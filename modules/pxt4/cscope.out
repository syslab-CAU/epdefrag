cscope 15 $HOME/Kernels/pxt4               0001505457
	@acl.c

8 
	~<löux/quŸa›s.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4.h
"

11 
	~"x©å.h
"

12 
	~"a˛.h
"

17 
posix_a˛
 *

18 
	$pxt4_a˛_‰om_disk
(c⁄° *
vÆue
, 
size_t
 
size
)

20 c⁄° *
íd
 = (*)
vÆue
 + 
size
;

21 
n
, 
cou¡
;

22 
posix_a˛
 *
a˛
;

24 i‡(!
vÆue
)

25  
NULL
;

26 i‡(
size
 < (
pxt4_a˛_hódî
))

27  
	`ERR_PTR
(-
EINVAL
);

28 i‡(((
pxt4_a˛_hódî
 *)
vÆue
)->
a_vîsi⁄
 !=

29 
	`˝u_to_À32
(
PXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_hódî
);

32 
cou¡
 = 
	`pxt4_a˛_cou¡
(
size
);

33 i‡(
cou¡
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 i‡(
cou¡
 == 0)

36  
NULL
;

37 
a˛
 = 
	`posix_a˛_Æloc
(
cou¡
, 
GFP_NOFS
);

38 i‡(!
a˛
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;Ç < 
cou¡
;Ç++) {

41 
pxt4_a˛_íåy
 *
íåy
 =

42 (
pxt4_a˛_íåy
 *)
vÆue
;

43 i‡((*)
vÆue
 + (
pxt4_a˛_íåy_sh‹t
Ë> 
íd
)

44 
Áû
;

45 
a˛
->
a_íåõs
[
n
].
e_èg
 = 
	`À16_to_˝u
(
íåy
->e_tag);

46 
a˛
->
a_íåõs
[
n
].
e_≥rm
 = 
	`À16_to_˝u
(
íåy
->e_perm);

48 
a˛
->
a_íåõs
[
n
].
e_èg
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
vÆue
 = (*)value +

54 (
pxt4_a˛_íåy_sh‹t
);

57 
ACL_USER
:

58 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

59 i‡((*)
vÆue
 > 
íd
)

60 
Áû
;

61 
a˛
->
a_íåõs
[
n
].
e_uid
 =

62 
	`make_kuid
(&
öô_u£r_ns
,

63 
	`À32_to_˝u
(
íåy
->
e_id
));

65 
ACL_GROUP
:

66 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

67 i‡((*)
vÆue
 > 
íd
)

68 
Áû
;

69 
a˛
->
a_íåõs
[
n
].
e_gid
 =

70 
	`make_kgid
(&
öô_u£r_ns
,

71 
	`À32_to_˝u
(
íåy
->
e_id
));

75 
Áû
;

78 i‡(
vÆue
 !
íd
)

79 
Áû
;

80  
a˛
;

82 
Áû
:

83 
	`posix_a˛_ªÀa£
(
a˛
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$pxt4_a˛_to_disk
(c⁄° 
posix_a˛
 *
a˛
, 
size_t
 *
size
)

93 
pxt4_a˛_hódî
 *
ext_a˛
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`pxt4_a˛_size
(
a˛
->
a_cou¡
);

98 
ext_a˛
 = 
	`kmÆloc
((
pxt4_a˛_hódî
Ë+ 
a˛
->
a_cou¡
 *

99 (
pxt4_a˛_íåy
), 
GFP_NOFS
);

100 i‡(!
ext_a˛
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_a˛
->
a_vîsi⁄
 = 
	`˝u_to_À32
(
PXT4_ACL_VERSION
);

103 
e
 = (*)
ext_a˛
 + (
pxt4_a˛_hódî
);

104 
n
 = 0;Ç < 
a˛
->
a_cou¡
;Ç++) {

105 c⁄° 
posix_a˛_íåy
 *
a˛_e
 = &
a˛
->
a_íåõs
[
n
];

106 
pxt4_a˛_íåy
 *
íåy
 = (pxt4_a˛_íåy *)
e
;

107 
íåy
->
e_èg
 = 
	`˝u_to_À16
(
a˛_e
->e_tag);

108 
íåy
->
e_≥rm
 = 
	`˝u_to_À16
(
a˛_e
->e_perm);

109 
a˛_e
->
e_èg
) {

110 
ACL_USER
:

111 
íåy
->
e_id
 = 
	`˝u_to_À32
(

112 
	`‰om_kuid
(&
öô_u£r_ns
, 
a˛_e
->
e_uid
));

113 
e
 +(
pxt4_a˛_íåy
);

115 
ACL_GROUP
:

116 
íåy
->
e_id
 = 
	`˝u_to_À32
(

117 
	`‰om_kgid
(&
öô_u£r_ns
, 
a˛_e
->
e_gid
));

118 
e
 +(
pxt4_a˛_íåy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +(
pxt4_a˛_íåy_sh‹t
);

129 
Áû
;

132  (*)
ext_a˛
;

134 
Áû
:

135 
	`k‰ì
(
ext_a˛
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_a˛
 *

145 
	$pxt4_gë_a˛
(
öode
 *öode, 
ty≥
)

147 
«me_ödex
;

148 *
vÆue
 = 
NULL
;

149 
posix_a˛
 *
a˛
;

150 
ªtvÆ
;

152 
ty≥
) {

153 
ACL_TYPE_ACCESS
:

154 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
NULL
, 0);

163 i‡(
ªtvÆ
 > 0) {

164 
vÆue
 = 
	`kmÆloc
(
ªtvÆ
, 
GFP_NOFS
);

165 i‡(!
vÆue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
vÆue
,Ñetval);

169 i‡(
ªtvÆ
 > 0)

170 
a˛
 = 
	`pxt4_a˛_‰om_disk
(
vÆue
, 
ªtvÆ
);

171 i‡(
ªtvÆ
 =-
ENODATA
 ||ÑëvÆ =-
ENOSYS
)

172 
a˛
 = 
NULL
;

174 
a˛
 = 
	`ERR_PTR
(
ªtvÆ
);

175 
	`k‰ì
(
vÆue
);

177  
a˛
;

178 
	}
}

186 
	$__pxt4_£t_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
ty≥
,

187 
posix_a˛
 *
a˛
, 
x©å_Êags
)

189 
«me_ödex
;

190 *
vÆue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
îr‹
;

194 
ty≥
) {

195 
ACL_TYPE_ACCESS
:

196 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

202  
a˛
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 i‡(
a˛
) {

209 
vÆue
 = 
	`pxt4_a˛_to_disk
(
a˛
, &
size
);

210 i‡(
	`IS_ERR
(
vÆue
))

211  ()
	`PTR_ERR
(
vÆue
);

214 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, "",

215 
vÆue
, 
size
, 
x©å_Êags
);

217 
	`k‰ì
(
vÆue
);

218 i‡(!
îr‹
) {

219 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

222  
îr‹
;

223 
	}
}

226 
	$pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
)

228 
h™dÀ_t
 *
h™dÀ
;

229 
îr‹
, 
¸edôs
, 
ªåõs
 = 0;

230 
size_t
 
a˛_size
 = 
a˛
 ? 
	`pxt4_a˛_size
◊˛->
a_cou¡
) : 0;

231 
umode_t
 
mode
 = 
öode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

235 i‡(
îr‹
)

236  
îr‹
;

237 
ªåy
:

238 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
a˛_size
, 
Ál£
 ,

239 &
¸edôs
);

240 i‡(
îr‹
)

241  
îr‹
;

243 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

244 i‡(
	`IS_ERR
(
h™dÀ
))

245  
	`PTR_ERR
(
h™dÀ
);

247 i‡((
ty≥
 =
ACL_TYPE_ACCESS
Ë&& 
a˛
) {

248 
îr‹
 = 
	`posix_a˛_upd©e_mode
(
öode
, &
mode
, &
a˛
);

249 i‡(
îr‹
)

250 
out_°›
;

251 i‡(
mode
 !
öode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ty≥
, 
a˛
, 0 );

256 i‡(!
îr‹
 && 
upd©e_mode
) {

257 
öode
->
i_mode
 = 
mode
;

258 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

259 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

261 
out_°›
:

262 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

263 i‡(
îr‹
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

264 
ªåy
;

265  
îr‹
;

266 
	}
}

275 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

277 
posix_a˛
 *
deÁu…_a˛
, *
a˛
;

278 
îr‹
;

280 
îr‹
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
deÁu…_a˛
, &
a˛
);

281 i‡(
îr‹
)

282  
îr‹
;

284 i‡(
deÁu…_a˛
) {

285 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_DEFAULT
,

286 
deÁu…_a˛
, 
XATTR_CREATE
);

287 
	`posix_a˛_ªÀa£
(
deÁu…_a˛
);

289 
öode
->
i_deÁu…_a˛
 = 
NULL
;

291 i‡(
a˛
) {

292 i‡(!
îr‹
)

293 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_ACCESS
,

294 
a˛
, 
XATTR_CREATE
);

295 
	`posix_a˛_ªÀa£
(
a˛
);

297 
öode
->
i_a˛
 = 
NULL
;

299  
îr‹
;

300 
	}
}

	@acl.h

8 
	~<löux/posix_a˛_x©å.h
>

10 
	#PXT4_ACL_VERSION
 0x0001

	)

13 
__À16
 
	me_èg
;

14 
__À16
 
	me_≥rm
;

15 
__À32
 
	me_id
;

16 } 
	tpxt4_a˛_íåy
;

19 
__À16
 
	me_èg
;

20 
__À16
 
	me_≥rm
;

21 } 
	tpxt4_a˛_íåy_sh‹t
;

24 
__À32
 
	ma_vîsi⁄
;

25 } 
	tpxt4_a˛_hódî
;

27 
ölöe
 
size_t
 
	$pxt4_a˛_size
(
cou¡
)

29 i‡(
cou¡
 <= 4) {

30  (
pxt4_a˛_hódî
) +

31 
cou¡
 * (
pxt4_a˛_íåy_sh‹t
);

33  (
pxt4_a˛_hódî
) +

34 4 * (
pxt4_a˛_íåy_sh‹t
) +

35 (
cou¡
 - 4Ë* (
pxt4_a˛_íåy
);

37 
	}
}

39 
ölöe
 
	$pxt4_a˛_cou¡
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -(
pxt4_a˛_hódî
);

43 
s
 = 
size
 - 4 * (
pxt4_a˛_íåy_sh‹t
);

44 i‡(
s
 < 0) {

45 i‡(
size
 % (
pxt4_a˛_íåy_sh‹t
))

47  
size
 / (
pxt4_a˛_íåy_sh‹t
);

49 i‡(
s
 % (
pxt4_a˛_íåy
))

51  
s
 / (
pxt4_a˛_íåy
) + 4;

53 
	}
}

55 #ifde‡
CONFIG_EXT4_FS_POSIX_ACL


58 
posix_a˛
 *
pxt4_gë_a˛
(
öode
 *öode, 
ty≥
);

59 
pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
);

60 
pxt4_öô_a˛
(
h™dÀ_t
 *, 
öode
 *, inode *);

63 
	~<löux/sched.h
>

64 
	#pxt4_gë_a˛
 
NULL


	)

65 
	#pxt4_£t_a˛
 
NULL


	)

67 
ölöe
 

68 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

71 
	}
}

	@balloc.c

15 
	~<löux/time.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/quŸa›s.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~"pxt4.h
"

21 
	~"pxt4_jbd3.h
"

22 
	~"mbÆloc.h
"

24 
	~<åa˚/evíts/pxt4.h
>

26 
pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

27 
pxt4_group_t
 
block_group
);

35 
pxt4_group_t
 
	$pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

36 
pxt4_fsblk_t
 
block
)

38 
pxt4_group_t
 
group
;

40 i‡(
	`ã°_›t2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) >>

43 (
	`PXT4_BLOCK_SIZE_BITS
(
sb
Ë+ 
	`PXT4_CLUSTER_BITS
(sb) + 3);

45 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
blockƒ
,

54 
pxt4_group_t
 *
blockgΩp
, 
pxt4_gΩblk_t
 *
off£ç
)

56 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

57 
pxt4_gΩblk_t
 
off£t
;

59 
blockƒ
 = blockƒ - 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockƒ
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

62 i‡(
off£ç
)

63 *
off£ç
 = 
off£t
;

64 i‡(
blockgΩp
)

65 *
blockgΩp
 = 
blockƒ
;

67 
	}
}

73 
ölöe
 
	$pxt4_block_ö_group
(
su≥r_block
 *
sb
,

74 
pxt4_fsblk_t
 
block
,

75 
pxt4_group_t
 
block_group
)

77 
pxt4_group_t
 
a˘uÆ_group
;

79 
a˘uÆ_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
block
);

80  (
a˘uÆ_group
 =
block_group
) ? 1 : 0;

81 
	}
}

86 
	$pxt4_num_ovîhód_˛u°îs
(
su≥r_block
 *
sb
,

87 
pxt4_group_t
 
block_group
,

88 
pxt4_group_desc
 *
gdp
)

90 
num_˛u°îs
;

91 
block_˛u°î
 = -1, 
öode_˛u°î
 = -1, 
ôbl_˛u°î
 = -1, 
i
, 
c
;

92 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

93 
pxt4_fsblk_t
 
ôbl_blk
;

94 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

99 
num_˛u°îs
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

113 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_block_bôm≠
(sb, 
gdp
), 
block_group
)) {

114 
block_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

115 
	`pxt4_block_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

116 i‡(
block_˛u°î
 < 
num_˛u°îs
)

117 
block_˛u°î
 = -1;

118 i‡(
block_˛u°î
 =
num_˛u°îs
) {

119 
num_˛u°îs
++;

120 
block_˛u°î
 = -1;

124 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
), 
block_group
)) {

125 
öode_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

126 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

127 i‡(
öode_˛u°î
 < 
num_˛u°îs
)

128 
öode_˛u°î
 = -1;

129 i‡(
öode_˛u°î
 =
num_˛u°îs
) {

130 
num_˛u°îs
++;

131 
öode_˛u°î
 = -1;

135 
ôbl_blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_ôb_≥r_group
; i++) {

137 i‡(
	`pxt4_block_ö_group
(
sb
, 
ôbl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`PXT4_B2C
(
sbi
, 
ôbl_blk
 + 
i
 - 
°¨t
);

139 i‡((
c
 < 
num_˛u°îs
Ë|| (¯=
öode_˛u°î
) ||

140 (
c
 =
block_˛u°î
Ë|| (¯=
ôbl_˛u°î
))

142 i‡(
c
 =
num_˛u°îs
) {

143 
num_˛u°îs
++;

146 
num_˛u°îs
++;

147 
ôbl_˛u°î
 = 
c
;

151 i‡(
block_˛u°î
 != -1)

152 
num_˛u°îs
++;

153 i‡(
öode_˛u°î
 != -1)

154 
num_˛u°îs
++;

156  
num_˛u°îs
;

157 
	}
}

159 
	$num_˛u°îs_ö_group
(
su≥r_block
 *
sb
,

160 
pxt4_group_t
 
block_group
)

162 
blocks
;

164 i‡(
block_group
 =
	`pxt4_gë_groups_cou¡
(
sb
) - 1) {

171 
blocks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
) -

172 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$pxt4_öô_block_bôm≠
(
su≥r_block
 *
sb
,

180 
buf„r_hód
 *
bh
,

181 
pxt4_group_t
 
block_group
,

182 
pxt4_group_desc
 *
gdp
)

184 
bô
, 
bô_max
;

185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

186 
pxt4_fsblk_t
 
°¨t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_locked
(bh));

192 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

194 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
bô_max
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

201 i‡((
bô_max
 >> 3Ë>
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
bô
 = 0; bô < 
bô_max
; bit++)

205 
	`pxt4_£t_bô
(
bô
, 
bh
->
b_d©a
);

207 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

211 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

212 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

215 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

216 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
) +

220 
sbi
->
s_ôb_≥r_group
; 
tmp
++) {

221 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

222 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

230 
	`pxt4_m¨k_bôm≠_íd
(
	`num_˛u°îs_ö_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

239 
pxt4_group_t
 
block_group
,

240 
pxt4_group_desc
 *
gdp
)

242  
	`num_˛u°îs_ö_group
(
sb
, 
block_group
) -

243 
	`pxt4_num_ovîhód_˛u°îs
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
pxt4_group_desc
 * 
	$pxt4_gë_group_desc
(
su≥r_block
 *
sb
,

265 
pxt4_group_t
 
block_group
,

266 
buf„r_hód
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

271 
pxt4_group_desc
 *
desc
;

272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

273 
buf„r_hód
 *
bh_p
;

275 i‡(
block_group
 >
ngroups
) {

276 
	`pxt4_îr‹
(
sb
, "block_group >= groups_count - block_group = %u,"

277 " groups_cou¡ = %u", 
block_group
, 
ngroups
);

279  
NULL
;

282 
group_desc
 = 
block_group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

283 
off£t
 = 
block_group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

284 
bh_p
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
group_desc
);

291 i‡(!
bh_p
) {

292 
	`pxt4_îr‹
(
sb
, "Group descriptorÇotÜoaded - "

294 
block_group
, 
group_desc
, 
off£t
);

295  
NULL
;

298 
desc
 = (
pxt4_group_desc
 *)(

299 (
__u8
 *)
bh_p
->
b_d©a
 +

300 
off£t
 * 
	`PXT4_DESC_SIZE
(
sb
));

301 i‡(
bh
)

302 *
bh
 = 
bh_p
;

303  
desc
;

304 
	}
}

310 
pxt4_fsblk_t
 
	$pxt4_vÆid_block_bôm≠
(
su≥r_block
 *
sb
,

311 
pxt4_group_desc
 *
desc
,

312 
pxt4_group_t
 
block_group
,

313 
buf„r_hód
 *
bh
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_gΩblk_t
 
off£t
;

317 
pxt4_gΩblk_t
 
√xt_zîo_bô
;

318 
pxt4_gΩblk_t
 
max_bô
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

319 
pxt4_fsblk_t
 
blk
;

320 
pxt4_fsblk_t
 
group_fú°_block
;

322 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
)) {

331 
group_fú°_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

334 
blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fú°_block
;

336 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

337 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fú°_block
;

344 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

345 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

347  
blk
;

350 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
desc
);

351 
off£t
 = 
blk
 - 
group_fú°_block
;

352 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

353 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
Ë>
max_bô
)

354  
blk
;

355 
√xt_zîo_bô
 = 
	`pxt4_föd_√xt_zîo_bô
(
bh
->
b_d©a
,

356 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
),

357 
	`PXT4_B2C
(
sbi
, 
off£t
));

358 i‡(
√xt_zîo_bô
 <

359 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
))

361  
blk
;

363 
	}
}

365 
	$pxt4_vÆid©e_block_bôm≠
(
su≥r_block
 *
sb
,

366 
pxt4_group_desc
 *
desc
,

367 
pxt4_group_t
 
block_group
,

368 
buf„r_hód
 *
bh
)

370 
pxt4_fsblk_t
 
blk
;

371 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

373 i‡(
	`buf„r_vîifõd
(
bh
))

375 i‡(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
))

376  -
EFSCORRUPTED
;

378 
	`pxt4_lock_group
(
sb
, 
block_group
);

379 i‡(
	`buf„r_vîifõd
(
bh
))

380 
vîifõd
;

381 i‡(
	`u∆ikñy
(!
	`pxt4_block_bôm≠_csum_vîify
(
sb
, 
block_group
,

382 
desc
, 
bh
))) {

383 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

384 
	`pxt4_îr‹
(
sb
, "bg %u: bad block bôm≠ checksum", 
block_group
);

385 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

386 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

387  -
EFSBADCRC
;

389 
blk
 = 
	`pxt4_vÆid_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

390 i‡(
	`u∆ikñy
(
blk
 != 0)) {

391 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

392 
	`pxt4_îr‹
(
sb
, "bg %u: block %llu: invalid block bitmap",

393 
block_group
, 
blk
);

394 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

395 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

396  -
EFSCORRUPTED
;

398 
	`£t_buf„r_vîifõd
(
bh
);

399 
vîifõd
:

400 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

402 
	}
}

414 
buf„r_hód
 *

415 
	$pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

417 
pxt4_group_desc
 *
desc
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
buf„r_hód
 *
bh
;

420 
pxt4_fsblk_t
 
bôm≠_blk
;

421 
îr
;

423 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

424 i‡(!
desc
)

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

426 
bôm≠_blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

427 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

428 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

429 
	`pxt4_îr‹
(
sb
, "Invalid block bitmap block %llu in "

430 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

431 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

432 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

433  
	`ERR_PTR
(-
EFSCORRUPTED
);

435 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

436 i‡(
	`u∆ikñy
(!
bh
)) {

437 
	`pxt4_w¨nög
(
sb
, "Cannot get buffer for block bitmap - "

439 
block_group
, 
bôm≠_blk
);

440  
	`ERR_PTR
(-
ENOMEM
);

443 i‡(
	`bôm≠_u±od©e
(
bh
))

444 
vîify
;

446 
	`lock_buf„r
(
bh
);

447 i‡(
	`bôm≠_u±od©e
(
bh
)) {

448 
	`u∆ock_buf„r
(
bh
);

449 
vîify
;

451 
	`pxt4_lock_group
(
sb
, 
block_group
);

452 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

453 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

454 i‡(
block_group
 == 0) {

455 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

456 
	`u∆ock_buf„r
(
bh
);

457 
	`pxt4_îr‹
(
sb
, "Block bitmap for bg 0 marked "

459 
îr
 = -
EFSCORRUPTED
;

460 
out
;

462 
îr
 = 
	`pxt4_öô_block_bôm≠
(
sb
, 
bh
, 
block_group
, 
desc
);

463 
	`£t_bôm≠_u±od©e
(
bh
);

464 
	`£t_buf„r_u±od©e
(
bh
);

465 
	`£t_buf„r_vîifõd
(
bh
);

466 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

467 
	`u∆ock_buf„r
(
bh
);

468 i‡(
îr
) {

469 
	`pxt4_îr‹
(
sb
, "FailedÅo init block bitmap for group "

470 "%u: %d", 
block_group
, 
îr
);

471 
out
;

473 
vîify
;

475 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

476 i‡(
	`buf„r_u±od©e
(
bh
)) {

481 
	`£t_bôm≠_u±od©e
(
bh
);

482 
	`u∆ock_buf„r
(
bh
);

483 
vîify
;

488 
	`£t_buf„r_√w
(
bh
);

489 
	`åa˚_pxt4_ªad_block_bôm≠_lﬂd
(
sb
, 
block_group
);

490 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

491 
	`gë_bh
(
bh
);

492 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

493  
bh
;

494 
vîify
:

495 
îr
 = 
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

496 i‡(
îr
)

497 
out
;

498  
bh
;

499 
out
:

500 
	`put_bh
(
bh
);

501  
	`ERR_PTR
(
îr
);

502 
	}
}

505 
	$pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
,

506 
buf„r_hód
 *
bh
)

508 
pxt4_group_desc
 *
desc
;

510 i‡(!
	`buf„r_√w
(
bh
))

512 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

513 i‡(!
desc
)

514  -
EFSCORRUPTED
;

515 
	`waô_⁄_buf„r
(
bh
);

516 i‡(!
	`buf„r_u±od©e
(
bh
)) {

517 
	`pxt4_îr‹
(
sb
, "CannotÑead block bitmap - "

519 
block_group
, (Ë
bh
->
b_blockƒ
);

520 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

521 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

522  -
EIO
;

524 
	`˛ór_buf„r_√w
(
bh
);

526  
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

527 
	}
}

529 
buf„r_hód
 *

530 
	$pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

532 
buf„r_hód
 *
bh
;

533 
îr
;

535 
bh
 = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
block_group
);

536 i‡(
	`IS_ERR
(
bh
))

537  
bh
;

538 
îr
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
block_group
, 
bh
);

539 i‡(
îr
) {

540 
	`put_bh
(
bh
);

541  
	`ERR_PTR
(
îr
);

543  
bh
;

544 
	}
}

555 
	$pxt4_has_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

556 
s64
 
n˛u°îs
, 
Êags
)

558 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
, 
rsv
, 
ªsv_˛u°îs
;

559 
≥r˝u_cou¡î
 *
fcc
 = &
sbi
->
s_‰ì˛u°îs_cou¡î
;

560 
≥r˝u_cou¡î
 *
dcc
 = &
sbi
->
s_dúty˛u°îs_cou¡î
;

562 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
fcc
);

563 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
dcc
);

564 
ªsv_˛u°îs
 = 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
);

570 
rsv
 = (
	`pxt4_r_blocks_cou¡
(
sbi
->
s_es
Ë>> sbi->
s_˛u°î_bôs
) +

571 
ªsv_˛u°îs
;

573 i‡(
‰ì_˛u°îs
 - (
n˛u°îs
 + 
rsv
 + 
dúty_˛u°îs
) <

574 
PXT4_FREECLUSTERS_WATERMARK
) {

575 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
fcc
);

576 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
dcc
);

581 i‡(
‰ì_˛u°îs
 >(
rsv
 + 
n˛u°îs
 + 
dúty_˛u°îs
))

585 i‡(
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`cuºít_fsuid
()) ||

586 (!
	`gid_eq
(
sbi
->
s_ªsgid
, 
GLOBAL_ROOT_GID
Ë&& 
	`ö_group_p
(sbi->s_resgid)) ||

587 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
) ||

588 (
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
)) {

590 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
 +

591 
ªsv_˛u°îs
))

595 i‡(
Êags
 & 
PXT4_MB_USE_RESERVED
) {

596 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
))

601 
	}
}

603 
	$pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

604 
s64
 
n˛u°îs
, 
Êags
)

606 i‡(
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 
n˛u°îs
, 
Êags
)) {

607 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
n˛u°îs
);

610  -
ENOSPC
;

611 
	}
}

623 
	$pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
)

625 i‡(!
	`pxt4_has_‰ì_˛u°îs
(
	`PXT4_SB
(
sb
), 1, 0) ||

626 (*
ªåõs
)++ > 1 ||

627 !
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

630 
	`smp_mb
();

631 i‡(
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 == 0)

634 
	`jbd_debug
(1, "%s:Ñëryög o≥øti⁄á·î ENOSPC\n", 
sb
->
s_id
);

635 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

637 
	}
}

651 
pxt4_fsblk_t
 
	$pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

652 
pxt4_fsblk_t
 
gﬂl
, 
Êags
,

653 *
cou¡
, *
îΩ
)

655 
pxt4_Æloˇti⁄_ªque°
 
¨
;

656 
pxt4_fsblk_t
 
ªt
;

658 
	`mem£t
(&
¨
, 0, (ar));

660 
¨
.
öode
 = inode;

661 
¨
.
gﬂl
 = goal;

662 
¨
.
Àn
 = 
cou¡
 ? *count : 1;

663 
¨
.
Êags
 = flags;

665 
ªt
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, 
îΩ
);

666 i‡(
cou¡
)

667 *
cou¡
 = 
¨
.
Àn
;

672 i‡(!(*
îΩ
Ë&& (
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
)) {

673 
	`dquŸ_Æloc_block_noÁû
(
öode
,

674 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
), 
¨
.
Àn
));

676  
ªt
;

677 
	}
}

685 
pxt4_fsblk_t
 
	$pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

687 
pxt4_fsblk_t
 
desc_cou¡
;

688 
pxt4_group_desc
 *
gdp
;

689 
pxt4_group_t
 
i
;

690 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

691 
pxt4_group_öfo
 *
gΩ
;

692 #ifde‡
PXT4FS_DEBUG


693 
pxt4_su≥r_block
 *
es
;

694 
pxt4_fsblk_t
 
bôm≠_cou¡
;

695 
x
;

696 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

698 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

699 
desc_cou¡
 = 0;

700 
bôm≠_cou¡
 = 0;

701 
gdp
 = 
NULL
;

703 
i
 = 0; i < 
ngroups
; i++) {

704 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

705 i‡(!
gdp
)

707 
gΩ
 = 
NULL
;

708 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

709 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

710 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

711 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

712 
	`bªl£
(
bôm≠_bh
);

713 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
i
);

714 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

715 
bôm≠_bh
 = 
NULL
;

719 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

720 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

721 
	`¥ötk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

722 
i
, 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
), 
x
);

723 
bôm≠_cou¡
 +
x
;

725 
	`bªl£
(
bôm≠_bh
);

726 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_clusters: stored = %llu"

728 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
	`pxt4_‰ì_blocks_cou¡
(
es
)),

729 
desc_cou¡
, 
bôm≠_cou¡
);

730  
bôm≠_cou¡
;

732 
desc_cou¡
 = 0;

733 
i
 = 0; i < 
ngroups
; i++) {

734 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

735 i‡(!
gdp
)

737 
gΩ
 = 
NULL
;

738 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

739 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

740 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

741 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

744  
desc_cou¡
;

746 
	}
}

748 
ölöe
 
	$ã°_roŸ
(
pxt4_group_t
 
a
, 
b
)

751 i‡(
a
 < 
b
)

753 i‡(
a
 =
b
)

755 i‡((
a
 % 
b
) != 0)

757 
a
 =á / 
b
;

759 
	}
}

769 
	$pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

771 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

773 i‡(
group
 == 0)

775 i‡(
	`pxt4_has_„©uª_•¨£_su≥r2
(
sb
)) {

776 i‡(
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[0]) ||

777 
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[1]))

781 i‡((
group
 <1Ë|| !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
))

783 i‡(!(
group
 & 1))

785 i‡(
	`ã°_roŸ
(
group
, 3) || (test_root(group, 5)) ||

786 
	`ã°_roŸ
(
group
, 7))

790 
	}
}

792 
	$pxt4_bg_num_gdb_mëa
(
su≥r_block
 *
sb
,

793 
pxt4_group_t
 
group
)

795 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

796 
pxt4_group_t
 
fú°
 = 
mëagroup
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

797 
pxt4_group_t
 
œ°
 = 
fú°
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1;

799 i‡(
group
 =
fú°
 || grou∞=fú° + 1 || grou∞=
œ°
)

802 
	}
}

804 
	$pxt4_bg_num_gdb_nomëa
(
su≥r_block
 *
sb
,

805 
pxt4_group_t
 
group
)

807 i‡(!
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

810 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
))

811  
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

813  
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
;

814 
	}
}

825 
	$pxt4_bg_num_gdb
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

827 
fú°_mëa_bg
 =

828 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

829 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

831 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
)

832  
	`pxt4_bg_num_gdb_nomëa
(
sb
, 
group
);

834  
	`pxt4_bg_num_gdb_mëa
(
sb
,
group
);

836 
	}
}

842 
	$pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

843 
pxt4_group_t
 
block_group
)

845 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

846 
num
;

849 
num
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
block_group
);

851 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
) ||

852 
block_group
 < 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
) *

853 
sbi
->
s_desc_≥r_block
) {

854 i‡(
num
) {

855 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

856 
num
 +
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

859 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

861  
	`PXT4_NUM_B2C
(
sbi
, 
num
);

862 
	}
}

870 
pxt4_fsblk_t
 
	$pxt4_öode_to_gﬂl_block
(
öode
 *inode)

872 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

873 
pxt4_group_t
 
block_group
;

874 
pxt4_gΩblk_t
 
cﬁour
;

875 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
öode
->
i_sb
));

876 
pxt4_fsblk_t
 
bg_°¨t
;

877 
pxt4_fsblk_t
 
œ°_block
;

879 
block_group
 = 
ei
->
i_block_group
;

880 i‡(
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

889 
block_group
 &~(
Êex_size
-1);

890 i‡(
	`S_ISREG
(
öode
->
i_mode
))

891 
block_group
++;

893 
bg_°¨t
 = 
	`pxt4_group_fú°_block_no
(
öode
->
i_sb
, 
block_group
);

894 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
) - 1;

900 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

901  
bg_°¨t
;

903 i‡(
bg_°¨t
 + 
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
Ë<
œ°_block
)

904 
cﬁour
 = (
cuºít
->
pid
 % 16) *

905 (
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
) / 16);

907 
cﬁour
 = (
cuºít
->
pid
 % 16Ë* ((
œ°_block
 - 
bg_°¨t
) / 16);

908  
bg_°¨t
 + 
cﬁour
;

909 
	}
}

	@bitmap.c

11 
	~<löux/buf„r_hód.h
>

12 
	~"pxt4.h
"

14 
	$pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
)

16  
numch¨s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
bôm≠
,Çumchars);

17 
	}
}

19 
	$pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

20 
pxt4_group_desc
 *
gdp
,

21 
buf„r_hód
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
¥ovided
, 
ˇlcuœãd
;

25 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

27 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

30 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_lo
);

31 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_hi
);

34 
¥ovided
 |(
hi
 << 16);

36 
ˇlcuœãd
 &= 0xFFFF;

38  
¥ovided
 =
ˇlcuœãd
;

39 
	}
}

41 
	$pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

42 
pxt4_group_desc
 *
gdp
,

43 
buf„r_hód
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

48 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

51 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_öode_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

53 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_öode_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

55 
	}
}

57 
	$pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

58 
pxt4_group_desc
 *
gdp
,

59 
buf„r_hód
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
¥ovided
, 
ˇlcuœãd
;

63 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

64 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

69 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_lo
);

70 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_hi
);

73 
¥ovided
 |(
hi
 << 16);

75 
ˇlcuœãd
 &= 0xFFFF;

77 i‡(
¥ovided
 =
ˇlcuœãd
)

81 
	}
}

83 
	$pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

84 
pxt4_group_desc
 *
gdp
,

85 
buf„r_hód
 *
bh
)

87 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

91 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

94 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

96 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

98 
	}
}

	@block_validity.c

12 
	~<löux/time.h
>

13 
	~<löux/fs.h
>

14 
	~<löux/«mei.h
>

15 
	~<löux/quŸa›s.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/blkdev.h
>

20 
	~<löux/¶ab.h
>

21 
	~"pxt4.h
"

23 
	spxt4_sy°em_z⁄e
 {

24 
rb_node
 
	mnode
;

25 
pxt4_fsblk_t
 
	m°¨t_blk
;

26 
	mcou¡
;

29 
kmem_ˇche
 *
	gpxt4_sy°em_z⁄e_ˇchï
;

31 
__öô
 
	$pxt4_öô_sy°em_z⁄e
()

33 
pxt4_sy°em_z⁄e_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_sy°em_z⁄e
, 0);

34 i‡(
pxt4_sy°em_z⁄e_ˇchï
 =
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$pxt4_exô_sy°em_z⁄e
()

41 
	`rcu_b¨rõr
();

42 
	`kmem_ˇche_de°roy
(
pxt4_sy°em_z⁄e_ˇchï
);

43 
	}
}

45 
ölöe
 
	$ˇn_mîge
(
pxt4_sy°em_z⁄e
 *
íåy1
,

46 
pxt4_sy°em_z⁄e
 *
íåy2
)

48 i‡((
íåy1
->
°¨t_blk
 +É¡ry1->
cou¡
Ë=
íåy2
->start_blk)

51 
	}
}

53 
	$ªÀa£_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
)

55 
pxt4_sy°em_z⁄e
 *
íåy
, *
n
;

57 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
n
,

58 &
sy°em_blks
->
roŸ
, 
node
)

59 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

60 
	}
}

67 
	$add_sy°em_z⁄e
(
pxt4_sy°em_blocks
 *
sy°em_blks
,

68 
pxt4_fsblk_t
 
°¨t_blk
,

69 
cou¡
)

71 
pxt4_sy°em_z⁄e
 *
√w_íåy
 = 
NULL
, *
íåy
;

72 
rb_node
 **
n
 = &
sy°em_blks
->
roŸ
.rb_node, *
node
;

73 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
 = NULL;

75 *
n
) {

76 
∑ª¡
 = *
n
;

77 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_sy°em_z⁄e
, 
node
);

78 i‡(
°¨t_blk
 < 
íåy
->start_blk)

79 
n
 = &(*n)->
rb_À·
;

80 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

81 
n
 = &(*n)->
rb_right
;

83 i‡(
°¨t_blk
 + 
cou¡
 > (
íåy
->start_blk +

84 
íåy
->
cou¡
))

85 
íåy
->
cou¡
 = (
°¨t_blk
 + count -

86 
íåy
->
°¨t_blk
);

87 
√w_node
 = *
n
;

88 
√w_íåy
 = 
	`rb_íåy
(
√w_node
, 
pxt4_sy°em_z⁄e
,

89 
node
);

94 i‡(!
√w_íåy
) {

95 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_sy°em_z⁄e_ˇchï
,

96 
GFP_KERNEL
);

97 i‡(!
√w_íåy
)

98  -
ENOMEM
;

99 
√w_íåy
->
°¨t_blk
 = start_blk;

100 
√w_íåy
->
cou¡
 = count;

101 
√w_node
 = &
√w_íåy
->
node
;

103 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

104 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
sy°em_blks
->
roŸ
);

108 
node
 = 
	`rb_¥ev
(
√w_node
);

109 i‡(
node
) {

110 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

111 i‡(
	`ˇn_mîge
(
íåy
, 
√w_íåy
)) {

112 
√w_íåy
->
°¨t_blk
 = 
íåy
->start_blk;

113 
√w_íåy
->
cou¡
 +
íåy
->count;

114 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

115 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

120 
node
 = 
	`rb_√xt
(
√w_node
);

121 i‡(
node
) {

122 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

123 i‡(
	`ˇn_mîge
(
√w_íåy
, 
íåy
)) {

124 
√w_íåy
->
cou¡
 +
íåy
->count;

125 
	`rb_îa£
(
node
, &
sy°em_blks
->
roŸ
);

126 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

130 
	}
}

132 
	$debug_¥öt_åì
(
pxt4_sb_öfo
 *
sbi
)

134 
rb_node
 *
node
;

135 
pxt4_sy°em_z⁄e
 *
íåy
;

136 
pxt4_sy°em_blocks
 *
sy°em_blks
;

137 
fú°
 = 1;

139 
	`¥ötk
(
KERN_INFO
 "System zones: ");

140 
	`rcu_ªad_lock
();

141 
sy°em_blks
 = 
	`rcu_dîe„ªn˚
(
sbi
->system_blks);

142 
node
 = 
	`rb_fú°
(&
sy°em_blks
->
roŸ
);

143 
node
) {

144 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

145 
	`¥ötk
(
KERN_CONT
 "%s%Œu-%Œu", 
fú°
 ? "" : ", ",

146 
íåy
->
°¨t_blk
,É¡ry->°¨t_blk +É¡ry->
cou¡
 - 1);

147 
fú°
 = 0;

148 
node
 = 
	`rb_√xt
(node);

150 
	`rcu_ªad_u∆ock
();

151 
	`¥ötk
(
KERN_CONT
 "\n");

152 
	}
}

159 
	$pxt4_d©a_block_vÆid_rcu
(
pxt4_sb_öfo
 *
sbi
,

160 
pxt4_sy°em_blocks
 *
sy°em_blks
,

161 
pxt4_fsblk_t
 
°¨t_blk
,

162 
cou¡
)

164 
pxt4_sy°em_z⁄e
 *
íåy
;

165 
rb_node
 *
n
;

167 i‡((
°¨t_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

168 (
°¨t_blk
 + 
cou¡
 < start_blk) ||

169 (
°¨t_blk
 + 
cou¡
 > 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

170 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

174 i‡(
sy°em_blks
 =
NULL
)

177 
n
 = 
sy°em_blks
->
roŸ
.
rb_node
;

178 
n
) {

179 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_sy°em_z⁄e
, 
node
);

180 i‡(
°¨t_blk
 + 
cou¡
 - 1 < 
íåy
->start_blk)

181 
n
 =Ç->
rb_À·
;

182 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

183 
n
 =Ç->
rb_right
;

185 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

190 
	}
}

192 
	$pxt4_¥Ÿe˘_ª£rved_öode
(
su≥r_block
 *
sb
,

193 
pxt4_sy°em_blocks
 *
sy°em_blks
,

194 
u32
 
öo
)

196 
öode
 *inode;

197 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

198 
pxt4_m≠_blocks
 
m≠
;

199 
u32
 
i
 = 0, 
num
;

200 
îr
 = 0, 
n
;

202 i‡((
öo
 < 
PXT4_ROOT_INO
) ||

203 (
öo
 > 
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)))

204  -
EINVAL
;

205 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_SPECIAL
);

206 i‡(
	`IS_ERR
(
öode
))

207  
	`PTR_ERR
(
öode
);

208 
num
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

209 
i
 < 
num
) {

210 
	`c⁄d_ªsched
();

211 
m≠
.
m_lblk
 = 
i
;

212 
m≠
.
m_Àn
 = 
num
 - 
i
;

213 
n
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

214 i‡(
n
 < 0) {

215 
îr
 = 
n
;

218 i‡(
n
 == 0) {

219 
i
++;

221 i‡(!
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
,

222 
m≠
.
m_pblk
, 
n
)) {

223 
	`pxt4_îr‹
(
sb
, "blocks %llu-%llu from inode %u "

224 "ovîœ∞sy°em z⁄e", 
m≠
.
m_pblk
,

225 
m≠
.
m_pblk
 + m≠.
m_Àn
 - 1, 
öo
);

226 
îr
 = -
EFSCORRUPTED
;

229 
îr
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
, 
m≠
.
m_pblk
, 
n
);

230 i‡(
îr
 < 0)

232 
i
 +
n
;

235 
	`ùut
(
öode
);

236  
îr
;

237 
	}
}

239 
	$pxt4_de°roy_sy°em_z⁄e
(
rcu_hód
 *
rcu
)

241 
pxt4_sy°em_blocks
 *
sy°em_blks
;

243 
sy°em_blks
 = 
	`c⁄èöî_of
(
rcu
, 
pxt4_sy°em_blocks
,Ñcu);

244 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

245 
	`k‰ì
(
sy°em_blks
);

246 
	}
}

257 
	$pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
)

259 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

260 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

261 
pxt4_sy°em_blocks
 *
sy°em_blks
;

262 
pxt4_group_desc
 *
gdp
;

263 
pxt4_group_t
 
i
;

264 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

265 
ªt
;

267 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
)) {

268 i‡(
sbi
->
sy°em_blks
)

269 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

272 i‡(
sbi
->
sy°em_blks
)

275 
sy°em_blks
 = 
	`kzÆloc
((*sy°em_blks), 
GFP_KERNEL
);

276 i‡(!
sy°em_blks
)

277  -
ENOMEM
;

279 
i
=0; i < 
ngroups
; i++) {

280 
	`c⁄d_ªsched
();

281 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
i
) &&

282 ((
i
 < 5Ë|| ((ò% 
Êex_size
) == 0)))

283 
	`add_sy°em_z⁄e
(
sy°em_blks
,

284 
	`pxt4_group_fú°_block_no
(
sb
, 
i
),

285 
	`pxt4_bg_num_gdb
(
sb
, 
i
) + 1);

286 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

287 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

288 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1);

289 i‡(
ªt
)

290 
îr
;

291 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

292 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1);

293 i‡(
ªt
)

294 
îr
;

295 
ªt
 = 
	`add_sy°em_z⁄e
(
sy°em_blks
,

296 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

297 
sbi
->
s_ôb_≥r_group
);

298 i‡(
ªt
)

299 
îr
;

301 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& 
sbi
->
s_es
->
s_jou∫Æ_öum
) {

302 
ªt
 = 
	`pxt4_¥Ÿe˘_ª£rved_öode
(
sb
, 
sy°em_blks
,

303 
	`À32_to_˝u
(
sbi
->
s_es
->
s_jou∫Æ_öum
));

304 i‡(
ªt
)

305 
îr
;

313 
	`rcu_assign_poöãr
(
sbi
->
sy°em_blks
, system_blks);

315 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

316 
	`debug_¥öt_åì
(
sbi
);

318 
îr
:

319 
	`ªÀa£_sy°em_z⁄e
(
sy°em_blks
);

320 
	`k‰ì
(
sy°em_blks
);

321  
ªt
;

322 
	}
}

334 
	$pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
)

336 
pxt4_sy°em_blocks
 *
sy°em_blks
;

338 
sy°em_blks
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
	`PXT4_SB
(
sb
)->system_blks,

339 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

340 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
sy°em_blks
, 
NULL
);

342 i‡(
sy°em_blks
)

343 
	`ˇŒ_rcu
(&
sy°em_blks
->
rcu
, 
pxt4_de°roy_sy°em_z⁄e
);

344 
	}
}

346 
	$pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
, 
pxt4_fsblk_t
 
°¨t_blk
,

347 
cou¡
)

349 
pxt4_sy°em_blocks
 *
sy°em_blks
;

350 
ªt
;

357 
	`rcu_ªad_lock
();

358 
sy°em_blks
 = 
	`rcu_dîe„ªn˚
(
sbi
->system_blks);

359 
ªt
 = 
	`pxt4_d©a_block_vÆid_rcu
(
sbi
, 
sy°em_blks
, 
°¨t_blk
,

360 
cou¡
);

361 
	`rcu_ªad_u∆ock
();

362  
ªt
;

363 
	}
}

365 
	$pxt4_check_blockªf
(c⁄° *
fun˘i⁄
, 
löe
,

366 
öode
 *öode, 
__À32
 *
p
, 
max
)

368 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

369 
__À32
 *
bªf
 = 
p
;

370 
blk
;

372 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

373 (
öode
->
i_öo
 ==

374 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

377 
bªf
 < 
p
+
max
) {

378 
blk
 = 
	`À32_to_˝u
(*
bªf
++);

379 i‡(
blk
 &&

380 
	`u∆ikñy
(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

381 
blk
, 1))) {

382 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
blk
);

383 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 
blk
,

385  -
EFSCORRUPTED
;

389 
	}
}

	@dir.c

25 
	~<löux/fs.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~<löux/unicode.h
>

30 
	~"pxt4.h
"

31 
	~"x©å.h
"

33 
pxt4_dx_ªaddú
(
fûe
 *, 
dú_c⁄ãxt
 *);

45 
	$is_dx_dú
(
öode
 *inode)

47 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

49 i‡(
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

50 ((
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) ||

51 ((
öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
) == 1) ||

52 
	`pxt4_has_ölöe_d©a
(
öode
)))

56 
	}
}

66 
	$__pxt4_check_dú_íåy
(c⁄° *
fun˘i⁄
, 
löe
,

67 
öode
 *
dú
, 
fûe
 *
fûp
,

68 
pxt4_dú_íåy_2
 *
de
,

69 
buf„r_hód
 *
bh
, *
buf
, 
size
,

70 
off£t
)

72 c⁄° *
îr‹_msg
 = 
NULL
;

73 c⁄° 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

74 
dú
->
i_sb
->
s_blocksize
);

75 c⁄° 
√xt_off£t
 = ((*Ë
de
 - 
buf
Ë+ 
æí
;

77 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(1)))

78 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

79 i‡(
	`u∆ikñy
(
æí
 % 4 != 0))

80 
îr‹_msg
 = "rec_len % 4 != 0";

81 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
)))

82 
îr‹_msg
 = "rec_len isÅoo small forÇame_len";

83 i‡(
	`u∆ikñy
(
√xt_off£t
 > 
size
))

84 
îr‹_msg
 = "directoryÉntry overrun";

85 i‡(
	`u∆ikñy
(
√xt_off£t
 > 
size
 - 
	`PXT4_DIR_REC_LEN
(1) &&

86 
√xt_off£t
 !
size
))

87 
îr‹_msg
 = "directoryÉntryÅoo closeÅo blockÉnd";

88 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
de
->
öode
) >

89 
	`À32_to_˝u
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_es
->
s_öodes_cou¡
)))

90 
îr‹_msg
 = "inode out of bounds";

94 i‡(
fûp
)

95 
	`pxt4_îr‹_fûe
(
fûp
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

98 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

99 
æí
, 
de
->
«me_Àn
, 
size
);

101 
	`pxt4_îr‹_öode
(
dú
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

104 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

105 
æí
, 
de
->
«me_Àn
, 
size
);

108 
	}
}

110 
	$pxt4_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

112 
off£t
;

113 
i
;

114 
pxt4_dú_íåy_2
 *
de
;

115 
îr
;

116 
öode
 *öodê
	`fûe_öode
(
fûe
);

117 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

118 
buf„r_hód
 *
bh
 = 
NULL
;

119 
fs¸y±_°r
 
f°r
 = 
	`FSTR_INIT
(
NULL
, 0);

121 i‡(
	`IS_ENCRYPTED
(
öode
)) {

122 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
);

123 i‡(
îr
 &&Éº !-
ENOKEY
)

124  
îr
;

127 i‡(
	`is_dx_dú
(
öode
)) {

128 
îr
 = 
	`pxt4_dx_ªaddú
(
fûe
, 
˘x
);

129 i‡(
îr
 !
ERR_BAD_DX_DIR
) {

130  
îr
;

133 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
)) {

138 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

142 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

143 
has_ölöe_d©a
 = 1;

144 
îr
 = 
	`pxt4_ªad_ölöe_dú
(
fûe
, 
˘x
,

145 &
has_ölöe_d©a
);

146 i‡(
has_ölöe_d©a
)

147  
îr
;

150 i‡(
	`IS_ENCRYPTED
(
öode
)) {

151 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
öode
, 
PXT4_NAME_LEN
, &
f°r
);

152 i‡(
îr
 < 0)

153  
îr
;

156 
˘x
->
pos
 < 
öode
->
i_size
) {

157 
pxt4_m≠_blocks
 
m≠
;

159 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

160 
îr
 = -
ERESTARTSYS
;

161 
îrout
;

163 
	`c⁄d_ªsched
();

164 
off£t
 = 
˘x
->
pos
 & (
sb
->
s_blocksize
 - 1);

165 
m≠
.
m_lblk
 = 
˘x
->
pos
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

166 
m≠
.
m_Àn
 = 1;

167 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

168 i‡(
îr
 == 0) {

171 i‡(
m≠
.
m_Àn
 == 0)

172 
m≠
.
m_Àn
 = 1;

173 
˘x
->
pos
 +
m≠
.
m_Àn
 * 
sb
->
s_blocksize
;

176 i‡(
îr
 > 0) {

177 
pgoff_t
 
ödex
 = 
m≠
.
m_pblk
 >>

178 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

179 i‡(!
	`ø_has_ödex
(&
fûe
->
f_ø
, 
ödex
))

180 
	`∑ge_ˇche_sync_ªadahód
(

181 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
,

182 &
fûe
->
f_ø
, file,

183 
ödex
, 1);

184 
fûe
->
f_ø
.
¥ev_pos
 = (
loff_t
)
ödex
 << 
PAGE_SHIFT
;

185 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
m≠
.
m_lblk
, 0);

186 i‡(
	`IS_ERR
(
bh
)) {

187 
îr
 = 
	`PTR_ERR
(
bh
);

188 
bh
 = 
NULL
;

189 
îrout
;

193 i‡(!
bh
) {

195 i‡(
˘x
->
pos
 > 
öode
->
i_blocks
 << 9)

197 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

202 i‡(!
	`buf„r_vîifõd
(
bh
) &&

203 !
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
)) {

204 
	`PXT4_ERROR_FILE
(
fûe
, 0, "directory fails checksum "

206 ()
˘x
->
pos
);

207 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

208 
	`bªl£
(
bh
);

209 
bh
 = 
NULL
;

212 
	`£t_buf„r_vîifõd
(
bh
);

218 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

219 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

220 
de
 = (
pxt4_dú_íåy_2
 *)

221 (
bh
->
b_d©a
 + 
i
);

228 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

229 
sb
->
s_blocksize
Ë< 
	`PXT4_DIR_REC_LEN
(1))

231 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

232 
sb
->
s_blocksize
);

234 
off£t
 = 
i
;

235 
˘x
->
pos
 = (˘x->po†& ~(
sb
->
s_blocksize
 - 1))

236 | 
off£t
;

237 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

240 
˘x
->
pos
 < 
öode
->
i_size


241 && 
off£t
 < 
sb
->
s_blocksize
) {

242 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 + 
off£t
);

243 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
bh
,

244 
bh
->
b_d©a
, bh->
b_size
,

245 
off£t
)) {

249 
˘x
->
pos
 = (ctx->pos |

250 (
sb
->
s_blocksize
 - 1)) + 1;

253 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

254 
sb
->
s_blocksize
);

255 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

256 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

257 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
,

258 
de
->
«me_Àn
,

259 
	`À32_to_˝u
(
de
->
öode
),

260 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

261 
d⁄e
;

263 
ßve_Àn
 = 
f°r
.
Àn
;

264 
fs¸y±_°r
 
de_«me
 =

265 
	`FSTR_INIT
(
de
->
«me
,

266 
de
->
«me_Àn
);

269 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
öode
,

270 0, 0, &
de_«me
, &
f°r
);

271 
de_«me
 = 
f°r
;

272 
f°r
.
Àn
 = 
ßve_Àn
;

273 i‡(
îr
)

274 
îrout
;

275 i‡(!
	`dú_emô
(
˘x
,

276 
de_«me
.
«me
, de_«me.
Àn
,

277 
	`À32_to_˝u
(
de
->
öode
),

278 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

279 
d⁄e
;

282 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

283 
sb
->
s_blocksize
);

285 i‡((
˘x
->
pos
 < 
öode
->
i_size
Ë&& !
	`dú_ªœx_sh¨ed
(inode))

286 
d⁄e
;

287 
	`bªl£
(
bh
);

288 
bh
 = 
NULL
;

289 
off£t
 = 0;

291 
d⁄e
:

292 
îr
 = 0;

293 
îrout
:

294 
	`fs¸y±_‚ame_‰ì_buf„r
(&
f°r
);

295 
	`bªl£
(
bh
);

296  
îr
;

297 
	}
}

299 
ölöe
 
	$is_32bô_≠i
()

301 #ifde‡
CONFIG_COMPAT


302  
	`ö_com∑t_sysˇŒ
();

304  (
BITS_PER_LONG
 == 32);

306 
	}
}

317 
ölöe
 
loff_t
 
	$hash2pos
(
fûe
 *
fûp
, 
__u32
 
maj‹
, __u32 
mö‹
)

319 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

320 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

321  
maj‹
 >> 1;

323  ((
__u64
)(
maj‹
 >> 1Ë<< 32Ë| (__u64)
mö‹
;

324 
	}
}

326 
ölöe
 
__u32
 
	$pos2maj_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

328 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

329 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

330  (
pos
 << 1) & 0xffffffff;

332  ((
pos
 >> 32) << 1) & 0xffffffff;

333 
	}
}

335 
ölöe
 
__u32
 
	$pos2mö_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

337 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

338 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

341  
pos
 & 0xffffffff;

342 
	}
}

347 
ölöe
 
loff_t
 
	$pxt4_gë_håì_eof
(
fûe
 *
fûp
)

349 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

350 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

351  
PXT4_HTREE_EOF_32BIT
;

353  
PXT4_HTREE_EOF_64BIT
;

354 
	}
}

368 
loff_t
 
	$pxt4_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

370 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

371 
dx_dú
 = 
	`is_dx_dú
(
öode
);

372 
loff_t
 
ªt
, 
håì_max
 = 
	`pxt4_gë_håì_eof
(
fûe
);

374 i‡(
	`likñy
(
dx_dú
))

375 
ªt
 = 
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

376 
håì_max
, htree_max);

378 
ªt
 = 
	`pxt4_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

379 
fûe
->
f_vîsi⁄
 = 
	`öode_≥ek_ivîsi⁄
(
öode
) - 1;

380  
ªt
;

381 
	}
}

387 
	s‚ame
 {

388 
__u32
 
	mhash
;

389 
__u32
 
	mmö‹_hash
;

390 
rb_node
 
	mrb_hash
;

391 
‚ame
 *
	m√xt
;

392 
__u32
 
	möode
;

393 
__u8
 
	m«me_Àn
;

394 
__u8
 
	mfûe_ty≥
;

395 
	m«me
[0];

402 
	$‰ì_rb_åì_‚ame
(
rb_roŸ
 *
roŸ
)

404 
‚ame
 *‚ame, *
√xt
;

406 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
‚ame
, 
√xt
, 
roŸ
, 
rb_hash
)

407 
‚ame
) {

408 
‚ame
 *
ﬁd
 = fname;

409 
‚ame
 = f«me->
√xt
;

410 
	`k‰ì
(
ﬁd
);

413 *
roŸ
 = 
RB_ROOT
;

414 
	}
}

417 
dú_¥iv©e_öfo
 *
	$pxt4_håì_¸óã_dú_öfo
(
fûe
 *
fûp
,

418 
loff_t
 
pos
)

420 
dú_¥iv©e_öfo
 *
p
;

422 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

423 i‡(!
p
)

424  
NULL
;

425 
p
->
cuº_hash
 = 
	`pos2maj_hash
(
fûp
, 
pos
);

426 
p
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûp
, 
pos
);

427  
p
;

428 
	}
}

430 
	$pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
)

432 
	`‰ì_rb_åì_‚ame
(&
p
->
roŸ
);

433 
	`k‰ì
(
p
);

434 
	}
}

443 
	$pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

444 
__u32
 
mö‹_hash
,

445 
pxt4_dú_íåy_2
 *
dúít
,

446 
fs¸y±_°r
 *
ít_«me
)

448 
rb_node
 **
p
, *
∑ª¡
 = 
NULL
;

449 
‚ame
 *‚ame, *
√w_‚
;

450 
dú_¥iv©e_öfo
 *
öfo
;

451 
Àn
;

453 
öfo
 = 
dú_fûe
->
¥iv©e_d©a
;

454 
p
 = &
öfo
->
roŸ
.
rb_node
;

457 
Àn
 = (
‚ame
Ë+ 
ít_«me
->len + 1;

458 
√w_‚
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

459 i‡(!
√w_‚
)

460  -
ENOMEM
;

461 
√w_‚
->
hash
 = hash;

462 
√w_‚
->
mö‹_hash
 = minor_hash;

463 
√w_‚
->
öode
 = 
	`À32_to_˝u
(
dúít
->inode);

464 
√w_‚
->
«me_Àn
 = 
ít_«me
->
Àn
;

465 
√w_‚
->
fûe_ty≥
 = 
dúít
->file_type;

466 
	`mem˝y
(
√w_‚
->
«me
, 
ít_«me
->«me,É¡_«me->
Àn
);

467 
√w_‚
->
«me
[
ít_«me
->
Àn
] = 0;

469 *
p
) {

470 
∑ª¡
 = *
p
;

471 
‚ame
 = 
	`rb_íåy
(
∑ª¡
, ‚ame, 
rb_hash
);

477 i‡((
√w_‚
->
hash
 =
‚ame
->hash) &&

478 (
√w_‚
->
mö‹_hash
 =
‚ame
->minor_hash)) {

479 
√w_‚
->
√xt
 = 
‚ame
->next;

480 
‚ame
->
√xt
 = 
√w_‚
;

484 i‡(
√w_‚
->
hash
 < 
‚ame
->hash)

485 
p
 = &(*p)->
rb_À·
;

486 i‡(
√w_‚
->
hash
 > 
‚ame
->hash)

487 
p
 = &(*p)->
rb_right
;

488 i‡(
√w_‚
->
mö‹_hash
 < 
‚ame
->minor_hash)

489 
p
 = &(*p)->
rb_À·
;

491 
p
 = &(*p)->
rb_right
;

494 
	`rb_lök_node
(&
√w_‚
->
rb_hash
, 
∑ª¡
, 
p
);

495 
	`rb_ö£π_cﬁ‹
(&
√w_‚
->
rb_hash
, &
öfo
->
roŸ
);

497 
	}
}

506 
	$ˇŒ_fûldú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
,

507 
‚ame
 *fname)

509 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

510 
öode
 *öodê
	`fûe_öode
(
fûe
);

511 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

513 i‡(!
‚ame
) {

514 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

515 "ˇŒed wôhÇuŒ f«me?!?", 
__func__
, 
__LINE__
,

516 
öode
->
i_öo
, 
cuºít
->
comm
);

519 
˘x
->
pos
 = 
	`hash2pos
(
fûe
, 
‚ame
->
hash
, f«me->
mö‹_hash
);

520 
‚ame
) {

521 i‡(!
	`dú_emô
(
˘x
, 
‚ame
->
«me
,

522 
‚ame
->
«me_Àn
,

523 
‚ame
->
öode
,

524 
	`gë_dty≥
(
sb
, 
‚ame
->
fûe_ty≥
))) {

525 
öfo
->
exåa_‚ame
 = 
‚ame
;

528 
‚ame
 = f«me->
√xt
;

531 
	}
}

533 
	$pxt4_dx_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

535 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

536 
öode
 *öodê
	`fûe_öode
(
fûe
);

537 
‚ame
 *fname;

538 
ªt
;

540 i‡(!
öfo
) {

541 
öfo
 = 
	`pxt4_håì_¸óã_dú_öfo
(
fûe
, 
˘x
->
pos
);

542 i‡(!
öfo
)

543  -
ENOMEM
;

544 
fûe
->
¥iv©e_d©a
 = 
öfo
;

547 i‡(
˘x
->
pos
 =
	`pxt4_gë_håì_eof
(
fûe
))

551 i‡(
öfo
->
œ°_pos
 !
˘x
->
pos
) {

552 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

553 
öfo
->
cuº_node
 = 
NULL
;

554 
öfo
->
exåa_‚ame
 = 
NULL
;

555 
öfo
->
cuº_hash
 = 
	`pos2maj_hash
(
fûe
, 
˘x
->
pos
);

556 
öfo
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûe
, 
˘x
->
pos
);

563 i‡(
öfo
->
exåa_‚ame
) {

564 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
öfo
->
exåa_‚ame
))

565 
föished
;

566 
öfo
->
exåa_‚ame
 = 
NULL
;

567 
√xt_node
;

568 } i‡(!
öfo
->
cuº_node
)

569 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

577 i‡((!
öfo
->
cuº_node
) ||

578 !
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

579 
öfo
->
cuº_node
 = 
NULL
;

580 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

581 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

582 
ªt
 = 
	`pxt4_håì_fûl_åì
(
fûe
, 
öfo
->
cuº_hash
,

583 
öfo
->
cuº_mö‹_hash
,

584 &
öfo
->
√xt_hash
);

585 i‡(
ªt
 < 0)

586  
ªt
;

587 i‡(
ªt
 == 0) {

588 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

591 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

594 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, ‚ame, 
rb_hash
);

595 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

596 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

597 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
‚ame
))

599 
√xt_node
:

600 
öfo
->
cuº_node
 = 
	`rb_√xt
(info->curr_node);

601 i‡(
öfo
->
cuº_node
) {

602 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, fname,

603 
rb_hash
);

604 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

605 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

607 i‡(
öfo
->
√xt_hash
 == ~0) {

608 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

611 
öfo
->
cuº_hash
 = info->
√xt_hash
;

612 
öfo
->
cuº_mö‹_hash
 = 0;

615 
föished
:

616 
öfo
->
œ°_pos
 = 
˘x
->
pos
;

618 
	}
}

620 
	$pxt4_dú_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

622 i‡(
	`IS_ENCRYPTED
(
öode
))

623  
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
Ë? -
EACCES
 : 0;

625 
	}
}

627 
	$pxt4_ªÀa£_dú
(
öode
 *öode, 
fûe
 *
fûp
)

629 i‡(
fûp
->
¥iv©e_d©a
)

630 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

633 
	}
}

635 
	$pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
, *
buf
,

636 
buf_size
)

638 
pxt4_dú_íåy_2
 *
de
;

639 
æí
;

640 
off£t
 = 0;

641 *
t›
;

643 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

644 
t›
 = 
buf
 + 
buf_size
;

645 (*Ë
de
 < 
t›
) {

646 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

647 
buf
, 
buf_size
, 
off£t
))

648  -
EFSCORRUPTED
;

649 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

650 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

651 
off£t
 +
æí
;

653 i‡((*Ë
de
 > 
t›
)

654  -
EFSCORRUPTED
;

657 
	}
}

659 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_dú_›î©i⁄s
 = {

660 .
Œ£ek
 = 
pxt4_dú_Œ£ek
,

661 .
	gªad
 = 
gíîic_ªad_dú
,

662 .
	gôî©e_sh¨ed
 = 
pxt4_ªaddú
,

663 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

664 #ifde‡
CONFIG_COMPAT


665 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

667 .
	gfsync
 = 
pxt4_sync_fûe
,

668 .
	g›í
 = 
pxt4_dú_›í
,

669 .
	gªÀa£
 = 
pxt4_ªÀa£_dú
,

672 #ifde‡
CONFIG_UNICODE


673 
	$pxt4_d_com∑ª
(c⁄° 
díåy
 *díåy, 
Àn
,

674 c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

676 
q°r
 q°∏{.
«me
 = 
°r
, .
Àn
 =Üen };

677 c⁄° 
díåy
 *
∑ª¡
 = 
	`READ_ONCE
(díåy->
d_∑ª¡
);

678 c⁄° 
öode
 *öodê
	`READ_ONCE
(
∑ª¡
->
d_öode
);

680 i‡(!
öode
 || !
	`IS_CASEFOLDED
(inode) ||

681 !
	`PXT4_SB
(
öode
->
i_sb
)->
s_ícodög
) {

682 i‡(
Àn
 !
«me
->len)

684  
	`memcmp
(
°r
, 
«me
->«me, 
Àn
);

687  
	`pxt4_ci_com∑ª
(
öode
, 
«me
, &
q°r
, 
Ál£
);

688 
	}
}

690 
	$pxt4_d_hash
(c⁄° 
díåy
 *díåy, 
q°r
 *
°r
)

692 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
díåy
->
d_sb
);

693 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

694 c⁄° 
öode
 *öodê
	`READ_ONCE
(
díåy
->
d_öode
);

695 *
n‹m
;

696 
Àn
, 
ªt
 = 0;

698 i‡(!
öode
 || !
	`IS_CASEFOLDED
(öodeË|| !
um
)

701 
n‹m
 = 
	`kmÆloc
(
PATH_MAX
, 
GFP_ATOMIC
);

702 i‡(!
n‹m
)

703  -
ENOMEM
;

705 
Àn
 = 
	`utf8_ˇ£fﬁd
(
um
, 
°r
, 
n‹m
, 
PATH_MAX
);

706 i‡(
Àn
 < 0) {

707 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

708 
ªt
 = -
EINVAL
;

709 
out
;

711 
°r
->
hash
 = 
	`fuŒ_«me_hash
(
díåy
, 
n‹m
, 
Àn
);

712 
out
:

713 
	`k‰ì
(
n‹m
);

714  
ªt
;

715 
	}
}

717 c⁄° 
díåy_›î©i⁄s
 
	gpxt4_díåy_›s
 = {

718 .
d_hash
 = 
pxt4_d_hash
,

719 .
	gd_com∑ª
 = 
pxt4_d_com∑ª
,

	@extents.c

20 
	~<löux/fs.h
>

21 
	~<löux/time.h
>

22 
	~<löux/jbd3.h
>

23 
	~<löux/highuid.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/quŸa›s.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/uac˚ss.h
>

29 
	~<löux/fõm≠.h
>

30 
	~<löux/backög-dev.h
>

31 
	~"pxt4_jbd3.h
"

32 
	~"pxt4_exã¡s.h
"

33 
	~"x©å.h
"

35 
	~<åa˚/evíts/pxt4.h
>

40 
	#PXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#PXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#PXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#PXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#PXT4_EXT_DATA_VALID2
 0x10

	)

48 
__À32
 
	$pxt4_exã¡_block_csum
(
öode
 *inode,

49 
pxt4_exã¡_hódî
 *
eh
)

51 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

52 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`˝u_to_À32
(
csum
);

58 
	}
}

60 
	$pxt4_exã¡_block_csum_vîify
(
öode
 *inode,

61 
pxt4_exã¡_hódî
 *
eh
)

63 
pxt4_exã¡_èû
 *
ë
;

65 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

68 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

69 i‡(
ë
->
ë_checksum
 !
	`pxt4_exã¡_block_csum
(
öode
, 
eh
))

72 
	}
}

74 
	$pxt4_exã¡_block_csum_£t
(
öode
 *inode,

75 
pxt4_exã¡_hódî
 *
eh
)

77 
pxt4_exã¡_èû
 *
ë
;

79 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

82 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

83 
ë
->
ë_checksum
 = 
	`pxt4_exã¡_block_csum
(
öode
, 
eh
);

84 
	}
}

86 
pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

87 
öode
 *inode,

88 
pxt4_ext_∑th
 **
µ©h
,

89 
pxt4_m≠_blocks
 *
m≠
,

90 
•lô_Êag
,

91 
Êags
);

93 
pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

94 
öode
 *inode,

95 
pxt4_ext_∑th
 **
µ©h
,

96 
pxt4_lblk_t
 
•lô
,

97 
•lô_Êag
,

98 
Êags
);

100 
pxt4_föd_dñayed_exã¡
(
öode
 *inode,

101 
exã¡_°©us
 *
√wes
);

103 
	$pxt4_ext_åunc_ª°¨t_‚
(
öode
 *öode, *
dr›≥d
)

111 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

112 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

113 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

114 *
dr›≥d
 = 1;

116 
	}
}

126 
	$pxt4_d©a£m_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

127 
check_¸ed
, 
ª°¨t_¸ed
,

128 
ªvoke_¸ed
)

130 
ªt
;

131 
dr›≥d
 = 0;

133 
ªt
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
check_¸ed
, 
ª°¨t_¸ed
,

134 
ªvoke_¸ed
, 
	`pxt4_ext_åunc_ª°¨t_‚
(
öode
, &
dr›≥d
));

135 i‡(
dr›≥d
)

136 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

137  
ªt
;

138 
	}
}

145 
	$pxt4_ext_gë_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

146 
pxt4_ext_∑th
 *
∑th
)

148 i‡(
∑th
->
p_bh
) {

150 
	`BUFFER_TRACE
(
∑th
->
p_bh
, "get_write_access");

151  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
∑th
->
p_bh
);

156 
	}
}

164 
	$__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

165 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

167 
îr
;

169 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

170 i‡(
∑th
->
p_bh
) {

171 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
	`ext_block_hdr
(
∑th
->
p_bh
));

173 
îr
 = 
	`__pxt4_h™dÀ_dúty_mëad©a
(
whîe
, 
löe
, 
h™dÀ
,

174 
öode
, 
∑th
->
p_bh
);

177 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

179  
îr
;

180 
	}
}

182 
pxt4_fsblk_t
 
	$pxt4_ext_föd_gﬂl
(
öode
 *inode,

183 
pxt4_ext_∑th
 *
∑th
,

184 
pxt4_lblk_t
 
block
)

186 i‡(
∑th
) {

187 
dïth
 = 
∑th
->
p_dïth
;

188 
pxt4_exã¡
 *
ex
;

207 
ex
 = 
∑th
[
dïth
].
p_ext
;

208 i‡(
ex
) {

209 
pxt4_fsblk_t
 
ext_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

210 
pxt4_lblk_t
 
ext_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

212 i‡(
block
 > 
ext_block
)

213  
ext_pblk
 + (
block
 - 
ext_block
);

215  
ext_pblk
 - (
ext_block
 - 
block
);

220 i‡(
∑th
[
dïth
].
p_bh
)

221  
∑th
[
dïth
].
p_bh
->
b_blockƒ
;

225  
	`pxt4_öode_to_gﬂl_block
(
öode
);

226 
	}
}

231 
pxt4_fsblk_t


232 
	$pxt4_ext_√w_mëa_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

233 
pxt4_ext_∑th
 *
∑th
,

234 
pxt4_exã¡
 *
ex
, *
îr
, 
Êags
)

236 
pxt4_fsblk_t
 
gﬂl
, 
√wblock
;

238 
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
	`À32_to_˝u
(
ex
->
ì_block
));

239 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

240 
NULL
, 
îr
);

241  
√wblock
;

242 
	}
}

244 
ölöe
 
	$pxt4_ext_•a˚_block
(
öode
 *öode, 
check
)

246 
size
;

248 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

249 / (
pxt4_exã¡
);

250 #ifde‡
AGGRESSIVE_TEST


251 i‡(!
check
 && 
size
 > 6)

252 
size
 = 6;

254  
size
;

255 
	}
}

257 
ölöe
 
	$pxt4_ext_•a˚_block_idx
(
öode
 *öode, 
check
)

259 
size
;

261 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

262 / (
pxt4_exã¡_idx
);

263 #ifde‡
AGGRESSIVE_TEST


264 i‡(!
check
 && 
size
 > 5)

265 
size
 = 5;

267  
size
;

268 
	}
}

270 
ölöe
 
	$pxt4_ext_•a˚_roŸ
(
öode
 *öode, 
check
)

272 
size
;

274 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

275 
size
 -(
pxt4_exã¡_hódî
);

276 
size
 /(
pxt4_exã¡
);

277 #ifde‡
AGGRESSIVE_TEST


278 i‡(!
check
 && 
size
 > 3)

279 
size
 = 3;

281  
size
;

282 
	}
}

284 
ölöe
 
	$pxt4_ext_•a˚_roŸ_idx
(
öode
 *öode, 
check
)

286 
size
;

288 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

289 
size
 -(
pxt4_exã¡_hódî
);

290 
size
 /(
pxt4_exã¡_idx
);

291 #ifde‡
AGGRESSIVE_TEST


292 i‡(!
check
 && 
size
 > 4)

293 
size
 = 4;

295  
size
;

296 
	}
}

298 
ölöe
 

299 
	$pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

300 
pxt4_ext_∑th
 **
µ©h
, 
pxt4_lblk_t
 
lblk
,

301 
noÁû
)

303 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

304 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
∑th
[∑th->
p_dïth
].
p_ext
);

306  
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
, 
lblk
, 
unwrôãn
 ?

307 
PXT4_EXT_MARK_UNWRIT1
|
PXT4_EXT_MARK_UNWRIT2
 : 0,

308 
PXT4_EX_NOCACHE
 | 
PXT4_GET_BLOCKS_PRE_IO
 |

309 (
noÁû
 ? 
PXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

310 
	}
}

317 
	$pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
)

319 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

320 
idxs
;

322 
idxs
 = ((
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

323 / (
pxt4_exã¡_idx
));

333 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

334 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
+1 =
lblock
) {

335 
num
 = 0;

337 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % 
idxs
) == 0)

338 
num
++;

339 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs)) == 0)

340 
num
++;

341 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs*idxs)) == 0) {

342 
num
++;

343 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

345 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

346 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
++;

347  
num
;

354 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

355 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
;

356  
	`ext_dïth
(
öode
) + 1;

357 
	}
}

360 
	$pxt4_ext_max_íåõs
(
öode
 *öode, 
dïth
)

362 
max
;

364 i‡(
dïth
 =
	`ext_dïth
(
öode
)) {

365 i‡(
dïth
 == 0)

366 
max
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 1);

368 
max
 = 
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 1);

370 i‡(
dïth
 == 0)

371 
max
 = 
	`pxt4_ext_•a˚_block
(
öode
, 1);

373 
max
 = 
	`pxt4_ext_•a˚_block_idx
(
öode
, 1);

376  
max
;

377 
	}
}

379 
	$pxt4_vÆid_exã¡
(
öode
 *öode, 
pxt4_exã¡
 *
ext
)

381 
pxt4_fsblk_t
 
block
 = 
	`pxt4_ext_pblock
(
ext
);

382 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

383 
pxt4_lblk_t
 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

390 i‡(
lblock
 + 
Àn
 <=Üblock)

392  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 
Àn
);

393 
	}
}

395 
	$pxt4_vÆid_exã¡_idx
(
öode
 *inode,

396 
pxt4_exã¡_idx
 *
ext_idx
)

398 
pxt4_fsblk_t
 
block
 = 
	`pxt4_idx_pblock
(
ext_idx
);

400  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 1);

401 
	}
}

403 
	$pxt4_vÆid_exã¡_íåõs
(
öode
 *inode,

404 
pxt4_exã¡_hódî
 *
eh
,

405 
dïth
)

407 
íåõs
;

408 i‡(
eh
->
eh_íåõs
 == 0)

411 
íåõs
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
);

413 i‡(
dïth
 == 0) {

415 
pxt4_exã¡
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

416 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

417 
pxt4_fsblk_t
 
pblock
 = 0;

418 
pxt4_lblk_t
 
lblock
 = 0;

419 
pxt4_lblk_t
 
¥ev
 = 0;

420 
Àn
 = 0;

421 
íåõs
) {

422 i‡(!
	`pxt4_vÆid_exã¡
(
öode
, 
ext
))

426 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

427 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

428 i‡((
lblock
 <
¥ev
) &&Örev) {

429 
pblock
 = 
	`pxt4_ext_pblock
(
ext
);

430 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
pblock
);

433 
ext
++;

434 
íåõs
--;

435 
¥ev
 = 
lblock
 + 
Àn
 - 1;

438 
pxt4_exã¡_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

439 
íåõs
) {

440 i‡(!
	`pxt4_vÆid_exã¡_idx
(
öode
, 
ext_idx
))

442 
ext_idx
++;

443 
íåõs
--;

447 
	}
}

449 
	$__pxt4_ext_check
(c⁄° *
fun˘i⁄
, 
löe
,

450 
öode
 *öode, 
pxt4_exã¡_hódî
 *
eh
,

451 
dïth
, 
pxt4_fsblk_t
 
pblk
)

453 c⁄° *
îr‹_msg
;

454 
max
 = 0, 
îr
 = -
EFSCORRUPTED
;

456 i‡(
	`u∆ikñy
(
eh
->
eh_magic
 !
PXT4_EXT_MAGIC
)) {

457 
îr‹_msg
 = "invalid magic";

458 
c‹ru±ed
;

460 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_dïth
Ë!
dïth
)) {

461 
îr‹_msg
 = "unexpectedÉh_depth";

462 
c‹ru±ed
;

464 i‡(
	`u∆ikñy
(
eh
->
eh_max
 == 0)) {

465 
îr‹_msg
 = "invalidÉh_max";

466 
c‹ru±ed
;

468 
max
 = 
	`pxt4_ext_max_íåõs
(
öode
, 
dïth
);

469 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_max
Ë> 
max
)) {

470 
îr‹_msg
 = "tooÜargeÉh_max";

471 
c‹ru±ed
;

473 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë>Üe16_to_˝u”h->
eh_max
))) {

474 
îr‹_msg
 = "invalidÉh_entries";

475 
c‹ru±ed
;

477 i‡(!
	`pxt4_vÆid_exã¡_íåõs
(
öode
, 
eh
, 
dïth
)) {

478 
îr‹_msg
 = "invalidÉxtentÉntries";

479 
c‹ru±ed
;

481 i‡(
	`u∆ikñy
(
dïth
 > 32)) {

482 
îr‹_msg
 = "tooÜargeÉh_depth";

483 
c‹ru±ed
;

486 i‡(
	`ext_dïth
(
öode
Ë!
dïth
 &&

487 !
	`pxt4_exã¡_block_csum_vîify
(
öode
, 
eh
)) {

488 
îr‹_msg
 = "extentÅree corrupted";

489 
îr
 = -
EFSBADCRC
;

490 
c‹ru±ed
;

494 
c‹ru±ed
:

495 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

498 (Ë
pblk
, 
îr‹_msg
,

499 
	`À16_to_˝u
(
eh
->
eh_magic
),

500 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
),

501 
max
, 
	`À16_to_˝u
(
eh
->
eh_dïth
), 
dïth
);

502  
îr
;

503 
	}
}

505 
	#pxt4_ext_check
(
öode
, 
eh
, 
dïth
, 
pblk
) \

506 
	`__pxt4_ext_check
(
__func__
, 
__LINE__
, (
öode
), (
eh
), (
dïth
), (
pblk
))

	)

508 
	$pxt4_ext_check_öode
(
öode
 *inode)

510  
	`pxt4_ext_check
(
öode
, 
	`ext_öode_hdr
(öode), 
	`ext_dïth
(inode), 0);

511 
	}
}

513 
buf„r_hód
 *

514 
	$__ªad_exã¡_åì_block
(c⁄° *
fun˘i⁄
, 
löe
,

515 
öode
 *öode, 
pxt4_fsblk_t
 
pblk
, 
dïth
,

516 
Êags
)

518 
buf„r_hód
 *
bh
;

519 
îr
;

521 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

522 i‡(
	`u∆ikñy
(!
bh
))

523  
	`ERR_PTR
(-
ENOMEM
);

525 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

526 
	`åa˚_pxt4_ext_lﬂd_exã¡
(
öode
, 
pblk
, 
_RET_IP_
);

527 
îr
 = 
	`bh_submô_ªad
(
bh
);

528 i‡(
îr
 < 0)

529 
îrout
;

531 i‡(
	`buf„r_vîifõd
(
bh
Ë&& !(
Êags
 & 
PXT4_EX_FORCE_CACHE
))

532  
bh
;

533 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) ||

534 (
öode
->
i_öo
 !=

535 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
))) {

536 
îr
 = 
	`__pxt4_ext_check
(
fun˘i⁄
, 
löe
, 
öode
,

537 
	`ext_block_hdr
(
bh
), 
dïth
, 
pblk
);

538 i‡(
îr
)

539 
îrout
;

541 
	`£t_buf„r_vîifõd
(
bh
);

545 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0) {

546 
pxt4_exã¡_hódî
 *
eh
 = 
	`ext_block_hdr
(
bh
);

547 
pxt4_exã¡
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

548 
pxt4_lblk_t
 
¥ev
 = 0;

549 
i
;

551 
i
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i > 0; i--, 
ex
++) {

552 
°©us
 = 
EXTENT_STATUS_WRITTEN
;

553 
pxt4_lblk_t
 
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

554 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

556 i‡(
¥ev
 && (¥ev !
lblk
))

557 
	`pxt4_es_ˇche_exã¡
(
öode
, 
¥ev
,

558 
lblk
 - 
¥ev
, ~0,

559 
EXTENT_STATUS_HOLE
);

561 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

562 
°©us
 = 
EXTENT_STATUS_UNWRITTEN
;

563 
	`pxt4_es_ˇche_exã¡
(
öode
, 
lblk
, 
Àn
,

564 
	`pxt4_ext_pblock
(
ex
), 
°©us
);

565 
¥ev
 = 
lblk
 + 
Àn
;

568  
bh
;

569 
îrout
:

570 
	`put_bh
(
bh
);

571  
	`ERR_PTR
(
îr
);

573 
	}
}

575 
	#ªad_exã¡_åì_block
(
öode
, 
pblk
, 
dïth
, 
Êags
) \

576 
	`__ªad_exã¡_åì_block
(
__func__
, 
__LINE__
, (
öode
), (
pblk
), \

577 (
dïth
), (
Êags
))

	)

583 
	$pxt4_ext_¥eˇche
(
öode
 *inode)

585 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

586 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

587 
buf„r_hód
 *
bh
;

588 
i
 = 0, 
dïth
, 
ªt
 = 0;

590 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

593 
	`down_ªad
(&
ei
->
i_d©a_£m
);

594 
dïth
 = 
	`ext_dïth
(
öode
);

596 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

597 
GFP_NOFS
);

598 i‡(
∑th
 =
NULL
) {

599 
	`up_ªad
(&
ei
->
i_d©a_£m
);

600  -
ENOMEM
;

604 i‡(
dïth
 == 0)

605 
out
;

606 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

607 
ªt
 = 
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0);

608 i‡(
ªt
)

609 
out
;

610 
∑th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[0].
p_hdr
);

611 
i
 >= 0) {

616 i‡((
i
 =
dïth
) ||

617 
∑th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
)) {

618 
	`bªl£
(
∑th
[
i
].
p_bh
);

619 
∑th
[
i
].
p_bh
 = 
NULL
;

620 
i
--;

623 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

624 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
++),

625 
dïth
 - 
i
 - 1,

626 
PXT4_EX_FORCE_CACHE
);

627 i‡(
	`IS_ERR
(
bh
)) {

628 
ªt
 = 
	`PTR_ERR
(
bh
);

631 
i
++;

632 
∑th
[
i
].
p_bh
 = 
bh
;

633 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

634 
∑th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[i].
p_hdr
);

636 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

637 
out
:

638 
	`up_ªad
(&
ei
->
i_d©a_£m
);

639 
	`pxt4_ext_dr›_ªfs
(
∑th
);

640 
	`k‰ì
(
∑th
);

641  
ªt
;

642 
	}
}

644 #ifde‡
EXT_DEBUG


645 
	$pxt4_ext_show_∑th
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

647 
k
, 
l
 = 
∑th
->
p_dïth
;

649 
	`ext_debug
("path:");

650 
k
 = 0; k <
l
; k++, 
∑th
++) {

651 i‡(
∑th
->
p_idx
) {

652 
	`ext_debug
(" %d->%Œu", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

653 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

654 } i‡(
∑th
->
p_ext
) {

655 
	`ext_debug
(" %d:[%d]%d:%llu ",

656 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

657 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

658 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
),

659 
	`pxt4_ext_pblock
(
∑th
->
p_ext
));

661 
	`ext_debug
(" []");

663 
	`ext_debug
("\n");

664 
	}
}

666 
	$pxt4_ext_show_Àaf
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

668 
dïth
 = 
	`ext_dïth
(
öode
);

669 
pxt4_exã¡_hódî
 *
eh
;

670 
pxt4_exã¡
 *
ex
;

671 
i
;

673 i‡(!
∑th
)

676 
eh
 = 
∑th
[
dïth
].
p_hdr
;

677 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

679 
	`ext_debug
("Di•œyögÜó‡exã¡†f‹ inodê%lu\n", 
öode
->
i_öo
);

681 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ex
++) {

682 
	`ext_debug
("%d:[%d]%d:%Œu ", 
	`À32_to_˝u
(
ex
->
ì_block
),

683 
	`pxt4_ext_is_unwrôãn
(
ex
),

684 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
), 
	`pxt4_ext_pblock
(ex));

686 
	`ext_debug
("\n");

687 
	}
}

689 
	$pxt4_ext_show_move
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
,

690 
pxt4_fsblk_t
 
√wblock
, 
Àvñ
)

692 
dïth
 = 
	`ext_dïth
(
öode
);

693 
pxt4_exã¡
 *
ex
;

695 i‡(
dïth
 !
Àvñ
) {

696 
pxt4_exã¡_idx
 *
idx
;

697 
idx
 = 
∑th
[
Àvñ
].
p_idx
;

698 
idx
 <
	`EXT_MAX_INDEX
(
∑th
[
Àvñ
].
p_hdr
)) {

699 
	`ext_debug
("%d: movê%d:%Œu i¿√w index %Œu\n", 
Àvñ
,

700 
	`À32_to_˝u
(
idx
->
ei_block
),

701 
	`pxt4_idx_pblock
(
idx
),

702 
√wblock
);

703 
idx
++;

709 
ex
 = 
∑th
[
dïth
].
p_ext
;

710 
ex
 <
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

711 
	`ext_debug
("move %d:%llu:[%d]%d inÇewÜeaf %llu\n",

712 
	`À32_to_˝u
(
ex
->
ì_block
),

713 
	`pxt4_ext_pblock
(
ex
),

714 
	`pxt4_ext_is_unwrôãn
(
ex
),

715 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

716 
√wblock
);

717 
ex
++;

719 
	}
}

722 
	#pxt4_ext_show_∑th
(
öode
, 
∑th
)

	)

723 
	#pxt4_ext_show_Àaf
(
öode
, 
∑th
)

	)

724 
	#pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
Àvñ
)

	)

727 
	$pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *
∑th
)

729 
dïth
, 
i
;

731 i‡(!
∑th
)

733 
dïth
 = 
∑th
->
p_dïth
;

734 
i
 = 0; i <
dïth
; i++, 
∑th
++)

735 i‡(
∑th
->
p_bh
) {

736 
	`bªl£
(
∑th
->
p_bh
);

737 
∑th
->
p_bh
 = 
NULL
;

739 
	}
}

747 
	$pxt4_ext_bö£¨ch_idx
(
öode
 *inode,

748 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

750 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

751 
pxt4_exã¡_idx
 *
r
, *
l
, *
m
;

754 
	`ext_debug
("bö£¨ch f‹ %u(idx): ", 
block
);

756 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

757 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

758 
l
 <
r
) {

759 
m
 = 
l
 + (
r
 -Ü) / 2;

760 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ei_block
))

761 
r
 = 
m
 - 1;

763 
l
 = 
m
 + 1;

764 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ei_block
),

765 
m
, 
	`À32_to_˝u
(m->
ei_block
),

766 
r
, 
	`À32_to_˝u
‘->
ei_block
));

769 
∑th
->
p_idx
 = 
l
 - 1;

770 
	`ext_debug
(" -> %u->%Œd ", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

771 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

773 #ifde‡
CHECK_BINSEARCH


775 
pxt4_exã¡_idx
 *
chix
, *
ix
;

776 
k
;

778 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

779 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ix
++) {

780 i‡(
k
 != 0 &&

781 
	`À32_to_˝u
(
ix
->
ei_block
) <=Üe32_to_cpu(ix[-1].ei_block)) {

782 
	`¥ötk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

783 "fú°=0x%p\n", 
k
,

784 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

785 
	`¥ötk
(
KERN_DEBUG
 "%u <= %u\n",

786 
	`À32_to_˝u
(
ix
->
ei_block
),

787 
	`À32_to_˝u
(
ix
[-1].
ei_block
));

789 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ix
->
ei_block
)

790 <
	`À32_to_˝u
(
ix
[-1].
ei_block
));

791 i‡(
block
 < 
	`À32_to_˝u
(
ix
->
ei_block
))

793 
chix
 = 
ix
;

795 
	`BUG_ON
(
chix
 !
∑th
->
p_idx
);

799 
	}
}

807 
	$pxt4_ext_bö£¨ch
(
öode
 *inode,

808 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

810 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

811 
pxt4_exã¡
 *
r
, *
l
, *
m
;

813 i‡(
eh
->
eh_íåõs
 == 0) {

821 
	`ext_debug
("bö£¨ch f‹ %u: ", 
block
);

823 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

824 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

826 
l
 <
r
) {

827 
m
 = 
l
 + (
r
 -Ü) / 2;

828 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ì_block
))

829 
r
 = 
m
 - 1;

831 
l
 = 
m
 + 1;

832 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ì_block
),

833 
m
, 
	`À32_to_˝u
(m->
ì_block
),

834 
r
, 
	`À32_to_˝u
‘->
ì_block
));

837 
∑th
->
p_ext
 = 
l
 - 1;

838 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

839 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

840 
	`pxt4_ext_pblock
(
∑th
->
p_ext
),

841 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

842 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
));

844 #ifde‡
CHECK_BINSEARCH


846 
pxt4_exã¡
 *
chex
, *
ex
;

847 
k
;

849 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

850 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ex
++) {

851 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ex
->
ì_block
)

852 <
	`À32_to_˝u
(
ex
[-1].
ì_block
));

853 i‡(
block
 < 
	`À32_to_˝u
(
ex
->
ì_block
))

855 
chex
 = 
ex
;

857 
	`BUG_ON
(
chex
 !
∑th
->
p_ext
);

861 
	}
}

863 
	$pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

865 
pxt4_exã¡_hódî
 *
eh
;

867 
eh
 = 
	`ext_öode_hdr
(
öode
);

868 
eh
->
eh_dïth
 = 0;

869 
eh
->
eh_íåõs
 = 0;

870 
eh
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

871 
eh
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

872 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

874 
	}
}

876 
pxt4_ext_∑th
 *

877 
	$pxt4_föd_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

878 
pxt4_ext_∑th
 **
‹ig_∑th
, 
Êags
)

880 
pxt4_exã¡_hódî
 *
eh
;

881 
buf„r_hód
 *
bh
;

882 
pxt4_ext_∑th
 *
∑th
 = 
‹ig_∑th
 ? *‹ig_∑th : 
NULL
;

883 
dïth
, 
i
, 
µos
 = 0;

884 
ªt
;

886 
eh
 = 
	`ext_öode_hdr
(
öode
);

887 
dïth
 = 
	`ext_dïth
(
öode
);

888 i‡(
dïth
 < 0 || dïth > 
PXT4_MAX_EXTENT_DEPTH
) {

889 
	`PXT4_ERROR_INODE
(
öode
, "inode has invalidÉxtent depth: %d",

890 
dïth
);

891 
ªt
 = -
EFSCORRUPTED
;

892 
îr
;

895 i‡(
∑th
) {

896 
	`pxt4_ext_dr›_ªfs
(
∑th
);

897 i‡(
dïth
 > 
∑th
[0].
p_maxdïth
) {

898 
	`k‰ì
(
∑th
);

899 *
‹ig_∑th
 = 
∑th
 = 
NULL
;

902 i‡(!
∑th
) {

904 
∑th
 = 
	`kˇŒoc
(
dïth
 + 2, (
pxt4_ext_∑th
),

905 
GFP_NOFS
);

906 i‡(
	`u∆ikñy
(!
∑th
))

907  
	`ERR_PTR
(-
ENOMEM
);

908 
∑th
[0].
p_maxdïth
 = 
dïth
 + 1;

910 
∑th
[0].
p_hdr
 = 
eh
;

911 
∑th
[0].
p_bh
 = 
NULL
;

913 
i
 = 
dïth
;

915 
i
) {

916 
	`ext_debug
("depth %d:Çum %d, max %d\n",

917 
µos
, 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

919 
	`pxt4_ext_bö£¨ch_idx
(
öode
, 
∑th
 + 
µos
, 
block
);

920 
∑th
[
µos
].
p_block
 = 
	`pxt4_idx_pblock
’©h[µos].
p_idx
);

921 
∑th
[
µos
].
p_dïth
 = 
i
;

922 
∑th
[
µos
].
p_ext
 = 
NULL
;

924 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
∑th
[
µos
].
p_block
, --
i
,

925 
Êags
);

926 i‡(
	`IS_ERR
(
bh
)) {

927 
ªt
 = 
	`PTR_ERR
(
bh
);

928 
îr
;

931 
eh
 = 
	`ext_block_hdr
(
bh
);

932 
µos
++;

933 
∑th
[
µos
].
p_bh
 = 
bh
;

934 
∑th
[
µos
].
p_hdr
 = 
eh
;

937 
∑th
[
µos
].
p_dïth
 = 
i
;

938 
∑th
[
µos
].
p_ext
 = 
NULL
;

939 
∑th
[
µos
].
p_idx
 = 
NULL
;

942 
	`pxt4_ext_bö£¨ch
(
öode
, 
∑th
 + 
µos
, 
block
);

944 i‡(
∑th
[
µos
].
p_ext
)

945 
∑th
[
µos
].
p_block
 = 
	`pxt4_ext_pblock
’©h[µos].
p_ext
);

947 
	`pxt4_ext_show_∑th
(
öode
, 
∑th
);

949  
∑th
;

951 
îr
:

952 
	`pxt4_ext_dr›_ªfs
(
∑th
);

953 
	`k‰ì
(
∑th
);

954 i‡(
‹ig_∑th
)

955 *
‹ig_∑th
 = 
NULL
;

956  
	`ERR_PTR
(
ªt
);

957 
	}
}

964 
	$pxt4_ext_ö£π_ödex
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

965 
pxt4_ext_∑th
 *
cuΩ
,

966 
logiˇl
, 
pxt4_fsblk_t
 
±r
)

968 
pxt4_exã¡_idx
 *
ix
;

969 
Àn
, 
îr
;

971 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
cuΩ
);

972 i‡(
îr
)

973  
îr
;

975 i‡(
	`u∆ikñy
(
logiˇl
 =
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
))) {

976 
	`PXT4_ERROR_INODE
(
öode
,

978 
logiˇl
, 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
));

979  -
EFSCORRUPTED
;

982 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
)

983 >
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
))) {

984 
	`PXT4_ERROR_INODE
(
öode
,

986 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
),

987 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
));

988  -
EFSCORRUPTED
;

991 i‡(
logiˇl
 > 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
)) {

993 
	`ext_debug
("ö£πÇew index %dá·î: %Œu\n", 
logiˇl
, 
±r
);

994 
ix
 = 
cuΩ
->
p_idx
 + 1;

997 
	`ext_debug
("ö£πÇew index %d bef‹e: %Œu\n", 
logiˇl
, 
±r
);

998 
ix
 = 
cuΩ
->
p_idx
;

1001 
Àn
 = 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
Ë- 
ix
 + 1;

1002 
	`BUG_ON
(
Àn
 < 0);

1003 i‡(
Àn
 > 0) {

1004 
	`ext_debug
("insertÇew index %d: "

1006 
logiˇl
, 
Àn
, 
ix
, ix + 1);

1007 
	`memmove
(
ix
 + 1, ix, 
Àn
 * (
pxt4_exã¡_idx
));

1010 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_MAX_INDEX
(
cuΩ
->
p_hdr
))) {

1011 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_MAX_INDEX!");

1012  -
EFSCORRUPTED
;

1015 
ix
->
ei_block
 = 
	`˝u_to_À32
(
logiˇl
);

1016 
	`pxt4_idx_°‹e_pblock
(
ix
, 
±r
);

1017 
	`À16_add_˝u
(&
cuΩ
->
p_hdr
->
eh_íåõs
, 1);

1019 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
))) {

1020 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_LAST_INDEX!");

1021  -
EFSCORRUPTED
;

1024 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
cuΩ
);

1025 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

1027  
îr
;

1028 
	}
}

1040 
	$pxt4_ext_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1041 
Êags
,

1042 
pxt4_ext_∑th
 *
∑th
,

1043 
pxt4_exã¡
 *
√wext
, 
©
)

1045 
buf„r_hód
 *
bh
 = 
NULL
;

1046 
dïth
 = 
	`ext_dïth
(
öode
);

1047 
pxt4_exã¡_hódî
 *
√h
;

1048 
pxt4_exã¡_idx
 *
fidx
;

1049 
i
 = 
©
, 
k
, 
m
, 
a
;

1050 
pxt4_fsblk_t
 
√wblock
, 
ﬁdblock
;

1051 
__À32
 
b‹dî
;

1052 
pxt4_fsblk_t
 *
ablocks
 = 
NULL
;

1053 
îr
 = 0;

1054 
size_t
 
ext_size
 = 0;

1061 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 > 
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
))) {

1062 
	`PXT4_ERROR_INODE
(
öode
, "p_ext > EXT_MAX_EXTENT!");

1063  -
EFSCORRUPTED
;

1065 i‡(
∑th
[
dïth
].
p_ext
 !
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
)) {

1066 
b‹dî
 = 
∑th
[
dïth
].
p_ext
[1].
ì_block
;

1067 
	`ext_debug
("leaf will be split."

1069 
	`À32_to_˝u
(
b‹dî
));

1071 
b‹dî
 = 
√wext
->
ì_block
;

1072 
	`ext_debug
("leaf will beádded."

1074 
	`À32_to_˝u
(
b‹dî
));

1089 
ablocks
 = 
	`kˇŒoc
(
dïth
, (
pxt4_fsblk_t
), 
GFP_NOFS
);

1090 i‡(!
ablocks
)

1091  -
ENOMEM
;

1094 
	`ext_debug
("Æloˇã %d block†f‹ indexes/Àaf\n", 
dïth
 - 
©
);

1095 
a
 = 0;á < 
dïth
 - 
©
;á++) {

1096 
√wblock
 = 
	`pxt4_ext_√w_mëa_block
(
h™dÀ
, 
öode
, 
∑th
,

1097 
√wext
, &
îr
, 
Êags
);

1098 i‡(
√wblock
 == 0)

1099 
˛ónup
;

1100 
ablocks
[
a
] = 
√wblock
;

1104 
√wblock
 = 
ablocks
[--
a
];

1105 i‡(
	`u∆ikñy
(
√wblock
 == 0)) {

1106 
	`PXT4_ERROR_INODE
(
öode
, "newblock == 0!");

1107 
îr
 = -
EFSCORRUPTED
;

1108 
˛ónup
;

1110 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1111 i‡(
	`u∆ikñy
(!
bh
)) {

1112 
îr
 = -
ENOMEM
;

1113 
˛ónup
;

1115 
	`lock_buf„r
(
bh
);

1117 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1118 i‡(
îr
)

1119 
˛ónup
;

1121 
√h
 = 
	`ext_block_hdr
(
bh
);

1122 
√h
->
eh_íåõs
 = 0;

1123 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1124 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1125 
√h
->
eh_dïth
 = 0;

1128 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 !=

1129 
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

1130 
	`PXT4_ERROR_INODE
(
öode
, "eh_entries %d !=Éh_max %d!",

1131 
∑th
[
dïth
].
p_hdr
->
eh_íåõs
,

1132 
∑th
[
dïth
].
p_hdr
->
eh_max
);

1133 
îr
 = -
EFSCORRUPTED
;

1134 
˛ónup
;

1137 
m
 = 
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë-Ö©h[dïth].
p_ext
++;

1138 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
dïth
);

1139 i‡(
m
) {

1140 
pxt4_exã¡
 *
ex
;

1141 
ex
 = 
	`EXT_FIRST_EXTENT
(
√h
);

1142 
	`memmove
(
ex
, 
∑th
[
dïth
].
p_ext
, (
pxt4_exã¡
Ë* 
m
);

1143 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1147 
ext_size
 = (
pxt4_exã¡_hódî
) +

1148 (
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
);

1149 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1150 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1151 
	`£t_buf„r_u±od©e
(
bh
);

1152 
	`u∆ock_buf„r
(
bh
);

1154 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1155 i‡(
îr
)

1156 
˛ónup
;

1157 
	`bªl£
(
bh
);

1158 
bh
 = 
NULL
;

1161 i‡(
m
) {

1162 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1163 i‡(
îr
)

1164 
˛ónup
;

1165 
	`À16_add_˝u
(&
∑th
[
dïth
].
p_hdr
->
eh_íåõs
, -
m
);

1166 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1167 i‡(
îr
)

1168 
˛ónup
;

1173 
k
 = 
dïth
 - 
©
 - 1;

1174 i‡(
	`u∆ikñy
(
k
 < 0)) {

1175 
	`PXT4_ERROR_INODE
(
öode
, "k %d < 0!", 
k
);

1176 
îr
 = -
EFSCORRUPTED
;

1177 
˛ónup
;

1179 i‡(
k
)

1180 
	`ext_debug
("¸óã %d i¡îmedüã indi˚s\n", 
k
);

1183 
i
 = 
dïth
 - 1;

1184 
k
--) {

1185 
ﬁdblock
 = 
√wblock
;

1186 
√wblock
 = 
ablocks
[--
a
];

1187 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
√wblock
);

1188 i‡(
	`u∆ikñy
(!
bh
)) {

1189 
îr
 = -
ENOMEM
;

1190 
˛ónup
;

1192 
	`lock_buf„r
(
bh
);

1194 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1195 i‡(
îr
)

1196 
˛ónup
;

1198 
√h
 = 
	`ext_block_hdr
(
bh
);

1199 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1200 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1201 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1202 
√h
->
eh_dïth
 = 
	`˝u_to_À16
(
dïth
 - 
i
);

1203 
fidx
 = 
	`EXT_FIRST_INDEX
(
√h
);

1204 
fidx
->
ei_block
 = 
b‹dî
;

1205 
	`pxt4_idx_°‹e_pblock
(
fidx
, 
ﬁdblock
);

1207 
	`ext_debug
("int.indexát %d (block %llu): %u -> %llu\n",

1208 
i
, 
√wblock
, 
	`À32_to_˝u
(
b‹dî
), 
ﬁdblock
);

1211 i‡(
	`u∆ikñy
(
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
) !=

1212 
	`EXT_LAST_INDEX
(
∑th
[
i
].
p_hdr
))) {

1213 
	`PXT4_ERROR_INODE
(
öode
,

1215 
	`À32_to_˝u
(
∑th
[
i
].
p_ext
->
ì_block
));

1216 
îr
 = -
EFSCORRUPTED
;

1217 
˛ónup
;

1220 
m
 = 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
Ë-Ö©h[i].
p_idx
++;

1221 
	`ext_debug
("cu∏0x%p,Üa° 0x%p\n", 
∑th
[
i
].
p_idx
,

1222 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
));

1223 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
i
);

1224 i‡(
m
) {

1225 
	`memmove
(++
fidx
, 
∑th
[
i
].
p_idx
,

1226 (
pxt4_exã¡_idx
Ë* 
m
);

1227 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1230 
ext_size
 = (
pxt4_exã¡_hódî
) +

1231 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
));

1232 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1233 
öode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1234 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1235 
	`£t_buf„r_u±od©e
(
bh
);

1236 
	`u∆ock_buf„r
(
bh
);

1238 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1239 i‡(
îr
)

1240 
˛ónup
;

1241 
	`bªl£
(
bh
);

1242 
bh
 = 
NULL
;

1245 i‡(
m
) {

1246 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1247 i‡(
îr
)

1248 
˛ónup
;

1249 
	`À16_add_˝u
(&
∑th
[
i
].
p_hdr
->
eh_íåõs
, -
m
);

1250 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1251 i‡(
îr
)

1252 
˛ónup
;

1255 
i
--;

1259 
îr
 = 
	`pxt4_ext_ö£π_ödex
(
h™dÀ
, 
öode
, 
∑th
 + 
©
,

1260 
	`À32_to_˝u
(
b‹dî
), 
√wblock
);

1262 
˛ónup
:

1263 i‡(
bh
) {

1264 i‡(
	`buf„r_locked
(
bh
))

1265 
	`u∆ock_buf„r
(
bh
);

1266 
	`bªl£
(
bh
);

1269 i‡(
îr
) {

1271 
i
 = 0; i < 
dïth
; i++) {

1272 i‡(!
ablocks
[
i
])

1274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ablocks
[
i
], 1,

1275 
PXT4_FREE_BLOCKS_METADATA
);

1278 
	`k‰ì
(
ablocks
);

1280  
îr
;

1281 
	}
}

1291 
	$pxt4_ext_grow_ödïth
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1292 
Êags
)

1294 
pxt4_exã¡_hódî
 *
√h
;

1295 
buf„r_hód
 *
bh
;

1296 
pxt4_fsblk_t
 
√wblock
, 
gﬂl
 = 0;

1297 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

1298 
îr
 = 0;

1299 
size_t
 
ext_size
 = 0;

1302 i‡(
	`ext_dïth
(
öode
))

1303 
gﬂl
 = 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_öode_hdr
(
öode
)));

1304 i‡(
gﬂl
 > 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
)) {

1305 
Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

1306 
gﬂl
--;

1308 
gﬂl
 = 
	`pxt4_öode_to_gﬂl_block
(
öode
);

1309 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

1310 
NULL
, &
îr
);

1311 i‡(
√wblock
 == 0)

1312  
îr
;

1314 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1315 i‡(
	`u∆ikñy
(!
bh
))

1316  -
ENOMEM
;

1317 
	`lock_buf„r
(
bh
);

1319 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1320 i‡(
îr
) {

1321 
	`u∆ock_buf„r
(
bh
);

1322 
out
;

1325 
ext_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

1327 
	`memmove
(
bh
->
b_d©a
, 
	`PXT4_I
(
öode
)->
i_d©a
, 
ext_size
);

1329 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1332 
√h
 = 
	`ext_block_hdr
(
bh
);

1335 i‡(
	`ext_dïth
(
öode
))

1336 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1338 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1339 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1340 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1341 
	`£t_buf„r_u±od©e
(
bh
);

1342 
	`u∆ock_buf„r
(
bh
);

1344 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1345 i‡(
îr
)

1346 
out
;

1349 
√h
 = 
	`ext_öode_hdr
(
öode
);

1350 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1351 
	`pxt4_idx_°‹e_pblock
(
	`EXT_FIRST_INDEX
(
√h
), 
√wblock
);

1352 i‡(
√h
->
eh_dïth
 == 0) {

1354 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 0));

1355 
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
 =

1356 
	`EXT_FIRST_EXTENT
(
√h
)->
ì_block
;

1358 
	`ext_debug
("newÑoot:Çum %d(%d),Üblock %d,Ötr %llu\n",

1359 
	`À16_to_˝u
(
√h
->
eh_íåõs
),Üe16_to_˝u“eh->
eh_max
),

1360 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
),

1361 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
√h
)));

1363 
	`À16_add_˝u
(&
√h
->
eh_dïth
, 1);

1364 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1365 
out
:

1366 
	`bªl£
(
bh
);

1368  
îr
;

1369 
	}
}

1376 
	$pxt4_ext_¸óã_√w_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1377 
mb_Êags
,

1378 
gb_Êags
,

1379 
pxt4_ext_∑th
 **
µ©h
,

1380 
pxt4_exã¡
 *
√wext
)

1382 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1383 
pxt4_ext_∑th
 *
cuΩ
;

1384 
dïth
, 
i
, 
îr
 = 0;

1386 
ª≥©
:

1387 
i
 = 
dïth
 = 
	`ext_dïth
(
öode
);

1390 
cuΩ
 = 
∑th
 + 
dïth
;

1391 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1392 
i
--;

1393 
cuΩ
--;

1398 i‡(
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1401 
îr
 = 
	`pxt4_ext_•lô
(
h™dÀ
, 
öode
, 
mb_Êags
, 
∑th
, 
√wext
, 
i
);

1402 i‡(
îr
)

1403 
out
;

1406 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1407 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1408 
µ©h
, 
gb_Êags
);

1409 i‡(
	`IS_ERR
(
∑th
))

1410 
îr
 = 
	`PTR_ERR
(
∑th
);

1413 
îr
 = 
	`pxt4_ext_grow_ödïth
(
h™dÀ
, 
öode
, 
mb_Êags
);

1414 i‡(
îr
)

1415 
out
;

1418 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1419 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1420 
µ©h
, 
gb_Êags
);

1421 i‡(
	`IS_ERR
(
∑th
)) {

1422 
îr
 = 
	`PTR_ERR
(
∑th
);

1423 
out
;

1430 
dïth
 = 
	`ext_dïth
(
öode
);

1431 i‡(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 =∑th[dïth].p_hdr->
eh_max
) {

1433 
ª≥©
;

1437 
out
:

1438  
îr
;

1439 
	}
}

1448 
	$pxt4_ext_£¨ch_À·
(
öode
 *inode,

1449 
pxt4_ext_∑th
 *
∑th
,

1450 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
)

1452 
pxt4_exã¡_idx
 *
ix
;

1453 
pxt4_exã¡
 *
ex
;

1454 
dïth
, 
ì_Àn
;

1456 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1457 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1458  -
EFSCORRUPTED
;

1460 
dïth
 = 
∑th
->
p_dïth
;

1461 *
phys
 = 0;

1463 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1470 
ex
 = 
∑th
[
dïth
].
p_ext
;

1471 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1472 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1473 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1474 
	`PXT4_ERROR_INODE
(
öode
,

1476 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
));

1477  -
EFSCORRUPTED
;

1479 --
dïth
 >= 0) {

1480 
ix
 = 
∑th
[
dïth
].
p_idx
;

1481 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1482 
	`PXT4_ERROR_INODE
(
öode
,

1484 
ix
 !
NULL
 ? 
	`À32_to_˝u
(ix->
ei_block
) : 0,

1485 
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
Ë!
NULL
 ?

1486 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
)->
ei_block
) : 0,

1487 
dïth
);

1488  -
EFSCORRUPTED
;

1494 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1495 
	`PXT4_ERROR_INODE
(
öode
,

1497 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1498  -
EFSCORRUPTED
;

1501 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1;

1502 *
phys
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

1504 
	}
}

1513 
	$pxt4_ext_£¨ch_right
(
öode
 *inode,

1514 
pxt4_ext_∑th
 *
∑th
,

1515 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
,

1516 
pxt4_exã¡
 **
ªt_ex
)

1518 
buf„r_hód
 *
bh
 = 
NULL
;

1519 
pxt4_exã¡_hódî
 *
eh
;

1520 
pxt4_exã¡_idx
 *
ix
;

1521 
pxt4_exã¡
 *
ex
;

1522 
pxt4_fsblk_t
 
block
;

1523 
dïth
;

1524 
ì_Àn
;

1526 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1527 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1528  -
EFSCORRUPTED
;

1530 
dïth
 = 
∑th
->
p_dïth
;

1531 *
phys
 = 0;

1533 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1540 
ex
 = 
∑th
[
dïth
].
p_ext
;

1541 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1542 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1543 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1544 
	`PXT4_ERROR_INODE
(
öode
,

1546 
dïth
);

1547  -
EFSCORRUPTED
;

1549 --
dïth
 >= 0) {

1550 
ix
 = 
∑th
[
dïth
].
p_idx
;

1551 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1552 
	`PXT4_ERROR_INODE
(
öode
,

1554 *
logiˇl
);

1555  -
EFSCORRUPTED
;

1558 
found_exã¡
;

1561 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1562 
	`PXT4_ERROR_INODE
(
öode
,

1564 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1565  -
EFSCORRUPTED
;

1568 i‡(
ex
 !
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

1570 
ex
++;

1571 
found_exã¡
;

1575 --
dïth
 >= 0) {

1576 
ix
 = 
∑th
[
dïth
].
p_idx
;

1577 i‡(
ix
 !
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1578 
gŸ_ödex
;

1584 
gŸ_ödex
:

1588 
ix
++;

1589 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1590 ++
dïth
 < 
∑th
->
p_dïth
) {

1592 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
,

1593 
∑th
->
p_dïth
 - 
dïth
, 0);

1594 i‡(
	`IS_ERR
(
bh
))

1595  
	`PTR_ERR
(
bh
);

1596 
eh
 = 
	`ext_block_hdr
(
bh
);

1597 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1598 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1599 
	`put_bh
(
bh
);

1602 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
, 
∑th
->
p_dïth
 - 
dïth
, 0);

1603 i‡(
	`IS_ERR
(
bh
))

1604  
	`PTR_ERR
(
bh
);

1605 
eh
 = 
	`ext_block_hdr
(
bh
);

1606 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1607 
found_exã¡
:

1608 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

1609 *
phys
 = 
	`pxt4_ext_pblock
(
ex
);

1610 *
ªt_ex
 = 
ex
;

1611 i‡(
bh
)

1612 
	`put_bh
(
bh
);

1614 
	}
}

1623 
pxt4_lblk_t


1624 
	$pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
)

1626 
dïth
;

1628 
	`BUG_ON
(
∑th
 =
NULL
);

1629 
dïth
 = 
∑th
->
p_dïth
;

1631 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1632  
EXT_MAX_BLOCKS
;

1634 
dïth
 >= 0) {

1635 i‡(
dïth
 =
∑th
->
p_dïth
) {

1637 i‡(
∑th
[
dïth
].
p_ext
 &&

1638 
∑th
[
dïth
].
p_ext
 !=

1639 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

1640  
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
[1].
ì_block
);

1643 i‡(
∑th
[
dïth
].
p_idx
 !=

1644 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1645  
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1647 
dïth
--;

1650  
EXT_MAX_BLOCKS
;

1651 
	}
}

1657 
pxt4_lblk_t
 
	$pxt4_ext_√xt_Àaf_block
(
pxt4_ext_∑th
 *
∑th
)

1659 
dïth
;

1661 
	`BUG_ON
(
∑th
 =
NULL
);

1662 
dïth
 = 
∑th
->
p_dïth
;

1665 i‡(
dïth
 == 0)

1666  
EXT_MAX_BLOCKS
;

1669 
dïth
--;

1671 
dïth
 >= 0) {

1672 i‡(
∑th
[
dïth
].
p_idx
 !=

1673 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1674  (
pxt4_lblk_t
)

1675 
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1676 
dïth
--;

1679  
EXT_MAX_BLOCKS
;

1680 
	}
}

1688 
	$pxt4_ext_c‹ª˘_ödexes
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1689 
pxt4_ext_∑th
 *
∑th
)

1691 
pxt4_exã¡_hódî
 *
eh
;

1692 
dïth
 = 
	`ext_dïth
(
öode
);

1693 
pxt4_exã¡
 *
ex
;

1694 
__À32
 
b‹dî
;

1695 
k
, 
îr
 = 0;

1697 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1698 
ex
 = 
∑th
[
dïth
].
p_ext
;

1700 i‡(
	`u∆ikñy
(
ex
 =
NULL
 || 
eh
 == NULL)) {

1701 
	`PXT4_ERROR_INODE
(
öode
,

1702 "ex %∞=NULL o∏eh %∞=NULL", 
ex
, 
eh
);

1703  -
EFSCORRUPTED
;

1706 i‡(
dïth
 == 0) {

1711 i‡(
ex
 !
	`EXT_FIRST_EXTENT
(
eh
)) {

1719 
k
 = 
dïth
 - 1;

1720 
b‹dî
 = 
∑th
[
dïth
].
p_ext
->
ì_block
;

1721 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1722 i‡(
îr
)

1723  
îr
;

1724 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1725 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1726 i‡(
îr
)

1727  
îr
;

1729 
k
--) {

1731 i‡(
∑th
[
k
+1].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[k+1].
p_hdr
))

1733 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1734 i‡(
îr
)

1736 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1737 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1738 i‡(
îr
)

1742  
îr
;

1743 
	}
}

1746 
	$pxt4_ˇn_exã¡s_be_mîged
(
öode
 *öode, 
pxt4_exã¡
 *
ex1
,

1747 
pxt4_exã¡
 *
ex2
)

1749 
ext1_ì_Àn
, 
pxt2_ì_Àn
;

1751 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
Ë!pxt4_ext_is_unwrôãn(
ex2
))

1754 
ext1_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

1755 
pxt2_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

1757 i‡(
	`À32_to_˝u
(
ex1
->
ì_block
Ë+ 
ext1_ì_Àn
 !=

1758 
	`À32_to_˝u
(
ex2
->
ì_block
))

1766 i‡(
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_INIT_MAX_LEN
)

1769 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
) &&

1770 
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

1772 #ifde‡
AGGRESSIVE_TEST


1773 i‡(
ext1_ì_Àn
 >= 4)

1777 i‡(
	`pxt4_ext_pblock
(
ex1
Ë+ 
ext1_ì_Àn
 =pxt4_ext_pblock(
ex2
))

1780 
	}
}

1789 
	$pxt4_ext_åy_to_mîge_right
(
öode
 *inode,

1790 
pxt4_ext_∑th
 *
∑th
,

1791 
pxt4_exã¡
 *
ex
)

1793 
pxt4_exã¡_hódî
 *
eh
;

1794 
dïth
, 
Àn
;

1795 
mîge_d⁄e
 = 0, 
unwrôãn
;

1797 
dïth
 = 
	`ext_dïth
(
öode
);

1798 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1799 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1801 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1802 i‡(!
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
,Éx + 1))

1805 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

1806 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

1807 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
 + 1));

1808 i‡(
unwrôãn
)

1809 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

1811 i‡(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1812 
Àn
 = (
	`EXT_LAST_EXTENT
(
eh
Ë- 
ex
 - 1)

1813 * (
pxt4_exã¡
);

1814 
	`memmove
(
ex
 + 1,Éx + 2, 
Àn
);

1816 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

1817 
mîge_d⁄e
 = 1;

1818 
	`WARN_ON
(
eh
->
eh_íåõs
 == 0);

1819 i‡(!
eh
->
eh_íåõs
)

1820 
	`PXT4_ERROR_INODE
(
öode
, "eh->eh_entries = 0!");

1823  
mîge_d⁄e
;

1824 
	}
}

1830 
	$pxt4_ext_åy_to_mîge_up
(
h™dÀ_t
 *
h™dÀ
,

1831 
öode
 *inode,

1832 
pxt4_ext_∑th
 *
∑th
)

1834 
size_t
 
s
;

1835 
max_roŸ
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 0);

1836 
pxt4_fsblk_t
 
blk
;

1838 i‡((
∑th
[0].
p_dïth
 != 1) ||

1839 (
	`À16_to_˝u
(
∑th
[0].
p_hdr
->
eh_íåõs
) != 1) ||

1840 (
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
Ë> 
max_roŸ
))

1848 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 2,

1849 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 1)))

1855 
blk
 = 
	`pxt4_idx_pblock
(
∑th
[0].
p_idx
);

1856 
s
 = 
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
) *

1857 (
pxt4_exã¡_idx
);

1858 
s
 +(
pxt4_exã¡_hódî
);

1860 
∑th
[1].
p_maxdïth
 =Öath[0].p_maxdepth;

1861 
	`mem˝y
(
∑th
[0].
p_hdr
,Ö©h[1].p_hdr, 
s
);

1862 
∑th
[0].
p_dïth
 = 0;

1863 
∑th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
’©h[0].
p_hdr
) +

1864 (
∑th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
’©h[1].
p_hdr
));

1865 
∑th
[0].
p_hdr
->
eh_max
 = 
	`˝u_to_À16
(
max_roŸ
);

1867 
	`bªl£
(
∑th
[1].
p_bh
);

1868 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
blk
, 1,

1869 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

1870 
	}
}

1876 
	$pxt4_ext_åy_to_mîge
(
h™dÀ_t
 *
h™dÀ
,

1877 
öode
 *inode,

1878 
pxt4_ext_∑th
 *
∑th
,

1879 
pxt4_exã¡
 *
ex
) {

1880 
pxt4_exã¡_hódî
 *
eh
;

1881 
dïth
;

1882 
mîge_d⁄e
 = 0;

1884 
dïth
 = 
	`ext_dïth
(
öode
);

1885 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1886 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1888 i‡(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1889 
mîge_d⁄e
 = 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
 - 1);

1891 i‡(!
mîge_d⁄e
)

1892 (Ë
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
);

1894 
	`pxt4_ext_åy_to_mîge_up
(
h™dÀ
, 
öode
, 
∑th
);

1895 
	}
}

1905 
	$pxt4_ext_check_ovîœp
(
pxt4_sb_öfo
 *
sbi
,

1906 
öode
 *inode,

1907 
pxt4_exã¡
 *
√wext
,

1908 
pxt4_ext_∑th
 *
∑th
)

1910 
pxt4_lblk_t
 
b1
, 
b2
;

1911 
dïth
, 
Àn1
;

1912 
ªt
 = 0;

1914 
b1
 = 
	`À32_to_˝u
(
√wext
->
ì_block
);

1915 
Àn1
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
);

1916 
dïth
 = 
	`ext_dïth
(
öode
);

1917 i‡(!
∑th
[
dïth
].
p_ext
)

1918 
out
;

1919 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
->
ì_block
));

1925 i‡(
b2
 < 
b1
) {

1926 
b2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

1927 i‡(
b2
 =
EXT_MAX_BLOCKS
)

1928 
out
;

1929 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, b2);

1933 i‡(
b1
 + 
Àn1
 < b1) {

1934 
Àn1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1935 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
Àn1
);

1936 
ªt
 = 1;

1940 i‡(
b1
 + 
Àn1
 > 
b2
) {

1941 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
b2
 - 
b1
);

1942 
ªt
 = 1;

1944 
out
:

1945  
ªt
;

1946 
	}
}

1954 
	$pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1955 
pxt4_ext_∑th
 **
µ©h
,

1956 
pxt4_exã¡
 *
√wext
, 
gb_Êags
)

1958 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1959 
pxt4_exã¡_hódî
 *
eh
;

1960 
pxt4_exã¡
 *
ex
, *
„x
;

1961 
pxt4_exã¡
 *
√¨ex
;

1962 
pxt4_ext_∑th
 *
≈©h
 = 
NULL
;

1963 
dïth
, 
Àn
, 
îr
;

1964 
pxt4_lblk_t
 
√xt
;

1965 
mb_Êags
 = 0, 
unwrôãn
;

1967 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1968 
mb_Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

1969 i‡(
	`u∆ikñy
(
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) == 0)) {

1970 
	`PXT4_ERROR_INODE
(
öode
, "pxt4_ext_get_actual_len(newext) == 0");

1971  -
EFSCORRUPTED
;

1973 
dïth
 = 
	`ext_dïth
(
öode
);

1974 
ex
 = 
∑th
[
dïth
].
p_ext
;

1975 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1976 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

1977 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

1978  -
EFSCORRUPTED
;

1982 i‡(
ex
 && !(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
)) {

1991 i‡(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1992 (
	`À32_to_˝u
(
ex
->
ì_block
) +

1993 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) <

1994 
	`À32_to_˝u
(
√wext
->
ì_block
))) {

1995 
ex
 += 1;

1996 
¥ïíd
;

1997 } i‡((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1998 (
	`À32_to_˝u
(
√wext
->
ì_block
) +

1999 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) <

2000 
	`À32_to_˝u
(
ex
->
ì_block
)))

2001 
ex
 -= 1;

2004 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
, 
√wext
)) {

2005 
	`ext_debug
("append [%d]%d blockÅo %u:[%d]%d"

2007 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2008 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2009 
	`À32_to_˝u
(
ex
->
ì_block
),

2010 
	`pxt4_ext_is_unwrôãn
(
ex
),

2011 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2012 
	`pxt4_ext_pblock
(
ex
));

2013 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2014 
∑th
 + 
dïth
);

2015 i‡(
îr
)

2016  
îr
;

2017 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2018 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2019 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2020 i‡(
unwrôãn
)

2021 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2022 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2023 
√¨ex
 = 
ex
;

2024 
mîge
;

2027 
¥ïíd
:

2029 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
√wext
, 
ex
)) {

2030 
	`ext_debug
("prepend %u[%d]%d blockÅo %u:[%d]%d"

2032 
	`À32_to_˝u
(
√wext
->
ì_block
),

2033 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2034 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2035 
	`À32_to_˝u
(
ex
->
ì_block
),

2036 
	`pxt4_ext_is_unwrôãn
(
ex
),

2037 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2038 
	`pxt4_ext_pblock
(
ex
));

2039 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2040 
∑th
 + 
dïth
);

2041 i‡(
îr
)

2042  
îr
;

2044 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2045 
ex
->
ì_block
 = 
√wext
->ee_block;

2046 
	`pxt4_ext_°‹e_pblock
(
ex
, 
	`pxt4_ext_pblock
(
√wext
));

2047 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2048 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2049 i‡(
unwrôãn
)

2050 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2051 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2052 
√¨ex
 = 
ex
;

2053 
mîge
;

2057 
dïth
 = 
	`ext_dïth
(
öode
);

2058 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2059 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
))

2060 
has_•a˚
;

2063 
„x
 = 
	`EXT_LAST_EXTENT
(
eh
);

2064 
√xt
 = 
EXT_MAX_BLOCKS
;

2065 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
Ë>Üe32_to_˝u(
„x
->ee_block))

2066 
√xt
 = 
	`pxt4_ext_√xt_Àaf_block
(
∑th
);

2067 i‡(
√xt
 !
EXT_MAX_BLOCKS
) {

2068 
	`ext_debug
("√xàÀa‡block - %u\n", 
√xt
);

2069 
	`BUG_ON
(
≈©h
 !
NULL
);

2070 
≈©h
 = 
	`pxt4_föd_exã¡
(
öode
, 
√xt
, 
NULL
, 0);

2071 i‡(
	`IS_ERR
(
≈©h
))

2072  
	`PTR_ERR
(
≈©h
);

2073 
	`BUG_ON
(
≈©h
->
p_dïth
 !
∑th
->p_depth);

2074 
eh
 = 
≈©h
[
dïth
].
p_hdr
;

2075 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
)) {

2076 
	`ext_debug
("nextÜeaf isn't full(%d)\n",

2077 
	`À16_to_˝u
(
eh
->
eh_íåõs
));

2078 
∑th
 = 
≈©h
;

2079 
has_•a˚
;

2081 
	`ext_debug
("nextÜeaf hasÇo free space(%d,%d)\n",

2082 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

2089 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

2090 
mb_Êags
 |
PXT4_MB_USE_RESERVED
;

2091 
îr
 = 
	`pxt4_ext_¸óã_√w_Àaf
(
h™dÀ
, 
öode
, 
mb_Êags
, 
gb_Êags
,

2092 
µ©h
, 
√wext
);

2093 i‡(
îr
)

2094 
˛ónup
;

2095 
dïth
 = 
	`ext_dïth
(
öode
);

2096 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2098 
has_•a˚
:

2099 
√¨ex
 = 
∑th
[
dïth
].
p_ext
;

2101 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2102 i‡(
îr
)

2103 
˛ónup
;

2105 i‡(!
√¨ex
) {

2107 
	`ext_debug
("firstÉxtent inÅheÜeaf: %u:%llu:[%d]%d\n",

2108 
	`À32_to_˝u
(
√wext
->
ì_block
),

2109 
	`pxt4_ext_pblock
(
√wext
),

2110 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2111 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2112 
√¨ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2114 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
)

2115 > 
	`À32_to_˝u
(
√¨ex
->
ì_block
)) {

2117 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2119 
	`À32_to_˝u
(
√wext
->
ì_block
),

2120 
	`pxt4_ext_pblock
(
√wext
),

2121 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2122 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2123 
√¨ex
);

2124 
√¨ex
++;

2127 
	`BUG_ON
(
√wext
->
ì_block
 =
√¨ex
->ee_block);

2128 
	`ext_debug
("insert %u:%llu:[%d]%dáfter: "

2130 
	`À32_to_˝u
(
√wext
->
ì_block
),

2131 
	`pxt4_ext_pblock
(
√wext
),

2132 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2133 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2134 
√¨ex
);

2136 
Àn
 = 
	`EXT_LAST_EXTENT
(
eh
Ë- 
√¨ex
 + 1;

2137 i‡(
Àn
 > 0) {

2138 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2140 
	`À32_to_˝u
(
√wext
->
ì_block
),

2141 
	`pxt4_ext_pblock
(
√wext
),

2142 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2143 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2144 
Àn
, 
√¨ex
,Çearex + 1);

2145 
	`memmove
(
√¨ex
 + 1,Çearex,

2146 
Àn
 * (
pxt4_exã¡
));

2150 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, 1);

2151 
∑th
[
dïth
].
p_ext
 = 
√¨ex
;

2152 
√¨ex
->
ì_block
 = 
√wext
->ee_block;

2153 
	`pxt4_ext_°‹e_pblock
(
√¨ex
, 
	`pxt4_ext_pblock
(
√wext
));

2154 
√¨ex
->
ì_Àn
 = 
√wext
->ee_len;

2156 
mîge
:

2158 i‡(!(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

2159 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
√¨ex
);

2163 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2164 i‡(
îr
)

2165 
˛ónup
;

2167 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

2169 
˛ónup
:

2170 
	`pxt4_ext_dr›_ªfs
(
≈©h
);

2171 
	`k‰ì
(
≈©h
);

2172  
îr
;

2173 
	}
}

2175 
	$pxt4_fûl_fõm≠_exã¡s
(
öode
 *inode,

2176 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2177 
fõm≠_exã¡_öfo
 *
fõöfo
)

2179 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2180 
pxt4_exã¡
 *
ex
;

2181 
exã¡_°©us
 
es
;

2182 
pxt4_lblk_t
 
√xt
, 
√xt_dñ
, 
°¨t
 = 0, 
íd
 = 0;

2183 
pxt4_lblk_t
 
œ°
 = 
block
 + 
num
;

2184 
exi°s
, 
dïth
 = 0, 
îr
 = 0;

2185 
Êags
 = 0;

2186 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2188 
block
 < 
œ°
 && block !
EXT_MAX_BLOCKS
) {

2189 
num
 = 
œ°
 - 
block
;

2191 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2193 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
block
, &path, 0);

2194 i‡(
	`IS_ERR
(
∑th
)) {

2195 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2196 
îr
 = 
	`PTR_ERR
(
∑th
);

2197 
∑th
 = 
NULL
;

2201 
dïth
 = 
	`ext_dïth
(
öode
);

2202 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2203 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2204 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2205 
îr
 = -
EFSCORRUPTED
;

2208 
ex
 = 
∑th
[
dïth
].
p_ext
;

2209 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2211 
Êags
 = 0;

2212 
exi°s
 = 0;

2213 i‡(!
ex
) {

2216 
°¨t
 = 
block
;

2217 
íd
 = 
block
 + 
num
;

2218 } i‡(
	`À32_to_˝u
(
ex
->
ì_block
Ë> 
block
) {

2220 
°¨t
 = 
block
;

2221 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2222 i‡(
block
 + 
num
 < 
íd
)

2223 
íd
 = 
block
 + 
num
;

2224 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2225 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2227 
°¨t
 = 
block
;

2228 
íd
 = 
block
 + 
num
;

2229 i‡(
íd
 >
√xt
)

2230 
íd
 = 
√xt
;

2231 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)) {

2236 
°¨t
 = 
block
;

2237 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
)

2238 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2239 i‡(
block
 + 
num
 < 
íd
)

2240 
íd
 = 
block
 + 
num
;

2241 
exi°s
 = 1;

2243 
	`BUG
();

2245 
	`BUG_ON
(
íd
 <
°¨t
);

2247 i‡(!
exi°s
) {

2248 
es
.
es_lblk
 = 
°¨t
;

2249 
es
.
es_Àn
 = 
íd
 - 
°¨t
;

2250 
es
.
es_pblk
 = 0;

2252 
es
.
es_lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2253 
es
.
es_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2254 
es
.
es_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2255 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2256 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2264 
√xt_dñ
 = 
	`pxt4_föd_dñayed_exã¡
(
öode
, &
es
);

2265 i‡(!
exi°s
 && 
√xt_dñ
) {

2266 
exi°s
 = 1;

2267 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2268 
FIEMAP_EXTENT_UNKNOWN
);

2270 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2272 i‡(
	`u∆ikñy
(
es
.
es_Àn
 == 0)) {

2273 
	`PXT4_ERROR_INODE
(
öode
, "es.es_len == 0");

2274 
îr
 = -
EFSCORRUPTED
;

2289 i‡(
√xt
 =
√xt_dñ
 &&Çexà=
EXT_MAX_BLOCKS
) {

2290 
Êags
 |
FIEMAP_EXTENT_LAST
;

2291 i‡(
	`u∆ikñy
(
√xt_dñ
 !
EXT_MAX_BLOCKS
 ||

2292 
√xt
 !
EXT_MAX_BLOCKS
)) {

2293 
	`PXT4_ERROR_INODE
(
öode
,

2296 
√xt
, 
√xt_dñ
);

2297 
îr
 = -
EFSCORRUPTED
;

2302 i‡(
exi°s
) {

2303 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2304 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2305 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2306 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2307 
Êags
);

2308 i‡(
îr
 < 0)

2310 i‡(
îr
 == 1) {

2311 
îr
 = 0;

2316 
block
 = 
es
.
es_lblk
 +És.
es_Àn
;

2319 
	`pxt4_ext_dr›_ªfs
(
∑th
);

2320 
	`k‰ì
(
∑th
);

2321  
îr
;

2322 
	}
}

2324 
	$pxt4_fûl_es_ˇche_öfo
(
öode
 *inode,

2325 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2326 
fõm≠_exã¡_öfo
 *
fõöfo
)

2328 
pxt4_lblk_t
 
√xt
, 
íd
 = 
block
 + 
num
 - 1;

2329 
exã¡_°©us
 
es
;

2330 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2331 
Êags
;

2332 
îr
;

2334 
block
 <
íd
) {

2335 
√xt
 = 0;

2336 
Êags
 = 0;

2337 i‡(!
	`pxt4_es_lookup_exã¡
(
öode
, 
block
, &
√xt
, &
es
))

2339 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

2340 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2341 i‡(
	`pxt4_es_is_dñayed
(&
es
))

2342 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2343 
FIEMAP_EXTENT_UNKNOWN
);

2344 i‡(
	`pxt4_es_is_hﬁe
(&
es
))

2345 
Êags
 |
PXT4_FIEMAP_EXTENT_HOLE
;

2346 i‡(
√xt
 == 0)

2347 
Êags
 |
FIEMAP_EXTENT_LAST
;

2348 i‡(
Êags
 & (
FIEMAP_EXTENT_DELALLOC
|

2349 
PXT4_FIEMAP_EXTENT_HOLE
))

2350 
es
.
es_pblk
 = 0;

2352 
es
.
es_pblk
 = 
	`pxt4_es_pblock
(&es);

2353 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2354 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2355 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2356 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2357 
Êags
);

2358 i‡(
√xt
 == 0)

2360 
block
 = 
√xt
;

2361 i‡(
îr
 < 0)

2362  
îr
;

2363 i‡(
îr
 == 1)

2367 
	}
}

2383 
pxt4_lblk_t
 
	$pxt4_ext_dëîmöe_hﬁe
(
öode
 *inode,

2384 
pxt4_ext_∑th
 *
∑th
,

2385 
pxt4_lblk_t
 *
lblk
)

2387 
dïth
 = 
	`ext_dïth
(
öode
);

2388 
pxt4_exã¡
 *
ex
;

2389 
pxt4_lblk_t
 
Àn
;

2391 
ex
 = 
∑th
[
dïth
].
p_ext
;

2392 i‡(
ex
 =
NULL
) {

2394 *
lblk
 = 0;

2395 
Àn
 = 
EXT_MAX_BLOCKS
;

2396 } i‡(*
lblk
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

2397 
Àn
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë- *
lblk
;

2398 } i‡(*
lblk
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2399 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2400 
pxt4_lblk_t
 
√xt
;

2402 *
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
	`pxt4_ext_gë_a˘uÆ_Àn
(ex);

2403 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2404 
	`BUG_ON
(
√xt
 =*
lblk
);

2405 
Àn
 = 
√xt
 - *
lblk
;

2407 
	`BUG
();

2409  
Àn
;

2410 
	}
}

2418 
	$pxt4_ext_put_g≠_ö_ˇche
(
öode
 *öode, 
pxt4_lblk_t
 
hﬁe_°¨t
,

2419 
pxt4_lblk_t
 
hﬁe_Àn
)

2421 
exã¡_°©us
 
es
;

2423 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
hﬁe_°¨t
,

2424 
hﬁe_°¨t
 + 
hﬁe_Àn
 - 1, &
es
);

2425 i‡(
es
.
es_Àn
) {

2427 i‡(
es
.
es_lblk
 <
hﬁe_°¨t
)

2429 
hﬁe_Àn
 = 
	`mö
(
es
.
es_lblk
 - 
hﬁe_°¨t
, hole_len);

2431 
	`ext_debug
(" -> %u:%u\n", 
hﬁe_°¨t
, 
hﬁe_Àn
);

2432 
	`pxt4_es_ö£π_exã¡
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
, ~0,

2433 
EXTENT_STATUS_HOLE
);

2434 
	}
}

2440 
	$pxt4_ext_rm_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2441 
pxt4_ext_∑th
 *
∑th
, 
dïth
)

2443 
îr
;

2444 
pxt4_fsblk_t
 
Àaf
;

2447 
dïth
--;

2448 
∑th
 =Ö©h + 
dïth
;

2449 
Àaf
 = 
	`pxt4_idx_pblock
(
∑th
->
p_idx
);

2450 i‡(
	`u∆ikñy
(
∑th
->
p_hdr
->
eh_íåõs
 == 0)) {

2451 
	`PXT4_ERROR_INODE
(
öode
, "path->p_hdr->eh_entries == 0");

2452  -
EFSCORRUPTED
;

2454 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2455 i‡(
îr
)

2456  
îr
;

2458 i‡(
∑th
->
p_idx
 !
	`EXT_LAST_INDEX
’©h->
p_hdr
)) {

2459 
Àn
 = 
	`EXT_LAST_INDEX
(
∑th
->
p_hdr
Ë-Ö©h->
p_idx
;

2460 
Àn
 *(
pxt4_exã¡_idx
);

2461 
	`memmove
(
∑th
->
p_idx
,Ö©h->p_idx + 1, 
Àn
);

2464 
	`À16_add_˝u
(&
∑th
->
p_hdr
->
eh_íåõs
, -1);

2465 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2466 i‡(
îr
)

2467  
îr
;

2468 
	`ext_debug
("ödex i†em±y,Ñemovêô, fªêblock %Œu\n", 
Àaf
);

2469 
	`åa˚_pxt4_ext_rm_idx
(
öode
, 
Àaf
);

2471 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
Àaf
, 1,

2472 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

2474 --
dïth
 >= 0) {

2475 i‡(
∑th
->
p_idx
 !
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2477 
∑th
--;

2478 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2479 i‡(
îr
)

2481 
∑th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2482 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2483 i‡(
îr
)

2486  
îr
;

2487 
	}
}

2496 
	$pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *öode, 
ƒblocks
,

2497 
pxt4_ext_∑th
 *
∑th
)

2499 i‡(
∑th
) {

2500 
dïth
 = 
	`ext_dïth
(
öode
);

2501 
ªt
 = 0;

2504 i‡(
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
)

2505 < 
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

2516 
ªt
 = 2 + 
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

2517  
ªt
;

2521  
	`pxt4_chunk_å™s_blocks
(
öode
, 
ƒblocks
);

2522 
	}
}

2533 
	$pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
)

2535 
ödex
;

2536 
dïth
;

2539 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2542 
dïth
 = 
	`ext_dïth
(
öode
);

2544 i‡(
exã¡s
 <= 1)

2545 
ödex
 = 
dïth
 * 2;

2547 
ödex
 = 
dïth
 * 3;

2549  
ödex
;

2550 
	}
}

2552 
ölöe
 
	$gë_deÁu…_‰ì_blocks_Êags
(
öode
 *inode)

2554 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

2555 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

2556  
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
;

2557 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2558  
PXT4_FREE_BLOCKS_FORGET
;

2560 
	}
}

2577 
	$pxt4_ªª£rve_˛u°î
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

2579 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2580 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2582 
	`dquŸ_ª˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

2584 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2585 
ei
->
i_ª£rved_d©a_blocks
++;

2586 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 1);

2587 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2589 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 1);

2590 
	`pxt4_ªmove_≥ndög
(
öode
, 
lblk
);

2591 
	}
}

2593 
	$pxt4_ªmove_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2594 
pxt4_exã¡
 *
ex
,

2595 
∑πül_˛u°î
 *
∑πül
,

2596 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
to
)

2598 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2600 
pxt4_fsblk_t
 
œ°_pblk
, 
pblk
;

2601 
pxt4_lblk_t
 
num
;

2602 
Êags
;

2605 i‡(
‰om
 < 
	`À32_to_˝u
(
ex
->
ì_block
) ||

2606 
to
 !
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1) {

2607 
	`pxt4_îr‹
(
sbi
->
s_sb
,

2609 
‰om
, 
to
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

2613 #ifde‡
EXTENTS_STATS


2614 
	`•ö_lock
(&
sbi
->
s_ext_°©s_lock
);

2615 
sbi
->
s_ext_blocks
 +
ì_Àn
;

2616 
sbi
->
s_ext_exã¡s
++;

2617 i‡(
ì_Àn
 < 
sbi
->
s_ext_mö
)

2618 
sbi
->
s_ext_mö
 = 
ì_Àn
;

2619 i‡(
ì_Àn
 > 
sbi
->
s_ext_max
)

2620 
sbi
->
s_ext_max
 = 
ì_Àn
;

2621 i‡(
	`ext_dïth
(
öode
Ë> 
sbi
->
s_dïth_max
)

2622 
sbi
->
s_dïth_max
 = 
	`ext_dïth
(
öode
);

2623 
	`•ö_u∆ock
(&
sbi
->
s_ext_°©s_lock
);

2626 
	`åa˚_pxt4_ªmove_blocks
(
öode
, 
ex
, 
‰om
, 
to
, 
∑πül
);

2632 
œ°_pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

2634 i‡(
∑πül
->
°©e
 !
öôül
 &&

2635 
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
œ°_pblk
)) {

2636 i‡(
∑πül
->
°©e
 =
to‰ì
) {

2637 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2638 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2639 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2640 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2641 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2642 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2643 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2644 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2646 
∑πül
->
°©e
 = 
öôül
;

2649 
num
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 
‰om
;

2650 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 
num
;

2658 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2661 i‡((
	`PXT4_LBLK_COFF
(
sbi
, 
to
Ë!sbi->
s_˛u°î_øtio
 - 1) &&

2662 (
	`PXT4_LBLK_CMASK
(
sbi
, 
to
Ë>
‰om
) &&

2663 (
∑πül
->
°©e
 !
no‰ì
)) {

2664 i‡(
	`pxt4_is_≥ndög
(
öode
, 
to
))

2665 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2666 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2667 
	`PXT4_PBLK_CMASK
(
sbi
, 
œ°_pblk
),

2668 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2669 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2670 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
to
);

2671 
∑πül
->
°©e
 = 
öôül
;

2672 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2675 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2683 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2684 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
pblk
, 
num
, 
Êags
);

2687 i‡(
∑πül
->
°©e
 !
öôül
 &&Ö¨tül->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
))

2688 
∑πül
->
°©e
 = 
öôül
;

2700 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
‰om
Ë&& 
num
 =
ì_Àn
) {

2701 i‡(
∑πül
->
°©e
 =
öôül
) {

2702 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2703 
∑πül
->
lblk
 = 
‰om
;

2704 
∑πül
->
°©e
 = 
to‰ì
;

2707 
∑πül
->
°©e
 = 
öôül
;

2711 
	}
}

2729 
	$pxt4_ext_rm_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2730 
pxt4_ext_∑th
 *
∑th
,

2731 
∑πül_˛u°î
 *
∑πül
,

2732 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

2734 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2735 
îr
 = 0, 
c‹ª˘_ödex
 = 0;

2736 
dïth
 = 
	`ext_dïth
(
öode
), 
¸edôs
, 
ªvoke_¸edôs
;

2737 
pxt4_exã¡_hódî
 *
eh
;

2738 
pxt4_lblk_t
 
a
, 
b
;

2739 
num
;

2740 
pxt4_lblk_t
 
ex_ì_block
;

2741 
ex_ì_Àn
;

2742 
unwrôãn
 = 0;

2743 
pxt4_exã¡
 *
ex
;

2744 
pxt4_fsblk_t
 
pblk
;

2747 
	`ext_debug
("åunˇã sö˚ %u i¿Àa‡tÿ%u\n", 
°¨t
, 
íd
);

2748 i‡(!
∑th
[
dïth
].
p_hdr
)

2749 
∑th
[
dïth
].
p_hdr
 = 
	`ext_block_hdr
’©h[dïth].
p_bh
);

2750 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2751 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2752 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2753  -
EFSCORRUPTED
;

2756 
ex
 = 
∑th
[
dïth
].
p_ext
;

2757 i‡(!
ex
)

2758 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2760 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2761 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2763 
	`åa˚_pxt4_ext_rm_Àaf
(
öode
, 
°¨t
, 
ex
, 
∑πül
);

2765 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
) &&

2766 
ex_ì_block
 + 
ex_ì_Àn
 > 
°¨t
) {

2768 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2769 
unwrôãn
 = 1;

2771 
unwrôãn
 = 0;

2773 
	`ext_debug
("ªmovêexà%u:[%d]%d\n", 
ex_ì_block
,

2774 
unwrôãn
, 
ex_ì_Àn
);

2775 
∑th
[
dïth
].
p_ext
 = 
ex
;

2777 
a
 = 
ex_ì_block
 > 
°¨t
 ?Éx_ee_block : start;

2778 
b
 = 
ex_ì_block
+
ex_ì_Àn
 - 1 < 
íd
 ?

2779 
ex_ì_block
+
ex_ì_Àn
 - 1 : 
íd
;

2781 
	`ext_debug
(" b‹dî %u:%u\n", 
a
, 
b
);

2784 i‡(
íd
 < 
ex_ì_block
) {

2792 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2793 
pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2794 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2795 
∑πül
->
°©e
 = 
no‰ì
;

2797 
ex
--;

2798 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2799 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2801 } i‡(
b
 !
ex_ì_block
 + 
ex_ì_Àn
 - 1) {

2802 
	`PXT4_ERROR_INODE
(
öode
,

2805 
°¨t
, 
íd
, 
ex_ì_block
,

2806 
ex_ì_block
 + 
ex_ì_Àn
 - 1);

2807 
îr
 = -
EFSCORRUPTED
;

2808 
out
;

2809 } i‡(
a
 !
ex_ì_block
) {

2811 
num
 = 
a
 - 
ex_ì_block
;

2814 
num
 = 0;

2822 
¸edôs
 = 7 + 2*(
ex_ì_Àn
/
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
));

2823 i‡(
ex
 =
	`EXT_FIRST_EXTENT
(
eh
)) {

2824 
c‹ª˘_ödex
 = 1;

2825 
¸edôs
 +(
	`ext_dïth
(
öode
)) + 1;

2827 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

2833 
ªvoke_¸edôs
 =

2834 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
,

2835 
	`ext_dïth
(
öode
)) +

2836 
	`pxt4_‰ì_d©a_ªvoke_¸edôs
(
öode
, 
b
 - 
a
 + 1);

2838 
îr
 = 
	`pxt4_d©a£m_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
¸edôs
,

2839 
¸edôs
, 
ªvoke_¸edôs
);

2840 i‡(
îr
) {

2841 i‡(
îr
 > 0)

2842 
îr
 = -
EAGAIN
;

2843 
out
;

2846 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2847 i‡(
îr
)

2848 
out
;

2850 
îr
 = 
	`pxt4_ªmove_blocks
(
h™dÀ
, 
öode
, 
ex
, 
∑πül
, 
a
, 
b
);

2851 i‡(
îr
)

2852 
out
;

2854 i‡(
num
 == 0)

2856 
	`pxt4_ext_°‹e_pblock
(
ex
, 0);

2858 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
num
);

2863 i‡(
unwrôãn
 && 
num
)

2864 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2869 i‡(
num
 == 0) {

2870 i‡(
íd
 !
EXT_MAX_BLOCKS
 - 1) {

2876 
	`memmove
(
ex
,Éx+1, (
	`EXT_LAST_EXTENT
(
eh
) -Éx) *

2877 (
pxt4_exã¡
));

2880 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2881 (
pxt4_exã¡
));

2883 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

2886 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2887 i‡(
îr
)

2888 
out
;

2890 
	`ext_debug
("√wÉxã¡: %u:%u:%Œu\n", 
ex_ì_block
, 
num
,

2891 
	`pxt4_ext_pblock
(
ex
));

2892 
ex
--;

2893 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2894 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2897 i‡(
c‹ª˘_ödex
 && 
eh
->
eh_íåõs
)

2898 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2907 i‡(
∑πül
->
°©e
 =
to‰ì
 && 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
)) {

2908 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ex_ì_Àn
 - 1;

2909 i‡(
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
)) {

2910 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2912 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2913 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2914 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2915 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2916 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2917 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2918 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2920 
∑πül
->
°©e
 = 
öôül
;

2925 i‡(
îr
 =0 && 
eh
->
eh_íåõs
 =0 && 
∑th
[
dïth
].
p_bh
 !
NULL
)

2926 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
dïth
);

2928 
out
:

2929  
îr
;

2930 
	}
}

2937 
	$pxt4_ext_m‹e_to_rm
(
pxt4_ext_∑th
 *
∑th
)

2939 
	`BUG_ON
(
∑th
->
p_idx
 =
NULL
);

2941 i‡(
∑th
->
p_idx
 < 
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2948 i‡(
	`À16_to_˝u
(
∑th
->
p_hdr
->
eh_íåõs
Ë=∑th->
p_block
)

2951 
	}
}

2953 
	$pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2954 
pxt4_lblk_t
 
íd
)

2956 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2957 
dïth
 = 
	`ext_dïth
(
öode
);

2958 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2959 
∑πül_˛u°î
 
∑πül
;

2960 
h™dÀ_t
 *
h™dÀ
;

2961 
i
 = 0, 
îr
 = 0;

2963 
∑πül
.
p˛u
 = 0;

2964 
∑πül
.
lblk
 = 0;

2965 
∑πül
.
°©e
 = 
öôül
;

2967 
	`ext_debug
("åunˇã sö˚ %uÅÿ%u\n", 
°¨t
, 
íd
);

2970 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ªvoke
(
öode
, 
PXT4_HT_TRUNCATE
,

2971 
dïth
 + 1,

2972 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 
dïth
));

2973 i‡(
	`IS_ERR
(
h™dÀ
))

2974  
	`PTR_ERR
(
h™dÀ
);

2976 
agaö
:

2977 
	`åa˚_pxt4_ext_ªmove_•a˚
(
öode
, 
°¨t
, 
íd
, 
dïth
);

2986 i‡(
íd
 < 
EXT_MAX_BLOCKS
 - 1) {

2987 
pxt4_exã¡
 *
ex
;

2988 
pxt4_lblk_t
 
ì_block
, 
ex_íd
, 
lblk
;

2989 
pxt4_fsblk_t
 
pblk
;

2992 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
íd
, 
NULL
, 
PXT4_EX_NOCACHE
);

2993 i‡(
	`IS_ERR
(
∑th
)) {

2994 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2995  
	`PTR_ERR
(
∑th
);

2997 
dïth
 = 
	`ext_dïth
(
öode
);

2999 
ex
 = 
∑th
[
dïth
].
p_ext
;

3000 i‡(!
ex
) {

3001 i‡(
dïth
) {

3002 
	`PXT4_ERROR_INODE
(
öode
,

3004 
dïth
);

3005 
îr
 = -
EFSCORRUPTED
;

3007 
out
;

3010 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3011 
ex_íd
 = 
ì_block
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) - 1;

3019 i‡(
íd
 >
ì_block
 &&Énd < 
ex_íd
) {

3026 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

3027 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
íd
 - 
ì_block
 + 2;

3028 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3029 
∑πül
.
°©e
 = 
no‰ì
;

3038 
îr
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

3039 
íd
 + 1, 1);

3040 i‡(
îr
 < 0)

3041 
out
;

3043 } i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
íd
 >
ex_íd
 &&

3044 
∑πül
.
°©e
 =
öôül
) {

3055 
lblk
 = 
ex_íd
 + 1;

3056 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
lblk
, &
pblk
,

3057 &
ex
);

3058 i‡(
îr
)

3059 
out
;

3060 i‡(
pblk
) {

3061 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

3062 
∑πül
.
°©e
 = 
no‰ì
;

3070 
dïth
 = 
	`ext_dïth
(
öode
);

3071 i‡(
∑th
) {

3072 
k
 = 
i
 = 
dïth
;

3073 --
k
 > 0)

3074 
∑th
[
k
].
p_block
 =

3075 
	`À16_to_˝u
(
∑th
[
k
].
p_hdr
->
eh_íåõs
)+1;

3077 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

3078 
GFP_NOFS
);

3079 i‡(
∑th
 =
NULL
) {

3080 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3081  -
ENOMEM
;

3083 
∑th
[0].
p_maxdïth
 =Ö©h[0].
p_dïth
 = 
dïth
;

3084 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

3085 
i
 = 0;

3087 i‡(
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0)) {

3088 
îr
 = -
EFSCORRUPTED
;

3089 
out
;

3092 
îr
 = 0;

3094 
i
 >0 && 
îr
 == 0) {

3095 i‡(
i
 =
dïth
) {

3097 
îr
 = 
	`pxt4_ext_rm_Àaf
(
h™dÀ
, 
öode
, 
∑th
,

3098 &
∑πül
, 
°¨t
, 
íd
);

3100 
	`bªl£
(
∑th
[
i
].
p_bh
);

3101 
∑th
[
i
].
p_bh
 = 
NULL
;

3102 
i
--;

3107 i‡(!
∑th
[
i
].
p_hdr
) {

3108 
	`ext_debug
("initialize header\n");

3109 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
’©h[i].
p_bh
);

3112 i‡(!
∑th
[
i
].
p_idx
) {

3114 
∑th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
);

3115 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
)+1;

3116 
	`ext_debug
("init indexÖtr: hdr 0x%p,Çum %d\n",

3117 
∑th
[
i
].
p_hdr
,

3118 
	`À16_to_˝u
(
∑th
[
i
].
p_hdr
->
eh_íåõs
));

3121 
∑th
[
i
].
p_idx
--;

3124 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3125 
i
, 
	`EXT_FIRST_INDEX
(
∑th
[i].
p_hdr
),

3126 
∑th
[
i
].
p_idx
);

3127 i‡(
	`pxt4_ext_m‹e_to_rm
(
∑th
 + 
i
)) {

3128 
buf„r_hód
 *
bh
;

3130 
	`ext_debug
("moveÅoÜevel %d (block %llu)\n",

3131 
i
 + 1, 
	`pxt4_idx_pblock
(
∑th
[i].
p_idx
));

3132 
	`mem£t
(
∑th
 + 
i
 + 1, 0, (*path));

3133 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

3134 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
), 
dïth
 - i - 1,

3135 
PXT4_EX_NOCACHE
);

3136 i‡(
	`IS_ERR
(
bh
)) {

3138 
îr
 = 
	`PTR_ERR
(
bh
);

3143 
	`c⁄d_ªsched
();

3144 i‡(
	`WARN_ON
(
i
 + 1 > 
dïth
)) {

3145 
îr
 = -
EFSCORRUPTED
;

3148 
∑th
[
i
 + 1].
p_bh
 = 
bh
;

3152 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
);

3153 
i
++;

3156 i‡(
∑th
[
i
].
p_hdr
->
eh_íåõs
 == 0 && i > 0) {

3160 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
i
);

3163 
	`bªl£
(
∑th
[
i
].
p_bh
);

3164 
∑th
[
i
].
p_bh
 = 
NULL
;

3165 
i
--;

3166 
	`ext_debug
("ªtu∫ÅÿÀvñ %d\n", 
i
);

3170 
	`åa˚_pxt4_ext_ªmove_•a˚_d⁄e
(
öode
, 
°¨t
, 
íd
, 
dïth
, &
∑πül
,

3171 
∑th
->
p_hdr
->
eh_íåõs
);

3177 i‡(
∑πül
.
°©e
 =
to‰ì
 && 
îr
 == 0) {

3178 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

3180 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
.
lblk
))

3181 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3182 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

3183 
	`PXT4_C2B
(
sbi
, 
∑πül
.
p˛u
),

3184 
sbi
->
s_˛u°î_øtio
, 
Êags
);

3185 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3186 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
.
lblk
);

3187 
∑πül
.
°©e
 = 
öôül
;

3191 i‡(
∑th
->
p_hdr
->
eh_íåõs
 == 0) {

3196 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

3197 i‡(
îr
 == 0) {

3198 
	`ext_öode_hdr
(
öode
)->
eh_dïth
 = 0;

3199 
	`ext_öode_hdr
(
öode
)->
eh_max
 =

3200 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

3201 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

3204 
out
:

3205 
	`pxt4_ext_dr›_ªfs
(
∑th
);

3206 
	`k‰ì
(
∑th
);

3207 
∑th
 = 
NULL
;

3208 i‡(
îr
 =-
EAGAIN
)

3209 
agaö
;

3210 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3212  
îr
;

3213 
	}
}

3218 
	$pxt4_ext_öô
(
su≥r_block
 *
sb
)

3224 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

3225 #i‡
	`deföed
(
AGGRESSIVE_TEST
Ë|| deföed(
CHECK_BINSEARCH
Ë|| deföed(
EXTENTS_STATS
)

3226 
	`¥ötk
(
KERN_INFO
 "PXT4-fs: fileÉxtentsÉnabled"

3227 #ifde‡
AGGRESSIVE_TEST


3230 #ifde‡
CHECK_BINSEARCH


3233 #ifde‡
EXTENTS_STATS


3238 #ifde‡
EXTENTS_STATS


3239 
	`•ö_lock_öô
(&
	`PXT4_SB
(
sb
)->
s_ext_°©s_lock
);

3240 
	`PXT4_SB
(
sb
)->
s_ext_mö
 = 1 << 30;

3241 
	`PXT4_SB
(
sb
)->
s_ext_max
 = 0;

3244 
	}
}

3249 
	$pxt4_ext_ªÀa£
(
su≥r_block
 *
sb
)

3251 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3254 #ifde‡
EXTENTS_STATS


3255 i‡(
	`PXT4_SB
(
sb
)->
s_ext_blocks
 && PXT4_SB(sb)->
s_ext_exã¡s
) {

3256 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3257 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %lu blocks in %luÉxtents (%luáve)\n",

3258 
sbi
->
s_ext_blocks
, sbi->
s_ext_exã¡s
,

3259 
sbi
->
s_ext_blocks
 / sbi->
s_ext_exã¡s
);

3260 
	`¥ötk
(
KERN_ERR
 "PXT4-fs:Éxtents: %lu min, %lu max, max depth %lu\n",

3261 
sbi
->
s_ext_mö
, sbi->
s_ext_max
, sbi->
s_dïth_max
);

3264 
	}
}

3266 
	$pxt4_zîoout_es
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3268 
pxt4_lblk_t
 
ì_block
;

3269 
pxt4_fsblk_t
 
ì_pblock
;

3270 
ì_Àn
;

3272 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3273 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3274 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3276 i‡(
ì_Àn
 == 0)

3279  
	`pxt4_es_ö£π_exã¡
(
öode
, 
ì_block
, 
ì_Àn
, 
ì_pblock
,

3280 
EXTENT_STATUS_WRITTEN
);

3281 
	}
}

3284 
	$pxt4_ext_zîoout
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3286 
pxt4_fsblk_t
 
ì_pblock
;

3287 
ì_Àn
;

3289 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3290 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3291  
	`pxt4_issue_zîoout
(
öode
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_pblock
,

3292 
ì_Àn
);

3293 
	}
}

3316 
	$pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

3317 
öode
 *inode,

3318 
pxt4_ext_∑th
 **
µ©h
,

3319 
pxt4_lblk_t
 
•lô
,

3320 
•lô_Êag
,

3321 
Êags
)

3323 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3324 
pxt4_fsblk_t
 
√wblock
;

3325 
pxt4_lblk_t
 
ì_block
;

3326 
pxt4_exã¡
 *
ex
, 
√wex
, 
‹ig_ex
, 
zîo_ex
;

3327 
pxt4_exã¡
 *
ex2
 = 
NULL
;

3328 
ì_Àn
, 
dïth
;

3329 
îr
 = 0;

3331 
	`BUG_ON
((
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
)) ==

3332 (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
));

3334 
	`ext_debug
("pxt4_split_extents_at: inode %lu,Üogical"

3335 "block %Œu\n", 
öode
->
i_öo
, ()
•lô
);

3337 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3339 
dïth
 = 
	`ext_dïth
(
öode
);

3340 
ex
 = 
∑th
[
dïth
].
p_ext
;

3341 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3342 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3343 
√wblock
 = 
•lô
 - 
ì_block
 + 
	`pxt4_ext_pblock
(
ex
);

3345 
	`BUG_ON
(
•lô
 < 
ì_block
 || s∂ô >”e_block + 
ì_Àn
));

3346 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
) &&

3347 
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3348 
PXT4_EXT_MARK_UNWRIT1
 |

3349 
PXT4_EXT_MARK_UNWRIT2
));

3351 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3352 i‡(
îr
)

3353 
out
;

3355 i‡(
•lô
 =
ì_block
) {

3361 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3362 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3364 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3366 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

3367 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3369 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3370 
out
;

3374 
	`mem˝y
(&
‹ig_ex
, 
ex
, (orig_ex));

3375 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
•lô
 - 
ì_block
);

3376 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT1
)

3377 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3383 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3384 i‡(
îr
)

3385 
fix_exã¡_Àn
;

3387 
ex2
 = &
√wex
;

3388 
ex2
->
ì_block
 = 
	`˝u_to_À32
(
•lô
);

3389 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- (
•lô
 - 
ì_block
));

3390 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
√wblock
);

3391 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3392 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

3394 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
√wex
, 
Êags
);

3395 i‡(
îr
 =-
ENOSPC
 && (
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)) {

3396 i‡(
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
|
PXT4_EXT_DATA_VALID2
)) {

3397 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID1
) {

3398 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex2
);

3399 
zîo_ex
.
ì_block
 = 
ex2
->ee_block;

3400 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3401 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
));

3402 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3403 
	`pxt4_ext_pblock
(
ex2
));

3405 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex
);

3406 
zîo_ex
.
ì_block
 = 
ex
->ee_block;

3407 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3408 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
));

3409 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3410 
	`pxt4_ext_pblock
(
ex
));

3413 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
‹ig_ex
);

3414 
zîo_ex
.
ì_block
 = 
‹ig_ex
.ee_block;

3415 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3416 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
‹ig_ex
));

3417 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3418 
	`pxt4_ext_pblock
(&
‹ig_ex
));

3421 i‡(
îr
)

3422 
fix_exã¡_Àn
;

3424 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(ee_len);

3425 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3426 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3427 i‡(
îr
)

3428 
fix_exã¡_Àn
;

3431 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex
);

3433 
out
;

3434 } i‡(
îr
)

3435 
fix_exã¡_Àn
;

3437 
out
:

3438 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3439  
îr
;

3441 
fix_exã¡_Àn
:

3442 
ex
->
ì_Àn
 = 
‹ig_ex
.ee_len;

3443 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3444  
îr
;

3445 
	}
}

3458 
	$pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

3459 
öode
 *inode,

3460 
pxt4_ext_∑th
 **
µ©h
,

3461 
pxt4_m≠_blocks
 *
m≠
,

3462 
•lô_Êag
,

3463 
Êags
)

3465 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3466 
pxt4_lblk_t
 
ì_block
;

3467 
pxt4_exã¡
 *
ex
;

3468 
ì_Àn
, 
dïth
;

3469 
îr
 = 0;

3470 
unwrôãn
;

3471 
•lô_Êag1
, 
Êags1
;

3472 
Æloˇãd
 = 
m≠
->
m_Àn
;

3474 
dïth
 = 
	`ext_dïth
(
öode
);

3475 
ex
 = 
∑th
[
dïth
].
p_ext
;

3476 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3477 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3478 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3480 i‡(
m≠
->
m_lblk
 + m≠->
m_Àn
 < 
ì_block
 + 
ì_Àn
) {

3481 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_MAY_ZEROOUT
;

3482 
Êags1
 = 
Êags
 | 
PXT4_GET_BLOCKS_PRE_IO
;

3483 i‡(
unwrôãn
)

3484 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
 |

3485 
PXT4_EXT_MARK_UNWRIT2
;

3486 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
)

3487 
•lô_Êag1
 |
PXT4_EXT_DATA_VALID1
;

3488 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3489 
m≠
->
m_lblk
 + m≠->
m_Àn
, 
•lô_Êag1
, 
Êags1
);

3490 i‡(
îr
)

3491 
out
;

3493 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3499 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3500 i‡(
	`IS_ERR
(
∑th
))

3501  
	`PTR_ERR
(
∑th
);

3502 
dïth
 = 
	`ext_dïth
(
öode
);

3503 
ex
 = 
∑th
[
dïth
].
p_ext
;

3504 i‡(!
ex
) {

3505 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3506 (Ë
m≠
->
m_lblk
);

3507  -
EFSCORRUPTED
;

3509 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3510 
•lô_Êag1
 = 0;

3512 i‡(
m≠
->
m_lblk
 >
ì_block
) {

3513 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
;

3514 i‡(
unwrôãn
) {

3515 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
;

3516 
•lô_Êag1
 |
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3517 
PXT4_EXT_MARK_UNWRIT2
);

3519 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3520 
m≠
->
m_lblk
, 
•lô_Êag1
, 
Êags
);

3521 i‡(
îr
)

3522 
out
;

3525 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3526 
out
:

3527  
îr
 ?Éº : 
Æloˇãd
;

3528 
	}
}

3550 
	$pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ_t
 *
h™dÀ
,

3551 
öode
 *inode,

3552 
pxt4_m≠_blocks
 *
m≠
,

3553 
pxt4_ext_∑th
 **
µ©h
,

3554 
Êags
)

3556 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3557 
pxt4_sb_öfo
 *
sbi
;

3558 
pxt4_exã¡_hódî
 *
eh
;

3559 
pxt4_m≠_blocks
 
•lô_m≠
;

3560 
pxt4_exã¡
 
zîo_ex1
, 
zîo_ex2
;

3561 
pxt4_exã¡
 *
ex
, *
abut_ex
;

3562 
pxt4_lblk_t
 
ì_block
, 
eof_block
;

3563 
ì_Àn
, 
dïth
, 
m≠_Àn
 = 
m≠
->
m_Àn
;

3564 
Æloˇãd
 = 0, 
max_zîoout
 = 0;

3565 
îr
 = 0;

3566 
•lô_Êag
 = 
PXT4_EXT_DATA_VALID2
;

3568 
	`ext_debug
("pxt4_ext_convert_to_initialized: inode %lu,Üogical"

3569 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3570 ()
m≠
->
m_lblk
, 
m≠_Àn
);

3572 
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3573 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3574 
öode
->
i_sb
->
s_blocksize_bôs
;

3575 i‡(
eof_block
 < 
m≠
->
m_lblk
 + 
m≠_Àn
)

3576 
eof_block
 = 
m≠
->
m_lblk
 + 
m≠_Àn
;

3578 
dïth
 = 
	`ext_dïth
(
öode
);

3579 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3580 
ex
 = 
∑th
[
dïth
].
p_ext
;

3581 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3582 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3583 
zîo_ex1
.
ì_Àn
 = 0;

3584 
zîo_ex2
.
ì_Àn
 = 0;

3586 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_íãr
(
öode
, 
m≠
, 
ex
);

3589 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
));

3590 
	`BUG_ON
(!
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
));

3607 i‡((
m≠
->
m_lblk
 =
ì_block
) &&

3609 (
m≠_Àn
 < 
ì_Àn
) &&

3610 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3611 
pxt4_lblk_t
 
¥ev_lblk
;

3612 
pxt4_fsblk_t
 
¥ev_pblk
, 
ì_pblk
;

3613 
¥ev_Àn
;

3615 
abut_ex
 = 
ex
 - 1;

3616 
¥ev_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3617 
¥ev_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3618 
¥ev_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3619 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3630 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3631 ((
¥ev_lblk
 + 
¥ev_Àn
Ë=
ì_block
) &&

3632 ((
¥ev_pblk
 + 
¥ev_Àn
Ë=
ì_pblk
) &&

3633 (
¥ev_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3634 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3635 i‡(
îr
)

3636 
out
;

3638 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3639 
m≠
, 
ex
, 
abut_ex
);

3642 
ex
->
ì_block
 = 
	`˝u_to_À32
”e_block + 
m≠_Àn
);

3643 
	`pxt4_ext_°‹e_pblock
(
ex
, 
ì_pblk
 + 
m≠_Àn
);

3644 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3645 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3648 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
¥ev_Àn
 + 
m≠_Àn
);

3651 
Æloˇãd
 = 
m≠_Àn
;

3653 } i‡(((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=(
ì_block
 + 
ì_Àn
)) &&

3654 (
m≠_Àn
 < 
ì_Àn
) &&

3655 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3657 
pxt4_lblk_t
 
√xt_lblk
;

3658 
pxt4_fsblk_t
 
√xt_pblk
, 
ì_pblk
;

3659 
√xt_Àn
;

3661 
abut_ex
 = 
ex
 + 1;

3662 
√xt_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3663 
√xt_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3664 
√xt_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3665 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3676 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3677 ((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=
√xt_lblk
) &&

3678 ((
ì_pblk
 + 
ì_Àn
Ë=
√xt_pblk
) &&

3679 (
√xt_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3680 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3681 i‡(
îr
)

3682 
out
;

3684 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3685 
m≠
, 
ex
, 
abut_ex
);

3688 
abut_ex
->
ì_block
 = 
	`˝u_to_À32
(
√xt_lblk
 - 
m≠_Àn
);

3689 
	`pxt4_ext_°‹e_pblock
(
abut_ex
, 
√xt_pblk
 - 
m≠_Àn
);

3690 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3691 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3694 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
√xt_Àn
 + 
m≠_Àn
);

3697 
Æloˇãd
 = 
m≠_Àn
;

3700 i‡(
Æloˇãd
) {

3702 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3705 
∑th
[
dïth
].
p_ext
 = 
abut_ex
;

3706 
out
;

3708 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3710 
	`WARN_ON
(
m≠
->
m_lblk
 < 
ì_block
);

3715 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ? 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3717 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)

3718 
max_zîoout
 = 
sbi
->
s_exã¡_max_zîoout_kb
 >>

3719 (
öode
->
i_sb
->
s_blocksize_bôs
 - 10);

3721 i‡(
	`IS_ENCRYPTED
(
öode
))

3722 
max_zîoout
 = 0;

3735 
•lô_m≠
.
m_lblk
 = 
m≠
->m_lblk;

3736 
•lô_m≠
.
m_Àn
 = 
m≠
->m_len;

3738 i‡(
max_zîoout
 && (
Æloˇãd
 > 
•lô_m≠
.
m_Àn
)) {

3739 i‡(
Æloˇãd
 <
max_zîoout
) {

3741 
zîo_ex1
.
ì_block
 =

3742 
	`˝u_to_À32
(
•lô_m≠
.
m_lblk
 +

3743 
•lô_m≠
.
m_Àn
);

3744 
zîo_ex1
.
ì_Àn
 =

3745 
	`˝u_to_À16
(
Æloˇãd
 - 
•lô_m≠
.
m_Àn
);

3746 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex1
,

3747 
	`pxt4_ext_pblock
(
ex
Ë+ 
•lô_m≠
.
m_lblk
 +

3748 
•lô_m≠
.
m_Àn
 - 
ì_block
);

3749 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex1
);

3750 i‡(
îr
)

3751 
out
;

3752 
•lô_m≠
.
m_Àn
 = 
Æloˇãd
;

3754 i‡(
•lô_m≠
.
m_lblk
 - 
ì_block
 + s∂ô_m≠.
m_Àn
 <

3755 
max_zîoout
) {

3757 i‡(
•lô_m≠
.
m_lblk
 !
ì_block
) {

3758 
zîo_ex2
.
ì_block
 = 
ex
->ee_block;

3759 
zîo_ex2
.
ì_Àn
 = 
	`˝u_to_À16
(
•lô_m≠
.
m_lblk
 -

3760 
ì_block
);

3761 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex2
,

3762 
	`pxt4_ext_pblock
(
ex
));

3763 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex2
);

3764 i‡(
îr
)

3765 
out
;

3768 
•lô_m≠
.
m_Àn
 +•lô_m≠.
m_lblk
 - 
ì_block
;

3769 
•lô_m≠
.
m_lblk
 = 
ì_block
;

3770 
Æloˇãd
 = 
m≠
->
m_Àn
;

3774 
îr
 = 
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
•lô_m≠
, 
•lô_Êag
,

3775 
Êags
);

3776 i‡(
îr
 > 0)

3777 
îr
 = 0;

3778 
out
:

3780 i‡(!
îr
) {

3781 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex1
);

3782 i‡(!
îr
)

3783 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex2
);

3785  
îr
 ?Éº : 
Æloˇãd
;

3786 
	}
}

3812 
	$pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ_t
 *
h™dÀ
,

3813 
öode
 *inode,

3814 
pxt4_m≠_blocks
 *
m≠
,

3815 
pxt4_ext_∑th
 **
µ©h
,

3816 
Êags
)

3818 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3819 
pxt4_lblk_t
 
eof_block
;

3820 
pxt4_lblk_t
 
ì_block
;

3821 
pxt4_exã¡
 *
ex
;

3822 
ì_Àn
;

3823 
•lô_Êag
 = 0, 
dïth
;

3825 
	`ext_debug
("%s: inode %lu,Üogical block %llu, max_blocks %u\n",

3826 
__func__
, 
öode
->
i_öo
,

3827 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3829 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3830 
öode
->
i_sb
->
s_blocksize_bôs
;

3831 i‡(
eof_block
 < 
m≠
->
m_lblk
 + m≠->
m_Àn
)

3832 
eof_block
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
;

3837 
dïth
 = 
	`ext_dïth
(
öode
);

3838 
ex
 = 
∑th
[
dïth
].
p_ext
;

3839 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3840 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3843 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3844 
•lô_Êag
 |
PXT4_EXT_DATA_VALID1
;

3846 } i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

3847 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ?

3848 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3849 
•lô_Êag
 |(
PXT4_EXT_MARK_UNWRIT2
 | 
PXT4_EXT_DATA_VALID2
);

3851 
Êags
 |
PXT4_GET_BLOCKS_PRE_IO
;

3852  
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, 
m≠
, 
•lô_Êag
, 
Êags
);

3853 
	}
}

3855 
	$pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ_t
 *
h™dÀ
,

3856 
öode
 *inode,

3857 
pxt4_m≠_blocks
 *
m≠
,

3858 
pxt4_ext_∑th
 **
µ©h
)

3860 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3861 
pxt4_exã¡
 *
ex
;

3862 
pxt4_lblk_t
 
ì_block
;

3863 
ì_Àn
;

3864 
dïth
;

3865 
îr
 = 0;

3867 
dïth
 = 
	`ext_dïth
(
öode
);

3868 
ex
 = 
∑th
[
dïth
].
p_ext
;

3869 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3870 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3872 
	`ext_debug
("pxt4_convert_unwritten_extents_endio: inode %lu,Üogical"

3873 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3874 ()
ì_block
, 
ì_Àn
);

3882 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3883 #ifde‡
CONFIG_PXT4_DEBUG


3884 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Inode (%ld) finished:ÉxtentÜogical block %llu,"

3886 
öode
->
i_öo
, ()
ì_block
, 
ì_Àn
,

3887 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3889 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3890 
PXT4_GET_BLOCKS_CONVERT
);

3891 i‡(
îr
 < 0)

3892  
îr
;

3893 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3894 i‡(
	`IS_ERR
(
∑th
))

3895  
	`PTR_ERR
(
∑th
);

3896 
dïth
 = 
	`ext_dïth
(
öode
);

3897 
ex
 = 
∑th
[
dïth
].
p_ext
;

3900 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3901 i‡(
îr
)

3902 
out
;

3904 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3909 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3912 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3913 
out
:

3914 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3915  
îr
;

3916 
	}
}

3921 
	$check_eofblocks_Ê
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3922 
pxt4_lblk_t
 
lblk
,

3923 
pxt4_ext_∑th
 *
∑th
,

3924 
Àn
)

3926 
i
, 
dïth
;

3927 
pxt4_exã¡_hódî
 *
eh
;

3928 
pxt4_exã¡
 *
œ°_ex
;

3930 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
))

3933 
dïth
 = 
	`ext_dïth
(
öode
);

3934 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3941 i‡(
	`u∆ikñy
(!
eh
->
eh_íåõs
))

3942 
out
;

3943 
œ°_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3953 i‡(
lblk
 + 
Àn
 < 
	`À32_to_˝u
(
œ°_ex
->
ì_block
) +

3954 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_ex
))

3963 
i
 = 
dïth
-1; i >= 0; i--)

3964 i‡(
∑th
[
i
].
p_idx
 !
	`EXT_LAST_INDEX
’©h[i].
p_hdr
))

3966 
out
:

3967 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

3968  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3969 
	}
}

3972 
	$c⁄vît_öôülized_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3973 
pxt4_m≠_blocks
 *
m≠
,

3974 
pxt4_ext_∑th
 **
µ©h
,

3975 
Æloˇãd
)

3977 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3978 
pxt4_exã¡
 *
ex
;

3979 
pxt4_lblk_t
 
ì_block
;

3980 
ì_Àn
;

3981 
dïth
;

3982 
îr
 = 0;

3988 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

3989 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3991 
dïth
 = 
	`ext_dïth
(
öode
);

3992 
ex
 = 
∑th
[
dïth
].
p_ext
;

3993 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3994 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3996 
	`ext_debug
("%s: inode %lu,Üogical"

3997 "block %Œu, max_block†%u\n", 
__func__
, 
öode
->
i_öo
,

3998 ()
ì_block
, 
ì_Àn
);

4000 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

4001 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4002 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

4003 i‡(
îr
 < 0)

4004  
îr
;

4005 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

4006 i‡(
	`IS_ERR
(
∑th
))

4007  
	`PTR_ERR
(
∑th
);

4008 
dïth
 = 
	`ext_dïth
(
öode
);

4009 
ex
 = 
∑th
[
dïth
].
p_ext
;

4010 i‡(!
ex
) {

4011 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

4012 (Ë
m≠
->
m_lblk
);

4013  -
EFSCORRUPTED
;

4017 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

4018 i‡(
îr
)

4019  
îr
;

4021 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

4026 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

4029 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

4030 i‡(
îr
)

4031  
îr
;

4032 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4034 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4035 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
, m≠->
m_Àn
);

4036 i‡(
îr
)

4037  
îr
;

4038 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4039 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4040 
Æloˇãd
 = 
m≠
->
m_Àn
;

4041 
m≠
->
m_Àn
 = 
Æloˇãd
;

4042  
Æloˇãd
;

4043 
	}
}

4046 
	$pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4047 
pxt4_m≠_blocks
 *
m≠
,

4048 
pxt4_ext_∑th
 **
µ©h
, 
Êags
,

4049 
Æloˇãd
, 
pxt4_fsblk_t
 
√wblock
)

4051 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

4052 
ªt
 = 0;

4053 
îr
 = 0;

4055 
	`ext_debug
("pxt4_ext_handle_unwritten_extents: inode %lu,Üogical "

4057 
öode
->
i_öo
, ()
m≠
->
m_lblk
, m≠->
m_Àn
,

4058 
Êags
, 
Æloˇãd
);

4059 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4065 
Êags
 |
PXT4_GET_BLOCKS_METADATA_NOFAIL
;

4067 
	`åa˚_pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
öode
, 
m≠
, 
Êags
,

4068 
Æloˇãd
, 
√wblock
);

4071 i‡(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) {

4072 
ªt
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4073 
Êags
 | 
PXT4_GET_BLOCKS_CONVERT
);

4074 i‡(
ªt
 <= 0)

4075 
out
;

4076 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4077 
out
;

4080 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

4081 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) {

4082 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4083 
Æloˇãd
 = 
m≠
->
m_Àn
;

4084 
îr
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
, 
√wblock
,

4085 
Æloˇãd
);

4086 i‡(
îr
 < 0)

4087 
out2
;

4089 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ
, 
öode
, 
m≠
,

4090 
µ©h
);

4091 i‡(
ªt
 >= 0) {

4092 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4093 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4094 
∑th
, 
m≠
->
m_Àn
);

4096 
îr
 = 
ªt
;

4097 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4098 
m≠
->
m_pblk
 = 
√wblock
;

4099 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4100 
Æloˇãd
 = 
m≠
->
m_Àn
;

4101 
m≠
->
m_Àn
 = 
Æloˇãd
;

4102 
out2
;

4109 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) {

4110 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4111 
m≠_out
;

4115 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4123 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4124 
out1
;

4128 
ªt
 = 
	`pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
, 
Êags
);

4129 i‡(
ªt
 >= 0)

4130 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4131 
out
:

4132 i‡(
ªt
 <= 0) {

4133 
îr
 = 
ªt
;

4134 
out2
;

4136 
Æloˇãd
 = 
ªt
;

4137 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4138 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4139 
Æloˇãd
 = 
m≠
->
m_Àn
;

4140 
m≠
->
m_Àn
 = 
Æloˇãd
;

4142 
m≠_out
:

4143 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4144 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4145 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
,

4146 
m≠
->
m_Àn
);

4147 i‡(
îr
 < 0)

4148 
out2
;

4150 
out1
:

4151 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4152 
Æloˇãd
 = 
m≠
->
m_Àn
;

4153 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4154 
m≠
->
m_pblk
 = 
√wblock
;

4155 
m≠
->
m_Àn
 = 
Æloˇãd
;

4156 
out2
:

4157  
îr
 ?Éº : 
Æloˇãd
;

4158 
	}
}

4201 
	$gë_im∂õd_˛u°î_Æloc
(
su≥r_block
 *
sb
,

4202 
pxt4_m≠_blocks
 *
m≠
,

4203 
pxt4_exã¡
 *
ex
,

4204 
pxt4_ext_∑th
 *
∑th
)

4206 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4207 
pxt4_lblk_t
 
c_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4208 
pxt4_lblk_t
 
ex_˛u°î_°¨t
, 
ex_˛u°î_íd
;

4209 
pxt4_lblk_t
 
º_˛u°î_°¨t
;

4210 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4211 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4212 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4215 
ex_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
);

4216 
ex_˛u°î_íd
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
 + 
ì_Àn
 - 1);

4219 
º_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
m≠
->
m_lblk
);

4221 i‡((
º_˛u°î_°¨t
 =
ex_˛u°î_íd
) ||

4222 (
º_˛u°î_°¨t
 =
ex_˛u°î_°¨t
)) {

4223 i‡(
º_˛u°î_°¨t
 =
ex_˛u°î_íd
)

4224 
ì_°¨t
 +
ì_Àn
 - 1;

4225 
m≠
->
m_pblk
 = 
	`PXT4_PBLK_CMASK
(
sbi
, 
ì_°¨t
Ë+ 
c_off£t
;

4226 
m≠
->
m_Àn
 = 
	`mö
(map->m_len,

4227 (Ë
sbi
->
s_˛u°î_øtio
 - 
c_off£t
);

4237 i‡(
m≠
->
m_lblk
 < 
ì_block
)

4238 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
ì_block
 - m≠->
m_lblk
);

4249 i‡(
m≠
->
m_lblk
 > 
ì_block
) {

4250 
pxt4_lblk_t
 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

4251 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
√xt
 - m≠->
m_lblk
);

4254 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 1);

4258 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 0);

4260 
	}
}

4281 
	$pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4282 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

4284 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

4285 
pxt4_exã¡
 
√wex
, *
ex
, *
ex2
;

4286 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4287 
pxt4_fsblk_t
 
√wblock
 = 0;

4288 
‰ì_⁄_îr
 = 0, 
îr
 = 0, 
dïth
, 
ªt
;

4289 
Æloˇãd
 = 0, 
off£t
 = 0;

4290 
Æloˇãd_˛u°îs
 = 0;

4291 
pxt4_Æloˇti⁄_ªque°
 
¨
;

4292 
pxt4_lblk_t
 
˛u°î_off£t
;

4293 
boﬁ
 
m≠_‰om_˛u°î
 = 
Ál£
;

4295 
	`ext_debug
("blocks %u/%uÑequested for inode %lu\n",

4296 
m≠
->
m_lblk
, m≠->
m_Àn
, 
öode
->
i_öo
);

4297 
	`åa˚_pxt4_ext_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

4300 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, 0);

4301 i‡(
	`IS_ERR
(
∑th
)) {

4302 
îr
 = 
	`PTR_ERR
(
∑th
);

4303 
∑th
 = 
NULL
;

4304 
out2
;

4307 
dïth
 = 
	`ext_dïth
(
öode
);

4314 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

4315 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtentáddress "

4317 (Ë
m≠
->
m_lblk
, 
dïth
,

4318 
∑th
[
dïth
].
p_block
);

4319 
îr
 = -
EFSCORRUPTED
;

4320 
out2
;

4323 
ex
 = 
∑th
[
dïth
].
p_ext
;

4324 i‡(
ex
) {

4325 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4326 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4327 
ì_Àn
;

4334 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4336 
	`åa˚_pxt4_ext_show_exã¡
(
öode
, 
ì_block
, 
ì_°¨t
, 
ì_Àn
);

4339 i‡(
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
)) {

4340 
√wblock
 = 
m≠
->
m_lblk
 - 
ì_block
 + 
ì_°¨t
;

4342 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

4343 
	`ext_debug
("%u fô i¡ÿ%u:%d -> %Œu\n", 
m≠
->
m_lblk
,

4344 
ì_block
, 
ì_Àn
, 
√wblock
);

4350 i‡((!
	`pxt4_ext_is_unwrôãn
(
ex
)) &&

4351 (
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4352 
Æloˇãd
 = 
	`c⁄vît_öôülized_exã¡
(

4353 
h™dÀ
, 
öode
, 
m≠
, &
∑th
,

4354 
Æloˇãd
);

4355 
out2
;

4356 } i‡(!
	`pxt4_ext_is_unwrôãn
(
ex
))

4357 
out
;

4359 
ªt
 = 
	`pxt4_ext_h™dÀ_unwrôãn_exã¡s
(

4360 
h™dÀ
, 
öode
, 
m≠
, &
∑th
, 
Êags
,

4361 
Æloˇãd
, 
√wblock
);

4362 i‡(
ªt
 < 0)

4363 
îr
 = 
ªt
;

4365 
Æloˇãd
 = 
ªt
;

4366 
out2
;

4374 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4375 
pxt4_lblk_t
 
hﬁe_°¨t
, 
hﬁe_Àn
;

4377 
hﬁe_°¨t
 = 
m≠
->
m_lblk
;

4378 
hﬁe_Àn
 = 
	`pxt4_ext_dëîmöe_hﬁe
(
öode
, 
∑th
, &
hﬁe_°¨t
);

4383 
	`pxt4_ext_put_g≠_ö_ˇche
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
);

4386 i‡(
hﬁe_°¨t
 !
m≠
->
m_lblk
)

4387 
hﬁe_Àn
 -
m≠
->
m_lblk
 - 
hﬁe_°¨t
;

4388 
m≠
->
m_pblk
 = 0;

4389 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
hﬁe_Àn
);

4391 
out2
;

4397 
√wex
.
ì_block
 = 
	`˝u_to_À32
(
m≠
->
m_lblk
);

4398 
˛u°î_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4404 i‡(
˛u°î_off£t
 && 
ex
 &&

4405 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex
, 
∑th
)) {

4406 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4407 
√wblock
 = 
m≠
->
m_pblk
;

4408 
m≠_‰om_˛u°î
 = 
åue
;

4409 
gŸ_Æloˇãd_blocks
;

4413 
¨
.
Œe·
 = 
m≠
->
m_lblk
;

4414 
îr
 = 
	`pxt4_ext_£¨ch_À·
(
öode
, 
∑th
, &
¨
.
Œe·
, &¨.
∂e·
);

4415 i‡(
îr
)

4416 
out2
;

4417 
¨
.
Ãight
 = 
m≠
->
m_lblk
;

4418 
ex2
 = 
NULL
;

4419 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
¨
.
Ãight
, &¨.
¥ight
, &
ex2
);

4420 i‡(
îr
)

4421 
out2
;

4425 i‡((
sbi
->
s_˛u°î_øtio
 > 1Ë&& 
ex2
 &&

4426 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex2
, 
∑th
)) {

4427 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4428 
√wblock
 = 
m≠
->
m_pblk
;

4429 
m≠_‰om_˛u°î
 = 
åue
;

4430 
gŸ_Æloˇãd_blocks
;

4439 i‡(
m≠
->
m_Àn
 > 
EXT_INIT_MAX_LEN
 &&

4440 !(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4441 
m≠
->
m_Àn
 = 
EXT_INIT_MAX_LEN
;

4442 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4443 (
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4444 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
;

4447 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
m≠
->
m_Àn
);

4448 
îr
 = 
	`pxt4_ext_check_ovîœp
(
sbi
, 
öode
, &
√wex
, 
∑th
);

4449 i‡(
îr
)

4450 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4452 
Æloˇãd
 = 
m≠
->
m_Àn
;

4455 
¨
.
öode
 = inode;

4456 
¨
.
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
m≠
->
m_lblk
);

4457 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

4466 
off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4467 
¨
.
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
off£t
+
Æloˇãd
);

4468 
¨
.
gﬂl
 -
off£t
;

4469 
¨
.
logiˇl
 -
off£t
;

4470 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4471 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

4474 
¨
.
Êags
 = 0;

4475 i‡(
Êags
 & 
PXT4_GET_BLOCKS_NO_NORMALIZE
)

4476 
¨
.
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4477 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4478 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

4479 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

4480 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

4481 
√wblock
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, &
îr
);

4482 i‡(!
√wblock
)

4483 
out2
;

4484 
	`ext_debug
("allocateÇew block: goal %llu, found %llu/%u\n",

4485 
¨
.
gﬂl
, 
√wblock
, 
Æloˇãd
);

4486 
‰ì_⁄_îr
 = 1;

4487 
Æloˇãd_˛u°îs
 = 
¨
.
Àn
;

4488 
¨
.
Àn
 = 
	`PXT4_C2B
(
sbi
,ár.ÀnË- 
off£t
;

4489 i‡(
¨
.
Àn
 > 
Æloˇãd
)

4490 
¨
.
Àn
 = 
Æloˇãd
;

4492 
gŸ_Æloˇãd_blocks
:

4494 
	`pxt4_ext_°‹e_pblock
(&
√wex
, 
√wblock
 + 
off£t
);

4495 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
¨
.
Àn
);

4497 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
){

4498 
	`pxt4_ext_m¨k_unwrôãn
(&
√wex
);

4499 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4502 
îr
 = 0;

4503 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4504 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4505 
∑th
, 
¨
.
Àn
);

4506 i‡(!
îr
)

4507 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
,

4508 &
√wex
, 
Êags
);

4510 i‡(
îr
 && 
‰ì_⁄_îr
) {

4511 
fb_Êags
 = 
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4512 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4516 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4517 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
√wblock
,

4518 
	`PXT4_C2B
(
sbi
, 
Æloˇãd_˛u°îs
), 
fb_Êags
);

4519 
out2
;

4523 
√wblock
 = 
	`pxt4_ext_pblock
(&
√wex
);

4524 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4525 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4526 
Æloˇãd
 = 
m≠
->
m_Àn
;

4527 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4535 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
Ë&& !
m≠_‰om_˛u°î
) {

4536 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4541 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
Æloˇãd_˛u°îs
,

4544 
pxt4_lblk_t
 
lblk
, 
Àn
;

4545 
n
;

4558 
lblk
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
m≠
->
m_lblk
);

4559 
Àn
 = 
Æloˇãd_˛u°îs
 << 
sbi
->
s_˛u°î_bôs
;

4560 
n
 = 
	`pxt4_es_dñayed_˛u
(
öode
, 
lblk
, 
Àn
);

4561 i‡(
n
 > 0)

4562 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, (Ë
n
, 0);

4570 i‡((
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4571 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4573 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 0);

4574 
out
:

4575 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4576 
Æloˇãd
 = 
m≠
->
m_Àn
;

4577 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4578 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4579 
m≠
->
m_pblk
 = 
√wblock
;

4580 
m≠
->
m_Àn
 = 
Æloˇãd
;

4581 
out2
:

4582 
	`pxt4_ext_dr›_ªfs
(
∑th
);

4583 
	`k‰ì
(
∑th
);

4585 
	`åa˚_pxt4_ext_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
,

4586 
îr
 ?Éº : 
Æloˇãd
);

4587  
îr
 ?Éº : 
Æloˇãd
;

4588 
	}
}

4590 
	$pxt4_ext_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

4592 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4593 
pxt4_lblk_t
 
œ°_block
;

4594 
îr
 = 0;

4603 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

4604 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4605 i‡(
îr
)

4606  
îr
;

4608 
œ°_block
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4609 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4610 
ªåy
:

4611 
îr
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
,

4612 
EXT_MAX_BLOCKS
 - 
œ°_block
);

4613 i‡(
îr
 =-
ENOMEM
) {

4614 
	`c⁄d_ªsched
();

4615 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

4616 
ªåy
;

4618 i‡(
îr
)

4619  
îr
;

4620  
	`pxt4_ext_ªmove_•a˚
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 - 1);

4621 
	}
}

4623 
	$pxt4_Æloc_fûe_blocks
(
fûe
 *fûe, 
pxt4_lblk_t
 
off£t
,

4624 
pxt4_lblk_t
 
Àn
, 
loff_t
 
√w_size
,

4625 
Êags
)

4627 
öode
 *öodê
	`fûe_öode
(
fûe
);

4628 
h™dÀ_t
 *
h™dÀ
;

4629 
ªt
 = 0;

4630 
ªt2
 = 0;

4631 
ªåõs
 = 0;

4632 
dïth
 = 0;

4633 
pxt4_m≠_blocks
 
m≠
;

4634 
¸edôs
;

4635 
loff_t
 
ïos
;

4637 
	`BUG_ON
(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
));

4638 
m≠
.
m_lblk
 = 
off£t
;

4639 
m≠
.
m_Àn
 = 
Àn
;

4645 i‡(
Àn
 <
EXT_UNWRITTEN_MAX_LEN
)

4646 
Êags
 |
PXT4_GET_BLOCKS_NO_NORMALIZE
;

4651 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4652 
dïth
 = 
	`ext_dïth
(
öode
);

4654 
ªåy
:

4655 
ªt
 >0 && 
Àn
) {

4659 i‡(
dïth
 !
	`ext_dïth
(
öode
)) {

4660 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4661 
dïth
 = 
	`ext_dïth
(
öode
);

4664 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4665 
¸edôs
);

4666 i‡(
	`IS_ERR
(
h™dÀ
)) {

4667 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4670 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
Êags
);

4671 i‡(
ªt
 <= 0) {

4672 
	`pxt4_debug
("inode #%lu: block %u:Üen %u: "

4674 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4675 
m≠
.
m_Àn
, 
ªt
);

4676 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4677 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4680 
m≠
.
m_lblk
 +
ªt
;

4681 
m≠
.
m_Àn
 = 
Àn
 =Üí - 
ªt
;

4682 
ïos
 = (
loff_t
)
m≠
.
m_lblk
 << 
öode
->
i_blkbôs
;

4683 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

4684 i‡(
√w_size
) {

4685 i‡(
ïos
 > 
√w_size
)

4686 
ïos
 = 
√w_size
;

4687 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
ïos
) & 0x1)

4688 
öode
->
i_mtime
 = inode->
i_˘ime
;

4690 i‡(
ïos
 > 
öode
->
i_size
)

4691 
	`pxt4_£t_öode_Êag
(
öode
,

4692 
PXT4_INODE_EOFBLOCKS
);

4694 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4695 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4696 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4697 i‡(
ªt2
)

4700 i‡(
ªt
 =-
ENOSPC
 &&

4701 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
)) {

4702 
ªt
 = 0;

4703 
ªåy
;

4706  
ªt
 > 0 ? 
ªt2
 :Ñet;

4707 
	}
}

4709 
	$pxt4_zîo_ønge
(
fûe
 *fûe, 
loff_t
 
off£t
,

4710 
loff_t
 
Àn
, 
mode
)

4712 
öode
 *öodê
	`fûe_öode
(
fûe
);

4713 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

4714 
max_blocks
;

4715 
loff_t
 
√w_size
 = 0;

4716 
ªt
 = 0;

4717 
Êags
;

4718 
¸edôs
;

4719 
∑πül_begö
, 
∑πül_íd
;

4720 
loff_t
 
°¨t
, 
íd
;

4721 
pxt4_lblk_t
 
lblk
;

4722 
blkbôs
 = 
öode
->
i_blkbôs
;

4724 
	`åa˚_pxt4_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

4726 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4727  -
EINVAL
;

4730 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4731 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

4732 i‡(
ªt
)

4733  
ªt
;

4742 
°¨t
 = 
	`round_up
(
off£t
, 1 << 
blkbôs
);

4743 
íd
 = 
	`round_down
((
off£t
 + 
Àn
), 1 << 
blkbôs
);

4745 i‡(
°¨t
 < 
off£t
 || 
íd
 > off£à+ 
Àn
)

4746  -
EINVAL
;

4747 
∑πül_begö
 = 
off£t
 & ((1 << 
blkbôs
) - 1);

4748 
∑πül_íd
 = (
off£t
 + 
Àn
Ë& ((1 << 
blkbôs
) - 1);

4750 
lblk
 = 
°¨t
 >> 
blkbôs
;

4751 
max_blocks
 = (
íd
 >> 
blkbôs
);

4752 i‡(
max_blocks
 < 
lblk
)

4753 
max_blocks
 = 0;

4755 
max_blocks
 -
lblk
;

4757 
	`öode_lock
(
öode
);

4762 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4763 
ªt
 = -
EOPNOTSUPP
;

4764 
out_muãx
;

4767 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4768 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4769 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4770 
√w_size
 = 
off£t
 + 
Àn
;

4771 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4772 i‡(
ªt
)

4773 
out_muãx
;

4776 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4777 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4778 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4781 
	`öode_dio_waô
(
öode
);

4784 i‡(
∑πül_begö
 || 
∑πül_íd
) {

4785 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
,

4786 
	`round_down
(
off£t
, 1 << 
blkbôs
) >> blkbits,

4787 (
	`round_up
((
off£t
 + 
Àn
), 1 << 
blkbôs
) -

4788 
	`round_down
(
off£t
, 1 << 
blkbôs
)) >> blkbits,

4789 
√w_size
, 
Êags
);

4790 i‡(
ªt
)

4791 
out_muãx
;

4796 i‡(
max_blocks
 > 0) {

4797 
Êags
 |(
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4798 
PXT4_EX_NOCACHE
);

4804 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4806 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4807 i‡(
ªt
) {

4808 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4809 
out_muãx
;

4812 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àn
);

4813 i‡(
ªt
) {

4814 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4815 
out_muãx
;

4818 
	`åunˇã_∑geˇche_ønge
(
öode
, 
°¨t
, 
íd
 - 1);

4819 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4821 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
,

4822 
Êags
);

4823 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4824 i‡(
ªt
)

4825 
out_muãx
;

4827 i‡(!
∑πül_begö
 && !
∑πül_íd
)

4828 
out_muãx
;

4834 
¸edôs
 = (2 * 
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 2)) + 1;

4835 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4836 
¸edôs
 += 2;

4837 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

4838 i‡(
	`IS_ERR
(
h™dÀ
)) {

4839 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4840 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

4841 
out_muãx
;

4844 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4845 i‡(
√w_size
) {

4846 
	`pxt4_upd©e_öode_size
(
öode
, 
√w_size
);

4852 i‡((
off£t
 + 
Àn
Ë> 
	`i_size_ªad
(
öode
))

4853 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4855 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4858 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
, 
Àn
);

4859 i‡(
ªt
 >= 0)

4860 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4862 i‡(
fûe
->
f_Êags
 & 
O_SYNC
)

4863 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4865 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4866 
out_muãx
:

4867 
	`öode_u∆ock
(
öode
);

4868  
ªt
;

4869 
	}
}

4878 
	$pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,Üoff_à
Àn
)

4880 
öode
 *öodê
	`fûe_öode
(
fûe
);

4881 
loff_t
 
√w_size
 = 0;

4882 
max_blocks
;

4883 
ªt
 = 0;

4884 
Êags
;

4885 
pxt4_lblk_t
 
lblk
;

4886 
blkbôs
 = 
öode
->
i_blkbôs
;

4898 i‡(
	`IS_ENCRYPTED
(
öode
) &&

4899 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4900 
FALLOC_FL_ZERO_RANGE
)))

4901  -
EOPNOTSUPP
;

4904 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4905 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4906 
FALLOC_FL_INSERT_RANGE
))

4907  -
EOPNOTSUPP
;

4909 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4910  
	`pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àn
);

4912 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4913 i‡(
ªt
)

4914  
ªt
;

4916 i‡(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4917  
	`pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

4919 i‡(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4920  
	`pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

4922 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4923  
	`pxt4_zîo_ønge
(
fûe
, 
off£t
, 
Àn
, 
mode
);

4925 
	`åa˚_pxt4_ÁŒoˇã_íãr
(
öode
, 
off£t
, 
Àn
, 
mode
);

4926 
lblk
 = 
off£t
 >> 
blkbôs
;

4928 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4929 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4930 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4931 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4933 
	`öode_lock
(
öode
);

4938 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4939 
ªt
 = -
EOPNOTSUPP
;

4940 
out
;

4943 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4944 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4945 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4946 
√w_size
 = 
off£t
 + 
Àn
;

4947 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4948 i‡(
ªt
)

4949 
out
;

4953 
	`öode_dio_waô
(
öode
);

4955 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
, 
Êags
);

4956 i‡(
ªt
)

4957 
out
;

4959 i‡(
fûe
->
f_Êags
 & 
O_SYNC
 && 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

4960 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

4961 
	`PXT4_I
(
öode
)->
i_sync_tid
);

4963 
out
:

4964 
	`öode_u∆ock
(
öode
);

4965 
	`åa˚_pxt4_ÁŒoˇã_exô
(
öode
, 
off£t
, 
max_blocks
, 
ªt
);

4966  
ªt
;

4967 
	}
}

4979 
	$pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4980 
loff_t
 
off£t
, 
ssize_t
 
Àn
)

4982 
max_blocks
;

4983 
ªt
 = 0;

4984 
ªt2
 = 0;

4985 
pxt4_m≠_blocks
 
m≠
;

4986 
blkbôs
 = 
öode
->
i_blkbôs
;

4987 
¸edôs
 = 0;

4989 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

4990 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4992 i‡(!
h™dÀ
) {

4996 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
max_blocks
);

4998 
ªt
 >0 &&Ñë < 
max_blocks
) {

4999 
m≠
.
m_lblk
 +
ªt
;

5000 
m≠
.
m_Àn
 = (
max_blocks
 -
ªt
);

5001 i‡(
¸edôs
) {

5002 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

5003 
¸edôs
);

5004 i‡(
	`IS_ERR
(
h™dÀ
)) {

5005 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5009 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

5010 
PXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5011 i‡(
ªt
 <= 0)

5012 
	`pxt4_w¨nög
(
öode
->
i_sb
,

5015 
öode
->
i_öo
, 
m≠
.
m_lblk
,

5016 
m≠
.
m_Àn
, 
ªt
);

5017 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5018 i‡(
¸edôs
)

5019 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5020 i‡(
ªt
 <0 || 
ªt2
)

5023  
ªt
 > 0 ? 
ªt2
 :Ñet;

5024 
	}
}

5026 
	$pxt4_c⁄vît_unwrôãn_io_íd_vec
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_io_íd_t
 *
io_íd
)

5028 
ªt
, 
îr
 = 0;

5029 
pxt4_io_íd_vec
 *
io_íd_vec
;

5036 i‡(
h™dÀ
) {

5037 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_ª£rved
(handle,

5038 
PXT4_HT_EXT_CONVERT
);

5039 i‡(
	`IS_ERR
(
h™dÀ
))

5040  
	`PTR_ERR
(
h™dÀ
);

5043 
	`li°_f‹_óch_íåy
(
io_íd_vec
, &
io_íd
->
li°_vec
, 
li°
) {

5044 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ
, 
io_íd
->
öode
,

5045 
io_íd_vec
->
off£t
,

5046 
io_íd_vec
->
size
);

5047 i‡(
ªt
)

5051 i‡(
h™dÀ
)

5052 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5054  
ªt
 < 0 ?Ñë : 
îr
;

5055 
	}
}

5066 
	$pxt4_föd_dñayed_exã¡
(
öode
 *inode,

5067 
exã¡_°©us
 *
√wes
)

5069 
exã¡_°©us
 
es
;

5070 
pxt4_lblk_t
 
block
, 
√xt_dñ
;

5072 i‡(
√wes
->
es_pblk
 == 0) {

5073 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

5074 
√wes
->
es_lblk
,

5075 
√wes
->
es_lblk
 +Çewes->
es_Àn
 - 1,

5076 &
es
);

5082 i‡(
es
.
es_Àn
 == 0)

5086 i‡(
es
.
es_lblk
 > 
√wes
->es_lblk) {

5088 
√wes
->
es_Àn
 = 
	`mö
(
es
.
es_lblk
 -Çewes->es_lblk,

5089 
√wes
->
es_Àn
);

5093 
√wes
->
es_Àn
 = 
es
.
es_lblk
 +És.es_len -Çewes->es_lblk;

5096 
block
 = 
√wes
->
es_lblk
 +Çewes->
es_Àn
;

5097 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
block
,

5098 
EXT_MAX_BLOCKS
, &
es
);

5099 i‡(
es
.
es_Àn
 == 0)

5100 
√xt_dñ
 = 
EXT_MAX_BLOCKS
;

5102 
√xt_dñ
 = 
es
.
es_lblk
;

5104  
√xt_dñ
;

5105 
	}
}

5107 
	$pxt4_x©å_fõm≠
(
öode
 *inode,

5108 
fõm≠_exã¡_öfo
 *
fõöfo
)

5110 
__u64
 
physiˇl
 = 0;

5111 
__u64
 
Àngth
;

5112 
__u32
 
Êags
 = 
FIEMAP_EXTENT_LAST
;

5113 
blockbôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

5114 
îr‹
 = 0;

5117 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

5118 
pxt4_ûoc
 
ûoc
;

5119 
off£t
;

5121 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

5122 i‡(
îr‹
)

5123  
îr‹
;

5124 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
blockbôs
;

5125 
off£t
 = 
PXT4_GOOD_OLD_INODE_SIZE
 +

5126 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

5127 
physiˇl
 +
off£t
;

5128 
Àngth
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 - 
off£t
;

5129 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

5130 
	`bªl£
(
ûoc
.
bh
);

5132 
physiˇl
 = (
__u64
)
	`PXT4_I
(
öode
)->
i_fûe_a˛
 << 
blockbôs
;

5133 
Àngth
 = 
öode
->
i_sb
->
s_blocksize
;

5136 i‡(
physiˇl
)

5137 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 0, 
physiˇl
,

5138 
Àngth
, 
Êags
);

5139  (
îr‹
 < 0 ?Érror : 0);

5140 
	}
}

5142 
	$_pxt4_fõm≠
(
öode
 *inode,

5143 
fõm≠_exã¡_öfo
 *
fõöfo
,

5144 
__u64
 
°¨t
, __u64 
Àn
,

5145 (*
fûl
)(
öode
 *, 
pxt4_lblk_t
,

5146 
pxt4_lblk_t
,

5147 
fõm≠_exã¡_öfo
 *))

5149 
pxt4_lblk_t
 
°¨t_blk
;

5150 
u32
 
pxt4_fõm≠_Êags
 = 
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
;

5152 
îr‹
 = 0;

5154 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5155 
has_ölöe
 = 1;

5157 
îr‹
 = 
	`pxt4_ölöe_d©a_fõm≠
(
öode
, 
fõöfo
, &
has_ölöe
,

5158 
°¨t
, 
Àn
);

5160 i‡(
has_ölöe
)

5161  
îr‹
;

5164 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_CACHE
) {

5165 
îr‹
 = 
	`pxt4_ext_¥eˇche
(
öode
);

5166 i‡(
îr‹
)

5167  
îr‹
;

5168 
fõöfo
->
fi_Êags
 &~
FIEMAP_FLAG_CACHE
;

5172 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) &&

5173 
fûl
 =
pxt4_fûl_fõm≠_exã¡s
)

5174  
	`gíîic_block_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5175 
pxt4_gë_block
);

5177 i‡(
fûl
 =
pxt4_fûl_es_ˇche_öfo
)

5178 
pxt4_fõm≠_Êags
 &
FIEMAP_FLAG_XATTR
;

5179 i‡(
	`fõm≠_check_Êags
(
fõöfo
, 
pxt4_fõm≠_Êags
))

5180  -
EBADR
;

5182 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_XATTR
) {

5183 
îr‹
 = 
	`pxt4_x©å_fõm≠
(
öode
, 
fõöfo
);

5185 
pxt4_lblk_t
 
Àn_blks
;

5186 
__u64
 
œ°_blk
;

5188 
°¨t_blk
 = 
°¨t
 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

5189 
œ°_blk
 = (
°¨t
 + 
Àn
 - 1Ë>> 
öode
->
i_sb
->
s_blocksize_bôs
;

5190 i‡(
œ°_blk
 >
EXT_MAX_BLOCKS
)

5191 
œ°_blk
 = 
EXT_MAX_BLOCKS
-1;

5192 
Àn_blks
 = ((
pxt4_lblk_t
Ë
œ°_blk
Ë- 
°¨t_blk
 + 1;

5198 
îr‹
 = 
	`fûl
(
öode
, 
°¨t_blk
, 
Àn_blks
, 
fõöfo
);

5200  
îr‹
;

5201 
	}
}

5203 
	$pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5204 
__u64
 
°¨t
, __u64 
Àn
)

5206  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5207 
pxt4_fûl_fõm≠_exã¡s
);

5208 
	}
}

5210 
	$pxt4_gë_es_ˇche
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5211 
__u64
 
°¨t
, __u64 
Àn
)

5213 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5214 
has_ölöe
;

5216 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5217 
has_ölöe
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

5218 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5219 i‡(
has_ölöe
)

5223  
	`_pxt4_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5224 
pxt4_fûl_es_ˇche_öfo
);

5225 
	}
}

5235 
	$pxt4_ac˚ss_∑th
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5236 
pxt4_ext_∑th
 *
∑th
)

5238 
¸edôs
, 
îr
;

5240 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

5249 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5250 
îr
 = 
	`pxt4_d©a£m_ísuª_¸edôs
(
h™dÀ
, 
öode
, 7, 
¸edôs
, 0);

5251 i‡(
îr
 < 0)

5252  
îr
;

5254 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

5255  
îr
;

5256 
	}
}

5265 
	$pxt4_ext_shi·_∑th_exã¡s
(
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
shi·
,

5266 
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5267 
SHIFT_DIRECTION
 
SHIFT
)

5269 
dïth
, 
îr
 = 0;

5270 
pxt4_exã¡
 *
ex_°¨t
, *
ex_œ°
;

5271 
boﬁ
 
upd©e
 = 0;

5272 
dïth
 = 
∑th
->
p_dïth
;

5274 
dïth
 >= 0) {

5275 i‡(
dïth
 =
∑th
->
p_dïth
) {

5276 
ex_°¨t
 = 
∑th
[
dïth
].
p_ext
;

5277 i‡(!
ex_°¨t
)

5278  -
EFSCORRUPTED
;

5280 
ex_œ°
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5282 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5283 i‡(
îr
)

5284 
out
;

5286 i‡(
ex_°¨t
 =
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5287 
upd©e
 = 1;

5289 
ex_°¨t
 <
ex_œ°
) {

5290 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5291 
	`À32_add_˝u
(&
ex_°¨t
->
ì_block
,

5292 -
shi·
);

5294 i‡((
ex_°¨t
 >

5295 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5297 
	`pxt4_ext_åy_to_mîge_right
(
öode
,

5298 
∑th
, 
ex_°¨t
 - 1))

5299 
ex_œ°
--;

5301 
ex_°¨t
++;

5303 
	`À32_add_˝u
(&
ex_œ°
->
ì_block
, 
shi·
);

5304 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
,

5305 
ex_œ°
);

5306 
ex_œ°
--;

5309 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5310 i‡(
îr
)

5311 
out
;

5313 i‡(--
dïth
 < 0 || !
upd©e
)

5318 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5319 i‡(
îr
)

5320 
out
;

5322 i‡(
SHIFT
 =
SHIFT_LEFT
)

5323 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, -
shi·
);

5325 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, 
shi·
);

5326 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5327 i‡(
îr
)

5328 
out
;

5331 i‡(
∑th
[
dïth
].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[dïth].
p_hdr
))

5334 
dïth
--;

5337 
out
:

5338  
îr
;

5339 
	}
}

5349 
	$pxt4_ext_shi·_exã¡s
(
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5350 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
shi·
,

5351 
SHIFT_DIRECTION
 
SHIFT
)

5353 
pxt4_ext_∑th
 *
∑th
;

5354 
ªt
 = 0, 
dïth
;

5355 
pxt4_exã¡
 *
exã¡
;

5356 
pxt4_lblk_t
 
°›
, *
ôî©‹
, 
ex_°¨t
, 
ex_íd
;

5359 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5360 
PXT4_EX_NOCACHE
);

5361 i‡(
	`IS_ERR
(
∑th
))

5362  
	`PTR_ERR
(
∑th
);

5364 
dïth
 = 
∑th
->
p_dïth
;

5365 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5366 i‡(!
exã¡
)

5367 
out
;

5369 
°›
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5376 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5377 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
°¨t
 - 1, &path,

5378 
PXT4_EX_NOCACHE
);

5379 i‡(
	`IS_ERR
(
∑th
))

5380  
	`PTR_ERR
(
∑th
);

5381 
dïth
 = 
∑th
->
p_dïth
;

5382 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5383 i‡(
exã¡
) {

5384 
ex_°¨t
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5385 
ex_íd
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5386 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5388 
ex_°¨t
 = 0;

5389 
ex_íd
 = 0;

5392 i‡((
°¨t
 =
ex_°¨t
 && 
shi·
 >Éx_start) ||

5393 (
shi·
 > 
°¨t
 - 
ex_íd
)) {

5394 
ªt
 = -
EINVAL
;

5395 
out
;

5398 i‡(
shi·
 > 
EXT_MAX_BLOCKS
 -

5399 (
°›
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
))) {

5400 
ªt
 = -
EINVAL
;

5401 
out
;

5410 i‡(
SHIFT
 =
SHIFT_LEFT
)

5411 
ôî©‹
 = &
°¨t
;

5413 
ôî©‹
 = &
°›
;

5420 
ôî©‹
 && 
°¨t
 <
°›
) {

5421 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, *
ôî©‹
, &path,

5422 
PXT4_EX_NOCACHE
);

5423 i‡(
	`IS_ERR
(
∑th
))

5424  
	`PTR_ERR
(
∑th
);

5425 
dïth
 = 
∑th
->
p_dïth
;

5426 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5427 i‡(!
exã¡
) {

5428 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

5429 (Ë*
ôî©‹
);

5430  -
EFSCORRUPTED
;

5432 i‡(
SHIFT
 =
SHIFT_LEFT
 && *
ôî©‹
 >

5433 
	`À32_to_˝u
(
exã¡
->
ì_block
)) {

5435 i‡(
exã¡
 < 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

5436 
∑th
[
dïth
].
p_ext
++;

5438 *
ôî©‹
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5443 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5444 
exã¡
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5445 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5446 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5448 
exã¡
 = 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5449 i‡(
	`À32_to_˝u
(
exã¡
->
ì_block
) > 0)

5450 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) - 1;

5453 
ôî©‹
 = 
NULL
;

5455 
	`À32_to_˝u
(
exã¡
->
ì_block
Ë< 
°¨t
)

5456 
exã¡
++;

5457 
∑th
[
dïth
].
p_ext
 = 
exã¡
;

5459 
ªt
 = 
	`pxt4_ext_shi·_∑th_exã¡s
(
∑th
, 
shi·
, 
öode
,

5460 
h™dÀ
, 
SHIFT
);

5461 i‡(
ªt
)

5464 
out
:

5465 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5466 
	`k‰ì
(
∑th
);

5467  
ªt
;

5468 
	}
}

5475 
	$pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5477 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5478 
pxt4_lblk_t
 
punch_°¨t
, 
punch_°›
;

5479 
h™dÀ_t
 *
h™dÀ
;

5480 
¸edôs
;

5481 
loff_t
 
√w_size
, 
ioff£t
;

5482 
ªt
;

5489 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5490  -
EOPNOTSUPP
;

5493 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5494 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5495  -
EINVAL
;

5497 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5498  -
EINVAL
;

5500 
	`åa˚_pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

5502 
punch_°¨t
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5503 
punch_°›
 = (
off£t
 + 
Àn
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5506 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5507 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5508 i‡(
ªt
)

5509  
ªt
;

5512 
	`öode_lock
(
öode
);

5517 i‡(
off£t
 + 
Àn
 >
	`i_size_ªad
(
öode
)) {

5518 
ªt
 = -
EINVAL
;

5519 
out_muãx
;

5523 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5524 
ªt
 = -
EOPNOTSUPP
;

5525 
out_muãx
;

5529 
	`öode_dio_waô
(
öode
);

5535 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5537 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5538 i‡(
ªt
)

5539 
out_mm≠
;

5545 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5550 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
, 
off£t
);

5551 i‡(
ªt
)

5552 
out_mm≠
;

5558 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
off£t
 + 
Àn
,

5559 
LLONG_MAX
);

5560 i‡(
ªt
)

5561 
out_mm≠
;

5562 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5564 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5565 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5566 i‡(
	`IS_ERR
(
h™dÀ
)) {

5567 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5568 
out_mm≠
;

5571 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5572 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5574 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
punch_°¨t
,

5575 
EXT_MAX_BLOCKS
 - 
punch_°¨t
);

5576 i‡(
ªt
) {

5577 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5578 
out_°›
;

5581 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
punch_°¨t
, 
punch_°›
 - 1);

5582 i‡(
ªt
) {

5583 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5584 
out_°›
;

5586 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5588 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
, 
punch_°›
,

5589 
punch_°›
 - 
punch_°¨t
, 
SHIFT_LEFT
);

5590 i‡(
ªt
) {

5591 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5592 
out_°›
;

5595 
√w_size
 = 
	`i_size_ªad
(
öode
Ë- 
Àn
;

5596 
	`i_size_wrôe
(
öode
, 
√w_size
);

5597 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√w_size
;

5599 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5600 i‡(
	`IS_SYNC
(
öode
))

5601 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5602 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5603 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5604 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5606 
out_°›
:

5607 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5608 
out_mm≠
:

5609 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5610 
out_muãx
:

5611 
	`öode_u∆ock
(
öode
);

5612  
ªt
;

5613 
	}
}

5623 
	$pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5625 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5626 
h™dÀ_t
 *
h™dÀ
;

5627 
pxt4_ext_∑th
 *
∑th
;

5628 
pxt4_exã¡
 *
exã¡
;

5629 
pxt4_lblk_t
 
off£t_lblk
, 
Àn_lblk
, 
ì_°¨t_lblk
 = 0;

5630 
¸edôs
, 
ì_Àn
;

5631 
ªt
 = 0, 
dïth
, 
•lô_Êag
 = 0;

5632 
loff_t
 
ioff£t
;

5639 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5640  -
EOPNOTSUPP
;

5643 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5644 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5645  -
EINVAL
;

5647 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5648  -
EOPNOTSUPP
;

5650 
	`åa˚_pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

5652 
off£t_lblk
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5653 
Àn_lblk
 = 
Àn
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5656 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5657 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5658 i‡(
ªt
)

5659  
ªt
;

5662 
	`öode_lock
(
öode
);

5664 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5665 
ªt
 = -
EOPNOTSUPP
;

5666 
out_muãx
;

5670 i‡(
öode
->
i_size
 + 
Àn
 > inode->
i_sb
->
s_maxbyãs
) {

5671 
ªt
 = -
EFBIG
;

5672 
out_muãx
;

5676 i‡(
off£t
 >
	`i_size_ªad
(
öode
)) {

5677 
ªt
 = -
EINVAL
;

5678 
out_muãx
;

5682 
	`öode_dio_waô
(
öode
);

5688 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5690 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5691 i‡(
ªt
)

5692 
out_mm≠
;

5698 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5700 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
,

5701 
LLONG_MAX
);

5702 i‡(
ªt
)

5703 
out_mm≠
;

5704 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5706 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5707 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5708 i‡(
	`IS_ERR
(
h™dÀ
)) {

5709 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5710 
out_mm≠
;

5714 
öode
->
i_size
 +
Àn
;

5715 
	`PXT4_I
(
öode
)->
i_disksize
 +
Àn
;

5716 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5717 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5718 i‡(
ªt
)

5719 
out_°›
;

5721 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5722 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5724 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
off£t_lblk
, 
NULL
, 0);

5725 i‡(
	`IS_ERR
(
∑th
)) {

5726 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5727 
out_°›
;

5730 
dïth
 = 
	`ext_dïth
(
öode
);

5731 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5732 i‡(
exã¡
) {

5733 
ì_°¨t_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5734 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5740 i‡((
off£t_lblk
 > 
ì_°¨t_lblk
) &&

5741 (
off£t_lblk
 < (
ì_°¨t_lblk
 + 
ì_Àn
))) {

5742 i‡(
	`pxt4_ext_is_unwrôãn
(
exã¡
))

5743 
•lô_Êag
 = 
PXT4_EXT_MARK_UNWRIT1
 |

5744 
PXT4_EXT_MARK_UNWRIT2
;

5745 
ªt
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

5746 
off£t_lblk
, 
•lô_Êag
,

5747 
PXT4_EX_NOCACHE
 |

5748 
PXT4_GET_BLOCKS_PRE_IO
 |

5749 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5752 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5753 
	`k‰ì
(
∑th
);

5754 i‡(
ªt
 < 0) {

5755 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5756 
out_°›
;

5759 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5760 
	`k‰ì
(
∑th
);

5763 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
off£t_lblk
,

5764 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5765 i‡(
ªt
) {

5766 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5767 
out_°›
;

5774 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
,

5775 
ì_°¨t_lblk
 > 
off£t_lblk
 ?Ée_start_lblk : offset_lblk,

5776 
Àn_lblk
, 
SHIFT_RIGHT
);

5778 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5779 i‡(
	`IS_SYNC
(
öode
))

5780 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5781 i‡(
ªt
 >= 0)

5782 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5784 
out_°›
:

5785 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5786 
out_mm≠
:

5787 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5788 
out_muãx
:

5789 
	`öode_u∆ock
(
öode
);

5790  
ªt
;

5791 
	}
}

5814 
	$pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

5815 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,Öxt4_lblk_à
lblk2
,

5816 
pxt4_lblk_t
 
cou¡
, 
unwrôãn
, *
îp
)

5818 
pxt4_ext_∑th
 *
∑th1
 = 
NULL
;

5819 
pxt4_ext_∑th
 *
∑th2
 = 
NULL
;

5820 
ª∂a˚d_cou¡
 = 0;

5822 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode1
)->
i_d©a_£m
));

5823 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode2
)->
i_d©a_£m
));

5824 
	`BUG_ON
(!
	`öode_is_locked
(
öode1
));

5825 
	`BUG_ON
(!
	`öode_is_locked
(
öode2
));

5827 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode1
, 
lblk1
, 
cou¡
);

5828 i‡(
	`u∆ikñy
(*
îp
))

5830 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode2
, 
lblk2
, 
cou¡
);

5831 i‡(
	`u∆ikñy
(*
îp
))

5834 
cou¡
) {

5835 
pxt4_exã¡
 *
ex1
, *
ex2
, 
tmp_ex
;

5836 
pxt4_lblk_t
 
e1_blk
, 
e2_blk
;

5837 
e1_Àn
, 
e2_Àn
, 
Àn
;

5838 
•lô
 = 0;

5840 
∑th1
 = 
	`pxt4_föd_exã¡
(
öode1
, 
lblk1
, 
NULL
, 
PXT4_EX_NOCACHE
);

5841 i‡(
	`IS_ERR
(
∑th1
)) {

5842 *
îp
 = 
	`PTR_ERR
(
∑th1
);

5843 
∑th1
 = 
NULL
;

5844 
föish
:

5845 
cou¡
 = 0;

5846 
ª≥©
;

5848 
∑th2
 = 
	`pxt4_föd_exã¡
(
öode2
, 
lblk2
, 
NULL
, 
PXT4_EX_NOCACHE
);

5849 i‡(
	`IS_ERR
(
∑th2
)) {

5850 *
îp
 = 
	`PTR_ERR
(
∑th2
);

5851 
∑th2
 = 
NULL
;

5852 
föish
;

5854 
ex1
 = 
∑th1
[∑th1->
p_dïth
].
p_ext
;

5855 
ex2
 = 
∑th2
[∑th2->
p_dïth
].
p_ext
;

5857 i‡(
	`u∆ikñy
(!
ex2
 || !
ex1
))

5858 
föish
;

5860 
e1_blk
 = 
	`À32_to_˝u
(
ex1
->
ì_block
);

5861 
e2_blk
 = 
	`À32_to_˝u
(
ex2
->
ì_block
);

5862 
e1_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

5863 
e2_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

5866 i‡(!
	`ö_ønge
(
lblk1
, 
e1_blk
, 
e1_Àn
) ||

5867 !
	`ö_ønge
(
lblk2
, 
e2_blk
, 
e2_Àn
)) {

5868 
pxt4_lblk_t
 
√xt1
, 
≈xt2
;

5871 
√xt1
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th1
);

5872 
≈xt2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th2
);

5874 i‡(
e1_blk
 > 
lblk1
)

5875 
√xt1
 = 
e1_blk
;

5876 i‡(
e2_blk
 > 
lblk2
)

5877 
≈xt2
 = 
e2_blk
;

5879 i‡(
√xt1
 =
EXT_MAX_BLOCKS
 || 
≈xt2
 == EXT_MAX_BLOCKS)

5880 
föish
;

5882 
Àn
 = 
√xt1
 - 
lblk1
;

5883 i‡(
Àn
 < 
≈xt2
 - 
lblk2
)

5884 
Àn
 = 
≈xt2
 - 
lblk2
;

5885 i‡(
Àn
 > 
cou¡
)

5886 
Àn
 = 
cou¡
;

5887 
lblk1
 +
Àn
;

5888 
lblk2
 +
Àn
;

5889 
cou¡
 -
Àn
;

5890 
ª≥©
;

5894 i‡(
e1_blk
 < 
lblk1
) {

5895 
•lô
 = 1;

5896 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5897 &
∑th1
, 
lblk1
, 0);

5898 i‡(
	`u∆ikñy
(*
îp
))

5899 
föish
;

5901 i‡(
e2_blk
 < 
lblk2
) {

5902 
•lô
 = 1;

5903 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5904 &
∑th2
, 
lblk2
, 0);

5905 i‡(
	`u∆ikñy
(*
îp
))

5906 
föish
;

5910 i‡(
•lô
)

5911 
ª≥©
;

5914 
Àn
 = 
cou¡
;

5915 i‡(
Àn
 > 
e1_blk
 + 
e1_Àn
 - 
lblk1
)

5916 
Àn
 = 
e1_blk
 + 
e1_Àn
 - 
lblk1
;

5917 i‡(
Àn
 > 
e2_blk
 + 
e2_Àn
 - 
lblk2
)

5918 
Àn
 = 
e2_blk
 + 
e2_Àn
 - 
lblk2
;

5920 i‡(
Àn
 !
e1_Àn
) {

5921 
•lô
 = 1;

5922 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5923 &
∑th1
, 
lblk1
 + 
Àn
, 0);

5924 i‡(
	`u∆ikñy
(*
îp
))

5925 
föish
;

5927 i‡(
Àn
 !
e2_Àn
) {

5928 
•lô
 = 1;

5929 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5930 &
∑th2
, 
lblk2
 + 
Àn
, 0);

5931 i‡(*
îp
)

5932 
föish
;

5936 i‡(
•lô
)

5937 
ª≥©
;

5939 
	`BUG_ON
(
e2_Àn
 !
e1_Àn
);

5940 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode1
, 
∑th1
 +Ö©h1->
p_dïth
);

5941 i‡(
	`u∆ikñy
(*
îp
))

5942 
föish
;

5943 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode2
, 
∑th2
 +Ö©h2->
p_dïth
);

5944 i‡(
	`u∆ikñy
(*
îp
))

5945 
föish
;

5948 
tmp_ex
 = *
ex1
;

5949 
	`pxt4_ext_°‹e_pblock
(
ex1
, 
	`pxt4_ext_pblock
(
ex2
));

5950 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
	`pxt4_ext_pblock
(&
tmp_ex
));

5951 
ex1
->
ì_Àn
 = 
	`˝u_to_À16
(
e2_Àn
);

5952 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
(
e1_Àn
);

5953 i‡(
unwrôãn
)

5954 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

5955 i‡(
	`pxt4_ext_is_unwrôãn
(&
tmp_ex
))

5956 
	`pxt4_ext_m¨k_unwrôãn
(
ex1
);

5958 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode2
, 
∑th2
, 
ex2
);

5959 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode1
, 
∑th1
, 
ex1
);

5960 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode2
, 
∑th2
 +

5961 
∑th2
->
p_dïth
);

5962 i‡(
	`u∆ikñy
(*
îp
))

5963 
föish
;

5964 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode1
, 
∑th1
 +

5965 
∑th1
->
p_dïth
);

5972 i‡(
	`u∆ikñy
(*
îp
))

5973 
föish
;

5974 
lblk1
 +
Àn
;

5975 
lblk2
 +
Àn
;

5976 
ª∂a˚d_cou¡
 +
Àn
;

5977 
cou¡
 -
Àn
;

5979 
ª≥©
:

5980 
	`pxt4_ext_dr›_ªfs
(
∑th1
);

5981 
	`k‰ì
(
∑th1
);

5982 
	`pxt4_ext_dr›_ªfs
(
∑th2
);

5983 
	`k‰ì
(
∑th2
);

5984 
∑th1
 = 
∑th2
 = 
NULL
;

5986  
ª∂a˚d_cou¡
;

5987 
	}
}

6001 
	$pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
)

6003 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6004 
pxt4_ext_∑th
 *
∑th
;

6005 
dïth
, 
m≠≥d
 = 0, 
îr
 = 0;

6006 
pxt4_exã¡
 *
exã¡
;

6007 
pxt4_lblk_t
 
fú°_lblk
, 
fú°_l˛u
, 
œ°_l˛u
;

6010 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
	`PXT4_C2B
(
sbi
, 
l˛u
), 
NULL
, 0);

6011 i‡(
	`IS_ERR
(
∑th
)) {

6012 
îr
 = 
	`PTR_ERR
(
∑th
);

6013 
∑th
 = 
NULL
;

6014 
out
;

6017 
dïth
 = 
	`ext_dïth
(
öode
);

6024 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

6025 
	`PXT4_ERROR_INODE
(
öode
,

6027 (Ë
	`PXT4_C2B
(
sbi
, 
l˛u
),

6028 
dïth
, 
∑th
[dïth].
p_block
);

6029 
îr
 = -
EFSCORRUPTED
;

6030 
out
;

6033 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

6036 i‡(
exã¡
 =
NULL
)

6037 
out
;

6039 
fú°_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

6040 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6048 i‡(
l˛u
 >
fú°_l˛u
) {

6049 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
 +

6050 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
) - 1);

6051 i‡(
l˛u
 <
œ°_l˛u
) {

6052 
m≠≥d
 = 1;

6054 
fú°_lblk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

6055 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

6056 i‡(
l˛u
 =
fú°_l˛u
)

6057 
m≠≥d
 = 1;

6061 
out
:

6062 
	`pxt4_ext_dr›_ªfs
(
∑th
);

6063 
	`k‰ì
(
∑th
);

6065  
îr
 ?Éº : 
m≠≥d
;

6066 
	}
}

	@extents_status.c

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/£q_fûe.h
>

16 
	~"pxt4.h
"

18 
	~<åa˚/evíts/pxt4.h
>

144 
kmem_ˇche
 *
	gpxt4_es_ˇchï
;

145 
kmem_ˇche
 *
	gpxt4_≥ndög_ˇchï
;

147 
__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
);

148 
__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

149 
pxt4_lblk_t
 
íd
, *
ª£rved
);

150 
es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
);

151 
__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

152 
pxt4_öode_öfo
 *
locked_ei
);

153 
__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

154 
pxt4_lblk_t
 
Àn
);

156 
__öô
 
	$pxt4_öô_es
()

158 
pxt4_es_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_extent_status",

159 (
exã¡_°©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 i‡(
pxt4_es_ˇchï
 =
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$pxt4_exô_es
()

168 
	`kmem_ˇche_de°roy
(
pxt4_es_ˇchï
);

169 
	}
}

171 
	$pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
)

173 
åì
->
roŸ
 = 
RB_ROOT
;

174 
åì
->
ˇche_es
 = 
NULL
;

175 
	}
}

177 #ifde‡
ES_DEBUG__


178 
	$pxt4_es_¥öt_åì
(
öode
 *inode)

180 
pxt4_es_åì
 *
åì
;

181 
rb_node
 *
node
;

183 
	`¥ötk
(
KERN_DEBUG
 "°©u†exã¡†f‹ inodê%lu:", 
öode
->
i_öo
);

184 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

185 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

186 
node
) {

187 
exã¡_°©us
 *
es
;

188 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

189 
	`¥ötk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,És->
es_Àn
,

191 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

192 
node
 = 
	`rb_√xt
(node);

194 
	`¥ötk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#pxt4_es_¥öt_åì
(
öode
)

	)

200 
ölöe
 
pxt4_lblk_t
 
	$pxt4_es_íd
(
exã¡_°©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +És->
es_Àn
 <És->es_lblk);

203  
es
->
es_lblk
 +És->
es_Àn
 - 1;

204 
	}
}

210 
exã¡_°©us
 *
	$__es_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

211 
pxt4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roŸ
->rb_node;

214 
exã¡_°©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

218 i‡(
lblk
 < 
es
->
es_lblk
)

219 
node
 =Çode->
rb_À·
;

220 i‡(
lblk
 > 
	`pxt4_es_íd
(
es
))

221 
node
 =Çode->
rb_right
;

223  
es
;

226 i‡(
es
 && 
lblk
 <És->
es_lblk
)

227  
es
;

229 i‡(
es
 && 
lblk
 > 
	`pxt4_es_íd
(es)) {

230 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_föd_exã¡_ønge
(
öode
 *inode,

257 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

258 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

259 
exã¡_°©us
 *
es
)

261 
pxt4_es_åì
 *
åì
 = 
NULL
;

262 
exã¡_°©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =
NULL
);

266 
	`WARN_ON
(
íd
 < 
lblk
);

268 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

271 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

272 i‡(
åì
->
ˇche_es
) {

273 
es1
 = 
åì
->
ˇche_es
;

274 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
,

277 
	`pxt4_es_pblock
(
es1
), 
	`pxt4_es_°©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

284 
out
:

285 i‡(
es1
 && !
	`m©chög_‚
(es1)) {

286 (
node
 = 
	`rb_√xt
(&
es1
->
rb_node
)Ë!
NULL
) {

287 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

288 i‡(
es1
->
es_lblk
 > 
íd
) {

289 
es1
 = 
NULL
;

292 i‡(
	`m©chög_‚
(
es1
))

297 i‡(
es1
 && 
	`m©chög_‚
(es1)) {

298 
åì
->
ˇche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Àn
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

310 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

311 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

312 
exã¡_°©us
 *
es
)

314 
	`åa˚_pxt4_es_föd_exã¡_ønge_íãr
(
öode
, 
lblk
);

316 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

317 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
, 
es
);

318 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

320 
	`åa˚_pxt4_es_föd_exã¡_ønge_exô
(
öode
, 
es
);

321 
	}
}

338 
boﬁ
 
	$__es_sˇn_ønge
(
öode
 *inode,

339 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

340 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

342 
exã¡_°©us
 
es
;

344 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
°¨t
, 
íd
, &
es
);

345 i‡(
es
.
es_Àn
 == 0)

346  
Ál£
;

347 i‡(
es
.
es_lblk
 <
°¨t
 &&

348 
°¨t
 < 
es
.
es_lblk
 +És.
es_Àn
)

349  
åue
;

350 i‡(
°¨t
 <
es
.
es_lblk
 &&És.es_lblk <
íd
)

351  
åue
;

353  
Ál£
;

354 
	}
}

358 
boﬁ
 
	$pxt4_es_sˇn_ønge
(
öode
 *inode,

359 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

360 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
)

362 
boﬁ
 
ªt
;

364 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

365 
ªt
 = 
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
);

366 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

368  
ªt
;

369 
	}
}

385 
boﬁ
 
	$__es_sˇn_˛u
(
öode
 *inode,

386 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

387 
pxt4_lblk_t
 
lblk
)

389 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

390 
pxt4_lblk_t
 
lblk_°¨t
, 
lblk_íd
;

392 
lblk_°¨t
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_íd
 = 
lblk_°¨t
 + 
sbi
->
s_˛u°î_øtio
 - 1;

395  
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk_°¨t
, 
lblk_íd
);

396 
	}
}

401 
boﬁ
 
	$pxt4_es_sˇn_˛u
(
öode
 *inode,

402 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

403 
pxt4_lblk_t
 
lblk
)

405 
boﬁ
 
ªt
;

407 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

408 
ªt
 = 
	`__es_sˇn_˛u
(
öode
, 
m©chög_‚
, 
lblk
);

409 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

411  
ªt
;

412 
	}
}

414 
	$pxt4_es_li°_add
(
öode
 *inode)

416 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

417 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

419 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
))

422 
	`•ö_lock
(&
sbi
->
s_es_lock
);

423 i‡(
	`li°_em±y
(&
ei
->
i_es_li°
)) {

424 
	`li°_add_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

425 
sbi
->
s_es_ƒ_öode
++;

427 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$pxt4_es_li°_dñ
(
öode
 *inode)

432 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

435 
	`•ö_lock
(&
sbi
->
s_es_lock
);

436 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
)) {

437 
	`li°_dñ_öô
(&
ei
->
i_es_li°
);

438 
sbi
->
s_es_ƒ_öode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_ƒ_öode
 < 0);

441 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
exã¡_°©us
 *

445 
	$pxt4_es_Æloc_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
Àn
,

446 
pxt4_fsblk_t
 
pblk
)

448 
exã¡_°©us
 *
es
;

449 
es
 = 
	`kmem_ˇche_Æloc
(
pxt4_es_ˇchï
, 
GFP_ATOMIC
);

450 i‡(
es
 =
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Àn
 = 
Àn
;

454 
es
->
es_pblk
 = 
pblk
;

459 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

460 i‡(!
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
++)

461 
	`pxt4_es_li°_add
(
öode
);

462 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->

463 
s_es_°©s
.
es_°©s_shk_˙t
);

466 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
++;

467 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

469  
es
;

470 
	}
}

472 
	$pxt4_es_‰ì_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
es
)

474 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
--;

475 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

478 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

479 
	`BUG_ON
(
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
 == 0);

480 i‡(!--
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
)

481 
	`pxt4_es_li°_dñ
(
öode
);

482 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->

483 
s_es_°©s
.
es_°©s_shk_˙t
);

486 
	`kmem_ˇche_‰ì
(
pxt4_es_ˇchï
, 
es
);

487 
	}
}

496 
	$pxt4_es_ˇn_be_mîged
(
exã¡_°©us
 *
es1
,

497 
exã¡_°©us
 *
es2
)

499 i‡(
	`pxt4_es_ty≥
(
es1
Ë!pxt4_es_ty≥(
es2
))

502 i‡(((
__u64
Ë
es1
->
es_Àn
Ë+ 
es2
->es_À¿> 
EXT_MAX_BLOCKS
) {

503 
	`¥_w¨n
("ESássertion failed when mergingÉxtents. "

506 
es1
->
es_Àn
, 
es2
->es_Àn, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 i‡(((
__u64
Ë
es1
->
es_lblk
Ë+És1->
es_Àn
 !
es2
->es_lblk)

514 i‡((
	`pxt4_es_is_wrôãn
(
es1
Ë|| 
	`pxt4_es_is_unwrôãn
(es1)) &&

515 (
	`pxt4_es_pblock
(
es1
Ë+És1->
es_Àn
 =pxt4_es_pblock(
es2
)))

518 i‡(
	`pxt4_es_is_hﬁe
(
es1
))

522 i‡(
	`pxt4_es_is_dñayed
(
es1
Ë&& !
	`pxt4_es_is_unwrôãn
(es1))

526 
	}
}

528 
exã¡_°©us
 *

529 
	$pxt4_es_åy_to_mîge_À·
(
öode
 *öode, 
exã¡_°©us
 *
es
)

531 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

532 
exã¡_°©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

536 i‡(!
node
)

537  
es
;

539 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

540 i‡(
	`pxt4_es_ˇn_be_mîged
(
es1
, 
es
)) {

541 
es1
->
es_Àn
 +
es
->es_len;

542 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
))

543 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

544 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

545 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
exã¡_°©us
 *

553 
	$pxt4_es_åy_to_mîge_right
(
öode
 *öode, 
exã¡_°©us
 *
es
)

555 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

556 
exã¡_°©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

560 i‡(!
node
)

561  
es
;

563 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

564 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
es1
)) {

565 
es
->
es_Àn
 +
es1
->es_len;

566 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es1
))

567 
	`pxt4_es_£t_ª„ªn˚d
(
es
);

568 
	`rb_îa£
(
node
, &
åì
->
roŸ
);

569 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifde‡
ES_AGGRESSIVE_TEST


576 
	~"pxt4_exã¡s.h
"

578 
	$pxt4_es_ö£π_exã¡_ext_check
(
öode
 *inode,

579 
exã¡_°©us
 *
es
)

581 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

582 
pxt4_exã¡
 *
ex
;

583 
pxt4_lblk_t
 
ì_block
;

584 
pxt4_fsblk_t
 
ì_°¨t
;

585 
ì_Àn
;

586 
dïth
, 
ì_°©us
, 
es_°©us
;

588 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
es
->
es_lblk
, 
NULL
, 
PXT4_EX_NOCACHE
);

589 i‡(
	`IS_ERR
(
∑th
))

592 
dïth
 = 
	`ext_dïth
(
öode
);

593 
ex
 = 
∑th
[
dïth
].
p_ext
;

595 i‡(
ex
) {

597 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

598 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

601 
ì_°©us
 = 
	`pxt4_ext_is_unwrôãn
(
ex
) ? 1 : 0;

602 
es_°©us
 = 
	`pxt4_es_is_unwrôãn
(
es
) ? 1 : 0;

608 i‡(!
	`pxt4_es_is_wrôãn
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es)) {

609 i‡(
	`ö_ønge
(
es
->
es_lblk
, 
ì_block
, 
ì_Àn
)) {

610 
	`¥_w¨n
("ES insertássertion failed for "

615 
öode
->
i_öo
, 
ì_block
, 
ì_Àn
,

616 
ì_°¨t
, 
ì_°©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,És->
es_Àn
,

618 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

620 
out
;

627 i‡(
es
->
es_lblk
 < 
ì_block
 ||

628 
	`pxt4_es_pblock
(
es
Ë!
ì_°¨t
 +És->
es_lblk
 - 
ì_block
) {

629 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

631 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

632 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

633 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

634 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

635 
out
;

638 i‡(
ì_°©us
 ^ 
es_°©us
) {

639 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

641 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

642 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

643 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

644 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

651 i‡(!
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_hﬁe
(es)) {

652 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

655 "[%d/%d/%Œu/%x]\n", 
öode
->
i_öo
,

656 
es
->
es_lblk
,És->es_lblk,És->
es_Àn
,

657 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

660 
out
:

661 
	`pxt4_ext_dr›_ªfs
(
∑th
);

662 
	`k‰ì
(
∑th
);

663 
	}
}

665 
	$pxt4_es_ö£π_exã¡_öd_check
(
öode
 *inode,

666 
exã¡_°©us
 *
es
)

668 
pxt4_m≠_blocks
 
m≠
;

669 
ªtvÆ
;

678 
m≠
.
m_lblk
 = 
es
->
es_lblk
;

679 
m≠
.
m_Àn
 = 
es
->
es_Àn
;

681 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

682 i‡(
ªtvÆ
 > 0) {

683 i‡(
	`pxt4_es_is_dñayed
(
es
Ë|| 
	`pxt4_es_is_hﬁe
(es)) {

688 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

691 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

692 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

694 } i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

695 i‡(
ªtvÆ
 !
es
->
es_Àn
) {

696 
	`¥_w¨n
("ES insertássertion failed for "

698 
öode
->
i_öo
, 
ªtvÆ
, 
es
->
es_Àn
);

701 i‡(
m≠
.
m_pblk
 !
	`pxt4_es_pblock
(
es
)) {

702 
	`¥_w¨n
("ES insertássertion failed for "

705 
öode
->
i_öo
, 
m≠
.
m_pblk
,

706 
	`pxt4_es_pblock
(
es
));

714 
	`BUG
();

716 } i‡(
ªtvÆ
 == 0) {

717 i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

718 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

721 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

722 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

726 
	}
}

728 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

729 
exã¡_°©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

736 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

737 
	`pxt4_es_ö£π_exã¡_ext_check
(
öode
, 
es
);

739 
	`pxt4_es_ö£π_exã¡_öd_check
(
öode
, 
es
);

740 
	}
}

742 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

743 
exã¡_°©us
 *
es
)

745 
	}
}

748 
	$__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
)

750 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

751 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

752 
rb_node
 *
∑ª¡
 = 
NULL
;

753 
exã¡_°©us
 *
es
;

755 *
p
) {

756 
∑ª¡
 = *
p
;

757 
es
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©us
, 
rb_node
);

759 i‡(
√wes
->
es_lblk
 < 
es
->es_lblk) {

760 i‡(
	`pxt4_es_ˇn_be_mîged
(
√wes
, 
es
)) {

765 
es
->
es_lblk
 = 
√wes
->es_lblk;

766 
es
->
es_Àn
 +
√wes
->es_len;

767 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

768 
	`pxt4_es_is_unwrôãn
(
es
))

769 
	`pxt4_es_°‹e_pblock
(
es
,

770 
√wes
->
es_pblk
);

771 
es
 = 
	`pxt4_es_åy_to_mîge_À·
(
öode
,És);

772 
out
;

774 
p
 = &(*p)->
rb_À·
;

775 } i‡(
√wes
->
es_lblk
 > 
	`pxt4_es_íd
(
es
)) {

776 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
√wes
)) {

777 
es
->
es_Àn
 +
√wes
->es_len;

778 
es
 = 
	`pxt4_es_åy_to_mîge_right
(
öode
,És);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG
();

784  -
EINVAL
;

788 
es
 = 
	`pxt4_es_Æloc_exã¡
(
öode
, 
√wes
->
es_lblk
,Çewes->
es_Àn
,

789 
√wes
->
es_pblk
);

790 i‡(!
es
)

791  -
ENOMEM
;

792 
	`rb_lök_node
(&
es
->
rb_node
, 
∑ª¡
, 
p
);

793 
	`rb_ö£π_cﬁ‹
(&
es
->
rb_node
, &
åì
->
roŸ
);

795 
out
:

796 
åì
->
ˇche_es
 = 
es
;

798 
	}
}

806 
	$pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

807 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

808 
°©us
)

810 
exã¡_°©us
 
√wes
;

811 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

812 
îr
 = 0;

813 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xÅoÉxtent statusÅree of inode %lu\n",

816 
lblk
, 
Àn
, 
pblk
, 
°©us
, 
öode
->
i_öo
);

818 i‡(!
Àn
)

821 
	`BUG_ON
(
íd
 < 
lblk
);

823 i‡((
°©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
°©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`pxt4_w¨nög
(
öode
->
i_sb
, "InsertingÉxtent [%u/%u]ás "

827 " cau£ d©®loss.", 
lblk
, 
Àn
);

828 
	`WARN_ON
(1);

831 
√wes
.
es_lblk
 = 
lblk
;

832 
√wes
.
es_Àn
 = 
Àn
;

833 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

834 
	`åa˚_pxt4_es_ö£π_exã¡
(
öode
, &
√wes
);

836 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

838 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, 
NULL
);

840 i‡(
îr
 != 0)

841 
îr‹
;

842 
ªåy
:

843 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

844 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

845 128, 
	`PXT4_I
(
öode
)))

846 
ªåy
;

847 i‡(
îr
 =-
ENOMEM
 && !
	`pxt4_es_is_dñayed
(&
√wes
))

848 
îr
 = 0;

850 i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

851 (
°©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
°©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__ªvi£_≥ndög
(
öode
, 
lblk
, 
Àn
);

855 
îr‹
:

856 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

858 
	`pxt4_es_¥öt_åì
(
öode
);

860  
îr
;

861 
	}
}

868 
	$pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

869 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

870 
°©us
)

872 
exã¡_°©us
 *
es
;

873 
exã¡_°©us
 
√wes
;

874 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

876 
√wes
.
es_lblk
 = 
lblk
;

877 
√wes
.
es_Àn
 = 
Àn
;

878 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

879 
	`åa˚_pxt4_es_ˇche_exã¡
(
öode
, &
√wes
);

881 i‡(!
Àn
)

884 
	`BUG_ON
(
íd
 < 
lblk
);

886 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

888 
es
 = 
	`__es_åì_£¨ch
(&
	`PXT4_I
(
öode
)->
i_es_åì
.
roŸ
, 
lblk
);

889 i‡(!
es
 ||És->
es_lblk
 > 
íd
)

890 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

891 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

892 
	}
}

901 
	$pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

902 
pxt4_lblk_t
 *
√xt_lblk
,

903 
exã¡_°©us
 *
es
)

905 
pxt4_es_åì
 *
åì
;

906 
pxt4_es_°©s
 *
°©s
;

907 
exã¡_°©us
 *
es1
 = 
NULL
;

908 
rb_node
 *
node
;

909 
found
 = 0;

911 
	`åa˚_pxt4_es_lookup_exã¡_íãr
(
öode
, 
lblk
);

912 
	`es_debug
("looku∞exã¡ i¿block %u\n", 
lblk
);

914 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

915 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

918 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

919 i‡(
åì
->
ˇche_es
) {

920 
es1
 = 
åì
->
ˇche_es
;

921 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

922 
	`es_debug
("%u cached by [%u/%u)\n",

923 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
);

924 
found
 = 1;

925 
out
;

929 
node
 = 
åì
->
roŸ
.
rb_node
;

930 
node
) {

931 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

932 i‡(
lblk
 < 
es1
->
es_lblk
)

933 
node
 =Çode->
rb_À·
;

934 i‡(
lblk
 > 
	`pxt4_es_íd
(
es1
))

935 
node
 =Çode->
rb_right
;

937 
found
 = 1;

942 
out
:

943 
°©s
 = &
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
;

944 i‡(
found
) {

945 
	`BUG_ON
(!
es1
);

946 
es
->
es_lblk
 = 
es1
->es_lblk;

947 
es
->
es_Àn
 = 
es1
->es_len;

948 
es
->
es_pblk
 = 
es1
->es_pblk;

949 i‡(!
	`pxt4_es_is_ª„ªn˚d
(
es1
))

950 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

951 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_hôs
);

952 i‡(
√xt_lblk
) {

953 
node
 = 
	`rb_√xt
(&
es1
->
rb_node
);

954 i‡(
node
) {

955 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

956 
rb_node
);

957 *
√xt_lblk
 = 
es1
->
es_lblk
;

959 *
√xt_lblk
 = 0;

962 
	`≥r˝u_cou¡î_öc
(&
°©s
->
es_°©s_ˇche_mis£s
);

965 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

967 
	`åa˚_pxt4_es_lookup_exã¡_exô
(
öode
, 
es
, 
found
);

968  
found
;

969 
	}
}

971 
	srsvd_cou¡
 {

972 
	mndñ⁄ly
;

973 
boﬁ
 
	mfú°_do_lblk_found
;

974 
pxt4_lblk_t
 
	mfú°_do_lblk
;

975 
pxt4_lblk_t
 
	mœ°_do_lblk
;

976 
exã¡_°©us
 *
	mÀ·_es
;

977 
boﬁ
 
	m∑πül
;

978 
pxt4_lblk_t
 
	ml˛u
;

992 
	$öô_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

993 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

995 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

996 
rb_node
 *
node
;

998 
rc
->
ndñ⁄ly
 = 0;

1006 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1007 
rc
->
fú°_do_lblk_found
 = 
Ál£
;

1008 i‡(
lblk
 > 
es
->
es_lblk
) {

1009 
rc
->
À·_es
 = 
es
;

1011 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1012 
rc
->
À·_es
 = 
node
 ? 
	`rb_íåy
(node,

1013 
exã¡_°©us
,

1014 
rb_node
Ë: 
NULL
;

1016 
rc
->
∑πül
 = 
Ál£
;

1018 
	}
}

1034 
	$cou¡_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
Àn
,

1035 
exã¡_°©us
 *
es
, 
rsvd_cou¡
 *
rc
)

1037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1038 
pxt4_lblk_t
 
i
, 
íd
, 
n˛u
;

1040 i‡(!
	`pxt4_es_is_dñ⁄ly
(
es
))

1043 
	`WARN_ON
(
Àn
 <= 0);

1045 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1046 
rc
->
ndñ⁄ly
 +(Ë
Àn
;

1052 
i
 = (
lblk
 < 
es
->
es_lblk
) ?És->es_lblk :Üblk;

1053 
íd
 = 
lblk
 + (
pxt4_lblk_t
Ë
Àn
 - 1;

1054 
íd
 = (íd > 
	`pxt4_es_íd
(
es
)) ?Öxt4_es_end(es) :Énd;

1057 i‡(
rc
->
fú°_do_lblk_found
 =
Ál£
) {

1058 
rc
->
fú°_do_lblk
 = 
i
;

1059 
rc
->
fú°_do_lblk_found
 = 
åue
;

1063 
rc
->
œ°_do_lblk
 = 
íd
;

1069 i‡(
rc
->
∑πül
 && (rc->
l˛u
 !
	`PXT4_B2C
(
sbi
, 
i
))) {

1070 
rc
->
ndñ⁄ly
++;

1071 
rc
->
∑πül
 = 
Ál£
;

1078 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
i
) != 0) {

1079 i‡(
íd
 >
	`PXT4_LBLK_CFILL
(
sbi
, 
i
)) {

1080 
rc
->
ndñ⁄ly
++;

1081 
rc
->
∑πül
 = 
Ál£
;

1082 
i
 = 
	`PXT4_LBLK_CFILL
(
sbi
, i) + 1;

1090 i‡((
i
 + 
sbi
->
s_˛u°î_øtio
 - 1Ë<
íd
) {

1091 
n˛u
 = (
íd
 - 
i
 + 1Ë>> 
sbi
->
s_˛u°î_bôs
;

1092 
rc
->
ndñ⁄ly
 +
n˛u
;

1093 
i
 +
n˛u
 << 
sbi
->
s_˛u°î_bôs
;

1100 i‡(!
rc
->
∑πül
 && 
i
 <
íd
) {

1101 
rc
->
∑πül
 = 
åue
;

1102 
rc
->
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
i
);

1104 
	}
}

1116 
≥ndög_ª£rv©i⁄
 *
	$__¥_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

1117 
pxt4_lblk_t
 
l˛u
)

1119 
rb_node
 *
node
 = 
roŸ
->rb_node;

1120 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1122 
node
) {

1123 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1124 i‡(
l˛u
 < 
¥
->lclu)

1125 
node
 =Çode->
rb_À·
;

1126 i‡(
l˛u
 > 
¥
->lclu)

1127 
node
 =Çode->
rb_right
;

1129  
¥
;

1131 i‡(
¥
 && 
l˛u
 <Ör->lclu)

1132  
¥
;

1133 i‡(
¥
 && 
l˛u
 >Ör->lclu) {

1134 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1135  
node
 ? 
	`rb_íåy
“ode, 
≥ndög_ª£rv©i⁄
,

1136 
rb_node
Ë: 
NULL
;

1138  
NULL
;

1139 
	}
}

1157 
	$gë_rsvd
(
öode
 *öode, 
pxt4_lblk_t
 
íd
,

1158 
exã¡_°©us
 *
right_es
,

1159 
rsvd_cou¡
 *
rc
)

1161 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1162 
≥ndög_ª£rv©i⁄
 *
¥
;

1163 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1164 
rb_node
 *
node
;

1165 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

1166 
boﬁ
 
À·_dñ⁄ly
, 
right_dñ⁄ly
, 
cou¡_≥ndög
;

1167 
exã¡_°©us
 *
es
;

1169 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

1171 i‡(
rc
->
∑πül
)

1172 
rc
->
ndñ⁄ly
++;

1174 i‡(
rc
->
ndñ⁄ly
 == 0)

1177 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
fú°_do_lblk
);

1178 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
rc
->
œ°_do_lblk
);

1185 
À·_dñ⁄ly
 = 
right_dñ⁄ly
 = 
Ál£
;

1187 
es
 = 
rc
->
À·_es
;

1188 
es
 && 
	`pxt4_es_íd
(es) >=

1189 
	`PXT4_LBLK_CMASK
(
sbi
, 
rc
->
fú°_do_lblk
)) {

1190 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1191 
rc
->
ndñ⁄ly
--;

1192 
À·_dñ⁄ly
 = 
åue
;

1195 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

1196 i‡(!
node
)

1198 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1200 i‡(
right_es
 && (!
À·_dñ⁄ly
 || 
fú°_l˛u
 !
œ°_l˛u
)) {

1201 i‡(
íd
 < 
	`pxt4_es_íd
(
right_es
)) {

1202 
es
 = 
right_es
;

1204 
node
 = 
	`rb_√xt
(&
right_es
->
rb_node
);

1205 
es
 = 
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
,

1206 
rb_node
Ë: 
NULL
;

1208 
es
 &&És->
es_lblk
 <=

1209 
	`PXT4_LBLK_CFILL
(
sbi
, 
rc
->
œ°_do_lblk
)) {

1210 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1211 
rc
->
ndñ⁄ly
--;

1212 
right_dñ⁄ly
 = 
åue
;

1215 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1216 i‡(!
node
)

1218 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
,

1219 
rb_node
);

1232 i‡(
fú°_l˛u
 =
œ°_l˛u
) {

1233 i‡(
À·_dñ⁄ly
 | 
right_dñ⁄ly
)

1234 
cou¡_≥ndög
 = 
Ál£
;

1236 
cou¡_≥ndög
 = 
åue
;

1238 i‡(
À·_dñ⁄ly
)

1239 
fú°_l˛u
++;

1240 i‡(
right_dñ⁄ly
)

1241 
œ°_l˛u
--;

1242 i‡(
fú°_l˛u
 <
œ°_l˛u
)

1243 
cou¡_≥ndög
 = 
åue
;

1245 
cou¡_≥ndög
 = 
Ál£
;

1254 i‡(
cou¡_≥ndög
) {

1255 
¥
 = 
	`__¥_åì_£¨ch
(&
åì
->
roŸ
, 
fú°_l˛u
);

1256 
¥
 &&Ör->
l˛u
 <
œ°_l˛u
) {

1257 
rc
->
ndñ⁄ly
--;

1258 
node
 = 
	`rb_√xt
(&
¥
->
rb_node
);

1259 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1260 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1261 i‡(!
node
)

1263 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
,

1264 
rb_node
);

1268  
rc
->
ndñ⁄ly
;

1269 
	}
}

1285 
	$__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1286 
pxt4_lblk_t
 
íd
, *
ª£rved
)

1288 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1289 
rb_node
 *
node
;

1290 
exã¡_°©us
 *
es
;

1291 
exã¡_°©us
 
‹ig_es
;

1292 
pxt4_lblk_t
 
Àn1
, 
Àn2
;

1293 
pxt4_fsblk_t
 
block
;

1294 
îr
;

1295 
boﬁ
 
cou¡_ª£rved
 = 
åue
;

1296 
rsvd_cou¡
 
rc
;

1298 i‡(
ª£rved
 =
NULL
 || !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

1299 
cou¡_ª£rved
 = 
Ál£
;

1300 
ªåy
:

1301 
îr
 = 0;

1303 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

1304 i‡(!
es
)

1305 
out
;

1306 i‡(
es
->
es_lblk
 > 
íd
)

1307 
out
;

1310 
åì
->
ˇche_es
 = 
NULL
;

1311 i‡(
cou¡_ª£rved
)

1312 
	`öô_rsvd
(
öode
, 
lblk
, 
es
, &
rc
);

1314 
‹ig_es
.
es_lblk
 = 
es
->es_lblk;

1315 
‹ig_es
.
es_Àn
 = 
es
->es_len;

1316 
‹ig_es
.
es_pblk
 = 
es
->es_pblk;

1318 
Àn1
 = 
lblk
 > 
es
->
es_lblk
 ?Üblk -És->es_lblk : 0;

1319 
Àn2
 = 
	`pxt4_es_íd
(
es
Ë> 
íd
 ?Öxt4_es_end(es) -Énd : 0;

1320 i‡(
Àn1
 > 0)

1321 
es
->
es_Àn
 = 
Àn1
;

1322 i‡(
Àn2
 > 0) {

1323 i‡(
Àn1
 > 0) {

1324 
exã¡_°©us
 
√wes
;

1326 
√wes
.
es_lblk
 = 
íd
 + 1;

1327 
√wes
.
es_Àn
 = 
Àn2
;

1328 
block
 = 0x7FDEADBEEFULL;

1329 i‡(
	`pxt4_es_is_wrôãn
(&
‹ig_es
) ||

1330 
	`pxt4_es_is_unwrôãn
(&
‹ig_es
))

1331 
block
 = 
	`pxt4_es_pblock
(&
‹ig_es
) +

1332 
‹ig_es
.
es_Àn
 - 
Àn2
;

1333 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
block
,

1334 
	`pxt4_es_°©us
(&
‹ig_es
));

1335 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1336 i‡(
îr
) {

1337 
es
->
es_lblk
 = 
‹ig_es
.es_lblk;

1338 
es
->
es_Àn
 = 
‹ig_es
.es_len;

1339 i‡((
îr
 =-
ENOMEM
) &&

1340 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1341 128, 
	`PXT4_I
(
öode
)))

1342 
ªåy
;

1343 
out
;

1346 
es
->
es_lblk
 = 
íd
 + 1;

1347 
es
->
es_Àn
 = 
Àn2
;

1348 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

1349 
	`pxt4_es_is_unwrôãn
(
es
)) {

1350 
block
 = 
‹ig_es
.
es_pblk
 + orig_es.
es_Àn
 - 
Àn2
;

1351 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1354 i‡(
cou¡_ª£rved
)

1355 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
 - 
Àn2
,

1356 &
‹ig_es
, &
rc
);

1357 
out
;

1360 i‡(
Àn1
 > 0) {

1361 i‡(
cou¡_ª£rved
)

1362 
	`cou¡_rsvd
(
öode
, 
lblk
, 
‹ig_es
.
es_Àn
 - 
Àn1
,

1363 &
‹ig_es
, &
rc
);

1364 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1365 i‡(
node
)

1366 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1368 
es
 = 
NULL
;

1371 
es
 && 
	`pxt4_es_íd
”sË<
íd
) {

1372 i‡(
cou¡_ª£rved
)

1373 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
,És->
es_Àn
,És, &
rc
);

1374 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1375 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1376 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1377 i‡(!
node
) {

1378 
es
 = 
NULL
;

1381 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1384 i‡(
es
 &&És->
es_lblk
 < 
íd
 + 1) {

1385 
pxt4_lblk_t
 
‹ig_Àn
 = 
es
->
es_Àn
;

1387 
Àn1
 = 
	`pxt4_es_íd
(
es
Ë- 
íd
;

1388 i‡(
cou¡_ª£rved
)

1389 
	`cou¡_rsvd
(
öode
, 
es
->
es_lblk
, 
‹ig_Àn
 - 
Àn1
,

1390 
es
, &
rc
);

1391 
es
->
es_lblk
 = 
íd
 + 1;

1392 
es
->
es_Àn
 = 
Àn1
;

1393 i‡(
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es)) {

1394 
block
 = 
es
->
es_pblk
 + 
‹ig_Àn
 - 
Àn1
;

1395 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1399 i‡(
cou¡_ª£rved
)

1400 *
ª£rved
 = 
	`gë_rsvd
(
öode
, 
íd
, 
es
, &
rc
);

1401 
out
:

1402  
îr
;

1403 
	}
}

1415 
	$pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1416 
pxt4_lblk_t
 
Àn
)

1418 
pxt4_lblk_t
 
íd
;

1419 
îr
 = 0;

1420 
ª£rved
 = 0;

1422 
	`åa˚_pxt4_es_ªmove_exã¡
(
öode
, 
lblk
, 
Àn
);

1423 
	`es_debug
("remove [%u/%u) fromÉxtent statusÅree of inode %lu\n",

1424 
lblk
, 
Àn
, 
öode
->
i_öo
);

1426 i‡(!
Àn
)

1427  
îr
;

1429 
íd
 = 
lblk
 + 
Àn
 - 1;

1430 
	`BUG_ON
(
íd
 < 
lblk
);

1437 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1438 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
, &
ª£rved
);

1439 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1440 
	`pxt4_es_¥öt_åì
(
öode
);

1441 
	`pxt4_da_ªÀa£_•a˚
(
öode
, 
ª£rved
);

1442  
îr
;

1443 
	}
}

1445 
	$__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

1446 
pxt4_öode_öfo
 *
locked_ei
)

1448 
pxt4_öode_öfo
 *
ei
;

1449 
pxt4_es_°©s
 *
es_°©s
;

1450 
ktime_t
 
°¨t_time
;

1451 
u64
 
sˇn_time
;

1452 
ƒ_to_wÆk
;

1453 
ƒ_shrunk
 = 0;

1454 
ªåõd
 = 0, 
ƒ_skù≥d
 = 0;

1456 
es_°©s
 = &
sbi
->
s_es_°©s
;

1457 
°¨t_time
 = 
	`ktime_gë
();

1459 
ªåy
:

1460 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1461 
ƒ_to_wÆk
 = 
sbi
->
s_es_ƒ_öode
;

1462 
ƒ_to_wÆk
-- > 0) {

1463 i‡(
	`li°_em±y
(&
sbi
->
s_es_li°
)) {

1464 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1465 
out
;

1467 
ei
 = 
	`li°_fú°_íåy
(&
sbi
->
s_es_li°
, 
pxt4_öode_öfo
,

1468 
i_es_li°
);

1470 
	`li°_move_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

1476 i‡(!
ªåõd
 && 
	`pxt4_ã°_öode_°©e
(&
ei
->
vfs_öode
,

1477 
PXT4_STATE_EXT_PRECACHED
)) {

1478 
ƒ_skù≥d
++;

1482 i‡(
ei
 =
locked_ei
 || !
	`wrôe_åylock
(&ei->
i_es_lock
)) {

1483 
ƒ_skù≥d
++;

1490 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1492 
ƒ_shrunk
 +
	`es_ª˛aim_exã¡s
(
ei
, &
ƒ_to_sˇn
);

1493 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1495 i‡(
ƒ_to_sˇn
 <= 0)

1496 
out
;

1497 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1499 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1505 i‡((
ƒ_shrunk
 =0Ë&& 
ƒ_skù≥d
 && !
ªåõd
) {

1506 
ªåõd
++;

1507 
ªåy
;

1510 i‡(
locked_ei
 && 
ƒ_shrunk
 == 0)

1511 
ƒ_shrunk
 = 
	`es_ª˛aim_exã¡s
(
locked_ei
, &
ƒ_to_sˇn
);

1513 
out
:

1514 
sˇn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1515 i‡(
	`likñy
(
es_°©s
->
es_°©s_sˇn_time
))

1516 
es_°©s
->
es_°©s_sˇn_time
 = (
sˇn_time
 +

1517 
es_°©s
->
es_°©s_sˇn_time
*3) / 4;

1519 
es_°©s
->
es_°©s_sˇn_time
 = 
sˇn_time
;

1520 i‡(
sˇn_time
 > 
es_°©s
->
es_°©s_max_sˇn_time
)

1521 
es_°©s
->
es_°©s_max_sˇn_time
 = 
sˇn_time
;

1522 i‡(
	`likñy
(
es_°©s
->
es_°©s_shrunk
))

1523 
es_°©s
->
es_°©s_shrunk
 = (
ƒ_shrunk
 +

1524 
es_°©s
->
es_°©s_shrunk
*3) / 4;

1526 
es_°©s
->
es_°©s_shrunk
 = 
ƒ_shrunk
;

1528 
	`åa˚_pxt4_es_shrök
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
sˇn_time
,

1529 
ƒ_skù≥d
, 
ªåõd
);

1530  
ƒ_shrunk
;

1531 
	}
}

1533 
	$pxt4_es_cou¡
(
shrökî
 *
shrök
,

1534 
shrök_c⁄åﬁ
 *
sc
)

1536 
ƒ
;

1537 
pxt4_sb_öfo
 *
sbi
;

1539 
sbi
 = 
	`c⁄èöî_of
(
shrök
, 
pxt4_sb_öfo
, 
s_es_shrökî
);

1540 
ƒ
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1541 
	`åa˚_pxt4_es_shrök_cou¡
(
sbi
->
s_sb
, 
sc
->
ƒ_to_sˇn
, 
ƒ
);

1542  
ƒ
;

1543 
	}
}

1545 
	$pxt4_es_sˇn
(
shrökî
 *
shrök
,

1546 
shrök_c⁄åﬁ
 *
sc
)

1548 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
shrök
,

1549 
pxt4_sb_öfo
, 
s_es_shrökî
);

1550 
ƒ_to_sˇn
 = 
sc
->nr_to_scan;

1551 
ªt
, 
ƒ_shrunk
;

1553 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1554 
	`åa˚_pxt4_es_shrök_sˇn_íãr
(
sbi
->
s_sb
, 
ƒ_to_sˇn
, 
ªt
);

1556 i‡(!
ƒ_to_sˇn
)

1557  
ªt
;

1559 
ƒ_shrunk
 = 
	`__es_shrök
(
sbi
, 
ƒ_to_sˇn
, 
NULL
);

1561 
	`åa˚_pxt4_es_shrök_sˇn_exô
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
ªt
);

1562  
ƒ_shrunk
;

1563 
	}
}

1565 
	$pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
)

1567 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
((
su≥r_block
 *Ë
£q
->
¥iv©e
);

1568 
pxt4_es_°©s
 *
es_°©s
 = &
sbi
->
s_es_°©s
;

1569 
pxt4_öode_öfo
 *
ei
, *
max
 = 
NULL
;

1570 
öode_˙t
 = 0;

1572 i‡(
v
 !
SEQ_START_TOKEN
)

1576 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1577 
	`li°_f‹_óch_íåy
(
ei
, &
sbi
->
s_es_li°
, 
i_es_li°
) {

1578 
öode_˙t
++;

1579 i‡(
max
 && max->
i_es_Æl_ƒ
 < 
ei
->i_es_all_nr)

1580 
max
 = 
ei
;

1581 i‡(!
max
)

1582 
max
 = 
ei
;

1584 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1586 
	`£q_¥ötf
(
£q
, "stats:\n %lld objects\n %lldÑeclaimable objects\n",

1587 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_Æl_˙t
),

1588 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_shk_˙t
));

1589 
	`£q_¥ötf
(
£q
, " %lld/%lld cache hits/misses\n",

1590 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_hôs
),

1591 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_ˇche_mis£s
));

1592 i‡(
öode_˙t
)

1593 
	`£q_¥ötf
(
£q
, " %d inode†⁄Üi°\n", 
öode_˙t
);

1595 
	`£q_¥ötf
(
£q
, "average:\n %llu us scanÅime\n",

1596 
	`div_u64
(
es_°©s
->
es_°©s_sˇn_time
, 1000));

1597 
	`£q_¥ötf
(
£q
, " %lu shrunk obje˘s\n", 
es_°©s
->
es_°©s_shrunk
);

1598 i‡(
öode_˙t
)

1599 
	`£q_¥ötf
(
£q
,

1602 
max
->
vfs_öode
.
i_öo
, max->
i_es_Æl_ƒ
, max->
i_es_shk_ƒ
,

1603 
	`div_u64
(
es_°©s
->
es_°©s_max_sˇn_time
, 1000));

1606 
	}
}

1608 
	$pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1610 
îr
;

1613 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1614 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li°
);

1615 
sbi
->
s_es_ƒ_öode
 = 0;

1616 
	`•ö_lock_öô
(&
sbi
->
s_es_lock
);

1617 
sbi
->
s_es_°©s
.
es_°©s_shrunk
 = 0;

1618 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
, 0,

1619 
GFP_KERNEL
);

1620 i‡(
îr
)

1621  
îr
;

1622 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
, 0,

1623 
GFP_KERNEL
);

1624 i‡(
îr
)

1625 
îr1
;

1626 
sbi
->
s_es_°©s
.
es_°©s_sˇn_time
 = 0;

1627 
sbi
->
s_es_°©s
.
es_°©s_max_sˇn_time
 = 0;

1628 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
, 0, 
GFP_KERNEL
);

1629 i‡(
îr
)

1630 
îr2
;

1631 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
, 0, 
GFP_KERNEL
);

1632 i‡(
îr
)

1633 
îr3
;

1635 
sbi
->
s_es_shrökî
.
sˇn_obje˘s
 = 
pxt4_es_sˇn
;

1636 
sbi
->
s_es_shrökî
.
cou¡_obje˘s
 = 
pxt4_es_cou¡
;

1637 
sbi
->
s_es_shrökî
.
£eks
 = 
DEFAULT_SEEKS
;

1638 
îr
 = 
	`ªgi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1639 i‡(
îr
)

1640 
îr4
;

1643 
îr4
:

1644 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1645 
îr3
:

1646 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1647 
îr2
:

1648 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1649 
îr1
:

1650 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1651  
îr
;

1652 
	}
}

1654 
	$pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1656 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
);

1657 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
);

1658 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1659 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1660 
	`uƒegi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1661 
	}
}

1671 
	$es_do_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, 
pxt4_lblk_t
 
íd
,

1672 *
ƒ_to_sˇn
, *
ƒ_shrunk
)

1674 
öode
 *öodê&
ei
->
vfs_öode
;

1675 
pxt4_es_åì
 *
åì
 = &
ei
->
i_es_åì
;

1676 
exã¡_°©us
 *
es
;

1677 
rb_node
 *
node
;

1679 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
ei
->
i_es_shrök_lblk
);

1680 i‡(!
es
)

1681 
out_wøp
;

1683 *
ƒ_to_sˇn
 > 0) {

1684 i‡(
es
->
es_lblk
 > 
íd
) {

1685 
ei
->
i_es_shrök_lblk
 = 
íd
 + 1;

1689 (*
ƒ_to_sˇn
)--;

1690 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1695 i‡(
	`pxt4_es_is_dñayed
(
es
))

1696 
√xt
;

1697 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
)) {

1698 
	`pxt4_es_˛ór_ª„ªn˚d
(
es
);

1699 
√xt
;

1702 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1703 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1704 (*
ƒ_shrunk
)++;

1705 
√xt
:

1706 i‡(!
node
)

1707 
out_wøp
;

1708 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1710 
ei
->
i_es_shrök_lblk
 = 
es
->
es_lblk
;

1712 
out_wøp
:

1713 
ei
->
i_es_shrök_lblk
 = 0;

1715 
	}
}

1717 
	$es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
)

1719 
öode
 *öodê&
ei
->
vfs_öode
;

1720 
ƒ_shrunk
 = 0;

1721 
pxt4_lblk_t
 
°¨t
 = 
ei
->
i_es_shrök_lblk
;

1722 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1723 
DEFAULT_RATELIMIT_BURST
);

1725 i‡(
ei
->
i_es_shk_ƒ
 == 0)

1728 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
) &&

1729 
	`__øãlimô
(&
_rs
))

1730 
	`pxt4_w¨nög
(
öode
->
i_sb
, "forced shrink ofÖrecachedÉxtents");

1732 i‡(!
	`es_do_ª˛aim_exã¡s
(
ei
, 
EXT_MAX_BLOCKS
, 
ƒ_to_sˇn
, &
ƒ_shrunk
) &&

1733 
°¨t
 != 0)

1734 
	`es_do_ª˛aim_exã¡s
(
ei
, 
°¨t
 - 1, 
ƒ_to_sˇn
, &
ƒ_shrunk
);

1736 
ei
->
i_es_åì
.
ˇche_es
 = 
NULL
;

1737  
ƒ_shrunk
;

1738 
	}
}

1745 
	$pxt4_˛ór_öode_es
(
öode
 *inode)

1747 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1748 
exã¡_°©us
 *
es
;

1749 
pxt4_es_åì
 *
åì
;

1750 
rb_node
 *
node
;

1752 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1753 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1754 
åì
->
ˇche_es
 = 
NULL
;

1755 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1756 
node
) {

1757 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1758 
node
 = 
	`rb_√xt
(node);

1759 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

1760 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1761 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1764 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

1765 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1766 
	}
}

1768 #ifde‡
ES_DEBUG__


1769 
	$pxt4_¥öt_≥ndög_åì
(
öode
 *inode)

1771 
pxt4_≥ndög_åì
 *
åì
;

1772 
rb_node
 *
node
;

1773 
≥ndög_ª£rv©i⁄
 *
¥
;

1775 
	`¥ötk
(
KERN_DEBUG
 "≥ndögÑe£rv©i⁄†f‹ inodê%lu:", 
öode
->
i_öo
);

1776 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1777 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1778 
node
) {

1779 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1780 
	`¥ötk
(
KERN_DEBUG
 " %u", 
¥
->
l˛u
);

1781 
node
 = 
	`rb_√xt
(node);

1783 
	`¥ötk
(
KERN_DEBUG
 "\n");

1784 
	}
}

1786 
	#pxt4_¥öt_≥ndög_åì
(
öode
)

	)

1789 
__öô
 
	$pxt4_öô_≥ndög
()

1791 
pxt4_≥ndög_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_pending_reservation",

1792 (
≥ndög_ª£rv©i⁄
),

1793 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1794 i‡(
pxt4_≥ndög_ˇchï
 =
NULL
)

1795  -
ENOMEM
;

1797 
	}
}

1799 
	$pxt4_exô_≥ndög
()

1801 
	`kmem_ˇche_de°roy
(
pxt4_≥ndög_ˇchï
);

1802 
	}
}

1804 
	$pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
)

1806 
åì
->
roŸ
 = 
RB_ROOT
;

1807 
	}
}

1818 
≥ndög_ª£rv©i⁄
 *
	$__gë_≥ndög
(
öode
 *inode,

1819 
pxt4_lblk_t
 
l˛u
)

1821 
pxt4_≥ndög_åì
 *
åì
;

1822 
rb_node
 *
node
;

1823 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1825 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1826 
node
 = (&
åì
->
roŸ
)->
rb_node
;

1828 
node
) {

1829 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1830 i‡(
l˛u
 < 
¥
->lclu)

1831 
node
 =Çode->
rb_À·
;

1832 i‡(
l˛u
 > 
¥
->lclu)

1833 
node
 =Çode->
rb_right
;

1834 i‡(
l˛u
 =
¥
->lclu)

1835  
¥
;

1837  
NULL
;

1838 
	}
}

1850 
	$__ö£π_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1852 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1853 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1854 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

1855 
rb_node
 *
∑ª¡
 = 
NULL
;

1856 
≥ndög_ª£rv©i⁄
 *
¥
;

1857 
pxt4_lblk_t
 
l˛u
;

1858 
ªt
 = 0;

1860 
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
);

1862 *
p
) {

1863 
∑ª¡
 = *
p
;

1864 
¥
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1866 i‡(
l˛u
 < 
¥
->lclu) {

1867 
p
 = &(*p)->
rb_À·
;

1868 } i‡(
l˛u
 > 
¥
->lclu) {

1869 
p
 = &(*p)->
rb_right
;

1872 
out
;

1876 
¥
 = 
	`kmem_ˇche_Æloc
(
pxt4_≥ndög_ˇchï
, 
GFP_ATOMIC
);

1877 i‡(
¥
 =
NULL
) {

1878 
ªt
 = -
ENOMEM
;

1879 
out
;

1881 
¥
->
l˛u
 =Üclu;

1883 
	`rb_lök_node
(&
¥
->
rb_node
, 
∑ª¡
, 
p
);

1884 
	`rb_ö£π_cﬁ‹
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1886 
out
:

1887  
ªt
;

1888 
	}
}

1899 
	$__ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1901 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1902 
≥ndög_ª£rv©i⁄
 *
¥
;

1903 
pxt4_≥ndög_åì
 *
åì
;

1905 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
));

1906 i‡(
¥
 !
NULL
) {

1907 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1908 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1909 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1911 
	}
}

1922 
	$pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1924 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1926 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1927 
	`__ªmove_≥ndög
(
öode
, 
lblk
);

1928 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1929 
	}
}

1941 
boﬁ
 
	$pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1943 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1944 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1945 
boﬁ
 
ªt
;

1947 
	`ªad_lock
(&
ei
->
i_es_lock
);

1948 
ªt
 = (
boﬁ
)(
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
)Ë!
NULL
);

1949 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1951  
ªt
;

1952 
	}
}

1966 
	$pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1967 
boﬁ
 
Æloˇãd
)

1969 
exã¡_°©us
 
√wes
;

1970 
îr
 = 0;

1972 
	`es_debug
("add [%u/1) delayedÅoÉxtent statusÅree of inode %lu\n",

1973 
lblk
, 
öode
->
i_öo
);

1975 
√wes
.
es_lblk
 = 
lblk
;

1976 
√wes
.
es_Àn
 = 1;

1977 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, ~0, 
EXTENT_STATUS_DELAYED
);

1978 
	`åa˚_pxt4_es_ö£π_dñayed_block
(
öode
, &
√wes
, 
Æloˇãd
);

1980 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

1982 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1984 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
,Üblk, 
NULL
);

1985 i‡(
îr
 != 0)

1986 
îr‹
;

1987 
ªåy
:

1988 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1989 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1990 128, 
	`PXT4_I
(
öode
)))

1991 
ªåy
;

1992 i‡(
îr
 != 0)

1993 
îr‹
;

1995 i‡(
Æloˇãd
)

1996 
	`__ö£π_≥ndög
(
öode
, 
lblk
);

1998 
îr‹
:

1999 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

2001 
	`pxt4_es_¥öt_åì
(
öode
);

2002 
	`pxt4_¥öt_≥ndög_åì
(
öode
);

2004  
îr
;

2005 
	}
}

2020 
	$__es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2021 
pxt4_lblk_t
 
íd
)

2023 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

2024 
exã¡_°©us
 *
es
;

2025 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2026 
rb_node
 *
node
;

2027 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

2028 
œ°_cou¡ed_l˛u
;

2029 
n
 = 0;

2032 
œ°_cou¡ed_l˛u
 = ~0ULL;

2034 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
°¨t
);

2036 
es
 && (es->
es_lblk
 <
íd
)) {

2037 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

2038 i‡(
es
->
es_lblk
 <
°¨t
)

2039 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
°¨t
);

2041 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
es
->
es_lblk
);

2043 i‡(
	`pxt4_es_íd
(
es
Ë>
íd
)

2044 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
íd
);

2046 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_es_íd
(
es
));

2048 i‡(
fú°_l˛u
 =
œ°_cou¡ed_l˛u
)

2049 
n
 +
œ°_l˛u
 - 
fú°_l˛u
;

2051 
n
 +
œ°_l˛u
 - 
fú°_l˛u
 + 1;

2052 
œ°_cou¡ed_l˛u
 = 
œ°_l˛u
;

2054 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

2055 i‡(!
node
)

2057 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

2060  
n
;

2061 
	}
}

2073 
	$pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2074 
pxt4_lblk_t
 
Àn
)

2076 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2077 
pxt4_lblk_t
 
íd
;

2078 
n
;

2080 i‡(
Àn
 == 0)

2083 
íd
 = 
lblk
 + 
Àn
 - 1;

2084 
	`WARN_ON
(
íd
 < 
lblk
);

2086 
	`ªad_lock
(&
ei
->
i_es_lock
);

2088 
n
 = 
	`__es_dñayed_˛u
(
öode
, 
lblk
, 
íd
);

2090 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

2092  
n
;

2093 
	}
}

2110 
	$__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2111 
pxt4_lblk_t
 
Àn
)

2113 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2114 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

2115 
pxt4_lblk_t
 
fú°
, 
œ°
;

2116 
boﬁ
 
f_dñ
 = 
Ál£
, 
l_dñ
 = false;

2118 i‡(
Àn
 == 0)

2134 i‡(
	`PXT4_B2C
(
sbi
, 
lblk
Ë=PXT4_B2C(sbi, 
íd
)) {

2135 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2136 i‡(
fú°
 !
lblk
)

2137 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2138 
fú°
, 
lblk
 - 1);

2139 i‡(
f_dñ
) {

2140 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2142 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
) +

2143 
sbi
->
s_˛u°î_øtio
 - 1;

2144 i‡(
œ°
 !
íd
)

2145 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
,

2146 &
pxt4_es_is_dñ⁄ly
,

2147 
íd
 + 1, 
œ°
);

2148 i‡(
l_dñ
)

2149 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2151 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2154 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

2155 i‡(
fú°
 !
lblk
)

2156 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2157 
fú°
, 
lblk
 - 1);

2158 i‡(
f_dñ
)

2159 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

2161 
	`__ªmove_≥ndög
(
öode
, 
fú°
);

2163 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
Ë+ sbi->
s_˛u°î_øtio
 - 1;

2164 i‡(
œ°
 !
íd
)

2165 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

2166 
íd
 + 1, 
œ°
);

2167 i‡(
l_dñ
)

2168 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

2170 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

2172 
	}
}

	@extents_status.h

12 #i‚de‡
_PXT4_EXTENTS_STATUS_H


13 
	#_PXT4_EXTENTS_STATUS_H


	)

18 #ifde‡
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
pxt4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
pxt4_fsblk_t
)0Ë<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
pxt4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
Ë<< 
ES_SHIFT
)

	)

56 
	gpxt4_sb_öfo
;

57 
	gpxt4_exã¡
;

59 
	sexã¡_°©us
 {

60 
rb_node
 
	mrb_node
;

61 
pxt4_lblk_t
 
	mes_lblk
;

62 
pxt4_lblk_t
 
	mes_Àn
;

63 
pxt4_fsblk_t
 
	mes_pblk
;

66 
	spxt4_es_åì
 {

67 
rb_roŸ
 
	mroŸ
;

68 
exã¡_°©us
 *
	mˇche_es
;

71 
	spxt4_es_°©s
 {

72 
	mes_°©s_shrunk
;

73 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_hôs
;

74 
≥r˝u_cou¡î
 
	mes_°©s_ˇche_mis£s
;

75 
u64
 
	mes_°©s_sˇn_time
;

76 
u64
 
	mes_°©s_max_sˇn_time
;

77 
≥r˝u_cou¡î
 
	mes_°©s_Æl_˙t
;

78 
≥r˝u_cou¡î
 
	mes_°©s_shk_˙t
;

117 
	s≥ndög_ª£rv©i⁄
 {

118 
rb_node
 
	mrb_node
;

119 
pxt4_lblk_t
 
	ml˛u
;

122 
	spxt4_≥ndög_åì
 {

123 
rb_roŸ
 
	mroŸ
;

126 
__öô
 
pxt4_öô_es
();

127 
pxt4_exô_es
();

128 
pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
);

130 
pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

131 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

132 
°©us
);

133 
pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

134 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

135 
°©us
);

136 
pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

137 
pxt4_lblk_t
 
Àn
);

138 
pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

139 (*
m©ch_‚
)(
exã¡_°©us
 *
es
),

140 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

141 
exã¡_°©us
 *
es
);

142 
	`pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

143 
pxt4_lblk_t
 *
√xt_lblk
,

144 
exã¡_°©us
 *
es
);

145 
boﬁ
 
	`pxt4_es_sˇn_ønge
(
öode
 *inode,

146 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

147 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
);

148 
boﬁ
 
	`pxt4_es_sˇn_˛u
(
öode
 *inode,

149 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

150 
pxt4_lblk_t
 
lblk
);

152 
ölöe
 
	$pxt4_es_°©us
(
exã¡_°©us
 *
es
)

154  
es
->
es_pblk
 >> 
ES_SHIFT
;

155 
	}
}

157 
ölöe
 
	$pxt4_es_ty≥
(
exã¡_°©us
 *
es
)

159  (
es
->
es_pblk
 & 
ES_TYPE_MASK
Ë>> 
ES_SHIFT
;

160 
	}
}

162 
ölöe
 
	$pxt4_es_is_wrôãn
(
exã¡_°©us
 *
es
)

164  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_WRITTEN
) != 0;

165 
	}
}

167 
ölöe
 
	$pxt4_es_is_unwrôãn
(
exã¡_°©us
 *
es
)

169  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_UNWRITTEN
) != 0;

170 
	}
}

172 
ölöe
 
	$pxt4_es_is_dñayed
(
exã¡_°©us
 *
es
)

174  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_DELAYED
) != 0;

175 
	}
}

177 
ölöe
 
	$pxt4_es_is_hﬁe
(
exã¡_°©us
 *
es
)

179  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_HOLE
) != 0;

180 
	}
}

182 
ölöe
 
	$pxt4_es_is_m≠≥d
(
exã¡_°©us
 *
es
)

184  (
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es));

185 
	}
}

187 
ölöe
 
	$pxt4_es_is_dñ⁄ly
(
exã¡_°©us
 *
es
)

189  (
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es));

190 
	}
}

192 
ölöe
 
	$pxt4_es_£t_ª„ªn˚d
(
exã¡_°©us
 *
es
)

194 
es
->
es_pblk
 |((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
;

195 
	}
}

197 
ölöe
 
	$pxt4_es_˛ór_ª„ªn˚d
(
exã¡_°©us
 *
es
)

199 
es
->
es_pblk
 &~(((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
);

200 
	}
}

202 
ölöe
 
	$pxt4_es_is_ª„ªn˚d
(
exã¡_°©us
 *
es
)

204  (
	`pxt4_es_°©us
(
es
Ë& 
EXTENT_STATUS_REFERENCED
) != 0;

205 
	}
}

207 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_es_pblock
(
exã¡_°©us
 *
es
)

209  
es
->
es_pblk
 & ~
ES_MASK
;

210 
	}
}

212 
ölöe
 
	$pxt4_es_°‹e_pblock
(
exã¡_°©us
 *
es
,

213 
pxt4_fsblk_t
 
pb
)

215 
pxt4_fsblk_t
 
block
;

217 
block
 = (
pb
 & ~
ES_MASK
Ë| (
es
->
es_pblk
 & ES_MASK);

218 
es
->
es_pblk
 = 
block
;

219 
	}
}

221 
ölöe
 
	$pxt4_es_°‹e_°©us
(
exã¡_°©us
 *
es
,

222 
°©us
)

224 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

225 (
es
->
es_pblk
 & ~
ES_MASK
);

226 
	}
}

228 
ölöe
 
	$pxt4_es_°‹e_pblock_°©us
(
exã¡_°©us
 *
es
,

229 
pxt4_fsblk_t
 
pb
,

230 
°©us
)

232 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

233 (
pb
 & ~
ES_MASK
);

234 
	}
}

236 
pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

237 
pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

239 
pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
);

241 
__öô
 
pxt4_öô_≥ndög
();

242 
pxt4_exô_≥ndög
();

243 
pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
);

244 
pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

245 
boﬁ
 
pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

246 
pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

247 
boﬁ
 
Æloˇãd
);

248 
pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

249 
pxt4_lblk_t
 
Àn
);

250 
pxt4_˛ór_öode_es
(
öode
 *inode);

	@file.c

22 
	~<löux/time.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/iom≠.h
>

25 
	~<löux/mou¡.h
>

26 
	~<löux/∑th.h
>

27 
	~<löux/dax.h
>

28 
	~<löux/quŸa›s.h
>

29 
	~<löux/∑gevec.h
>

30 
	~<löux/uio.h
>

31 
	~<löux/mm™.h
>

32 
	~<löux/backög-dev.h
>

33 
	~"pxt4.h
"

34 
	~"pxt4_jbd3.h
"

35 
	~"x©å.h
"

36 
	~"a˛.h
"

37 
	~"åunˇã.h
"

39 
boﬁ
 
	$pxt4_dio_suµ‹ãd
(
öode
 *inode)

41 i‡(
	`IS_ENABLED
(
CONFIG_FS_ENCRYPTION
Ë&& 
	`IS_ENCRYPTED
(
öode
))

42  
Ál£
;

43 i‡(
	`fsvîôy_a˘ive
(
öode
))

44  
Ál£
;

45 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

46  
Ál£
;

47 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

48  
Ál£
;

49  
åue
;

50 
	}
}

52 
ssize_t
 
	$pxt4_dio_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

54 
ssize_t
 
ªt
;

55 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

57 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

58 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

59  -
EAGAIN
;

61 
	`öode_lock_sh¨ed
(
öode
);

64 i‡(!
	`pxt4_dio_suµ‹ãd
(
öode
)) {

65 
	`öode_u∆ock_sh¨ed
(
öode
);

73 
iocb
->
ki_Êags
 &~
IOCB_DIRECT
;

74  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

77 
ªt
 = 
	`iom≠_dio_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
, 
NULL
,

78 
	`is_sync_kiocb
(
iocb
));

79 
	`öode_u∆ock_sh¨ed
(
öode
);

81 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

82  
ªt
;

83 
	}
}

85 #ifde‡
CONFIG_FS_DAX


86 
ssize_t
 
	$pxt4_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

88 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

89 
ssize_t
 
ªt
;

91 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

92 i‡(!
	`öode_åylock_sh¨ed
(
öode
))

93  -
EAGAIN
;

95 
	`öode_lock_sh¨ed
(
öode
);

101 i‡(!
	`IS_DAX
(
öode
)) {

102 
	`öode_u∆ock_sh¨ed
(
öode
);

104  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

106 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
);

107 
	`öode_u∆ock_sh¨ed
(
öode
);

109 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

110  
ªt
;

111 
	}
}

114 
ssize_t
 
	$pxt4_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

116 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

118 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

119  -
EIO
;

121 i‡(!
	`iov_ôî_cou¡
(
to
))

124 #ifde‡
CONFIG_FS_DAX


125 i‡(
	`IS_DAX
(
öode
))

126  
	`pxt4_dax_ªad_ôî
(
iocb
, 
to
);

128 i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
)

129  
	`pxt4_dio_ªad_ôî
(
iocb
, 
to
);

131  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

132 
	}
}

139 
	$pxt4_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

141 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
)) {

142 
	`pxt4_Æloc_da_blocks
(
öode
);

143 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

146 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

147 (
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) == 1) &&

148 !
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

150 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

151 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

152 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

154 i‡(
	`is_dx
(
öode
Ë&& 
fûp
->
¥iv©e_d©a
)

155 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

158 
	}
}

170 
	$pxt4_u«lig√d_aio
(
öode
 *öode, 
iov_ôî
 *
‰om
, 
loff_t
 
pos
)

172 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

173 
blockmask
 = 
sb
->
s_blocksize
 - 1;

175 i‡(
pos
 >
	`ALIGN
(
	`i_size_ªad
(
öode
), 
sb
->
s_blocksize
))

178 i‡((
pos
 | 
	`iov_ôî_Æignmít
(
‰om
)Ë& 
blockmask
)

182 
	}
}

185 
boﬁ
 
	$pxt4_ovîwrôe_io
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àn
)

187 
pxt4_m≠_blocks
 
m≠
;

188 
blkbôs
 = 
öode
->
i_blkbôs
;

189 
îr
, 
blkÀn
;

191 i‡(
pos
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

192  
Ál£
;

194 
m≠
.
m_lblk
 = 
pos
 >> 
blkbôs
;

195 
m≠
.
m_Àn
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
pos
, 
blkbôs
);

196 
blkÀn
 = 
m≠
.
m_Àn
;

198 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

204  
îr
 =
blkÀn
 && (
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
);

205 
	}
}

207 
ssize_t
 
	$pxt4_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

209 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

210 
ssize_t
 
ªt
;

212 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

213  -
EPERM
;

215 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

216 i‡(
ªt
 <= 0)

217  
ªt
;

223 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

224 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

226 i‡(
iocb
->
ki_pos
 >
sbi
->
s_bôm≠_maxbyãs
)

227  -
EFBIG
;

228 
	`iov_ôî_åunˇã
(
‰om
, 
sbi
->
s_bôm≠_maxbyãs
 - 
iocb
->
ki_pos
);

231 
ªt
 = 
	`fûe_modifõd
(
iocb
->
ki_fûp
);

232 i‡(
ªt
)

233  
ªt
;

235  
	`iov_ôî_cou¡
(
‰om
);

236 
	}
}

238 
ssize_t
 
	$pxt4_buf„ªd_wrôe_ôî
(
kiocb
 *
iocb
,

239 
iov_ôî
 *
‰om
)

241 
ssize_t
 
ªt
;

242 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

244 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

245  -
EOPNOTSUPP
;

247 
	`öode_lock
(
öode
);

248 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

249 i‡(
ªt
 <= 0)

250 
out
;

252 
cuºít
->
backög_dev_öfo
 = 
	`öode_to_bdi
(
öode
);

253 
ªt
 = 
	`gíîic_≥rf‹m_wrôe
(
iocb
->
ki_fûp
, 
‰om
, iocb->
ki_pos
);

254 
cuºít
->
backög_dev_öfo
 = 
NULL
;

256 
out
:

257 
	`öode_u∆ock
(
öode
);

258 i‡(
	`likñy
(
ªt
 > 0)) {

259 
iocb
->
ki_pos
 +
ªt
;

260 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

263  
ªt
;

264 
	}
}

266 
ssize_t
 
	$pxt4_h™dÀ_öode_exãnsi⁄
(
öode
 *öode, 
loff_t
 
off£t
,

267 
ssize_t
 
wrôãn
, 
size_t
 
cou¡
)

269 
h™dÀ_t
 *
h™dÀ
;

270 
boﬁ
 
åunˇã
 = 
Ál£
;

271 
u8
 
blkbôs
 = 
öode
->
i_blkbôs
;

272 
pxt4_lblk_t
 
wrôãn_blk
, 
íd_blk
;

282 
	`WARN_ON_ONCE
(
	`i_size_ªad
(
öode
Ë< 
	`PXT4_I
(öode)->
i_disksize
);

283 i‡(
off£t
 + 
cou¡
 <
	`PXT4_I
(
öode
)->
i_disksize
) {

289 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
Ë&& inode->
i_∆ök
) {

290 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

292 i‡(
	`IS_ERR
(
h™dÀ
)) {

293 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

294  
	`PTR_ERR
(
h™dÀ
);

297 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

298 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

301  
wrôãn
;

304 i‡(
wrôãn
 < 0)

305 
åunˇã
;

307 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

308 i‡(
	`IS_ERR
(
h™dÀ
)) {

309 
wrôãn
 = 
	`PTR_ERR
(
h™dÀ
);

310 
åunˇã
;

313 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
off£t
 + 
wrôãn
))

314 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

319 
wrôãn_blk
 = 
	`ALIGN
(
off£t
 + 
wrôãn
, 1 << 
blkbôs
);

320 
íd_blk
 = 
	`ALIGN
(
off£t
 + 
cou¡
, 1 << 
blkbôs
);

321 i‡(
wrôãn_blk
 < 
íd_blk
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

322 
åunˇã
 = 
åue
;

328 i‡(!
åunˇã
 && 
öode
->
i_∆ök
)

329 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

330 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

332 i‡(
åunˇã
) {

333 
åunˇã
:

334 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

340 i‡(
öode
->
i_∆ök
)

341 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

344  
wrôãn
;

345 
	}
}

347 
	$pxt4_dio_wrôe_íd_io
(
kiocb
 *
iocb
, 
ssize_t
 
size
,

348 
îr‹
, 
Êags
)

350 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

351 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

353 i‡(
îr‹
)

354  
îr‹
;

356 i‡(
size
 && 
Êags
 & 
IOMAP_DIO_UNWRITTEN
)

357  
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
NULL
, 
öode
,

358 
off£t
, 
size
);

361 
	}
}

363 c⁄° 
iom≠_dio_›s
 
	gpxt4_dio_wrôe_›s
 = {

364 .
íd_io
 = 
pxt4_dio_wrôe_íd_io
,

367 
ssize_t
 
	$pxt4_dio_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

369 
ssize_t
 
ªt
;

370 
size_t
 
cou¡
;

371 
loff_t
 
off£t
;

372 
h™dÀ_t
 *
h™dÀ
;

373 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

374 
boﬁ
 
exãnd
 = 
Ál£
, 
ovîwrôe
 = fÆ£, 
u«lig√d_aio
 = false;

376 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

377 i‡(!
	`öode_åylock
(
öode
))

378  -
EAGAIN
;

380 
	`öode_lock
(
öode
);

383 i‡(!
	`pxt4_dio_suµ‹ãd
(
öode
)) {

384 
	`öode_u∆ock
(
öode
);

389  
	`pxt4_buf„ªd_wrôe_ôî
(
iocb
, 
‰om
);

392 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

393 i‡(
ªt
 <= 0) {

394 
	`öode_u∆ock
(
öode
);

395  
ªt
;

403 
off£t
 = 
iocb
->
ki_pos
;

404 
cou¡
 = 
	`iov_ôî_cou¡
(
‰om
);

405 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) &&

406 !
	`is_sync_kiocb
(
iocb
Ë&& 
	`pxt4_u«lig√d_aio
(
öode
, 
‰om
, 
off£t
)) {

407 
u«lig√d_aio
 = 
åue
;

408 
	`öode_dio_waô
(
öode
);

416 i‡(!
u«lig√d_aio
 && 
	`pxt4_ovîwrôe_io
(
öode
, 
off£t
, 
cou¡
) &&

417 
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

418 
ovîwrôe
 = 
åue
;

419 
	`downgøde_wrôe
(&
öode
->
i_rw£m
);

422 i‡(
off£t
 + 
cou¡
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

423 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

424 i‡(
	`IS_ERR
(
h™dÀ
)) {

425 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

426 
out
;

429 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

430 i‡(
ªt
) {

431 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

432 
out
;

435 
exãnd
 = 
åue
;

436 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

439 
ªt
 = 
	`iom≠_dio_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
, &
pxt4_dio_wrôe_›s
,

440 
	`is_sync_kiocb
(
iocb
Ë|| 
u«lig√d_aio
 || 
exãnd
);

442 i‡(
exãnd
)

443 
ªt
 = 
	`pxt4_h™dÀ_öode_exãnsi⁄
(
öode
, 
off£t
,Ñë, 
cou¡
);

445 
out
:

446 i‡(
ovîwrôe
)

447 
	`öode_u∆ock_sh¨ed
(
öode
);

449 
	`öode_u∆ock
(
öode
);

451 i‡(
ªt
 >0 && 
	`iov_ôî_cou¡
(
‰om
)) {

452 
ssize_t
 
îr
;

453 
loff_t
 
ídbyã
;

455 
off£t
 = 
iocb
->
ki_pos
;

456 
îr
 = 
	`pxt4_buf„ªd_wrôe_ôî
(
iocb
, 
‰om
);

457 i‡(
îr
 < 0)

458  
îr
;

467 
ªt
 +
îr
;

468 
ídbyã
 = 
off£t
 + 
îr
 - 1;

469 
îr
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
iocb
->
ki_fûp
->
f_m≠pög
,

470 
off£t
, 
ídbyã
);

471 i‡(!
îr
)

472 
	`övÆid©e_m≠pög_∑ges
(
iocb
->
ki_fûp
->
f_m≠pög
,

473 
off£t
 >> 
PAGE_SHIFT
,

474 
ídbyã
 >> 
PAGE_SHIFT
);

477  
ªt
;

478 
	}
}

480 #ifde‡
CONFIG_FS_DAX


481 
ssize_t


482 
	$pxt4_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

484 
ssize_t
 
ªt
;

485 
size_t
 
cou¡
;

486 
loff_t
 
off£t
;

487 
h™dÀ_t
 *
h™dÀ
;

488 
boﬁ
 
exãnd
 = 
Ál£
;

489 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

491 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

492 i‡(!
	`öode_åylock
(
öode
))

493  -
EAGAIN
;

495 
	`öode_lock
(
öode
);

498 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

499 i‡(
ªt
 <= 0)

500 
out
;

502 
off£t
 = 
iocb
->
ki_pos
;

503 
cou¡
 = 
	`iov_ôî_cou¡
(
‰om
);

505 i‡(
off£t
 + 
cou¡
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

506 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

507 i‡(
	`IS_ERR
(
h™dÀ
)) {

508 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

509 
out
;

512 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

513 i‡(
ªt
) {

514 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

515 
out
;

518 
exãnd
 = 
åue
;

519 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

522 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
);

524 i‡(
exãnd
)

525 
ªt
 = 
	`pxt4_h™dÀ_öode_exãnsi⁄
(
öode
, 
off£t
,Ñë, 
cou¡
);

526 
out
:

527 
	`öode_u∆ock
(
öode
);

528 i‡(
ªt
 > 0)

529 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

530  
ªt
;

531 
	}
}

534 
ssize_t


535 
	$pxt4_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

537 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

539 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

540  -
EIO
;

542 #ifde‡
CONFIG_FS_DAX


543 i‡(
	`IS_DAX
(
öode
))

544  
	`pxt4_dax_wrôe_ôî
(
iocb
, 
‰om
);

546 i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
)

547  
	`pxt4_dio_wrôe_ôî
(
iocb
, 
‰om
);

549  
	`pxt4_buf„ªd_wrôe_ôî
(
iocb
, 
‰om
);

550 
	}
}

552 #ifde‡
CONFIG_FS_DAX


553 
vm_Áu…_t
 
	$pxt4_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

554 
∑ge_íåy_size
 
≥_size
)

556 
îr‹
 = 0;

557 
vm_Áu…_t
 
ªsu…
;

558 
ªåõs
 = 0;

559 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

560 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

561 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

574 
boﬁ
 
wrôe
 = (
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
) &&

575 (
vmf
->
vma
->
vm_Êags
 & 
VM_SHARED
);

576 
p‚_t
 
p‚
;

578 i‡(
wrôe
) {

579 
	`sb_°¨t_∑geÁu…
(
sb
);

580 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

581 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

582 
ªåy
:

583 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_WRITE_PAGE
,

584 
	`PXT4_DATA_TRANS_BLOCKS
(
sb
));

585 i‡(
	`IS_ERR
(
h™dÀ
)) {

586 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

587 
	`sb_íd_∑geÁu…
(
sb
);

588  
VM_FAULT_SIGBUS
;

591 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

593 
ªsu…
 = 
	`dax_iom≠_Áu…
(
vmf
, 
≥_size
, &
p‚
, &
îr‹
, &
pxt4_iom≠_›s
);

594 i‡(
wrôe
) {

595 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

597 i‡((
ªsu…
 & 
VM_FAULT_ERROR
Ë&& 
îr‹
 =-
ENOSPC
 &&

598 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

599 
ªåy
;

601 i‡(
ªsu…
 & 
VM_FAULT_NEEDDSYNC
)

602 
ªsu…
 = 
	`dax_föish_sync_Áu…
(
vmf
, 
≥_size
, 
p‚
);

603 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

604 
	`sb_íd_∑geÁu…
(
sb
);

606 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

609  
ªsu…
;

610 
	}
}

612 
vm_Áu…_t
 
	$pxt4_dax_Áu…
(
vm_Áu…
 *
vmf
)

614  
	`pxt4_dax_huge_Áu…
(
vmf
, 
PE_SIZE_PTE
);

615 
	}
}

617 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_dax_vm_›s
 = {

618 .
Áu…
 = 
pxt4_dax_Áu…
,

619 .
	ghuge_Áu…
 = 
pxt4_dax_huge_Áu…
,

620 .
	g∑ge_mkwrôe
 = 
pxt4_dax_Áu…
,

621 .
	gp‚_mkwrôe
 = 
pxt4_dax_Áu…
,

624 
	#pxt4_dax_vm_›s
 
pxt4_fûe_vm_›s


	)

627 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_fûe_vm_›s
 = {

628 .
Áu…
 = 
pxt4_fûem≠_Áu…
,

629 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

630 .
	g∑ge_mkwrôe
 = 
pxt4_∑ge_mkwrôe
,

633 
	$pxt4_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

635 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

636 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

637 
dax_devi˚
 *
dax_dev
 = 
sbi
->
s_daxdev
;

639 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

640  -
EIO
;

646 i‡(!
	`daxdev_m≠pög_suµ‹ãd
(
vma
, 
dax_dev
))

647  -
EOPNOTSUPP
;

649 
	`fûe_ac˚s£d
(
fûe
);

650 i‡(
	`IS_DAX
(
	`fûe_öode
(
fûe
))) {

651 
vma
->
vm_›s
 = &
pxt4_dax_vm_›s
;

652 
vma
->
vm_Êags
 |
VM_HUGEPAGE
;

654 
vma
->
vm_›s
 = &
pxt4_fûe_vm_›s
;

657 
	}
}

659 
	$pxt4_ßm∂e_œ°_mou¡ed
(
su≥r_block
 *
sb
,

660 
vfsmou¡
 *
m¡
)

662 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

663 
∑th
Öath;

664 
buf
[64], *
˝
;

665 
h™dÀ_t
 *
h™dÀ
;

666 
îr
;

668 i‡(
	`likñy
(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_MNTDIR_SAMPLED
))

671 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`sb_°¨t_ötwrôe_åylock
(sb))

674 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_MNTDIR_SAMPLED
;

681 
	`mem£t
(
buf
, 0, (buf));

682 
∑th
.
m¡
 = mnt;

683 
∑th
.
díåy
 = 
m¡
->
m¡_roŸ
;

684 
˝
 = 
	`d_∑th
(&
∑th
, 
buf
, (buf));

685 
îr
 = 0;

686 i‡(
	`IS_ERR
(
˝
))

687 
out
;

689 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

690 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

691 i‡(
	`IS_ERR
(
h™dÀ
))

692 
out
;

693 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

694 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

695 i‡(
îr
)

696 
out_jou∫Æ
;

697 
	`°æ˝y
(
sbi
->
s_es
->
s_œ°_mou¡ed
, 
˝
,

698 (
sbi
->
s_es
->
s_œ°_mou¡ed
));

699 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

700 
out_jou∫Æ
:

701 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

702 
out
:

703 
	`sb_íd_ötwrôe
(
sb
);

704  
îr
;

705 
	}
}

707 
	$pxt4_fûe_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

709 
ªt
;

711 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

712  -
EIO
;

714 
ªt
 = 
	`pxt4_ßm∂e_œ°_mou¡ed
(
öode
->
i_sb
, 
fûp
->
f_∑th
.
m¡
);

715 i‡(
ªt
)

716  
ªt
;

718 
ªt
 = 
	`fs¸y±_fûe_›í
(
öode
, 
fûp
);

719 i‡(
ªt
)

720  
ªt
;

722 
ªt
 = 
	`fsvîôy_fûe_›í
(
öode
, 
fûp
);

723 i‡(
ªt
)

724  
ªt
;

730 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
) {

731 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

732 i‡(
ªt
 < 0)

733  
ªt
;

736 
fûp
->
f_mode
 |
FMODE_NOWAIT
;

737  
	`dquŸ_fûe_›í
(
öode
, 
fûp
);

738 
	}
}

745 
loff_t
 
	$pxt4_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

747 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

748 
loff_t
 
maxbyãs
;

750 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

751 
maxbyãs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
;

753 
maxbyãs
 = 
öode
->
i_sb
->
s_maxbyãs
;

755 
whí˚
) {

757  
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

758 
maxbyãs
, 
	`i_size_ªad
(
öode
));

759 
SEEK_HOLE
:

760 
	`öode_lock_sh¨ed
(
öode
);

761 
off£t
 = 
	`iom≠_£ek_hﬁe
(
öode
, offset,

762 &
pxt4_iom≠_ªp‹t_›s
);

763 
	`öode_u∆ock_sh¨ed
(
öode
);

765 
SEEK_DATA
:

766 
	`öode_lock_sh¨ed
(
öode
);

767 
off£t
 = 
	`iom≠_£ek_d©a
(
öode
, offset,

768 &
pxt4_iom≠_ªp‹t_›s
);

769 
	`öode_u∆ock_sh¨ed
(
öode
);

773 i‡(
off£t
 < 0)

774  
off£t
;

775  
	`vfs_£ços
(
fûe
, 
off£t
, 
maxbyãs
);

776 
	}
}

778 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_fûe_›î©i⁄s
 = {

779 .
Œ£ek
 = 
pxt4_Œ£ek
,

780 .
	gªad_ôî
 = 
pxt4_fûe_ªad_ôî
,

781 .
	gwrôe_ôî
 = 
pxt4_fûe_wrôe_ôî
,

782 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

783 #ifde‡
CONFIG_COMPAT


784 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

786 .
	gmm≠
 = 
pxt4_fûe_mm≠
,

787 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

788 .
	g›í
 = 
pxt4_fûe_›í
,

789 .
	gªÀa£
 = 
pxt4_ªÀa£_fûe
,

790 .
	gfsync
 = 
pxt4_sync_fûe
,

791 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

792 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

793 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

794 .
	gÁŒoˇã
 = 
pxt4_ÁŒoˇã
,

797 c⁄° 
öode_›î©i⁄s
 
	gpxt4_fûe_öode_›î©i⁄s
 = {

798 .
£èâr
 = 
pxt4_£èâr
,

799 .
	ggë©å
 = 
pxt4_fûe_gë©å
,

800 .
	gli°x©å
 = 
pxt4_li°x©å
,

801 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

802 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

803 .
	gfõm≠
 = 
pxt4_fõm≠
,

	@fsmap.c

7 
	~"pxt4.h
"

8 
	~<löux/fsm≠.h
>

9 
	~"fsm≠.h
"

10 
	~"mbÆloc.h
"

11 
	~<löux/s‹t.h
>

12 
	~<löux/li°_s‹t.h
>

13 
	~<åa˚/evíts/pxt4.h
>

16 
	$pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

17 
pxt4_fsm≠
 *
§c
)

19 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

20 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

21 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»<< 
sb
->
s_blocksize_bôs
;

22 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

23 
de°
->
fmr_off£t
 = 0;

24 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth << 
sb
->
s_blocksize_bôs
;

25 
de°
->
fmr_ª£rved
[0] = 0;

26 
de°
->
fmr_ª£rved
[1] = 0;

27 
de°
->
fmr_ª£rved
[2] = 0;

28 
	}
}

31 
	$pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

32 
fsm≠
 *
§c
)

34 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

35 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

36 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»>> 
sb
->
s_blocksize_bôs
;

37 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

38 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth >> 
sb
->
s_blocksize_bôs
;

39 
	}
}

42 
	spxt4_gëfsm≠_öfo
 {

43 
pxt4_fsm≠_hód
 *
	mgfi_hód
;

44 
pxt4_fsm≠_f‹m©_t
 
	mgfi_f‹m©ãr
;

45 *
	mgfi_f‹m©_¨g
;

46 
pxt4_fsblk_t
 
	mgfi_√xt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
pxt4_group_t
 
	mgfi_agno
;

49 
pxt4_fsm≠
 
	mgfi_low
;

50 
pxt4_fsm≠
 
	mgfi_high
;

51 
pxt4_fsm≠
 
	mgfi_œ°‰ì
;

52 
li°_hód
 
	mgfi_mëa_li°
;

53 
boﬁ
 
	mgfi_œ°
;

57 
	spxt4_gëfsm≠_dev
 {

58 (*
	mgfd_‚
)(
su≥r_block
 *
	msb
,

59 
pxt4_fsm≠
 *
	mkeys
,

60 
pxt4_gëfsm≠_öfo
 *
	möfo
);

61 
u32
 
	mgfd_dev
;

65 
	$pxt4_gëfsm≠_dev_com∑ª
(c⁄° *
p1
, c⁄° *
p2
)

67 c⁄° 
pxt4_gëfsm≠_dev
 *
d1
 = 
p1
;

68 c⁄° 
pxt4_gëfsm≠_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boﬁ
 
	$pxt4_gëfsm≠_ªc_bef‹e_low_key
(
pxt4_gëfsm≠_öfo
 *
öfo
,

75 
pxt4_fsm≠
 *
ªc
)

77  
ªc
->
fmr_physiˇl
 < 
öfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$pxt4_gëfsm≠_hñ≥r
(
su≥r_block
 *
sb
,

85 
pxt4_gëfsm≠_öfo
 *
öfo
,

86 
pxt4_fsm≠
 *
ªc
)

88 
pxt4_fsm≠
 
fmr
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

90 
pxt4_fsblk_t
 
ªc_fsblk
 = 
ªc
->
fmr_physiˇl
;

91 
pxt4_group_t
 
agno
;

92 
pxt4_gΩblk_t
 
˙o
;

93 
îr‹
;

95 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

96  -
EINTR
;

102 i‡(
	`pxt4_gëfsm≠_ªc_bef‹e_low_key
(
öfo
, 
ªc
)) {

103 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

104 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

105 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

106  
PXT4_QUERY_RANGE_CONTINUE
;

110 i‡(
öfo
->
gfi_hód
->
fmh_cou¡
 == 0) {

111 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
)

112 
öfo
->
gfi_hód
->
fmh_íåõs
++;

114 i‡(
öfo
->
gfi_œ°
)

115  
PXT4_QUERY_RANGE_CONTINUE
;

117 
öfo
->
gfi_hód
->
fmh_íåõs
++;

119 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

120 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

121 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

122  
PXT4_QUERY_RANGE_CONTINUE
;

130 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
) {

131 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

132  
PXT4_QUERY_RANGE_ABORT
;

134 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
öfo
->
gfi_√xt_fsblk
,

135 &
agno
, &
˙o
);

136 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
,

137 
	`PXT4_C2B
(
sbi
, 
˙o
),

138 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
,

139 
PXT4_FMR_OWN_UNKNOWN
);

141 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

142 
fmr
.
fmr_physiˇl
 = 
öfo
->
gfi_√xt_fsblk
;

143 
fmr
.
fmr_ow√r
 = 
PXT4_FMR_OWN_UNKNOWN
;

144 
fmr
.
fmr_Àngth
 = 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
;

145 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

146 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

147 i‡(
îr‹
)

148  
îr‹
;

149 
öfo
->
gfi_hód
->
fmh_íåõs
++;

152 i‡(
öfo
->
gfi_œ°
)

153 
out
;

156 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

157  
PXT4_QUERY_RANGE_ABORT
;

159 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
ªc_fsblk
, &
agno
, &
˙o
);

160 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
, 
	`PXT4_C2B
(
sbi
, 
˙o
),

161 
ªc
->
fmr_Àngth
,Ñec->
fmr_ow√r
);

163 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

164 
fmr
.
fmr_physiˇl
 = 
ªc_fsblk
;

165 
fmr
.
fmr_ow√r
 = 
ªc
->fmr_owner;

166 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

167 
fmr
.
fmr_Àngth
 = 
ªc
->fmr_length;

168 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

169 i‡(
îr‹
)

170  
îr‹
;

171 
öfo
->
gfi_hód
->
fmh_íåõs
++;

173 
out
:

174 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

175 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

176 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

177  
PXT4_QUERY_RANGE_CONTINUE
;

178 
	}
}

180 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_fsm≠_√xt_pblk
(
pxt4_fsm≠
 *
fmr
)

182  
fmr
->
fmr_physiˇl
 + fmr->
fmr_Àngth
;

183 
	}
}

186 
	$pxt4_gëfsm≠_d©adev_hñ≥r
(
su≥r_block
 *
sb
,

187 
pxt4_group_t
 
agno
, 
pxt4_gΩblk_t
 
°¨t
,

188 
pxt4_gΩblk_t
 
Àn
, *
¥iv
)

190 
pxt4_fsm≠
 
úec
;

191 
pxt4_gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

192 
pxt4_fsm≠
 *
p
;

193 
pxt4_fsm≠
 *
tmp
;

194 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

195 
pxt4_fsblk_t
 
fsb
;

196 
pxt4_fsblk_t
 
f¶í
;

197 
îr‹
;

199 
fsb
 = (
	`PXT4_C2B
(
sbi
, 
°¨t
Ë+ 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
));

200 
f¶í
 = 
	`PXT4_C2B
(
sbi
, 
Àn
);

203 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

205 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
öfo
->
gfi_œ°‰ì
Ë=
fsb
) {

206 
öfo
->
gfi_œ°‰ì
.
fmr_Àngth
 +
f¶í
;

214 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

215 i‡(
îr‹
)

216  
îr‹
;

217 
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
 = 0;

221 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, &
öfo
->
gfi_mëa_li°
, 
fmr_li°
) {

222 i‡(
p
->
fmr_physiˇl
 +Ö->
fmr_Àngth
 <
öfo
->
gfi_√xt_fsblk
) {

223 
	`li°_dñ
(&
p
->
fmr_li°
);

224 
	`k‰ì
(
p
);

225 } i‡(
p
->
fmr_physiˇl
 < 
fsb
) {

226 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, 
p
);

227 i‡(
îr‹
)

228  
îr‹
;

230 
	`li°_dñ
(&
p
->
fmr_li°
);

231 
	`k‰ì
(
p
);

235 
úec
.
fmr_devi˚
 = 0;

236 
úec
.
fmr_physiˇl
 = 
fsb
;

237 
úec
.
fmr_Àngth
 = 
f¶í
;

238 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_FREE
;

239 
úec
.
fmr_Êags
 = 0;

242 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
úec
) ==

243 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
 + 1)) {

244 
öfo
->
gfi_œ°‰ì
 = 
úec
;

249  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

250 
	}
}

253 
	$pxt4_gëfsm≠_logdev
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
keys
,

254 
pxt4_gëfsm≠_öfo
 *
öfo
)

256 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

257 
pxt4_fsm≠
 
úec
;

260 
öfo
->
gfi_low
 = 
keys
[0];

261 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

263 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

265 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, 0,

266 
öfo
->
gfi_low
.
fmr_physiˇl
,

267 
öfo
->
gfi_low
.
fmr_Àngth
,

268 
öfo
->
gfi_low
.
fmr_ow√r
);

270 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, 0,

271 
öfo
->
gfi_high
.
fmr_physiˇl
,

272 
öfo
->
gfi_high
.
fmr_Àngth
,

273 
öfo
->
gfi_high
.
fmr_ow√r
);

275 i‡(
keys
[0].
fmr_physiˇl
 > 0)

279 
úec
.
fmr_physiˇl
 = 
jou∫Æ
->
j_blk_off£t
;

280 
úec
.
fmr_Àngth
 = 
jou∫Æ
->
j_maxÀn
;

281 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_LOG
;

282 
úec
.
fmr_Êags
 = 0;

284  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

285 
	}
}

288 
ölöe
 
	$pxt4_gëfsm≠_fûl
(
li°_hód
 *
mëa_li°
,

289 
pxt4_fsblk_t
 
fsb
,Öxt4_fsblk_à
Àn
,

290 
uöt64_t
 
ow√r
)

292 
pxt4_fsm≠
 *
fsm
;

294 
fsm
 = 
	`kmÆloc
((*fsm), 
GFP_NOFS
);

295 i‡(!
fsm
)

296  -
ENOMEM
;

297 
fsm
->
fmr_devi˚
 = 0;

298 
fsm
->
fmr_Êags
 = 0;

299 
fsm
->
fmr_physiˇl
 = 
fsb
;

300 
fsm
->
fmr_ow√r
 = 
ow√r
;

301 
fsm
->
fmr_Àngth
 = 
Àn
;

302 
	`li°_add_èû
(&
fsm
->
fmr_li°
, 
mëa_li°
);

305 
	}
}

311 
	$pxt4_gëfsm≠_föd_sb
(
su≥r_block
 *
sb
,

312 
pxt4_group_t
 
agno
,

313 
li°_hód
 *
mëa_li°
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_fsblk_t
 
fsb
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
);

317 
pxt4_fsblk_t
 
Àn
;

318 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

319 
mëagroup
 = 
agno
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

320 
îr‹
;

323 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
agno
)) {

324 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 1, 
PXT4_FMR_OWN_FS
);

325 i‡(
îr‹
)

326  
îr‹
;

327 
fsb
++;

331 
Àn
 = 
	`pxt4_bg_num_gdb
(
sb
, 
agno
);

332 i‡(!
Àn
)

334 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

335 
PXT4_FMR_OWN_GDT
);

336 i‡(
îr‹
)

337  
îr‹
;

338 
fsb
 +
Àn
;

341 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
) {

342 
Àn
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

343 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

344 
PXT4_FMR_OWN_RESV_GDT
);

345 i‡(
îr‹
)

346  
îr‹
;

350 
	}
}

353 
	$pxt4_gëfsm≠_com∑ª
(*
¥iv
,

354 
li°_hód
 *
a
,

355 
li°_hód
 *
b
)

357 
pxt4_fsm≠
 *
Á
;

358 
pxt4_fsm≠
 *
fb
;

360 
Á
 = 
	`c⁄èöî_of
(
a
, 
pxt4_fsm≠
, 
fmr_li°
);

361 
fb
 = 
	`c⁄èöî_of
(
b
, 
pxt4_fsm≠
, 
fmr_li°
);

362 i‡(
Á
->
fmr_physiˇl
 < 
fb
->fmr_physical)

364 i‡(
Á
->
fmr_physiˇl
 > 
fb
->fmr_physical)

367 
	}
}

370 
	$pxt4_gëfsm≠_mîge_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

372 
pxt4_fsm≠
 *
p
;

373 
pxt4_fsm≠
 *
¥ev
 = 
NULL
;

374 
pxt4_fsm≠
 *
tmp
;

376 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

377 i‡(!
¥ev
) {

378 
¥ev
 = 
p
;

382 i‡(
¥ev
->
fmr_ow√r
 =
p
->fmr_owner &&

383 
¥ev
->
fmr_physiˇl
 +Öªv->
fmr_Àngth
 =
p
->fmr_physical) {

384 
¥ev
->
fmr_Àngth
 +
p
->fmr_length;

385 
	`li°_dñ
(&
p
->
fmr_li°
);

386 
	`k‰ì
(
p
);

388 
¥ev
 = 
p
;

390 
	}
}

393 
	$pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

395 
pxt4_fsm≠
 *
p
;

396 
pxt4_fsm≠
 *
tmp
;

398 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

399 
	`li°_dñ
(&
p
->
fmr_li°
);

400 
	`k‰ì
(
p
);

402 
	}
}

405 
	$pxt4_gëfsm≠_föd_fixed_mëad©a
(
su≥r_block
 *
sb
,

406 
li°_hód
 *
mëa_li°
)

408 
pxt4_group_desc
 *
gdp
;

409 
pxt4_group_t
 
agno
;

410 
îr‹
;

412 
	`INIT_LIST_HEAD
(
mëa_li°
);

415 
agno
 = 0;ágnÿ< 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;ágno++) {

416 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
agno
, 
NULL
);

417 i‡(!
gdp
) {

418 
îr‹
 = -
EFSCORRUPTED
;

419 
îr
;

423 
îr‹
 = 
	`pxt4_gëfsm≠_föd_sb
(
sb
, 
agno
, 
mëa_li°
);

424 i‡(
îr‹
)

425 
îr
;

428 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

429 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1,

430 
PXT4_FMR_OWN_BLKBM
);

431 i‡(
îr‹
)

432 
îr
;

435 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

436 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1,

437 
PXT4_FMR_OWN_INOBM
);

438 i‡(
îr‹
)

439 
îr
;

442 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

443 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

444 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
,

445 
PXT4_FMR_OWN_INODES
);

446 i‡(
îr‹
)

447 
îr
;

451 
	`li°_s‹t
(
NULL
, 
mëa_li°
, 
pxt4_gëfsm≠_com∑ª
);

454 
	`pxt4_gëfsm≠_mîge_fixed_mëad©a
(
mëa_li°
);

457 
îr
:

458 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
mëa_li°
);

459  
îr‹
;

460 
	}
}

463 
	$pxt4_gëfsm≠_d©adev
(
su≥r_block
 *
sb
,

464 
pxt4_fsm≠
 *
keys
,

465 
pxt4_gëfsm≠_öfo
 *
öfo
)

467 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

468 
pxt4_fsblk_t
 
°¨t_fsb
;

469 
pxt4_fsblk_t
 
íd_fsb
;

470 
pxt4_fsblk_t
 
bofs
;

471 
pxt4_fsblk_t
 
eofs
;

472 
pxt4_group_t
 
°¨t_ag
;

473 
pxt4_group_t
 
íd_ag
;

474 
pxt4_gΩblk_t
 
fú°_˛u°î
;

475 
pxt4_gΩblk_t
 
œ°_˛u°î
;

476 
îr‹
 = 0;

478 
bofs
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

479 
eofs
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
);

480 i‡(
keys
[0].
fmr_physiˇl
 >
eofs
)

482 i‡(
keys
[0].
fmr_physiˇl
 < 
bofs
)

483 
keys
[0].
fmr_physiˇl
 = 
bofs
;

484 i‡(
keys
[1].
fmr_physiˇl
 >
eofs
)

485 
keys
[1].
fmr_physiˇl
 = 
eofs
 - 1;

486 
°¨t_fsb
 = 
keys
[0].
fmr_physiˇl
;

487 
íd_fsb
 = 
keys
[1].
fmr_physiˇl
;

490 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t_fsb
, &
°¨t_ag
, &
fú°_˛u°î
);

491 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
íd_fsb
, &
íd_ag
, &
œ°_˛u°î
);

498 
öfo
->
gfi_low
 = 
keys
[0];

499 
öfo
->
gfi_low
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
);

500 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

502 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

505 
îr‹
 = 
	`pxt4_gëfsm≠_föd_fixed_mëad©a
(
sb
, &
öfo
->
gfi_mëa_li°
);

506 i‡(
îr‹
)

507 
îr
;

510 
öfo
->
gfi_agno
 = 
°¨t_ag
;

511 
öfo
->
gfi_agno
 <
íd_ag
;

512 
öfo
->
gfi_agno
++) {

517 i‡(
öfo
->
gfi_agno
 =
íd_ag
) {

518 
öfo
->
gfi_high
 = 
keys
[1];

519 
öfo
->
gfi_high
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
,

520 
œ°_˛u°î
);

521 
öfo
->
gfi_high
.
fmr_Àngth
 = 0;

524 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

525 
öfo
->
gfi_low
.
fmr_physiˇl
,

526 
öfo
->
gfi_low
.
fmr_Àngth
,

527 
öfo
->
gfi_low
.
fmr_ow√r
);

529 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

530 
öfo
->
gfi_high
.
fmr_physiˇl
,

531 
öfo
->
gfi_high
.
fmr_Àngth
,

532 
öfo
->
gfi_high
.
fmr_ow√r
);

534 
îr‹
 = 
	`pxt4_mbÆloc_quîy_ønge
(
sb
, 
öfo
->
gfi_agno
,

535 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_low
.
fmr_physiˇl
),

536 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_high
.
fmr_physiˇl
),

537 
pxt4_gëfsm≠_d©adev_hñ≥r
, 
öfo
);

538 i‡(
îr‹
)

539 
îr
;

545 i‡(
öfo
->
gfi_agno
 =
°¨t_ag
)

546 
	`mem£t
(&
öfo
->
gfi_low
, 0, (info->gfi_low));

550 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

551 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

552 i‡(
îr‹
)

553 
îr
;

557 
öfo
->
gfi_œ°
 = 
åue
;

558 
îr‹
 = 
	`pxt4_gëfsm≠_d©adev_hñ≥r
(
sb
, 
íd_ag
, 
œ°_˛u°î
, 0, 
öfo
);

559 i‡(
îr‹
)

560 
îr
;

562 
îr
:

563 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(&
öfo
->
gfi_mëa_li°
);

564  
îr‹
;

565 
	}
}

568 
boﬁ
 
	$pxt4_gëfsm≠_is_vÆid_devi˚
(
su≥r_block
 *
sb
,

569 
pxt4_fsm≠
 *
fm
)

571 i‡(
fm
->
fmr_devi˚
 =0 || fm->fmr_devi˚ =
UINT_MAX
 ||

572 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
))

573  
åue
;

574 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 &&

575 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
))

576  
åue
;

577  
Ál£
;

578 
	}
}

581 
boﬁ
 
	$pxt4_gëfsm≠_check_keys
(
pxt4_fsm≠
 *
low_key
,

582 
pxt4_fsm≠
 *
high_key
)

584 i‡(
low_key
->
fmr_devi˚
 > 
high_key
->fmr_device)

585  
Ál£
;

586 i‡(
low_key
->
fmr_devi˚
 < 
high_key
->fmr_device)

587  
åue
;

589 i‡(
low_key
->
fmr_physiˇl
 > 
high_key
->fmr_physical)

590  
Ál£
;

591 i‡(
low_key
->
fmr_physiˇl
 < 
high_key
->fmr_physical)

592  
åue
;

594 i‡(
low_key
->
fmr_ow√r
 > 
high_key
->fmr_owner)

595  
Ál£
;

596 i‡(
low_key
->
fmr_ow√r
 < 
high_key
->fmr_owner)

597  
åue
;

599  
Ál£
;

600 
	}
}

602 
	#PXT4_GETFSMAP_DEVS
 2

	)

624 
	$pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

625 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
)

627 
pxt4_fsm≠
 
dkeys
[2];

628 
pxt4_gëfsm≠_dev
 
h™dÀrs
[
PXT4_GETFSMAP_DEVS
];

629 
pxt4_gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

630 
i
;

631 
îr‹
 = 0;

633 i‡(
hód
->
fmh_iÊags
 & ~
FMH_IF_VALID
)

634  -
EINVAL
;

635 i‡(!
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[0]) ||

636 !
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[1]))

637  -
EINVAL
;

639 
hód
->
fmh_íåõs
 = 0;

642 
	`mem£t
(
h™dÀrs
, 0, (handlers));

643 
h™dÀrs
[0].
gfd_dev
 = 
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

644 
h™dÀrs
[0].
gfd_‚
 = 
pxt4_gëfsm≠_d©adev
;

645 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
) {

646 
h™dÀrs
[1].
gfd_dev
 = 
	`√w_ícode_dev
(

647 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
);

648 
h™dÀrs
[1].
gfd_‚
 = 
pxt4_gëfsm≠_logdev
;

651 
	`s‹t
(
h™dÀrs
, 
PXT4_GETFSMAP_DEVS
, (
pxt4_gëfsm≠_dev
),

652 
pxt4_gëfsm≠_dev_com∑ª
, 
NULL
);

665 
dkeys
[0] = 
hód
->
fmh_keys
[0];

666 
dkeys
[0].
fmr_physiˇl
 +dkeys[0].
fmr_Àngth
;

667 
dkeys
[0].
fmr_ow√r
 = 0;

668 
dkeys
[0].
fmr_Àngth
 = 0;

669 
	`mem£t
(&
dkeys
[1], 0xFF, (
pxt4_fsm≠
));

671 i‡(!
	`pxt4_gëfsm≠_check_keys
(
dkeys
, &
hód
->
fmh_keys
[1]))

672  -
EINVAL
;

674 
öfo
.
gfi_√xt_fsblk
 = 
hód
->
fmh_keys
[0].
fmr_physiˇl
 +

675 
hód
->
fmh_keys
[0].
fmr_Àngth
;

676 
öfo
.
gfi_f‹m©ãr
 = 
f‹m©ãr
;

677 
öfo
.
gfi_f‹m©_¨g
 = 
¨g
;

678 
öfo
.
gfi_hód
 = 
hód
;

681 
i
 = 0; i < 
PXT4_GETFSMAP_DEVS
; i++) {

683 i‡(!
h™dÀrs
[
i
].
gfd_‚
)

685 i‡(
hód
->
fmh_keys
[0].
fmr_devi˚
 > 
h™dÀrs
[
i
].
gfd_dev
)

687 i‡(
hód
->
fmh_keys
[1].
fmr_devi˚
 < 
h™dÀrs
[
i
].
gfd_dev
)

697 i‡(
h™dÀrs
[
i
].
gfd_dev
 =
hód
->
fmh_keys
[1].
fmr_devi˚
)

698 
dkeys
[1] = 
hód
->
fmh_keys
[1];

699 i‡(
h™dÀrs
[
i
].
gfd_dev
 > 
hód
->
fmh_keys
[0].
fmr_devi˚
)

700 
	`mem£t
(&
dkeys
[0], 0, (
pxt4_fsm≠
));

702 
öfo
.
gfi_dev
 = 
h™dÀrs
[
i
].
gfd_dev
;

703 
öfo
.
gfi_œ°
 = 
Ál£
;

704 
öfo
.
gfi_agno
 = -1;

705 
îr‹
 = 
h™dÀrs
[
i
].
	`gfd_‚
(
sb
, 
dkeys
, &
öfo
);

706 i‡(
îr‹
)

708 
öfo
.
gfi_√xt_fsblk
 = 0;

711 
hód
->
fmh_oÊags
 = 
FMH_OF_DEV_T
;

712  
îr‹
;

713 
	}
}

	@fsmap.h

7 #i‚de‡
__PXT4_FSMAP_H__


8 
	#__PXT4_FSMAP_H__


	)

10 
	gfsm≠
;

13 
	spxt4_fsm≠
 {

14 
li°_hód
 
	mfmr_li°
;

15 
dev_t
 
	mfmr_devi˚
;

16 
uöt32_t
 
	mfmr_Êags
;

17 
uöt64_t
 
	mfmr_physiˇl
;

18 
uöt64_t
 
	mfmr_ow√r
;

19 
uöt64_t
 
	mfmr_Àngth
;

22 
	spxt4_fsm≠_hód
 {

23 
uöt32_t
 
	mfmh_iÊags
;

24 
uöt32_t
 
	mfmh_oÊags
;

25 
	mfmh_cou¡
;

26 
	mfmh_íåõs
;

28 
pxt4_fsm≠
 
	mfmh_keys
[2];

31 
pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

32 
pxt4_fsm≠
 *
§c
);

33 
pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

34 
fsm≠
 *
§c
);

37 (*
	tpxt4_fsm≠_f‹m©_t
)(
	tpxt4_fsm≠
 *, *);

39 
	`pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

40 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
);

42 
	#PXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#PXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#PXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#PXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#PXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1Ë

	)

49 
	#PXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2Ë

	)

50 
	#PXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5Ë

	)

51 
	#PXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1Ë

	)

52 
	#PXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2Ë

	)

53 
	#PXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3Ë

	)

54 
	#PXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4Ë

	)

	@fsync.c

26 
	~<löux/time.h
>

27 
	~<löux/fs.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/wrôeback.h
>

30 
	~<löux/blkdev.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

35 
	~<åa˚/evíts/pxt4.h
>

45 
	$pxt4_sync_∑ª¡
(
öode
 *inode)

47 
díåy
 *díåy = 
NULL
;

48 
öode
 *
√xt
;

49 
ªt
 = 0;

51 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

53 
öode
 = 
	`igøb
(inode);

54 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
)) {

55 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

56 
díåy
 = 
	`d_föd_™y_Æüs
(
öode
);

57 i‡(!
díåy
)

59 
√xt
 = 
	`igøb
(
	`d_öode
(
díåy
->
d_∑ª¡
));

60 
	`dput
(
díåy
);

61 i‡(!
√xt
)

63 
	`ùut
(
öode
);

64 
öode
 = 
√xt
;

72 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

73 i‡(
ªt
)

75 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 1);

76 i‡(
ªt
)

79 
	`ùut
(
öode
);

80  
ªt
;

81 
	}
}

83 
	$pxt4_fsync_nojou∫Æ
(
öode
 *öode, 
boﬁ
 
d©async
,

84 
boﬁ
 *
√eds_b¨rõr
)

86 
ªt
, 
îr
;

88 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

89 i‡(!(
öode
->
i_°©e
 & 
I_DIRTY_ALL
))

90  
ªt
;

91 i‡(
d©async
 && !(
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
))

92  
ªt
;

94 
îr
 = 
	`sync_öode_mëad©a
(
öode
, 1);

95 i‡(!
ªt
)

96 
ªt
 = 
îr
;

98 i‡(!
ªt
)

99 
ªt
 = 
	`pxt4_sync_∑ª¡
(
öode
);

100 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
BARRIER
))

101 *
√eds_b¨rõr
 = 
åue
;

103  
ªt
;

104 
	}
}

106 
	$pxt4_fsync_jou∫Æ
(
öode
 *öode, 
boﬁ
 
d©async
,

107 
boﬁ
 *
√eds_b¨rõr
)

109 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

110 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

111 
tid_t
 
commô_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :Éi->
i_sync_tid
;

113 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

114 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ
, 
commô_tid
))

115 *
√eds_b¨rõr
 = 
åue
;

117  
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

118 
	}
}

131 
	$pxt4_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

133 
ªt
 = 0, 
îr
;

134 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

135 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

136 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

138 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

139  -
EIO
;

141 
	`J_ASSERT
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
);

143 
	`åa˚_pxt4_sync_fûe_íãr
(
fûe
, 
d©async
);

145 i‡(
	`sb_rd⁄ly
(
öode
->
i_sb
)) {

147 
	`smp_rmb
();

148 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

149 
ªt
 = -
EROFS
;

150 
out
;

153 
ªt
 = 
	`fûe_wrôe_™d_waô_ønge
(
fûe
, 
°¨t
, 
íd
);

154 i‡(
ªt
)

155  
ªt
;

171 i‡(!
sbi
->
s_jou∫Æ
)

172 
ªt
 = 
	`pxt4_fsync_nojou∫Æ
(
öode
, 
d©async
, &
√eds_b¨rõr
);

173 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

174 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

176 
ªt
 = 
	`pxt4_fsync_jou∫Æ
(
öode
, 
d©async
, &
√eds_b¨rõr
);

178 i‡(
√eds_b¨rõr
) {

179 
îr
 = 
	`blkdev_issue_Êush
(
öode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

180 i‡(!
ªt
)

181 
ªt
 = 
îr
;

183 
out
:

184 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

185 i‡(
ªt
 == 0)

186 
ªt
 = 
îr
;

187 
	`åa˚_pxt4_sync_fûe_exô
(
öode
, 
ªt
);

188  
ªt
;

189 
	}
}

	@hash.c

8 
	~<löux/fs.h
>

9 
	~<löux/unicode.h
>

10 
	~<löux/compûî.h
>

11 
	~<löux/bô›s.h
>

12 
	~"pxt4.h
"

14 
	#DELTA
 0x9E3779B9

	)

16 
	$TEA_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[])

18 
__u32
 
sum
 = 0;

19 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

20 
__u32
 
a
 = 
ö
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

21 
n
 = 16;

24 
sum
 +
DELTA
;

25 
b0
 +((
b1
 << 4)+
a
Ë^ (b1+
sum
Ë^ ((b1 >> 5)+
b
);

26 
b1
 +((
b0
 << 4)+
c
Ë^ (b0+
sum
Ë^ ((b0 >> 5)+
d
);

27 } --
n
);

29 
buf
[0] +
b0
;

30 
buf
[1] +
b1
;

31 
	}
}

34 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

35 
	#G
(
x
, 
y
, 
z
Ë(((xË& (y)Ë+ (((xË^ (y)Ë& (z)))

	)

36 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

44 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

45 (
a
 +
	`f
(
b
, 
c
, 
d
Ë+ 
x
,á = 
	`rﬁ32
◊, 
s
))

	)

46 
	#K1
 0

	)

47 
	#K2
 013240474631UL

	)

48 
	#K3
 015666365641UL

	)

53 
__u32
 
	$hÆf_md4_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[8])

55 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

58 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K1
, 3);

59 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 
K1
, 7);

60 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K1
, 11);

61 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 
K1
, 19);

62 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 
K1
, 3);

63 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K1
, 7);

64 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 
K1
, 11);

65 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K1
, 19);

68 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K2
, 3);

69 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 
K2
, 5);

70 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[5] + 
K2
, 9);

71 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K2
, 13);

72 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K2
, 3);

73 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 
K2
, 5);

74 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[4] + 
K2
, 9);

75 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K2
, 13);

78 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[3] + 
K3
, 3);

79 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 
K3
, 9);

80 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K3
, 11);

81 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K3
, 15);

82 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K3
, 3);

83 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K3
, 9);

84 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[0] + 
K3
, 11);

85 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 
K3
, 15);

87 
buf
[0] +
a
;

88 
buf
[1] +
b
;

89 
buf
[2] +
c
;

90 
buf
[3] +
d
;

92  
buf
[1];

93 
	}
}

94 #unde‡
ROUND


95 #unde‡
K1


96 #unde‡
K2


97 #unde‡
K3


98 #unde‡
F


99 #unde‡
G


100 #unde‡
H


103 
__u32
 
	$dx_hack_hash_unsig√d
(c⁄° *
«me
, 
Àn
)

105 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

106 c⁄° *
u˝
 = (c⁄° *Ë
«me
;

108 
Àn
--) {

109 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
u˝
++) * 7152373));

111 i‡(
hash
 & 0x80000000)

112 
hash
 -= 0x7fffffff;

113 
hash1
 = 
hash0
;

114 
hash0
 = 
hash
;

116  
hash0
 << 1;

117 
	}
}

119 
__u32
 
	$dx_hack_hash_sig√d
(c⁄° *
«me
, 
Àn
)

121 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

122 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
«me
;

124 
Àn
--) {

125 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
s˝
++) * 7152373));

127 i‡(
hash
 & 0x80000000)

128 
hash
 -= 0x7fffffff;

129 
hash1
 = 
hash0
;

130 
hash0
 = 
hash
;

132  
hash0
 << 1;

133 
	}
}

135 
	$°r2hashbuf_sig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

137 
__u32
 
∑d
, 
vÆ
;

138 
i
;

139 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
msg
;

141 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

142 
∑d
 |=Öad << 16;

144 
vÆ
 = 
∑d
;

145 i‡(
Àn
 > 
num
*4)

146 
Àn
 = 
num
 * 4;

147 
i
 = 0; i < 
Àn
; i++) {

148 
vÆ
 = ((Ë
s˝
[
i
]) + (val << 8);

149 i‡((
i
 % 4) == 3) {

150 *
buf
++ = 
vÆ
;

151 
vÆ
 = 
∑d
;

152 
num
--;

155 i‡(--
num
 >= 0)

156 *
buf
++ = 
vÆ
;

157 --
num
 >= 0)

158 *
buf
++ = 
∑d
;

159 
	}
}

161 
	$°r2hashbuf_unsig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

163 
__u32
 
∑d
, 
vÆ
;

164 
i
;

165 c⁄° *
u˝
 = (c⁄° *Ë
msg
;

167 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

168 
∑d
 |=Öad << 16;

170 
vÆ
 = 
∑d
;

171 i‡(
Àn
 > 
num
*4)

172 
Àn
 = 
num
 * 4;

173 
i
 = 0; i < 
Àn
; i++) {

174 
vÆ
 = ((Ë
u˝
[
i
]) + (val << 8);

175 i‡((
i
 % 4) == 3) {

176 *
buf
++ = 
vÆ
;

177 
vÆ
 = 
∑d
;

178 
num
--;

181 i‡(--
num
 >= 0)

182 *
buf
++ = 
vÆ
;

183 --
num
 >= 0)

184 *
buf
++ = 
∑d
;

185 
	}
}

200 
	$__pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
,

201 
dx_hash_öfo
 *
höfo
)

203 
__u32
 
hash
;

204 
__u32
 
mö‹_hash
 = 0;

205 c⁄° *
p
;

206 
i
;

207 
__u32
 
ö
[8], 
buf
[4];

208 (*
°r2hashbuf
)(c⁄° *, , 
__u32
 *, ) =

209 
°r2hashbuf_sig√d
;

212 
buf
[0] = 0x67452301;

213 
buf
[1] = 0xefcdab89;

214 
buf
[2] = 0x98badcfe;

215 
buf
[3] = 0x10325476;

218 i‡(
höfo
->
£ed
) {

219 
i
 = 0; i < 4; i++) {

220 i‡(
höfo
->
£ed
[
i
]) {

221 
	`mem˝y
(
buf
, 
höfo
->
£ed
, (buf));

227 
höfo
->
hash_vîsi⁄
) {

228 
DX_HASH_LEGACY_UNSIGNED
:

229 
hash
 = 
	`dx_hack_hash_unsig√d
(
«me
, 
Àn
);

231 
DX_HASH_LEGACY
:

232 
hash
 = 
	`dx_hack_hash_sig√d
(
«me
, 
Àn
);

234 
DX_HASH_HALF_MD4_UNSIGNED
:

235 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

237 
DX_HASH_HALF_MD4
:

238 
p
 = 
«me
;

239 
Àn
 > 0) {

240 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 8);

241 
	`hÆf_md4_å™sf‹m
(
buf
, 
ö
);

242 
Àn
 -= 32;

243 
p
 += 32;

245 
mö‹_hash
 = 
buf
[2];

246 
hash
 = 
buf
[1];

248 
DX_HASH_TEA_UNSIGNED
:

249 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

251 
DX_HASH_TEA
:

252 
p
 = 
«me
;

253 
Àn
 > 0) {

254 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 4);

255 
	`TEA_å™sf‹m
(
buf
, 
ö
);

256 
Àn
 -= 16;

257 
p
 += 16;

259 
hash
 = 
buf
[0];

260 
mö‹_hash
 = 
buf
[1];

263 
höfo
->
hash
 = 0;

266 
hash
 = hash & ~1;

267 i‡(
hash
 =(
PXT4_HTREE_EOF_32BIT
 << 1))

268 
hash
 = (
PXT4_HTREE_EOF_32BIT
 - 1) << 1;

269 
höfo
->
hash
 = hash;

270 
höfo
->
mö‹_hash
 = minor_hash;

272 
	}
}

274 
	$pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

275 
dx_hash_öfo
 *
höfo
)

277 #ifde‡
CONFIG_UNICODE


278 c⁄° 
unicode_m≠
 *
um
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
;

279 
r
, 
dÀn
;

280 *
buff
;

281 
q°r
 q°∏{.
«me
 =Çame, .
Àn
 =Üen };

283 i‡(
Àn
 && 
	`IS_CASEFOLDED
(
dú
Ë&& 
um
) {

284 
buff
 = 
	`kzÆloc
((Ë* 
PATH_MAX
, 
GFP_KERNEL
);

285 i‡(!
buff
)

286  -
ENOMEM
;

288 
dÀn
 = 
	`utf8_ˇ£fﬁd
(
um
, &
q°r
, 
buff
, 
PATH_MAX
);

289 i‡(
dÀn
 < 0) {

290 
	`k‰ì
(
buff
);

291 
›aque_£q
;

294 
r
 = 
	`__pxt4fs_dúhash
(
buff
, 
dÀn
, 
höfo
);

296 
	`k‰ì
(
buff
);

297  
r
;

299 
›aque_£q
:

301  
	`__pxt4fs_dúhash
(
«me
, 
Àn
, 
höfo
);

302 
	}
}

	@ialloc.c

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/°©.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/quŸa›s.h
>

21 
	~<löux/buf„r_hód.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/¸ed.h
>

27 
	~<asm/byã‹dî.h
>

29 
	~"pxt4.h
"

30 
	~"pxt4_jbd3.h
"

31 
	~"x©å.h
"

32 
	~"a˛.h
"

34 
	~<åa˚/evíts/pxt4.h
>

55 
	$pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
)

57 
i
;

59 i‡(
°¨t_bô
 >
íd_bô
)

62 
	`pxt4_debug
("m¨kÉnd bô†+%dÅhrough +%d u£d\n", 
°¨t_bô
, 
íd_bô
);

63 
i
 = 
°¨t_bô
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`pxt4_£t_bô
(
i
, 
bôm≠
);

65 i‡(
i
 < 
íd_bô
)

66 
	`mem£t
(
bôm≠
 + (
i
 >> 3), 0xff, (
íd_bô
 - i) >> 3);

67 
	}
}

69 
	$pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
)

71 i‡(
u±od©e
) {

72 
	`£t_buf„r_u±od©e
(
bh
);

73 
	`£t_bôm≠_u±od©e
(
bh
);

75 
	`u∆ock_buf„r
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$pxt4_vÆid©e_öode_bôm≠
(
su≥r_block
 *
sb
,

80 
pxt4_group_desc
 *
desc
,

81 
pxt4_group_t
 
block_group
,

82 
buf„r_hód
 *
bh
)

84 
pxt4_fsblk_t
 
blk
;

85 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

87 i‡(
	`buf„r_vîifõd
(
bh
))

89 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

90  -
EFSCORRUPTED
;

92 
	`pxt4_lock_group
(
sb
, 
block_group
);

93 i‡(
	`buf„r_vîifõd
(
bh
))

94 
vîifõd
;

95 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

96 i‡(!
	`pxt4_öode_bôm≠_csum_vîify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

99 
	`pxt4_îr‹
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "öode_bôm≠ = %Œu", 
block_group
, 
blk
);

101 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

102 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_buf„r_vîifõd
(
bh
);

106 
vîifõd
:

107 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

109 
	}
}

117 
buf„r_hód
 *

118 
	$pxt4_ªad_öode_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

120 
pxt4_group_desc
 *
desc
;

121 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

122 
buf„r_hód
 *
bh
 = 
NULL
;

123 
pxt4_fsblk_t
 
bôm≠_blk
;

124 
îr
;

126 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

127 i‡(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
bôm≠_blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

131 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

132 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

133 
	`pxt4_îr‹
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

135 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

136 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

140 i‡(
	`u∆ikñy
(!
bh
)) {

141 
	`pxt4_w¨nög
(
sb
, "CannotÑead inode bitmap - "

143 
block_group
, 
bôm≠_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 i‡(
	`bôm≠_u±od©e
(
bh
))

147 
vîify
;

149 
	`lock_buf„r
(
bh
);

150 i‡(
	`bôm≠_u±od©e
(
bh
)) {

151 
	`u∆ock_buf„r
(
bh
);

152 
vîify
;

155 
	`pxt4_lock_group
(
sb
, 
block_group
);

156 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

158 i‡(
block_group
 == 0) {

159 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

160 
	`u∆ock_buf„r
(
bh
);

161 
	`pxt4_îr‹
(
sb
, "Inode bitmap for bg 0 marked "

163 
îr
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`PXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_bôm≠_u±od©e
(
bh
);

170 
	`£t_buf„r_u±od©e
(
bh
);

171 
	`£t_buf„r_vîifõd
(
bh
);

172 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

173 
	`u∆ock_buf„r
(
bh
);

174  
bh
;

176 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

178 i‡(
	`buf„r_u±od©e
(
bh
)) {

183 
	`£t_bôm≠_u±od©e
(
bh
);

184 
	`u∆ock_buf„r
(
bh
);

185 
vîify
;

190 
	`åa˚_pxt4_lﬂd_öode_bôm≠
(
sb
, 
block_group
);

191 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

192 
	`gë_bh
(
bh
);

193 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`waô_⁄_buf„r
(
bh
);

195 i‡(!
	`buf„r_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`pxt4_îr‹
(
sb
, "CannotÑead inode bitmap - "

199 
block_group
, 
bôm≠_blk
);

200 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

201 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
vîify
:

206 
îr
 = 
	`pxt4_vÆid©e_öode_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

207 i‡(
îr
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
îr
);

213 
	}
}

231 
	$pxt4_‰ì_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

233 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

234 
is_dúe˘‹y
;

235 
öo
;

236 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

237 
buf„r_hód
 *
bh2
;

238 
pxt4_group_t
 
block_group
;

239 
bô
;

240 
pxt4_group_desc
 *
gdp
;

241 
pxt4_su≥r_block
 *
es
;

242 
pxt4_sb_öfo
 *
sbi
;

243 
Áèl
 = 0, 
îr
, 
cou¡
, 
˛óªd
;

244 
pxt4_group_öfo
 *
gΩ
;

246 i‡(!
sb
) {

247 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d: inode on "

248 "n⁄exi°íàdevi˚\n", 
__func__
, 
__LINE__
);

251 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1) {

252 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
öode
->
i_öo
,

254 
	`©omic_ªad
(&
öode
->
i_cou¡
));

257 i‡(
öode
->
i_∆ök
) {

258 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:Çlink=%d\n",

259 
__func__
, 
__LINE__
, 
öode
->
i_öo
, inode->
i_∆ök
);

262 
sbi
 = 
	`PXT4_SB
(
sb
);

264 
öo
 = 
öode
->
i_öo
;

265 
	`pxt4_debug
("‰ìög inodê%lu\n", 
öo
);

266 
	`åa˚_pxt4_‰ì_öode
(
öode
);

268 
	`dquŸ_öôülize
(
öode
);

269 
	`dquŸ_‰ì_öode
(
öode
);

271 
is_dúe˘‹y
 = 
	`S_ISDIR
(
öode
->
i_mode
);

274 
	`pxt4_˛ór_öode
(
öode
);

276 
es
 = 
sbi
->
s_es
;

277 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

278 
	`pxt4_îr‹
(
sb
, "ª£rved o∏n⁄exi°íàöodê%lu", 
öo
);

279 
îr‹_ªtu∫
;

281 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

282 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

283 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

285 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

286 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

287 
Áèl
 = 
	`PTR_ERR
(
bôm≠_bh
);

288 
bôm≠_bh
 = 
NULL
;

289 
îr‹_ªtu∫
;

291 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))) {

292 
Áèl
 = -
EFSCORRUPTED
;

293 
îr‹_ªtu∫
;

296 
	`BUFFER_TRACE
(
bôm≠_bh
, "get_write_access");

297 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

298 i‡(
Áèl
)

299 
îr‹_ªtu∫
;

301 
Áèl
 = -
ESRCH
;

302 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
bh2
);

303 i‡(
gdp
) {

304 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

305 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh2
);

307 
	`pxt4_lock_group
(
sb
, 
block_group
);

308 
˛óªd
 = 
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
bôm≠_bh
->
b_d©a
);

309 i‡(
Áèl
 || !
˛óªd
) {

310 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

311 
out
;

314 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) + 1;

315 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
cou¡
);

316 i‡(
is_dúe˘‹y
) {

317 
cou¡
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
) - 1;

318 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
cou¡
);

319 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_dús_cou¡î
);

321 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
,

322 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

323 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

324 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

326 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_‰ìöodes_cou¡î
);

327 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

328 
Êex_groups
 *
fg
;

330 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

331 
	`pxt4_Êex_group
(
sbi
, 
block_group
));

332 
	`©omic_öc
(&
fg
->
‰ì_öodes
);

333 i‡(
is_dúe˘‹y
)

334 
	`©omic_dec
(&
fg
->
u£d_dús
);

336 
	`BUFFER_TRACE
(
bh2
, "callÖxt4_handle_dirty_metadata");

337 
Áèl
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh2
);

338 
out
:

339 i‡(
˛óªd
) {

340 
	`BUFFER_TRACE
(
bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

341 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

342 i‡(!
Áèl
)

343 
Áèl
 = 
îr
;

345 
	`pxt4_îr‹
(
sb
, "bôáÃódy cÀ¨ed f‹ inodê%lu", 
öo
);

346 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

347 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

350 
îr‹_ªtu∫
:

351 
	`bªl£
(
bôm≠_bh
);

352 
	`pxt4_°d_îr‹
(
sb
, 
Áèl
);

353 
	}
}

355 
	s‹lov_°©s
 {

356 
__u64
 
	m‰ì_˛u°îs
;

357 
__u32
 
	m‰ì_öodes
;

358 
__u32
 
	mu£d_dús
;

366 
	$gë_‹lov_°©s
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
g
,

367 
Êex_size
, 
‹lov_°©s
 *
°©s
)

369 
pxt4_group_desc
 *
desc
;

371 i‡(
Êex_size
 > 1) {

372 
Êex_groups
 *
fg
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
),

373 
s_Êex_groups
, 
g
);

374 
°©s
->
‰ì_öodes
 = 
	`©omic_ªad
(&
fg
->free_inodes);

375 
°©s
->
‰ì_˛u°îs
 = 
	`©omic64_ªad
(&
fg
->free_clusters);

376 
°©s
->
u£d_dús
 = 
	`©omic_ªad
(&
fg
->used_dirs);

380 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

381 i‡(
desc
) {

382 
°©s
->
‰ì_öodes
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

383 
°©s
->
‰ì_˛u°îs
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

384 
°©s
->
u£d_dús
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
desc
);

386 
°©s
->
‰ì_öodes
 = 0;

387 
°©s
->
‰ì_˛u°îs
 = 0;

388 
°©s
->
u£d_dús
 = 0;

390 
	}
}

413 
	$föd_group_‹lov
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

414 
pxt4_group_t
 *
group
, 
umode_t
 
mode
,

415 c⁄° 
q°r
 *qstr)

417 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

418 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

419 
pxt4_group_t
 
ªÆ_ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

420 
öodes_≥r_group
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

421 
‰ìi
, 
ave‰ìi
, 
gΩ_‰ì
;

422 
pxt4_fsblk_t
 
‰ìb
, 
ave‰ìc
;

423 
ndús
;

424 
max_dús
, 
mö_öodes
;

425 
pxt4_gΩblk_t
 
mö_˛u°îs
;

426 
pxt4_group_t
 
i
, 
gΩ
, 
g
, 
ngroups
;

427 
pxt4_group_desc
 *
desc
;

428 
‹lov_°©s
 
°©s
;

429 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

430 
dx_hash_öfo
 
höfo
;

432 
ngroups
 = 
ªÆ_ngroups
;

433 i‡(
Êex_size
 > 1) {

434 
ngroups
 = (
ªÆ_ngroups
 + 
Êex_size
 - 1) >>

435 
sbi
->
s_log_groups_≥r_Êex
;

436 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

439 
‰ìi
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

440 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

441 
‰ìb
 = 
	`PXT4_C2B
(
sbi
,

442 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

443 
ave‰ìc
 = 
‰ìb
;

444 
	`do_div
(
ave‰ìc
, 
ngroups
);

445 
ndús
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dús_cou¡î
);

447 i‡(
	`S_ISDIR
(
mode
) &&

448 ((
∑ª¡
 =
	`d_öode
(
sb
->
s_roŸ
)) ||

449 (
	`pxt4_ã°_öode_Êag
(
∑ª¡
, 
PXT4_INODE_TOPDIR
)))) {

450 
be°_ndú
 = 
öodes_≥r_group
;

451 
ªt
 = -1;

453 i‡(
q°r
) {

454 
höfo
.
hash_vîsi⁄
 = 
DX_HASH_HALF_MD4
;

455 
höfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

456 
	`pxt4fs_dúhash
(
∑ª¡
, 
q°r
->
«me
, q°r->
Àn
, &
höfo
);

457 
gΩ
 = 
höfo
.
hash
;

459 
gΩ
 = 
	`¥™dom_u32
();

460 
∑ª¡_group
 = ()
gΩ
 % 
ngroups
;

461 
i
 = 0; i < 
ngroups
; i++) {

462 
g
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

463 
	`gë_‹lov_°©s
(
sb
, 
g
, 
Êex_size
, &
°©s
);

464 i‡(!
°©s
.
‰ì_öodes
)

466 i‡(
°©s
.
u£d_dús
 >
be°_ndú
)

468 i‡(
°©s
.
‰ì_öodes
 < 
ave‰ìi
)

470 i‡(
°©s
.
‰ì_˛u°îs
 < 
ave‰ìc
)

472 
gΩ
 = 
g
;

473 
ªt
 = 0;

474 
be°_ndú
 = 
°©s
.
u£d_dús
;

476 i‡(
ªt
)

477 
ÁŒback
;

478 
found_Êex_bg
:

479 i‡(
Êex_size
 == 1) {

480 *
group
 = 
gΩ
;

491 
gΩ
 *
Êex_size
;

492 
i
 = 0; i < 
Êex_size
; i++) {

493 i‡(
gΩ
+
i
 >
ªÆ_ngroups
)

495 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
+
i
, 
NULL
);

496 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

497 *
group
 = 
gΩ
+
i
;

501 
ÁŒback
;

504 
max_dús
 = 
ndús
 / 
ngroups
 + 
öodes_≥r_group
 / 16;

505 
mö_öodes
 = 
ave‰ìi
 - 
öodes_≥r_group
*
Êex_size
 / 4;

506 i‡(
mö_öodes
 < 1)

507 
mö_öodes
 = 1;

508 
mö_˛u°îs
 = 
ave‰ìc
 - 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)*
Êex_size
 / 4;

514 i‡(
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

515 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

516 i‡(
Êex_size
 > 1)

517 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

520 
i
 = 0; i < 
ngroups
; i++) {

521 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

522 
	`gë_‹lov_°©s
(
sb
, 
gΩ
, 
Êex_size
, &
°©s
);

523 i‡(
°©s
.
u£d_dús
 >
max_dús
)

525 i‡(
°©s
.
‰ì_öodes
 < 
mö_öodes
)

527 i‡(
°©s
.
‰ì_˛u°îs
 < 
mö_˛u°îs
)

529 
found_Êex_bg
;

532 
ÁŒback
:

533 
ngroups
 = 
ªÆ_ngroups
;

534 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

535 
ÁŒback_ªåy
:

536 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

537 
i
 = 0; i < 
ngroups
; i++) {

538 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

539 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
, 
NULL
);

540 i‡(
desc
) {

541 
gΩ_‰ì
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

542 i‡(
gΩ_‰ì
 && gΩ_‰ì >
ave‰ìi
) {

543 *
group
 = 
gΩ
;

549 i‡(
ave‰ìi
) {

554 
ave‰ìi
 = 0;

555 
ÁŒback_ªåy
;

559 
	}
}

561 
	$föd_group_Ÿhî
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

562 
pxt4_group_t
 *
group
, 
umode_t
 
mode
)

564 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

565 
pxt4_group_t
 
i
, 
œ°
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

566 
pxt4_group_desc
 *
desc
;

567 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
sb
));

576 i‡(
Êex_size
 > 1) {

577 
ªåy
 = 0;

579 
åy_agaö
:

580 
∑ª¡_group
 &~(
Êex_size
-1);

581 
œ°
 = 
∑ª¡_group
 + 
Êex_size
;

582 i‡(
œ°
 > 
ngroups
)

583 
œ°
 = 
ngroups
;

584 
i
 = 
∑ª¡_group
; i < 
œ°
; i++) {

585 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

586 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

587 *
group
 = 
i
;

591 i‡(!
ªåy
 && 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

592 
ªåy
 = 1;

593 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

594 
åy_agaö
;

601 *
group
 = 
∑ª¡_group
 + 
Êex_size
;

602 i‡(*
group
 > 
ngroups
)

603 *
group
 = 0;

604  
	`föd_group_‹lov
(
sb
, 
∑ª¡
, 
group
, 
mode
, 
NULL
);

610 *
group
 = 
∑ª¡_group
;

611 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

612 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

613 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

625 *
group
 = (*grou∞+ 
∑ª¡
->
i_öo
Ë% 
ngroups
;

631 
i
 = 1; i < 
ngroups
; i <<= 1) {

632 *
group
 +
i
;

633 i‡(*
group
 >
ngroups
)

634 *
group
 -
ngroups
;

635 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

636 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

637 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

645 *
group
 = 
∑ª¡_group
;

646 
i
 = 0; i < 
ngroups
; i++) {

647 i‡(++*
group
 >
ngroups
)

648 *
group
 = 0;

649 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

650 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc))

655 
	}
}

663 
	#RECENTCY_MIN
 5

	)

664 
	#RECENTCY_DIRTY
 300

	)

666 
	$ª˚¡ly_dñëed
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
öo
)

668 
pxt4_group_desc
 *
gdp
;

669 
pxt4_öode
 *
øw_öode
;

670 
buf„r_hód
 *
bh
;

671 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

672 
off£t
, 
ªt
 = 0;

673 
ª˚¡cy
 = 
RECENTCY_MIN
;

674 
u32
 
dtime
, 
now
;

676 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

677 i‡(
	`u∆ikñy
(!
gdp
))

680 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
	`pxt4_öode_èbÀ
(sb, 
gdp
) +

681 (
öo
 / 
öodes_≥r_block
));

682 i‡(!
bh
 || !
	`buf„r_u±od©e
(bh))

687 
out
;

689 
off£t
 = (
öo
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

690 
øw_öode
 = (
pxt4_öode
 *Ë(
bh
->
b_d©a
 + 
off£t
);

696 
dtime
 = 
	`À32_to_˝u
(
øw_öode
->
i_dtime
);

697 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

698 i‡(
	`buf„r_dúty
(
bh
))

699 
ª˚¡cy
 +
RECENTCY_DIRTY
;

701 i‡(
dtime
 && 
	`time_bef‹e32
(dtime, 
now
) &&

702 
	`time_bef‹e32
(
now
, 
dtime
 + 
ª˚¡cy
))

703 
ªt
 = 1;

704 
out
:

705 
	`bªl£
(
bh
);

706  
ªt
;

707 
	}
}

709 
	$föd_öode_bô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

710 
buf„r_hód
 *
bôm≠
, *
öo
)

712 
√xt
:

713 *
öo
 = 
	`pxt4_föd_√xt_zîo_bô
((*)

714 
bôm≠
->
b_d©a
,

715 
	`PXT4_INODES_PER_GROUP
(
sb
), *
öo
);

716 i‡(*
öo
 >
	`PXT4_INODES_PER_GROUP
(
sb
))

719 i‡((
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 =
NULL
) &&

720 
	`ª˚¡ly_dñëed
(
sb
, 
group
, *
öo
)) {

721 *
öo
 = *ino + 1;

722 i‡(*
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

723 
√xt
;

728 
	}
}

740 
öode
 *
	$__pxt4_√w_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

741 
umode_t
 
mode
, c⁄° 
q°r
 *qstr,

742 
__u32
 
gﬂl
, 
uid_t
 *
ow√r
, __u32 
i_Êags
,

743 
h™dÀ_ty≥
, 
löe_no
,

744 
nblocks
)

746 
su≥r_block
 *
sb
;

747 
buf„r_hód
 *
öode_bôm≠_bh
 = 
NULL
;

748 
buf„r_hód
 *
group_desc_bh
;

749 
pxt4_group_t
 
ngroups
, 
group
 = 0;

750 
öo
 = 0;

751 
öode
 *inode;

752 
pxt4_group_desc
 *
gdp
 = 
NULL
;

753 
pxt4_öode_öfo
 *
ei
;

754 
pxt4_sb_öfo
 *
sbi
;

755 
ªt2
, 
îr
;

756 
öode
 *
ªt
;

757 
pxt4_group_t
 
i
;

758 
pxt4_group_t
 
Êex_group
;

759 
pxt4_group_öfo
 *
gΩ
;

760 
í¸y±
 = 0;

763 i‡(!
dú
 || !dú->
i_∆ök
)

764  
	`ERR_PTR
(-
EPERM
);

766 
sb
 = 
dú
->
i_sb
;

767 
sbi
 = 
	`PXT4_SB
(
sb
);

769 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

770  
	`ERR_PTR
(-
EIO
);

772 i‡((
	`IS_ENCRYPTED
(
dú
Ë|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

773 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode)) &&

774 !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

775 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

776 i‡(
îr
)

777  
	`ERR_PTR
(
îr
);

778 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
))

779  
	`ERR_PTR
(-
ENOKEY
);

780 
í¸y±
 = 1;

783 i‡(!
h™dÀ
 && 
sbi
->
s_jou∫Æ
 && !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

784 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


785 
posix_a˛
 *
p
 = 
	`gë_a˛
(
dú
, 
ACL_TYPE_DEFAULT
);

787 i‡(
	`IS_ERR
(
p
))

788  
	`ERR_CAST
(
p
);

789 i‡(
p
) {

790 
a˛_size
 = 
p
->
a_cou¡
 * (
pxt4_a˛_íåy
);

792 
nblocks
 +(
	`S_ISDIR
(
mode
) ? 2 : 1) *

793 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

794 
NULL
 , 
a˛_size
,

795 
åue
 );

796 
	`posix_a˛_ªÀa£
(
p
);

800 #ifde‡
CONFIG_SECURITY


802 
num_£curôy_x©ås
 = 1;

804 #ifde‡
CONFIG_INTEGRITY


805 
num_£curôy_x©ås
++;

812 
nblocks
 +
num_£curôy_x©ås
 *

813 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

814 
NULL
 , 1024,

815 
åue
 );

818 i‡(
í¸y±
)

819 
nblocks
 +
	`__pxt4_x©å_£t_¸edôs
(
sb
,

820 
NULL
 , NULL ,

821 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

822 
åue
 );

825 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

826 
	`åa˚_pxt4_ªque°_öode
(
dú
, 
mode
);

827 
öode
 = 
	`√w_öode
(
sb
);

828 i‡(!
öode
)

829  
	`ERR_PTR
(-
ENOMEM
);

830 
ei
 = 
	`PXT4_I
(
öode
);

837 i‡(
ow√r
) {

838 
öode
->
i_mode
 = 
mode
;

839 
	`i_uid_wrôe
(
öode
, 
ow√r
[0]);

840 
	`i_gid_wrôe
(
öode
, 
ow√r
[1]);

841 } i‡(
	`ã°_›t
(
sb
, 
GRPID
)) {

842 
öode
->
i_mode
 = 
mode
;

843 
öode
->
i_uid
 = 
	`cuºít_fsuid
();

844 
öode
->
i_gid
 = 
dú
->i_gid;

846 
	`öode_öô_ow√r
(
öode
, 
dú
, 
mode
);

848 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

849 
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
))

850 
ei
->
i_¥ojid
 = 
	`PXT4_I
(
dú
)->i_projid;

852 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, 
PXT4_DEF_PROJID
);

854 
îr
 = 
	`dquŸ_öôülize
(
öode
);

855 i‡(
îr
)

856 
out
;

858 i‡(!
gﬂl
)

859 
gﬂl
 = 
sbi
->
s_öode_gﬂl
;

861 i‡(
gﬂl
 && gﬂ»<
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)) {

862 
group
 = (
gﬂl
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

863 
öo
 = (
gﬂl
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

864 
ªt2
 = 0;

865 
gŸ_group
;

868 i‡(
	`S_ISDIR
(
mode
))

869 
ªt2
 = 
	`föd_group_‹lov
(
sb
, 
dú
, &
group
, 
mode
, 
q°r
);

871 
ªt2
 = 
	`föd_group_Ÿhî
(
sb
, 
dú
, &
group
, 
mode
);

873 
gŸ_group
:

874 
	`PXT4_I
(
dú
)->
i_œ°_Æloc_group
 = 
group
;

875 
îr
 = -
ENOSPC
;

876 i‡(
ªt2
 == -1)

877 
out
;

884 
i
 = 0; i < 
ngroups
; i++, 
öo
 = 0) {

885 
îr
 = -
EIO
;

887 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

888 i‡(!
gdp
)

889 
out
;

894 i‡(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) == 0)

895 
√xt_group
;

897 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

899 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

900 
√xt_group
;

902 
	`bªl£
(
öode_bôm≠_bh
);

903 
öode_bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
group
);

905 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) ||

906 
	`IS_ERR
(
öode_bôm≠_bh
)) {

907 
öode_bôm≠_bh
 = 
NULL
;

908 
√xt_group
;

911 
ª≥©_ö_this_group
:

912 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

913 i‡(!
ªt2
)

914 
√xt_group
;

916 i‡(
group
 =0 && (
öo
 + 1Ë< 
	`PXT4_FIRST_INO
(
sb
)) {

917 
	`pxt4_îr‹
(
sb
, "reserved inode found cleared - "

918 "öode=%lu", 
öo
 + 1);

919 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

920 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

921 
√xt_group
;

924 i‡(!
h™dÀ
) {

925 
	`BUG_ON
(
nblocks
 <= 0);

926 
h™dÀ
 = 
	`__pxt4_jou∫Æ_°¨t_sb
(
dú
->
i_sb
, 
löe_no
,

927 
h™dÀ_ty≥
, 
nblocks
, 0,

928 
	`pxt4_å™s_deÁu…_ªvoke_¸edôs
(
sb
));

929 i‡(
	`IS_ERR
(
h™dÀ
)) {

930 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

931 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

932 
out
;

935 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "get_write_access");

936 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
öode_bôm≠_bh
);

937 i‡(
îr
) {

938 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

939 
out
;

941 
	`pxt4_lock_group
(
sb
, 
group
);

942 
ªt2
 = 
	`pxt4_ã°_™d_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

943 i‡(
ªt2
) {

947 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

948 i‡(
ªt2
) {

949 
	`pxt4_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

950 
ªt2
 = 0;

952 
ªt2
 = 1;

955 
	`pxt4_u∆ock_group
(
sb
, 
group
);

956 
öo
++;

957 i‡(!
ªt2
)

958 
gŸ
;

960 i‡(
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

961 
ª≥©_ö_this_group
;

962 
√xt_group
:

963 i‡(++
group
 =
ngroups
)

964 
group
 = 0;

966 
îr
 = -
ENOSPC
;

967 
out
;

969 
gŸ
:

970 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

971 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
öode_bôm≠_bh
);

972 i‡(
îr
) {

973 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

974 
out
;

977 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

978 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
group_desc_bh
);

979 i‡(
îr
) {

980 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

981 
out
;

985 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

986 
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
)) {

987 
buf„r_hód
 *
block_bôm≠_bh
;

989 
block_bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

990 i‡(
	`IS_ERR
(
block_bôm≠_bh
)) {

991 
îr
 = 
	`PTR_ERR
(
block_bôm≠_bh
);

992 
out
;

994 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "get block bitmapáccess");

995 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
block_bôm≠_bh
);

996 i‡(
îr
) {

997 
	`bªl£
(
block_bôm≠_bh
);

998 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

999 
out
;

1002 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "dirty block bitmap");

1003 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
block_bôm≠_bh
);

1006 
	`pxt4_lock_group
(
sb
, 
group
);

1007 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

1008 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

1009 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

1010 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1011 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
gdp
));

1012 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
,

1013 
block_bôm≠_bh
);

1014 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1016 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1017 
	`bªl£
(
block_bôm≠_bh
);

1019 i‡(
îr
) {

1020 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1021 
out
;

1026 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1027 
‰ì
;

1028 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1030 
	`down_ªad
(&
gΩ
->
Æloc_£m
);

1031 
	`pxt4_lock_group
(
sb
, 
group
);

1032 
‰ì
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1033 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1034 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)) {

1035 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_INODE_UNINIT
);

1036 
‰ì
 = 0;

1043 i‡(
öo
 > 
‰ì
)

1044 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1045 (
	`PXT4_INODES_PER_GROUP
(
sb
Ë- 
öo
));

1046 
	`up_ªad
(&
gΩ
->
Æloc_£m
);

1048 
	`pxt4_lock_group
(
sb
, 
group
);

1051 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`pxt4_‰ì_öodes_cou¡
(sb, gdp) - 1);

1052 i‡(
	`S_ISDIR
(
mode
)) {

1053 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
	`pxt4_u£d_dús_cou¡
(sb, gdp) + 1);

1054 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1055 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1057 
	`©omic_öc
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1058 
f
)->
u£d_dús
);

1061 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1062 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
öode_bôm≠_bh
,

1063 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1064 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1066 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1068 
	`BUFFER_TRACE
(
group_desc_bh
, "callÖxt4_handle_dirty_metadata");

1069 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
group_desc_bh
);

1070 i‡(
îr
) {

1071 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1072 
out
;

1075 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_‰ìöodes_cou¡î
);

1076 i‡(
	`S_ISDIR
(
mode
))

1077 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_dús_cou¡î
);

1079 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1080 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1081 
	`©omic_dec
(&
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

1082 
Êex_group
)->
‰ì_öodes
);

1085 
öode
->
i_öo
 = 
öo
 + 
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1087 
öode
->
i_blocks
 = 0;

1088 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1089 
ei
->
i_¸time
 = 
öode
->
i_mtime
;

1091 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1092 
ei
->
i_dú_°¨t_lookup
 = 0;

1093 
ei
->
i_disksize
 = 0;

1096 
ei
->
i_Êags
 =

1097 
	`pxt4_mask_Êags
(
mode
, 
	`PXT4_I
(
dú
)->
i_Êags
 & 
PXT4_FL_INHERITED
);

1098 
ei
->
i_Êags
 |= i_flags;

1099 
ei
->
i_fûe_a˛
 = 0;

1100 
ei
->
i_dtime
 = 0;

1101 
ei
->
i_block_group
 = 
group
;

1102 
ei
->
i_œ°_Æloc_group
 = ~0;

1104 
	`pxt4_£t_öode_Êags
(
öode
);

1105 i‡(
	`IS_DIRSYNC
(
öode
))

1106 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1107 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1112 
îr
 = -
EIO
;

1113 
	`pxt4_îr‹
(
sb
, "failedÅo insert inode %lu: doublyállocated?",

1114 
öode
->
i_öo
);

1115 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

1116 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1117 
out
;

1119 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

1122 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

1123 
__u32
 
csum
;

1124 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

1125 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

1126 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

1127 (
öum
));

1128 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

1129 (
gí
));

1132 
	`pxt4_˛ór_°©e_Êags
(
ei
);

1133 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

1135 
ei
->
i_exåa_isize
 = 
sbi
->
s_w™t_exåa_isize
;

1136 
ei
->
i_ölöe_off
 = 0;

1137 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
))

1138 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1139 
ªt
 = 
öode
;

1140 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

1141 i‡(
îr
)

1142 
Áû_dr›
;

1149 i‡(
í¸y±
) {

1150 
îr
 = 
	`fs¸y±_öhîô_c⁄ãxt
(
dú
, 
öode
, 
h™dÀ
, 
åue
);

1151 i‡(
îr
)

1152 
Áû_‰ì_dr›
;

1155 i‡(!(
ei
->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

1156 
îr
 = 
	`pxt4_öô_a˛
(
h™dÀ
, 
öode
, 
dú
);

1157 i‡(
îr
)

1158 
Áû_‰ì_dr›
;

1160 
îr
 = 
	`pxt4_öô_£curôy
(
h™dÀ
, 
öode
, 
dú
, 
q°r
);

1161 i‡(
îr
)

1162 
Áû_‰ì_dr›
;

1165 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

1167 i‡(
	`S_ISDIR
(
mode
Ë|| 
	`S_ISREG
(modeË|| 
	`S_ISLNK
(mode)) {

1168 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

1169 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

1173 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

1174 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1175 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1178 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1179 i‡(
îr
) {

1180 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1181 
Áû_‰ì_dr›
;

1184 
	`pxt4_debug
("Æloˇtög inodê%lu\n", 
öode
->
i_öo
);

1185 
	`åa˚_pxt4_Æloˇã_öode
(
öode
, 
dú
, 
mode
);

1186 
	`bªl£
(
öode_bôm≠_bh
);

1187  
ªt
;

1189 
Áû_‰ì_dr›
:

1190 
	`dquŸ_‰ì_öode
(
öode
);

1191 
Áû_dr›
:

1192 
	`˛ór_∆ök
(
öode
);

1193 
	`u∆ock_√w_öode
(
öode
);

1194 
out
:

1195 
	`dquŸ_dr›
(
öode
);

1196 
öode
->
i_Êags
 |
S_NOQUOTA
;

1197 
	`ùut
(
öode
);

1198 
	`bªl£
(
öode_bôm≠_bh
);

1199  
	`ERR_PTR
(
îr
);

1200 
	}
}

1203 
öode
 *
	$pxt4_‹ph™_gë
(
su≥r_block
 *
sb
, 
öo
)

1205 
max_öo
 = 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1206 
pxt4_group_t
 
block_group
;

1207 
bô
;

1208 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1209 
öode
 *öodê
NULL
;

1210 
îr
 = -
EFSCORRUPTED
;

1212 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
max_öo
)

1213 
bad_‹ph™
;

1215 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

1216 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

1217 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

1218 i‡(
	`IS_ERR
(
bôm≠_bh
))

1219  
	`ERR_CAST
(
bôm≠_bh
);

1225 i‡(!
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
))

1226 
bad_‹ph™
;

1228 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1229 i‡(
	`IS_ERR
(
öode
)) {

1230 
îr
 = 
	`PTR_ERR
(
öode
);

1231 
	`pxt4_îr‹
(
sb
, "couldn'tÑead orphan inode %lu (err %d)",

1232 
öo
, 
îr
);

1233  
öode
;

1242 i‡((
öode
->
i_∆ök
 && !
	`pxt4_ˇn_åunˇã
(inode)) ||

1243 
	`is_bad_öode
(
öode
))

1244 
bad_‹ph™
;

1246 i‡(
	`NEXT_ORPHAN
(
öode
Ë> 
max_öo
)

1247 
bad_‹ph™
;

1248 
	`bªl£
(
bôm≠_bh
);

1249  
öode
;

1251 
bad_‹ph™
:

1252 
	`pxt4_îr‹
(
sb
, "bad oΩh™ inodê%lu", 
öo
);

1253 i‡(
bôm≠_bh
)

1254 
	`¥ötk
(
KERN_ERR
 "pxt4_test_bit(bit=%d, block=%llu) = %d\n",

1255 
bô
, ()
bôm≠_bh
->
b_blockƒ
,

1256 
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
));

1257 i‡(
öode
) {

1258 
	`¥ötk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1259 
	`is_bad_öode
(
öode
));

1260 
	`¥ötk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1261 
	`NEXT_ORPHAN
(
öode
));

1262 
	`¥ötk
(
KERN_ERR
 "max_öo=%lu\n", 
max_öo
);

1263 
	`¥ötk
(
KERN_ERR
 "i_∆ök=%u\n", 
öode
->
i_∆ök
);

1265 i‡(
öode
->
i_∆ök
 == 0)

1266 
öode
->
i_blocks
 = 0;

1267 
	`ùut
(
öode
);

1269 
	`bªl£
(
bôm≠_bh
);

1270  
	`ERR_PTR
(
îr
);

1271 
	}
}

1273 
	$pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *
sb
)

1275 
desc_cou¡
;

1276 
pxt4_group_desc
 *
gdp
;

1277 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1278 #ifde‡
PXT4FS_DEBUG


1279 
pxt4_su≥r_block
 *
es
;

1280 
bôm≠_cou¡
, 
x
;

1281 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1283 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1284 
desc_cou¡
 = 0;

1285 
bôm≠_cou¡
 = 0;

1286 
gdp
 = 
NULL
;

1287 
i
 = 0; i < 
ngroups
; i++) {

1288 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1289 i‡(!
gdp
)

1291 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1292 
	`bªl£
(
bôm≠_bh
);

1293 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
i
);

1294 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

1295 
bôm≠_bh
 = 
NULL
;

1299 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

1300 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1301 
	`¥ötk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1302 (Ë
i
, 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), 
x
);

1303 
bôm≠_cou¡
 +
x
;

1305 
	`bªl£
(
bôm≠_bh
);

1306 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_inodes: "

1308 
	`À32_to_˝u
(
es
->
s_‰ì_öodes_cou¡
), 
desc_cou¡
, 
bôm≠_cou¡
);

1309  
desc_cou¡
;

1311 
desc_cou¡
 = 0;

1312 
i
 = 0; i < 
ngroups
; i++) {

1313 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1314 i‡(!
gdp
)

1316 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1317 
	`c⁄d_ªsched
();

1319  
desc_cou¡
;

1321 
	}
}

1324 
	$pxt4_cou¡_dús
(
su≥r_block
 * 
sb
)

1326 
cou¡
 = 0;

1327 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1329 
i
 = 0; i < 
ngroups
; i++) {

1330 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1331 i‡(!
gdp
)

1333 
cou¡
 +
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
);

1335  
cou¡
;

1336 
	}
}

1346 
	$pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1347 
b¨rõr
)

1349 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_group_desc
 *
gdp
 = 
NULL
;

1352 
buf„r_hód
 *
group_desc_bh
;

1353 
h™dÀ_t
 *
h™dÀ
;

1354 
pxt4_fsblk_t
 
blk
;

1355 
num
, 
ªt
 = 0, 
u£d_blks
 = 0;

1358 i‡(
	`sb_rd⁄ly
(
sb
)) {

1359 
ªt
 = 1;

1360 
out
;

1363 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 i‡(!
gdp
)

1365 
out
;

1371 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1375 i‡(
	`IS_ERR
(
h™dÀ
)) {

1376 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1377 
out
;

1380 
	`down_wrôe
(&
gΩ
->
Æloc_£m
);

1386 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)))

1387 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)),

1389 
sbi
->
s_öodes_≥r_block
);

1391 i‡((
u£d_blks
 < 0Ë|| (u£d_blk†> 
sbi
->
s_ôb_≥r_group
) ||

1392 ((
group
 =0Ë&& ((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1393 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)) <

1394 
	`PXT4_FIRST_INO
(
sb
)))) {

1395 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1398 
group
, 
u£d_blks
,

1399 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
));

1400 
ªt
 = 1;

1401 
îr_out
;

1404 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ 
u£d_blks
;

1405 
num
 = 
sbi
->
s_ôb_≥r_group
 - 
u£d_blks
;

1407 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1408 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1409 
group_desc_bh
);

1410 i‡(
ªt
)

1411 
îr_out
;

1418 i‡(
	`u∆ikñy
(
num
 == 0))

1419 
skù_zîoout
;

1421 
	`pxt4_debug
("goingÅo zero out inodeÅable in group %d\n",

1422 
group
);

1423 
ªt
 = 
	`sb_issue_zîoout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1424 i‡(
ªt
 < 0)

1425 
îr_out
;

1426 i‡(
b¨rõr
)

1427 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1429 
skù_zîoout
:

1430 
	`pxt4_lock_group
(
sb
, 
group
);

1431 
gdp
->
bg_Êags
 |
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
);

1432 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1433 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1435 
	`BUFFER_TRACE
(
group_desc_bh
,

1437 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1438 
group_desc_bh
);

1440 
îr_out
:

1441 
	`up_wrôe
(&
gΩ
->
Æloc_£m
);

1442 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1443 
out
:

1444  
ªt
;

1445 
	}
}

	@indirect.c

24 
	~"pxt4_jbd3.h
"

25 
	~"åunˇã.h
"

26 
	~<löux/dax.h
>

27 
	~<löux/uio.h
>

29 
	~<åa˚/evíts/pxt4.h
>

32 
__À32
 *
	mp
;

33 
__À32
 
	mkey
;

34 
buf„r_hód
 *
	mbh
;

35 } 
	tIndúe˘
;

37 
ölöe
 
	$add_chaö
(
Indúe˘
 *
p
, 
buf„r_hód
 *
bh
, 
__À32
 *
v
)

39 
p
->
key
 = *’->∞
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$pxt4_block_to_∑th
(
öode
 *inode,

75 
pxt4_lblk_t
 
i_block
,

76 
pxt4_lblk_t
 
off£ts
[4], *
bound¨y
)

78 
±rs
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

79 
±rs_bôs
 = 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
);

80 c⁄° 
dúe˘_blocks
 = 
PXT4_NDIR_BLOCKS
,

81 
ödúe˘_blocks
 = 
±rs
,

82 
doubÀ_blocks
 = (1 << (
±rs_bôs
 * 2));

83 
n
 = 0;

84 
föÆ
 = 0;

86 i‡(
i_block
 < 
dúe˘_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
föÆ
 = 
dúe˘_blocks
;

89 } i‡((
i_block
 -
dúe˘_blocks
Ë< 
ödúe˘_blocks
) {

90 
off£ts
[
n
++] = 
PXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
föÆ
 = 
±rs
;

93 } i‡((
i_block
 -
ödúe˘_blocks
Ë< 
doubÀ_blocks
) {

94 
off£ts
[
n
++] = 
PXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_bôs
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
föÆ
 = 
±rs
;

98 } i‡(((
i_block
 -
doubÀ_blocks
Ë>> (
±rs_bôs
 * 2)Ë< 
±rs
) {

99 
off£ts
[
n
++] = 
PXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_bôs
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_bôs
Ë& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
föÆ
 = 
±rs
;

105 
	`pxt4_w¨nög
(
öode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dúe˘_blocks
 +

107 
ödúe˘_blocks
 + 
doubÀ_blocks
, 
öode
->
i_öo
);

109 i‡(
bound¨y
)

110 *
bound¨y
 = 
föÆ
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indúe˘
 *
	$pxt4_gë_bønch
(
öode
 *öode, 
dïth
,

145 
pxt4_lblk_t
 *
off£ts
,

146 
Indúe˘
 
chaö
[4], *
îr
)

148 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

149 
Indúe˘
 *
p
 = 
chaö
;

150 
buf„r_hód
 *
bh
;

151 
ªt
 = -
EIO
;

153 *
îr
 = 0;

155 
	`add_chaö
(
chaö
, 
NULL
, 
	`PXT4_I
(
öode
)->
i_d©a
 + *
off£ts
);

156 i‡(!
p
->
key
)

157 
no_block
;

158 --
dïth
) {

159 
bh
 = 
	`sb_gëblk
(
sb
, 
	`À32_to_˝u
(
p
->
key
));

160 i‡(
	`u∆ikñy
(!
bh
)) {

161 
ªt
 = -
ENOMEM
;

162 
Áûuª
;

165 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

166 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
Áûuª
;

171 i‡(
	`pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
Áûuª
;

177 
	`add_chaö
(++
p
, 
bh
, (
__À32
 *)bh->
b_d©a
 + *++
off£ts
);

179 i‡(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
Áûuª
:

185 *
îr
 = 
ªt
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
pxt4_fsblk_t
 
	$pxt4_föd_√¨
(
öode
 *öode, 
Indúe˘
 *
öd
)

212 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

213 
__À32
 *
°¨t
 = 
öd
->
bh
 ? (__À32 *Ëöd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__À32
 *
p
;

217 
p
 = 
öd
->∞- 1;Ö >
°¨t
;Ö--) {

218 i‡(*
p
)

219  
	`À32_to_˝u
(*
p
);

223 i‡(
öd
->
bh
)

224  
öd
->
bh
->
b_blockƒ
;

230  
	`pxt4_öode_to_gﬂl_block
(
öode
);

231 
	}
}

244 
pxt4_fsblk_t
 
	$pxt4_föd_gﬂl
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

245 
Indúe˘
 *
∑πül
)

247 
pxt4_fsblk_t
 
gﬂl
;

253 
gﬂl
 = 
	`pxt4_föd_√¨
(
öode
, 
∑πül
);

254 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

255  
gﬂl
;

256 
	}
}

270 
	$pxt4_blks_to_Æloˇã
(
Indúe˘
 *
bønch
, 
k
, 
blks
,

271 
blocks_to_bound¨y
)

273 
cou¡
 = 0;

279 i‡(
k
 > 0) {

281 i‡(
blks
 < 
blocks_to_bound¨y
 + 1)

282 
cou¡
 +
blks
;

284 
cou¡
 +
blocks_to_bound¨y
 + 1;

285  
cou¡
;

288 
cou¡
++;

289 
cou¡
 < 
blks
 && cou¡ <
blocks_to_bound¨y
 &&

290 
	`À32_to_˝u
(*(
bønch
[0].
p
 + 
cou¡
)) == 0) {

291 
cou¡
++;

293  
cou¡
;

294 
	}
}

321 
	$pxt4_Æloc_bønch
(
h™dÀ_t
 *
h™dÀ
,

322 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

323 
ödúe˘_blks
, 
pxt4_lblk_t
 *
off£ts
,

324 
Indúe˘
 *
bønch
)

326 
buf„r_hód
 * 
bh
;

327 
pxt4_fsblk_t
 
b
, 
√w_blocks
[4];

328 
__À32
 *
p
;

329 
i
, 
j
, 
îr
, 
Àn
 = 1;

331 
i
 = 0; i <
ödúe˘_blks
; i++) {

332 i‡(
i
 =
ödúe˘_blks
) {

333 
√w_blocks
[
i
] = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, 
¨
, &
îr
);

335 
¨
->
gﬂl
 = 
√w_blocks
[
i
] = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
,

336 
¨
->
öode
,ár->
gﬂl
,

337 
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
,

338 
NULL
, &
îr
);

340 
bønch
[
i
+1].
bh
 = 
NULL
;

342 i‡(
îr
) {

343 
i
--;

344 
Áûed
;

346 
bønch
[
i
].
key
 = 
	`˝u_to_À32
(
√w_blocks
[i]);

347 i‡(
i
 == 0)

350 
bh
 = 
bønch
[
i
].bh = 
	`sb_gëblk
(
¨
->
öode
->
i_sb
, 
√w_blocks
[i-1]);

351 i‡(
	`u∆ikñy
(!
bh
)) {

352 
îr
 = -
ENOMEM
;

353 
Áûed
;

355 
	`lock_buf„r
(
bh
);

356 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

357 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

358 i‡(
îr
) {

359 
	`u∆ock_buf„r
(
bh
);

360 
Áûed
;

363 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

364 
p
 = 
bønch
[
i
].∞(
__À32
 *Ë
bh
->
b_d©a
 + 
off£ts
[i];

365 
b
 = 
√w_blocks
[
i
];

367 i‡(
i
 =
ödúe˘_blks
)

368 
Àn
 = 
¨
->len;

369 
j
 = 0; j < 
Àn
; j++)

370 *
p
++ = 
	`˝u_to_À32
(
b
++);

372 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

373 
	`£t_buf„r_u±od©e
(
bh
);

374 
	`u∆ock_buf„r
(
bh
);

376 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

377 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
bh
);

378 i‡(
îr
)

379 
Áûed
;

382 
Áûed
:

383 i‡(
i
 =
ödúe˘_blks
) {

385 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
√w_blocks
[
i
],

386 
¨
->
Àn
, 0);

387 
i
--;

389 ; 
i
 >= 0; i--) {

399 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
bønch
[
i
+1].
bh
,

400 
√w_blocks
[
i
], 1,

401 
bønch
[
i
+1].
bh
 ? 
PXT4_FREE_BLOCKS_FORGET
 : 0);

403  
îr
;

404 
	}
}

417 
	$pxt4_•li˚_bønch
(
h™dÀ_t
 *
h™dÀ
,

418 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

419 
Indúe˘
 *
whîe
, 
num
)

421 
i
;

422 
îr
 = 0;

423 
pxt4_fsblk_t
 
cuºít_block
;

430 i‡(
whîe
->
bh
) {

431 
	`BUFFER_TRACE
(
whîe
->
bh
, "get_write_access");

432 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
whîe
->
bh
);

433 i‡(
îr
)

434 
îr_out
;

438 *
whîe
->
p
 = whîe->
key
;

444 i‡(
num
 =0 && 
¨
->
Àn
 > 1) {

445 
cuºít_block
 = 
	`À32_to_˝u
(
whîe
->
key
) + 1;

446 
i
 = 1; i < 
¨
->
Àn
; i++)

447 *(
whîe
->
p
 + 
i
Ë
	`˝u_to_À32
(
cuºít_block
++);

452 i‡(
whîe
->
bh
) {

461 
	`jbd_debug
(5, "splicing indirect only\n");

462 
	`BUFFER_TRACE
(
whîe
->
bh
, "callÖxt4_handle_dirty_metadata");

463 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
whîe
->
bh
);

464 i‡(
îr
)

465 
îr_out
;

470 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
¨
->
öode
);

471 
	`jbd_debug
(5, "splicing direct\n");

473  
îr
;

475 
îr_out
:

476 
i
 = 1; i <
num
; i++) {

482 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
whîe
[
i
].
bh
, 0, 1,

483 
PXT4_FREE_BLOCKS_FORGET
);

485 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
	`À32_to_˝u
(
whîe
[
num
].
key
),

486 
¨
->
Àn
, 0);

488  
îr
;

489 
	}
}

519 
	$pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

520 
pxt4_m≠_blocks
 *
m≠
,

521 
Êags
)

523 
pxt4_Æloˇti⁄_ªque°
 
¨
;

524 
îr
 = -
EIO
;

525 
pxt4_lblk_t
 
off£ts
[4];

526 
Indúe˘
 
chaö
[4];

527 
Indúe˘
 *
∑πül
;

528 
ödúe˘_blks
;

529 
blocks_to_bound¨y
 = 0;

530 
dïth
;

531 
cou¡
 = 0;

532 
pxt4_fsblk_t
 
fú°_block
 = 0;

534 
	`åa˚_pxt4_öd_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

535 
	`J_ASSERT
(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)));

536 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || (
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0);

537 
dïth
 = 
	`pxt4_block_to_∑th
(
öode
, 
m≠
->
m_lblk
, 
off£ts
,

538 &
blocks_to_bound¨y
);

540 i‡(
dïth
 == 0)

541 
out
;

543 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
dïth
, 
off£ts
, 
chaö
, &
îr
);

546 i‡(!
∑πül
) {

547 
fú°_block
 = 
	`À32_to_˝u
(
chaö
[
dïth
 - 1].
key
);

548 
cou¡
++;

550 
cou¡
 < 
m≠
->
m_Àn
 && cou¡ <
blocks_to_bound¨y
) {

551 
pxt4_fsblk_t
 
blk
;

553 
blk
 = 
	`À32_to_˝u
(*(
chaö
[
dïth
-1].
p
 + 
cou¡
));

555 i‡(
blk
 =
fú°_block
 + 
cou¡
)

556 
cou¡
++;

560 
gŸ_ô
;

564 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

565 
ïb
 = 
öode
->
i_sb
->
s_blocksize
 / (
u32
);

566 
i
;

574 
cou¡
 = 0;

575 
i
 = 
∑πül
 - 
chaö
 + 1; i < 
dïth
; i++)

576 
cou¡
 = cou¡ * 
ïb
 + (ïb - 
off£ts
[
i
] - 1);

577 
cou¡
++;

579 
m≠
->
m_pblk
 = 0;

580 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
cou¡
);

581 
˛ónup
;

585 i‡(
îr
 =-
EIO
)

586 
˛ónup
;

591 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
)) {

592 
	`PXT4_ERROR_INODE
(
öode
, "Can'tállocate blocks for "

594  -
EFSCORRUPTED
;

598 
	`mem£t
(&
¨
, 0, (ar));

599 
¨
.
öode
 = inode;

600 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

601 i‡(
	`S_ISREG
(
öode
->
i_mode
))

602 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

603 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

604 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

605 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

606 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

608 
¨
.
gﬂl
 = 
	`pxt4_föd_gﬂl
(
öode
, 
m≠
->
m_lblk
, 
∑πül
);

611 
ödúe˘_blks
 = (
chaö
 + 
dïth
Ë- 
∑πül
 - 1;

617 
¨
.
Àn
 = 
	`pxt4_blks_to_Æloˇã
(
∑πül
, 
ödúe˘_blks
,

618 
m≠
->
m_Àn
, 
blocks_to_bound¨y
);

623 
îr
 = 
	`pxt4_Æloc_bønch
(
h™dÀ
, &
¨
, 
ödúe˘_blks
,

624 
off£ts
 + (
∑πül
 - 
chaö
),Öartial);

633 i‡(!
îr
)

634 
îr
 = 
	`pxt4_•li˚_bønch
(
h™dÀ
, &
¨
, 
∑πül
, 
ödúe˘_blks
);

635 i‡(
îr
)

636 
˛ónup
;

638 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

640 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

641 
cou¡
 = 
¨
.
Àn
;

642 
gŸ_ô
:

643 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

644 
m≠
->
m_pblk
 = 
	`À32_to_˝u
(
chaö
[
dïth
-1].
key
);

645 
m≠
->
m_Àn
 = 
cou¡
;

646 i‡(
cou¡
 > 
blocks_to_bound¨y
)

647 
m≠
->
m_Êags
 |
PXT4_MAP_BOUNDARY
;

648 
îr
 = 
cou¡
;

650 
∑πül
 = 
chaö
 + 
dïth
 - 1;

651 
˛ónup
:

652 
∑πül
 > 
chaö
) {

653 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

654 
	`bªl£
(
∑πül
->
bh
);

655 
∑πül
--;

657 
out
:

658 
	`åa˚_pxt4_öd_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
, 
îr
);

659  
îr
;

660 
	}
}

666 
	$pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
)

668 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

669 
£˘‹_t
 
död_mask
 = ~((£˘‹_t)
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
) - 1);

670 
blk_bôs
;

672 i‡(
lblock
 < 
PXT4_NDIR_BLOCKS
)

675 
lblock
 -
PXT4_NDIR_BLOCKS
;

677 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

678 (
lblock
 & 
död_mask
Ë=
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
) {

679 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

682 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
 & 
död_mask
;

683 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

684 
blk_bôs
 = 
	`‹dî_ba£_2
(
lblock
);

685  (
blk_bôs
 / 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
)) + 1;

686 
	}
}

692 
	$pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

699  
	`DIV_ROUND_UP
(
ƒblocks
, 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
)) + 4;

700 
	}
}

702 
	$pxt4_öd_åunc_ª°¨t_‚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

703 
buf„r_hód
 *
bh
, *
dr›≥d
)

705 
îr
;

707 i‡(
bh
) {

708 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

709 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

710 i‡(
	`u∆ikñy
(
îr
))

711  
îr
;

713 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

714 i‡(
	`u∆ikñy
(
îr
))

715  
îr
;

722 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

723 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

724 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

725 *
dr›≥d
 = 1;

727 
	}
}

737 
	$pxt4_öd_åunˇã_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
,

738 
öode
 *inode,

739 
buf„r_hód
 *
bh
,

740 
ªvoke_¸eds
)

742 
ªt
;

743 
dr›≥d
 = 0;

745 
ªt
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
,

746 
	`pxt4_blocks_f‹_åunˇã
(
öode
), 
ªvoke_¸eds
,

747 
	`pxt4_öd_åunc_ª°¨t_‚
(
h™dÀ
, 
öode
, 
bh
, &
dr›≥d
));

748 i‡(
dr›≥d
)

749 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

750 i‡(
ªt
 <= 0)

751  
ªt
;

752 i‡(
bh
) {

753 
	`BUFFER_TRACE
(
bh
, "retaking writeáccess");

754 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

755 i‡(
	`u∆ikñy
(
ªt
))

756  
ªt
;

759 
	}
}

766 
ölöe
 
	$Æl_zî€s
(
__À32
 *
p
, __À32 *
q
)

768 
p
 < 
q
)

769 i‡(*
p
++)

772 
	}
}

809 
Indúe˘
 *
	$pxt4_föd_sh¨ed
(
öode
 *öode, 
dïth
,

810 
pxt4_lblk_t
 
off£ts
[4], 
Indúe˘
 
chaö
[4],

811 
__À32
 *
t›
)

813 
Indúe˘
 *
∑πül
, *
p
;

814 
k
, 
îr
;

816 *
t›
 = 0;

818 
k
 = 
dïth
; k > 1 && !
off£ts
[k-1]; k--)

820 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
k
, 
off£ts
, 
chaö
, &
îr
);

822 i‡(!
∑πül
)

823 
∑πül
 = 
chaö
 + 
k
-1;

828 i‡(!
∑πül
->
key
 && *∑πül->
p
)

830 
no_t›
;

831 
p
 = 
∑πül
; (∞> 
chaö
Ë&& 
	`Æl_zî€s
((
__À32
 *Ëp->
bh
->
b_d©a
,Ö->p);Ö--)

839 i‡(
p
 =
chaö
 + 
k
 - 1 &&Ö > chain) {

840 
p
->p--;

842 *
t›
 = *
p
->p;

845 *
p
->p = 0;

850 
∑πül
 > 
p
) {

851 
	`bªl£
(
∑πül
->
bh
);

852 
∑πül
--;

854 
no_t›
:

855  
∑πül
;

856 
	}
}

869 
	$pxt4_˛ór_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

870 
buf„r_hód
 *
bh
,

871 
pxt4_fsblk_t
 
block_to_‰ì
,

872 
cou¡
, 
__À32
 *
fú°
,

873 
__À32
 *
œ°
)

875 
__À32
 *
p
;

876 
Êags
 = 
PXT4_FREE_BLOCKS_VALIDATED
;

877 
îr
;

879 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

880 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

881 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
 | 
PXT4_FREE_BLOCKS_METADATA
;

882 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

883 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
;

885 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block_to_‰ì
,

886 
cou¡
)) {

887 
	`PXT4_ERROR_INODE
(
öode
, "attemptÅo clear invalid "

889 (Ë
block_to_‰ì
, 
cou¡
);

893 
îr
 = 
	`pxt4_öd_åunˇã_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
bh
,

894 
	`pxt4_‰ì_d©a_ªvoke_¸edôs
(
öode
, 
cou¡
));

895 i‡(
îr
 < 0)

896 
out_îr
;

898 
p
 = 
fú°
;Ö < 
œ°
;Ö++)

899 *
p
 = 0;

901 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block_to_‰ì
, 
cou¡
, 
Êags
);

903 
out_îr
:

904 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

905  
îr
;

906 
	}
}

927 
	$pxt4_‰ì_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

928 
buf„r_hód
 *
this_bh
,

929 
__À32
 *
fú°
, __À32 *
œ°
)

931 
pxt4_fsblk_t
 
block_to_‰ì
 = 0;

932 
cou¡
 = 0;

933 
__À32
 *
block_to_‰ì_p
 = 
NULL
;

936 
pxt4_fsblk_t
 
ƒ
;

937 
__À32
 *
p
;

939 
îr
 = 0;

941 i‡(
this_bh
) {

942 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

943 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
this_bh
);

946 i‡(
îr
)

950 
p
 = 
fú°
;Ö < 
œ°
;Ö++) {

951 
ƒ
 = 
	`À32_to_˝u
(*
p
);

952 i‡(
ƒ
) {

954 i‡(
cou¡
 == 0) {

955 
block_to_‰ì
 = 
ƒ
;

956 
block_to_‰ì_p
 = 
p
;

957 
cou¡
 = 1;

958 } i‡(
ƒ
 =
block_to_‰ì
 + 
cou¡
) {

959 
cou¡
++;

961 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
,

962 
block_to_‰ì
, 
cou¡
,

963 
block_to_‰ì_p
, 
p
);

964 i‡(
îr
)

966 
block_to_‰ì
 = 
ƒ
;

967 
block_to_‰ì_p
 = 
p
;

968 
cou¡
 = 1;

973 i‡(!
îr
 && 
cou¡
 > 0)

974 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
, 
block_to_‰ì
,

975 
cou¡
, 
block_to_‰ì_p
, 
p
);

976 i‡(
îr
 < 0)

980 i‡(
this_bh
) {

981 
	`BUFFER_TRACE
(
this_bh
, "callÖxt4_handle_dirty_metadata");

989 i‡((
	`PXT4_JOURNAL
(
öode
Ë=
NULL
Ë|| 
	`bh2jh
(
this_bh
))

990 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
this_bh
);

992 
	`PXT4_ERROR_INODE
(
öode
,

995 (Ë
this_bh
->
b_blockƒ
);

997 
	}
}

1012 
	$pxt4_‰ì_bønches
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1013 
buf„r_hód
 *
∑ª¡_bh
,

1014 
__À32
 *
fú°
, __À32 *
œ°
, 
dïth
)

1016 
pxt4_fsblk_t
 
ƒ
;

1017 
__À32
 *
p
;

1019 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1022 i‡(
dïth
--) {

1023 
buf„r_hód
 *
bh
;

1024 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1025 
p
 = 
œ°
;

1026 --
p
 >
fú°
) {

1027 
ƒ
 = 
	`À32_to_˝u
(*
p
);

1028 i‡(!
ƒ
)

1031 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

1032 
ƒ
, 1)) {

1033 
	`PXT4_ERROR_INODE
(
öode
,

1036 (Ë
ƒ
, 
dïth
);

1041 
bh
 = 
	`sb_bªad
(
öode
->
i_sb
, 
ƒ
);

1047 i‡(!
bh
) {

1048 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ƒ
,

1054 
	`BUFFER_TRACE
(
bh
, "free child branches");

1055 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
bh
,

1056 (
__À32
 *Ë
bh
->
b_d©a
,

1057 (
__À32
 *Ë
bh
->
b_d©a
 + 
addr_≥r_block
,

1058 
dïth
);

1059 
	`bªl£
(
bh
);

1077 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1079 i‡(
	`pxt4_öd_åunˇã_ísuª_¸edôs
(
h™dÀ
, 
öode
,

1080 
NULL
,

1081 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(

1082 
öode
->
i_sb
, 1)) < 0)

1096 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1097 
PXT4_FREE_BLOCKS_METADATA
|

1098 
PXT4_FREE_BLOCKS_FORGET
);

1100 i‡(
∑ª¡_bh
) {

1105 
	`BUFFER_TRACE
(
∑ª¡_bh
, "get_write_access");

1106 i‡(!
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1107 
∑ª¡_bh
)){

1108 *
p
 = 0;

1109 
	`BUFFER_TRACE
(
∑ª¡_bh
,

1111 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1112 
öode
,

1113 
∑ª¡_bh
);

1119 
	`BUFFER_TRACE
(
∑ª¡_bh
, "free data blocks");

1120 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
∑ª¡_bh
, 
fú°
, 
œ°
);

1122 
	}
}

1124 
	$pxt4_öd_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1126 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1127 
__À32
 *
i_d©a
 = 
ei
->i_data;

1128 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1129 
pxt4_lblk_t
 
off£ts
[4];

1130 
Indúe˘
 
chaö
[4];

1131 
Indúe˘
 *
∑πül
;

1132 
__À32
 
ƒ
 = 0;

1133 
n
 = 0;

1134 
pxt4_lblk_t
 
œ°_block
, 
max_block
;

1135 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1137 
œ°_block
 = (
öode
->
i_size
 + 
blocksize
-1)

1138 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1139 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1140 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1142 i‡(
œ°_block
 !
max_block
) {

1143 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
œ°_block
, 
off£ts
, 
NULL
);

1144 i‡(
n
 == 0)

1148 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 -Üast_block);

1157 
ei
->
i_disksize
 = 
öode
->
i_size
;

1159 i‡(
œ°_block
 =
max_block
) {

1165 } i‡(
n
 == 1) {

1166 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1167 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1168 
do_ödúe˘s
;

1171 
∑πül
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1173 i‡(
ƒ
) {

1174 i‡(
∑πül
 =
chaö
) {

1176 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1177 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1178 *
∑πül
->
p
 = 0;

1185 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1186 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1187 
∑πül
->
p
,

1188 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1192 
∑πül
 > 
chaö
) {

1193 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,Ö¨tül->
p
 + 1,

1194 (
__À32
*)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1195 (
chaö
+
n
-1Ë- 
∑πül
);

1196 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

1197 
	`bªl£
(
∑πül
->
bh
);

1198 
∑πül
--;

1200 
do_ödúe˘s
:

1202 
off£ts
[0]) {

1204 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1205 i‡(
ƒ
) {

1206 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1207 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1210 
PXT4_IND_BLOCK
:

1211 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1212 i‡(
ƒ
) {

1213 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1214 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1217 
PXT4_DIND_BLOCK
:

1218 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1219 i‡(
ƒ
) {

1220 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1221 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1224 
PXT4_TIND_BLOCK
:

1227 
	}
}

1239 
	$pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1240 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

1242 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1243 
__À32
 *
i_d©a
 = 
ei
->i_data;

1244 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1245 
pxt4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1246 
Indúe˘
 
chaö
[4], 
chaö2
[4];

1247 
Indúe˘
 *
∑πül
, *
∑πül2
;

1248 
Indúe˘
 *
p
 = 
NULL
, *
p2
 = NULL;

1249 
pxt4_lblk_t
 
max_block
;

1250 
__À32
 
ƒ
 = 0, 
ƒ2
 = 0;

1251 
n
 = 0, 
n2
 = 0;

1252 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1254 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1255 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1256 i‡(
íd
 >
max_block
)

1257 
íd
 = 
max_block
;

1258 i‡((
°¨t
 >
íd
Ë|| (°¨à> 
max_block
))

1261 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
°¨t
, 
off£ts
, 
NULL
);

1262 
n2
 = 
	`pxt4_block_to_∑th
(
öode
, 
íd
, 
off£ts2
, 
NULL
);

1264 
	`BUG_ON
(
n
 > 
n2
);

1266 i‡((
n
 =1Ë&& (¿=
n2
)) {

1268 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1269 
i_d©a
 + 
off£ts2
[0]);

1271 } i‡(
n2
 > 
n
) {

1279 i‡(
n
 == 1) {

1284 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1285 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1286 
íd_ønge
;

1290 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1291 i‡(
ƒ
) {

1292 i‡(
∑πül
 =
chaö
) {

1294 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1295 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1296 *
∑πül
->
p
 = 0;

1299 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1300 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1301 
∑πül
->
p
,

1302 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1310 
∑πül
 > 
chaö
) {

1311 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1312 
∑πül
->
p
 + 1,

1313 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1314 (
chaö
+
n
-1Ë- 
∑πül
);

1315 
∑πül
--;

1318 
íd_ønge
:

1319 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1320 i‡(
ƒ2
) {

1321 i‡(
∑πül2
 =
chaö2
) {

1328 
do_ödúe˘s
;

1337 
∑πül2
->
p
++;

1344 
∑πül2
 > 
chaö2
) {

1345 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1346 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1347 
∑πül2
->
p
,

1348 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1349 
∑πül2
--;

1351 
do_ödúe˘s
;

1355 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1356 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1359 i‡(
ƒ
) {

1360 
Àvñ
 = 
	`mö
(
∑πül
 - 
chaö
, 
∑πül2
 - 
chaö2
);

1361 
i
;

1362 
subåì
 = 1;

1364 
i
 = 0; i <
Àvñ
; i++) {

1365 i‡(
off£ts
[
i
] !
off£ts2
[i]) {

1366 
subåì
 = 0;

1371 i‡(!
subåì
) {

1372 i‡(
∑πül
 =
chaö
) {

1374 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1375 &
ƒ
, &nr+1,

1376 (
chaö
+
n
-1Ë- 
∑πül
);

1377 *
∑πül
->
p
 = 0;

1380 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1381 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1382 
∑πül
->
p
,

1383 
∑πül
->
p
+1,

1384 (
chaö
+
n
-1Ë- 
∑πül
);

1389 i‡(!
ƒ2
) {

1396 
∑πül2
->
p
++;

1399 
∑πül
 > 
chaö
 || 
∑πül2
 > 
chaö2
) {

1400 
dïth
 = (
chaö
+
n
-1Ë- 
∑πül
;

1401 
dïth2
 = (
chaö2
+
n2
-1Ë- 
∑πül2
;

1403 i‡(
∑πül
 > 
chaö
 && 
∑πül2
 > 
chaö2
 &&

1404 
∑πül
->
bh
->
b_blockƒ
 =
∑πül2
->bh->b_blocknr) {

1409 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1410 
∑πül
->
p
 + 1,

1411 
∑πül2
->
p
,

1412 (
chaö
+
n
-1Ë- 
∑πül
);

1413 
˛ónup
;

1423 i‡(
∑πül
 > 
chaö
 && 
dïth
 <
dïth2
) {

1424 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1425 
∑πül
->
p
 + 1,

1426 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1427 (
chaö
+
n
-1Ë- 
∑πül
);

1428 
∑πül
--;

1430 i‡(
∑πül2
 > 
chaö2
 && 
dïth2
 <
dïth
) {

1431 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1432 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1433 
∑πül2
->
p
,

1434 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1435 
∑πül2
--;

1439 
˛ónup
:

1440 
p
 &&Ö > 
chaö
) {

1441 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1442 
	`bªl£
(
p
->
bh
);

1443 
p
--;

1445 
p2
 &&Ö2 > 
chaö2
) {

1446 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1447 
	`bªl£
(
p2
->
bh
);

1448 
p2
--;

1452 
do_ödúe˘s
:

1454 
off£ts
[0]) {

1456 i‡(++
n
 >
n2
)

1458 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1459 i‡(
ƒ
) {

1460 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1461 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1464 
PXT4_IND_BLOCK
:

1465 i‡(++
n
 >
n2
)

1467 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1468 i‡(
ƒ
) {

1469 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1470 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1473 
PXT4_DIND_BLOCK
:

1474 i‡(++
n
 >
n2
)

1476 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1477 i‡(
ƒ
) {

1478 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1479 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1482 
PXT4_TIND_BLOCK
:

1485 
˛ónup
;

1486 
	}
}

	@inline.c

7 
	~<löux/iom≠.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/ivîsi⁄.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

14 
	~"åunˇã.h
"

16 
	#PXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#PXT4_MIN_INLINE_DATA_SIZE
 (((
__À32
Ë* 
PXT4_N_BLOCKS
))

	)

18 
	#PXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#PXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$pxt4_gë_ölöe_size
(
öode
 *inode)

23 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
)

24  
	`PXT4_I
(
öode
)->
i_ölöe_size
;

27 
	}
}

29 
	$gë_max_ölöe_x©å_vÆue_size
(
öode
 *inode,

30 
pxt4_ûoc
 *
ûoc
)

32 
pxt4_x©å_ibody_hódî
 *
hódî
;

33 
pxt4_x©å_íåy
 *
íåy
;

34 
pxt4_öode
 *
øw_öode
;

35 
‰ì
, 
mö_offs
;

37 
mö_offs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 -

38 
PXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`PXT4_I
(
öode
)->
i_exåa_isize
 -

40 (
pxt4_x©å_ibody_hódî
);

47 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

48  
	`PXT4_XATTR_SIZE
(
mö_offs
 -

49 
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
)) -

50 
PXT4_XATTR_ROUND
 - (
__u32
));

52 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

53 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

54 
íåy
 = 
	`IFIRST
(
hódî
);

57 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

58 i‡(!
íåy
->
e_vÆue_öum
 &&É¡ry->
e_vÆue_size
) {

59 
size_t
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

60 i‡(
offs
 < 
mö_offs
)

61 
mö_offs
 = 
offs
;

64 
‰ì
 = 
mö_offs
 -

65 ((*)
íåy
 - (*)
	`IFIRST
(
hódî
)Ë- (
__u32
);

67 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

68 
íåy
 = (
pxt4_x©å_íåy
 *)

69 ((*)
øw_öode
 + 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

71 
‰ì
 +
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

72 
out
;

75 
‰ì
 -
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
));

77 i‡(
‰ì
 > 
PXT4_XATTR_ROUND
)

78 
‰ì
 = 
	`PXT4_XATTR_SIZE
(‰ì - 
PXT4_XATTR_ROUND
);

80 
‰ì
 = 0;

82 
out
:

83  
‰ì
;

84 
	}
}

91 
	$pxt4_gë_max_ölöe_size
(
öode
 *inode)

93 
îr‹
, 
max_ölöe_size
;

94 
pxt4_ûoc
 
ûoc
;

96 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

99 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

100 i‡(
îr‹
) {

101 
	`pxt4_îr‹_öode
(
öode
, 
__func__
, 
__LINE__
, 0,

103 
öode
->
i_öo
);

107 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

108 
max_ölöe_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
öode
, &
ûoc
);

109 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

111 
	`bªl£
(
ûoc
.
bh
);

113 i‡(!
max_ölöe_size
)

116  
max_ölöe_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode)

126 
pxt4_x©å_ibody_föd
 
is
 = {

127 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

129 
pxt4_x©å_öfo
 
i
 = {

130 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

131 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

133 
îr‹
;

135 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

138 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

139 i‡(
îr‹
)

140  
îr‹
;

142 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

143 i‡(
îr‹
)

144 
out
;

146 i‡(!
is
.
s
.
nŸ_found
) {

147 i‡(
is
.
s
.
hîe
->
e_vÆue_öum
) {

148 
	`PXT4_ERROR_INODE
(
öode
, "inline data xattrÑefers "

150 
îr‹
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

154 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

155 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`bªl£
(
is
.
ûoc
.
bh
);

161  
îr‹
;

162 
	}
}

164 
	$pxt4_ªad_ölöe_d©a
(
öode
 *öode, *
buf„r
,

165 
Àn
,

166 
pxt4_ûoc
 *
ûoc
)

168 
pxt4_x©å_íåy
 *
íåy
;

169 
pxt4_x©å_ibody_hódî
 *
hódî
;

170 
˝_Àn
 = 0;

171 
pxt4_öode
 *
øw_öode
;

173 i‡(!
Àn
)

176 
	`BUG_ON
(
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

178 
˝_Àn
 = 
Àn
 < 
PXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Àn
 : 
PXT4_MIN_INLINE_DATA_SIZE
;

181 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

182 
	`mem˝y
(
buf„r
, (*)(
øw_öode
->
i_block
), 
˝_Àn
);

184 
Àn
 -
˝_Àn
;

185 
buf„r
 +
˝_Àn
;

187 i‡(!
Àn
)

188 
out
;

190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

191 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

192 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

193 
Àn
 = 
	`mö_t
(,Üen,

194 ()
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

196 
	`mem˝y
(
buf„r
,

197 (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
), 
Àn
);

198 
˝_Àn
 +
Àn
;

200 
out
:

201  
˝_Àn
;

202 
	}
}

210 
	$pxt4_wrôe_ölöe_d©a
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
,

211 *
buf„r
, 
loff_t
 
pos
, 
Àn
)

213 
pxt4_x©å_íåy
 *
íåy
;

214 
pxt4_x©å_ibody_hódî
 *
hódî
;

215 
pxt4_öode
 *
øw_öode
;

216 
˝_Àn
 = 0;

218 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

221 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

222 
	`BUG_ON
(
pos
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

224 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

225 
buf„r
 +
pos
;

227 i‡(
pos
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

228 
˝_Àn
 = 
pos
 + 
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

229 
PXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Àn
;

230 
	`mem˝y
((*)
øw_öode
->
i_block
 + 
pos
, 
buf„r
, 
˝_Àn
);

232 
Àn
 -
˝_Àn
;

233 
buf„r
 +
˝_Àn
;

234 
pos
 +
˝_Àn
;

237 i‡(!
Àn
)

240 
pos
 -
PXT4_MIN_INLINE_DATA_SIZE
;

241 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

242 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

243 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

245 
	`mem˝y
((*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
Ë+ 
pos
,

246 
buf„r
, 
Àn
);

247 
	}
}

249 
	$pxt4_¸óã_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
Àn
)

252 
îr‹
;

253 *
vÆue
 = 
NULL
;

254 
pxt4_x©å_ibody_föd
 
is
 = {

255 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

257 
pxt4_x©å_öfo
 
i
 = {

258 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

259 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

262 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

263 i‡(
îr‹
)

264  
îr‹
;

266 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

267 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

268 i‡(
îr‹
)

269 
out
;

271 i‡(
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

272 
vÆue
 = 
PXT4_ZERO_XATTR_VALUE
;

273 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

275 
vÆue
 = "";

276 
Àn
 = 0;

280 
i
.
vÆue
 = value;

281 
i
.
vÆue_Àn
 = 
Àn
;

283 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

284 i‡(
îr‹
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nŸ_found
);

289 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

290 i‡(
îr‹
) {

291 i‡(
îr‹
 =-
ENOSPC
)

292 
	`pxt4_˛ór_öode_°©e
(
öode
,

293 
PXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

298 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

300 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

301 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

302 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
Àn
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

303 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

304 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

305 
	`gë_bh
(
is
.
ûoc
.
bh
);

306 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

308 
out
:

309 
	`bªl£
(
is
.
ûoc
.
bh
);

310  
îr‹
;

311 
	}
}

313 
	$pxt4_upd©e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

314 
Àn
)

316 
îr‹
;

317 *
vÆue
 = 
NULL
;

318 
pxt4_x©å_ibody_föd
 
is
 = {

319 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

321 
pxt4_x©å_öfo
 
i
 = {

322 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

323 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

327 i‡(
Àn
 <
	`PXT4_I
(
öode
)->
i_ölöe_size
)

330 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

331 i‡(
îr‹
)

332  
îr‹
;

334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

335 i‡(
îr‹
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

340 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

341 
vÆue
 = 
	`kzÆloc
(
Àn
, 
GFP_NOFS
);

342 i‡(!
vÆue
) {

343 
îr‹
 = -
ENOMEM
;

344 
out
;

347 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
, i.
«me
,

348 
vÆue
, 
Àn
);

349 i‡(
îr‹
 =-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

353 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

354 i‡(
îr‹
)

355 
out
;

358 
i
.
vÆue
 = value;

359 
i
.
vÆue_Àn
 = 
Àn
;

361 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

362 i‡(
îr‹
)

363 
out
;

365 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

366 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

367 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

369 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

370 
	`gë_bh
(
is
.
ûoc
.
bh
);

371 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

373 
out
:

374 
	`k‰ì
(
vÆue
);

375 
	`bªl£
(
is
.
ûoc
.
bh
);

376  
îr‹
;

377 
	}
}

379 
	$pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

380 
Àn
)

382 
ªt
, 
size
, 
no_ex∑nd
;

383 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

385 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

389 i‡(
size
 < 
Àn
)

390  -
ENOSPC
;

392 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

394 i‡(
ei
->
i_ölöe_off
)

395 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

397 
ªt
 = 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

399 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

400  
ªt
;

401 
	}
}

403 
	$pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

404 
öode
 *inode)

406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

407 
pxt4_x©å_ibody_föd
 
is
 = {

408 .
s
 = { .
nŸ_found
 = 0, },

410 
pxt4_x©å_öfo
 
i
 = {

411 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

412 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

413 .
vÆue
 = 
NULL
,

414 .
vÆue_Àn
 = 0,

416 
îr‹
;

418 i‡(!
ei
->
i_ölöe_off
)

421 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

422 i‡(
îr‹
)

423  
îr‹
;

425 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

426 i‡(
îr‹
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

430 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

431 i‡(
îr‹
)

432 
out
;

434 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

435 i‡(
îr‹
)

436 
out
;

438 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

439 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

442 i‡(
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
)) {

443 i‡(
	`S_ISDIR
(
öode
->
i_mode
) ||

444 
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

446 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

449 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

451 
	`gë_bh
(
is
.
ûoc
.
bh
);

452 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

454 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

455 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 0;

456 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`bªl£
(
is
.
ûoc
.
bh
);

459 i‡(
îr‹
 =-
ENODATA
)

460 
îr‹
 = 0;

461  
îr‹
;

462 
	}
}

464 
	$pxt4_ªad_ölöe_∑ge
(
öode
 *öode, 
∑ge
 *page)

466 *
kaddr
;

467 
ªt
 = 0;

468 
size_t
 
Àn
;

469 
pxt4_ûoc
 
ûoc
;

471 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

472 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

473 
	`BUG_ON
(
∑ge
->
ödex
);

475 i‡(!
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

476 
	`pxt4_w¨nög
(
öode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
öode
->
i_öo
);

478 
out
;

481 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

482 i‡(
ªt
)

483 
out
;

485 
Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
), 
	`i_size_ªad
(inode));

486 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

487 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
kaddr
, 
Àn
, &
ûoc
);

488 
	`Êush_dˇche_∑ge
(
∑ge
);

489 
	`kunm≠_©omic
(
kaddr
);

490 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

491 
	`SëPageU±od©e
(
∑ge
);

492 
	`bªl£
(
ûoc
.
bh
);

494 
out
:

495  
ªt
;

496 
	}
}

498 
	$pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page)

500 
ªt
 = 0;

502 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

503 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

504 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

505  -
EAGAIN
;

512 i‡(!
∑ge
->
ödex
)

513 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

514 i‡(!
	`PageU±od©e
(
∑ge
)) {

515 
	`zîo_u£r_£gmít
(
∑ge
, 0, 
PAGE_SIZE
);

516 
	`SëPageU±od©e
(
∑ge
);

519 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

521 
	`u∆ock_∑ge
(
∑ge
);

522  
ªt
 >= 0 ? 0 :Ñet;

523 
	}
}

525 
	$pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

526 
öode
 *inode,

527 
Êags
)

529 
ªt
, 
√eded_blocks
, 
no_ex∑nd
;

530 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

531 
ªåõs
 = 0, 
£m_hñd
 = 0;

532 
∑ge
 *∑gê
NULL
;

533 
‰om
, 
to
;

534 
pxt4_ûoc
 
ûoc
;

536 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

541 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

545 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

547 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

548 i‡(
ªt
)

549  
ªt
;

551 
ªåy
:

552 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

553 i‡(
	`IS_ERR
(
h™dÀ
)) {

554 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

555 
h™dÀ
 = 
NULL
;

556 
out
;

561 
Êags
 |
AOP_FLAG_NOFS
;

563 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

564 i‡(!
∑ge
) {

565 
ªt
 = -
ENOMEM
;

566 
out
;

569 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

570 
£m_hñd
 = 1;

572 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

573 
ªt
 = 0;

574 
out
;

577 
‰om
 = 0;

578 
to
 = 
	`pxt4_gë_ölöe_size
(
öode
);

579 i‡(!
	`PageU±od©e
(
∑ge
)) {

580 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

581 i‡(
ªt
 < 0)

582 
out
;

585 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

586 i‡(
ªt
)

587 
out
;

589 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

590 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
,

591 
pxt4_gë_block_unwrôãn
);

593 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
, 
pxt4_gë_block
);

595 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

596 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

597 
‰om
, 
to
, 
NULL
,

598 
do_jou∫Æ_gë_wrôe_ac˚ss
);

601 i‡(
ªt
) {

602 
	`u∆ock_∑ge
(
∑ge
);

603 
	`put_∑ge
(
∑ge
);

604 
∑ge
 = 
NULL
;

605 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

606 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

607 
£m_hñd
 = 0;

608 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

609 
h™dÀ
 = 
NULL
;

610 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

617 i‡(
öode
->
i_∆ök
)

618 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

621 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

622 
ªåy
;

624 i‡(
∑ge
)

625 
	`block_commô_wrôe
(
∑ge
, 
‰om
, 
to
);

626 
out
:

627 i‡(
∑ge
) {

628 
	`u∆ock_∑ge
(
∑ge
);

629 
	`put_∑ge
(
∑ge
);

631 i‡(
£m_hñd
)

632 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

633 i‡(
h™dÀ
)

634 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

635 
	`bªl£
(
ûoc
.
bh
);

636  
ªt
;

637 
	}
}

645 
	$pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

646 
öode
 *inode,

647 
loff_t
 
pos
, 
Àn
,

648 
Êags
,

649 
∑ge
 **
∑gï
)

651 
ªt
;

652 
h™dÀ_t
 *
h™dÀ
;

653 
∑ge
 *page;

654 
pxt4_ûoc
 
ûoc
;

656 i‡(
pos
 + 
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
))

657 
c⁄vît
;

659 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

660 i‡(
ªt
)

661  
ªt
;

667 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

668 i‡(
	`IS_ERR
(
h™dÀ
)) {

669 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

670 
h™dÀ
 = 
NULL
;

671 
out
;

674 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

675 i‡(
ªt
 &&Ñë !-
ENOSPC
)

676 
out
;

679 i‡(
ªt
 =-
ENOSPC
) {

680 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

681 
	`bªl£
(
ûoc
.
bh
);

682 
c⁄vît
;

685 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

686 i‡(
ªt
)

687 
out
;

689 
Êags
 |
AOP_FLAG_NOFS
;

691 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

692 i‡(!
∑ge
) {

693 
ªt
 = -
ENOMEM
;

694 
out
;

697 *
∑gï
 = 
∑ge
;

698 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

699 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

700 
ªt
 = 0;

701 
	`u∆ock_∑ge
(
∑ge
);

702 
	`put_∑ge
(
∑ge
);

703 
out_up_ªad
;

706 i‡(!
	`PageU±od©e
(
∑ge
)) {

707 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

708 i‡(
ªt
 < 0) {

709 
	`u∆ock_∑ge
(
∑ge
);

710 
	`put_∑ge
(
∑ge
);

711 
out_up_ªad
;

715 
ªt
 = 1;

716 
h™dÀ
 = 
NULL
;

717 
out_up_ªad
:

718 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

719 
out
:

720 i‡(
h™dÀ
 && (
ªt
 != 1))

721 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

722 
	`bªl£
(
ûoc
.
bh
);

723  
ªt
;

724 
c⁄vît
:

725  
	`pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

726 
öode
, 
Êags
);

727 
	}
}

729 
	$pxt4_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
,

730 
c›õd
, 
∑ge
 *page)

732 
ªt
, 
no_ex∑nd
;

733 *
kaddr
;

734 
pxt4_ûoc
 
ûoc
;

736 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
)) {

737 i‡(!
	`PageU±od©e
(
∑ge
)) {

738 
c›õd
 = 0;

739 
out
;

743 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

744 i‡(
ªt
) {

745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

746 
c›õd
 = 0;

747 
out
;

750 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

751 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

753 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

754 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 
pos
, 
Àn
);

755 
	`kunm≠_©omic
(
kaddr
);

756 
	`SëPageU±od©e
(
∑ge
);

758 
	`CÀ¨PageDúty
(
∑ge
);

760 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

761 
	`bªl£
(
ûoc
.
bh
);

762 
	`m¨k_öode_dúty
(
öode
);

763 
out
:

764  
c›õd
;

765 
	}
}

767 
buf„r_hód
 *

768 
	$pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

769 
Àn
,

770 
∑ge
 *page)

772 
ªt
, 
no_ex∑nd
;

773 *
kaddr
;

774 
pxt4_ûoc
 
ûoc
;

776 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

777 i‡(
ªt
) {

778 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

779  
NULL
;

782 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

783 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

784 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 0, 
Àn
);

785 
	`kunm≠_©omic
(
kaddr
);

786 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

788  
ûoc
.
bh
;

789 
	}
}

800 
	$pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

801 
öode
 *inode,

802 
Êags
,

803 **
fsd©a
)

805 
ªt
 = 0, 
ölöe_size
;

806 
∑ge
 *page;

808 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

809 i‡(!
∑ge
)

810  -
ENOMEM
;

812 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

813 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

814 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

815 
out
;

818 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

820 i‡(!
	`PageU±od©e
(
∑ge
)) {

821 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

822 i‡(
ªt
 < 0)

823 
out
;

826 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 0, 
ölöe_size
,

827 
pxt4_da_gë_block_¥ï
);

828 i‡(
ªt
) {

829 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

830 
	`u∆ock_∑ge
(
∑ge
);

831 
	`put_∑ge
(
∑ge
);

832 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

833  
ªt
;

836 
	`SëPageDúty
(
∑ge
);

837 
	`SëPageU±od©e
(
∑ge
);

838 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

839 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

841 
out
:

842 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

843 i‡(
∑ge
) {

844 
	`u∆ock_∑ge
(
∑ge
);

845 
	`put_∑ge
(
∑ge
);

847  
ªt
;

848 
	}
}

858 
	$pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

859 
öode
 *inode,

860 
loff_t
 
pos
, 
Àn
,

861 
Êags
,

862 
∑ge
 **
∑gï
,

863 **
fsd©a
)

865 
ªt
, 
ölöe_size
;

866 
h™dÀ_t
 *
h™dÀ
;

867 
∑ge
 *page;

868 
pxt4_ûoc
 
ûoc
;

869 
ªåõs
 = 0;

871 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

872 i‡(
ªt
)

873  
ªt
;

875 
ªåy_jou∫Æ
:

876 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

877 i‡(
	`IS_ERR
(
h™dÀ
)) {

878 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

879 
out
;

882 
ölöe_size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

884 
ªt
 = -
ENOSPC
;

885 i‡(
ölöe_size
 >
pos
 + 
Àn
) {

886 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

887 i‡(
ªt
 &&Ñë !-
ENOSPC
)

888 
out_jou∫Æ
;

895 
Êags
 |
AOP_FLAG_NOFS
;

897 i‡(
ªt
 =-
ENOSPC
) {

898 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

899 
ªt
 = 
	`pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

900 
öode
,

901 
Êags
,

902 
fsd©a
);

903 i‡(
ªt
 =-
ENOSPC
 &&

904 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

905 
ªåy_jou∫Æ
;

906 
out
;

909 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

910 i‡(!
∑ge
) {

911 
ªt
 = -
ENOMEM
;

912 
out_jou∫Æ
;

915 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

916 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

917 
ªt
 = 0;

918 
out_ªÀa£_∑ge
;

921 i‡(!
	`PageU±od©e
(
∑ge
)) {

922 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

923 i‡(
ªt
 < 0)

924 
out_ªÀa£_∑ge
;

926 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

927 i‡(
ªt
)

928 
out_ªÀa£_∑ge
;

930 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

931 *
∑gï
 = 
∑ge
;

932 
	`bªl£
(
ûoc
.
bh
);

934 
out_ªÀa£_∑ge
:

935 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

936 
	`u∆ock_∑ge
(
∑ge
);

937 
	`put_∑ge
(
∑ge
);

938 
out_jou∫Æ
:

939 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

940 
out
:

941 
	`bªl£
(
ûoc
.
bh
);

942  
ªt
;

943 
	}
}

945 
	$pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

946 
Àn
, 
c›õd
,

947 
∑ge
 *page)

949 
ªt
;

951 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
);

952 i‡(
ªt
 < 0) {

953 
	`u∆ock_∑ge
(
∑ge
);

954 
	`put_∑ge
(
∑ge
);

955  
ªt
;

957 
c›õd
 = 
ªt
;

966 i‡(
pos
+
c›õd
 > 
öode
->
i_size
)

967 
	`i_size_wrôe
(
öode
, 
pos
+
c›õd
);

968 
	`u∆ock_∑ge
(
∑ge
);

969 
	`put_∑ge
(
∑ge
);

977 
	`m¨k_öode_dúty
(
öode
);

979  
c›õd
;

980 
	}
}

982 #ifde‡
INLINE_DIR_DEBUG


983 
	$pxt4_show_ölöe_dú
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

984 *
ölöe_°¨t
, 
ölöe_size
)

986 
off£t
;

987 
de_Àn
;

988 
pxt4_dú_íåy_2
 *
de
 = 
ölöe_°¨t
;

989 *
dlimô
 = 
ölöe_°¨t
 + 
ölöe_size
;

991 
	`åa˚_¥ötk
("öodê%lu\n", 
dú
->
i_öo
);

992 
off£t
 = 0;

993 (*)
de
 < 
dlimô
) {

994 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

995 
	`åa˚_¥ötk
("de: off %uÑlen %uÇame %.*sÇlen %u ino %u\n",

996 
off£t
, 
de_Àn
, 
de
->
«me_Àn
, de->
«me
,

997 
de
->
«me_Àn
, 
	`À32_to_˝u
(de->
öode
));

998 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

999 
ölöe_°¨t
, 
ölöe_size
, 
off£t
))

1000 
	`BUG
();

1002 
off£t
 +
de_Àn
;

1003 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1005 
	}
}

1007 
	#pxt4_show_ölöe_dú
(
dú
, 
bh
, 
ölöe_°¨t
, 
ölöe_size
)

	)

1015 
	$pxt4_add_dúít_to_ölöe
(
h™dÀ_t
 *
h™dÀ
,

1016 
pxt4_fûíame
 *
‚ame
,

1017 
öode
 *
dú
,

1018 
öode
 *inode,

1019 
pxt4_ûoc
 *
ûoc
,

1020 *
ölöe_°¨t
, 
ölöe_size
)

1022 
îr
;

1023 
pxt4_dú_íåy_2
 *
de
;

1025 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
ûoc
->
bh
, 
ölöe_°¨t
,

1026 
ölöe_size
, 
‚ame
, &
de
);

1027 i‡(
îr
)

1028  
îr
;

1030 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

1031 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

1032 i‡(
îr
)

1033  
îr
;

1034 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
ölöe_size
, 
‚ame
);

1036 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
->
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1049 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1050 
	`pxt4_upd©e_dx_Êag
(
dú
);

1051 
	`öode_öc_ivîsi⁄
(
dú
);

1053 
	}
}

1055 *
	$pxt4_gë_ölöe_x©å_pos
(
öode
 *inode,

1056 
pxt4_ûoc
 *
ûoc
)

1058 
pxt4_x©å_íåy
 *
íåy
;

1059 
pxt4_x©å_ibody_hódî
 *
hódî
;

1061 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1063 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(
ûoc
));

1064 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
	`pxt4_øw_öode
(
ûoc
) +

1065 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1067  (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

1068 
	}
}

1071 
	$pxt4_upd©e_föÆ_de
(*
de_buf
, 
ﬁd_size
, 
√w_size
)

1073 
pxt4_dú_íåy_2
 *
de
, *
¥ev_de
;

1074 *
limô
;

1075 
de_Àn
;

1077 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1078 i‡(
ﬁd_size
) {

1079 
limô
 = 
de_buf
 + 
ﬁd_size
;

1081 
¥ev_de
 = 
de
;

1082 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ﬁd_size
);

1083 
de_buf
 +
de_Àn
;

1084 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1085 } 
de_buf
 < 
limô
);

1087 
¥ev_de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
de_Àn
 + 
√w_size
 -

1088 
ﬁd_size
, 
√w_size
);

1091 
de
->
öode
 = 0;

1092 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
√w_size
,Çew_size);

1094 
	}
}

1096 
	$pxt4_upd©e_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1097 
pxt4_ûoc
 *
ûoc
)

1099 
ªt
;

1100 
ﬁd_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
;

1101 
√w_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
dú
, 
ûoc
);

1103 i‡(
√w_size
 - 
ﬁd_size
 <
	`PXT4_DIR_REC_LEN
(1))

1104  -
ENOSPC
;

1106 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
dú
,

1107 
√w_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
);

1108 i‡(
ªt
)

1109  
ªt
;

1111 
	`pxt4_upd©e_föÆ_de
(
	`pxt4_gë_ölöe_x©å_pos
(
dú
, 
ûoc
), 
ﬁd_size
,

1112 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1113 
PXT4_MIN_INLINE_DATA_SIZE
);

1114 
dú
->
i_size
 = 
	`PXT4_I
(dú)->
i_disksize
 = PXT4_I(dú)->
i_ölöe_size
;

1116 
	}
}

1118 
	$pxt4_ª°‹e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1119 
pxt4_ûoc
 *
ûoc
,

1120 *
buf
, 
ölöe_size
)

1122 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1123 
	`pxt4_wrôe_ölöe_d©a
(
öode
, 
ûoc
, 
buf
, 0, 
ölöe_size
);

1124 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1125 
	}
}

1127 
	$pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

1128 
öode
 *inode,

1129 
buf„r_hód
 *
dú_block
,

1130 *
buf
,

1131 
ölöe_size
)

1133 
îr
, 
csum_size
 = 0, 
hódî_size
 = 0;

1134 
pxt4_dú_íåy_2
 *
de
;

1135 *
èrgë
 = 
dú_block
->
b_d©a
;

1141 
de
 = (
pxt4_dú_íåy_2
 *)
èrgë
;

1142 
de
 = 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, de,

1143 
öode
->
i_sb
->
s_blocksize
, 
csum_size
,

1144 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
buf
)->
öode
), 1);

1145 
hódî_size
 = (*)
de
 - 
èrgë
;

1147 
	`mem˝y
((*)
de
, 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1148 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1150 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1151 
csum_size
 = (
pxt4_dú_íåy_èû
);

1153 
öode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1154 
	`i_size_wrôe
(
öode
, inode->
i_sb
->
s_blocksize
);

1155 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1156 
	`pxt4_upd©e_föÆ_de
(
dú_block
->
b_d©a
,

1157 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
 + 
hódî_size
,

1158 
öode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1160 i‡(
csum_size
)

1161 
	`pxt4_öôülize_dúít_èû
(
dú_block
,

1162 
öode
->
i_sb
->
s_blocksize
);

1163 
	`£t_buf„r_u±od©e
(
dú_block
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

1165 i‡(
îr
)

1166  
îr
;

1167 
	`£t_buf„r_vîifõd
(
dú_block
);

1168  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1169 
	}
}

1171 
	$pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

1172 
öode
 *inode,

1173 
pxt4_ûoc
 *
ûoc
)

1175 
îr‹
;

1176 *
buf
 = 
NULL
;

1177 
buf„r_hód
 *
d©a_bh
 = 
NULL
;

1178 
pxt4_m≠_blocks
 
m≠
;

1179 
ölöe_size
;

1181 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1182 
buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1183 i‡(!
buf
) {

1184 
îr‹
 = -
ENOMEM
;

1185 
out
;

1188 
îr‹
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
buf
, 
ölöe_size
, 
ûoc
);

1189 i‡(
îr‹
 < 0)

1190 
out
;

1196 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1197 
îr‹
 = 
	`pxt4_check_Æl_de
(
öode
, 
ûoc
->
bh
,

1198 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1199 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1200 i‡(
îr‹
)

1201 
out
;

1204 
îr‹
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1205 i‡(
îr‹
)

1206 
out
;

1208 
m≠
.
m_lblk
 = 0;

1209 
m≠
.
m_Àn
 = 1;

1210 
m≠
.
m_Êags
 = 0;

1211 
îr‹
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
PXT4_GET_BLOCKS_CREATE
);

1212 i‡(
îr‹
 < 0)

1213 
out_ª°‹e
;

1214 i‡(!(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
)) {

1215 
îr‹
 = -
EIO
;

1216 
out_ª°‹e
;

1219 
d©a_bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1220 i‡(!
d©a_bh
) {

1221 
îr‹
 = -
ENOMEM
;

1222 
out_ª°‹e
;

1225 
	`lock_buf„r
(
d©a_bh
);

1226 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
d©a_bh
);

1227 i‡(
îr‹
) {

1228 
	`u∆ock_buf„r
(
d©a_bh
);

1229 
îr‹
 = -
EIO
;

1230 
out_ª°‹e
;

1232 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1234 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

1235 
	`mem˝y
(
d©a_bh
->
b_d©a
, 
buf
, 
ölöe_size
);

1236 
	`£t_buf„r_u±od©e
(
d©a_bh
);

1237 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1238 
öode
, 
d©a_bh
);

1240 
îr‹
 = 
	`pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ
, 
öode
, 
d©a_bh
,

1241 
buf
, 
ölöe_size
);

1244 
	`u∆ock_buf„r
(
d©a_bh
);

1245 
out_ª°‹e
:

1246 i‡(
îr‹
)

1247 
	`pxt4_ª°‹e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ûoc
, 
buf
, 
ölöe_size
);

1249 
out
:

1250 
	`bªl£
(
d©a_bh
);

1251 
	`k‰ì
(
buf
);

1252  
îr‹
;

1253 
	}
}

1260 
	$pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1261 
öode
 *
dú
, inode *inode)

1263 
ªt
, 
ölöe_size
, 
no_ex∑nd
;

1264 *
ölöe_°¨t
;

1265 
pxt4_ûoc
 
ûoc
;

1267 
ªt
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1268 i‡(
ªt
)

1269  
ªt
;

1271 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1272 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
))

1273 
out
;

1275 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1276 
PXT4_INLINE_DOTDOT_SIZE
;

1277 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1279 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, &
ûoc
,

1280 
ölöe_°¨t
, 
ölöe_size
);

1281 i‡(
ªt
 !-
ENOSPC
)

1282 
out
;

1285 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1286 
PXT4_MIN_INLINE_DATA_SIZE
;

1287 i‡(!
ölöe_size
) {

1289 
ªt
 = 
	`pxt4_upd©e_ölöe_dú
(
h™dÀ
, 
dú
, &
ûoc
);

1290 i‡(
ªt
 &&Ñë !-
ENOSPC
)

1291 
out
;

1293 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1294 
PXT4_MIN_INLINE_DATA_SIZE
;

1297 i‡(
ölöe_size
) {

1298 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1300 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
,

1301 
öode
, &
ûoc
, 
ölöe_°¨t
,

1302 
ölöe_size
);

1304 i‡(
ªt
 !-
ENOSPC
)

1305 
out
;

1313 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
dú
, &
ûoc
);

1315 
out
:

1316 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1317 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1318 
	`bªl£
(
ûoc
.
bh
);

1319  
ªt
;

1320 
	}
}

1327 
	$pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

1328 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1329 
dx_hash_öfo
 *
höfo
,

1330 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

1331 *
has_ölöe_d©a
)

1333 
îr
 = 0, 
cou¡
 = 0;

1334 
∑ª¡_öo
;

1335 
pos
;

1336 
pxt4_dú_íåy_2
 *
de
;

1337 
öode
 *öodê
	`fûe_öode
(
dú_fûe
);

1338 
ªt
, 
ölöe_size
 = 0;

1339 
pxt4_ûoc
 
ûoc
;

1340 *
dú_buf
 = 
NULL
;

1341 
pxt4_dú_íåy_2
 
Áke
;

1342 
fs¸y±_°r
 
tmp_°r
;

1344 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1345 i‡(
ªt
)

1346  
ªt
;

1348 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1349 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1350 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1351 *
has_ölöe_d©a
 = 0;

1352 
out
;

1355 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1356 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1357 i‡(!
dú_buf
) {

1358 
ªt
 = -
ENOMEM
;

1359 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1360 
out
;

1363 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1364 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1365 i‡(
ªt
 < 0)

1366 
out
;

1368 
pos
 = 0;

1369 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1370 
pos
 < 
ölöe_size
) {

1376 i‡(
pos
 == 0) {

1377 
Áke
.
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1378 
Áke
.
«me_Àn
 = 1;

1379 
	`°r˝y
(
Áke
.
«me
, ".");

1380 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1381 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1382 
ölöe_size
);

1383 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1384 
de
 = &
Áke
;

1385 
pos
 = 
PXT4_INLINE_DOTDOT_OFFSET
;

1386 } i‡(
pos
 =
PXT4_INLINE_DOTDOT_OFFSET
) {

1387 
Áke
.
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

1388 
Áke
.
«me_Àn
 = 2;

1389 
	`°r˝y
(
Áke
.
«me
, "..");

1390 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1391 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1392 
ölöe_size
);

1393 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1394 
de
 = &
Áke
;

1395 
pos
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1397 
de
 = (
pxt4_dú_íåy_2
 *)(
dú_buf
 + 
pos
);

1398 
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1399 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
dú_fûe
, 
de
,

1400 
ûoc
.
bh
, 
dú_buf
,

1401 
ölöe_size
, 
pos
)) {

1402 
ªt
 = 
cou¡
;

1403 
out
;

1407 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1408 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1409 ((
höfo
->
hash
 =
°¨t_hash
) &&

1410 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1412 i‡(
de
->
öode
 == 0)

1414 
tmp_°r
.
«me
 = 
de
->name;

1415 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1416 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 
höfo
->
hash
,

1417 
höfo
->
mö‹_hash
, 
de
, &
tmp_°r
);

1418 i‡(
îr
) {

1419 
ªt
 = 
îr
;

1420 
out
;

1422 
cou¡
++;

1424 
ªt
 = 
cou¡
;

1425 
out
:

1426 
	`k‰ì
(
dú_buf
);

1427 
	`bªl£
(
ûoc
.
bh
);

1428  
ªt
;

1429 
	}
}

1439 
	$pxt4_ªad_ölöe_dú
(
fûe
 *file,

1440 
dú_c⁄ãxt
 *
˘x
,

1441 *
has_ölöe_d©a
)

1443 
off£t
, 
∑ª¡_öo
;

1444 
i
;

1445 
pxt4_dú_íåy_2
 *
de
;

1446 
su≥r_block
 *
sb
;

1447 
öode
 *öodê
	`fûe_öode
(
fûe
);

1448 
ªt
, 
ölöe_size
 = 0;

1449 
pxt4_ûoc
 
ûoc
;

1450 *
dú_buf
 = 
NULL
;

1451 
dŸdŸ_off£t
, 
dŸdŸ_size
, 
exåa_off£t
, 
exåa_size
;

1453 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1454 i‡(
ªt
)

1455  
ªt
;

1457 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1458 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1459 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1460 *
has_ölöe_d©a
 = 0;

1461 
out
;

1464 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1465 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1466 i‡(!
dú_buf
) {

1467 
ªt
 = -
ENOMEM
;

1468 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1469 
out
;

1472 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1473 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1474 i‡(
ªt
 < 0)

1475 
out
;

1477 
ªt
 = 0;

1478 
sb
 = 
öode
->
i_sb
;

1479 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1480 
off£t
 = 
˘x
->
pos
;

1489 
dŸdŸ_off£t
 = 
	`PXT4_DIR_REC_LEN
(1);

1490 
dŸdŸ_size
 = 
dŸdŸ_off£t
 + 
	`PXT4_DIR_REC_LEN
(2);

1491 
exåa_off£t
 = 
dŸdŸ_size
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1492 
exåa_size
 = 
exåa_off£t
 + 
ölöe_size
;

1500 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

1501 
i
 = 0; i < 
exåa_size
 && i < 
off£t
;) {

1506 i‡(!
i
) {

1507 
i
 = 
dŸdŸ_off£t
;

1509 } i‡(
i
 =
dŸdŸ_off£t
) {

1510 
i
 = 
dŸdŸ_size
;

1516 
de
 = (
pxt4_dú_íåy_2
 *)

1517 (
dú_buf
 + 
i
 - 
exåa_off£t
);

1524 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
)

1525 < 
	`PXT4_DIR_REC_LEN
(1))

1527 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1528 
exåa_size
);

1530 
off£t
 = 
i
;

1531 
˘x
->
pos
 = 
off£t
;

1532 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

1535 
˘x
->
pos
 < 
exåa_size
) {

1536 i‡(
˘x
->
pos
 == 0) {

1537 i‡(!
	`dú_emô
(
˘x
, ".", 1, 
öode
->
i_öo
, 
DT_DIR
))

1538 
out
;

1539 
˘x
->
pos
 = 
dŸdŸ_off£t
;

1543 i‡(
˘x
->
pos
 =
dŸdŸ_off£t
) {

1544 i‡(!
	`dú_emô
(
˘x
, "..", 2, 
∑ª¡_öo
, 
DT_DIR
))

1545 
out
;

1546 
˘x
->
pos
 = 
dŸdŸ_size
;

1550 
de
 = (
pxt4_dú_íåy_2
 *)

1551 (
dú_buf
 + 
˘x
->
pos
 - 
exåa_off£t
);

1552 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
ûoc
.
bh
, 
dú_buf
,

1553 
exåa_size
, 
˘x
->
pos
))

1554 
out
;

1555 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1556 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
, de->
«me_Àn
,

1557 
	`À32_to_˝u
(
de
->
öode
),

1558 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

1559 
out
;

1561 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
);

1563 
out
:

1564 
	`k‰ì
(
dú_buf
);

1565 
	`bªl£
(
ûoc
.
bh
);

1566  
ªt
;

1567 
	}
}

1569 
buf„r_hód
 *
	$pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

1570 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

1571 *
ªtvÆ
)

1573 
pxt4_ûoc
 
ûoc
;

1575 *
ªtvÆ
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1576 i‡(*
ªtvÆ
)

1577  
NULL
;

1579 *
∑ª¡_de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1581  
ûoc
.
bh
;

1582 
	}
}

1589 
	$pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1590 
öode
 *inode)

1592 
ªt
, 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1593 
pxt4_ûoc
 
ûoc
;

1594 
pxt4_dú_íåy_2
 *
de
;

1596 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1597 i‡(
ªt
)

1598  
ªt
;

1600 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1601 i‡(
ªt
)

1602 
out
;

1608 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1609 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡
->
i_öo
);

1610 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
PXT4_INLINE_DOTDOT_SIZE
);

1611 
de
->
öode
 = 0;

1612 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1613 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
,

1614 
ölöe_size
);

1615 
	`£t_∆ök
(
öode
, 2);

1616 
öode
->
i_size
 = 
	`PXT4_I
(öode)->
i_disksize
 = 
ölöe_size
;

1617 
out
:

1618 
	`bªl£
(
ûoc
.
bh
);

1619  
ªt
;

1620 
	}
}

1622 
buf„r_hód
 *
	$pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

1623 
pxt4_fûíame
 *
‚ame
,

1624 
pxt4_dú_íåy_2
 **
ªs_dú
,

1625 *
has_ölöe_d©a
)

1627 
ªt
;

1628 
pxt4_ûoc
 
ûoc
;

1629 *
ölöe_°¨t
;

1630 
ölöe_size
;

1632 i‡(
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
))

1633  
NULL
;

1635 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1636 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1637 *
has_ölöe_d©a
 = 0;

1638 
out
;

1641 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1642 
PXT4_INLINE_DOTDOT_SIZE
;

1643 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1644 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1645 
dú
, 
‚ame
, 0, 
ªs_dú
);

1646 i‡(
ªt
 == 1)

1647 
out_föd
;

1648 i‡(
ªt
 < 0)

1649 
out
;

1651 i‡(
	`pxt4_gë_ölöe_size
(
dú
Ë=
PXT4_MIN_INLINE_DATA_SIZE
)

1652 
out
;

1654 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1655 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
Ë- 
PXT4_MIN_INLINE_DATA_SIZE
;

1657 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1658 
dú
, 
‚ame
, 0, 
ªs_dú
);

1659 i‡(
ªt
 == 1)

1660 
out_föd
;

1662 
out
:

1663 
	`bªl£
(
ûoc
.
bh
);

1664 
ûoc
.
bh
 = 
NULL
;

1665 
out_föd
:

1666 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1667  
ûoc
.
bh
;

1668 
	}
}

1670 
	$pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

1671 
öode
 *
dú
,

1672 
pxt4_dú_íåy_2
 *
de_dñ
,

1673 
buf„r_hód
 *
bh
,

1674 *
has_ölöe_d©a
)

1676 
îr
, 
ölöe_size
, 
no_ex∑nd
;

1677 
pxt4_ûoc
 
ûoc
;

1678 *
ölöe_°¨t
;

1680 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1681 i‡(
îr
)

1682  
îr
;

1684 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1685 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1686 *
has_ölöe_d©a
 = 0;

1687 
out
;

1690 i‡((*)
de_dñ
 - ((*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
) <

1691 
PXT4_MIN_INLINE_DATA_SIZE
) {

1692 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1693 
PXT4_INLINE_DOTDOT_SIZE
;

1694 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 -

1695 
PXT4_INLINE_DOTDOT_SIZE
;

1697 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1698 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
) -

1699 
PXT4_MIN_INLINE_DATA_SIZE
;

1702 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1703 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1704 i‡(
îr
)

1705 
out
;

1707 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

1708 
ölöe_°¨t
, 
ölöe_size
, 0);

1709 i‡(
îr
)

1710 
out
;

1712 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1713 
out
:

1714 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1715 i‡(
	`likñy
(
îr
 == 0))

1716 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1717 
	`bªl£
(
ûoc
.
bh
);

1718 i‡(
îr
 !-
ENOENT
)

1719 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1720  
îr
;

1721 
	}
}

1726 
ölöe
 
pxt4_dú_íåy_2
 *

1727 
	$pxt4_gë_ölöe_íåy
(
öode
 *inode,

1728 
pxt4_ûoc
 *
ûoc
,

1729 
off£t
,

1730 **
ölöe_°¨t
,

1731 *
ölöe_size
)

1733 *
ölöe_pos
;

1735 
	`BUG_ON
(
off£t
 > 
	`pxt4_gë_ölöe_size
(
öode
));

1737 i‡(
off£t
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1738 
ölöe_pos
 = (*)
	`pxt4_øw_öode
(
ûoc
)->
i_block
;

1739 *
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1741 
ölöe_pos
 = 
	`pxt4_gë_ölöe_x©å_pos
(
öode
, 
ûoc
);

1742 
off£t
 -
PXT4_MIN_INLINE_DATA_SIZE
;

1743 *
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
) -

1744 
PXT4_MIN_INLINE_DATA_SIZE
;

1747 i‡(
ölöe_°¨t
)

1748 *
ölöe_°¨t
 = 
ölöe_pos
;

1749  (
pxt4_dú_íåy_2
 *)(
ölöe_pos
 + 
off£t
);

1750 
	}
}

1752 
boﬁ
 
	$em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
)

1754 
îr
, 
ölöe_size
;

1755 
pxt4_ûoc
 
ûoc
;

1756 
size_t
 
ölöe_Àn
;

1757 *
ölöe_pos
;

1758 
off£t
;

1759 
pxt4_dú_íåy_2
 *
de
;

1760 
boﬁ
 
ªt
 = 
åue
;

1762 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1763 i‡(
îr
) {

1764 
	`PXT4_ERROR_INODE
(
dú
, "error %d getting inode %lu block",

1765 
îr
, 
dú
->
i_öo
);

1766  
åue
;

1769 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1770 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1771 *
has_ölöe_d©a
 = 0;

1772 
out
;

1775 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1776 i‡(!
	`À32_to_˝u
(
de
->
öode
)) {

1777 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1779 
dú
->
i_öo
);

1780 
ªt
 = 
åue
;

1781 
out
;

1784 
ölöe_Àn
 = 
	`pxt4_gë_ölöe_size
(
dú
);

1785 
off£t
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1786 
off£t
 < 
ölöe_Àn
) {

1787 
de
 = 
	`pxt4_gë_ölöe_íåy
(
dú
, &
ûoc
, 
off£t
,

1788 &
ölöe_pos
, &
ölöe_size
);

1789 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
,

1790 
ûoc
.
bh
, 
ölöe_pos
,

1791 
ölöe_size
, 
off£t
)) {

1792 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1796 
dú
->
i_öo
, 
	`À32_to_˝u
(
de
->
öode
),

1797 
	`À16_to_˝u
(
de
->
ªc_Àn
), de->
«me_Àn
,

1798 
ölöe_size
);

1799 
ªt
 = 
åue
;

1800 
out
;

1802 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1803 
ªt
 = 
Ál£
;

1804 
out
;

1806 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1809 
out
:

1810 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1811 
	`bªl£
(
ûoc
.
bh
);

1812  
ªt
;

1813 
	}
}

1815 
	$pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1817 
ªt
, 
no_ex∑nd
;

1819 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1820 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1821 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1823  
ªt
;

1824 
	}
}

1826 
	$pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap)

1828 
__u64
 
addr
;

1829 
îr‹
 = -
EAGAIN
;

1830 
pxt4_ûoc
 
ûoc
;

1832 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1833 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1834 
out
;

1836 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1837 i‡(
îr‹
)

1838 
out
;

1840 
addr
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1841 
addr
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1842 
addr
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1844 
	`bªl£
(
ûoc
.
bh
);

1846 
iom≠
->
addr
 =áddr;

1847 
iom≠
->
off£t
 = 0;

1848 
iom≠
->
Àngth
 = 
	`mö_t
(
loff_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1849 
	`i_size_ªad
(
öode
));

1850 
iom≠
->
ty≥
 = 
IOMAP_INLINE
;

1851 
iom≠
->
Êags
 = 0;

1853 
out
:

1854 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1855  
îr‹
;

1856 
	}
}

1858 
	$pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

1859 
fõm≠_exã¡_öfo
 *
fõöfo
,

1860 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
)

1862 
__u64
 
physiˇl
 = 0;

1863 
__u64
 
ölöe_Àn
;

1864 
__u32
 
Êags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1865 
FIEMAP_EXTENT_LAST
;

1866 
îr‹
 = 0;

1867 
pxt4_ûoc
 
ûoc
;

1869 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1870 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1871 *
has_ölöe
 = 0;

1872 
out
;

1874 
ölöe_Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1875 
	`i_size_ªad
(
öode
));

1876 i‡(
°¨t
 >
ölöe_Àn
)

1877 
out
;

1878 i‡(
°¨t
 + 
Àn
 < 
ölöe_Àn
)

1879 
ölöe_Àn
 = 
°¨t
 + 
Àn
;

1880 
ölöe_Àn
 -
°¨t
;

1882 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1883 i‡(
îr‹
)

1884 
out
;

1886 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1887 
physiˇl
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1888 
physiˇl
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1890 
	`bªl£
(
ûoc
.
bh
);

1891 
out
:

1892 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1893 i‡(
physiˇl
)

1894 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
°¨t
, 
physiˇl
,

1895 
ölöe_Àn
, 
Êags
);

1896  (
îr‹
 < 0 ?Érror : 0);

1897 
	}
}

1899 
	$pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
)

1901 
h™dÀ_t
 *
h™dÀ
;

1902 
ölöe_size
, 
vÆue_Àn
, 
√eded_blocks
, 
no_ex∑nd
, 
îr
 = 0;

1903 
size_t
 
i_size
;

1904 *
vÆue
 = 
NULL
;

1905 
pxt4_x©å_ibody_föd
 
is
 = {

1906 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

1908 
pxt4_x©å_öfo
 
i
 = {

1909 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

1910 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

1914 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

1915 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
√eded_blocks
);

1916 i‡(
	`IS_ERR
(
h™dÀ
))

1917  
	`PTR_ERR
(
h™dÀ
);

1919 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1920 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1921 *
has_ölöe
 = 0;

1922 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1926 i‡((
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
)) != 0)

1927 
out
;

1929 i‡((
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
)) != 0)

1930 
out
;

1932 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1933 
i_size
 = 
öode
->i_size;

1934 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1935 
	`PXT4_I
(
öode
)->
i_disksize
 = 
i_size
;

1937 i‡(
i_size
 < 
ölöe_size
) {

1939 i‡(
ölöe_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

1940 i‡((
îr
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
)) != 0)

1941 
out_îr‹
;

1943 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

1945 
vÆue_Àn
 = 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

1946 
vÆue
 = 
	`kmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1947 i‡(!
vÆue
) {

1948 
îr
 = -
ENOMEM
;

1949 
out_îr‹
;

1952 
îr
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
,

1953 
i
.
«me
, 
vÆue
, 
vÆue_Àn
);

1954 i‡(
îr
 <= 0)

1955 
out_îr‹
;

1957 
i
.
vÆue
 = value;

1958 
i
.
vÆue_Àn
 = 
i_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1959 
i_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
 : 0;

1960 
îr
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
,

1961 &
i
, &
is
);

1962 i‡(
îr
)

1963 
out_îr‹
;

1967 i‡(
i_size
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1968 *
p
 = (*Ë
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
;

1969 
	`mem£t
(
p
 + 
i_size
, 0,

1970 
PXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1973 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
i_size
 <

1974 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1975 
PXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1978 
out_îr‹
:

1979 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1980 
out
:

1981 
	`bªl£
(
is
.
ûoc
.
bh
);

1982 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1983 
	`k‰ì
(
vÆue
);

1984 i‡(
öode
->
i_∆ök
)

1985 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

1987 i‡(
îr
 == 0) {

1988 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1989 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1990 i‡(
	`IS_SYNC
(
öode
))

1991 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1993 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1994  
îr
;

1995 
	}
}

1997 
	$pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode)

1999 
îr‹
, 
√eded_blocks
, 
no_ex∑nd
;

2000 
h™dÀ_t
 *
h™dÀ
;

2001 
pxt4_ûoc
 
ûoc
;

2003 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

2004 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

2008 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

2010 
ûoc
.
bh
 = 
NULL
;

2011 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2012 i‡(
îr‹
)

2013  
îr‹
;

2015 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

2016 i‡(
	`IS_ERR
(
h™dÀ
)) {

2017 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2018 
out_‰ì
;

2021 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2022 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2023 
îr‹
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
, &
ûoc
);

2024 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2025 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2026 
out_‰ì
:

2027 
	`bªl£
(
ûoc
.
bh
);

2028  
îr‹
;

2029 
	}
}

	@inode-test.c

7 
	~<kunô/ã°.h
>

8 
	~<löux/kî√l.h
>

9 
	~<löux/time64.h
>

11 
	~"pxt4.h
"

17 
	#LOWER_MSB_0
 0L

	)

23 
	#UPPER_MSB_0
 0x7fffffffL

	)

28 
	#LOWER_MSB_1
 (-(
UPPER_MSB_0
Ë- 1LË

	)

33 
	#UPPER_MSB_1
 (-1L)

	)

38 
	#MAX_NANOSECONDS
 ((1L << 30Ë- 1)

	)

40 
	#CASE_NAME_FORMAT
 "%s: msb:%xÜowî_bound:%xÉxåa_bôs: %x"

	)

42 
	#LOWER_BOUND_NEG_NO_EXTRA_BITS_CASE
\

43 "1901-12-13 Lowî bound o‡32bô < 0Åime°amp,Çÿexå®bôs"

	)

44 
	#UPPER_BOUND_NEG_NO_EXTRA_BITS_CASE
\

45 "1969-12-31 Uµî bound o‡32bô < 0Åime°amp,Çÿexå®bôs"

	)

46 
	#LOWER_BOUND_NONNEG_NO_EXTRA_BITS_CASE
\

47 "1970-01-01 Lowî bound o‡32bô >=0Åime°amp,Çÿexå®bôs"

	)

48 
	#UPPER_BOUND_NONNEG_NO_EXTRA_BITS_CASE
\

49 "2038-01-19 Uµî bound o‡32bô >=0Åime°amp,Çÿexå®bôs"

	)

50 
	#LOWER_BOUND_NEG_LO_1_CASE
\

51 "2038-01-19 Lowî bound o‡32bô <0Åime°amp,Üÿexå®£¯bô on"

	)

52 
	#UPPER_BOUND_NEG_LO_1_CASE
\

53 "2106-02-07 Uµî bound o‡32bô <0Åime°amp,Üÿexå®£¯bô on"

	)

54 
	#LOWER_BOUND_NONNEG_LO_1_CASE
\

55 "2106-02-07 Lowî bound o‡32bô >=0Åime°amp,Üÿexå®£¯bô on"

	)

56 
	#UPPER_BOUND_NONNEG_LO_1_CASE
\

57 "2174-02-25 Uµî bound o‡32bô >=0Åime°amp,Üÿexå®£¯bô on"

	)

58 
	#LOWER_BOUND_NEG_HI_1_CASE
\

59 "2174-02-25 Lowî bound o‡32bô <0Åime°amp, hòexå®£¯bô on"

	)

60 
	#UPPER_BOUND_NEG_HI_1_CASE
\

61 "2242-03-16 Uµî bound o‡32bô <0Åime°amp, hòexå®£¯bô on"

	)

62 
	#LOWER_BOUND_NONNEG_HI_1_CASE
\

63 "2242-03-16 Lowî bound o‡32bô >=0Åime°amp, hòexå®£¯bô on"

	)

64 
	#UPPER_BOUND_NONNEG_HI_1_CASE
\

65 "2310-04-04 Uµî bound o‡32bô >=0Åime°amp, hòexå®£¯bô on"

	)

66 
	#UPPER_BOUND_NONNEG_HI_1_NS_1_CASE
\

67 "2310-04-04 Uµî bound o‡32bô>=0Åime°amp, hòexå®£¯bô 1. 1Çs"

	)

68 
	#LOWER_BOUND_NONNEG_HI_1_NS_MAX_CASE
\

69 "2378-04-22 Lowî bound o‡32bô>time°amp. Exå®£¯bô†1. MaxÇs"

	)

70 
	#LOWER_BOUND_NONNEG_EXTRA_BITS_1_CASE
\

71 "2378-04-22 Lowî bound o‡32bô >=0Åime°amp. AŒÉxå®£¯bô†⁄"

	)

72 
	#UPPER_BOUND_NONNEG_EXTRA_BITS_1_CASE
\

73 "2446-05-10 Uµî bound o‡32bô >=0Åime°amp. AŒÉxå®£¯bô†⁄"

	)

75 
	stime°amp_ex≥˘©i⁄
 {

76 c⁄° *
	mã°_ˇ£_«me
;

77 
time•ec64
 
	mex≥˘ed
;

78 
u32
 
	mexåa_bôs
;

79 
boﬁ
 
	mmsb_£t
;

80 
boﬁ
 
	mlowî_bound
;

83 
time64_t
 
	$gë_32bô_time
(c⁄° 
time°amp_ex≥˘©i⁄
 * c⁄° 
ã°
)

85 i‡(
ã°
->
msb_£t
) {

86 i‡(
ã°
->
lowî_bound
)

87  
LOWER_MSB_1
;

89  
UPPER_MSB_1
;

92 i‡(
ã°
->
lowî_bound
)

93  
LOWER_MSB_0
;

94  
UPPER_MSB_0
;

95 
	}
}

102 
	$öode_ã°_xtime°amp_decodög
(
kunô
 *
ã°
)

104 c⁄° 
time°amp_ex≥˘©i⁄
 
ã°_d©a
[] = {

106 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NEG_NO_EXTRA_BITS_CASE
,

107 .
msb_£t
 = 
åue
,

108 .
lowî_bound
 = 
åue
,

109 .
exåa_bôs
 = 0,

110 .
ex≥˘ed
 = {.
tv_£c
 = -0x80000000LL, .
tv_n£c
 = 0L},

114 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NEG_NO_EXTRA_BITS_CASE
,

115 .
msb_£t
 = 
åue
,

116 .
lowî_bound
 = 
Ál£
,

117 .
exåa_bôs
 = 0,

118 .
ex≥˘ed
 = {.
tv_£c
 = -1LL, .
tv_n£c
 = 0L},

122 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NONNEG_NO_EXTRA_BITS_CASE
,

123 .
msb_£t
 = 
Ál£
,

124 .
lowî_bound
 = 
åue
,

125 .
exåa_bôs
 = 0,

126 .
ex≥˘ed
 = {0LL, 0L},

130 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NONNEG_NO_EXTRA_BITS_CASE
,

131 .
msb_£t
 = 
Ál£
,

132 .
lowî_bound
 = 
Ál£
,

133 .
exåa_bôs
 = 0,

134 .
ex≥˘ed
 = {.
tv_£c
 = 0x7fffffffLL, .
tv_n£c
 = 0L},

138 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NEG_LO_1_CASE
,

139 .
msb_£t
 = 
åue
,

140 .
lowî_bound
 = 
åue
,

141 .
exåa_bôs
 = 1,

142 .
ex≥˘ed
 = {.
tv_£c
 = 0x80000000LL, .
tv_n£c
 = 0L},

146 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NEG_LO_1_CASE
,

147 .
msb_£t
 = 
åue
,

148 .
lowî_bound
 = 
Ál£
,

149 .
exåa_bôs
 = 1,

150 .
ex≥˘ed
 = {.
tv_£c
 = 0xffffffffLL, .
tv_n£c
 = 0L},

154 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NONNEG_LO_1_CASE
,

155 .
msb_£t
 = 
Ál£
,

156 .
lowî_bound
 = 
åue
,

157 .
exåa_bôs
 = 1,

158 .
ex≥˘ed
 = {.
tv_£c
 = 0x100000000LL, .
tv_n£c
 = 0L},

162 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NONNEG_LO_1_CASE
,

163 .
msb_£t
 = 
Ál£
,

164 .
lowî_bound
 = 
Ál£
,

165 .
exåa_bôs
 = 1,

166 .
ex≥˘ed
 = {.
tv_£c
 = 0x17fffffffLL, .
tv_n£c
 = 0L},

170 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NEG_HI_1_CASE
,

171 .
msb_£t
 = 
åue
,

172 .
lowî_bound
 = 
åue
,

173 .
exåa_bôs
 = 2,

174 .
ex≥˘ed
 = {.
tv_£c
 = 0x180000000LL, .
tv_n£c
 = 0L},

178 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NEG_HI_1_CASE
,

179 .
msb_£t
 = 
åue
,

180 .
lowî_bound
 = 
Ál£
,

181 .
exåa_bôs
 = 2,

182 .
ex≥˘ed
 = {.
tv_£c
 = 0x1ffffffffLL, .
tv_n£c
 = 0L},

186 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NONNEG_HI_1_CASE
,

187 .
msb_£t
 = 
Ál£
,

188 .
lowî_bound
 = 
åue
,

189 .
exåa_bôs
 = 2,

190 .
ex≥˘ed
 = {.
tv_£c
 = 0x200000000LL, .
tv_n£c
 = 0L},

194 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NONNEG_HI_1_CASE
,

195 .
msb_£t
 = 
Ál£
,

196 .
lowî_bound
 = 
Ál£
,

197 .
exåa_bôs
 = 2,

198 .
ex≥˘ed
 = {.
tv_£c
 = 0x27fffffffLL, .
tv_n£c
 = 0L},

202 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NONNEG_HI_1_NS_1_CASE
,

203 .
msb_£t
 = 
Ál£
,

204 .
lowî_bound
 = 
Ál£
,

205 .
exåa_bôs
 = 6,

206 .
ex≥˘ed
 = {.
tv_£c
 = 0x27fffffffLL, .
tv_n£c
 = 1L},

210 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NONNEG_HI_1_NS_MAX_CASE
,

211 .
msb_£t
 = 
Ál£
,

212 .
lowî_bound
 = 
åue
,

213 .
exåa_bôs
 = 0xFFFFFFFF,

214 .
ex≥˘ed
 = {.
tv_£c
 = 0x300000000LL,

215 .
tv_n£c
 = 
MAX_NANOSECONDS
},

219 .
ã°_ˇ£_«me
 = 
LOWER_BOUND_NONNEG_EXTRA_BITS_1_CASE
,

220 .
msb_£t
 = 
Ál£
,

221 .
lowî_bound
 = 
åue
,

222 .
exåa_bôs
 = 3,

223 .
ex≥˘ed
 = {.
tv_£c
 = 0x300000000LL, .
tv_n£c
 = 0L},

227 .
ã°_ˇ£_«me
 = 
UPPER_BOUND_NONNEG_EXTRA_BITS_1_CASE
,

228 .
msb_£t
 = 
Ál£
,

229 .
lowî_bound
 = 
Ál£
,

230 .
exåa_bôs
 = 3,

231 .
ex≥˘ed
 = {.
tv_£c
 = 0x37fffffffLL, .
tv_n£c
 = 0L},

235 
time•ec64
 
time°amp
;

236 
i
;

238 
i
 = 0; i < 
	`ARRAY_SIZE
(
ã°_d©a
); ++i) {

239 
time°amp
.
tv_£c
 = 
	`gë_32bô_time
(&
ã°_d©a
[
i
]);

240 
	`pxt4_decode_exåa_time
(&
time°amp
,

241 
	`˝u_to_À32
(
ã°_d©a
[
i
].
exåa_bôs
));

243 
	`KUNIT_EXPECT_EQ_MSG
(
ã°
,

244 
ã°_d©a
[
i
].
ex≥˘ed
.
tv_£c
,

245 
time°amp
.
tv_£c
,

246 
CASE_NAME_FORMAT
,

247 
ã°_d©a
[
i
].
ã°_ˇ£_«me
,

248 
ã°_d©a
[
i
].
msb_£t
,

249 
ã°_d©a
[
i
].
lowî_bound
,

250 
ã°_d©a
[
i
].
exåa_bôs
);

251 
	`KUNIT_EXPECT_EQ_MSG
(
ã°
,

252 
ã°_d©a
[
i
].
ex≥˘ed
.
tv_n£c
,

253 
time°amp
.
tv_n£c
,

254 
CASE_NAME_FORMAT
,

255 
ã°_d©a
[
i
].
ã°_ˇ£_«me
,

256 
ã°_d©a
[
i
].
msb_£t
,

257 
ã°_d©a
[
i
].
lowî_bound
,

258 
ã°_d©a
[
i
].
exåa_bôs
);

260 
	}
}

262 
kunô_ˇ£
 
	gpxt4_öode_ã°_ˇ£s
[] = {

263 
KUNIT_CASE
(
öode_ã°_xtime°amp_decodög
),

267 
kunô_suôe
 
	gpxt4_öode_ã°_suôe
 = {

268 .
«me
 = "pxt4_inode_test",

269 .
	gã°_ˇ£s
 = 
pxt4_öode_ã°_ˇ£s
,

272 
kunô_ã°_suôe
(
pxt4_öode_ã°_suôe
);

	@inode.c

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/highuid.h
>

25 
	~<löux/∑gem≠.h
>

26 
	~<löux/dax.h
>

27 
	~<löux/quŸa›s.h
>

28 
	~<löux/°rög.h
>

29 
	~<löux/buf„r_hód.h
>

30 
	~<löux/wrôeback.h
>

31 
	~<löux/∑gevec.h
>

32 
	~<löux/m∑ge.h
>

33 
	~<löux/«mei.h
>

34 
	~<löux/uio.h
>

35 
	~<löux/bio.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/kî√l.h
>

38 
	~<löux/¥ötk.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/bô›s.h
>

41 
	~<löux/iom≠.h
>

42 
	~<löux/ivîsi⁄.h
>

44 
	~"pxt4_jbd3.h
"

45 
	~"x©å.h
"

46 
	~"a˛.h
"

47 
	~"åunˇã.h
"

49 
	~<åa˚/evíts/pxt4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$pxt4_öode_csum
(
öode
 *öode, 
pxt4_öode
 *
øw
,

54 
pxt4_öode_öfo
 *
ei
)

56 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
øw
, 
off£t
);

63 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +
csum_size
;

65 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

66 
PXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_hi
);

70 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 +

71 
PXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
PXT4_GOOD_OLD_INODE_SIZE
);

73 i‡(
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +
csum_size
;

78 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

79 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$pxt4_öode_csum_vîify
(
öode
 *öode, 
pxt4_öode
 *
øw
,

86 
pxt4_öode_öfo
 *
ei
)

88 
__u32
 
¥ovided
, 
ˇlcuœãd
;

90 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

91 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

92 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

95 
¥ovided
 = 
	`À16_to_˝u
(
øw
->
i_checksum_lo
);

96 
ˇlcuœãd
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

97 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

99 
¥ovided
 |((
__u32
)
	`À16_to_˝u
(
øw
->
i_checksum_hi
)) << 16;

101 
ˇlcuœãd
 &= 0xFFFF;

103  
¥ovided
 =
ˇlcuœãd
;

104 
	}
}

106 
	$pxt4_öode_csum_£t
(
öode
 *öode, 
pxt4_öode
 *
øw
,

107 
pxt4_öode_öfo
 *
ei
)

109 
__u32
 
csum
;

111 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

112 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

113 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

116 
csum
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

117 
øw
->
i_checksum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

118 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

120 
øw
->
i_checksum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

121 
	}
}

123 
ölöe
 
	$pxt4_begö_‹dîed_åunˇã
(
öode
 *inode,

124 
loff_t
 
√w_size
)

126 
	`åa˚_pxt4_begö_‹dîed_åunˇã
(
öode
, 
√w_size
);

133 i‡(!
	`PXT4_I
(
öode
)->
jöode
)

135  
	`jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
	`PXT4_JOURNAL
(
öode
),

136 
	`PXT4_I
(
öode
)->
jöode
,

137 
√w_size
);

138 
	}
}

140 
pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

141 
Àngth
);

142 
__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *∑ge, 
Àn
);

143 
pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

144 
pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

145 
≥xã¡s
);

151 
	$pxt4_öode_is_Á°_symlök
(
öode
 *inode)

153 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

154 
ó_blocks
 = 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 ?

155 
	`PXT4_CLUSTER_SIZE
(
öode
->
i_sb
) >> 9 : 0;

157 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

160  (
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 - 
ó_blocks
 == 0);

162  
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_size
 &&

163 (
öode
->
i_size
 < 
PXT4_N_BLOCKS
 * 4);

164 
	}
}

169 
	$pxt4_evi˘_öode
(
öode
 *inode)

171 
h™dÀ_t
 *
h™dÀ
;

172 
îr
;

178 
exåa_¸edôs
 = 6;

179 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

181 
	`åa˚_pxt4_evi˘_öode
(
öode
);

183 i‡(
öode
->
i_∆ök
) {

202 i‡(
öode
->
i_öo
 !
PXT4_JOURNAL_INO
 &&

203 
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

204 (
	`S_ISLNK
(
öode
->
i_mode
Ë|| 
	`S_ISREG
(inode->i_mode)) &&

205 
öode
->
i_d©a
.
ƒ∑ges
) {

206 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

207 
tid_t
 
commô_tid
 = 
	`PXT4_I
(
öode
)->
i_d©async_tid
;

209 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

210 
	`fûem≠_wrôe_™d_waô
(&
öode
->
i_d©a
);

212 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

214 
no_dñëe
;

217 i‡(
	`is_bad_öode
(
öode
))

218 
no_dñëe
;

219 
	`dquŸ_öôülize
(
öode
);

221 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

222 
	`pxt4_begö_‹dîed_åunˇã
(
öode
, 0);

223 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

229 
	`sb_°¨t_ötwrôe
(
öode
->
i_sb
);

231 i‡(!
	`IS_NOQUOTA
(
öode
))

232 
exåa_¸edôs
 +
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
);

238 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
,

239 
	`pxt4_blocks_f‹_åunˇã
(
öode
Ë+ 
exåa_¸edôs
 - 3);

240 i‡(
	`IS_ERR
(
h™dÀ
)) {

241 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
	`PTR_ERR
(
h™dÀ
));

247 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

248 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

249 
no_dñëe
;

252 i‡(
	`IS_SYNC
(
öode
))

253 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

262 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
))

263 
	`mem£t
(
	`PXT4_I
(
öode
)->
i_d©a
, 0, (PXT4_I(inode)->i_data));

264 
öode
->
i_size
 = 0;

265 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

266 i‡(
îr
) {

267 
	`pxt4_w¨nög
(
öode
->
i_sb
,

268 "couldn'àm¨k inodêdúty (î∏%d)", 
îr
);

269 
°›_h™dÀ
;

271 i‡(
öode
->
i_blocks
) {

272 
îr
 = 
	`pxt4_åunˇã
(
öode
);

273 i‡(
îr
) {

274 
	`pxt4_îr‹
(
öode
->
i_sb
,

276 
öode
->
i_öo
, 
îr
);

277 
°›_h™dÀ
;

282 
îr
 = 
	`pxt4_x©å_dñëe_öode
(
h™dÀ
, 
öode
, &
ó_öode_¨øy
,

283 
exåa_¸edôs
);

284 i‡(
îr
) {

285 
	`pxt4_w¨nög
(
öode
->
i_sb
, "x©å dñëê”º %d)", 
îr
);

286 
°›_h™dÀ
:

287 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

288 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

289 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

290 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

291 
no_dñëe
;

302 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

303 
	`PXT4_I
(
öode
)->
i_dtime
 = (
__u32
)
	`ktime_gë_ªÆ_£c⁄ds
();

312 i‡(
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
))

314 
	`pxt4_˛ór_öode
(
öode
);

316 
	`pxt4_‰ì_öode
(
h™dÀ
, 
öode
);

317 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

318 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

319 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

321 
no_dñëe
:

322 
	`pxt4_˛ór_öode
(
öode
);

323 
	}
}

325 #ifde‡
CONFIG_QUOTA


326 
qsize_t
 *
	$pxt4_gë_ª£rved_•a˚
(
öode
 *inode)

328  &
	`PXT4_I
(
öode
)->
i_ª£rved_quŸa
;

329 
	}
}

336 
	$pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

337 
u£d
, 
quŸa_˛aim
)

339 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

340 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

342 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

343 
	`åa˚_pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
u£d
, 
quŸa_˛aim
);

344 i‡(
	`u∆ikñy
(
u£d
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

345 
	`pxt4_w¨nög
(
öode
->
i_sb
, "%s: ino %lu, used %d "

347 
__func__
, 
öode
->
i_öo
, 
u£d
,

348 
ei
->
i_ª£rved_d©a_blocks
);

349 
	`WARN_ON
(1);

350 
u£d
 = 
ei
->
i_ª£rved_d©a_blocks
;

354 
ei
->
i_ª£rved_d©a_blocks
 -
u£d
;

355 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
u£d
);

357 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

360 i‡(
quŸa_˛aim
)

361 
	`dquŸ_˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

368 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

376 i‡((
ei
->
i_ª£rved_d©a_blocks
 == 0) &&

377 !
	`öode_is_›í_f‹_wrôe
(
öode
))

378 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

379 
	}
}

381 
	$__check_block_vÆidôy
(
öode
 *öode, c⁄° *
func
,

382 
löe
,

383 
pxt4_m≠_blocks
 *
m≠
)

385 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
öode
->
i_sb
) &&

386 (
öode
->
i_öo
 ==

387 
	`À32_to_˝u
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_jou∫Æ_öum
)))

389 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
m≠
->
m_pblk
,

390 
m≠
->
m_Àn
)) {

391 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
m≠
->
m_pblk
,

393 "÷ígth %d)", (Ë
m≠
->
m_lblk
,

394 
m≠
->
m_pblk
, m≠->
m_Àn
);

395  -
EFSCORRUPTED
;

398 
	}
}

400 
	$pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
pxt4_fsblk_t
 
pblk
,

401 
pxt4_lblk_t
 
Àn
)

403 
ªt
;

405 i‡(
	`IS_ENCRYPTED
(
öode
))

406  
	`fs¸y±_zîoout_ønge
(
öode
, 
lblk
, 
pblk
, 
Àn
);

408 
ªt
 = 
	`sb_issue_zîoout
(
öode
->
i_sb
, 
pblk
, 
Àn
, 
GFP_NOFS
);

409 i‡(
ªt
 > 0)

410 
ªt
 = 0;

412  
ªt
;

413 
	}
}

415 
	#check_block_vÆidôy
(
öode
, 
m≠
) \

416 
	`__check_block_vÆidôy
((
öode
), 
__func__
, 
__LINE__
, (
m≠
))

	)

418 #ifde‡
ES_AGGRESSIVE_TEST


419 
	$pxt4_m≠_blocks_es_ªcheck
(
h™dÀ_t
 *
h™dÀ
,

420 
öode
 *inode,

421 
pxt4_m≠_blocks
 *
es_m≠
,

422 
pxt4_m≠_blocks
 *
m≠
,

423 
Êags
)

425 
ªtvÆ
;

427 
m≠
->
m_Êags
 = 0;

435 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

436 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

437 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

438 
PXT4_GET_BLOCKS_KEEP_SIZE
);

440 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

441 
PXT4_GET_BLOCKS_KEEP_SIZE
);

443 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

449 i‡(
es_m≠
->
m_lblk
 !
m≠
->m_lblk ||

450 
es_m≠
->
m_Êags
 !
m≠
->m_flags ||

451 
es_m≠
->
m_pblk
 !
m≠
->m_pblk) {

452 
	`¥ötk
("ES cacheássertion failed for inode: %lu "

455 
öode
->
i_öo
, 
es_m≠
->
m_lblk
,És_m≠->
m_Àn
,

456 
es_m≠
->
m_pblk
,És_m≠->
m_Êags
, 
m≠
->
m_lblk
,

457 
m≠
->
m_Àn
, m≠->
m_pblk
, m≠->
m_Êags
,

458 
ªtvÆ
, 
Êags
);

460 
	}
}

485 
	$pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

486 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

488 
exã¡_°©us
 
es
;

489 
ªtvÆ
;

490 
ªt
 = 0;

491 #ifde‡
ES_AGGRESSIVE_TEST


492 
pxt4_m≠_blocks
 
‹ig_m≠
;

494 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

497 
m≠
->
m_Êags
 = 0;

498 
	`ext_debug
("pxt4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

499 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
Êags
, 
m≠
->
m_Àn
,

500 (Ë
m≠
->
m_lblk
);

505 i‡(
	`u∆ikñy
(
m≠
->
m_Àn
 > 
INT_MAX
))

506 
m≠
->
m_Àn
 = 
INT_MAX
;

509 i‡(
	`u∆ikñy
(
m≠
->
m_lblk
 >
EXT_MAX_BLOCKS
))

510  -
EFSCORRUPTED
;

513 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

514 i‡(
	`pxt4_es_is_wrôãn
(&
es
Ë|| 
	`pxt4_es_is_unwrôãn
(&es)) {

515 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
) +

516 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

517 
m≠
->
m_Êags
 |
	`pxt4_es_is_wrôãn
(&
es
) ?

518 
PXT4_MAP_MAPPED
 : 
PXT4_MAP_UNWRITTEN
;

519 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

520 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

521 
ªtvÆ
 = 
m≠
->
m_Àn
;

522 
m≠
->
m_Àn
 = 
ªtvÆ
;

523 } i‡(
	`pxt4_es_is_dñayed
(&
es
Ë|| 
	`pxt4_es_is_hﬁe
(&es)) {

524 
m≠
->
m_pblk
 = 0;

525 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

526 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

527 
ªtvÆ
 = 
m≠
->
m_Àn
;

528 
m≠
->
m_Àn
 = 
ªtvÆ
;

529 
ªtvÆ
 = 0;

531 
	`BUG
();

533 #ifde‡
ES_AGGRESSIVE_TEST


534 
	`pxt4_m≠_blocks_es_ªcheck
(
h™dÀ
, 
öode
, 
m≠
,

535 &
‹ig_m≠
, 
Êags
);

537 
found
;

544 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

545 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

546 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

547 
PXT4_GET_BLOCKS_KEEP_SIZE
);

549 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

550 
PXT4_GET_BLOCKS_KEEP_SIZE
);

552 i‡(
ªtvÆ
 > 0) {

553 
°©us
;

555 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

556 
	`pxt4_w¨nög
(
öode
->
i_sb
,

559 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

560 
	`WARN_ON
(1);

563 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

564 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

565 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

566 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

567 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

568 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

569 
°©us
 |
EXTENT_STATUS_DELAYED
;

570 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
,

571 
m≠
->
m_Àn
, m≠->
m_pblk
, 
°©us
);

572 i‡(
ªt
 < 0)

573 
ªtvÆ
 = 
ªt
;

575 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

577 
found
:

578 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

579 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

580 i‡(
ªt
 != 0)

581  
ªt
;

585 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0)

586  
ªtvÆ
;

595 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
)

601 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

602  
ªtvÆ
;

608 
m≠
->
m_Êags
 &~
PXT4_MAP_FLAGS
;

616 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

622 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

623 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

625 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

627 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

633 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

642 i‡((
ªtvÆ
 > 0) &&

643 (
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
))

644 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
ªtvÆ
, 1);

647 i‡(
ªtvÆ
 > 0) {

648 
°©us
;

650 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

651 
	`pxt4_w¨nög
(
öode
->
i_sb
,

654 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

655 
	`WARN_ON
(1);

665 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
 &&

666 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
 &&

667 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

668 
ªt
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
,

669 
m≠
->
m_pblk
, m≠->
m_Àn
);

670 i‡(
ªt
) {

671 
ªtvÆ
 = 
ªt
;

672 
out_£m
;

680 i‡((
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) &&

681 
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, &
es
)) {

682 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

683 
out_£m
;

685 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

686 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

687 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

688 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

689 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

690 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

691 
°©us
 |
EXTENT_STATUS_DELAYED
;

692 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

693 
m≠
->
m_pblk
, 
°©us
);

694 i‡(
ªt
 < 0) {

695 
ªtvÆ
 = 
ªt
;

696 
out_£m
;

700 
out_£m
:

701 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

702 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

703 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

704 i‡(
ªt
 != 0)

705  
ªt
;

712 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
 &&

713 !(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) &&

714 !(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) &&

715 !
	`pxt4_is_quŸa_fûe
(
öode
) &&

716 
	`pxt4_should_‹dî_d©a
(
öode
)) {

717 
loff_t
 
°¨t_byã
 =

718 (
loff_t
)
m≠
->
m_lblk
 << 
öode
->
i_blkbôs
;

719 
loff_t
 
Àngth
 = (loff_t)
m≠
->
m_Àn
 << 
öode
->
i_blkbôs
;

721 i‡(
Êags
 & 
PXT4_GET_BLOCKS_IO_SUBMIT
)

722 
ªt
 = 
	`pxt4_jbd3_öode_add_waô
(
h™dÀ
, 
öode
,

723 
°¨t_byã
, 
Àngth
);

725 
ªt
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
,

726 
°¨t_byã
, 
Àngth
);

727 i‡(
ªt
)

728  
ªt
;

731  
ªtvÆ
;

732 
	}
}

738 
	$pxt4_upd©e_bh_°©e
(
buf„r_hód
 *
bh
, 
Êags
)

740 
ﬁd_°©e
;

741 
√w_°©e
;

743 
Êags
 &
PXT4_MAP_FLAGS
;

746 i‡(!
bh
->
b_∑ge
) {

747 
bh
->
b_°©e
 = (bh->b_°©ê& ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

756 
ﬁd_°©e
 = 
	`READ_ONCE
(
bh
->
b_°©e
);

757 
√w_°©e
 = (
ﬁd_°©e
 & ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

758 } 
	`u∆ikñy
(

759 
	`cmpxchg
(&
bh
->
b_°©e
, 
ﬁd_°©e
, 
√w_°©e
) != old_state));

760 
	}
}

762 
	$_pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

763 
buf„r_hód
 *
bh
, 
Êags
)

765 
pxt4_m≠_blocks
 
m≠
;

766 
ªt
 = 0;

768 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

769  -
ERANGE
;

771 
m≠
.
m_lblk
 = 
iblock
;

772 
m≠
.
m_Àn
 = 
bh
->
b_size
 >> 
öode
->
i_blkbôs
;

774 
ªt
 = 
	`pxt4_m≠_blocks
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(), 
öode
, &
m≠
,

775 
Êags
);

776 i‡(
ªt
 > 0) {

777 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

778 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

779 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

780 
ªt
 = 0;

781 } i‡(
ªt
 == 0) {

783 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

785  
ªt
;

786 
	}
}

788 
	$pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

789 
buf„r_hód
 *
bh
, 
¸óã
)

791  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
,

792 
¸óã
 ? 
PXT4_GET_BLOCKS_CREATE
 : 0);

793 
	}
}

800 
	$pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

801 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

803 
	`pxt4_debug
("pxt4_get_block_unwritten: inode %lu, create flag %d\n",

804 
öode
->
i_öo
, 
¸óã
);

805  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
,

806 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

807 
	}
}

810 
	#DIO_MAX_BLOCKS
 4096

	)

815 
buf„r_hód
 *
	$pxt4_gëblk
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

816 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

818 
pxt4_m≠_blocks
 
m≠
;

819 
buf„r_hód
 *
bh
;

820 
¸óã
 = 
m≠_Êags
 & 
PXT4_GET_BLOCKS_CREATE
;

821 
îr
;

823 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || 
¸óã
 == 0);

825 
m≠
.
m_lblk
 = 
block
;

826 
m≠
.
m_Àn
 = 1;

827 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
m≠_Êags
);

829 i‡(
îr
 == 0)

830  
¸óã
 ? 
	`ERR_PTR
(-
ENOSPC
Ë: 
NULL
;

831 i‡(
îr
 < 0)

832  
	`ERR_PTR
(
îr
);

834 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

835 i‡(
	`u∆ikñy
(!
bh
))

836  
	`ERR_PTR
(-
ENOMEM
);

837 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
) {

838 
	`J_ASSERT
(
¸óã
 != 0);

839 
	`J_ASSERT
(
h™dÀ
 !
NULL
);

848 
	`lock_buf„r
(
bh
);

849 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

850 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

851 i‡(
	`u∆ikñy
(
îr
)) {

852 
	`u∆ock_buf„r
(
bh
);

853 
îrout
;

855 i‡(!
	`buf„r_u±od©e
(
bh
)) {

856 
	`mem£t
(
bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

857 
	`£t_buf„r_u±od©e
(
bh
);

859 
	`u∆ock_buf„r
(
bh
);

860 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

861 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

862 i‡(
	`u∆ikñy
(
îr
))

863 
îrout
;

865 
	`BUFFER_TRACE
(
bh
, "notáÇew buffer");

866  
bh
;

867 
îrout
:

868 
	`bªl£
(
bh
);

869  
	`ERR_PTR
(
îr
);

870 
	}
}

872 
buf„r_hód
 *
	$pxt4_bªad
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

873 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

875 
buf„r_hód
 *
bh
;

877 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
öode
, 
block
, 
m≠_Êags
);

878 i‡(
	`IS_ERR
(
bh
))

879  
bh
;

880 i‡(!
bh
 || 
	`pxt4_buf„r_u±od©e
(bh))

881  
bh
;

882 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

883 
	`waô_⁄_buf„r
(
bh
);

884 i‡(
	`buf„r_u±od©e
(
bh
))

885  
bh
;

886 
	`put_bh
(
bh
);

887  
	`ERR_PTR
(-
EIO
);

888 
	}
}

891 
	$pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

892 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
)

894 
i
, 
îr
;

896 
i
 = 0; i < 
bh_cou¡
; i++) {

897 
bhs
[
i
] = 
	`pxt4_gëblk
(
NULL
, 
öode
, 
block
 + i, 0 );

898 i‡(
	`IS_ERR
(
bhs
[
i
])) {

899 
îr
 = 
	`PTR_ERR
(
bhs
[
i
]);

900 
bh_cou¡
 = 
i
;

901 
out_bªl£
;

905 
i
 = 0; i < 
bh_cou¡
; i++)

907 i‡(
bhs
[
i
] && !
	`pxt4_buf„r_u±od©e
(bhs[i]))

908 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

909 &
bhs
[
i
]);

911 i‡(!
waô
)

914 
i
 = 0; i < 
bh_cou¡
; i++)

915 i‡(
bhs
[
i
])

916 
	`waô_⁄_buf„r
(
bhs
[
i
]);

918 
i
 = 0; i < 
bh_cou¡
; i++) {

919 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i])) {

920 
îr
 = -
EIO
;

921 
out_bªl£
;

926 
out_bªl£
:

927 
i
 = 0; i < 
bh_cou¡
; i++) {

928 
	`bªl£
(
bhs
[
i
]);

929 
bhs
[
i
] = 
NULL
;

931  
îr
;

932 
	}
}

934 
	$pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

935 
buf„r_hód
 *
hód
,

936 
‰om
,

937 
to
,

938 *
∑πül
,

939 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

940 
buf„r_hód
 *
bh
))

942 
buf„r_hód
 *
bh
;

943 
block_°¨t
, 
block_íd
;

944 
blocksize
 = 
hód
->
b_size
;

945 
îr
, 
ªt
 = 0;

946 
buf„r_hód
 *
√xt
;

948 
bh
 = 
hód
, 
block_°¨t
 = 0;

949 
ªt
 =0 && (
bh
 !
hód
 || !
block_°¨t
);

950 
block_°¨t
 = 
block_íd
, 
bh
 = 
√xt
) {

951 
√xt
 = 
bh
->
b_this_∑ge
;

952 
block_íd
 = 
block_°¨t
 + 
blocksize
;

953 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

954 i‡(
∑πül
 && !
	`buf„r_u±od©e
(
bh
))

955 *
∑πül
 = 1;

958 
îr
 = (*
‚
)(
h™dÀ
, 
bh
);

959 i‡(!
ªt
)

960 
ªt
 = 
îr
;

962  
ªt
;

963 
	}
}

989 
	$do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

990 
buf„r_hód
 *
bh
)

992 
dúty
 = 
	`buf„r_dúty
(
bh
);

993 
ªt
;

995 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1005 i‡(
dúty
)

1006 
	`˛ór_buf„r_dúty
(
bh
);

1007 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

1008 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1009 i‡(!
ªt
 && 
dúty
)

1010 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1011  
ªt
;

1012 
	}
}

1014 #ifde‡
CONFIG_FS_ENCRYPTION


1015 
	$pxt4_block_wrôe_begö
(
∑ge
 *∑ge, 
loff_t
 
pos
, 
Àn
,

1016 
gë_block_t
 *
gë_block
)

1018 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1019 
to
 = 
‰om
 + 
Àn
;

1020 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1021 
block_°¨t
, 
block_íd
;

1022 
£˘‹_t
 
block
;

1023 
îr
 = 0;

1024 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1025 
bbôs
;

1026 
buf„r_hód
 *
bh
, *
hód
, *
waô
[2];

1027 
ƒ_waô
 = 0;

1028 
i
;

1030 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1031 
	`BUG_ON
(
‰om
 > 
PAGE_SIZE
);

1032 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1033 
	`BUG_ON
(
‰om
 > 
to
);

1035 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1036 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

1037 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1038 
bbôs
 = 
	`ûog2
(
blocksize
);

1039 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
bbôs
);

1041 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

1042 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

1043 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1044 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1045 i‡(
	`PageU±od©e
(
∑ge
)) {

1046 i‡(!
	`buf„r_u±od©e
(
bh
))

1047 
	`£t_buf„r_u±od©e
(
bh
);

1051 i‡(
	`buf„r_√w
(
bh
))

1052 
	`˛ór_buf„r_√w
(
bh
);

1053 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

1054 
	`WARN_ON
(
bh
->
b_size
 !
blocksize
);

1055 
îr
 = 
	`gë_block
(
öode
, 
block
, 
bh
, 1);

1056 i‡(
îr
)

1058 i‡(
	`buf„r_√w
(
bh
)) {

1059 i‡(
	`PageU±od©e
(
∑ge
)) {

1060 
	`˛ór_buf„r_√w
(
bh
);

1061 
	`£t_buf„r_u±od©e
(
bh
);

1062 
	`m¨k_buf„r_dúty
(
bh
);

1065 i‡(
block_íd
 > 
to
 || 
block_°¨t
 < 
‰om
)

1066 
	`zîo_u£r_£gmíts
(
∑ge
, 
to
, 
block_íd
,

1067 
block_°¨t
, 
‰om
);

1071 i‡(
	`PageU±od©e
(
∑ge
)) {

1072 i‡(!
	`buf„r_u±od©e
(
bh
))

1073 
	`£t_buf„r_u±od©e
(
bh
);

1076 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_dñay
(bh) &&

1077 !
	`buf„r_unwrôãn
(
bh
) &&

1078 (
block_°¨t
 < 
‰om
 || 
block_íd
 > 
to
)) {

1079 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1080 
waô
[
ƒ_waô
++] = 
bh
;

1086 
i
 = 0; i < 
ƒ_waô
; i++) {

1087 
	`waô_⁄_buf„r
(
waô
[
i
]);

1088 i‡(!
	`buf„r_u±od©e
(
waô
[
i
]))

1089 
îr
 = -
EIO
;

1091 i‡(
	`u∆ikñy
(
îr
)) {

1092 
	`∑ge_zîo_√w_buf„rs
(
∑ge
, 
‰om
, 
to
);

1093 } i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
)) {

1094 
i
 = 0; i < 
ƒ_waô
; i++) {

1095 
îr2
;

1097 
îr2
 = 
	`fs¸y±_de¸y±_∑geˇche_blocks
(
∑ge
, 
blocksize
,

1098 
	`bh_off£t
(
waô
[
i
]));

1099 i‡(
îr2
) {

1100 
	`˛ór_buf„r_u±od©e
(
waô
[
i
]);

1101 
îr
 = 
îr2
;

1106  
îr
;

1107 
	}
}

1110 
	$pxt4_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

1111 
loff_t
 
pos
, 
Àn
, 
Êags
,

1112 
∑ge
 **
∑gï
, **
fsd©a
)

1114 
öode
 *öodê
m≠pög
->
ho°
;

1115 
ªt
, 
√eded_blocks
;

1116 
h™dÀ_t
 *
h™dÀ
;

1117 
ªåõs
 = 0;

1118 
∑ge
 *page;

1119 
pgoff_t
 
ödex
;

1120 
‰om
, 
to
;

1122 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

1123  -
EIO
;

1125 
	`åa˚_pxt4_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

1130 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

1131 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

1132 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1133 
to
 = 
‰om
 + 
Àn
;

1135 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

1136 
ªt
 = 
	`pxt4_åy_to_wrôe_ölöe_d©a
(
m≠pög
, 
öode
, 
pos
, 
Àn
,

1137 
Êags
, 
∑gï
);

1138 i‡(
ªt
 < 0)

1139  
ªt
;

1140 i‡(
ªt
 == 1)

1151 
ªåy_gøb
:

1152 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

1153 i‡(!
∑ge
)

1154  -
ENOMEM
;

1155 
	`u∆ock_∑ge
(
∑ge
);

1157 
ªåy_jou∫Æ
:

1158 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

1159 i‡(
	`IS_ERR
(
h™dÀ
)) {

1160 
	`put_∑ge
(
∑ge
);

1161  
	`PTR_ERR
(
h™dÀ
);

1164 
	`lock_∑ge
(
∑ge
);

1165 i‡(
∑ge
->
m≠pög
 != mapping) {

1167 
	`u∆ock_∑ge
(
∑ge
);

1168 
	`put_∑ge
(
∑ge
);

1169 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1170 
ªåy_gøb
;

1173 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

1175 #ifde‡
CONFIG_FS_ENCRYPTION


1176 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1177 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1178 
pxt4_gë_block_unwrôãn
);

1180 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1181 
pxt4_gë_block
);

1183 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1184 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1185 
pxt4_gë_block_unwrôãn
);

1187 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_gë_block
);

1189 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

1190 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

1191 
‰om
, 
to
, 
NULL
,

1192 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1195 i‡(
ªt
) {

1196 
boﬁ
 
exãnded
 = (
pos
 + 
Àn
 > 
öode
->
i_size
) &&

1197 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1199 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
exãnded
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

1209 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1211 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1212 i‡(
exãnded
) {

1213 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1220 i‡(
öode
->
i_∆ök
)

1221 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1224 i‡(
ªt
 =-
ENOSPC
 &&

1225 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1226 
ªåy_jou∫Æ
;

1227 
	`put_∑ge
(
∑ge
);

1228  
ªt
;

1230 *
∑gï
 = 
∑ge
;

1231  
ªt
;

1232 
	}
}

1235 
	$wrôe_íd_‚
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1237 
ªt
;

1238 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1240 
	`£t_buf„r_u±od©e
(
bh
);

1241 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1242 
	`˛ór_buf„r_mëa
(
bh
);

1243 
	`˛ór_buf„r_¥io
(
bh
);

1244  
ªt
;

1245 
	}
}

1254 
	$pxt4_wrôe_íd
(
fûe
 *file,

1255 
addªss_•a˚
 *
m≠pög
,

1256 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1257 
∑ge
 *∑ge, *
fsd©a
)

1259 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1260 
öode
 *öodê
m≠pög
->
ho°
;

1261 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1262 
ªt
 = 0, 
ªt2
;

1263 
i_size_ch™ged
 = 0;

1264 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1265 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1267 
	`åa˚_pxt4_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1268 i‡(
ölöe_d©a
) {

1269 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1270 
c›õd
, 
∑ge
);

1271 i‡(
ªt
 < 0) {

1272 
	`u∆ock_∑ge
(
∑ge
);

1273 
	`put_∑ge
(
∑ge
);

1274 
îrout
;

1276 
c›õd
 = 
ªt
;

1278 
c›õd
 = 
	`block_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

1279 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

1287 i‡(!
vîôy
)

1288 
i_size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1289 
	`u∆ock_∑ge
(
∑ge
);

1290 
	`put_∑ge
(
∑ge
);

1292 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1293 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1300 i‡(
i_size_ch™ged
 || 
ölöe_d©a
)

1301 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1303 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1308 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1309 
îrout
:

1310 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1311 i‡(!
ªt
)

1312 
ªt
 = 
ªt2
;

1314 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1315 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1321 i‡(
öode
->
i_∆ök
)

1322 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1325  
ªt
 ?Ñë : 
c›õd
;

1326 
	}
}

1333 
	$pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1334 
∑ge
 *page,

1335 
‰om
, 
to
)

1337 
block_°¨t
 = 0, 
block_íd
;

1338 
buf„r_hód
 *
hód
, *
bh
;

1340 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1342 
block_íd
 = 
block_°¨t
 + 
bh
->
b_size
;

1343 i‡(
	`buf„r_√w
(
bh
)) {

1344 i‡(
block_íd
 > 
‰om
 && 
block_°¨t
 < 
to
) {

1345 i‡(!
	`PageU±od©e
(
∑ge
)) {

1346 
°¨t
, 
size
;

1348 
°¨t
 = 
	`max
(
‰om
, 
block_°¨t
);

1349 
size
 = 
	`mö
(
to
, 
block_íd
Ë- 
°¨t
;

1351 
	`zîo_u£r
(
∑ge
, 
°¨t
, 
size
);

1352 
	`wrôe_íd_‚
(
h™dÀ
, 
bh
);

1354 
	`˛ór_buf„r_√w
(
bh
);

1357 
block_°¨t
 = 
block_íd
;

1358 
bh
 = bh->
b_this_∑ge
;

1359 } 
bh
 !
hód
);

1360 
	}
}

1362 
	$pxt4_jou∫ÆÀd_wrôe_íd
(
fûe
 *file,

1363 
addªss_•a˚
 *
m≠pög
,

1364 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1365 
∑ge
 *∑ge, *
fsd©a
)

1367 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1368 
öode
 *öodê
m≠pög
->
ho°
;

1369 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1370 
ªt
 = 0, 
ªt2
;

1371 
∑πül
 = 0;

1372 
‰om
, 
to
;

1373 
size_ch™ged
 = 0;

1374 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1375 
boﬁ
 
vîôy
 = 
	`pxt4_vîôy_ö_¥ogªss
(
öode
);

1377 
	`åa˚_pxt4_jou∫ÆÀd_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1378 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1379 
to
 = 
‰om
 + 
Àn
;

1381 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1383 i‡(
ölöe_d©a
) {

1384 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1385 
c›õd
, 
∑ge
);

1386 i‡(
ªt
 < 0) {

1387 
	`u∆ock_∑ge
(
∑ge
);

1388 
	`put_∑ge
(
∑ge
);

1389 
îrout
;

1391 
c›õd
 = 
ªt
;

1392 } i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
Ë&& !
	`PageU±od©e
(
∑ge
)) {

1393 
c›õd
 = 0;

1394 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
, 
‰om
, 
to
);

1396 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
))

1397 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
,

1398 
‰om
 + 
c›õd
, 
to
);

1399 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 
‰om
,

1400 
‰om
 + 
c›õd
, &
∑πül
,

1401 
wrôe_íd_‚
);

1402 i‡(!
∑πül
)

1403 
	`SëPageU±od©e
(
∑ge
);

1405 i‡(!
vîôy
)

1406 
size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1407 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1408 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1409 
	`u∆ock_∑ge
(
∑ge
);

1410 
	`put_∑ge
(
∑ge
);

1412 i‡(
ﬁd_size
 < 
pos
 && !
vîôy
)

1413 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1415 i‡(
size_ch™ged
 || 
ölöe_d©a
) {

1416 
ªt2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1417 i‡(!
ªt
)

1418 
ªt
 = 
ªt2
;

1421 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
 && 
	`pxt4_ˇn_åunˇã
(inode))

1426 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1428 
îrout
:

1429 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1430 i‡(!
ªt
)

1431 
ªt
 = 
ªt2
;

1432 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && !
vîôy
) {

1433 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1439 i‡(
öode
->
i_∆ök
)

1440 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1443  
ªt
 ?Ñë : 
c›õd
;

1444 
	}
}

1449 
	$pxt4_da_ª£rve_•a˚
(
öode
 *inode)

1451 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1452 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1453 
ªt
;

1460 
ªt
 = 
	`dquŸ_ª£rve_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1461 i‡(
ªt
)

1462  
ªt
;

1464 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1465 i‡(
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 1, 0)) {

1466 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1467 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1468  -
ENOSPC
;

1470 
ei
->
i_ª£rved_d©a_blocks
++;

1471 
	`åa˚_pxt4_da_ª£rve_•a˚
(
öode
);

1472 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1475 
	}
}

1477 
	$pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
)

1479 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1480 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1482 i‡(!
to_‰ì
)

1485 
	`•ö_lock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1487 
	`åa˚_pxt4_da_ªÀa£_•a˚
(
öode
, 
to_‰ì
);

1488 i‡(
	`u∆ikñy
(
to_‰ì
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

1495 
	`pxt4_w¨nög
(
öode
->
i_sb
, "pxt4_da_release_space: "

1497 "d©®blocks", 
öode
->
i_öo
, 
to_‰ì
,

1498 
ei
->
i_ª£rved_d©a_blocks
);

1499 
	`WARN_ON
(1);

1500 
to_‰ì
 = 
ei
->
i_ª£rved_d©a_blocks
;

1502 
ei
->
i_ª£rved_d©a_blocks
 -
to_‰ì
;

1505 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
to_‰ì
);

1507 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1509 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
to_‰ì
));

1510 
	}
}

1516 
	sm∑ge_da_d©a
 {

1517 
öode
 *
	möode
;

1518 
wrôeback_c⁄åﬁ
 *
	mwbc
;

1520 
pgoff_t
 
	mfú°_∑ge
;

1521 
pgoff_t
 
	m√xt_∑ge
;

1522 
pgoff_t
 
	mœ°_∑ge
;

1528 
pxt4_m≠_blocks
 
	mm≠
;

1529 
pxt4_io_submô
 
	mio_submô
;

1530 
	mdo_m≠
:1;

1533 
	$m∑ge_ªÀa£_unu£d_∑ges
(
m∑ge_da_d©a
 *
mpd
,

1534 
boﬁ
 
övÆid©e
)

1536 
ƒ_∑ges
, 
i
;

1537 
pgoff_t
 
ödex
, 
íd
;

1538 
∑gevec
 
pvec
;

1539 
öode
 *öodê
mpd
->inode;

1540 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

1543 i‡(
mpd
->
fú°_∑ge
 >mpd->
√xt_∑ge
)

1546 
ödex
 = 
mpd
->
fú°_∑ge
;

1547 
íd
 = 
mpd
->
√xt_∑ge
 - 1;

1548 i‡(
övÆid©e
) {

1549 
pxt4_lblk_t
 
°¨t
, 
œ°
;

1550 
°¨t
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1551 
œ°
 = 
íd
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1552 
	`pxt4_es_ªmove_exã¡
(
öode
, 
°¨t
, 
œ°
 - start + 1);

1555 
	`∑gevec_öô
(&
pvec
);

1556 
ödex
 <
íd
) {

1557 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
);

1558 i‡(
ƒ_∑ges
 == 0)

1560 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1561 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

1563 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1564 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

1565 i‡(
övÆid©e
) {

1566 i‡(
	`∑ge_m≠≥d
(
∑ge
))

1567 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

1568 
	`block_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1569 
	`CÀ¨PageU±od©e
(
∑ge
);

1571 
	`u∆ock_∑ge
(
∑ge
);

1573 
	`∑gevec_ªÀa£
(&
pvec
);

1575 
	}
}

1577 
	$pxt4_¥öt_‰ì_blocks
(
öode
 *inode)

1579 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1580 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1581 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1583 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1584 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

1585 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
)));

1586 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1587 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1588 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1589 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_‰ì˛u°îs_cou¡î
)));

1590 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1591 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1592 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

1593 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "BlockÑeservation details");

1594 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1595 
ei
->
i_ª£rved_d©a_blocks
);

1597 
	}
}

1599 
	$pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1601  (
	`buf„r_dñay
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)Ë&& 
	`buf„r_dúty
(bh);

1602 
	}
}

1615 
	$pxt4_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1617 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1618 
ªt
;

1619 
boﬁ
 
Æloˇãd
 = 
Ál£
;

1632 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1633 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1634 i‡(
ªt
 != 0)

1635 
îrout
;

1637 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
lblk
)) {

1638 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
,

1639 &
pxt4_es_is_m≠≥d
, 
lblk
)) {

1640 
ªt
 = 
	`pxt4_˛u_m≠≥d
(
öode
,

1641 
	`PXT4_B2C
(
sbi
, 
lblk
));

1642 i‡(
ªt
 < 0)

1643 
îrout
;

1644 i‡(
ªt
 == 0) {

1645 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1646 i‡(
ªt
 != 0)

1647 
îrout
;

1649 
Æloˇãd
 = 
åue
;

1652 
Æloˇãd
 = 
åue
;

1657 
ªt
 = 
	`pxt4_es_ö£π_dñayed_block
(
öode
, 
lblk
, 
Æloˇãd
);

1659 
îrout
:

1660  
ªt
;

1661 
	}
}

1669 
	$pxt4_da_m≠_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1670 
pxt4_m≠_blocks
 *
m≠
,

1671 
buf„r_hód
 *
bh
)

1673 
exã¡_°©us
 
es
;

1674 
ªtvÆ
;

1675 
£˘‹_t
 
övÆid_block
 = ~((sector_t) 0xffff);

1676 #ifde‡
ES_AGGRESSIVE_TEST


1677 
pxt4_m≠_blocks
 
‹ig_m≠
;

1679 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

1682 i‡(
övÆid_block
 < 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
))

1683 
övÆid_block
 = ~0;

1685 
m≠
->
m_Êags
 = 0;

1686 
	`ext_debug
("pxt4_da_map_blocks(): inode %lu, max_blocks %u,"

1687 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
m≠
->
m_Àn
,

1688 (Ë
m≠
->
m_lblk
);

1691 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
iblock
, 
NULL
, &
es
)) {

1692 i‡(
	`pxt4_es_is_hﬁe
(&
es
)) {

1693 
ªtvÆ
 = 0;

1694 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1695 
add_dñayed
;

1702 i‡(
	`pxt4_es_is_dñayed
(&
es
Ë&& !
	`pxt4_es_is_unwrôãn
(&es)) {

1703 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1704 
	`£t_buf„r_√w
(
bh
);

1705 
	`£t_buf„r_dñay
(
bh
);

1709 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
Ë+ 
iblock
 -És.
es_lblk
;

1710 
ªtvÆ
 = 
es
.
es_Àn
 - (
iblock
 -És.
es_lblk
);

1711 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

1712 
ªtvÆ
 = 
m≠
->
m_Àn
;

1713 
m≠
->
m_Àn
 = 
ªtvÆ
;

1714 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

1715 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

1716 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

1717 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

1719 
	`BUG
();

1721 #ifde‡
ES_AGGRESSIVE_TEST


1722 
	`pxt4_m≠_blocks_es_ªcheck
(
NULL
, 
öode
, 
m≠
, &
‹ig_m≠
, 0);

1724  
ªtvÆ
;

1731 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1732 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

1733 
ªtvÆ
 = 0;

1734 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

1735 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1737 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1739 
add_dñayed
:

1740 i‡(
ªtvÆ
 == 0) {

1741 
ªt
;

1748 
ªt
 = 
	`pxt4_ö£π_dñayed_block
(
öode
, 
m≠
->
m_lblk
);

1749 i‡(
ªt
 != 0) {

1750 
ªtvÆ
 = 
ªt
;

1751 
out_u∆ock
;

1754 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1755 
	`£t_buf„r_√w
(
bh
);

1756 
	`£t_buf„r_dñay
(
bh
);

1757 } i‡(
ªtvÆ
 > 0) {

1758 
ªt
;

1759 
°©us
;

1761 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

1762 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1765 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

1766 
	`WARN_ON
(1);

1769 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

1770 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1771 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

1772 
m≠
->
m_pblk
, 
°©us
);

1773 i‡(
ªt
 != 0)

1774 
ªtvÆ
 = 
ªt
;

1777 
out_u∆ock
:

1778 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

1780  
ªtvÆ
;

1781 
	}
}

1795 
	$pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1796 
buf„r_hód
 *
bh
, 
¸óã
)

1798 
pxt4_m≠_blocks
 
m≠
;

1799 
ªt
 = 0;

1801 
	`BUG_ON
(
¸óã
 == 0);

1802 
	`BUG_ON
(
bh
->
b_size
 !
öode
->
i_sb
->
s_blocksize
);

1804 
m≠
.
m_lblk
 = 
iblock
;

1805 
m≠
.
m_Àn
 = 1;

1812 
ªt
 = 
	`pxt4_da_m≠_blocks
(
öode
, 
iblock
, &
m≠
, 
bh
);

1813 i‡(
ªt
 <= 0)

1814  
ªt
;

1816 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

1817 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

1819 i‡(
	`buf„r_unwrôãn
(
bh
)) {

1826 
	`£t_buf„r_√w
(
bh
);

1827 
	`£t_buf„r_m≠≥d
(
bh
);

1830 
	}
}

1832 
	$bgë_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1834 
	`gë_bh
(
bh
);

1836 
	}
}

1838 
	$bput_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1840 
	`put_bh
(
bh
);

1842 
	}
}

1844 
	$__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *page,

1845 
Àn
)

1847 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

1848 
öode
 *öodê
m≠pög
->
ho°
;

1849 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

1850 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

1851 
ªt
 = 0, 
îr
 = 0;

1852 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1853 
buf„r_hód
 *
öode_bh
 = 
NULL
;

1855 
	`CÀ¨PageChecked
(
∑ge
);

1857 i‡(
ölöe_d©a
) {

1858 
	`BUG_ON
(
∑ge
->
ödex
 != 0);

1859 
	`BUG_ON
(
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
));

1860 
öode_bh
 = 
	`pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
, 
Àn
, 
∑ge
);

1861 i‡(
öode_bh
 =
NULL
)

1862 
out
;

1864 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

1865 i‡(!
∑ge_bufs
) {

1866 
	`BUG
();

1867 
out
;

1869 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
,

1870 
NULL
, 
bgë_⁄e
);

1877 
	`gë_∑ge
(
∑ge
);

1878 
	`u∆ock_∑ge
(
∑ge
);

1880 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

1881 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

1882 i‡(
	`IS_ERR
(
h™dÀ
)) {

1883 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1884 
	`put_∑ge
(
∑ge
);

1885 
out_no_∑gñock
;

1887 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1889 
	`lock_∑ge
(
∑ge
);

1890 
	`put_∑ge
(
∑ge
);

1891 i‡(
∑ge
->
m≠pög
 != mapping) {

1893 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1894 
ªt
 = 0;

1895 
out
;

1898 i‡(
ölöe_d©a
) {

1899 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1901 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

1902 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1904 
îr
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

1905 
wrôe_íd_‚
);

1907 i‡(
ªt
 == 0)

1908 
ªt
 = 
îr
;

1909 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1910 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1911 i‡(!
ªt
)

1912 
ªt
 = 
îr
;

1914 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1915 
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
,

1916 
NULL
, 
bput_⁄e
);

1917 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1918 
out
:

1919 
	`u∆ock_∑ge
(
∑ge
);

1920 
out_no_∑gñock
:

1921 
	`bªl£
(
öode_bh
);

1922  
ªt
;

1923 
	}
}

1966 
	$pxt4_wrôïage
(
∑ge
 *page,

1967 
wrôeback_c⁄åﬁ
 *
wbc
)

1969 
ªt
 = 0;

1970 
loff_t
 
size
;

1971 
Àn
;

1972 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

1973 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1974 
pxt4_io_submô
 
io_submô
;

1975 
boﬁ
 
kìp_towrôe
 = 
Ál£
;

1977 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

1978 
	`pxt4_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1979 
	`u∆ock_∑ge
(
∑ge
);

1980  -
EIO
;

1983 
	`åa˚_pxt4_wrôïage
(
∑ge
);

1984 
size
 = 
	`i_size_ªad
(
öode
);

1985 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

1986 !
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

1987 
Àn
 = 
size
 & ~
PAGE_MASK
;

1989 
Àn
 = 
PAGE_SIZE
;

1991 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2009 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
, NULL,

2010 
pxt4_bh_dñay_‹_unwrôãn
)) {

2011 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2012 i‡((
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

2013 (
öode
->
i_sb
->
s_blocksize
 =
PAGE_SIZE
)) {

2019 
	`WARN_ON_ONCE
((
cuºít
->
Êags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2020 =
PF_MEMALLOC
);

2021 
	`u∆ock_∑ge
(
∑ge
);

2024 
kìp_towrôe
 = 
åue
;

2027 i‡(
	`PageChecked
(
∑ge
Ë&& 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2032  
	`__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
, 
Àn
);

2034 
	`pxt4_io_submô_öô
(&
io_submô
, 
wbc
);

2035 
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_NOFS
);

2036 i‡(!
io_submô
.
io_íd
) {

2037 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2038 
	`u∆ock_∑ge
(
∑ge
);

2039  -
ENOMEM
;

2041 
ªt
 = 
	`pxt4_bio_wrôe_∑ge
(&
io_submô
, 
∑ge
, 
Àn
, 
wbc
, 
kìp_towrôe
);

2042 
	`pxt4_io_submô
(&
io_submô
);

2044 
	`pxt4_put_io_íd_de„r
(
io_submô
.
io_íd
);

2045  
ªt
;

2046 
	}
}

2048 
	$m∑ge_submô_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page)

2050 
Àn
;

2051 
loff_t
 
size
;

2052 
îr
;

2054 
	`BUG_ON
(
∑ge
->
ödex
 !
mpd
->
fú°_∑ge
);

2055 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2069 
size
 = 
	`i_size_ªad
(
mpd
->
öode
);

2070 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
 &&

2071 !
	`pxt4_vîôy_ö_¥ogªss
(
mpd
->
öode
))

2072 
Àn
 = 
size
 & ~
PAGE_MASK
;

2074 
Àn
 = 
PAGE_SIZE
;

2075 
îr
 = 
	`pxt4_bio_wrôe_∑ge
(&
mpd
->
io_submô
, 
∑ge
, 
Àn
, mpd->
wbc
, 
Ál£
);

2076 i‡(!
îr
)

2077 
mpd
->
wbc
->
ƒ_to_wrôe
--;

2078 
mpd
->
fú°_∑ge
++;

2080  
îr
;

2081 
	}
}

2083 
	#BH_FLAGS
 ((1 << 
BH_Unwrôãn
Ë| (1 << 
BH_Dñay
))

	)

2090 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2106 
boﬁ
 
	$m∑ge_add_bh_to_exã¡
(
m∑ge_da_d©a
 *
mpd
, 
pxt4_lblk_t
 
lblk
,

2107 
buf„r_hód
 *
bh
)

2109 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2112 i‡(!
	`buf„r_dúty
(
bh
Ë|| !
	`buf„r_m≠≥d
(bh) ||

2113 (!
	`buf„r_dñay
(
bh
Ë&& !
	`buf„r_unwrôãn
(bh))) {

2115 i‡(
m≠
->
m_Àn
 == 0)

2116  
åue
;

2117  
Ál£
;

2121 i‡(
m≠
->
m_Àn
 == 0) {

2123 i‡(!
mpd
->
do_m≠
)

2124  
Ál£
;

2125 
m≠
->
m_lblk
 = 
lblk
;

2126 
m≠
->
m_Àn
 = 1;

2127 
m≠
->
m_Êags
 = 
bh
->
b_°©e
 & 
BH_FLAGS
;

2128  
åue
;

2132 i‡(
m≠
->
m_Àn
 >
MAX_WRITEPAGES_EXTENT_LEN
)

2133  
Ál£
;

2136 i‡(
lblk
 =
m≠
->
m_lblk
 + m≠->
m_Àn
 &&

2137 (
bh
->
b_°©e
 & 
BH_FLAGS
Ë=
m≠
->
m_Êags
) {

2138 
m≠
->
m_Àn
++;

2139  
åue
;

2141  
Ál£
;

2142 
	}
}

2160 
	$m∑ge_¥o˚ss_∑ge_bufs
(
m∑ge_da_d©a
 *
mpd
,

2161 
buf„r_hód
 *
hód
,

2162 
buf„r_hód
 *
bh
,

2163 
pxt4_lblk_t
 
lblk
)

2165 
öode
 *öodê
mpd
->inode;

2166 
îr
;

2167 
pxt4_lblk_t
 
blocks
 = (
	`i_size_ªad
(
öode
Ë+ 
	`i_blocksize
(inode) - 1)

2168 >> 
öode
->
i_blkbôs
;

2170 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

2171 
blocks
 = 
EXT_MAX_BLOCKS
;

2174 
	`BUG_ON
(
	`buf„r_locked
(
bh
));

2176 i‡(
lblk
 >
blocks
 || !
	`m∑ge_add_bh_to_exã¡
(
mpd
,Üblk, 
bh
)) {

2178 i‡(
mpd
->
m≠
.
m_Àn
)

2181 i‡(!
mpd
->
do_m≠
)

2186 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2188 i‡(
mpd
->
m≠
.
m_Àn
 == 0) {

2189 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
hód
->
b_∑ge
);

2190 i‡(
îr
 < 0)

2191  
îr
;

2193  
lblk
 < 
blocks
;

2194 
	}
}

2211 
	$m∑ge_¥o˚ss_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page,

2212 
pxt4_lblk_t
 *
m_lblk
, 
pxt4_fsblk_t
 *
m_pblk
,

2213 
boﬁ
 *
m≠_bh
)

2215 
buf„r_hód
 *
hód
, *
bh
;

2216 
pxt4_io_íd_t
 *
io_íd
 = 
mpd
->
io_submô
.io_end;

2217 
pxt4_lblk_t
 
lblk
 = *
m_lblk
;

2218 
pxt4_fsblk_t
 
pblock
 = *
m_pblk
;

2219 
îr
 = 0;

2220 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2221 
ssize_t
 
io_íd_size
 = 0;

2222 
pxt4_io_íd_vec
 *
io_íd_vec
 = 
	`pxt4_œ°_io_íd_vec
(
io_íd
);

2224 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2226 i‡(
lblk
 < 
mpd
->
m≠
.
m_lblk
)

2228 i‡(
lblk
 >
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
) {

2233 
mpd
->
m≠
.
m_Àn
 = 0;

2234 
mpd
->
m≠
.
m_Êags
 = 0;

2235 
io_íd_vec
->
size
 +
io_íd_size
;

2236 
io_íd_size
 = 0;

2238 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, 
bh
, 
lblk
);

2239 i‡(
îr
 > 0)

2240 
îr
 = 0;

2241 i‡(!
îr
 && 
mpd
->
m≠
.
m_Àn
 && mpd->m≠.
m_lblk
 > 
lblk
) {

2242 
io_íd_vec
 = 
	`pxt4_Æloc_io_íd_vec
(
io_íd
);

2243 i‡(
	`IS_ERR
(
io_íd_vec
)) {

2244 
îr
 = 
	`PTR_ERR
(
io_íd_vec
);

2245 
out
;

2247 
io_íd_vec
->
off£t
 = 
mpd
->
m≠
.
m_lblk
 << 
blkbôs
;

2249 *
m≠_bh
 = 
åue
;

2250 
out
;

2252 i‡(
	`buf„r_dñay
(
bh
)) {

2253 
	`˛ór_buf„r_dñay
(
bh
);

2254 
bh
->
b_blockƒ
 = 
pblock
++;

2256 
	`˛ór_buf„r_unwrôãn
(
bh
);

2257 
io_íd_size
 +(1 << 
blkbôs
);

2258 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2260 
io_íd_vec
->
size
 +
io_íd_size
;

2261 
io_íd_size
 = 0;

2262 *
m≠_bh
 = 
Ál£
;

2263 
out
:

2264 *
m_lblk
 = 
lblk
;

2265 *
m_pblk
 = 
pblock
;

2266  
îr
;

2267 
	}
}

2283 
	$m∑ge_m≠_™d_submô_buf„rs
(
m∑ge_da_d©a
 *
mpd
)

2285 
∑gevec
 
pvec
;

2286 
ƒ_∑ges
, 
i
;

2287 
öode
 *öodê
mpd
->inode;

2288 
bµ_bôs
 = 
PAGE_SHIFT
 - 
öode
->
i_blkbôs
;

2289 
pgoff_t
 
°¨t
, 
íd
;

2290 
pxt4_lblk_t
 
lblk
;

2291 
pxt4_fsblk_t
 
pblock
;

2292 
îr
;

2293 
boﬁ
 
m≠_bh
 = 
Ál£
;

2295 
°¨t
 = 
mpd
->
m≠
.
m_lblk
 >> 
bµ_bôs
;

2296 
íd
 = (
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
 - 1Ë>> 
bµ_bôs
;

2297 
lblk
 = 
°¨t
 << 
bµ_bôs
;

2298 
pblock
 = 
mpd
->
m≠
.
m_pblk
;

2300 
	`∑gevec_öô
(&
pvec
);

2301 
°¨t
 <
íd
) {

2302 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
öode
->
i_m≠pög
,

2303 &
°¨t
, 
íd
);

2304 i‡(
ƒ_∑ges
 == 0)

2306 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2307 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2309 
îr
 = 
	`m∑ge_¥o˚ss_∑ge
(
mpd
, 
∑ge
, &
lblk
, &
pblock
,

2310 &
m≠_bh
);

2316 i‡(
îr
 < 0 || 
m≠_bh
 =
åue
)

2317 
out
;

2319 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
∑ge
);

2320 i‡(
îr
 < 0)

2321 
out
;

2323 
	`∑gevec_ªÀa£
(&
pvec
);

2326 
mpd
->
m≠
.
m_Àn
 = 0;

2327 
mpd
->
m≠
.
m_Êags
 = 0;

2329 
out
:

2330 
	`∑gevec_ªÀa£
(&
pvec
);

2331  
îr
;

2332 
	}
}

2334 
	$m∑ge_m≠_⁄e_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
m∑ge_da_d©a
 *
mpd
)

2336 
öode
 *öodê
mpd
->inode;

2337 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2338 
gë_blocks_Êags
;

2339 
îr
, 
di‹ód_nﬁock
;

2341 
	`åa˚_pxt4_da_wrôe_∑ges_exã¡
(
öode
, 
m≠
);

2357 
gë_blocks_Êags
 = 
PXT4_GET_BLOCKS_CREATE
 |

2358 
PXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2359 
PXT4_GET_BLOCKS_IO_SUBMIT
;

2360 
di‹ód_nﬁock
 = 
	`pxt4_should_di‹ód_nﬁock
(
öode
);

2361 i‡(
di‹ód_nﬁock
)

2362 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

2363 i‡(
m≠
->
m_Êags
 & (1 << 
BH_Dñay
))

2364 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2366 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
gë_blocks_Êags
);

2367 i‡(
îr
 < 0)

2368  
îr
;

2369 i‡(
di‹ód_nﬁock
 && (
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
)) {

2370 i‡(!
mpd
->
io_submô
.
io_íd
->
h™dÀ
 &&

2371 
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2372 
mpd
->
io_submô
.
io_íd
->
h™dÀ
 = h™dÀ->
h_rsv_h™dÀ
;

2373 
h™dÀ
->
h_rsv_h™dÀ
 = 
NULL
;

2375 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
mpd
->
io_submô
.
io_íd
);

2378 
	`BUG_ON
(
m≠
->
m_Àn
 == 0);

2380 
	}
}

2402 
	$m∑ge_m≠_™d_submô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

2403 
m∑ge_da_d©a
 *
mpd
,

2404 
boﬁ
 *
give_up_⁄_wrôe
)

2406 
öode
 *öodê
mpd
->inode;

2407 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2408 
îr
;

2409 
loff_t
 
disksize
;

2410 
¥ogªss
 = 0;

2411 
pxt4_io_íd_t
 *
io_íd
 = 
mpd
->
io_submô
.io_end;

2412 
pxt4_io_íd_vec
 *
io_íd_vec
;

2414 
io_íd_vec
 = 
	`pxt4_Æloc_io_íd_vec
(
io_íd
);

2415 i‡(
	`IS_ERR
(
io_íd_vec
))

2416  
	`PTR_ERR
(
io_íd_vec
);

2417 
io_íd_vec
->
off£t
 = ((
loff_t
)
m≠
->
m_lblk
Ë<< 
öode
->
i_blkbôs
;

2419 
îr
 = 
	`m∑ge_m≠_⁄e_exã¡
(
h™dÀ
, 
mpd
);

2420 i‡(
îr
 < 0) {

2421 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2423 i‡(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
)) ||

2424 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

2425 
övÆid©e_dúty_∑ges
;

2431 i‡((
îr
 =-
ENOMEM
) ||

2432 (
îr
 =-
ENOSPC
 && 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
))) {

2433 i‡(
¥ogªss
)

2434 
upd©e_disksize
;

2435  
îr
;

2437 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2441 
öode
->
i_öo
,

2442 ()
m≠
->
m_lblk
,

2443 ()
m≠
->
m_Àn
, -
îr
);

2444 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2447 i‡(
îr
 =-
ENOSPC
)

2448 
	`pxt4_¥öt_‰ì_blocks
(
öode
);

2449 
övÆid©e_dúty_∑ges
:

2450 *
give_up_⁄_wrôe
 = 
åue
;

2451  
îr
;

2453 
¥ogªss
 = 1;

2458 
îr
 = 
	`m∑ge_m≠_™d_submô_buf„rs
(
mpd
);

2459 i‡(
îr
 < 0)

2460 
upd©e_disksize
;

2461 } 
m≠
->
m_Àn
);

2463 
upd©e_disksize
:

2468 
disksize
 = ((
loff_t
)
mpd
->
fú°_∑ge
Ë<< 
PAGE_SHIFT
;

2469 i‡(
disksize
 > 
	`READ_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
)) {

2470 
îr2
;

2471 
loff_t
 
i_size
;

2473 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2474 
i_size
 = 
	`i_size_ªad
(
öode
);

2475 i‡(
disksize
 > 
i_size
)

2476 
disksize
 = 
i_size
;

2477 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2478 
	`PXT4_I
(
öode
)->
i_disksize
 = 
disksize
;

2479 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2480 
îr2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2481 i‡(
îr2
)

2482 
	`pxt4_îr‹
(
öode
->
i_sb
,

2484 
öode
->
i_öo
);

2485 i‡(!
îr
)

2486 
îr
 = 
îr2
;

2488  
îr
;

2489 
	}
}

2498 
	$pxt4_da_wrôïages_å™s_blocks
(
öode
 *inode)

2500 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

2502  
	`pxt4_mëa_å™s_blocks
(
öode
,

2503 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2504 
	}
}

2524 
	$m∑ge_¥ï¨e_exã¡_to_m≠
(
m∑ge_da_d©a
 *
mpd
)

2526 
addªss_•a˚
 *
m≠pög
 = 
mpd
->
öode
->
i_m≠pög
;

2527 
∑gevec
 
pvec
;

2528 
ƒ_∑ges
;

2529 
À·
 = 
mpd
->
wbc
->
ƒ_to_wrôe
;

2530 
pgoff_t
 
ödex
 = 
mpd
->
fú°_∑ge
;

2531 
pgoff_t
 
íd
 = 
mpd
->
œ°_∑ge
;

2532 
xa_m¨k_t
 
èg
;

2533 
i
, 
îr
 = 0;

2534 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2535 
pxt4_lblk_t
 
lblk
;

2536 
buf„r_hód
 *
hód
;

2538 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || mpd->wbc->
ègged_wrôïages
)

2539 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2541 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2543 
	`∑gevec_öô
(&
pvec
);

2544 
mpd
->
m≠
.
m_Àn
 = 0;

2545 
mpd
->
√xt_∑ge
 = 
ödex
;

2546 
ödex
 <
íd
) {

2547 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2548 
èg
);

2549 i‡(
ƒ_∑ges
 == 0)

2550 
out
;

2552 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2553 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2563 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
 && 
À·
 <= 0)

2564 
out
;

2567 i‡(
mpd
->
m≠
.
m_Àn
 > 0 && mpd->
√xt_∑ge
 !
∑ge
->
ödex
)

2568 
out
;

2570 
	`lock_∑ge
(
∑ge
);

2578 i‡(!
	`PageDúty
(
∑ge
) ||

2579 (
	`PageWrôeback
(
∑ge
) &&

2580 (
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
)) ||

2581 
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2582 
	`u∆ock_∑ge
(
∑ge
);

2586 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2587 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2589 i‡(
mpd
->
m≠
.
m_Àn
 == 0)

2590 
mpd
->
fú°_∑ge
 = 
∑ge
->
ödex
;

2591 
mpd
->
√xt_∑ge
 = 
∑ge
->
ödex
 + 1;

2593 
lblk
 = ((
pxt4_lblk_t
)
∑ge
->
ödex
) <<

2594 (
PAGE_SHIFT
 - 
blkbôs
);

2595 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2596 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, hód, 
lblk
);

2597 i‡(
îr
 <= 0)

2598 
out
;

2599 
îr
 = 0;

2600 
À·
--;

2602 
	`∑gevec_ªÀa£
(&
pvec
);

2603 
	`c⁄d_ªsched
();

2606 
out
:

2607 
	`∑gevec_ªÀa£
(&
pvec
);

2608  
îr
;

2609 
	}
}

2611 
	$pxt4_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2612 
wrôeback_c⁄åﬁ
 *
wbc
)

2614 
pgoff_t
 
wrôeback_ödex
 = 0;

2615 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2616 
ønge_whﬁe
 = 0;

2617 
cy˛ed
 = 1;

2618 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2619 
m∑ge_da_d©a
 
mpd
;

2620 
öode
 *öodê
m≠pög
->
ho°
;

2621 
√eded_blocks
, 
rsv_blocks
 = 0, 
ªt
 = 0;

2622 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2623 
boﬁ
 
d⁄e
;

2624 
blk_∂ug
 
∂ug
;

2625 
boﬁ
 
give_up_⁄_wrôe
 = 
Ál£
;

2627 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2628  -
EIO
;

2630 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2631 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2638 i‡(!
m≠pög
->
ƒ∑ges
 || !
	`m≠pög_ègged
(m≠pög, 
PAGECACHE_TAG_DIRTY
))

2639 
out_wrôïages
;

2641 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

2642 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2643 
out_wrôïages
;

2656 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
)) ||

2657 
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)) {

2658 
ªt
 = -
EROFS
;

2659 
out_wrôïages
;

2667 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2669 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

2670 i‡(
	`IS_ERR
(
h™dÀ
)) {

2671 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2672 
out_wrôïages
;

2674 
	`BUG_ON
(
	`pxt4_ã°_öode_°©e
(
öode
,

2675 
PXT4_STATE_MAY_INLINE_DATA
));

2676 
	`pxt4_de°roy_ölöe_d©a
(
h™dÀ
, 
öode
);

2677 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2680 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

2685 
rsv_blocks
 = 1 + 
	`pxt4_chunk_å™s_blocks
(
öode
,

2686 
PAGE_SIZE
 >> 
öode
->
i_blkbôs
);

2689 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2690 
ønge_whﬁe
 = 1;

2692 i‡(
wbc
->
ønge_cy˛ic
) {

2693 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2694 i‡(
wrôeback_ödex
)

2695 
cy˛ed
 = 0;

2696 
mpd
.
fú°_∑ge
 = 
wrôeback_ödex
;

2697 
mpd
.
œ°_∑ge
 = -1;

2699 
mpd
.
fú°_∑ge
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2700 
mpd
.
œ°_∑ge
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2703 
mpd
.
öode
 = inode;

2704 
mpd
.
wbc
 = wbc;

2705 
	`pxt4_io_submô_öô
(&
mpd
.
io_submô
, 
wbc
);

2706 
ªåy
:

2707 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2708 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
mpd
.
fú°_∑ge
, mpd.
œ°_∑ge
);

2709 
d⁄e
 = 
Ál£
;

2710 
	`blk_°¨t_∂ug
(&
∂ug
);

2718 
mpd
.
do_m≠
 = 0;

2719 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2720 i‡(!
mpd
.
io_submô
.
io_íd
) {

2721 
ªt
 = -
ENOMEM
;

2722 
u≈lug
;

2724 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2726 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
Ál£
);

2728 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2729 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2730 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2731 i‡(
ªt
 < 0)

2732 
u≈lug
;

2734 !
d⁄e
 && 
mpd
.
fú°_∑ge
 <mpd.
œ°_∑ge
) {

2736 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2737 i‡(!
mpd
.
io_submô
.
io_íd
) {

2738 
ªt
 = -
ENOMEM
;

2749 
	`BUG_ON
(
	`pxt4_should_jou∫Æ_d©a
(
öode
));

2750 
√eded_blocks
 = 
	`pxt4_da_wrôïages_å™s_blocks
(
öode
);

2753 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
,

2754 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
, 
rsv_blocks
);

2755 i‡(
	`IS_ERR
(
h™dÀ
)) {

2756 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2757 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_CRIT
, "%s: jbd3_start: "

2758 "%ldÖages, inÿ%lu;Éº %d", 
__func__
,

2759 
wbc
->
ƒ_to_wrôe
, 
öode
->
i_öo
, 
ªt
);

2761 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2762 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2765 
mpd
.
do_m≠
 = 1;

2767 
	`åa˚_pxt4_da_wrôe_∑ges
(
öode
, 
mpd
.
fú°_∑ge
, mpd.
wbc
);

2768 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2769 i‡(!
ªt
) {

2770 i‡(
mpd
.
m≠
.
m_Àn
)

2771 
ªt
 = 
	`m∑ge_m≠_™d_submô_exã¡
(
h™dÀ
, &
mpd
,

2772 &
give_up_⁄_wrôe
);

2780 
d⁄e
 = 
åue
;

2793 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë|| h™dÀ->
h_sync
 == 0) {

2794 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2795 
h™dÀ
 = 
NULL
;

2796 
mpd
.
do_m≠
 = 0;

2799 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
give_up_⁄_wrôe
);

2801 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2810 i‡(
h™dÀ
) {

2811 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2812 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2814 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2815 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2817 i‡(
ªt
 =-
ENOSPC
 && 
sbi
->
s_jou∫Æ
) {

2823 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

2824 
ªt
 = 0;

2828 i‡(
ªt
)

2831 
u≈lug
:

2832 
	`blk_föish_∂ug
(&
∂ug
);

2833 i‡(!
ªt
 && !
cy˛ed
 && 
wbc
->
ƒ_to_wrôe
 > 0) {

2834 
cy˛ed
 = 1;

2835 
mpd
.
œ°_∑ge
 = 
wrôeback_ödex
 - 1;

2836 
mpd
.
fú°_∑ge
 = 0;

2837 
ªåy
;

2841 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2846 
m≠pög
->
wrôeback_ödex
 = 
mpd
.
fú°_∑ge
;

2848 
out_wrôïages
:

2849 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2850 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2851 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2852  
ªt
;

2853 
	}
}

2855 
	$pxt4_dax_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2856 
wrôeback_c⁄åﬁ
 *
wbc
)

2858 
ªt
;

2859 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2860 
öode
 *öodê
m≠pög
->
ho°
;

2861 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2863 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2864  -
EIO
;

2866 
	`≥r˝u_down_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2867 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2869 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
öode
->
i_sb
->
s_bdev
, 
wbc
);

2870 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2871 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2872 
	`≥r˝u_up_ªad
(&
sbi
->
s_wrôïages_rw£m
);

2873  
ªt
;

2874 
	}
}

2876 
	$pxt4_n⁄da_swôch
(
su≥r_block
 *
sb
)

2878 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
;

2879 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2889 
‰ì_˛u°îs
 =

2890 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

2891 
dúty_˛u°îs
 =

2892 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

2896 i‡(
dúty_˛u°îs
 && (
‰ì_˛u°îs
 < 2 * dirty_clusters))

2897 
	`åy_to_wrôeback_öodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

2899 i‡(2 * 
‰ì_˛u°îs
 < 3 * 
dúty_˛u°îs
 ||

2900 
‰ì_˛u°îs
 < (
dúty_˛u°îs
 + 
PXT4_FREECLUSTERS_WATERMARK
)) {

2908 
	}
}

2911 
	$pxt4_da_wrôe_¸edôs
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
)

2913 i‡(
	`likñy
(
	`pxt4_has_„©uª_œrge_fûe
(
öode
->
i_sb
)))

2916 i‡(
pos
 + 
Àn
 <= 0x7fffffffULL)

2921 
	}
}

2923 
	$pxt4_da_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

2924 
loff_t
 
pos
, 
Àn
, 
Êags
,

2925 
∑ge
 **
∑gï
, **
fsd©a
)

2927 
ªt
, 
ªåõs
 = 0;

2928 
∑ge
 *page;

2929 
pgoff_t
 
ödex
;

2930 
öode
 *öodê
m≠pög
->
ho°
;

2931 
h™dÀ_t
 *
h™dÀ
;

2933 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2934  -
EIO
;

2936 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

2938 i‡(
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
Ë|| 
	`S_ISLNK
(öode->
i_mode
) ||

2939 
	`pxt4_vîôy_ö_¥ogªss
(
öode
)) {

2940 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

2941  
	`pxt4_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
,

2942 
Àn
, 
Êags
, 
∑gï
, 
fsd©a
);

2944 *
fsd©a
 = (*)0;

2945 
	`åa˚_pxt4_da_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

2947 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2948 
ªt
 = 
	`pxt4_da_wrôe_ölöe_d©a_begö
(
m≠pög
, 
öode
,

2949 
pos
, 
Àn
, 
Êags
,

2950 
∑gï
, 
fsd©a
);

2951 i‡(
ªt
 < 0)

2952  
ªt
;

2953 i‡(
ªt
 == 1)

2964 
ªåy_gøb
:

2965 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

2966 i‡(!
∑ge
)

2967  -
ENOMEM
;

2968 
	`u∆ock_∑ge
(
∑ge
);

2976 
ªåy_jou∫Æ
:

2977 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

2978 
	`pxt4_da_wrôe_¸edôs
(
öode
, 
pos
, 
Àn
));

2979 i‡(
	`IS_ERR
(
h™dÀ
)) {

2980 
	`put_∑ge
(
∑ge
);

2981  
	`PTR_ERR
(
h™dÀ
);

2984 
	`lock_∑ge
(
∑ge
);

2985 i‡(
∑ge
->
m≠pög
 != mapping) {

2987 
	`u∆ock_∑ge
(
∑ge
);

2988 
	`put_∑ge
(
∑ge
);

2989 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2990 
ªåy_gøb
;

2993 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

2995 #ifde‡
CONFIG_FS_ENCRYPTION


2996 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

2997 
pxt4_da_gë_block_¥ï
);

2999 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_da_gë_block_¥ï
);

3001 i‡(
ªt
 < 0) {

3002 
	`u∆ock_∑ge
(
∑ge
);

3003 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3009 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
)

3010 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3012 i‡(
ªt
 =-
ENOSPC
 &&

3013 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3014 
ªåy_jou∫Æ
;

3016 
	`put_∑ge
(
∑ge
);

3017  
ªt
;

3020 *
∑gï
 = 
∑ge
;

3021  
ªt
;

3022 
	}
}

3028 
	$pxt4_da_should_upd©e_i_disksize
(
∑ge
 *page,

3029 
off£t
)

3031 
buf„r_hód
 *
bh
;

3032 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3033 
idx
;

3034 
i
;

3036 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3037 
idx
 = 
off£t
 >> 
öode
->
i_blkbôs
;

3039 
i
 = 0; i < 
idx
; i++)

3040 
bh
 = bh->
b_this_∑ge
;

3042 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| (
	`buf„r_dñay
(bh)Ë|| 
	`buf„r_unwrôãn
(bh))

3045 
	}
}

3047 
	$pxt4_da_wrôe_íd
(
fûe
 *file,

3048 
addªss_•a˚
 *
m≠pög
,

3049 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3050 
∑ge
 *∑ge, *
fsd©a
)

3052 
öode
 *öodê
m≠pög
->
ho°
;

3053 
ªt
 = 0, 
ªt2
;

3054 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3055 
loff_t
 
√w_i_size
;

3056 
°¨t
, 
íd
;

3057 
wrôe_mode
 = ()()
fsd©a
;

3059 i‡(
wrôe_mode
 =
FALL_BACK_TO_NONDELALLOC
)

3060  
	`pxt4_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

3061 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3063 
	`åa˚_pxt4_da_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

3064 
°¨t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3065 
íd
 = 
°¨t
 + 
c›õd
 - 1;

3072 
√w_i_size
 = 
pos
 + 
c›õd
;

3073 i‡(
c›õd
 && 
√w_i_size
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3074 i‡(
	`pxt4_has_ölöe_d©a
(
öode
) ||

3075 
	`pxt4_da_should_upd©e_i_disksize
(
∑ge
, 
íd
)) {

3076 
	`pxt4_upd©e_i_disksize
(
öode
, 
√w_i_size
);

3081 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3085 i‡(
wrôe_mode
 !
CONVERT_INLINE_DATA
 &&

3086 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
) &&

3087 
	`pxt4_has_ölöe_d©a
(
öode
))

3088 
ªt2
 = 
	`pxt4_da_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
,

3089 
∑ge
);

3091 
ªt2
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
,

3092 
∑ge
, 
fsd©a
);

3094 
c›õd
 = 
ªt2
;

3095 i‡(
ªt2
 < 0)

3096 
ªt
 = 
ªt2
;

3097 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3098 i‡(!
ªt
)

3099 
ªt
 = 
ªt2
;

3101  
ªt
 ?Ñë : 
c›õd
;

3102 
	}
}

3107 
	$pxt4_Æloc_da_blocks
(
öode
 *inode)

3109 
	`åa˚_pxt4_Æloc_da_blocks
(
öode
);

3111 i‡(!
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

3145  
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

3146 
	}
}

3162 
£˘‹_t
 
	$pxt4_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

3164 
öode
 *öodê
m≠pög
->
ho°
;

3165 
jou∫Æ_t
 *
jou∫Æ
;

3166 
îr
;

3171 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3174 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
) &&

3175 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
)) {

3181 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

3184 i‡(
	`PXT4_JOURNAL
(
öode
) &&

3185 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
)) {

3204 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

3205 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

3206 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

3207 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

3208 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

3210 i‡(
îr
)

3214  
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
pxt4_gë_block
);

3215 
	}
}

3217 
	$pxt4_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

3219 
ªt
 = -
EAGAIN
;

3220 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3222 
	`åa˚_pxt4_ªad∑ge
(
∑ge
);

3224 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3225 
ªt
 = 
	`pxt4_ªad∑ge_ölöe
(
öode
, 
∑ge
);

3227 i‡(
ªt
 =-
EAGAIN
)

3228  
	`pxt4_m∑ge_ªad∑ges
(
∑ge
->
m≠pög
, 
NULL
,Öage, 1,

3229 
Ál£
);

3231  
ªt
;

3232 
	}
}

3235 
	$pxt4_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3236 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

3238 
öode
 *öodê
m≠pög
->
ho°
;

3241 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3244  
	`pxt4_m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
NULL
, 
ƒ_∑ges
, 
åue
);

3245 
	}
}

3247 
	$pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3248 
Àngth
)

3250 
	`åa˚_pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3253 
	`WARN_ON
(
	`∑ge_has_buf„rs
(
∑ge
Ë&& 
	`buf„r_jbd
(
	`∑ge_buf„rs
(page)));

3255 
	`block_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3256 
	}
}

3258 
	$__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3259 
off£t
,

3260 
Àngth
)

3262 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3264 
	`åa˚_pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3269 i‡(
off£t
 =0 && 
Àngth
 =
PAGE_SIZE
)

3270 
	`CÀ¨PageChecked
(
∑ge
);

3272  
	`jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ
, 
∑ge
, 
off£t
, 
Àngth
);

3273 
	}
}

3276 
	$pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3277 
off£t
,

3278 
Àngth
)

3280 
	`WARN_ON
(
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
) < 0);

3281 
	}
}

3283 
	$pxt4_ªÀa£∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
waô
)

3285 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3287 
	`åa˚_pxt4_ªÀa£∑ge
(
∑ge
);

3290 i‡(
	`PageChecked
(
∑ge
))

3292 i‡(
jou∫Æ
)

3293  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
, 
waô
);

3295  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3296 
	}
}

3298 
boﬁ
 
	$pxt4_öode_d©async_dúty
(
öode
 *inode)

3300 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

3302 i‡(
jou∫Æ
)

3303  !
	`jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ
,

3304 
	`PXT4_I
(
öode
)->
i_d©async_tid
);

3306 i‡(!
	`li°_em±y
(&
öode
->
i_m≠pög
->
¥iv©e_li°
))

3307  
åue
;

3308  
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
;

3309 
	}
}

3311 
	$pxt4_£t_iom≠
(
öode
 *öode, 
iom≠
 *iomap,

3312 
pxt4_m≠_blocks
 *
m≠
, 
loff_t
 
off£t
,

3313 
loff_t
 
Àngth
)

3315 
u8
 
blkbôs
 = 
öode
->
i_blkbôs
;

3322 
iom≠
->
Êags
 = 0;

3323 i‡(
	`pxt4_öode_d©async_dúty
(
öode
) ||

3324 
off£t
 + 
Àngth
 > 
	`i_size_ªad
(
öode
))

3325 
iom≠
->
Êags
 |
IOMAP_F_DIRTY
;

3327 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
)

3328 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

3330 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

3331 
iom≠
->
dax_dev
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_daxdev
;

3332 
iom≠
->
off£t
 = (
u64
Ë
m≠
->
m_lblk
 << 
blkbôs
;

3333 
iom≠
->
Àngth
 = (
u64
Ë
m≠
->
m_Àn
 << 
blkbôs
;

3344 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) {

3345 
iom≠
->
ty≥
 = 
IOMAP_UNWRITTEN
;

3346 
iom≠
->
addr
 = (
u64
Ë
m≠
->
m_pblk
 << 
blkbôs
;

3347 } i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

3348 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

3349 
iom≠
->
addr
 = (
u64
Ë
m≠
->
m_pblk
 << 
blkbôs
;

3351 
iom≠
->
ty≥
 = 
IOMAP_HOLE
;

3352 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

3354 
	}
}

3356 
	$pxt4_iom≠_Æloc
(
öode
 *öode, 
pxt4_m≠_blocks
 *
m≠
,

3357 
Êags
)

3359 
h™dÀ_t
 *
h™dÀ
;

3360 
u8
 
blkbôs
 = 
öode
->
i_blkbôs
;

3361 
ªt
, 
dio_¸edôs
, 
m_Êags
 = 0, 
ªåõs
 = 0;

3367 i‡(
m≠
->
m_Àn
 > 
DIO_MAX_BLOCKS
)

3368 
m≠
->
m_Àn
 = 
DIO_MAX_BLOCKS
;

3369 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
m≠
->
m_Àn
);

3371 
ªåy
:

3378 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
, 
dio_¸edôs
);

3379 i‡(
	`IS_ERR
(
h™dÀ
))

3380  
	`PTR_ERR
(
h™dÀ
);

3386 
	`WARN_ON
(!
	`IS_DAX
(
öode
Ë&& !(
Êags
 & 
IOMAP_DIRECT
));

3387 i‡(
	`IS_DAX
(
öode
))

3388 
m_Êags
 = 
PXT4_GET_BLOCKS_CREATE_ZERO
;

3395 i‡((
m≠
->
m_lblk
 * (1 << 
blkbôs
)Ë>
	`i_size_ªad
(
öode
))

3396 
m_Êags
 = 
PXT4_GET_BLOCKS_CREATE
;

3397 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

3398 
m_Êags
 = 
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

3400 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
m_Êags
);

3407 i‡(!
m_Êags
 && !
ªt
)

3408 
ªt
 = -
ENOTBLK
;

3410 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3411 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3412 
ªåy
;

3414  
ªt
;

3415 
	}
}

3418 
	$pxt4_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3419 
Êags
, 
iom≠
 *iom≠, iom≠ *
§cm≠
)

3421 
ªt
;

3422 
pxt4_m≠_blocks
 
m≠
;

3423 
u8
 
blkbôs
 = 
öode
->
i_blkbôs
;

3425 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3426  -
EINVAL
;

3428 i‡(
	`WARN_ON_ONCE
(
	`pxt4_has_ölöe_d©a
(
öode
)))

3429  -
ERANGE
;

3434 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

3435 
m≠
.
m_Àn
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3436 
PXT4_MAX_LOGICAL_BLOCK
Ë- 
m≠
.
m_lblk
 + 1;

3438 i‡(
Êags
 & 
IOMAP_WRITE
)

3439 
ªt
 = 
	`pxt4_iom≠_Æloc
(
öode
, &
m≠
, 
Êags
);

3441 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3443 i‡(
ªt
 < 0)

3444  
ªt
;

3446 
	`pxt4_£t_iom≠
(
öode
, 
iom≠
, &
m≠
, 
off£t
, 
Àngth
);

3449 
	}
}

3451 
	$pxt4_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3452 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

3461 i‡(
Êags
 & (
IOMAP_WRITE
 | 
IOMAP_DIRECT
Ë&& 
wrôãn
 == 0)

3462  -
ENOTBLK
;

3465 
	}
}

3467 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_›s
 = {

3468 .
iom≠_begö
 = 
pxt4_iom≠_begö
,

3469 .
	giom≠_íd
 = 
pxt4_iom≠_íd
,

3472 
boﬁ
 
	$pxt4_iom≠_is_dñÆloc
(
öode
 *inode,

3473 
pxt4_m≠_blocks
 *
m≠
)

3475 
exã¡_°©us
 
es
;

3476 
pxt4_lblk_t
 
off£t
 = 0, 
íd
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1;

3478 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

3479 
m≠
->
m_lblk
, 
íd
, &
es
);

3481 i‡(!
es
.
es_Àn
 ||És.
es_lblk
 > 
íd
)

3482  
Ál£
;

3484 i‡(
es
.
es_lblk
 > 
m≠
->
m_lblk
) {

3485 
m≠
->
m_Àn
 = 
es
.
es_lblk
 - m≠->
m_lblk
;

3486  
Ál£
;

3489 
off£t
 = 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

3490 
m≠
->
m_Àn
 = 
es
.
es_Àn
 - 
off£t
;

3492  
åue
;

3493 
	}
}

3495 
	$pxt4_iom≠_begö_ªp‹t
(
öode
 *öode, 
loff_t
 
off£t
,

3496 
loff_t
 
Àngth
, 
Êags
,

3497 
iom≠
 *iom≠, iom≠ *
§cm≠
)

3499 
ªt
;

3500 
boﬁ
 
dñÆloc
 = 
Ál£
;

3501 
pxt4_m≠_blocks
 
m≠
;

3502 
u8
 
blkbôs
 = 
öode
->
i_blkbôs
;

3504 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3505  -
EINVAL
;

3507 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3508 
ªt
 = 
	`pxt4_ölöe_d©a_iom≠
(
öode
, 
iom≠
);

3509 i‡(
ªt
 !-
EAGAIN
) {

3510 i‡(
ªt
 =0 && 
off£t
 >
iom≠
->
Àngth
)

3511 
ªt
 = -
ENOENT
;

3512  
ªt
;

3519 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

3520 
m≠
.
m_Àn
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3521 
PXT4_MAX_LOGICAL_BLOCK
Ë- 
m≠
.
m_lblk
 + 1;

3523 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3524 i‡(
ªt
 < 0)

3525  
ªt
;

3526 i‡(
ªt
 == 0)

3527 
dñÆloc
 = 
	`pxt4_iom≠_is_dñÆloc
(
öode
, &
m≠
);

3529 
	`pxt4_£t_iom≠
(
öode
, 
iom≠
, &
m≠
, 
off£t
, 
Àngth
);

3530 i‡(
dñÆloc
 && 
iom≠
->
ty≥
 =
IOMAP_HOLE
)

3531 
iom≠
->
ty≥
 = 
IOMAP_DELALLOC
;

3534 
	}
}

3536 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_ªp‹t_›s
 = {

3537 .
iom≠_begö
 = 
pxt4_iom≠_begö_ªp‹t
,

3553 
	$pxt4_jou∫ÆÀd_£t_∑ge_dúty
(
∑ge
 *page)

3555 
	`SëPageChecked
(
∑ge
);

3556  
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

3557 
	}
}

3559 
	$pxt4_£t_∑ge_dúty
(
∑ge
 *page)

3561 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
Ë&& !
	`PageDúty
(page));

3562 
	`WARN_ON_ONCE
(!
	`∑ge_has_buf„rs
(
∑ge
));

3563  
	`__£t_∑ge_dúty_buf„rs
(
∑ge
);

3564 
	}
}

3566 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_a›s
 = {

3567 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3568 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3569 .
	gwrôïage
 = 
pxt4_wrôïage
,

3570 .
	gwrôïages
 = 
pxt4_wrôïages
,

3571 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3572 .
	gwrôe_íd
 = 
pxt4_wrôe_íd
,

3573 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3574 .
	gbm≠
 = 
pxt4_bm≠
,

3575 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3576 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3577 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3578 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3579 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3580 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3583 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_jou∫ÆÀd_a›s
 = {

3584 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3585 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3586 .
	gwrôïage
 = 
pxt4_wrôïage
,

3587 .
	gwrôïages
 = 
pxt4_wrôïages
,

3588 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3589 .
	gwrôe_íd
 = 
pxt4_jou∫ÆÀd_wrôe_íd
,

3590 .
	g£t_∑ge_dúty
 = 
pxt4_jou∫ÆÀd_£t_∑ge_dúty
,

3591 .
	gbm≠
 = 
pxt4_bm≠
,

3592 .
	gövÆid©ïage
 = 
pxt4_jou∫ÆÀd_övÆid©ïage
,

3593 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3594 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3595 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3596 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3599 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_da_a›s
 = {

3600 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3601 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3602 .
	gwrôïage
 = 
pxt4_wrôïage
,

3603 .
	gwrôïages
 = 
pxt4_wrôïages
,

3604 .
	gwrôe_begö
 = 
pxt4_da_wrôe_begö
,

3605 .
	gwrôe_íd
 = 
pxt4_da_wrôe_íd
,

3606 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3607 .
	gbm≠
 = 
pxt4_bm≠
,

3608 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3609 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3610 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3611 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3612 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3613 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3616 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_dax_a›s
 = {

3617 .
wrôïages
 = 
pxt4_dax_wrôïages
,

3618 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3619 .
	g£t_∑ge_dúty
 = 
no›_£t_∑ge_dúty
,

3620 .
	gbm≠
 = 
pxt4_bm≠
,

3621 .
	gövÆid©ïage
 = 
no›_övÆid©ïage
,

3624 
	$pxt4_£t_a›s
(
öode
 *inode)

3626 
	`pxt4_öode_jou∫Æ_mode
(
öode
)) {

3627 
PXT4_INODE_ORDERED_DATA_MODE
:

3628 
PXT4_INODE_WRITEBACK_DATA_MODE
:

3630 
PXT4_INODE_JOURNAL_DATA_MODE
:

3631 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_jou∫ÆÀd_a›s
;

3634 
	`BUG
();

3636 i‡(
	`IS_DAX
(
öode
))

3637 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_dax_a›s
;

3638 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

3639 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_da_a›s
;

3641 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_a›s
;

3642 
	}
}

3644 
	$__pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

3645 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

3647 
pxt4_fsblk_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

3648 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

3649 
blocksize
, 
pos
;

3650 
pxt4_lblk_t
 
iblock
;

3651 
öode
 *öodê
m≠pög
->
ho°
;

3652 
buf„r_hód
 *
bh
;

3653 
∑ge
 *page;

3654 
îr
 = 0;

3656 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
‰om
 >> 
PAGE_SHIFT
,

3657 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
));

3658 i‡(!
∑ge
)

3659  -
ENOMEM
;

3661 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

3663 
iblock
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

3665 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

3666 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

3669 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3670 
pos
 = 
blocksize
;

3671 
off£t
 >
pos
) {

3672 
bh
 = bh->
b_this_∑ge
;

3673 
iblock
++;

3674 
pos
 +
blocksize
;

3676 i‡(
	`buf„r_‰ìd
(
bh
)) {

3677 
	`BUFFER_TRACE
(
bh
, "freed: skip");

3678 
u∆ock
;

3680 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

3681 
	`BUFFER_TRACE
(
bh
, "unmapped");

3682 
	`pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

3684 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

3685 
	`BUFFER_TRACE
(
bh
, "still unmapped");

3686 
u∆ock
;

3691 i‡(
	`PageU±od©e
(
∑ge
))

3692 
	`£t_buf„r_u±od©e
(
bh
);

3694 i‡(!
	`buf„r_u±od©e
(
bh
)) {

3695 
îr
 = -
EIO
;

3696 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

3697 
	`waô_⁄_buf„r
(
bh
);

3699 i‡(!
	`buf„r_u±od©e
(
bh
))

3700 
u∆ock
;

3701 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode)) {

3703 
	`BUG_ON
(!
	`fs¸y±_has_í¸y±i⁄_key
(
öode
));

3704 
	`WARN_ON_ONCE
(
	`fs¸y±_de¸y±_∑geˇche_blocks
(

3705 
∑ge
, 
blocksize
, 
	`bh_off£t
(
bh
)));

3708 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

3709 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

3710 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

3711 i‡(
îr
)

3712 
u∆ock
;

3714 
	`zîo_u£r
(
∑ge
, 
off£t
, 
Àngth
);

3715 
	`BUFFER_TRACE
(
bh
, "zeroedÉnd of block");

3717 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

3718 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

3720 
îr
 = 0;

3721 
	`m¨k_buf„r_dúty
(
bh
);

3722 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

3723 
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
, 
‰om
,

3724 
Àngth
);

3727 
u∆ock
:

3728 
	`u∆ock_∑ge
(
∑ge
);

3729 
	`put_∑ge
(
∑ge
);

3730  
îr
;

3731 
	}
}

3740 
	$pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

3741 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

3743 
öode
 *öodê
m≠pög
->
ho°
;

3744 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

3745 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

3746 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

3752 i‡(
Àngth
 > 
max
 ||Üength < 0)

3753 
Àngth
 = 
max
;

3755 i‡(
	`IS_DAX
(
öode
)) {

3756  
	`iom≠_zîo_ønge
(
öode
, 
‰om
, 
Àngth
, 
NULL
,

3757 &
pxt4_iom≠_›s
);

3759  
	`__pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

3760 
	}
}

3768 
	$pxt4_block_åunˇã_∑ge
(
h™dÀ_t
 *
h™dÀ
,

3769 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
)

3771 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

3772 
Àngth
;

3773 
blocksize
;

3774 
öode
 *öodê
m≠pög
->
ho°
;

3777 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& !
	`fs¸y±_has_í¸y±i⁄_key
(inode))

3780 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

3781 
Àngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

3783  
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

3784 
	}
}

3786 
	$pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3787 
loff_t
 
l°¨t
,Üoff_à
Àngth
)

3789 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

3790 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

3791 
∑πül_°¨t
, 
∑πül_íd
;

3792 
pxt4_fsblk_t
 
°¨t
, 
íd
;

3793 
loff_t
 
byã_íd
 = (
l°¨t
 + 
Àngth
 - 1);

3794 
îr
 = 0;

3796 
∑πül_°¨t
 = 
l°¨t
 & (
sb
->
s_blocksize
 - 1);

3797 
∑πül_íd
 = 
byã_íd
 & (
sb
->
s_blocksize
 - 1);

3799 
°¨t
 = 
l°¨t
 >> 
sb
->
s_blocksize_bôs
;

3800 
íd
 = 
byã_íd
 >> 
sb
->
s_blocksize_bôs
;

3803 i‡(
°¨t
 =
íd
 &&

3804 (
∑πül_°¨t
 || (
∑πül_íd
 !
sb
->
s_blocksize
 - 1))) {

3805 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

3806 
l°¨t
, 
Àngth
);

3807  
îr
;

3810 i‡(
∑πül_°¨t
) {

3811 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

3812 
l°¨t
, 
sb
->
s_blocksize
);

3813 i‡(
îr
)

3814  
îr
;

3817 i‡(
∑πül_íd
 !
sb
->
s_blocksize
 - 1)

3818 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

3819 
byã_íd
 - 
∑πül_íd
,

3820 
∑πül_íd
 + 1);

3821  
îr
;

3822 
	}
}

3824 
	$pxt4_ˇn_åunˇã
(
öode
 *inode)

3826 i‡(
	`S_ISREG
(
öode
->
i_mode
))

3828 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

3830 i‡(
	`S_ISLNK
(
öode
->
i_mode
))

3831  !
	`pxt4_öode_is_Á°_symlök
(
öode
);

3833 
	}
}

3841 
	$pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

3842 
loff_t
 
Àn
)

3844 
h™dÀ_t
 *
h™dÀ
;

3845 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

3847 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

3848 i‡(
off£t
 > 
size
 || off£à+ 
Àn
 < size)

3851 i‡(
	`PXT4_I
(
öode
)->
i_disksize
 >
size
)

3854 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 1);

3855 i‡(
	`IS_ERR
(
h™dÀ
))

3856  
	`PTR_ERR
(
h™dÀ
);

3857 
	`pxt4_upd©e_i_disksize
(
öode
, 
size
);

3858 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3859 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3862 
	}
}

3864 
	$pxt4_waô_dax_∑ge
(
pxt4_öode_öfo
 *
ei
)

3866 
	`up_wrôe
(&
ei
->
i_mm≠_£m
);

3867 
	`scheduÀ
();

3868 
	`down_wrôe
(&
ei
->
i_mm≠_£m
);

3869 
	}
}

3871 
	$pxt4_bªak_œyouts
(
öode
 *inode)

3873 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3874 
∑ge
 *page;

3875 
îr‹
;

3877 i‡(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm≠_£m
)))

3878  -
EINVAL
;

3881 
∑ge
 = 
	`dax_œyout_busy_∑ge
(
öode
->
i_m≠pög
);

3882 i‡(!
∑ge
)

3885 
îr‹
 = 
	`___waô_v¨_evít
(&
∑ge
->
_ªfcou¡
,

3886 
	`©omic_ªad
(&
∑ge
->
_ªfcou¡
) == 1,

3887 
TASK_INTERRUPTIBLE
, 0, 0,

3888 
	`pxt4_waô_dax_∑ge
(
ei
));

3889 } 
îr‹
 == 0);

3891  
îr‹
;

3892 
	}
}

3905 
	$pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
)

3907 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

3908 
pxt4_lblk_t
 
fú°_block
, 
°›_block
;

3909 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

3910 
loff_t
 
fú°_block_off£t
, 
œ°_block_off£t
;

3911 
h™dÀ_t
 *
h™dÀ
;

3912 
¸edôs
;

3913 
ªt
 = 0;

3915 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

3916  -
EOPNOTSUPP
;

3918 
	`åa˚_pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àngth
, 0);

3920 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

3921 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3922 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

3923 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

3924 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

3925 i‡(
ªt
)

3926  
ªt
;

3933 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
)) {

3934 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
off£t
,

3935 
off£t
 + 
Àngth
 - 1);

3936 i‡(
ªt
)

3937  
ªt
;

3940 
	`öode_lock
(
öode
);

3943 i‡(
off£t
 >
öode
->
i_size
)

3944 
out_muãx
;

3950 i‡(
off£t
 + 
Àngth
 > 
öode
->
i_size
) {

3951 
Àngth
 = 
öode
->
i_size
 +

3952 
PAGE_SIZE
 - (
öode
->
i_size
 & (PAGE_SIZE - 1)) -

3953 
off£t
;

3956 i‡(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

3957 (
off£t
 + 
Àngth
Ë& (
sb
->
s_blocksize
 - 1)) {

3962 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

3963 i‡(
ªt
 < 0)

3964 
out_muãx
;

3969 
	`öode_dio_waô
(
öode
);

3975 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

3977 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

3978 i‡(
ªt
)

3979 
out_dio
;

3981 
fú°_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

3982 
œ°_block_off£t
 = 
	`round_down
((
off£t
 + 
Àngth
), 
sb
->
s_blocksize
) - 1;

3985 i‡(
œ°_block_off£t
 > 
fú°_block_off£t
) {

3986 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àngth
);

3987 i‡(
ªt
)

3988 
out_dio
;

3989 
	`åunˇã_∑geˇche_ønge
(
öode
, 
fú°_block_off£t
,

3990 
œ°_block_off£t
);

3993 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

3994 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

3996 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

3997 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

3998 i‡(
	`IS_ERR
(
h™dÀ
)) {

3999 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4000 
	`pxt4_°d_îr‹
(
sb
, 
ªt
);

4001 
out_dio
;

4004 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
,

4005 
Àngth
);

4006 i‡(
ªt
)

4007 
out_°›
;

4009 
fú°_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4010 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4011 
°›_block
 = (
off£t
 + 
Àngth
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4014 i‡(
°›_block
 > 
fú°_block
) {

4016 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4017 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4019 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
fú°_block
,

4020 
°›_block
 - 
fú°_block
);

4021 i‡(
ªt
) {

4022 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4023 
out_°›
;

4026 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4027 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
fú°_block
,

4028 
°›_block
 - 1);

4030 
ªt
 = 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ
, 
öode
, 
fú°_block
,

4031 
°›_block
);

4033 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4035 i‡(
	`IS_SYNC
(
öode
))

4036 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4038 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4039 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4040 i‡(
ªt
 >= 0)

4041 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4042 
out_°›
:

4043 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4044 
out_dio
:

4045 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4046 
out_muãx
:

4047 
	`öode_u∆ock
(
öode
);

4048  
ªt
;

4049 
	}
}

4051 
	$pxt4_öode_©èch_jöode
(
öode
 *inode)

4053 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4054 
jbd3_öode
 *
jöode
;

4056 i‡(
ei
->
jöode
 || !
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

4059 
jöode
 = 
	`jbd3_Æloc_öode
(
GFP_KERNEL
);

4060 
	`•ö_lock
(&
öode
->
i_lock
);

4061 i‡(!
ei
->
jöode
) {

4062 i‡(!
jöode
) {

4063 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4064  -
ENOMEM
;

4066 
ei
->
jöode
 = jinode;

4067 
	`jbd3_jou∫Æ_öô_jbd_öode
(
ei
->
jöode
, 
öode
);

4068 
jöode
 = 
NULL
;

4070 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4071 i‡(
	`u∆ikñy
(
jöode
 !
NULL
))

4072 
	`jbd3_‰ì_öode
(
jöode
);

4074 
	}
}

4104 
	$pxt4_åunˇã
(
öode
 *inode)

4106 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4107 
¸edôs
;

4108 
îr
 = 0;

4109 
h™dÀ_t
 *
h™dÀ
;

4110 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4117 i‡(!(
öode
->
i_°©e
 & (
I_NEW
|
I_FREEING
)))

4118 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4119 
	`åa˚_pxt4_åunˇã_íãr
(
öode
);

4121 i‡(!
	`pxt4_ˇn_åunˇã
(
öode
))

4124 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4126 i‡(
öode
->
i_size
 =0 && !
	`ã°_›t
(öode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4127 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

4129 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4130 
has_ölöe
 = 1;

4132 
îr
 = 
	`pxt4_ölöe_d©a_åunˇã
(
öode
, &
has_ölöe
);

4133 i‡(
îr
)

4134  
îr
;

4135 i‡(
has_ölöe
)

4140 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1)) {

4141 i‡(
	`pxt4_öode_©èch_jöode
(
öode
) < 0)

4145 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4146 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4148 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4150 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4151 i‡(
	`IS_ERR
(
h™dÀ
))

4152  
	`PTR_ERR
(
h™dÀ
);

4154 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1))

4155 
	`pxt4_block_åunˇã_∑ge
(
h™dÀ
, 
m≠pög
, 
öode
->
i_size
);

4166 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

4167 i‡(
îr
)

4168 
out_°›
;

4170 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4172 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4174 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4175 
îr
 = 
	`pxt4_ext_åunˇã
(
h™dÀ
, 
öode
);

4177 
	`pxt4_öd_åunˇã
(
h™dÀ
, 
öode
);

4179 
	`up_wrôe
(&
ei
->
i_d©a_£m
);

4180 i‡(
îr
)

4181 
out_°›
;

4183 i‡(
	`IS_SYNC
(
öode
))

4184 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4186 
out_°›
:

4194 i‡(
öode
->
i_∆ök
)

4195 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

4197 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4198 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4199 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4201 
	`åa˚_pxt4_åunˇã_exô
(
öode
);

4202  
îr
;

4203 
	}
}

4211 
	$__pxt4_gë_öode_loc
(
öode
 *inode,

4212 
pxt4_ûoc
 *
ûoc
, 
ö_mem
)

4214 
pxt4_group_desc
 *
gdp
;

4215 
buf„r_hód
 *
bh
;

4216 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4217 
pxt4_fsblk_t
 
block
;

4218 
blk_∂ug
 
∂ug
;

4219 
öodes_≥r_block
, 
öode_off£t
;

4221 
ûoc
->
bh
 = 
NULL
;

4222 i‡(
öode
->
i_öo
 < 
PXT4_ROOT_INO
 ||

4223 
öode
->
i_öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))

4224  -
EFSCORRUPTED
;

4226 
ûoc
->
block_group
 = (
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

4227 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ûoc
->
block_group
, 
NULL
);

4228 i‡(!
gdp
)

4229  -
EIO
;

4234 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4235 
öode_off£t
 = ((
öode
->
i_öo
 - 1) %

4236 
	`PXT4_INODES_PER_GROUP
(
sb
));

4237 
block
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ (
öode_off£t
 / 
öodes_≥r_block
);

4238 
ûoc
->
off£t
 = (
öode_off£t
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

4240 
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

4241 i‡(
	`u∆ikñy
(!
bh
))

4242  -
ENOMEM
;

4243 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4244 
	`lock_buf„r
(
bh
);

4252 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
Ë&& !
	`buf„r_u±od©e
(bh))

4253 
	`£t_buf„r_u±od©e
(
bh
);

4255 i‡(
	`buf„r_u±od©e
(
bh
)) {

4257 
	`u∆ock_buf„r
(
bh
);

4258 
has_buf„r
;

4266 i‡(
ö_mem
) {

4267 
buf„r_hód
 *
bôm≠_bh
;

4268 
i
, 
°¨t
;

4270 
°¨t
 = 
öode_off£t
 & ~(
öodes_≥r_block
 - 1);

4273 
bôm≠_bh
 = 
	`sb_gëblk
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
));

4274 i‡(
	`u∆ikñy
(!
bôm≠_bh
))

4275 
make_io
;

4282 i‡(!
	`buf„r_u±od©e
(
bôm≠_bh
)) {

4283 
	`bªl£
(
bôm≠_bh
);

4284 
make_io
;

4286 
i
 = 
°¨t
; i < sèπ + 
öodes_≥r_block
; i++) {

4287 i‡(
i
 =
öode_off£t
)

4289 i‡(
	`pxt4_ã°_bô
(
i
, 
bôm≠_bh
->
b_d©a
))

4292 
	`bªl£
(
bôm≠_bh
);

4293 i‡(
i
 =
°¨t
 + 
öodes_≥r_block
) {

4295 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4296 
	`£t_buf„r_u±od©e
(
bh
);

4297 
	`u∆ock_buf„r
(
bh
);

4298 
has_buf„r
;

4302 
make_io
:

4307 
	`blk_°¨t_∂ug
(&
∂ug
);

4308 i‡(
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
) {

4309 
pxt4_fsblk_t
 
b
, 
íd
, 
èbÀ
;

4310 
num
;

4311 
__u32
 
ø_blks
 = 
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
;

4313 
èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

4315 
b
 = 
block
 & ~((
pxt4_fsblk_t
Ë
ø_blks
 - 1);

4316 i‡(
èbÀ
 > 
b
)

4317 
b
 = 
èbÀ
;

4318 
íd
 = 
b
 + 
ø_blks
;

4319 
num
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

4320 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

4321 
num
 -
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

4322 
èbÀ
 +
num
 / 
öodes_≥r_block
;

4323 i‡(
íd
 > 
èbÀ
)

4324 
íd
 = 
èbÀ
;

4325 
b
 <
íd
)

4326 
	`sb_bªadahód
(
sb
, 
b
++);

4334 
	`åa˚_pxt4_lﬂd_öode
(
öode
);

4335 
	`gë_bh
(
bh
);

4336 
bh
->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

4337 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4338 
	`blk_föish_∂ug
(&
∂ug
);

4339 
	`waô_⁄_buf„r
(
bh
);

4340 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4341 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
,

4343 
	`bªl£
(
bh
);

4344  -
EIO
;

4347 
has_buf„r
:

4348 
ûoc
->
bh
 = bh;

4350 
	}
}

4352 
	$pxt4_gë_öode_loc
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

4355  
	`__pxt4_gë_öode_loc
(
öode
, 
ûoc
,

4356 !
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
));

4357 
	}
}

4359 
boﬁ
 
	$pxt4_should_u£_dax
(
öode
 *inode)

4361 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DAX
))

4362  
Ál£
;

4363 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4364  
Ál£
;

4365 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4366  
Ál£
;

4367 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

4368  
Ál£
;

4369 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
))

4370  
Ál£
;

4371 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
))

4372  
Ál£
;

4373  
åue
;

4374 
	}
}

4376 
	$pxt4_£t_öode_Êags
(
öode
 *inode)

4378 
Êags
 = 
	`PXT4_I
(
öode
)->
i_Êags
;

4379 
√w_Ê
 = 0;

4381 i‡(
Êags
 & 
PXT4_SYNC_FL
)

4382 
√w_Ê
 |
S_SYNC
;

4383 i‡(
Êags
 & 
PXT4_APPEND_FL
)

4384 
√w_Ê
 |
S_APPEND
;

4385 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

4386 
√w_Ê
 |
S_IMMUTABLE
;

4387 i‡(
Êags
 & 
PXT4_NOATIME_FL
)

4388 
√w_Ê
 |
S_NOATIME
;

4389 i‡(
Êags
 & 
PXT4_DIRSYNC_FL
)

4390 
√w_Ê
 |
S_DIRSYNC
;

4391 i‡(
	`pxt4_should_u£_dax
(
öode
))

4392 
√w_Ê
 |
S_DAX
;

4393 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

4394 
√w_Ê
 |
S_ENCRYPTED
;

4395 i‡(
Êags
 & 
PXT4_CASEFOLD_FL
)

4396 
√w_Ê
 |
S_CASEFOLD
;

4397 i‡(
Êags
 & 
PXT4_VERITY_FL
)

4398 
√w_Ê
 |
S_VERITY
;

4399 
	`öode_£t_Êags
(
öode
, 
√w_Ê
,

4400 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4401 
S_ENCRYPTED
|
S_CASEFOLD
|
S_VERITY
);

4402 
	}
}

4404 
blk˙t_t
 
	$pxt4_öode_blocks
(
pxt4_öode
 *
øw_öode
,

4405 
pxt4_öode_öfo
 *
ei
)

4407 
blk˙t_t
 
i_blocks
 ;

4408 
öode
 *öodê&(
ei
->
vfs_öode
);

4409 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4411 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

4413 
i_blocks
 = ((
u64
)
	`À16_to_˝u
(
øw_öode
->
i_blocks_high
)) << 32 |

4414 
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4415 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
)) {

4417  
i_blocks
 << (
öode
->
i_blkbôs
 - 9);

4419  
i_blocks
;

4422  
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4424 
	}
}

4426 
ölöe
 
	$pxt4_igë_exåa_öode
(
öode
 *inode,

4427 
pxt4_öode
 *
øw_öode
,

4428 
pxt4_öode_öfo
 *
ei
)

4430 
__À32
 *
magic
 = (*)
øw_öode
 +

4431 
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
;

4433 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 + (
__À32
) <=

4434 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) &&

4435 *
magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

4436 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

4437  
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

4439 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

4441 
	}
}

4443 
	$pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
)

4445 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

4446  -
EOPNOTSUPP
;

4447 *
¥ojid
 = 
	`PXT4_I
(
öode
)->
i_¥ojid
;

4449 
	}
}

4456 
ölöe
 
	$pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
 *öode, 
u64
 
vÆ
)

4458 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4459 
	`öode_£t_ivîsi⁄_øw
(
öode
, 
vÆ
);

4461 
	`öode_£t_ivîsi⁄_quîõd
(
öode
, 
vÆ
);

4462 
	}
}

4463 
ölöe
 
u64
 
	$pxt4_öode_≥ek_ivîsi⁄
(c⁄° 
öode
 *inode)

4465 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4466  
	`öode_≥ek_ivîsi⁄_øw
(
öode
);

4468  
	`öode_≥ek_ivîsi⁄
(
öode
);

4469 
	}
}

4471 
öode
 *
	$__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

4472 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

4473 
löe
)

4475 
pxt4_ûoc
 
ûoc
;

4476 
pxt4_öode
 *
øw_öode
;

4477 
pxt4_öode_öfo
 *
ei
;

4478 
öode
 *inode;

4479 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4480 
ªt
;

4481 
loff_t
 
size
;

4482 
block
;

4483 
uid_t
 
i_uid
;

4484 
gid_t
 
i_gid
;

4485 
¥ojid_t
 
i_¥ojid
;

4487 i‡((!(
Êags
 & 
PXT4_IGET_SPECIAL
) &&

4488 (
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë&& inÿ!
PXT4_ROOT_INO
)) ||

4489 (
öo
 < 
PXT4_ROOT_INO
) ||

4490 (
öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))) {

4491 i‡(
Êags
 & 
PXT4_IGET_HANDLE
)

4492  
	`ERR_PTR
(-
ESTALE
);

4493 
	`__pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
,

4495 
öo
, 
cuºít
->
comm
);

4496  
	`ERR_PTR
(-
EFSCORRUPTED
);

4499 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

4500 i‡(!
öode
)

4501  
	`ERR_PTR
(-
ENOMEM
);

4502 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

4503  
öode
;

4505 
ei
 = 
	`PXT4_I
(
öode
);

4506 
ûoc
.
bh
 = 
NULL
;

4508 
ªt
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

4509 i‡(
ªt
 < 0)

4510 
bad_öode
;

4511 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

4513 i‡((
öo
 =
PXT4_ROOT_INO
Ë&& (
øw_öode
->
i_löks_cou¡
 == 0)) {

4514 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4516 
ªt
 = -
EFSCORRUPTED
;

4517 
bad_öode
;

4520 i‡((
Êags
 & 
PXT4_IGET_HANDLE
) &&

4521 (
øw_öode
->
i_löks_cou¡
 =0Ë&& (øw_öode->
i_mode
 == 0)) {

4522 
ªt
 = -
ESTALE
;

4523 
bad_öode
;

4526 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4527 
ei
->
i_exåa_isize
 = 
	`À16_to_˝u
(
øw_öode
->i_extra_isize);

4528 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 >

4529 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) ||

4530 (
ei
->
i_exåa_isize
 & 3)) {

4531 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4534 
ei
->
i_exåa_isize
,

4535 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

4536 
ªt
 = -
EFSCORRUPTED
;

4537 
bad_öode
;

4540 
ei
->
i_exåa_isize
 = 0;

4543 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

4544 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4545 
__u32
 
csum
;

4546 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

4547 
__À32
 
gí
 = 
øw_öode
->
i_gíî©i⁄
;

4548 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

4549 (
öum
));

4550 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

4551 (
gí
));

4554 i‡(!
	`pxt4_öode_csum_vîify
(
öode
, 
øw_öode
, 
ei
)) {

4555 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4557 
ªt
 = -
EFSBADCRC
;

4558 
bad_öode
;

4561 
öode
->
i_mode
 = 
	`À16_to_˝u
(
øw_öode
->i_mode);

4562 
i_uid
 = (
uid_t
)
	`À16_to_˝u
(
øw_öode
->
i_uid_low
);

4563 
i_gid
 = (
gid_t
)
	`À16_to_˝u
(
øw_öode
->
i_gid_low
);

4564 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

4565 
	`PXT4_INODE_SIZE
(
sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

4566 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

4567 
i_¥ojid
 = (
¥ojid_t
)
	`À32_to_˝u
(
øw_öode
->i_projid);

4569 
i_¥ojid
 = 
PXT4_DEF_PROJID
;

4571 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4572 
i_uid
 |
	`À16_to_˝u
(
øw_öode
->
i_uid_high
) << 16;

4573 
i_gid
 |
	`À16_to_˝u
(
øw_öode
->
i_gid_high
) << 16;

4575 
	`i_uid_wrôe
(
öode
, 
i_uid
);

4576 
	`i_gid_wrôe
(
öode
, 
i_gid
);

4577 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, i_projid);

4578 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
øw_öode
->
i_löks_cou¡
));

4580 
	`pxt4_˛ór_°©e_Êags
(
ei
);

4581 
ei
->
i_ölöe_off
 = 0;

4582 
ei
->
i_dú_°¨t_lookup
 = 0;

4583 
ei
->
i_dtime
 = 
	`À32_to_˝u
(
øw_öode
->i_dtime);

4589 i‡(
öode
->
i_∆ök
 == 0) {

4590 i‡((
öode
->
i_mode
 == 0 ||

4591 !(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
)) &&

4592 
öo
 !
PXT4_BOOT_LOADER_INO
) {

4594 
ªt
 = -
ESTALE
;

4595 
bad_öode
;

4604 
ei
->
i_Êags
 = 
	`À32_to_˝u
(
øw_öode
->i_flags);

4605 
	`pxt4_£t_öode_Êags
(
öode
);

4606 
öode
->
i_blocks
 = 
	`pxt4_öode_blocks
(
øw_öode
, 
ei
);

4607 
ei
->
i_fûe_a˛
 = 
	`À32_to_˝u
(
øw_öode
->
i_fûe_a˛_lo
);

4608 i‡(
	`pxt4_has_„©uª_64bô
(
sb
))

4609 
ei
->
i_fûe_a˛
 |=

4610 ((
__u64
)
	`À16_to_˝u
(
øw_öode
->
i_fûe_a˛_high
)) << 32;

4611 
öode
->
i_size
 = 
	`pxt4_isize
(
sb
, 
øw_öode
);

4612 i‡((
size
 = 
	`i_size_ªad
(
öode
)) < 0) {

4613 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4614 "igë: bad i_sizêvÆue: %Œd", 
size
);

4615 
ªt
 = -
EFSCORRUPTED
;

4616 
bad_öode
;

4623 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
sb
Ë&& 
	`pxt4_has_mëad©a_csum
(sb) &&

4624 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) {

4625 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4627 
ªt
 = -
EFSCORRUPTED
;

4628 
bad_öode
;

4630 
ei
->
i_disksize
 = 
öode
->
i_size
;

4631 #ifde‡
CONFIG_QUOTA


4632 
ei
->
i_ª£rved_quŸa
 = 0;

4634 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
øw_öode
->i_generation);

4635 
ei
->
i_block_group
 = 
ûoc
.
block_group
;

4636 
ei
->
i_œ°_Æloc_group
 = ~0;

4641 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

4642 
ei
->
i_d©a
[
block
] = 
øw_öode
->
i_block
[block];

4643 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

4652 i‡(
jou∫Æ
) {

4653 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

4654 
tid_t
 
tid
;

4656 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

4657 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

4658 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

4660 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

4661 i‡(
å™ß˘i⁄
)

4662 
tid
 = 
å™ß˘i⁄
->
t_tid
;

4664 
tid
 = 
jou∫Æ
->
j_commô_£quí˚
;

4665 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4666 
ei
->
i_sync_tid
 = 
tid
;

4667 
ei
->
i_d©async_tid
 = 
tid
;

4670 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4671 i‡(
ei
->
i_exåa_isize
 == 0) {

4673 
	`BUILD_BUG_ON
((
pxt4_öode
) & 3);

4674 
ei
->
i_exåa_isize
 = (
pxt4_öode
) -

4675 
PXT4_GOOD_OLD_INODE_SIZE
;

4677 
ªt
 = 
	`pxt4_igë_exåa_öode
(
öode
, 
øw_öode
, 
ei
);

4678 i‡(
ªt
)

4679 
bad_öode
;

4683 
	`PXT4_INODE_GET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

4684 
	`PXT4_INODE_GET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

4685 
	`PXT4_INODE_GET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

4686 
	`PXT4_EINODE_GET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

4688 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

4689 
u64
 
ivîs
 = 
	`À32_to_˝u
(
øw_öode
->
i_disk_vîsi⁄
);

4691 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4692 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

4693 
ivîs
 |=

4694 (
__u64
)(
	`À32_to_˝u
(
øw_öode
->
i_vîsi⁄_hi
)) << 32;

4696 
	`pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
, 
ivîs
);

4699 
ªt
 = 0;

4700 i‡(
ei
->
i_fûe_a˛
 &&

4701 !
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
sb
), 
ei
->
i_fûe_a˛
, 1)) {

4702 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4704 
ei
->
i_fûe_a˛
);

4705 
ªt
 = -
EFSCORRUPTED
;

4706 
bad_öode
;

4707 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

4709 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

4710 (
	`S_ISLNK
(
öode
->
i_mode
) &&

4711 !
	`pxt4_öode_is_Á°_symlök
(
öode
))) {

4712 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4713 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

4715 
ªt
 = 
	`pxt4_öd_check_öode
(
öode
);

4718 i‡(
ªt
)

4719 
bad_öode
;

4721 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

4722 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

4723 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

4724 
	`pxt4_£t_a›s
(
öode
);

4725 } i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

4726 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

4727 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

4728 } i‡(
	`S_ISLNK
(
öode
->
i_mode
)) {

4730 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode)) {

4731 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4734 
ªt
 = -
EFSCORRUPTED
;

4735 
bad_öode
;

4737 i‡(
	`IS_ENCRYPTED
(
öode
)) {

4738 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

4739 
	`pxt4_£t_a›s
(
öode
);

4740 } i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

4741 
öode
->
i_lök
 = (*)
ei
->
i_d©a
;

4742 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

4743 
	`nd_ãrmö©e_lök
(
ei
->
i_d©a
, 
öode
->
i_size
,

4744 (
ei
->
i_d©a
) - 1);

4746 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

4747 
	`pxt4_£t_a›s
(
öode
);

4749 
	`öode_nohighmem
(
öode
);

4750 } i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode) ||

4751 
	`S_ISFIFO
(
öode
->
i_mode
Ë|| 
	`S_ISSOCK
(inode->i_mode)) {

4752 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

4753 i‡(
øw_öode
->
i_block
[0])

4754 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

4755 
	`ﬁd_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[0])));

4757 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

4758 
	`√w_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[1])));

4759 } i‡(
öo
 =
PXT4_BOOT_LOADER_INO
) {

4760 
	`make_bad_öode
(
öode
);

4762 
ªt
 = -
EFSCORRUPTED
;

4763 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4764 "igë: bogu†i_modê(%o)", 
öode
->
i_mode
);

4765 
bad_öode
;

4767 i‡(
	`IS_CASEFOLDED
(
öode
Ë&& !
	`pxt4_has_„©uª_ˇ£fﬁd
(öode->
i_sb
))

4768 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4770 
	`bªl£
(
ûoc
.
bh
);

4772 
	`u∆ock_√w_öode
(
öode
);

4773  
öode
;

4775 
bad_öode
:

4776 
	`bªl£
(
ûoc
.
bh
);

4777 
	`igë_Áûed
(
öode
);

4778  
	`ERR_PTR
(
ªt
);

4779 
	}
}

4781 
	$pxt4_öode_blocks_£t
(
h™dÀ_t
 *
h™dÀ
,

4782 
pxt4_öode
 *
øw_öode
,

4783 
pxt4_öode_öfo
 *
ei
)

4785 
öode
 *öodê&(
ei
->
vfs_öode
);

4786 
u64
 
i_blocks
 = 
öode
->i_blocks;

4787 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4789 i‡(
i_blocks
 <= ~0U) {

4794 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

4795 
øw_öode
->
i_blocks_high
 = 0;

4796 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

4799 i‡(!
	`pxt4_has_„©uª_huge_fûe
(
sb
))

4800  -
EFBIG
;

4802 i‡(
i_blocks
 <= 0xffffffffffffULL) {

4807 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

4808 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

4809 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

4811 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

4813 
i_blocks
 = i_block†>> (
öode
->
i_blkbôs
 - 9);

4814 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

4815 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

4818 
	}
}

4820 
	sŸhî_öode
 {

4821 
	m‹ig_öo
;

4822 
pxt4_öode
 *
	møw_öode
;

4825 
	$Ÿhî_öode_m©ch
(
öode
 * inode, 
öo
,

4826 *
d©a
)

4828 
Ÿhî_öode
 *
oi
 = (Ÿhî_öodê*Ë
d©a
;

4830 i‡((
öode
->
i_öo
 !
öo
) ||

4831 (
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

4832 
I_DIRTY_INODE
)) ||

4833 ((
öode
->
i_°©e
 & 
I_DIRTY_TIME
) == 0))

4835 
	`•ö_lock
(&
öode
->
i_lock
);

4836 i‡(((
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

4837 
I_DIRTY_INODE
)) == 0) &&

4838 (
öode
->
i_°©e
 & 
I_DIRTY_TIME
)) {

4839 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4841 
öode
->
i_°©e
 &~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

4842 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4844 
	`•ö_lock
(&
ei
->
i_øw_lock
);

4845 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
oi
->
øw_öode
);

4846 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
oi
->
øw_öode
);

4847 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
oi
->
øw_öode
);

4848 
	`pxt4_öode_csum_£t
(
öode
, 
oi
->
øw_öode
, 
ei
);

4849 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

4850 
	`åa˚_pxt4_Ÿhî_öode_upd©e_time
(
öode
, 
oi
->
‹ig_öo
);

4853 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4855 
	}
}

4861 
	$pxt4_upd©e_Ÿhî_öodes_time
(
su≥r_block
 *
sb
,

4862 
‹ig_öo
, *
buf
)

4864 
Ÿhî_öode
 
oi
;

4865 
öo
;

4866 
i
, 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4867 
öode_size
 = 
	`PXT4_INODE_SIZE
(
sb
);

4869 
oi
.
‹ig_öo
 = orig_ino;

4875 
öo
 = ((
‹ig_öo
 - 1Ë& ~(
öodes_≥r_block
 - 1)) + 1;

4876 
i
 = 0; i < 
öodes_≥r_block
; i++, 
öo
++, 
buf
 +
öode_size
) {

4877 i‡(
öo
 =
‹ig_öo
)

4879 
oi
.
øw_öode
 = (
pxt4_öode
 *Ë
buf
;

4880 (Ë
	`föd_öode_nowaô
(
sb
, 
öo
, 
Ÿhî_öode_m©ch
, &
oi
);

4882 
	}
}

4891 
	$pxt4_do_upd©e_öode
(
h™dÀ_t
 *
h™dÀ
,

4892 
öode
 *inode,

4893 
pxt4_ûoc
 *
ûoc
)

4895 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

4896 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4897 
buf„r_hód
 *
bh
 = 
ûoc
->bh;

4898 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4899 
îr
 = 0, 
rc
, 
block
;

4900 
√ed_d©async
 = 0, 
£t_œrge_fûe
 = 0;

4901 
uid_t
 
i_uid
;

4902 
gid_t
 
i_gid
;

4903 
¥ojid_t
 
i_¥ojid
;

4905 
	`•ö_lock
(&
ei
->
i_øw_lock
);

4909 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

4910 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

4912 
øw_öode
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

4913 
i_uid
 = 
	`i_uid_ªad
(
öode
);

4914 
i_gid
 = 
	`i_gid_ªad
(
öode
);

4915 
i_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->i_projid);

4916 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4917 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_uid
));

4918 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_gid
));

4923 i‡(
ei
->
i_dtime
 && 
	`li°_em±y
(&ei->
i_‹ph™
)) {

4924 
øw_öode
->
i_uid_high
 = 0;

4925 
øw_öode
->
i_gid_high
 = 0;

4927 
øw_öode
->
i_uid_high
 =

4928 
	`˝u_to_À16
(
	`high_16_bôs
(
i_uid
));

4929 
øw_öode
->
i_gid_high
 =

4930 
	`˝u_to_À16
(
	`high_16_bôs
(
i_gid
));

4933 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowuid
(
i_uid
));

4934 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowgid
(
i_gid
));

4935 
øw_öode
->
i_uid_high
 = 0;

4936 
øw_öode
->
i_gid_high
 = 0;

4938 
øw_öode
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

4940 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

4941 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

4942 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

4943 
	`PXT4_EINODE_SET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

4945 
îr
 = 
	`pxt4_öode_blocks_£t
(
h™dÀ
, 
øw_öode
, 
ei
);

4946 i‡(
îr
) {

4947 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

4948 
out_bªl£
;

4950 
øw_öode
->
i_dtime
 = 
	`˝u_to_À32
(
ei
->i_dtime);

4951 
øw_öode
->
i_Êags
 = 
	`˝u_to_À32
(
ei
->i_flags & 0xFFFFFFFF);

4952 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
)))

4953 
øw_öode
->
i_fûe_a˛_high
 =

4954 
	`˝u_to_À16
(
ei
->
i_fûe_a˛
 >> 32);

4955 
øw_öode
->
i_fûe_a˛_lo
 = 
	`˝u_to_À32
(
ei
->
i_fûe_a˛
);

4956 i‡(
ei
->
i_disksize
 !
	`pxt4_isize
(
öode
->
i_sb
, 
øw_öode
)) {

4957 
	`pxt4_isize_£t
(
øw_öode
, 
ei
->
i_disksize
);

4958 
√ed_d©async
 = 1;

4960 i‡(
ei
->
i_disksize
 > 0x7fffffffULL) {

4961 i‡(!
	`pxt4_has_„©uª_œrge_fûe
(
sb
) ||

4962 
	`PXT4_SB
(
sb
)->
s_es
->
s_ªv_Àvñ
 ==

4963 
	`˝u_to_À32
(
PXT4_GOOD_OLD_REV
))

4964 
£t_œrge_fûe
 = 1;

4966 
øw_öode
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

4967 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode)) {

4968 i‡(
	`ﬁd_vÆid_dev
(
öode
->
i_rdev
)) {

4969 
øw_öode
->
i_block
[0] =

4970 
	`˝u_to_À32
(
	`ﬁd_ícode_dev
(
öode
->
i_rdev
));

4971 
øw_öode
->
i_block
[1] = 0;

4973 
øw_öode
->
i_block
[0] = 0;

4974 
øw_öode
->
i_block
[1] =

4975 
	`˝u_to_À32
(
	`√w_ícode_dev
(
öode
->
i_rdev
));

4976 
øw_öode
->
i_block
[2] = 0;

4978 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

4979 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

4980 
øw_öode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

4983 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

4984 
u64
 
ivîs
 = 
	`pxt4_öode_≥ek_ivîsi⁄
(
öode
);

4986 
øw_öode
->
i_disk_vîsi⁄
 = 
	`˝u_to_À32
(
ivîs
);

4987 i‡(
ei
->
i_exåa_isize
) {

4988 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

4989 
øw_öode
->
i_vîsi⁄_hi
 =

4990 
	`˝u_to_À32
(
ivîs
 >> 32);

4991 
øw_öode
->
i_exåa_isize
 =

4992 
	`˝u_to_À16
(
ei
->
i_exåa_isize
);

4996 
	`BUG_ON
(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

4997 
i_¥ojid
 !
PXT4_DEF_PROJID
);

4999 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

5000 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

5001 
øw_öode
->
i_¥ojid
 = 
	`˝u_to_À32
(i_projid);

5003 
	`pxt4_öode_csum_£t
(
öode
, 
øw_öode
, 
ei
);

5004 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5005 i‡(
öode
->
i_sb
->
s_Êags
 & 
SB_LAZYTIME
)

5006 
	`pxt4_upd©e_Ÿhî_öodes_time
(
öode
->
i_sb
, inode->
i_öo
,

5007 
bh
->
b_d©a
);

5009 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

5010 
rc
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5011 i‡(!
îr
)

5012 
îr
 = 
rc
;

5013 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

5014 i‡(
£t_œrge_fûe
) {

5015 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get writeáccess");

5016 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

5017 i‡(
îr
)

5018 
out_bªl£
;

5019 
	`pxt4_£t_„©uª_œrge_fûe
(
sb
);

5020 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5021 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

5023 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 
√ed_d©async
);

5024 
out_bªl£
:

5025 
	`bªl£
(
bh
);

5026 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5027  
îr
;

5028 
	}
}

5064 
	$pxt4_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

5066 
îr
;

5068 i‡(
	`WARN_ON_ONCE
(
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

5069 
	`sb_rd⁄ly
(
öode
->
i_sb
))

5072 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5073  -
EIO
;

5075 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

5076 i‡(
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

5077 
	`jbd_debug
(1, "calledÑecursively,Çon-PF_MEMALLOC!\n");

5078 
	`dump_°ack
();

5079  -
EIO
;

5087 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
 || wbc->
f‹_sync
)

5090 
îr
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

5091 
	`PXT4_I
(
öode
)->
i_sync_tid
);

5093 
pxt4_ûoc
 
ûoc
;

5095 
îr
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

5096 i‡(
îr
)

5097  
îr
;

5102 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

5103 
	`sync_dúty_buf„r
(
ûoc
.
bh
);

5104 i‡(
	`buf„r_ªq
(
ûoc
.
bh
Ë&& !
	`buf„r_u±od©e
(iloc.bh)) {

5105 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ûoc
.
bh
->
b_blockƒ
,

5107 
îr
 = -
EIO
;

5109 
	`bªl£
(
ûoc
.
bh
);

5111  
îr
;

5112 
	}
}

5119 
	$pxt4_waô_f‹_èû_∑ge_commô
(
öode
 *inode)

5121 
∑ge
 *page;

5122 
off£t
;

5123 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

5124 
tid_t
 
commô_tid
 = 0;

5125 
ªt
;

5127 
off£t
 = 
öode
->
i_size
 & (
PAGE_SIZE
 - 1);

5137 i‡(!
off£t
 || off£à> (
PAGE_SIZE
 - 
	`i_blocksize
(
öode
)))

5140 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

5141 
öode
->
i_size
 >> 
PAGE_SHIFT
);

5142 i‡(!
∑ge
)

5144 
ªt
 = 
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
,

5145 
PAGE_SIZE
 - 
off£t
);

5146 
	`u∆ock_∑ge
(
∑ge
);

5147 
	`put_∑ge
(
∑ge
);

5148 i‡(
ªt
 !-
EBUSY
)

5150 
commô_tid
 = 0;

5151 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5152 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

5153 
commô_tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

5154 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5155 i‡(
commô_tid
)

5156 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
commô_tid
);

5158 
	}
}

5184 
	$pxt4_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

5186 
öode
 *öodê
	`d_öode
(
díåy
);

5187 
îr‹
, 
rc
 = 0;

5188 
‹ph™
 = 0;

5189 c⁄° 
ü_vÆid
 = 
©å
->ia_valid;

5191 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5192  -
EIO
;

5194 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

5195  -
EPERM
;

5197 i‡(
	`u∆ikñy
(
	`IS_APPEND
(
öode
) &&

5198 (
ü_vÆid
 & (
ATTR_MODE
 | 
ATTR_UID
 |

5199 
ATTR_GID
 | 
ATTR_TIMES_SET
))))

5200  -
EPERM
;

5202 
îr‹
 = 
	`£èâr_¥ï¨e
(
díåy
, 
©å
);

5203 i‡(
îr‹
)

5204  
îr‹
;

5206 
îr‹
 = 
	`fs¸y±_¥ï¨e_£èâr
(
díåy
, 
©å
);

5207 i‡(
îr‹
)

5208  
îr‹
;

5210 
îr‹
 = 
	`fsvîôy_¥ï¨e_£èâr
(
díåy
, 
©å
);

5211 i‡(
îr‹
)

5212  
îr‹
;

5214 i‡(
	`is_quŸa_modifiˇti⁄
(
öode
, 
©å
)) {

5215 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

5216 i‡(
îr‹
)

5217  
îr‹
;

5219 i‡((
ü_vÆid
 & 
ATTR_UID
 && !
	`uid_eq
(
©å
->
ü_uid
, 
öode
->
i_uid
)) ||

5220 (
ü_vÆid
 & 
ATTR_GID
 && !
	`gid_eq
(
©å
->
ü_gid
, 
öode
->
i_gid
))) {

5221 
h™dÀ_t
 *
h™dÀ
;

5225 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5226 (
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
öode
->
i_sb
) +

5227 
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
)) + 3);

5228 i‡(
	`IS_ERR
(
h™dÀ
)) {

5229 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5230 
îr_out
;

5236 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5237 
îr‹
 = 
	`dquŸ_å™s„r
(
öode
, 
©å
);

5238 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5240 i‡(
îr‹
) {

5241 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5242  
îr‹
;

5246 i‡(
©å
->
ü_vÆid
 & 
ATTR_UID
)

5247 
öode
->
i_uid
 = 
©å
->
ü_uid
;

5248 i‡(
©å
->
ü_vÆid
 & 
ATTR_GID
)

5249 
öode
->
i_gid
 = 
©å
->
ü_gid
;

5250 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5251 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5254 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

5255 
h™dÀ_t
 *
h™dÀ
;

5256 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

5257 
shrök
 = (
©å
->
ü_size
 < 
öode
->
i_size
);

5259 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

5260 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5262 i‡(
©å
->
ü_size
 > 
sbi
->
s_bôm≠_maxbyãs
)

5263  -
EFBIG
;

5265 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5266  -
EINVAL
;

5268 i‡(
	`IS_I_VERSION
(
öode
Ë&& 
©å
->
ü_size
 !öode->
i_size
)

5269 
	`öode_öc_ivîsi⁄
(
öode
);

5271 i‡(
shrök
) {

5272 i‡(
	`pxt4_should_‹dî_d©a
(
öode
)) {

5273 
îr‹
 = 
	`pxt4_begö_‹dîed_åunˇã
(
öode
,

5274 
©å
->
ü_size
);

5275 i‡(
îr‹
)

5276 
îr_out
;

5282 
	`öode_dio_waô
(
öode
);

5285 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5287 
rc
 = 
	`pxt4_bªak_œyouts
(
öode
);

5288 i‡(
rc
) {

5289 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5290  
rc
;

5293 i‡(
©å
->
ü_size
 !
öode
->
i_size
) {

5294 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 3);

5295 i‡(
	`IS_ERR
(
h™dÀ
)) {

5296 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5297 
out_mm≠_£m
;

5299 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& 
shrök
) {

5300 
îr‹
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

5301 
‹ph™
 = 1;

5307 i‡(!
shrök
) {

5308 
öode
->
i_mtime
 = 
	`cuºít_time
(inode);

5309 
öode
->
i_˘ime
 = inode->
i_mtime
;

5311 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5312 
	`PXT4_I
(
öode
)->
i_disksize
 = 
©å
->
ü_size
;

5313 
rc
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5314 i‡(!
îr‹
)

5315 
îr‹
 = 
rc
;

5321 i‡(!
îr‹
)

5322 
	`i_size_wrôe
(
öode
, 
©å
->
ü_size
);

5323 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5324 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5325 i‡(
îr‹
)

5326 
out_mm≠_£m
;

5327 i‡(!
shrök
) {

5328 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
,

5329 
öode
->
i_size
);

5330 } i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5331 
	`pxt4_waô_f‹_èû_∑ge_commô
(
öode
);

5339 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

5344 i‡(
©å
->
ü_size
 <
ﬁdsize
) {

5345 
rc
 = 
	`pxt4_åunˇã
(
öode
);

5346 i‡(
rc
)

5347 
îr‹
 = 
rc
;

5349 
out_mm≠_£m
:

5350 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5353 i‡(!
îr‹
) {

5354 
	`£èâr_c›y
(
öode
, 
©å
);

5355 
	`m¨k_öode_dúty
(
öode
);

5362 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5363 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5365 i‡(!
îr‹
 && (
ü_vÆid
 & 
ATTR_MODE
))

5366 
rc
 = 
	`posix_a˛_chmod
(
öode
, inode->
i_mode
);

5368 
îr_out
:

5369 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

5370 i‡(!
îr‹
)

5371 
îr‹
 = 
rc
;

5372  
îr‹
;

5373 
	}
}

5375 
	$pxt4_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5376 
u32
 
ªque°_mask
, 
quîy_Êags
)

5378 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5379 
pxt4_öode
 *
øw_öode
;

5380 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5381 
Êags
;

5383 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¸time
)) {

5384 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

5385 
°©
->
btime
.
tv_£c
 = 
ei
->
i_¸time
.tv_sec;

5386 
°©
->
btime
.
tv_n£c
 = 
ei
->
i_¸time
.tv_nsec;

5389 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

5390 i‡(
Êags
 & 
PXT4_APPEND_FL
)

5391 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

5392 i‡(
Êags
 & 
PXT4_COMPR_FL
)

5393 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

5394 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

5395 
°©
->
©åibuãs
 |
STATX_ATTR_ENCRYPTED
;

5396 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

5397 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

5398 i‡(
Êags
 & 
PXT4_NODUMP_FL
)

5399 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

5400 i‡(
Êags
 & 
PXT4_VERITY_FL
)

5401 
°©
->
©åibuãs
 |
STATX_ATTR_VERITY
;

5403 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

5404 
STATX_ATTR_COMPRESSED
 |

5405 
STATX_ATTR_ENCRYPTED
 |

5406 
STATX_ATTR_IMMUTABLE
 |

5407 
STATX_ATTR_NODUMP
 |

5408 
STATX_ATTR_VERITY
);

5410 
	`gíîic_fûœâr
(
öode
, 
°©
);

5412 
	}
}

5414 
	$pxt4_fûe_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5415 
u32
 
ªque°_mask
, 
quîy_Êags
)

5417 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5418 
u64
 
dñÆloc_blocks
;

5420 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

5428 i‡(
	`u∆ikñy
(
	`pxt4_has_ölöe_d©a
(
öode
)))

5429 
°©
->
blocks
 +(°©->
size
 + 511) >> 9;

5441 
dñÆloc_blocks
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

5442 
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
);

5443 
°©
->
blocks
 +
dñÆloc_blocks
 << (
öode
->
i_sb
->
s_blocksize_bôs
 - 9);

5445 
	}
}

5447 
	$pxt4_ödex_å™s_blocks
(
öode
 *öode, 
lblocks
,

5448 
≥xã¡s
)

5450 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5451  
	`pxt4_öd_å™s_blocks
(
öode
, 
lblocks
);

5452  
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 
≥xã¡s
);

5453 
	}
}

5466 
	$pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

5467 
≥xã¡s
)

5469 
pxt4_group_t
 
groups
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
öode
->
i_sb
);

5470 
gdpblocks
;

5471 
idxblocks
;

5472 
ªt
 = 0;

5478 
idxblocks
 = 
	`pxt4_ödex_å™s_blocks
(
öode
, 
lblocks
, 
≥xã¡s
);

5480 
ªt
 = 
idxblocks
;

5486 
groups
 = 
idxblocks
 + 
≥xã¡s
;

5487 
gdpblocks
 = 
groups
;

5488 i‡(
groups
 > 
ngroups
)

5489 
groups
 = 
ngroups
;

5490 i‡(
groups
 > 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
)

5491 
gdpblocks
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
;

5494 
ªt
 +
groups
 + 
gdpblocks
;

5497 
ªt
 +
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

5499  
ªt
;

5500 
	}
}

5512 
	$pxt4_wrôïage_å™s_blocks
(
öode
 *inode)

5514 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

5515 
ªt
;

5517 
ªt
 = 
	`pxt4_mëa_å™s_blocks
(
öode
, 
bµ
, bpp);

5520 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5521 
ªt
 +
bµ
;

5522  
ªt
;

5523 
	}
}

5534 
	$pxt4_chunk_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

5536  
	`pxt4_mëa_å™s_blocks
(
öode
, 
ƒblocks
, 1);

5537 
	}
}

5543 
	$pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

5544 
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

5546 
îr
 = 0;

5548 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

5549 
	`put_bh
(
ûoc
->
bh
);

5550  -
EIO
;

5552 i‡(
	`IS_I_VERSION
(
öode
))

5553 
	`öode_öc_ivîsi⁄
(
öode
);

5556 
	`gë_bh
(
ûoc
->
bh
);

5559 
îr
 = 
	`pxt4_do_upd©e_öode
(
h™dÀ
, 
öode
, 
ûoc
);

5560 
	`put_bh
(
ûoc
->
bh
);

5561  
îr
;

5562 
	}
}

5570 
	$pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5571 
pxt4_ûoc
 *
ûoc
)

5573 
îr
;

5575 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5576  -
EIO
;

5578 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, 
ûoc
);

5579 i‡(!
îr
) {

5580 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5581 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5582 i‡(
îr
) {

5583 
	`bªl£
(
ûoc
->
bh
);

5584 
ûoc
->
bh
 = 
NULL
;

5587 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5588  
îr
;

5589 
	}
}

5591 
	$__pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5592 
√w_exåa_isize
,

5593 
pxt4_ûoc
 *
ûoc
,

5594 
h™dÀ_t
 *
h™dÀ
, *
no_ex∑nd
)

5596 
pxt4_öode
 *
øw_öode
;

5597 
pxt4_x©å_ibody_hódî
 *
hódî
;

5598 
öode_size
 = 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
);

5599 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5600 
îr‹
;

5603 i‡((
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 > 
öode_size
) ||

5604 (
ei
->
i_exåa_isize
 & 3)) {

5605 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtra_isize %u (inode size %u)",

5606 
ei
->
i_exåa_isize
,

5607 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

5608  -
EFSCORRUPTED
;

5610 i‡((
√w_exåa_isize
 < 
ei
->
i_exåa_isize
) ||

5611 (
√w_exåa_isize
 < 4) ||

5612 (
√w_exåa_isize
 > 
öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))

5613  -
EINVAL
;

5615 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5617 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

5620 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
) ||

5621 
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

5622 
	`mem£t
((*)
øw_öode
 + 
PXT4_GOOD_OLD_INODE_SIZE
 +

5623 
	`PXT4_I
(
öode
)->
i_exåa_isize
, 0,

5624 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
);

5625 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

5630 
îr‹
 = 
	`pxt4_ex∑nd_exåa_isize_ó
(
öode
, 
√w_exåa_isize
,

5631 
øw_öode
, 
h™dÀ
);

5632 i‡(
îr‹
) {

5636 *
no_ex∑nd
 = 1;

5639  
îr‹
;

5640 
	}
}

5646 
	$pxt4_åy_to_ex∑nd_exåa_isize
(
öode
 *inode,

5647 
√w_exåa_isize
,

5648 
pxt4_ûoc
 
ûoc
,

5649 
h™dÀ_t
 *
h™dÀ
)

5651 
no_ex∑nd
;

5652 
îr‹
;

5654 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
))

5655  -
EOVERFLOW
;

5666 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
,

5667 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
), 0) != 0)

5668  -
ENOSPC
;

5670 i‡(
	`pxt4_wrôe_åylock_x©å
(
öode
, &
no_ex∑nd
) == 0)

5671  -
EBUSY
;

5673 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, &
ûoc
,

5674 
h™dÀ
, &
no_ex∑nd
);

5675 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

5677  
îr‹
;

5678 
	}
}

5680 
	$pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5681 
√w_exåa_isize
,

5682 
pxt4_ûoc
 *
ûoc
)

5684 
h™dÀ_t
 *
h™dÀ
;

5685 
no_ex∑nd
;

5686 
îr‹
, 
rc
;

5688 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
)) {

5689 
	`bªl£
(
ûoc
->
bh
);

5690  -
EOVERFLOW
;

5693 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
,

5694 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
));

5695 i‡(
	`IS_ERR
(
h™dÀ
)) {

5696 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5697 
	`bªl£
(
ûoc
->
bh
);

5698  
îr‹
;

5701 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

5703 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5704 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5705 i‡(
îr‹
) {

5706 
	`bªl£
(
ûoc
->
bh
);

5707 
out_u∆ock
;

5710 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, 
ûoc
,

5711 
h™dÀ
, &
no_ex∑nd
);

5713 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, 
ûoc
);

5714 i‡(!
îr‹
)

5715 
îr‹
 = 
rc
;

5717 
out_u∆ock
:

5718 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

5719 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5720  
îr‹
;

5721 
	}
}

5736 
	$pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

5738 
pxt4_ûoc
 
ûoc
;

5739 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5740 
îr
;

5742 
	`might_¶ìp
();

5743 
	`åa˚_pxt4_m¨k_öode_dúty
(
öode
, 
_RET_IP_
);

5744 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

5745 i‡(
îr
)

5746  
îr
;

5748 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 < 
sbi
->
s_w™t_exåa_isize
)

5749 
	`pxt4_åy_to_ex∑nd_exåa_isize
(
öode
, 
sbi
->
s_w™t_exåa_isize
,

5750 
ûoc
, 
h™dÀ
);

5752  
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

5753 
	}
}

5773 
	$pxt4_dúty_öode
(
öode
 *öode, 
Êags
)

5775 
h™dÀ_t
 *
h™dÀ
;

5777 i‡(
Êags
 =
I_DIRTY_TIME
)

5779 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

5780 i‡(
	`IS_ERR
(
h™dÀ
))

5781 
out
;

5783 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5785 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5786 
out
:

5788 
	}
}

5790 
	$pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *öode, 
vÆ
)

5792 
jou∫Æ_t
 *
jou∫Æ
;

5793 
h™dÀ_t
 *
h™dÀ
;

5794 
îr
;

5795 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5807 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

5808 i‡(!
jou∫Æ
)

5810 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

5811  -
EROFS
;

5814 
	`öode_dio_waô
(
öode
);

5824 i‡(
vÆ
) {

5825 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5826 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

5827 i‡(
îr
 < 0) {

5828 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5829  
îr
;

5833 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

5834 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5844 i‡(
vÆ
)

5845 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

5847 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5848 i‡(
îr
 < 0) {

5849 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5850 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

5851  
îr
;

5853 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

5855 
	`pxt4_£t_a›s
(
öode
);

5857 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5858 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

5860 i‡(
vÆ
)

5861 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5865 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

5866 i‡(
	`IS_ERR
(
h™dÀ
))

5867  
	`PTR_ERR
(
h™dÀ
);

5869 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5870 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5871 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5872 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5874  
îr
;

5875 
	}
}

5877 
	$pxt4_bh_unm≠≥d
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

5879  !
	`buf„r_m≠≥d
(
bh
);

5880 
	}
}

5882 
vm_Áu…_t
 
	$pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

5884 
vm_¨ó_°ru˘
 *
vma
 = 
vmf
->vma;

5885 
∑ge
 *∑gê
vmf
->page;

5886 
loff_t
 
size
;

5887 
Àn
;

5888 
îr
;

5889 
vm_Áu…_t
 
ªt
;

5890 
fûe
 *fûê
vma
->
vm_fûe
;

5891 
öode
 *öodê
	`fûe_öode
(
fûe
);

5892 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

5893 
h™dÀ_t
 *
h™dÀ
;

5894 
gë_block_t
 *
gë_block
;

5895 
ªåõs
 = 0;

5897 i‡(
	`u∆ikñy
(
	`IS_IMMUTABLE
(
öode
)))

5898  
VM_FAULT_SIGBUS
;

5900 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

5901 
	`fûe_upd©e_time
(
vma
->
vm_fûe
);

5903 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5905 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

5906 i‡(
îr
)

5907 
out_ªt
;

5910 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

5911 !
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

5912 !
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
)) {

5914 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
,

5915 
pxt4_da_gë_block_¥ï
);

5916 } 
îr
 =-
ENOSPC
 &&

5917 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

5918 
out_ªt
;

5921 
	`lock_∑ge
(
∑ge
);

5922 
size
 = 
	`i_size_ªad
(
öode
);

5924 i‡(
∑ge
->
m≠pög
 !m≠pög || 
	`∑ge_off£t
’ageË> 
size
) {

5925 
	`u∆ock_∑ge
(
∑ge
);

5926 
ªt
 = 
VM_FAULT_NOPAGE
;

5927 
out
;

5930 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

5931 
Àn
 = 
size
 & ~
PAGE_MASK
;

5933 
Àn
 = 
PAGE_SIZE
;

5938 i‡(
	`∑ge_has_buf„rs
(
∑ge
)) {

5939 i‡(!
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
	`∑ge_buf„rs
(
∑ge
),

5940 0, 
Àn
, 
NULL
,

5941 
pxt4_bh_unm≠≥d
)) {

5943 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

5944 
ªt
 = 
VM_FAULT_LOCKED
;

5945 
out
;

5948 
	`u∆ock_∑ge
(
∑ge
);

5950 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

5951 
gë_block
 = 
pxt4_gë_block_unwrôãn
;

5953 
gë_block
 = 
pxt4_gë_block
;

5954 
ªåy_Æloc
:

5955 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

5956 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

5957 i‡(
	`IS_ERR
(
h™dÀ
)) {

5958 
ªt
 = 
VM_FAULT_SIGBUS
;

5959 
out
;

5961 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
, 
gë_block
);

5962 i‡(!
îr
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5963 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 0,

5964 
PAGE_SIZE
, 
NULL
, 
do_jou∫Æ_gë_wrôe_ac˚ss
)) {

5965 
	`u∆ock_∑ge
(
∑ge
);

5966 
ªt
 = 
VM_FAULT_SIGBUS
;

5967 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5968 
out
;

5970 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

5972 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5973 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

5974 
ªåy_Æloc
;

5975 
out_ªt
:

5976 
ªt
 = 
	`block_∑ge_mkwrôe_ªtu∫
(
îr
);

5977 
out
:

5978 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5979 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

5980  
ªt
;

5981 
	}
}

5983 
vm_Áu…_t
 
	$pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

5985 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

5986 
vm_Áu…_t
 
ªt
;

5988 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5989 
ªt
 = 
	`fûem≠_Áu…
(
vmf
);

5990 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5992  
ªt
;

5993 
	}
}

	@ioctl.c

11 
	~<löux/fs.h
>

12 
	~<löux/ˇ∑bûôy.h
>

13 
	~<löux/time.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/mou¡.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/quŸa›s.h
>

18 
	~<löux/øndom.h
>

19 
	~<löux/uuid.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/ivîsi⁄.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

25 
	~<löux/fsm≠.h
>

26 
	~"fsm≠.h
"

27 
	~<åa˚/evíts/pxt4.h
>

37 
	$memsw≠
(*
a
, *
b
, 
size_t
 
Àn
)

39 *
≠
, *
bp
;

41 
≠
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Àn
-- > 0) {

44 
	`sw≠
(*
≠
, *
bp
);

45 
≠
++;

46 
bp
++;

48 
	}
}

61 
	$sw≠_öode_d©a
(
öode
 *
öode1
, öodê*
öode2
)

63 
loff_t
 
isize
;

64 
pxt4_öode_öfo
 *
ei1
;

65 
pxt4_öode_öfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`PXT4_I
(
öode1
);

69 
ei2
 = 
	`PXT4_I
(
öode2
);

71 
	`sw≠
(
öode1
->
i_vîsi⁄
, 
öode2
->i_version);

72 
	`sw≠
(
öode1
->
i_©ime
, 
öode2
->i_atime);

73 
	`sw≠
(
öode1
->
i_mtime
, 
öode2
->i_mtime);

75 
	`memsw≠
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_Êags
 & 
PXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_Êags
 = (
ei2
->i_Êag†& 
PXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_Êags
 & ~
PXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_Êags
 = 
tmp
 | (ei2->i_Êag†& ~
PXT4_FL_SHOULD_SWAP
);

80 
	`sw≠
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`pxt4_es_ªmove_exã¡
(
öode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`pxt4_es_ªmove_exã¡
(
öode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_ªad
(
öode1
);

85 
	`i_size_wrôe
(
öode1
, 
	`i_size_ªad
(
öode2
));

86 
	`i_size_wrôe
(
öode2
, 
isize
);

87 
	}
}

89 
	$ª£t_öode_£ed
(
öode
 *inode)

91 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

92 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

93 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

94 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

95 
__u32
 
csum
;

97 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

100 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
, (gen));

102 
	}
}

113 
	$sw≠_öode_boŸ_lﬂdî
(
su≥r_block
 *
sb
,

114 
öode
 *inode)

116 
h™dÀ_t
 *
h™dÀ
;

117 
îr
;

118 
öode
 *
öode_bl
;

119 
pxt4_öode_öfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blk˙t_t
 
blocks
;

122 
byãs
;

124 
öode_bl
 = 
	`pxt4_igë
(
sb
, 
PXT4_BOOT_LOADER_INO
, 
PXT4_IGET_SPECIAL
);

125 i‡(
	`IS_ERR
(
öode_bl
))

126  
	`PTR_ERR
(
öode_bl
);

127 
ei_bl
 = 
	`PXT4_I
(
öode_bl
);

131 
	`lock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

133 i‡(
öode
->
i_∆ök
 !1 || !
	`S_ISREG
(öode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
öode
Ë|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_JOURNAL_DATA_FL
) ||

136 
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
îr
 = -
EINVAL
;

138 
jou∫Æ_îr_out
;

141 i‡(
	`IS_RDONLY
(
öode
Ë|| 
	`IS_APPEND
(öodeË|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
Ë|| !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

143 
îr
 = -
EPERM
;

144 
jou∫Æ_îr_out
;

147 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

148 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

149 i‡(
îr
)

150 
îr_out
;

152 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode_bl
->
i_m≠pög
);

153 i‡(
îr
)

154 
îr_out
;

157 
	`öode_dio_waô
(
öode
);

158 
	`öode_dio_waô
(
öode_bl
);

160 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

161 
	`åunˇã_öode_∑ges
(&
öode_bl
->
i_d©a
, 0);

163 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode_bl
, 
PXT4_HT_MOVE_EXTENTS
, 2);

164 i‡(
	`IS_ERR
(
h™dÀ
)) {

165 
îr
 = -
EINVAL
;

166 
îr_out
;

170 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
, 
öode_bl
);

172 i‡(
öode_bl
->
i_∆ök
 == 0) {

174 
	`£t_∆ök
(
öode_bl
, 1);

175 
	`i_uid_wrôe
(
öode_bl
, 0);

176 
	`i_gid_wrôe
(
öode_bl
, 0);

177 
öode_bl
->
i_Êags
 = 0;

178 
ei_bl
->
i_Êags
 = 0;

179 
	`öode_£t_ivîsi⁄
(
öode_bl
, 1);

180 
	`i_size_wrôe
(
öode_bl
, 0);

181 
öode_bl
->
i_mode
 = 
S_IFREG
;

182 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

183 
	`pxt4_£t_öode_Êag
(
öode_bl
, 
PXT4_INODE_EXTENTS
);

184 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
îr
 = 
	`dquŸ_öôülize
(
öode
);

190 i‡(
îr
)

191 
îr_out1
;

193 
size
 = (
qsize_t
)(
öode
->
i_blocks
Ë* (1 << 9Ë+ inode->
i_byãs
;

194 
size_bl
 = (
qsize_t
)(
öode_bl
->
i_blocks
Ë* (1 << 9Ë+ inode_bl->
i_byãs
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

198 
öode
->
i_˘ime
 = 
öode_bl
->i_˘imê
	`cuºít_time
(inode);

200 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

201 
öode_bl
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

202 
	`ª£t_öode_£ed
(
öode
);

203 
	`ª£t_öode_£ed
(
öode_bl
);

205 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

207 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

208 i‡(
îr
 < 0) {

210 
	`pxt4_w¨nög
(
öode
->
i_sb
,

212 
öode
->
i_öo
, 
îr
);

214 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

215 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

216 
îr_out1
;

219 
blocks
 = 
öode_bl
->
i_blocks
;

220 
byãs
 = 
öode_bl
->
i_byãs
;

221 
öode_bl
->
i_blocks
 = 
öode
->i_blocks;

222 
öode_bl
->
i_byãs
 = 
öode
->i_bytes;

223 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

224 i‡(
îr
 < 0) {

226 
	`pxt4_w¨nög
(
öode_bl
->
i_sb
,

228 
öode_bl
->
i_öo
, 
îr
);

229 
ªvît
;

233 i‡(
diff
 > 0)

234 
	`dquŸ_‰ì_•a˚
(
öode
, 
diff
);

236 
îr
 = 
	`dquŸ_Æloc_•a˚
(
öode
, -1 * 
diff
);

238 i‡(
îr
 < 0) {

239 
ªvît
:

241 
öode_bl
->
i_blocks
 = 
blocks
;

242 
öode_bl
->
i_byãs
 = 
byãs
;

243 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

244 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

245 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

248 
îr_out1
:

249 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

250 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
, 
öode_bl
);

252 
îr_out
:

253 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

254 
jou∫Æ_îr_out
:

255 
	`u∆ock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

256 
	`ùut
(
öode_bl
);

257  
îr
;

258 
	}
}

260 #ifde‡
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_zîo
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 i‡(
u
[
i
])

269 
	}
}

277 
	$pxt4_io˘l_check_immuèbÀ
(
öode
 *öode, 
__u32
 
√w_¥ojid
,

278 
Êags
)

280 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

281 
ﬁdÊags
 = 
ei
->
i_Êags
;

283 i‡(!(
ﬁdÊags
 & 
PXT4_IMMUTABLE_FL
Ë|| !(
Êags
 & PXT4_IMMUTABLE_FL))

286 i‡((
ﬁdÊags
 & ~
PXT4_IMMUTABLE_FL
Ë!(
Êags
 & ~PXT4_IMMUTABLE_FL))

287  -
EPERM
;

288 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

289 
	`__k¥ojid_vÆ
(
ei
->
i_¥ojid
Ë!
√w_¥ojid
)

290  -
EPERM
;

293 
	}
}

295 
	$pxt4_io˘l_£tÊags
(
öode
 *inode,

296 
Êags
)

298 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

299 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

300 
îr
 = -
EPERM
, 
migøã
 = 0;

301 
pxt4_ûoc
 
ûoc
;

302 
ﬁdÊags
, 
mask
, 
i
;

303 
jÊag
;

304 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

307 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

308 
Êags_out
;

310 
ﬁdÊags
 = 
ei
->
i_Êags
;

313 
jÊag
 = 
Êags
 & 
PXT4_JOURNAL_DATA_FL
;

315 
îr
 = 
	`vfs_ioc_£tÊags_¥ï¨e
(
öode
, 
ﬁdÊags
, 
Êags
);

316 i‡(
îr
)

317 
Êags_out
;

323 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

324 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

325 
Êags_out
;

327 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_EXTENTS_FL
)

328 
migøã
 = 1;

330 i‡(
Êags
 & 
PXT4_EOFBLOCKS_FL
) {

332 i‡(!(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
)) {

333 
îr
 = -
EOPNOTSUPP
;

334 
Êags_out
;

336 } i‡(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
) {

337 
îr
 = 
	`pxt4_åunˇã
(
öode
);

338 i‡(
îr
)

339 
Êags_out
;

342 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_CASEFOLD_FL
) {

343 i‡(!
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

344 
îr
 = -
EOPNOTSUPP
;

345 
Êags_out
;

348 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

349 
îr
 = -
ENOTDIR
;

350 
Êags_out
;

353 i‡(!
	`pxt4_em±y_dú
(
öode
)) {

354 
îr
 = -
ENOTEMPTY
;

355 
Êags_out
;

365 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& !
	`IS_IMMUTABLE
(inode) &&

366 (
Êags
 & 
PXT4_IMMUTABLE_FL
)) {

367 
	`öode_dio_waô
(
öode
);

368 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

369 i‡(
îr
)

370 
Êags_out
;

373 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

374 i‡(
	`IS_ERR
(
h™dÀ
)) {

375 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

376 
Êags_out
;

378 i‡(
	`IS_SYNC
(
öode
))

379 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

380 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

381 i‡(
îr
)

382 
Êags_îr
;

384 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

385 i‡(!(
mask
 & 
PXT4_FL_USER_MODIFIABLE
))

388 i‡(
mask
 =
PXT4_JOURNAL_DATA_FL
 || mask =
PXT4_EXTENTS_FL
)

390 i‡(
mask
 & 
Êags
)

391 
	`pxt4_£t_öode_Êag
(
öode
, 
i
);

393 
	`pxt4_˛ór_öode_Êag
(
öode
, 
i
);

396 
	`pxt4_£t_öode_Êags
(
öode
);

397 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

399 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

400 
Êags_îr
:

401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

402 i‡(
îr
)

403 
Êags_out
;

405 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

410 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DAX
)) {

411 
îr
 = -
EBUSY
;

412 
Êags_out
;

415 
îr
 = 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
, 
jÊag
);

416 i‡(
îr
)

417 
Êags_out
;

419 i‡(
migøã
) {

420 i‡(
Êags
 & 
PXT4_EXTENTS_FL
)

421 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

423 
îr
 = 
	`pxt4_öd_migøã
(
öode
);

426 
Êags_out
:

427  
îr
;

428 
	}
}

430 #ifde‡
CONFIG_QUOTA


431 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

433 
öode
 *öodê
	`fûe_öode
(
fûp
);

434 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

435 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

436 
îr
, 
rc
;

437 
h™dÀ_t
 *
h™dÀ
;

438 
k¥ojid_t
 
k¥ojid
;

439 
pxt4_ûoc
 
ûoc
;

440 
pxt4_öode
 *
øw_öode
;

441 
dquŸ
 *
å™s„r_to
[
MAXQUOTAS
] = { };

443 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
sb
)) {

444 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

445  -
EOPNOTSUPP
;

450 i‡(
	`PXT4_INODE_SIZE
(
sb
Ë<
PXT4_GOOD_OLD_INODE_SIZE
)

451  -
EOPNOTSUPP
;

453 
k¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, (
¥ojid_t
)
¥ojid
);

455 i‡(
	`¥ojid_eq
(
k¥ojid
, 
	`PXT4_I
(
öode
)->
i_¥ojid
))

458 
îr
 = -
EPERM
;

460 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

461  
îr
;

463 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

464 i‡(
îr
)

465  
îr
;

467 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

468 i‡(!
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
)) {

469 
îr
 = 
	`pxt4_ex∑nd_exåa_isize
(
öode
,

470 
	`PXT4_SB
(
sb
)->
s_w™t_exåa_isize
,

471 &
ûoc
);

472 i‡(
îr
)

473  
îr
;

475 
	`bªl£
(
ûoc
.
bh
);

478 
îr
 = 
	`dquŸ_öôülize
(
öode
);

479 i‡(
îr
)

480  
îr
;

482 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

483 
	`PXT4_QUOTA_INIT_BLOCKS
(
sb
) +

484 
	`PXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

485 i‡(
	`IS_ERR
(
h™dÀ
))

486  
	`PTR_ERR
(
h™dÀ
);

488 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

489 i‡(
îr
)

490 
out_°›
;

492 
å™s„r_to
[
PRJQUOTA
] = 
	`dqgë
(
sb
, 
	`make_kqid_¥ojid
(
k¥ojid
));

493 i‡(!
	`IS_ERR
(
å™s„r_to
[
PRJQUOTA
])) {

498 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

499 
îr
 = 
	`__dquŸ_å™s„r
(
öode
, 
å™s„r_to
);

500 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

501 
	`dqput
(
å™s„r_to
[
PRJQUOTA
]);

502 i‡(
îr
)

503 
out_dúty
;

506 
	`PXT4_I
(
öode
)->
i_¥ojid
 = 
k¥ojid
;

507 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

508 
out_dúty
:

509 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

510 i‡(!
îr
)

511 
îr
 = 
rc
;

512 
out_°›
:

513 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

514  
îr
;

515 
	}
}

517 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

519 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

520  -
EOPNOTSUPP
;

522 
	}
}

526 
ölöe
 
__u32
 
	$pxt4_iÊags_to_xÊags
(
iÊags
)

528 
__u32
 
xÊags
 = 0;

530 i‡(
iÊags
 & 
PXT4_SYNC_FL
)

531 
xÊags
 |
FS_XFLAG_SYNC
;

532 i‡(
iÊags
 & 
PXT4_IMMUTABLE_FL
)

533 
xÊags
 |
FS_XFLAG_IMMUTABLE
;

534 i‡(
iÊags
 & 
PXT4_APPEND_FL
)

535 
xÊags
 |
FS_XFLAG_APPEND
;

536 i‡(
iÊags
 & 
PXT4_NODUMP_FL
)

537 
xÊags
 |
FS_XFLAG_NODUMP
;

538 i‡(
iÊags
 & 
PXT4_NOATIME_FL
)

539 
xÊags
 |
FS_XFLAG_NOATIME
;

540 i‡(
iÊags
 & 
PXT4_PROJINHERIT_FL
)

541 
xÊags
 |
FS_XFLAG_PROJINHERIT
;

542  
xÊags
;

543 
	}
}

545 
	#PXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

546 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

547 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

550 
ölöe
 
	$pxt4_xÊags_to_iÊags
(
__u32
 
xÊags
)

552 
iÊags
 = 0;

554 i‡(
xÊags
 & 
FS_XFLAG_SYNC
)

555 
iÊags
 |
PXT4_SYNC_FL
;

556 i‡(
xÊags
 & 
FS_XFLAG_IMMUTABLE
)

557 
iÊags
 |
PXT4_IMMUTABLE_FL
;

558 i‡(
xÊags
 & 
FS_XFLAG_APPEND
)

559 
iÊags
 |
PXT4_APPEND_FL
;

560 i‡(
xÊags
 & 
FS_XFLAG_NODUMP
)

561 
iÊags
 |
PXT4_NODUMP_FL
;

562 i‡(
xÊags
 & 
FS_XFLAG_NOATIME
)

563 
iÊags
 |
PXT4_NOATIME_FL
;

564 i‡(
xÊags
 & 
FS_XFLAG_PROJINHERIT
)

565 
iÊags
 |
PXT4_PROJINHERIT_FL
;

567  
iÊags
;

568 
	}
}

570 
	$pxt4_shutdown
(
su≥r_block
 *
sb
, 
¨g
)

572 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

573 
__u32
 
Êags
;

575 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

576  -
EPERM
;

578 i‡(
	`gë_u£r
(
Êags
, (
__u32
 
__u£r
 *)
¨g
))

579  -
EFAULT
;

581 i‡(
Êags
 > 
PXT4_GOING_FLAGS_NOLOGFLUSH
)

582  -
EINVAL
;

584 i‡(
	`pxt4_f‹˚d_shutdown
(
sbi
))

587 
	`pxt4_msg
(
sb
, 
KERN_ALERT
, "shuàdow¿ªque°ed (%d)", 
Êags
);

588 
	`åa˚_pxt4_shutdown
(
sb
, 
Êags
);

590 
Êags
) {

591 
PXT4_GOING_FLAGS_DEFAULT
:

592 
	`‰ìze_bdev
(
sb
->
s_bdev
);

593 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

594 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

596 
PXT4_GOING_FLAGS_LOGFLUSH
:

597 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

598 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal)) {

599 (Ë
	`pxt4_f‹˚_commô
(
sb
);

600 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

603 
PXT4_GOING_FLAGS_NOLOGFLUSH
:

604 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

605 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal))

606 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

609  -
EINVAL
;

611 
	`˛ór_›t
(
sb
, 
DISCARD
);

613 
	}
}

615 
	sgëfsm≠_öfo
 {

616 
su≥r_block
 *
	mgi_sb
;

617 
fsm≠_hód
 
__u£r
 *
	mgi_d©a
;

618 
	mgi_idx
;

619 
__u32
 
	mgi_œ°_Êags
;

622 
	$pxt4_gëfsm≠_f‹m©
(
pxt4_fsm≠
 *
xfm
, *
¥iv
)

624 
gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

625 
fsm≠
 
fm
;

627 
	`åa˚_pxt4_gëfsm≠_m≠pög
(
öfo
->
gi_sb
, 
xfm
);

629 
öfo
->
gi_œ°_Êags
 = 
xfm
->
fmr_Êags
;

630 
	`pxt4_fsm≠_‰om_öã∫Æ
(
öfo
->
gi_sb
, &
fm
, 
xfm
);

631 i‡(
	`c›y_to_u£r
(&
öfo
->
gi_d©a
->
fmh_ªcs
[öfo->
gi_idx
++], &
fm
,

632 (
fsm≠
)))

633  -
EFAULT
;

636 
	}
}

638 
	$pxt4_ioc_gëfsm≠
(
su≥r_block
 *
sb
,

639 
fsm≠_hód
 
__u£r
 *
¨g
)

641 
gëfsm≠_öfo
 
öfo
 = { 
NULL
 };

642 
pxt4_fsm≠_hód
 
xhód
 = {0};

643 
fsm≠_hód
 
hód
;

644 
boﬁ
 
ab‹ãd
 = 
Ál£
;

645 
îr‹
;

647 i‡(
	`c›y_‰om_u£r
(&
hód
, 
¨g
, (
fsm≠_hód
)))

648  -
EFAULT
;

649 i‡(
	`memchr_öv
(
hód
.
fmh_ª£rved
, 0, (head.fmh_reserved)) ||

650 
	`memchr_öv
(
hód
.
fmh_keys
[0].
fmr_ª£rved
, 0,

651 (
hód
.
fmh_keys
[0].
fmr_ª£rved
)) ||

652 
	`memchr_öv
(
hód
.
fmh_keys
[1].
fmr_ª£rved
, 0,

653 (
hód
.
fmh_keys
[1].
fmr_ª£rved
)))

654  -
EINVAL
;

659 i‡(
hód
.
fmh_keys
[0].
fmr_off£t
 ||

660 (
hód
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

661 
hód
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

662  -
EINVAL
;

664 
xhód
.
fmh_iÊags
 = 
hód
.fmh_iflags;

665 
xhód
.
fmh_cou¡
 = 
hód
.fmh_count;

666 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[0], &
hód
.fmh_keys[0]);

667 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[1], &
hód
.fmh_keys[1]);

669 
	`åa˚_pxt4_gëfsm≠_low_key
(
sb
, &
xhód
.
fmh_keys
[0]);

670 
	`åa˚_pxt4_gëfsm≠_high_key
(
sb
, &
xhód
.
fmh_keys
[1]);

672 
öfo
.
gi_sb
 = 
sb
;

673 
öfo
.
gi_d©a
 = 
¨g
;

674 
îr‹
 = 
	`pxt4_gëfsm≠
(
sb
, &
xhód
, 
pxt4_gëfsm≠_f‹m©
, &
öfo
);

675 i‡(
îr‹
 =
PXT4_QUERY_RANGE_ABORT
) {

676 
îr‹
 = 0;

677 
ab‹ãd
 = 
åue
;

678 } i‡(
îr‹
)

679  
îr‹
;

682 i‡(!
ab‹ãd
 && 
öfo
.
gi_idx
) {

683 
öfo
.
gi_œ°_Êags
 |
FMR_OF_LAST
;

684 i‡(
	`c›y_to_u£r
(&
öfo
.
gi_d©a
->
fmh_ªcs
[öfo.
gi_idx
 - 1].
fmr_Êags
,

685 &
öfo
.
gi_œ°_Êags
,

686 (
öfo
.
gi_œ°_Êags
)))

687  -
EFAULT
;

691 
hód
.
fmh_íåõs
 = 
xhód
.fmh_entries;

692 
hód
.
fmh_oÊags
 = 
xhód
.fmh_oflags;

693 i‡(
	`c›y_to_u£r
(
¨g
, &
hód
, (
fsm≠_hód
)))

694  -
EFAULT
;

697 
	}
}

699 
	$pxt4_io˘l_group_add
(
fûe
 *file,

700 
pxt4_√w_group_d©a
 *
öput
)

702 
su≥r_block
 *
sb
 = 
	`fûe_öode
(
fûe
)->
i_sb
;

703 
îr
, 
îr2
=0;

705 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

706 i‡(
îr
)

707  
îr
;

709 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

710 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

712 
îr
 = -
EOPNOTSUPP
;

713 
group_add_out
;

716 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

717 i‡(
îr
)

718 
group_add_out
;

720 
îr
 = 
	`pxt4_group_add
(
sb
, 
öput
);

721 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

722 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

723 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

724 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

726 i‡(
îr
 == 0)

727 
îr
 = 
îr2
;

728 
	`m¡_dr›_wrôe_fûe
(
fûe
);

729 i‡(!
îr
 && 
	`pxt4_has_group_desc_csum
(
sb
) &&

730 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

731 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
öput
->
group
);

732 
group_add_out
:

733 
	`pxt4_ªsize_íd
(
sb
);

734  
îr
;

735 
	}
}

737 
	$pxt4_fûl_fsx©å
(
öode
 *öode, 
fsx©å
 *
Á
)

739 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

741 
	`sim∂e_fûl_fsx©å
(
Á
, 
	`pxt4_iÊags_to_xÊags
(
ei
->
i_Êags
 &

742 
PXT4_FL_USER_VISIBLE
));

744 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

745 
Á
->
fsx_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
);

746 
	}
}

749 
	$fõm≠_check_ønges
(
su≥r_block
 *
sb
,

750 
u64
 
°¨t
, u64 
Àn
, u64 *
√w_Àn
)

752 
u64
 
maxbyãs
 = (u64Ë
sb
->
s_maxbyãs
;

754 *
√w_Àn
 = 
Àn
;

756 i‡(
Àn
 == 0)

757  -
EINVAL
;

759 i‡(
°¨t
 > 
maxbyãs
)

760  -
EFBIG
;

765 i‡(
Àn
 > 
maxbyãs
 || (maxbyã†-ÜíË< 
°¨t
)

766 *
√w_Àn
 = 
maxbyãs
 - 
°¨t
;

769 
	}
}

772 
	#FIEMAP_MAX_EXTENTS
 (
UINT_MAX
 / (
fõm≠_exã¡
))

	)

774 
	$pxt4_io˘l_gë_es_ˇche
(
fûe
 *
fûp
, 
¨g
)

776 
fõm≠
 fiemap;

777 
fõm≠
 
__u£r
 *
ufõm≠
 = (fõm≠ __u£∏*Ë
¨g
;

778 
fõm≠_exã¡_öfo
 
fõöfo
 = { 0, };

779 
öode
 *öodê
	`fûe_öode
(
fûp
);

780 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

781 
u64
 
Àn
;

782 
îr‹
;

784 i‡(
	`c›y_‰om_u£r
(&
fõm≠
, 
ufõm≠
, (fiemap)))

785  -
EFAULT
;

787 i‡(
fõm≠
.
fm_exã¡_cou¡
 > 
FIEMAP_MAX_EXTENTS
)

788  -
EINVAL
;

790 
îr‹
 = 
	`fõm≠_check_ønges
(
sb
, 
fõm≠
.
fm_°¨t
, fõm≠.
fm_Àngth
,

791 &
Àn
);

792 i‡(
îr‹
)

793  
îr‹
;

795 
fõöfo
.
fi_Êags
 = 
fõm≠
.
fm_Êags
;

796 
fõöfo
.
fi_exã¡s_max
 = 
fõm≠
.
fm_exã¡_cou¡
;

797 
fõöfo
.
fi_exã¡s_°¨t
 = 
ufõm≠
->
fm_exã¡s
;

799 i‡(
fõm≠
.
fm_exã¡_cou¡
 != 0 &&

800 !
	`ac˚ss_ok
(
fõöfo
.
fi_exã¡s_°¨t
,

801 
fõöfo
.
fi_exã¡s_max
 * (
fõm≠_exã¡
)))

802  -
EFAULT
;

804 i‡(
fõöfo
.
fi_Êags
 & 
FIEMAP_FLAG_SYNC
)

805 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

807 
îr‹
 = 
	`pxt4_gë_es_ˇche
(
öode
, &
fõöfo
, 
fõm≠
.
fm_°¨t
, 
Àn
);

808 
fõm≠
.
fm_Êags
 = 
fõöfo
.
fi_Êags
;

809 
fõm≠
.
fm_m≠≥d_exã¡s
 = 
fõöfo
.
fi_exã¡s_m≠≥d
;

810 i‡(
	`c›y_to_u£r
(
ufõm≠
, &
fõm≠
, (fiemap)))

811 
îr‹
 = -
EFAULT
;

813  
îr‹
;

814 
	}
}

816 
	$pxt4_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

818 
öode
 *öodê
	`fûe_öode
(
fûp
);

819 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

820 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

821 
Êags
;

823 
	`pxt4_debug
("cmd = %u,árg = %lu\n", 
cmd
, 
¨g
);

825 
cmd
) {

826 
FS_IOC_GETFSMAP
:

827  
	`pxt4_ioc_gëfsm≠
(
sb
, (
__u£r
 *)
¨g
);

828 
PXT4_IOC_GETFLAGS
:

829 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

830 i‡(
	`S_ISREG
(
öode
->
i_mode
))

831 
Êags
 &~
PXT4_PROJINHERIT_FL
;

832  
	`put_u£r
(
Êags
, (
__u£r
 *Ë
¨g
);

833 
PXT4_IOC_SETFLAGS
: {

834 
îr
;

836 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

837  -
EACCES
;

839 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *Ë
¨g
))

840  -
EFAULT
;

842 i‡(
Êags
 & ~
PXT4_FL_USER_VISIBLE
)

843  -
EOPNOTSUPP
;

850 
Êags
 &
PXT4_FL_USER_MODIFIABLE
;

851 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

852  -
EOPNOTSUPP
;

854 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

855 i‡(
îr
)

856  
îr
;

858 
	`öode_lock
(
öode
);

859 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
,

860 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->
i_¥ojid
),

861 
Êags
);

862 i‡(!
îr
)

863 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

864 
	`öode_u∆ock
(
öode
);

865 
	`m¡_dr›_wrôe_fûe
(
fûp
);

866  
îr
;

868 
PXT4_IOC_GETVERSION
:

869 
PXT4_IOC_GETVERSION_OLD
:

870  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *Ë
¨g
);

871 
PXT4_IOC_SETVERSION
:

872 
PXT4_IOC_SETVERSION_OLD
: {

873 
h™dÀ_t
 *
h™dÀ
;

874 
pxt4_ûoc
 
ûoc
;

875 
__u32
 
gíî©i⁄
;

876 
îr
;

878 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

879  -
EPERM
;

881 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

882 
	`pxt4_w¨nög
(
sb
, "Setting inode version isÇot "

884  -
ENOTTY
;

887 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

888 i‡(
îr
)

889  
îr
;

890 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *Ë
¨g
)) {

891 
îr
 = -
EFAULT
;

892 
£tvîsi⁄_out
;

895 
	`öode_lock
(
öode
);

896 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

897 i‡(
	`IS_ERR
(
h™dÀ
)) {

898 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

899 
u∆ock_out
;

901 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

902 i‡(
îr
 == 0) {

903 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

904 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

905 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

907 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

909 
u∆ock_out
:

910 
	`öode_u∆ock
(
öode
);

911 
£tvîsi⁄_out
:

912 
	`m¡_dr›_wrôe_fûe
(
fûp
);

913  
îr
;

915 
PXT4_IOC_GROUP_EXTEND
: {

916 
pxt4_fsblk_t
 
n_blocks_cou¡
;

917 
îr
, 
îr2
=0;

919 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

920 i‡(
îr
)

921  
îr
;

923 i‡(
	`gë_u£r
(
n_blocks_cou¡
, (
__u32
 
__u£r
 *)
¨g
)) {

924 
îr
 = -
EFAULT
;

925 
group_exãnd_out
;

928 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

929 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

931 
îr
 = -
EOPNOTSUPP
;

932 
group_exãnd_out
;

935 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

936 i‡(
îr
)

937 
group_exãnd_out
;

939 
îr
 = 
	`pxt4_group_exãnd
(
sb
, 
	`PXT4_SB
(sb)->
s_es
, 
n_blocks_cou¡
);

940 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

941 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

942 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

943 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

945 i‡(
îr
 == 0)

946 
îr
 = 
îr2
;

947 
	`m¡_dr›_wrôe_fûe
(
fûp
);

948 
group_exãnd_out
:

949 
	`pxt4_ªsize_íd
(
sb
);

950  
îr
;

953 
PXT4_IOC_MOVE_EXT
: {

954 
move_exã¡
 
me
;

955 
fd
 
d⁄‹
;

956 
îr
;

958 i‡(!(
fûp
->
f_mode
 & 
FMODE_READ
) ||

959 !(
fûp
->
f_mode
 & 
FMODE_WRITE
))

960  -
EBADF
;

962 i‡(
	`c›y_‰om_u£r
(&
me
,

963 (
move_exã¡
 
__u£r
 *)
¨g
, (
me
)))

964  -
EFAULT
;

965 
me
.
moved_Àn
 = 0;

967 
d⁄‹
 = 
	`fdgë
(
me
.
d⁄‹_fd
);

968 i‡(!
d⁄‹
.
fûe
)

969  -
EBADF
;

971 i‡(!(
d⁄‹
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

972 
îr
 = -
EBADF
;

973 
mext_out
;

976 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

977 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

979 
îr
 = -
EOPNOTSUPP
;

980 
mext_out
;

981 } i‡(
	`IS_DAX
(
öode
)) {

982 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

984 
îr
 = -
EOPNOTSUPP
;

985 
mext_out
;

988 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

989 i‡(
îr
)

990 
mext_out
;

992 
îr
 = 
	`pxt4_move_exã¡s
(
fûp
, 
d⁄‹
.
fûe
, 
me
.
‹ig_°¨t
,

993 
me
.
d⁄‹_°¨t
, me.
Àn
, &me.
moved_Àn
);

994 
	`m¡_dr›_wrôe_fûe
(
fûp
);

996 i‡(
	`c›y_to_u£r
((
move_exã¡
 
__u£r
 *)
¨g
,

997 &
me
, (me)))

998 
îr
 = -
EFAULT
;

999 
mext_out
:

1000 
	`fdput
(
d⁄‹
);

1001  
îr
;

1004 
PXT4_IOC_GROUP_ADD
: {

1005 
pxt4_√w_group_d©a
 
öput
;

1007 i‡(
	`c›y_‰om_u£r
(&
öput
, (
pxt4_√w_group_öput
 
__u£r
 *)
¨g
,

1008 (
öput
)))

1009  -
EFAULT
;

1011  
	`pxt4_io˘l_group_add
(
fûp
, &
öput
);

1014 
PXT4_IOC_MIGRATE
:

1016 
îr
;

1017 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1018  -
EACCES
;

1020 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1021 i‡(
îr
)

1022  
îr
;

1029 
	`öode_lock
((
öode
));

1030 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

1031 
	`öode_u∆ock
((
öode
));

1032 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1033  
îr
;

1036 
PXT4_IOC_ALLOC_DA_BLKS
:

1038 
îr
;

1039 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1040  -
EACCES
;

1042 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1043 i‡(
îr
)

1044  
îr
;

1045 
îr
 = 
	`pxt4_Æloc_da_blocks
(
öode
);

1046 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1047  
îr
;

1050 
PXT4_IOC_SWAP_BOOT
:

1052 
îr
;

1053 i‡(!(
fûp
->
f_mode
 & 
FMODE_WRITE
))

1054  -
EBADF
;

1055 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1056 i‡(
îr
)

1057  
îr
;

1058 
îr
 = 
	`sw≠_öode_boŸ_lﬂdî
(
sb
, 
öode
);

1059 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1060  
îr
;

1063 
PXT4_IOC_RESIZE_FS
: {

1064 
pxt4_fsblk_t
 
n_blocks_cou¡
;

1065 
îr
 = 0, 
îr2
 = 0;

1066 
pxt4_group_t
 
o_group
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

1068 i‡(
	`c›y_‰om_u£r
(&
n_blocks_cou¡
, (
__u64
 
__u£r
 *)
¨g
,

1069 (
__u64
))) {

1070  -
EFAULT
;

1073 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

1074 i‡(
îr
)

1075  
îr
;

1077 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1078 i‡(
îr
)

1079 
ªsizefs_out
;

1081 
îr
 = 
	`pxt4_ªsize_fs
(
sb
, 
n_blocks_cou¡
);

1082 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

1083 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1084 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1085 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

1087 i‡(
îr
 == 0)

1088 
îr
 = 
îr2
;

1089 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1090 i‡(!
îr
 && (
o_group
 < 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
) &&

1091 
	`pxt4_has_group_desc_csum
(
sb
) &&

1092 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1093 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
o_group
);

1095 
ªsizefs_out
:

1096 
	`pxt4_ªsize_íd
(
sb
);

1097  
îr
;

1100 
FITRIM
:

1102 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

1103 
f°rim_ønge
 
ønge
;

1104 
ªt
 = 0;

1106 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

1107  -
EPERM
;

1109 i‡(!
	`blk_queue_disˇrd
(
q
))

1110  -
EOPNOTSUPP
;

1116 i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb))

1117  -
EROFS
;

1119 i‡(
	`c›y_‰om_u£r
(&
ønge
, (
f°rim_ønge
 
__u£r
 *)
¨g
,

1120 (
ønge
)))

1121  -
EFAULT
;

1123 
ønge
.
möÀn
 = 
	`max
(()range.minlen,

1124 
q
->
limôs
.
disˇrd_gønuœrôy
);

1125 
ªt
 = 
	`pxt4_åim_fs
(
sb
, &
ønge
);

1126 i‡(
ªt
 < 0)

1127  
ªt
;

1129 i‡(
	`c›y_to_u£r
((
f°rim_ønge
 
__u£r
 *)
¨g
, &
ønge
,

1130 (
ønge
)))

1131  -
EFAULT
;

1135 
PXT4_IOC_PRECACHE_EXTENTS
:

1136  
	`pxt4_ext_¥eˇche
(
öode
);

1138 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1139 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1140  -
EOPNOTSUPP
;

1141  
	`fs¸y±_io˘l_£t_pﬁicy
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1143 
PXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1144 #ifde‡
CONFIG_FS_ENCRYPTION


1145 
îr
, 
îr2
;

1146 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1147 
h™dÀ_t
 *
h™dÀ
;

1149 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1150  -
EOPNOTSUPP
;

1151 i‡(
	`uuid_is_zîo
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
)) {

1152 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1153 i‡(
îr
)

1154  
îr
;

1155 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1156 i‡(
	`IS_ERR
(
h™dÀ
)) {

1157 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1158 
pwß…_îr_exô
;

1160 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1161 i‡(
îr
)

1162 
pwß…_îr_jou∫Æ
;

1163 
	`gíî©e_øndom_uuid
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
);

1164 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1165 
sbi
->
s_sbh
);

1166 
pwß…_îr_jou∫Æ
:

1167 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1168 i‡(
îr2
 && !
îr
)

1169 
îr
 = 
îr2
;

1170 
pwß…_îr_exô
:

1171 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1172 i‡(
îr
)

1173  
îr
;

1175 i‡(
	`c›y_to_u£r
((
__u£r
 *Ë
¨g
,

1176 
sbi
->
s_es
->
s_í¸y±_pw_ß…
, 16))

1177  -
EFAULT
;

1180  -
EOPNOTSUPP
;

1183 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1184 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1185  -
EOPNOTSUPP
;

1186  
	`fs¸y±_io˘l_gë_pﬁicy
(
fûp
, (
__u£r
 *)
¨g
);

1188 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1189 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1190  -
EOPNOTSUPP
;

1191  
	`fs¸y±_io˘l_gë_pﬁicy_ex
(
fûp
, (
__u£r
 *)
¨g
);

1193 
FS_IOC_ADD_ENCRYPTION_KEY
:

1194 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1195  -
EOPNOTSUPP
;

1196  
	`fs¸y±_io˘l_add_key
(
fûp
, (
__u£r
 *)
¨g
);

1198 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1199 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1200  -
EOPNOTSUPP
;

1201  
	`fs¸y±_io˘l_ªmove_key
(
fûp
, (
__u£r
 *)
¨g
);

1203 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1204 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1205  -
EOPNOTSUPP
;

1206  
	`fs¸y±_io˘l_ªmove_key_Æl_u£rs
(
fûp
,

1207 (
__u£r
 *)
¨g
);

1208 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1209 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1210  -
EOPNOTSUPP
;

1211  
	`fs¸y±_io˘l_gë_key_°©us
(
fûp
, (
__u£r
 *)
¨g
);

1213 
PXT4_IOC_CLEAR_ES_CACHE
:

1215 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1216  -
EACCES
;

1217 
	`pxt4_˛ór_öode_es
(
öode
);

1221 
PXT4_IOC_GETSTATE
:

1223 
__u32
 
°©e
 = 0;

1225 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
))

1226 
°©e
 |
PXT4_STATE_FLAG_EXT_PRECACHED
;

1227 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

1228 
°©e
 |
PXT4_STATE_FLAG_NEW
;

1229 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

1230 
°©e
 |
PXT4_STATE_FLAG_NEWENTRY
;

1231 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
))

1232 
°©e
 |
PXT4_STATE_FLAG_DA_ALLOC_CLOSE
;

1234  
	`put_u£r
(
°©e
, (
__u32
 
__u£r
 *Ë
¨g
);

1237 
PXT4_IOC_GET_ES_CACHE
:

1238  
	`pxt4_io˘l_gë_es_ˇche
(
fûp
, 
¨g
);

1240 
PXT4_IOC_FSGETXATTR
:

1242 
fsx©å
 
Á
;

1244 
	`pxt4_fûl_fsx©å
(
öode
, &
Á
);

1246 i‡(
	`c›y_to_u£r
((
fsx©å
 
__u£r
 *)
¨g
,

1247 &
Á
, (fa)))

1248  -
EFAULT
;

1251 
PXT4_IOC_FSSETXATTR
:

1253 
fsx©å
 
Á
, 
ﬁd_Á
;

1254 
îr
;

1256 i‡(
	`c›y_‰om_u£r
(&
Á
, (
fsx©å
 
__u£r
 *)
¨g
,

1257 (
Á
)))

1258  -
EFAULT
;

1261 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1262  -
EACCES
;

1264 i‡(
Á
.
fsx_xÊags
 & ~
PXT4_SUPPORTED_FS_XFLAGS
)

1265  -
EOPNOTSUPP
;

1267 
Êags
 = 
	`pxt4_xÊags_to_iÊags
(
Á
.
fsx_xÊags
);

1268 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

1269  -
EOPNOTSUPP
;

1271 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1272 i‡(
îr
)

1273  
îr
;

1275 
	`öode_lock
(
öode
);

1276 
	`pxt4_fûl_fsx©å
(
öode
, &
ﬁd_Á
);

1277 
îr
 = 
	`vfs_ioc_fs£tx©å_check
(
öode
, &
ﬁd_Á
, &
Á
);

1278 i‡(
îr
)

1279 
out
;

1280 
Êags
 = (
ei
->
i_Êags
 & ~
PXT4_FL_XFLAG_VISIBLE
) |

1281 (
Êags
 & 
PXT4_FL_XFLAG_VISIBLE
);

1282 
îr
 = 
	`pxt4_io˘l_check_immuèbÀ
(
öode
, 
Á
.
fsx_¥ojid
, 
Êags
);

1283 i‡(
îr
)

1284 
out
;

1285 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

1286 i‡(
îr
)

1287 
out
;

1288 
îr
 = 
	`pxt4_io˘l_£çroje˘
(
fûp
, 
Á
.
fsx_¥ojid
);

1289 
out
:

1290 
	`öode_u∆ock
(
öode
);

1291 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1292  
îr
;

1294 
PXT4_IOC_SHUTDOWN
:

1295  
	`pxt4_shutdown
(
sb
, 
¨g
);

1297 
FS_IOC_ENABLE_VERITY
:

1298 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1299  -
EOPNOTSUPP
;

1300  
	`fsvîôy_io˘l_íabÀ
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1302 
FS_IOC_MEASURE_VERITY
:

1303 i‡(!
	`pxt4_has_„©uª_vîôy
(
sb
))

1304  -
EOPNOTSUPP
;

1305  
	`fsvîôy_io˘l_mósuª
(
fûp
, (
__u£r
 *)
¨g
);

1308  -
ENOTTY
;

1310 
	}
}

1312 #ifde‡
CONFIG_COMPAT


1313 
	$pxt4_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

1316 
cmd
) {

1317 
PXT4_IOC32_GETFLAGS
:

1318 
cmd
 = 
PXT4_IOC_GETFLAGS
;

1320 
PXT4_IOC32_SETFLAGS
:

1321 
cmd
 = 
PXT4_IOC_SETFLAGS
;

1323 
PXT4_IOC32_GETVERSION
:

1324 
cmd
 = 
PXT4_IOC_GETVERSION
;

1326 
PXT4_IOC32_SETVERSION
:

1327 
cmd
 = 
PXT4_IOC_SETVERSION
;

1329 
PXT4_IOC32_GROUP_EXTEND
:

1330 
cmd
 = 
PXT4_IOC_GROUP_EXTEND
;

1332 
PXT4_IOC32_GETVERSION_OLD
:

1333 
cmd
 = 
PXT4_IOC_GETVERSION_OLD
;

1335 
PXT4_IOC32_SETVERSION_OLD
:

1336 
cmd
 = 
PXT4_IOC_SETVERSION_OLD
;

1338 
PXT4_IOC32_GETRSVSZ
:

1339 
cmd
 = 
PXT4_IOC_GETRSVSZ
;

1341 
PXT4_IOC32_SETRSVSZ
:

1342 
cmd
 = 
PXT4_IOC_SETRSVSZ
;

1344 
PXT4_IOC32_GROUP_ADD
: {

1345 
com∑t_pxt4_√w_group_öput
 
__u£r
 *
uöput
;

1346 
pxt4_√w_group_d©a
 
öput
;

1347 
îr
;

1349 
uöput
 = 
	`com∑t_±r
(
¨g
);

1350 
îr
 = 
	`gë_u£r
(
öput
.
group
, &
uöput
->group);

1351 
îr
 |
	`gë_u£r
(
öput
.
block_bôm≠
, &
uöput
->block_bitmap);

1352 
îr
 |
	`gë_u£r
(
öput
.
öode_bôm≠
, &
uöput
->inode_bitmap);

1353 
îr
 |
	`gë_u£r
(
öput
.
öode_èbÀ
, &
uöput
->inode_table);

1354 
îr
 |
	`gë_u£r
(
öput
.
blocks_cou¡
, &
uöput
->blocks_count);

1355 
îr
 |
	`gë_u£r
(
öput
.
ª£rved_blocks
,

1356 &
uöput
->
ª£rved_blocks
);

1357 i‡(
îr
)

1358  -
EFAULT
;

1359  
	`pxt4_io˘l_group_add
(
fûe
, &
öput
);

1361 
PXT4_IOC_MOVE_EXT
:

1362 
PXT4_IOC_RESIZE_FS
:

1363 
FITRIM
:

1364 
PXT4_IOC_PRECACHE_EXTENTS
:

1365 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1366 
PXT4_IOC_GET_ENCRYPTION_PWSALT
:

1367 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1368 
FS_IOC_GET_ENCRYPTION_POLICY_EX
:

1369 
FS_IOC_ADD_ENCRYPTION_KEY
:

1370 
FS_IOC_REMOVE_ENCRYPTION_KEY
:

1371 
FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
:

1372 
FS_IOC_GET_ENCRYPTION_KEY_STATUS
:

1373 
PXT4_IOC_SHUTDOWN
:

1374 
FS_IOC_GETFSMAP
:

1375 
FS_IOC_ENABLE_VERITY
:

1376 
FS_IOC_MEASURE_VERITY
:

1377 
PXT4_IOC_CLEAR_ES_CACHE
:

1378 
PXT4_IOC_GETSTATE
:

1379 
PXT4_IOC_GET_ES_CACHE
:

1382  -
ENOIOCTLCMD
;

1384  
	`pxt4_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

1385 
	}
}

	@jbd3/checkpoint.c

17 
	~<löux/time.h
>

18 
	~<löux/fs.h
>

19 
	~<löux/jbd3.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/blkdev.h
>

23 
	~<åa˚/evíts/jbd3.h
>

30 
ölöe
 
	$__buf„r_u∆ök_fú°
(
jou∫Æ_hód
 *
jh
)

32 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

34 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh->b_cpprev;

35 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh->b_cpnext;

36 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
jh
) {

37 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
jh
->
b_˝√xt
;

38 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
jh
)

39 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
NULL
;

41 
	}
}

48 
ölöe
 
	$__buf„r_u∆ök
(
jou∫Æ_hód
 *
jh
)

50 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

52 
	`__buf„r_u∆ök_fú°
(
jh
);

53 i‡(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
jh
) {

54 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
jh
->
b_˝√xt
;

55 i‡(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
jh
)

56 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
NULL
;

58 
	}
}

65 
ölöe
 
	$__buf„r_ªlök_io
(
jou∫Æ_hód
 *
jh
)

67 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

69 
	`__buf„r_u∆ök_fú°
(
jh
);

71 i‡(!
å™ß˘i⁄
->
t_checkpoöt_io_li°
) {

72 
jh
->
b_˝√xt
 = jh->
b_˝¥ev
 = jh;

74 
jh
->
b_˝√xt
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
;

75 
jh
->
b_˝¥ev
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
->b_cpprev;

76 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh;

77 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh;

79 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
jh
;

80 
	}
}

89 
	$__åy_to_‰ì_˝_buf
(
jou∫Æ_hód
 *
jh
)

91 
ªt
 = 0;

92 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

94 i‡(
jh
->
b_å™ß˘i⁄
 =
NULL
 && !
	`buf„r_locked
(
bh
) &&

95 !
	`buf„r_dúty
(
bh
Ë&& !
	`buf„r_wrôe_io_îr‹
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpointÜist");

97 
ªt
 = 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
) + 1;

99  
ªt
;

100 
	}
}

108 
	$__jbd3_log_waô_f‹_•a˚
(
jou∫Æ_t
 *
jou∫Æ
)

110 
nblocks
, 
•a˚_À·
;

113 
nblocks
 = 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
;

114 
	`jbd3_log_•a˚_À·
(
jou∫Æ
Ë< 
nblocks
) {

115 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

116 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

129 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

130 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
) {

131 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

134 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

135 
•a˚_À·
 = 
	`jbd3_log_•a˚_À·
(
jou∫Æ
);

136 i‡(
•a˚_À·
 < 
nblocks
) {

137 
chk±
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
;

138 
tid_t
 
tid
 = 0;

140 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

141 
tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

142 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

143 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

144 i‡(
chk±
) {

145 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

146 } i‡(
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
) == 0) {

149 } i‡(
tid
) {

155 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

156 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

157 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

160 
	`¥ötk
(
KERN_ERR
 "%s:Çeeded %d blocksánd "

162 
__func__
, 
nblocks
, 
•a˚_À·
);

163 
	`¥ötk
(
KERN_ERR
 "%s:Ço wayÅo get more "

164 "jou∫Æ s∑˚ i¿%s\n", 
__func__
,

165 
jou∫Æ
->
j_dev«me
);

166 
	`WARN_ON
(1);

167 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

169 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

171 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

173 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

175 
	}
}

178 
	$__Êush_b©ch
(
jou∫Æ_t
 *
jou∫Æ
, *
b©ch_cou¡
)

180 
i
;

181 
blk_∂ug
 
∂ug
;

183 
	`blk_°¨t_∂ug
(&
∂ug
);

184 
i
 = 0; i < *
b©ch_cou¡
; i++)

185 
	`wrôe_dúty_buf„r
(
jou∫Æ
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

186 
	`blk_föish_∂ug
(&
∂ug
);

188 
i
 = 0; i < *
b©ch_cou¡
; i++) {

189 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_chk±_bhs
[
i
];

190 
	`BUFFER_TRACE
(
bh
, "brelse");

191 
	`__bªl£
(
bh
);

193 *
b©ch_cou¡
 = 0;

194 
	}
}

204 
	$jbd3_log_do_checkpoöt
(
jou∫Æ_t
 *
jou∫Æ
)

206 
jou∫Æ_hód
 *
jh
;

207 
buf„r_hód
 *
bh
;

208 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

209 
tid_t
 
this_tid
;

210 
ªsu…
, 
b©ch_cou¡
 = 0;

212 
	`jbd_debug
(1, "Start checkpoint\n");

219 
ªsu…
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

220 
	`åa˚_jbd3_checkpoöt
(
jou∫Æ
, 
ªsu…
);

221 
	`jbd_debug
(1, "˛ónup_jou∫Æ_èûÑëu∫ed %d\n", 
ªsu…
);

222 i‡(
ªsu…
 <= 0)

223  
ªsu…
;

229 
ªsu…
 = 0;

230 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

231 i‡(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
)

232 
out
;

233 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

234 i‡(
å™ß˘i⁄
->
t_chp_°©s
.
cs_chp_time
 == 0)

235 
å™ß˘i⁄
->
t_chp_°©s
.
cs_chp_time
 = 
jiffõs
;

236 
this_tid
 = 
å™ß˘i⁄
->
t_tid
;

237 
ª°¨t
:

243 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
å™ß˘i⁄
 ||

244 
å™ß˘i⁄
->
t_tid
 !
this_tid
)

245 
out
;

248 
å™ß˘i⁄
->
t_checkpoöt_li°
) {

249 
jh
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
;

250 
bh
 = 
	`jh2bh
(
jh
);

252 i‡(
	`buf„r_locked
(
bh
)) {

253 
	`gë_bh
(
bh
);

254 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

255 
	`waô_⁄_buf„r
(
bh
);

257 
	`BUFFER_TRACE
(
bh
, "brelse");

258 
	`__bªl£
(
bh
);

259 
ªåy
;

261 i‡(
jh
->
b_å™ß˘i⁄
 !
NULL
) {

262 
å™ß˘i⁄_t
 *
t
 = 
jh
->
b_å™ß˘i⁄
;

263 
tid_t
 
tid
 = 
t
->
t_tid
;

265 
å™ß˘i⁄
->
t_chp_°©s
.
cs_f‹˚d_to_˛o£
++;

266 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

267 i‡(
	`u∆ikñy
(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
))

274 
	`¥ötk
(
KERN_ERR


276 
jou∫Æ
->
j_dev«me
, (Ë
bh
->
b_blockƒ
);

278 i‡(
b©ch_cou¡
)

279 
	`__Êush_b©ch
(
jou∫Æ
, &
b©ch_cou¡
);

280 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

289 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

290 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

291 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

292 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

293 
ª°¨t
;

295 i‡(!
	`buf„r_dúty
(
bh
)) {

296 i‡(
	`u∆ikñy
(
	`buf„r_wrôe_io_îr‹
(
bh
)Ë&& !
ªsu…
)

297 
ªsu…
 = -
EIO
;

298 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

299 i‡(
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
))

301 
out
;

312 
	`BUFFER_TRACE
(
bh
, "queue");

313 
	`gë_bh
(
bh
);

314 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_jwrôe
(bh));

315 
jou∫Æ
->
j_chk±_bhs
[
b©ch_cou¡
++] = 
bh
;

316 
	`__buf„r_ªlök_io
(
jh
);

317 
å™ß˘i⁄
->
t_chp_°©s
.
cs_wrôãn
++;

318 i‡((
b©ch_cou¡
 =
JBD3_NR_BATCH
) ||

319 
	`√ed_ªsched
() ||

320 
	`•ö_√edbªak
(&
jou∫Æ
->
j_li°_lock
))

321 
u∆ock_™d_Êush
;

324 i‡(
b©ch_cou¡
) {

325 
u∆ock_™d_Êush
:

326 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

327 
ªåy
:

328 i‡(
b©ch_cou¡
)

329 
	`__Êush_b©ch
(
jou∫Æ
, &
b©ch_cou¡
);

330 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

331 
ª°¨t
;

338 
ª°¨t2
:

340 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
å™ß˘i⁄
 ||

341 
å™ß˘i⁄
->
t_tid
 !
this_tid
)

342 
out
;

344 
å™ß˘i⁄
->
t_checkpoöt_io_li°
) {

345 
jh
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
;

346 
bh
 = 
	`jh2bh
(
jh
);

347 i‡(
	`buf„r_locked
(
bh
)) {

348 
	`gë_bh
(
bh
);

349 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

350 
	`waô_⁄_buf„r
(
bh
);

352 
	`BUFFER_TRACE
(
bh
, "brelse");

353 
	`__bªl£
(
bh
);

354 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

355 
ª°¨t2
;

357 i‡(
	`u∆ikñy
(
	`buf„r_wrôe_io_îr‹
(
bh
)Ë&& !
ªsu…
)

358 
ªsu…
 = -
EIO
;

365 i‡(
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
))

368 
out
:

369 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

370 i‡(
ªsu…
 < 0)

371 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªsu…
);

373 
ªsu…
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

375  (
ªsu…
 < 0) ?Ñesult : 0;

376 
	}
}

396 
	$jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ_t
 *
jou∫Æ
)

398 
tid_t
 
fú°_tid
;

399 
blockƒ
;

401 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

402  -
EIO
;

404 i‡(!
	`jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ
, &
fú°_tid
, &
blockƒ
))

406 
	`J_ASSERT
(
blockƒ
 != 0);

416 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
)

417 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

419  
	`__jbd3_upd©e_log_èû
(
jou∫Æ
, 
fú°_tid
, 
blockƒ
);

420 
	}
}

434 
	$jou∫Æ_˛ón_⁄e_˝_li°
(
jou∫Æ_hód
 *
jh
, 
boﬁ
 
de°roy
)

436 
jou∫Æ_hód
 *
œ°_jh
;

437 
jou∫Æ_hód
 *
√xt_jh
 = 
jh
;

438 
ªt
;

440 i‡(!
jh
)

443 
œ°_jh
 = 
jh
->
b_˝¥ev
;

445 
jh
 = 
√xt_jh
;

446 
√xt_jh
 = 
jh
->
b_˝√xt
;

447 i‡(!
de°roy
)

448 
ªt
 = 
	`__åy_to_‰ì_˝_buf
(
jh
);

450 
ªt
 = 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
) + 1;

451 i‡(!
ªt
)

453 i‡(
ªt
 == 2)

461 i‡(
	`√ed_ªsched
())

463 } 
jh
 !
œ°_jh
);

466 
	}
}

476 
	$__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ_t
 *
jou∫Æ
, 
boﬁ
 
de°roy
)

478 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, *
œ°_å™ß˘i⁄
, *
√xt_å™ß˘i⁄
;

479 
ªt
;

481 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

482 i‡(!
å™ß˘i⁄
)

485 
œ°_å™ß˘i⁄
 = 
å™ß˘i⁄
->
t_˝¥ev
;

486 
√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

488 
å™ß˘i⁄
 = 
√xt_å™ß˘i⁄
;

489 
√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
->
t_˝√xt
;

490 
ªt
 = 
	`jou∫Æ_˛ón_⁄e_˝_li°
(
å™ß˘i⁄
->
t_checkpoöt_li°
,

491 
de°roy
);

497 i‡(
	`√ed_ªsched
())

499 i‡(
ªt
)

506 
ªt
 = 
	`jou∫Æ_˛ón_⁄e_˝_li°
(
å™ß˘i⁄
->

507 
t_checkpoöt_io_li°
, 
de°roy
);

508 i‡(
	`√ed_ªsched
())

515 i‡(!
ªt
)

517 } 
å™ß˘i⁄
 !
œ°_å™ß˘i⁄
);

518 
	}
}

524 
	$jbd3_jou∫Æ_de°roy_checkpoöt
(
jou∫Æ_t
 *
jou∫Æ
)

531 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

532 i‡(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
) {

533 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

536 
	`__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ
, 
åue
);

537 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

538 
	`c⁄d_ªsched
();

540 
	}
}

560 
	$__jbd3_jou∫Æ_ªmove_checkpoöt
(
jou∫Æ_hód
 *
jh
)

562 
å™ß˘i⁄_chp_°©s_s
 *
°©s
;

563 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

564 
jou∫Æ_t
 *
jou∫Æ
;

565 
ªt
 = 0;

567 
	`JBUFFER_TRACE
(
jh
, "entry");

569 i‡((
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
Ë=
NULL
) {

570 
	`JBUFFER_TRACE
(
jh
, "not onÅransaction");

571 
out
;

573 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

575 
	`JBUFFER_TRACE
(
jh
, "removing fromÅransaction");

576 
	`__buf„r_u∆ök
(
jh
);

577 
jh
->
b_˝_å™ß˘i⁄
 = 
NULL
;

578 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

580 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 !
NULL
 ||

581 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 !
NULL
)

582 
out
;

593 i‡(
å™ß˘i⁄
->
t_°©e
 !
T_FINISHED
)

594 
out
;

598 
°©s
 = &
å™ß˘i⁄
->
t_chp_°©s
;

599 i‡(
°©s
->
cs_chp_time
)

600 
°©s
->
cs_chp_time
 = 
	`jbd3_time_diff
(stats->cs_chp_time,

601 
jiffõs
);

602 
	`åa˚_jbd3_checkpoöt_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

603 
å™ß˘i⁄
->
t_tid
, 
°©s
);

605 
	`__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ
, 
å™ß˘i⁄
);

606 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
å™ß˘i⁄
);

607 
ªt
 = 1;

608 
out
:

609  
ªt
;

610 
	}
}

620 
	$__jbd3_jou∫Æ_ö£π_checkpoöt
(
jou∫Æ_hód
 *
jh
,

621 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

623 
	`JBUFFER_TRACE
(
jh
, "entry");

624 
	`J_ASSERT_JH
(
jh
, 
	`buf„r_dúty
(
	`jh2bh
(jh)Ë|| 
	`buf„r_jbddúty
(jh2bh(jh)));

625 
	`J_ASSERT_JH
(
jh
, jh->
b_˝_å™ß˘i⁄
 =
NULL
);

628 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
	`jh2bh
(
jh
));

629 
jh
->
b_˝_å™ß˘i⁄
 = 
å™ß˘i⁄
;

631 i‡(!
å™ß˘i⁄
->
t_checkpoöt_li°
) {

632 
jh
->
b_˝√xt
 = jh->
b_˝¥ev
 = jh;

634 
jh
->
b_˝√xt
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
;

635 
jh
->
b_˝¥ev
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
->b_cpprev;

636 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh;

637 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh;

639 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
jh
;

640 
	}
}

652 
	$__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

654 
	`as£π_•ö_locked
(&
jou∫Æ
->
j_li°_lock
);

655 i‡(
å™ß˘i⁄
->
t_˝√xt
) {

656 
å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
 =Åransaction->t_cpprev;

657 
å™ß˘i⁄
->
t_˝¥ev
->
t_˝√xt
 =Åransaction->t_cpnext;

658 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
å™ß˘i⁄
)

659 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =

660 
å™ß˘i⁄
->
t_˝√xt
;

661 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
å™ß˘i⁄
)

662 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 = 
NULL
;

665 
	`J_ASSERT
(
å™ß˘i⁄
->
t_°©e
 =
T_FINISHED
);

666 
	`J_ASSERT
(
å™ß˘i⁄
->
t_buf„rs
 =
NULL
);

667 
	`J_ASSERT
(
å™ß˘i⁄
->
t_f‹gë
 =
NULL
);

668 
	`J_ASSERT
(
å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

669 
	`J_ASSERT
(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
);

670 
	`J_ASSERT
(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
NULL
);

671 
	`J_ASSERT
(
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
) == 0);

672 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 !
å™ß˘i⁄
);

673 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 !
å™ß˘i⁄
);

675 
	`åa˚_jbd3_dr›_å™ß˘i⁄
(
jou∫Æ
, 
å™ß˘i⁄
);

677 
	`jbd_debug
(1, "Dr›pögÅønß˘i⁄ %d,áŒ d⁄e\n", 
å™ß˘i⁄
->
t_tid
);

678 
	}
}

	@jbd3/commit.c

13 
	~<löux/time.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/jbd3.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/jiffõs.h
>

21 
	~<löux/¸c32.h
>

22 
	~<löux/wrôeback.h
>

23 
	~<löux/backög-dev.h
>

24 
	~<löux/bio.h
>

25 
	~<löux/blkdev.h
>

26 
	~<löux/bô›s.h
>

27 
	~<åa˚/evíts/jbd3.h
>

32 
	$jou∫Æ_íd_buf„r_io_sync
(
buf„r_hód
 *
bh
, 
u±od©e
)

34 
buf„r_hód
 *
‹ig_bh
 = 
bh
->
b_¥iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 i‡(
u±od©e
)

38 
	`£t_buf„r_u±od©e
(
bh
);

40 
	`˛ór_buf„r_u±od©e
(
bh
);

41 i‡(
‹ig_bh
) {

42 
	`˛ór_bô_u∆ock
(
BH_Shadow
, &
‹ig_bh
->
b_°©e
);

43 
	`smp_mb__a·î_©omic
();

44 
	`wake_up_bô
(&
‹ig_bh
->
b_°©e
, 
BH_Shadow
);

46 
	`u∆ock_buf„r
(
bh
);

47 
	}
}

63 
	$ªÀa£_buf„r_∑ge
(
buf„r_hód
 *
bh
)

65 
∑ge
 *page;

67 i‡(
	`buf„r_dúty
(
bh
))

68 
n›e
;

69 i‡(
	`©omic_ªad
(&
bh
->
b_cou¡
) != 1)

70 
n›e
;

71 
∑ge
 = 
bh
->
b_∑ge
;

72 i‡(!
∑ge
)

73 
n›e
;

74 i‡(
∑ge
->
m≠pög
)

75 
n›e
;

78 i‡(!
	`åylock_∑ge
(
∑ge
))

79 
n›e
;

81 
	`gë_∑ge
(
∑ge
);

82 
	`__bªl£
(
bh
);

83 
	`åy_to_‰ì_buf„rs
(
∑ge
);

84 
	`u∆ock_∑ge
(
∑ge
);

85 
	`put_∑ge
(
∑ge
);

88 
n›e
:

89 
	`__bªl£
(
bh
);

90 
	}
}

92 
	$jbd3_commô_block_csum_£t
(
jou∫Æ_t
 *
j
, 
buf„r_hód
 *
bh
)

94 
commô_hódî
 *
h
;

95 
__u32
 
csum
;

97 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

100 
h
 = (
commô_hódî
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty≥
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`˝u_to_be32
(
csum
);

106 
	}
}

116 
	$jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

117 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
,

118 
buf„r_hód
 **
cbh
,

119 
__u32
 
¸c32_sum
)

121 
commô_hódî
 *
tmp
;

122 
buf„r_hód
 *
bh
;

123 
ªt
;

124 
time•ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

131 
bh
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
commô_å™ß˘i⁄
,

132 
JBD3_COMMIT_BLOCK
);

133 i‡(!
bh
)

136 
tmp
 = (
commô_hódî
 *)
bh
->
b_d©a
;

137 
	`ktime_gë_cﬂr£_ªÆ_ts64
(&
now
);

138 
tmp
->
h_commô_£c
 = 
	`˝u_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_commô_n£c
 = 
	`˝u_to_be32
(
now
.
tv_n£c
);

141 i‡(
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

142 
tmp
->
h_chksum_ty≥
 = 
JBD3_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD3_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`˝u_to_be32
(
¸c32_sum
);

146 
	`jbd3_commô_block_csum_£t
(
jou∫Æ
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_buf„r
(
bh
);

150 
	`˛ór_buf„r_dúty
(
bh
);

151 
	`£t_buf„r_u±od©e
(
bh
);

152 
bh
->
b_íd_io
 = 
jou∫Æ_íd_buf„r_io_sync
;

154 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

155 !
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
))

156 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
ªt
;

163 
	}
}

169 
	$jou∫Æ_waô_⁄_commô_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

170 
buf„r_hód
 *
bh
)

172 
ªt
 = 0;

174 
	`˛ór_buf„r_dúty
(
bh
);

175 
	`waô_⁄_buf„r
(
bh
);

177 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

178 
ªt
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
ªt
;

182 
	}
}

190 
	$jou∫Æ_submô_öode_d©a_buf„rs
(
addªss_•a˚
 *
m≠pög
,

191 
loff_t
 
dúty_°¨t
,Üoff_à
dúty_íd
)

193 
ªt
;

194 
wrôeback_c⁄åﬁ
 
wbc
 = {

195 .
sync_mode
 = 
WB_SYNC_ALL
,

196 .
ƒ_to_wrôe
 = 
m≠pög
->
ƒ∑ges
 * 2,

197 .
ønge_°¨t
 = 
dúty_°¨t
,

198 .
ønge_íd
 = 
dúty_íd
,

201 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, &
wbc
);

202  
ªt
;

203 
	}
}

213 
	$jou∫Æ_submô_d©a_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

214 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
)

216 
jbd3_öode
 *
jöode
;

217 
îr
, 
ªt
 = 0;

218 
addªss_•a˚
 *
m≠pög
;

220 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

221 
	`li°_f‹_óch_íåy
(
jöode
, &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

222 
loff_t
 
dúty_°¨t
 = 
jöode
->
i_dúty_°¨t
;

223 
loff_t
 
dúty_íd
 = 
jöode
->
i_dúty_íd
;

225 i‡(!(
jöode
->
i_Êags
 & 
JI_WRITE_DATA
))

227 
m≠pög
 = 
jöode
->
i_vfs_öode
->
i_m≠pög
;

228 
jöode
->
i_Êags
 |
JI_COMMIT_RUNNING
;

229 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

236 
	`åa˚_jbd3_submô_öode_d©a
(
jöode
->
i_vfs_öode
);

237 
îr
 = 
	`jou∫Æ_submô_öode_d©a_buf„rs
(
m≠pög
, 
dúty_°¨t
,

238 
dúty_íd
);

239 i‡(!
ªt
)

240 
ªt
 = 
îr
;

241 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

242 
	`J_ASSERT
(
jöode
->
i_å™ß˘i⁄
 =
commô_å™ß˘i⁄
);

243 
jöode
->
i_Êags
 &~
JI_COMMIT_RUNNING
;

244 
	`smp_mb
();

245 
	`wake_up_bô
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

247 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

248  
ªt
;

249 
	}
}

256 
	$jou∫Æ_föish_öode_d©a_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

257 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
)

259 
jbd3_öode
 *
jöode
, *
√xt_i
;

260 
îr
, 
ªt
 = 0;

263 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

264 
	`li°_f‹_óch_íåy
(
jöode
, &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

265 
loff_t
 
dúty_°¨t
 = 
jöode
->
i_dúty_°¨t
;

266 
loff_t
 
dúty_íd
 = 
jöode
->
i_dúty_íd
;

268 i‡(!(
jöode
->
i_Êags
 & 
JI_WAIT_DATA
))

270 
jöode
->
i_Êags
 |
JI_COMMIT_RUNNING
;

271 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

272 
îr
 = 
	`fûem≠_fd©awaô_ønge_kìp_îr‹s
(

273 
jöode
->
i_vfs_öode
->
i_m≠pög
, 
dúty_°¨t
,

274 
dúty_íd
);

275 i‡(!
ªt
)

276 
ªt
 = 
îr
;

277 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

278 
jöode
->
i_Êags
 &~
JI_COMMIT_RUNNING
;

279 
	`smp_mb
();

280 
	`wake_up_bô
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

284 
	`li°_f‹_óch_íåy_ß„
(
jöode
, 
√xt_i
,

285 &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

286 
	`li°_dñ
(&
jöode
->
i_li°
);

287 i‡(
jöode
->
i_√xt_å™ß˘i⁄
) {

288 
jöode
->
i_å™ß˘i⁄
 = jöode->
i_√xt_å™ß˘i⁄
;

289 
jöode
->
i_√xt_å™ß˘i⁄
 = 
NULL
;

290 
	`li°_add
(&
jöode
->
i_li°
,

291 &
jöode
->
i_å™ß˘i⁄
->
t_öode_li°
);

293 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

294 
jöode
->
i_dúty_°¨t
 = 0;

295 
jöode
->
i_dúty_íd
 = 0;

298 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

300  
ªt
;

301 
	}
}

303 
__u32
 
	$jbd3_checksum_d©a
(
__u32
 
¸c32_sum
, 
buf„r_hód
 *
bh
)

305 
∑ge
 *∑gê
bh
->
b_∑ge
;

306 *
addr
;

307 
__u32
 
checksum
;

309 
addr
 = 
	`km≠_©omic
(
∑ge
);

310 
checksum
 = 
	`¸c32_be
(
¸c32_sum
,

311 (*)(
addr
 + 
	`off£t_ö_∑ge
(
bh
->
b_d©a
)), bh->
b_size
);

312 
	`kunm≠_©omic
(
addr
);

314  
checksum
;

315 
	}
}

317 
	$wrôe_èg_block
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

318 
block
)

320 
èg
->
t_blockƒ
 = 
	`˝u_to_be32
(
block
 & (
u32
)~0);

321 i‡(
	`jbd3_has_„©uª_64bô
(
j
))

322 
èg
->
t_blockƒ_high
 = 
	`˝u_to_be32
((
block
 >> 31) >> 1);

323 
	}
}

325 
	$jbd3_block_èg_csum_£t
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

326 
buf„r_hód
 *
bh
, 
__u32
 
£quí˚
)

328 
jou∫Æ_block_èg3_t
 *
èg3
 = (jou∫Æ_block_èg3_à*)
èg
;

329 
∑ge
 *∑gê
bh
->
b_∑ge
;

330 
__u8
 *
addr
;

331 
__u32
 
csum32
;

332 
__be32
 
£q
;

334 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

337 
£q
 = 
	`˝u_to_be32
(
£quí˚
);

338 
addr
 = 
	`km≠_©omic
(
∑ge
);

339 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

340 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
addr
 + 
	`off£t_ö_∑ge
(
bh
->
b_d©a
),

341 
bh
->
b_size
);

342 
	`kunm≠_©omic
(
addr
);

344 i‡(
	`jbd3_has_„©uª_csum3
(
j
))

345 
èg3
->
t_checksum
 = 
	`˝u_to_be32
(
csum32
);

347 
èg
->
t_checksum
 = 
	`˝u_to_be16
(
csum32
);

348 
	}
}

355 
	$jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
)

357 
å™ß˘i⁄_°©s_s
 
°©s
;

358 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
;

359 
jou∫Æ_hód
 *
jh
;

360 
buf„r_hód
 *
des¸ùt‹
;

361 
buf„r_hód
 **
wbuf
 = 
jou∫Æ
->
j_wbuf
;

362 
bufs
;

363 
Êags
;

364 
îr
;

365 
blockƒ
;

366 
ktime_t
 
°¨t_time
;

367 
u64
 
commô_time
;

368 *
ègp
 = 
NULL
;

369 
jou∫Æ_block_èg_t
 *
èg
 = 
NULL
;

370 
•a˚_À·
 = 0;

371 
fú°_èg
 = 0;

372 
èg_Êag
;

373 
i
;

374 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

375 
buf„r_hód
 *
cbh
 = 
NULL
;

376 
__u32
 
¸c32_sum
 = ~0;

377 
blk_∂ug
 
∂ug
;

379 
fú°_block
;

380 
tid_t
 
fú°_tid
;

381 
upd©e_èû
;

382 
csum_size
 = 0;

383 
	`LIST_HEAD
(
io_bufs
);

384 
	`LIST_HEAD
(
log_bufs
);

386 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

387 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

395 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_FLUSHED
) {

396 
	`jbd_debug
(3, "super block updated\n");

397 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

404 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
,

405 
jou∫Æ
->
j_èû_£quí˚
,

406 
jou∫Æ
->
j_èû
,

407 
REQ_SYNC
);

408 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

410 
	`jbd_debug
(3, "superblockÇot updated\n");

413 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 !
NULL
);

414 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 =
NULL
);

416 
commô_å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

418 
	`åa˚_jbd3_°¨t_commô
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

419 
	`jbd_debug
(1, "JBD3: starting commit ofÅransaction %d\n",

420 
commô_å™ß˘i⁄
->
t_tid
);

422 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

423 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_RUNNING
);

424 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_LOCKED
;

426 
	`åa˚_jbd3_commô_lockög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

427 
°©s
.
run
.
rs_waô
 = 
commô_å™ß˘i⁄
->
t_max_waô
;

428 
°©s
.
run
.
rs_ªque°_dñay
 = 0;

429 
°©s
.
run
.
rs_locked
 = 
jiffõs
;

430 i‡(
commô_å™ß˘i⁄
->
t_ªque°ed
)

431 
°©s
.
run
.
rs_ªque°_dñay
 =

432 
	`jbd3_time_diff
(
commô_å™ß˘i⁄
->
t_ªque°ed
,

433 
°©s
.
run
.
rs_locked
);

434 
°©s
.
run
.
rs_ru¬ög
 = 
	`jbd3_time_diff
(
commô_å™ß˘i⁄
->
t_°¨t
,

435 
°©s
.
run
.
rs_locked
);

437 
	`•ö_lock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

438 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_upd©es
)) {

439 
	`DEFINE_WAIT
(
waô
);

441 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
,

442 
TASK_UNINTERRUPTIBLE
);

443 i‡(
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_upd©es
)) {

444 
	`•ö_u∆ock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

445 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

446 
	`scheduÀ
();

447 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

448 
	`•ö_lock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

450 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

452 
	`•ö_u∆ock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

453 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_SWITCH
;

454 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

456 
	`J_ASSERT
 (
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
) <=

457 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

475 
commô_å™ß˘i⁄
->
t_ª£rved_li°
) {

476 
jh
 = 
commô_å™ß˘i⁄
->
t_ª£rved_li°
;

477 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:Ñefile");

482 i‡(
jh
->
b_commôãd_d©a
) {

483 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

485 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

486 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
bh
->
b_size
);

487 
jh
->
b_commôãd_d©a
 = 
NULL
;

488 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

490 
	`jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ
, 
jh
);

498 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

499 
	`__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ
, 
Ál£
);

500 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

502 
	`jbd_debug
(3, "JBD3: commitÖhase 1\n");

508 
	`jbd3_˛ór_buf„r_ªvoked_Êags
(
jou∫Æ
);

513 
	`jbd3_jou∫Æ_swôch_ªvoke_èbÀ
(
jou∫Æ
);

518 
	`©omic_sub
(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
),

519 &
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
);

521 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

522 
	`åa˚_jbd3_commô_Êushög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

523 
°©s
.
run
.
rs_Êushög
 = 
jiffõs
;

524 
°©s
.
run
.
rs_locked
 = 
	`jbd3_time_diff
(stats.run.rs_locked,

525 
°©s
.
run
.
rs_Êushög
);

527 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_FLUSH
;

528 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 = 
commô_å™ß˘i⁄
;

529 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 = 
NULL
;

530 
°¨t_time
 = 
	`ktime_gë
();

531 
commô_å™ß˘i⁄
->
t_log_°¨t
 = 
jou∫Æ
->
j_hód
;

532 
	`wake_up
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

533 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

535 
	`jbd_debug
(3, "JBD3: commitÖhase 2a\n");

541 
îr
 = 
	`jou∫Æ_submô_d©a_buf„rs
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

542 i‡(
îr
)

543 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

545 
	`blk_°¨t_∂ug
(&
∂ug
);

546 
	`jbd3_jou∫Æ_wrôe_ªvoke_ªc‹ds
(
commô_å™ß˘i⁄
, &
log_bufs
);

548 
	`jbd_debug
(3, "JBD3: commitÖhase 2b\n");

555 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

556 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT
;

557 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

559 
	`åa˚_jbd3_commô_loggög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

560 
°©s
.
run
.
rs_loggög
 = 
jiffõs
;

561 
°©s
.
run
.
rs_Êushög
 = 
	`jbd3_time_diff
(stats.run.rs_flushing,

562 
°©s
.
run
.
rs_loggög
);

563 
°©s
.
run
.
rs_blocks
 = 
commô_å™ß˘i⁄
->
t_ƒ_buf„rs
;

564 
°©s
.
run
.
rs_blocks_logged
 = 0;

566 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_ƒ_buf„rs
 <=

567 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
));

569 
îr
 = 0;

570 
bufs
 = 0;

571 
des¸ùt‹
 = 
NULL
;

572 
commô_å™ß˘i⁄
->
t_buf„rs
) {

576 
jh
 = 
commô_å™ß˘i⁄
->
t_buf„rs
;

581 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)) {

582 
	`˛ór_buf„r_jbddúty
(
	`jh2bh
(
jh
));

583 
	`JBUFFER_TRACE
(
jh
, "journal isáborting:Ñefile");

584 
	`jbd3_buf„r_ab‹t_åiggî
(
jh
,

585 
jh
->
b_‰ozí_d©a
 ?

586 
jh
->
b_‰ozí_åiggîs
 :

587 
jh
->
b_åiggîs
);

588 
	`jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ
, 
jh
);

593 i‡(!
commô_å™ß˘i⁄
->
t_buf„rs
)

594 
°¨t_jou∫Æ_io
;

601 i‡(!
des¸ùt‹
) {

602 
	`J_ASSERT
 (
bufs
 == 0);

604 
	`jbd_debug
(4, "JBD3: get descriptor\n");

606 
des¸ùt‹
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(

607 
commô_å™ß˘i⁄
,

608 
JBD3_DESCRIPTOR_BLOCK
);

609 i‡(!
des¸ùt‹
) {

610 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

614 
	`jbd_debug
(4, "JBD3: got buffer %llu (%p)\n",

615 ()
des¸ùt‹
->
b_blockƒ
,

616 
des¸ùt‹
->
b_d©a
);

617 
ègp
 = &
des¸ùt‹
->
b_d©a
[(
jou∫Æ_hódî_t
)];

618 
•a˚_À·
 = 
des¸ùt‹
->
b_size
 -

619 (
jou∫Æ_hódî_t
);

620 
fú°_èg
 = 1;

621 
	`£t_buf„r_jwrôe
(
des¸ùt‹
);

622 
	`£t_buf„r_dúty
(
des¸ùt‹
);

623 
wbuf
[
bufs
++] = 
des¸ùt‹
;

627 
	`BUFFER_TRACE
(
des¸ùt‹
, "ph3: fileás descriptor");

628 
	`jbd3_fûe_log_bh
(&
log_bufs
, 
des¸ùt‹
);

633 
îr
 = 
	`jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ
, &
blockƒ
);

637 i‡(
îr
) {

638 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

646 
	`©omic_dec
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
);

651 
	`©omic_öc
(&
	`jh2bh
(
jh
)->
b_cou¡
);

657 
	`£t_bô
(
BH_JWrôe
, &
	`jh2bh
(
jh
)->
b_°©e
);

658 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

659 
Êags
 = 
	`jbd3_jou∫Æ_wrôe_mëad©a_buf„r
(
commô_å™ß˘i⁄
,

660 
jh
, &
wbuf
[
bufs
], 
blockƒ
);

661 i‡(
Êags
 < 0) {

662 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
Êags
);

665 
	`jbd3_fûe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

670 
èg_Êag
 = 0;

671 i‡(
Êags
 & 1)

672 
èg_Êag
 |
JBD3_FLAG_ESCAPE
;

673 i‡(!
fú°_èg
)

674 
èg_Êag
 |
JBD3_FLAG_SAME_UUID
;

676 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

677 
	`wrôe_èg_block
(
jou∫Æ
, 
èg
, 
	`jh2bh
(
jh
)->
b_blockƒ
);

678 
èg
->
t_Êags
 = 
	`˝u_to_be16
(
èg_Êag
);

679 
	`jbd3_block_èg_csum_£t
(
jou∫Æ
, 
èg
, 
wbuf
[
bufs
],

680 
commô_å™ß˘i⁄
->
t_tid
);

681 
ègp
 +
èg_byãs
;

682 
•a˚_À·
 -
èg_byãs
;

683 
bufs
++;

685 i‡(
fú°_èg
) {

686 
	`mem˝y
 (
ègp
, 
jou∫Æ
->
j_uuid
, 16);

687 
ègp
 += 16;

688 
•a˚_À·
 -= 16;

689 
fú°_èg
 = 0;

695 i‡(
bufs
 =
jou∫Æ
->
j_wbufsize
 ||

696 
commô_å™ß˘i⁄
->
t_buf„rs
 =
NULL
 ||

697 
•a˚_À·
 < 
èg_byãs
 + 16 + 
csum_size
) {

699 
	`jbd_debug
(4, "JBD3: Submô %d IOs\n", 
bufs
);

705 
èg
->
t_Êags
 |
	`˝u_to_be16
(
JBD3_FLAG_LAST_TAG
);

706 
°¨t_jou∫Æ_io
:

707 i‡(
des¸ùt‹
)

708 
	`jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ
,

709 
des¸ùt‹
);

711 
i
 = 0; i < 
bufs
; i++) {

712 
buf„r_hód
 *
bh
 = 
wbuf
[
i
];

716 i‡(
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

717 
¸c32_sum
 =

718 
	`jbd3_checksum_d©a
(
¸c32_sum
, 
bh
);

721 
	`lock_buf„r
(
bh
);

722 
	`˛ór_buf„r_dúty
(
bh
);

723 
	`£t_buf„r_u±od©e
(
bh
);

724 
bh
->
b_íd_io
 = 
jou∫Æ_íd_buf„r_io_sync
;

725 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

727 
	`c⁄d_ªsched
();

731 
des¸ùt‹
 = 
NULL
;

732 
bufs
 = 0;

736 
îr
 = 
	`jou∫Æ_föish_öode_d©a_buf„rs
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

737 i‡(
îr
) {

738 
	`¥ötk
(
KERN_WARNING


740 "⁄ %s\n", 
jou∫Æ
->
j_dev«me
);

741 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT_ON_SYNCDATA_ERR
)

742 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

743 
îr
 = 0;

753 
upd©e_èû
 =

754 
	`jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ
, &
fú°_tid
, &
fú°_block
);

756 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

757 i‡(
upd©e_èû
) {

758 
‰ìd
 = 
fú°_block
 - 
jou∫Æ
->
j_èû
;

760 i‡(
fú°_block
 < 
jou∫Æ
->
j_èû
)

761 
‰ìd
 +
jou∫Æ
->
j_œ°
 - jou∫Æ->
j_fú°
;

763 i‡(
‰ìd
 < 
jou∫Æ
->
j_maxÀn
 / 4)

764 
upd©e_èû
 = 0;

766 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT
);

767 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_DFLUSH
;

768 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

775 i‡(
commô_å™ß˘i⁄
->
t_√ed_d©a_Êush
 &&

776 (
jou∫Æ
->
j_fs_dev
 !jou∫Æ->
j_dev
) &&

777 (
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

778 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

781 i‡(
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

782 
îr
 = 
	`jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ
, 
commô_å™ß˘i⁄
,

783 &
cbh
, 
¸c32_sum
);

784 i‡(
îr
)

785 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

788 
	`blk_föish_∂ug
(&
∂ug
);

801 
	`jbd_debug
(3, "JBD3: commitÖhase 3\n");

803 !
	`li°_em±y
(&
io_bufs
)) {

804 
buf„r_hód
 *
bh
 = 
	`li°_íåy
(
io_bufs
.
¥ev
,

805 
buf„r_hód
,

806 
b_assoc_buf„rs
);

808 
	`waô_⁄_buf„r
(
bh
);

809 
	`c⁄d_ªsched
();

811 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

812 
îr
 = -
EIO
;

813 
	`jbd3_unfûe_log_bh
(
bh
);

814 
°©s
.
run
.
rs_blocks_logged
++;

820 
	`BUFFER_TRACE
(
bh
, "dumpingÅemporary bh");

821 
	`__bªl£
(
bh
);

822 
	`J_ASSERT_BH
(
bh
, 
	`©omic_ªad
(&bh->
b_cou¡
) == 0);

823 
	`‰ì_buf„r_hód
(
bh
);

826 
jh
 = 
commô_å™ß˘i⁄
->
t_shadow_li°
->
b_çªv
;

827 
bh
 = 
	`jh2bh
(
jh
);

828 
	`˛ór_buf„r_jwrôe
(
bh
);

829 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_jbddúty
(bh));

830 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_shadow
(bh));

836 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Forget");

837 
	`jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
commô_å™ß˘i⁄
, 
BJ_F‹gë
);

838 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

839 
	`__bªl£
(
bh
);

842 
	`J_ASSERT
 (
commô_å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

844 
	`jbd_debug
(3, "JBD3: commitÖhase 4\n");

847 !
	`li°_em±y
(&
log_bufs
)) {

848 
buf„r_hód
 *
bh
;

850 
bh
 = 
	`li°_íåy
(
log_bufs
.
¥ev
, 
buf„r_hód
, 
b_assoc_buf„rs
);

851 
	`waô_⁄_buf„r
(
bh
);

852 
	`c⁄d_ªsched
();

854 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

855 
îr
 = -
EIO
;

857 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

858 
	`˛ór_buf„r_jwrôe
(
bh
);

859 
	`jbd3_unfûe_log_bh
(
bh
);

860 
°©s
.
run
.
rs_blocks_logged
++;

861 
	`__bªl£
(
bh
);

865 i‡(
îr
)

866 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

868 
	`jbd_debug
(3, "JBD3: commitÖhase 5\n");

869 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

870 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT_DFLUSH
);

871 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_JFLUSH
;

872 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

874 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

875 
îr
 = 
	`jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ
, 
commô_å™ß˘i⁄
,

876 &
cbh
, 
¸c32_sum
);

877 i‡(
îr
)

878 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

880 i‡(
cbh
)

881 
îr
 = 
	`jou∫Æ_waô_⁄_commô_ªc‹d
(
jou∫Æ
, 
cbh
);

882 
°©s
.
run
.
rs_blocks_logged
++;

883 i‡(
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
) &&

884 
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
) {

885 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_dev
, 
GFP_NOFS
, 
NULL
);

888 i‡(
îr
)

889 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

891 
	`WARN_ON_ONCE
(

892 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
) < 0);

899 i‡(
upd©e_èû
)

900 
	`jbd3_upd©e_log_èû
(
jou∫Æ
, 
fú°_tid
, 
fú°_block
);

907 
	`jbd_debug
(3, "JBD3: commitÖhase 6\n");

909 
	`J_ASSERT
(
	`li°_em±y
(&
commô_å™ß˘i⁄
->
t_öode_li°
));

910 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_buf„rs
 =
NULL
);

911 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
);

912 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

914 
ª°¨t_lo›
:

919 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

920 
commô_å™ß˘i⁄
->
t_f‹gë
) {

921 
å™ß˘i⁄_t
 *
˝_å™ß˘i⁄
;

922 
buf„r_hód
 *
bh
;

923 
åy_to_‰ì
 = 0;

924 
boﬁ
 
dr›_ªf
;

926 
jh
 = 
commô_å™ß˘i⁄
->
t_f‹gë
;

927 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

928 
bh
 = 
	`jh2bh
(
jh
);

933 
	`gë_bh
(
bh
);

934 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

935 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
commô_å™ß˘i⁄
);

950 i‡(
jh
->
b_commôãd_d©a
) {

951 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
bh
->
b_size
);

952 
jh
->
b_commôãd_d©a
 = 
NULL
;

953 i‡(
jh
->
b_‰ozí_d©a
) {

954 
jh
->
b_commôãd_d©a
 = jh->
b_‰ozí_d©a
;

955 
jh
->
b_‰ozí_d©a
 = 
NULL
;

956 
jh
->
b_‰ozí_åiggîs
 = 
NULL
;

958 } i‡(
jh
->
b_‰ozí_d©a
) {

959 
	`jbd3_‰ì
(
jh
->
b_‰ozí_d©a
, 
bh
->
b_size
);

960 
jh
->
b_‰ozí_d©a
 = 
NULL
;

961 
jh
->
b_‰ozí_åiggîs
 = 
NULL
;

964 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

965 
˝_å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

966 i‡(
˝_å™ß˘i⁄
) {

967 
	`JBUFFER_TRACE
(
jh
, "remove from old cpÅransaction");

968 
˝_å™ß˘i⁄
->
t_chp_°©s
.
cs_dr›≥d
++;

969 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

987 i‡(
	`buf„r_‰ìd
(
bh
Ë&& !
jh
->
b_√xt_å™ß˘i⁄
) {

988 
addªss_•a˚
 *
m≠pög
;

990 
	`˛ór_buf„r_‰ìd
(
bh
);

991 
	`˛ór_buf„r_jbddúty
(
bh
);

1004 
m≠pög
 = 
	`READ_ONCE
(
bh
->
b_∑ge
->mapping);

1005 i‡(
m≠pög
 && !
	`sb_is_blkdev_sb
(m≠pög->
ho°
->
i_sb
)) {

1006 
	`˛ór_buf„r_m≠≥d
(
bh
);

1007 
	`˛ór_buf„r_√w
(
bh
);

1008 
	`˛ór_buf„r_ªq
(
bh
);

1009 
bh
->
b_bdev
 = 
NULL
;

1013 i‡(
	`buf„r_jbddúty
(
bh
)) {

1014 
	`JBUFFER_TRACE
(
jh
, "addÅoÇew checkpointingÅrans");

1015 
	`__jbd3_jou∫Æ_ö£π_checkpoöt
(
jh
, 
commô_å™ß˘i⁄
);

1016 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

1017 
	`˛ór_buf„r_jbddúty
(
bh
);

1019 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_dúty
(bh));

1029 i‡(!
jh
->
b_√xt_å™ß˘i⁄
)

1030 
åy_to_‰ì
 = 1;

1032 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1033 
dr›_ªf
 = 
	`__jbd3_jou∫Æ_ªfûe_buf„r
(
jh
);

1034 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1035 i‡(
dr›_ªf
)

1036 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1037 i‡(
åy_to_‰ì
)

1038 
	`ªÀa£_buf„r_∑ge
(
bh
);

1040 
	`__bªl£
(
bh
);

1041 
	`c⁄d_ªsched_lock
(&
jou∫Æ
->
j_li°_lock
);

1043 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1050 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1051 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1056 i‡(
commô_å™ß˘i⁄
->
t_f‹gë
) {

1057 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1058 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1059 
ª°¨t_lo›
;

1065 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
NULL
) {

1066 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 = 
commô_å™ß˘i⁄
;

1067 
commô_å™ß˘i⁄
->
t_˝√xt
 = commit_transaction;

1068 
commô_å™ß˘i⁄
->
t_˝¥ev
 = commit_transaction;

1070 
commô_å™ß˘i⁄
->
t_˝√xt
 =

1071 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

1072 
commô_å™ß˘i⁄
->
t_˝¥ev
 =

1073 
commô_å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
;

1074 
commô_å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
 =

1075 
commô_å™ß˘i⁄
;

1076 
commô_å™ß˘i⁄
->
t_˝¥ev
->
t_˝√xt
 =

1077 
commô_å™ß˘i⁄
;

1079 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1083 
	`jbd_debug
(3, "JBD3: commitÖhase 7\n");

1085 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT_JFLUSH
);

1087 
commô_å™ß˘i⁄
->
t_°¨t
 = 
jiffõs
;

1088 
°©s
.
run
.
rs_loggög
 = 
	`jbd3_time_diff
(stats.run.rs_logging,

1089 
commô_å™ß˘i⁄
->
t_°¨t
);

1094 
°©s
.
ts_tid
 = 
commô_å™ß˘i⁄
->
t_tid
;

1095 
°©s
.
run
.
rs_h™dÀ_cou¡
 =

1096 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_h™dÀ_cou¡
);

1097 
	`åa˚_jbd3_run_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

1098 
commô_å™ß˘i⁄
->
t_tid
, &
°©s
.
run
);

1099 
°©s
.
ts_ªque°ed
 = (
commô_å™ß˘i⁄
->
t_ªque°ed
) ? 1 : 0;

1101 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_CALLBACK
;

1102 
	`J_ASSERT
(
commô_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

1103 
jou∫Æ
->
j_commô_£quí˚
 = 
commô_å™ß˘i⁄
->
t_tid
;

1104 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 = 
NULL
;

1105 
commô_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1111 i‡(
	`likñy
(
jou∫Æ
->
j_avîage_commô_time
))

1112 
jou∫Æ
->
j_avîage_commô_time
 = (
commô_time
 +

1113 
jou∫Æ
->
j_avîage_commô_time
*3) / 4;

1115 
jou∫Æ
->
j_avîage_commô_time
 = 
commô_time
;

1117 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1119 i‡(
jou∫Æ
->
j_commô_ˇŒback
)

1120 
jou∫Æ
->
	`j_commô_ˇŒback
(jou∫Æ, 
commô_å™ß˘i⁄
);

1122 
	`åa˚_jbd3_íd_commô
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

1123 
	`jbd_debug
(1, "JBD3: commit %d complete, head %d\n",

1124 
jou∫Æ
->
j_commô_£quí˚
, jou∫Æ->
j_èû_£quí˚
);

1126 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1127 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1128 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_FINISHED
;

1130 i‡(
commô_å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
 &&

1131 
commô_å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
NULL
) {

1132 
	`__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

1133 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
commô_å™ß˘i⁄
);

1135 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1136 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1137 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

1142 
	`•ö_lock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1143 
jou∫Æ
->
j_°©s
.
ts_tid
++;

1144 
jou∫Æ
->
j_°©s
.
ts_ªque°ed
 +
°©s
.ts_requested;

1145 
jou∫Æ
->
j_°©s
.
run
.
rs_waô
 +
°©s
.run.rs_wait;

1146 
jou∫Æ
->
j_°©s
.
run
.
rs_ªque°_dñay
 +
°©s
.run.rs_request_delay;

1147 
jou∫Æ
->
j_°©s
.
run
.
rs_ru¬ög
 +
°©s
.run.rs_running;

1148 
jou∫Æ
->
j_°©s
.
run
.
rs_locked
 +
°©s
.run.rs_locked;

1149 
jou∫Æ
->
j_°©s
.
run
.
rs_Êushög
 +
°©s
.run.rs_flushing;

1150 
jou∫Æ
->
j_°©s
.
run
.
rs_loggög
 +
°©s
.run.rs_logging;

1151 
jou∫Æ
->
j_°©s
.
run
.
rs_h™dÀ_cou¡
 +
°©s
.run.rs_handle_count;

1152 
jou∫Æ
->
j_°©s
.
run
.
rs_blocks
 +
°©s
.run.rs_blocks;

1153 
jou∫Æ
->
j_°©s
.
run
.
rs_blocks_logged
 +
°©s
.run.rs_blocks_logged;

1154 
	`•ö_u∆ock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1155 
	}
}

	@jbd3/journal.c

22 
	~<löux/moduÀ.h
>

23 
	~<löux/time.h
>

24 
	~<löux/fs.h
>

25 
	~<löux/jbd3.h
>

26 
	~<löux/î∫o.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/‰ìzî.h
>

31 
	~<löux/∑gem≠.h
>

32 
	~<löux/kthªad.h
>

33 
	~<löux/pois⁄.h
>

34 
	~<löux/¥oc_fs.h
>

35 
	~<löux/£q_fûe.h
>

36 
	~<löux/m©h64.h
>

37 
	~<löux/hash.h
>

38 
	~<löux/log2.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/backög-dev.h
>

41 
	~<löux/bô›s.h
>

42 
	~<löux/øãlimô.h
>

43 
	~<löux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<åa˚/evíts/jbd3.h
>

48 
	~<löux/uac˚ss.h
>

49 
	~<asm/∑ge.h
>

51 #ifde‡
CONFIG_JBD3_DEBUG


52 
ush‹t
 
jbd3_jou∫Æ_íabÀ_debug
 
	g__ªad_mo°ly
;

53 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_íabÀ_debug
);

55 
moduÀ_∑øm_«med
(
jbd3_debug
, 
jbd3_jou∫Æ_íabÀ_debug
, 
ush‹t
, 0644);

56 
MODULE_PARM_DESC
(
jbd3_debug
, "DebuggingÜevel for jbd3");

59 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_exãnd
);

60 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°›
);

61 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_u∆ock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_wrôe_ac˚ss
);

64 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_¸óã_ac˚ss
);

65 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_undo_ac˚ss
);

66 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_£t_åiggîs
);

67 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_dúty_mëad©a
);

68 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹gë
);

69 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_Êush
);

70 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ªvoke
);

72 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_dev
);

73 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_öode
);

74 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_check_u£d_„©uªs
);

75 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs
);

76 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_£t_„©uªs
);

77 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_lﬂd
);

78 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_de°roy
);

79 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ab‹t
);

80 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_î∫o
);

81 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ack_îr
);

82 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_˛ór_îr
);

83 
EXPORT_SYMBOL
(
jbd3_log_waô_commô
);

84 
EXPORT_SYMBOL
(
jbd3_log_°¨t_commô
);

85 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t_commô
);

86 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹˚_commô_√°ed
);

87 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_wùe
);

88 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_blocks_≥r_∑ge
);

89 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_övÆid©ïage
);

90 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_åy_to_‰ì_buf„rs
);

91 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹˚_commô
);

92 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öode_ønged_wrôe
);

93 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öode_ønged_waô
);

94 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_jbd_öode
);

95 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ªÀa£_jbd_öode
);

96 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_begö_‹dîed_åunˇã
);

97 
EXPORT_SYMBOL
(
jbd3_öode_ˇche
);

99 
__jou∫Æ_ab‹t_so·
 (
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
);

100 
jbd3_jou∫Æ_¸óã_¶ab
(
size_t
 
¶ab_size
);

102 #ifde‡
CONFIG_JBD3_DEBUG


103 
	$__jbd3_debug
(
Àvñ
, c⁄° *
fûe
, c⁄° *
func
,

104 
löe
, c⁄° *
fmt
, ...)

106 
va_f‹m©
 
vaf
;

107 
va_li°
 
¨gs
;

109 i‡(
Àvñ
 > 
jbd3_jou∫Æ_íabÀ_debug
)

111 
	`va_°¨t
(
¨gs
, 
fmt
);

112 
vaf
.
fmt
 = fmt;

113 
vaf
.
va
 = &
¨gs
;

114 
	`¥ötk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fûe
, 
func
, 
löe
, &
vaf
);

115 
	`va_íd
(
¨gs
);

116 
	}
}

117 
EXPORT_SYMBOL
(
__jbd3_debug
);

121 
	$jbd3_vîify_csum_ty≥
(
jou∫Æ_t
 *
j
, 
jou∫Æ_su≥rblock_t
 *
sb
)

123 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
j
))

126  
sb
->
s_checksum_ty≥
 =
JBD3_CRC32C_CHKSUM
;

127 
	}
}

129 
__be32
 
	$jbd3_su≥rblock_csum
(
jou∫Æ_t
 *
j
, 
jou∫Æ_su≥rblock_t
 *
sb
)

131 
__u32
 
csum
;

132 
__be32
 
ﬁd_csum
;

134 
ﬁd_csum
 = 
sb
->
s_checksum
;

135 
sb
->
s_checksum
 = 0;

136 
csum
 = 
	`jbd3_chksum
(
j
, ~0, (*)
sb
, (
jou∫Æ_su≥rblock_t
));

137 
sb
->
s_checksum
 = 
ﬁd_csum
;

139  
	`˝u_to_be32
(
csum
);

140 
	}
}

146 
	$commô_timeout
(
timî_li°
 *
t
)

148 
jou∫Æ_t
 *
jou∫Æ
 = 
	`‰om_timî
(jou∫Æ, 
t
, 
j_commô_timî
);

150 
	`wake_up_¥o˚ss
(
jou∫Æ
->
j_èsk
);

151 
	}
}

169 
	$kjou∫Æd2
(*
¨g
)

171 
jou∫Æ_t
 *
jou∫Æ
 = 
¨g
;

172 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

178 
	`timî_£tup
(&
jou∫Æ
->
j_commô_timî
, 
commô_timeout
, 0);

180 
	`£t_‰ìzabÀ
();

183 
jou∫Æ
->
j_èsk
 = 
cuºít
;

184 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

192 
	`memÆloc_nofs_ßve
();

197 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

199 
lo›
:

200 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
)

201 
íd_lo›
;

203 
	`jbd_debug
(1, "commit_sequence=%u, commit_request=%u\n",

204 
jou∫Æ
->
j_commô_£quí˚
, jou∫Æ->
j_commô_ªque°
);

206 i‡(
jou∫Æ
->
j_commô_£quí˚
 !jou∫Æ->
j_commô_ªque°
) {

207 
	`jbd_debug
(1, "OK,Ñequests differ\n");

208 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

209 
	`dñ_timî_sync
(&
jou∫Æ
->
j_commô_timî
);

210 
	`jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ
);

211 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

212 
lo›
;

215 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

216 i‡(
	`‰ìzög
(
cuºít
)) {

222 
	`jbd_debug
(1, "Now suspending kjournald2\n");

223 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

224 
	`åy_to_‰ìze
();

225 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

231 
	`DEFINE_WAIT
(
waô
);

232 
should_¶ìp
 = 1;

234 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_commô
, &
waô
,

235 
TASK_INTERRUPTIBLE
);

236 i‡(
jou∫Æ
->
j_commô_£quí˚
 !jou∫Æ->
j_commô_ªque°
)

237 
should_¶ìp
 = 0;

238 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

239 i‡(
å™ß˘i⁄
 && 
	`time_a·î_eq
(
jiffõs
,

240 
å™ß˘i⁄
->
t_expúes
))

241 
should_¶ìp
 = 0;

242 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
)

243 
should_¶ìp
 = 0;

244 i‡(
should_¶ìp
) {

245 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

246 
	`scheduÀ
();

247 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

249 
	`föish_waô
(&
jou∫Æ
->
j_waô_commô
, &
waô
);

252 
	`jbd_debug
(1, "kjournald2 wakes\n");

257 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

258 i‡(
å™ß˘i⁄
 && 
	`time_a·î_eq
(
jiffõs
,Åønß˘i⁄->
t_expúes
)) {

259 
jou∫Æ
->
j_commô_ªque°
 = 
å™ß˘i⁄
->
t_tid
;

260 
	`jbd_debug
(1, "woke because ofÅimeout\n");

262 
lo›
;

264 
íd_lo›
:

265 
	`dñ_timî_sync
(&
jou∫Æ
->
j_commô_timî
);

266 
jou∫Æ
->
j_èsk
 = 
NULL
;

267 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

268 
	`jbd_debug
(1, "JournalÅhreadÉxiting.\n");

269 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

271 
	}
}

273 
	$jbd3_jou∫Æ_°¨t_thªad
(
jou∫Æ_t
 *
jou∫Æ
)

275 
èsk_°ru˘
 *
t
;

277 
t
 = 
	`kthªad_run
(
kjou∫Æd2
, 
jou∫Æ
, "jbd3/%s",

278 
jou∫Æ
->
j_dev«me
);

279 i‡(
	`IS_ERR
(
t
))

280  
	`PTR_ERR
(
t
);

282 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
, jou∫Æ->
j_èsk
 !
NULL
);

284 
	}
}

286 
	$jou∫Æ_kûl_thªad
(
jou∫Æ_t
 *
jou∫Æ
)

288 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

289 
jou∫Æ
->
j_Êags
 |
JBD3_UNMOUNT
;

291 
jou∫Æ
->
j_èsk
) {

292 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

293 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

294 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
, jou∫Æ->
j_èsk
 =
NULL
);

295 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

297 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

298 
	}
}

335 
	$jbd3_jou∫Æ_wrôe_mëad©a_buf„r
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

336 
jou∫Æ_hód
 *
jh_ö
,

337 
buf„r_hód
 **
bh_out
,

338 
£˘‹_t
 
blockƒ
)

340 
√ed_c›y_out
 = 0;

341 
d⁄e_c›y_out
 = 0;

342 
do_esˇ≥
 = 0;

343 *
m≠≥d_d©a
;

344 
buf„r_hód
 *
√w_bh
;

345 
∑ge
 *
√w_∑ge
;

346 
√w_off£t
;

347 
buf„r_hód
 *
bh_ö
 = 
	`jh2bh
(
jh_ö
);

348 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

359 
	`J_ASSERT_BH
(
bh_ö
, 
	`buf„r_jbddúty
(bh_in));

361 
√w_bh
 = 
	`Æloc_buf„r_hód
(
GFP_NOFS
|
__GFP_NOFAIL
);

364 
	`©omic_£t
(&
√w_bh
->
b_cou¡
, 1);

366 
	`•ö_lock
(&
jh_ö
->
b_°©e_lock
);

367 
ª≥©
:

372 i‡(
jh_ö
->
b_‰ozí_d©a
) {

373 
d⁄e_c›y_out
 = 1;

374 
√w_∑ge
 = 
	`vút_to_∑ge
(
jh_ö
->
b_‰ozí_d©a
);

375 
√w_off£t
 = 
	`off£t_ö_∑ge
(
jh_ö
->
b_‰ozí_d©a
);

377 
√w_∑ge
 = 
	`jh2bh
(
jh_ö
)->
b_∑ge
;

378 
√w_off£t
 = 
	`off£t_ö_∑ge
(
	`jh2bh
(
jh_ö
)->
b_d©a
);

381 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

388 i‡(!
d⁄e_c›y_out
)

389 
	`jbd3_buf„r_‰ozí_åiggî
(
jh_ö
, 
m≠≥d_d©a
 + 
√w_off£t
,

390 
jh_ö
->
b_åiggîs
);

395 i‡(*((
__be32
 *)(
m≠≥d_d©a
 + 
√w_off£t
)) ==

396 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
)) {

397 
√ed_c›y_out
 = 1;

398 
do_esˇ≥
 = 1;

400 
	`kunm≠_©omic
(
m≠≥d_d©a
);

405 i‡(
√ed_c›y_out
 && !
d⁄e_c›y_out
) {

406 *
tmp
;

408 
	`•ö_u∆ock
(&
jh_ö
->
b_°©e_lock
);

409 
tmp
 = 
	`jbd3_Æloc
(
bh_ö
->
b_size
, 
GFP_NOFS
);

410 i‡(!
tmp
) {

411 
	`bªl£
(
√w_bh
);

412  -
ENOMEM
;

414 
	`•ö_lock
(&
jh_ö
->
b_°©e_lock
);

415 i‡(
jh_ö
->
b_‰ozí_d©a
) {

416 
	`jbd3_‰ì
(
tmp
, 
bh_ö
->
b_size
);

417 
ª≥©
;

420 
jh_ö
->
b_‰ozí_d©a
 = 
tmp
;

421 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

422 
	`mem˝y
(
tmp
, 
m≠≥d_d©a
 + 
√w_off£t
, 
bh_ö
->
b_size
);

423 
	`kunm≠_©omic
(
m≠≥d_d©a
);

425 
√w_∑ge
 = 
	`vút_to_∑ge
(
tmp
);

426 
√w_off£t
 = 
	`off£t_ö_∑ge
(
tmp
);

427 
d⁄e_c›y_out
 = 1;

434 
jh_ö
->
b_‰ozí_åiggîs
 = jh_ö->
b_åiggîs
;

441 i‡(
do_esˇ≥
) {

442 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

443 *((*)(
m≠≥d_d©a
 + 
√w_off£t
)) = 0;

444 
	`kunm≠_©omic
(
m≠≥d_d©a
);

447 
	`£t_bh_∑ge
(
√w_bh
, 
√w_∑ge
, 
√w_off£t
);

448 
√w_bh
->
b_size
 = 
bh_ö
->b_size;

449 
√w_bh
->
b_bdev
 = 
jou∫Æ
->
j_dev
;

450 
√w_bh
->
b_blockƒ
 = 
blockƒ
;

451 
√w_bh
->
b_¥iv©e
 = 
bh_ö
;

452 
	`£t_buf„r_m≠≥d
(
√w_bh
);

453 
	`£t_buf„r_dúty
(
√w_bh
);

455 *
bh_out
 = 
√w_bh
;

462 
	`JBUFFER_TRACE
(
jh_ö
, "fileás BJ_Shadow");

463 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

464 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh_ö
, 
å™ß˘i⁄
, 
BJ_Shadow
);

465 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

466 
	`£t_buf„r_shadow
(
bh_ö
);

467 
	`•ö_u∆ock
(&
jh_ö
->
b_°©e_lock
);

469  
do_esˇ≥
 | (
d⁄e_c›y_out
 << 1);

470 
	}
}

481 
	$__jbd3_log_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
èrgë
)

484 i‡(
jou∫Æ
->
j_commô_ªque°
 =
èrgë
)

492 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

493 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
èrgë
) {

499 
jou∫Æ
->
j_commô_ªque°
 = 
èrgë
;

500 
	`jbd_debug
(1, "JBD3:Ñequesting commit %u/%u\n",

501 
jou∫Æ
->
j_commô_ªque°
,

502 
jou∫Æ
->
j_commô_£quí˚
);

503 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_ªque°ed
 = 
jiffõs
;

504 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

506 } i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
èrgë
))

510 
	`WARN_ONCE
(1, "JBD3: badÜog_start_commit: %u %u %u %u\n",

511 
jou∫Æ
->
j_commô_ªque°
,

512 
jou∫Æ
->
j_commô_£quí˚
,

513 
èrgë
, 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ?

514 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 : 0);

516 
	}
}

518 
	$jbd3_log_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

520 
ªt
;

522 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

523 
ªt
 = 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

524 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

525  
ªt
;

526 
	}
}

535 
	$__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

537 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
NULL
;

538 
tid_t
 
tid
;

539 
√ed_to_°¨t
 = 0, 
ªt
 = 0;

541 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

542 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 && !
cuºít
->
jou∫Æ_öfo
) {

543 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

544 i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
å™ß˘i⁄
->
t_tid
))

545 
√ed_to_°¨t
 = 1;

546 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

547 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

549 i‡(!
å™ß˘i⁄
) {

551 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

554 
tid
 = 
å™ß˘i⁄
->
t_tid
;

555 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

556 i‡(
√ed_to_°¨t
)

557 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

558 
ªt
 = 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

559 i‡(!
ªt
)

560 
ªt
 = 1;

562  
ªt
;

563 
	}
}

573 
	$jbd3_jou∫Æ_f‹˚_commô_√°ed
(
jou∫Æ_t
 *
jou∫Æ
)

575 
ªt
;

577 
ªt
 = 
	`__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

578  
ªt
 > 0;

579 
	}
}

588 
	$jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

590 
ªt
;

592 
	`J_ASSERT
(!
cuºít
->
jou∫Æ_öfo
);

593 
ªt
 = 
	`__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

594 i‡(
ªt
 > 0)

595 
ªt
 = 0;

596  
ªt
;

597 
	}
}

604 
	$jbd3_jou∫Æ_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 *
±id
)

606 
ªt
 = 0;

608 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

609 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

610 
tid_t
 
tid
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
;

612 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

615 i‡(
±id
)

616 *
±id
 = 
tid
;

617 
ªt
 = 1;

618 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

623 i‡(
±id
)

624 *
±id
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

625 
ªt
 = 1;

627 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

628  
ªt
;

629 
	}
}

637 
	$jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

639 
ªt
 = 0;

640 
å™ß˘i⁄_t
 *
commô_å™s
;

642 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

644 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

646 i‡(
	`tid_geq
(
jou∫Æ
->
j_commô_£quí˚
, 
tid
))

647 
out
;

648 
commô_å™s
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

649 i‡(!
commô_å™s
 || commô_å™s->
t_tid
 !
tid
) {

650 
ªt
 = 1;

651 
out
;

657 i‡(
jou∫Æ
->
j_fs_dev
 !jou∫Æ->
j_dev
) {

658 i‡(!
commô_å™s
->
t_√ed_d©a_Êush
 ||

659 
commô_å™s
->
t_°©e
 >
T_COMMIT_DFLUSH
)

660 
out
;

662 i‡(
commô_å™s
->
t_°©e
 >
T_COMMIT_JFLUSH
)

663 
out
;

665 
ªt
 = 1;

666 
out
:

667 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

668  
ªt
;

669 
	}
}

670 
EXPORT_SYMBOL
(
jbd3_å™s_wûl_£nd_d©a_b¨rõr
);

676 
	$jbd3_log_waô_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

678 
îr
 = 0;

680 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

681 #ifde‡
CONFIG_PROVE_LOCKING


687 i‡(
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
) &&

688 (!
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 ||

689 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 !
tid
)) {

690 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

691 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

692 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

695 #ifde‡
CONFIG_JBD3_DEBUG


696 i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
)) {

697 
	`¥ötk
(
KERN_ERR


699 
__func__
, 
jou∫Æ
->
j_commô_ªque°
, 
tid
);

702 
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
)) {

703 
	`jbd_debug
(1, "JBD3: want %u, j_commit_sequence=%u\n",

704 
tid
, 
jou∫Æ
->
j_commô_£quí˚
);

705 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

706 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

707 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
,

708 !
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
));

709 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

711 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

713 i‡(
	`u∆ikñy
(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)))

714 
îr
 = -
EIO
;

715  
îr
;

716 
	}
}

719 
	$jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

721 
ªt
 = 1;

723 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

724 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

725 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
tid
)

726 
ªt
 = 0;

727 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

728 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 =
tid
)

729 
ªt
 = 0;

730 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

731  
ªt
;

732 
	}
}

733 
EXPORT_SYMBOL
(
jbd3_å™ß˘i⁄_commôãd
);

742 
	$jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

744 
√ed_to_waô
 = 1;

746 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

747 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

748 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
tid
) {

749 i‡(
jou∫Æ
->
j_commô_ªque°
 !
tid
) {

751 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

752 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

753 
waô_commô
;

755 } i‡(!(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

756 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 =
tid
))

757 
√ed_to_waô
 = 0;

758 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

759 i‡(!
√ed_to_waô
)

761 
waô_commô
:

762  
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

763 
	}
}

764 
EXPORT_SYMBOL
(
jbd3_com∂ëe_å™ß˘i⁄
);

770 
	$jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ_t
 *
jou∫Æ
, *
ªç
)

772 
blockƒ
;

774 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

775 
	`J_ASSERT
(
jou∫Æ
->
j_‰ì
 > 1);

777 
blockƒ
 = 
jou∫Æ
->
j_hód
;

778 
jou∫Æ
->
j_hód
++;

779 
jou∫Æ
->
j_‰ì
--;

780 i‡(
jou∫Æ
->
j_hód
 =jou∫Æ->
j_œ°
)

781 
jou∫Æ
->
j_hód
 = jou∫Æ->
j_fú°
;

782 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

783  
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
blockƒ
, 
ªç
);

784 
	}
}

793 
	$jbd3_jou∫Æ_bm≠
(
jou∫Æ_t
 *
jou∫Æ
, 
blockƒ
,

794 *
ªç
)

796 
îr
 = 0;

797 
ªt
;

799 i‡(
jou∫Æ
->
j_öode
) {

800 
ªt
 = 
	`bm≠
(
jou∫Æ
->
j_öode
, 
blockƒ
);

801 i‡(
ªt
)

802 *
ªç
 = 
ªt
;

804 
	`¥ötk
(
KERN_ALERT
 "%s: journal blockÇot found "

806 
__func__
, 
blockƒ
, 
jou∫Æ
->
j_dev«me
);

807 
îr
 = -
EIO
;

808 
	`__jou∫Æ_ab‹t_so·
(
jou∫Æ
, 
îr
);

811 *
ªç
 = 
blockƒ
;

813  
îr
;

814 
	}
}

826 
buf„r_hód
 *

827 
	$jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
ty≥
)

829 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

830 
buf„r_hód
 *
bh
;

831 
blockƒ
;

832 
jou∫Æ_hódî_t
 *
hódî
;

833 
îr
;

835 
îr
 = 
	`jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ
, &
blockƒ
);

837 i‡(
îr
)

838  
NULL
;

840 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

841 i‡(!
bh
)

842  
NULL
;

843 
	`©omic_dec
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

844 
	`lock_buf„r
(
bh
);

845 
	`mem£t
(
bh
->
b_d©a
, 0, 
jou∫Æ
->
j_blocksize
);

846 
hódî
 = (
jou∫Æ_hódî_t
 *)
bh
->
b_d©a
;

847 
hódî
->
h_magic
 = 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
);

848 
hódî
->
h_blockty≥
 = 
	`˝u_to_be32
(
ty≥
);

849 
hódî
->
h_£quí˚
 = 
	`˝u_to_be32
(
å™ß˘i⁄
->
t_tid
);

850 
	`£t_buf„r_u±od©e
(
bh
);

851 
	`u∆ock_buf„r
(
bh
);

852 
	`BUFFER_TRACE
(
bh
, "returnÅhis buffer");

853  
bh
;

854 
	}
}

856 
	$jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ_t
 *
j
, 
buf„r_hód
 *
bh
)

858 
jbd3_jou∫Æ_block_èû
 *
èû
;

859 
__u32
 
csum
;

861 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

864 
èû
 = (
jbd3_jou∫Æ_block_èû
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

865 (
jbd3_jou∫Æ_block_èû
));

866 
èû
->
t_checksum
 = 0;

867 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

868 
èû
->
t_checksum
 = 
	`˝u_to_be32
(
csum
);

869 
	}
}

881 
	$jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 *
tid
,

882 *
block
)

884 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

885 
ªt
;

887 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

888 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

889 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

890 i‡(
å™ß˘i⁄
) {

891 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

892 *
block
 = 
å™ß˘i⁄
->
t_log_°¨t
;

893 } i‡((
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
Ë!
NULL
) {

894 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

895 *
block
 = 
å™ß˘i⁄
->
t_log_°¨t
;

896 } i‡((
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
Ë!
NULL
) {

897 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

898 *
block
 = 
jou∫Æ
->
j_hód
;

900 *
tid
 = 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

901 *
block
 = 
jou∫Æ
->
j_hód
;

903 
ªt
 = 
	`tid_gt
(*
tid
, 
jou∫Æ
->
j_èû_£quí˚
);

904 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

905 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

907  
ªt
;

908 
	}
}

920 
	$__jbd3_upd©e_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
, 
block
)

922 
‰ìd
;

923 
ªt
;

925 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

933 
ªt
 = 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
, 
tid
, 
block
,

934 
REQ_SYNC
 | 
REQ_FUA
);

935 i‡(
ªt
)

936 
out
;

938 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

939 
‰ìd
 = 
block
 - 
jou∫Æ
->
j_èû
;

940 i‡(
block
 < 
jou∫Æ
->
j_èû
)

941 
‰ìd
 +
jou∫Æ
->
j_œ°
 - jou∫Æ->
j_fú°
;

943 
	`åa˚_jbd3_upd©e_log_èû
(
jou∫Æ
, 
tid
, 
block
, 
‰ìd
);

944 
	`jbd_debug
(1,

947 
jou∫Æ
->
j_èû_£quí˚
, 
tid
, 
block
, 
‰ìd
);

949 
jou∫Æ
->
j_‰ì
 +
‰ìd
;

950 
jou∫Æ
->
j_èû_£quí˚
 = 
tid
;

951 
jou∫Æ
->
j_èû
 = 
block
;

952 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

954 
out
:

955  
ªt
;

956 
	}
}

963 
	$jbd3_upd©e_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
, 
block
)

965 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

966 i‡(
	`tid_gt
(
tid
, 
jou∫Æ
->
j_èû_£quí˚
))

967 
	`__jbd3_upd©e_log_èû
(
jou∫Æ
, 
tid
, 
block
);

968 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

969 
	}
}

971 
	sjbd3_°©s_¥oc_£ssi⁄
 {

972 
jou∫Æ_t
 *
	mjou∫Æ
;

973 
å™ß˘i⁄_°©s_s
 *
	m°©s
;

974 
	m°¨t
;

975 
	mmax
;

978 *
	$jbd3_£q_öfo_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

980  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

981 
	}
}

983 *
	$jbd3_£q_öfo_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

985 (*
pos
)++;

986  
NULL
;

987 
	}
}

989 
	$jbd3_£q_öfo_show
(
£q_fûe
 *
£q
, *
v
)

991 
jbd3_°©s_¥oc_£ssi⁄
 *
s
 = 
£q
->
¥iv©e
;

993 i‡(
v
 !
SEQ_START_TOKEN
)

995 
	`£q_¥ötf
(
£q
, "%luÅransactions (%luÑequested), "

997 
s
->
°©s
->
ts_tid
, s->°©s->
ts_ªque°ed
,

998 
s
->
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

999 i‡(
s
->
°©s
->
ts_tid
 == 0)

1001 
	`£q_¥ötf
(
£q
, "average: \n %ums waiting forÅransaction\n",

1002 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_waô
 / s->°©s->
ts_tid
));

1003 
	`£q_¥ötf
(
£q
, " %umsÑequest delay\n",

1004 (
s
->
°©s
->
ts_ªque°ed
 == 0) ? 0 :

1005 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_ªque°_dñay
 /

1006 
s
->
°©s
->
ts_ªque°ed
));

1007 
	`£q_¥ötf
(
£q
, " %umsÑunningÅransaction\n",

1008 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_ru¬ög
 / s->°©s->
ts_tid
));

1009 
	`£q_¥ötf
(
£q
, " %umsÅransaction was beingÜocked\n",

1010 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_locked
 / s->°©s->
ts_tid
));

1011 
	`£q_¥ötf
(
£q
, " %ums flushing data (in ordered mode)\n",

1012 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_Êushög
 / s->°©s->
ts_tid
));

1013 
	`£q_¥ötf
(
£q
, " %umsÜoggingÅransaction\n",

1014 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_loggög
 / s->°©s->
ts_tid
));

1015 
	`£q_¥ötf
(
£q
, " %lluusáverageÅransaction commitÅime\n",

1016 
	`div_u64
(
s
->
jou∫Æ
->
j_avîage_commô_time
, 1000));

1017 
	`£q_¥ötf
(
£q
, " %lu handlesÖerÅransaction\n",

1018 
s
->
°©s
->
run
.
rs_h™dÀ_cou¡
 / s->°©s->
ts_tid
);

1019 
	`£q_¥ötf
(
£q
, " %lu blocksÖerÅransaction\n",

1020 
s
->
°©s
->
run
.
rs_blocks
 / s->°©s->
ts_tid
);

1021 
	`£q_¥ötf
(
£q
, " %luÜogged blocksÖerÅransaction\n",

1022 
s
->
°©s
->
run
.
rs_blocks_logged
 / s->°©s->
ts_tid
);

1024 
	}
}

1026 
	$jbd3_£q_öfo_°›
(
£q_fûe
 *
£q
, *
v
)

1028 
	}
}

1030 c⁄° 
£q_›î©i⁄s
 
	gjbd3_£q_öfo_›s
 = {

1031 .
°¨t
 = 
jbd3_£q_öfo_°¨t
,

1032 .
	g√xt
 = 
jbd3_£q_öfo_√xt
,

1033 .
	g°›
 = 
jbd3_£q_öfo_°›
,

1034 .
	gshow
 = 
jbd3_£q_öfo_show
,

1037 
	$jbd3_£q_öfo_›í
(
öode
 *öode, 
fûe
 *file)

1039 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PDE_DATA
(
öode
);

1040 
jbd3_°©s_¥oc_£ssi⁄
 *
s
;

1041 
rc
, 
size
;

1043 
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

1044 i‡(
s
 =
NULL
)

1045  -
ENOMEM
;

1046 
size
 = (
å™ß˘i⁄_°©s_s
);

1047 
s
->
°©s
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

1048 i‡(
s
->
°©s
 =
NULL
) {

1049 
	`k‰ì
(
s
);

1050  -
ENOMEM
;

1052 
	`•ö_lock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1053 
	`mem˝y
(
s
->
°©s
, &
jou∫Æ
->
j_°©s
, 
size
);

1054 
s
->
jou∫Æ
 = journal;

1055 
	`•ö_u∆ock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1057 
rc
 = 
	`£q_›í
(
fûe
, &
jbd3_£q_öfo_›s
);

1058 i‡(
rc
 == 0) {

1059 
£q_fûe
 *
m
 = 
fûe
->
¥iv©e_d©a
;

1060 
m
->
¥iv©e
 = 
s
;

1062 
	`k‰ì
(
s
->
°©s
);

1063 
	`k‰ì
(
s
);

1065  
rc
;

1067 
	}
}

1069 
	$jbd3_£q_öfo_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1071 
£q_fûe
 *
£q
 = 
fûe
->
¥iv©e_d©a
;

1072 
jbd3_°©s_¥oc_£ssi⁄
 *
s
 = 
£q
->
¥iv©e
;

1073 
	`k‰ì
(
s
->
°©s
);

1074 
	`k‰ì
(
s
);

1075  
	`£q_ªÀa£
(
öode
, 
fûe
);

1076 
	}
}

1078 c⁄° 
fûe_›î©i⁄s
 
	gjbd3_£q_öfo_f›s
 = {

1079 .
ow√r
 = 
THIS_MODULE
,

1080 .
	g›í
 = 
jbd3_£q_öfo_›í
,

1081 .
	gªad
 = 
£q_ªad
,

1082 .
	gŒ£ek
 = 
£q_l£ek
,

1083 .
	gªÀa£
 = 
jbd3_£q_öfo_ªÀa£
,

1086 
¥oc_dú_íåy
 *
	g¥oc_jbd3_°©s
;

1088 
	$jbd3_°©s_¥oc_öô
(
jou∫Æ_t
 *
jou∫Æ
)

1090 
jou∫Æ
->
j_¥oc_íåy
 = 
	`¥oc_mkdú
(jou∫Æ->
j_dev«me
, 
¥oc_jbd3_°©s
);

1091 i‡(
jou∫Æ
->
j_¥oc_íåy
) {

1092 
	`¥oc_¸óã_d©a
("öfo", 
S_IRUGO
, 
jou∫Æ
->
j_¥oc_íåy
,

1093 &
jbd3_£q_öfo_f›s
, 
jou∫Æ
);

1095 
	}
}

1097 
	$jbd3_°©s_¥oc_exô
(
jou∫Æ_t
 *
jou∫Æ
)

1099 
	`ªmove_¥oc_íåy
("öfo", 
jou∫Æ
->
j_¥oc_íåy
);

1100 
	`ªmove_¥oc_íåy
(
jou∫Æ
->
j_dev«me
, 
¥oc_jbd3_°©s
);

1101 
	}
}

1104 
	$jbd3_mö_èg_size
()

1110  (
jou∫Æ_block_èg_t
) - 4;

1111 
	}
}

1122 
jou∫Æ_t
 *
	$jou∫Æ_öô_comm⁄
(
block_devi˚
 *
bdev
,

1123 
block_devi˚
 *
fs_dev
,

1124 
°¨t
, 
Àn
, 
blocksize
)

1126 
lock_˛ass_key
 
jbd3_å™s_commô_key
;

1127 
jou∫Æ_t
 *
jou∫Æ
;

1128 
îr
;

1129 
buf„r_hód
 *
bh
;

1130 
n
;

1132 
jou∫Æ
 = 
	`kzÆloc
((*jou∫Æ), 
GFP_KERNEL
);

1133 i‡(!
jou∫Æ
)

1134  
NULL
;

1136 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

1137 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

1138 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_commô
);

1139 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_upd©es
);

1140 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_ª£rved
);

1141 
	`muãx_öô
(&
jou∫Æ
->
j_b¨rõr
);

1142 
	`muãx_öô
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1143 
	`•ö_lock_öô
(&
jou∫Æ
->
j_ªvoke_lock
);

1144 
	`•ö_lock_öô
(&
jou∫Æ
->
j_li°_lock
);

1145 
	`rwlock_öô
(&
jou∫Æ
->
j_°©e_lock
);

1147 
jou∫Æ
->
j_commô_öãrvÆ
 = (
HZ
 * 
JBD3_DEFAULT_MAX_COMMIT_AGE
);

1148 
jou∫Æ
->
j_mö_b©ch_time
 = 0;

1149 
jou∫Æ
->
j_max_b©ch_time
 = 15000;

1150 
	`©omic_£t
(&
jou∫Æ
->
j_ª£rved_¸edôs
, 0);

1153 
jou∫Æ
->
j_Êags
 = 
JBD3_ABORT
;

1156 
îr
 = 
	`jbd3_jou∫Æ_öô_ªvoke
(
jou∫Æ
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1157 i‡(
îr
)

1158 
îr_˛ónup
;

1160 
	`•ö_lock_öô
(&
jou∫Æ
->
j_hi°‹y_lock
);

1162 
	`lockdï_öô_m≠
(&
jou∫Æ
->
j_å™s_commô_m≠
, "jbd3_handle",

1163 &
jbd3_å™s_commô_key
, 0);

1166 
jou∫Æ
->
j_blocksize
 = 
blocksize
;

1167 
jou∫Æ
->
j_dev
 = 
bdev
;

1168 
jou∫Æ
->
j_fs_dev
 = 
fs_dev
;

1169 
jou∫Æ
->
j_blk_off£t
 = 
°¨t
;

1170 
jou∫Æ
->
j_maxÀn
 = 
Àn
;

1172 
n
 = 
jou∫Æ
->
j_blocksize
 / 
	`jbd3_mö_èg_size
();

1173 
jou∫Æ
->
j_wbufsize
 = 
n
;

1174 
jou∫Æ
->
j_wbuf
 = 
	`kmÆloc_¨øy
(
n
, (
buf„r_hód
 *),

1175 
GFP_KERNEL
);

1176 i‡(!
jou∫Æ
->
j_wbuf
)

1177 
îr_˛ónup
;

1179 
bh
 = 
	`gëblk_unmovabÀ
(
jou∫Æ
->
j_dev
, 
°¨t
, jou∫Æ->
j_blocksize
);

1180 i‡(!
bh
) {

1181 
	`¥_îr
("%s: Cannot get buffer for journal superblock\n",

1182 
__func__
);

1183 
îr_˛ónup
;

1185 
jou∫Æ
->
j_sb_buf„r
 = 
bh
;

1186 
jou∫Æ
->
j_su≥rblock
 = (
jou∫Æ_su≥rblock_t
 *)
bh
->
b_d©a
;

1188  
jou∫Æ
;

1190 
îr_˛ónup
:

1191 
	`k‰ì
(
jou∫Æ
->
j_wbuf
);

1192 
	`jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ
);

1193 
	`k‰ì
(
jou∫Æ
);

1194  
NULL
;

1195 
	}
}

1220 
jou∫Æ_t
 *
	$jbd3_jou∫Æ_öô_dev
(
block_devi˚
 *
bdev
,

1221 
block_devi˚
 *
fs_dev
,

1222 
°¨t
, 
Àn
, 
blocksize
)

1224 
jou∫Æ_t
 *
jou∫Æ
;

1226 
jou∫Æ
 = 
	`jou∫Æ_öô_comm⁄
(
bdev
, 
fs_dev
, 
°¨t
, 
Àn
, 
blocksize
);

1227 i‡(!
jou∫Æ
)

1228  
NULL
;

1230 
	`bdev«me
(
jou∫Æ
->
j_dev
, jou∫Æ->
j_dev«me
);

1231 
	`°ºïœ˚
(
jou∫Æ
->
j_dev«me
, '/', '!');

1232 
	`jbd3_°©s_¥oc_öô
(
jou∫Æ
);

1234  
jou∫Æ
;

1235 
	}
}

1245 
jou∫Æ_t
 *
	$jbd3_jou∫Æ_öô_öode
(
öode
 *inode)

1247 
jou∫Æ_t
 *
jou∫Æ
;

1248 *
p
;

1249 
blockƒ
;

1251 
blockƒ
 = 
	`bm≠
(
öode
, 0);

1252 i‡(!
blockƒ
) {

1253 
	`¥_îr
("%s: CannotÜocate journal superblock\n",

1254 
__func__
);

1255  
NULL
;

1258 
	`jbd_debug
(1, "JBD3: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1259 
öode
->
i_sb
->
s_id
, inode->
i_öo
, (Ëöode->
i_size
,

1260 
öode
->
i_sb
->
s_blocksize_bôs
, inode->i_sb->
s_blocksize
);

1262 
jou∫Æ
 = 
	`jou∫Æ_öô_comm⁄
(
öode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1263 
blockƒ
, 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
,

1264 
öode
->
i_sb
->
s_blocksize
);

1265 i‡(!
jou∫Æ
)

1266  
NULL
;

1268 
jou∫Æ
->
j_öode
 = 
öode
;

1269 
	`bdev«me
(
jou∫Æ
->
j_dev
, jou∫Æ->
j_dev«me
);

1270 
p
 = 
	`°ºïœ˚
(
jou∫Æ
->
j_dev«me
, '/', '!');

1271 
	`•rötf
(
p
, "-%lu", 
jou∫Æ
->
j_öode
->
i_öo
);

1272 
	`jbd3_°©s_¥oc_öô
(
jou∫Æ
);

1274  
jou∫Æ
;

1275 
	}
}

1282 
	$jou∫Æ_Áû_su≥rblock
 (
jou∫Æ_t
 *
jou∫Æ
)

1284 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1285 
	`bªl£
(
bh
);

1286 
jou∫Æ
->
j_sb_buf„r
 = 
NULL
;

1287 
	}
}

1296 
	$jou∫Æ_ª£t
(
jou∫Æ_t
 *
jou∫Æ
)

1298 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1299 
fú°
, 
œ°
;

1301 
fú°
 = 
	`be32_to_˝u
(
sb
->
s_fú°
);

1302 
œ°
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1303 i‡(
fú°
 + 
JBD3_MIN_JOURNAL_BLOCKS
 > 
œ°
 + 1) {

1304 
	`¥ötk
(
KERN_ERR
 "JBD3: JournalÅoo short (blocks %llu-%llu).\n",

1305 
fú°
, 
œ°
);

1306 
	`jou∫Æ_Áû_su≥rblock
(
jou∫Æ
);

1307  -
EINVAL
;

1310 
jou∫Æ
->
j_fú°
 = 
fú°
;

1311 
jou∫Æ
->
j_œ°
 = 
œ°
;

1313 
jou∫Æ
->
j_hód
 = 
fú°
;

1314 
jou∫Æ
->
j_èû
 = 
fú°
;

1315 
jou∫Æ
->
j_‰ì
 = 
œ°
 - 
fú°
;

1317 
jou∫Æ
->
j_èû_£quí˚
 = jou∫Æ->
j_å™ß˘i⁄_£quí˚
;

1318 
jou∫Æ
->
j_commô_£quí˚
 = jou∫Æ->
j_å™ß˘i⁄_£quí˚
 - 1;

1319 
jou∫Æ
->
j_commô_ªque°
 = jou∫Æ->
j_commô_£quí˚
;

1321 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 = jou∫Æ->
j_maxÀn
 / 4;

1329 i‡(
sb
->
s_°¨t
 == 0) {

1330 
	`jbd_debug
(1, "JBD3: Skipping superblock update onÑecovered sb "

1332 
jou∫Æ
->
j_èû
, jou∫Æ->
j_èû_£quí˚
,

1333 
jou∫Æ
->
j_î∫o
);

1334 
jou∫Æ
->
j_Êags
 |
JBD3_FLUSHED
;

1337 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1344 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
,

1345 
jou∫Æ
->
j_èû_£quí˚
,

1346 
jou∫Æ
->
j_èû
,

1347 
REQ_SYNC
 | 
REQ_FUA
);

1348 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1350  
	`jbd3_jou∫Æ_°¨t_thªad
(
jou∫Æ
);

1351 
	}
}

1357 
	$jbd3_wrôe_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe_Êags
)

1359 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1360 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1361 
ªt
;

1364 i‡(!
	`buf„r_m≠≥d
(
bh
))

1365  -
EIO
;

1367 
	`åa˚_jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_Êags
);

1368 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

1369 
wrôe_Êags
 &~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1370 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
)) {

1379 
	`¥ötk
(
KERN_ERR
 "JBD3:Örevious I/OÉrror detected "

1381 
jou∫Æ
->
j_dev«me
);

1382 
	`˛ór_buf„r_wrôe_io_îr‹
(
bh
);

1383 
	`£t_buf„r_u±od©e
(
bh
);

1385 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

1386 
sb
->
s_checksum
 = 
	`jbd3_su≥rblock_csum
(
jou∫Æ
, sb);

1387 
	`gë_bh
(
bh
);

1388 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

1389 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
, 
wrôe_Êags
, 
bh
);

1390 
	`waô_⁄_buf„r
(
bh
);

1391 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
)) {

1392 
	`˛ór_buf„r_wrôe_io_îr‹
(
bh
);

1393 
	`£t_buf„r_u±od©e
(
bh
);

1394 
ªt
 = -
EIO
;

1396 i‡(
ªt
) {

1397 
	`¥ötk
(
KERN_ERR
 "JBD3: Error %d detected when updating "

1398 "jou∫Æ su≥rblock f‹ %s.\n", 
ªt
,

1399 
jou∫Æ
->
j_dev«me
);

1400 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªt
);

1403  
ªt
;

1404 
	}
}

1416 
	$jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
èû_tid
,

1417 
èû_block
, 
wrôe_›
)

1419 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1420 
ªt
;

1422 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

1423  -
EIO
;

1425 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

1426 
	`jbd_debug
(1, "JBD3: updating superblock (start %lu, seq %u)\n",

1427 
èû_block
, 
èû_tid
);

1429 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1430 
sb
->
s_£quí˚
 = 
	`˝u_to_be32
(
èû_tid
);

1431 
sb
->
s_°¨t
 = 
	`˝u_to_be32
(
èû_block
);

1433 
ªt
 = 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_›
);

1434 i‡(
ªt
)

1435 
out
;

1438 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1439 
	`WARN_ON
(!
sb
->
s_£quí˚
);

1440 
jou∫Æ
->
j_Êags
 &~
JBD3_FLUSHED
;

1441 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1443 
out
:

1444  
ªt
;

1445 
	}
}

1455 
	$jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe_›
)

1457 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1459 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

1460 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1461 i‡(
sb
->
s_°¨t
 == 0) {

1462 
	`u∆ock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1466 
	`jbd_debug
(1, "JBD3: Marking journalásÉmpty (seq %u)\n",

1467 
jou∫Æ
->
j_èû_£quí˚
);

1469 
sb
->
s_£quí˚
 = 
	`˝u_to_be32
(
jou∫Æ
->
j_èû_£quí˚
);

1470 
sb
->
s_°¨t
 = 
	`˝u_to_be32
(0);

1472 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_›
);

1475 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1476 
jou∫Æ
->
j_Êags
 |
JBD3_FLUSHED
;

1477 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1478 
	}
}

1488 
	$jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ_t
 *
jou∫Æ
)

1490 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1491 
îrcode
;

1493 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1494 
îrcode
 = 
jou∫Æ
->
j_î∫o
;

1495 i‡(
îrcode
 =-
ESHUTDOWN
)

1496 
îrcode
 = 0;

1497 
	`jbd_debug
(1, "JBD3: upd©ög su≥rblockÉº‹ (î∫ÿ%d)\n", 
îrcode
);

1498 
sb
->
s_î∫o
 = 
	`˝u_to_be32
(
îrcode
);

1500 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

1501 
	}
}

1502 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_upd©e_sb_î∫o
);

1504 
	$jou∫Æ_ªvoke_ªc‹ds_≥r_block
(
jou∫Æ_t
 *
jou∫Æ
)

1506 
ªc‹d_size
;

1507 
•a˚
 = 
jou∫Æ
->
j_blocksize
 - (
jbd3_jou∫Æ_ªvoke_hódî_t
);

1509 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

1510 
ªc‹d_size
 = 8;

1512 
ªc‹d_size
 = 4;

1514 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

1515 
•a˚
 -(
jbd3_jou∫Æ_block_èû
);

1516  
•a˚
 / 
ªc‹d_size
;

1517 
	}
}

1523 
	$jou∫Æ_gë_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
)

1525 
buf„r_hód
 *
bh
;

1526 
jou∫Æ_su≥rblock_t
 *
sb
;

1527 
îr
 = -
EIO
;

1529 
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1531 
	`J_ASSERT
(
bh
 !
NULL
);

1532 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1533 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1534 
	`waô_⁄_buf„r
(
bh
);

1535 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1536 
	`¥ötk
(
KERN_ERR


1538 
out
;

1542 i‡(
	`buf„r_vîifõd
(
bh
))

1545 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1547 
îr
 = -
EINVAL
;

1549 i‡(
sb
->
s_hódî
.
h_magic
 !
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
) ||

1550 
sb
->
s_blocksize
 !
	`˝u_to_be32
(
jou∫Æ
->
j_blocksize
)) {

1551 
	`¥ötk
(
KERN_WARNING
 "JBD3:Ço valid journal superblock found\n");

1552 
out
;

1555 
	`be32_to_˝u
(
sb
->
s_hódî
.
h_blockty≥
)) {

1556 
JBD3_SUPERBLOCK_V1
:

1557 
jou∫Æ
->
j_f‹m©_vîsi⁄
 = 1;

1559 
JBD3_SUPERBLOCK_V2
:

1560 
jou∫Æ
->
j_f‹m©_vîsi⁄
 = 2;

1563 
	`¥ötk
(
KERN_WARNING
 "JBD3: unrecognised superblock format ID\n");

1564 
out
;

1567 i‡(
	`be32_to_˝u
(
sb
->
s_maxÀn
Ë< 
jou∫Æ
->
j_maxÀn
)

1568 
jou∫Æ
->
j_maxÀn
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1569 i‡(
	`be32_to_˝u
(
sb
->
s_maxÀn
Ë> 
jou∫Æ
->
j_maxÀn
) {

1570 
	`¥ötk
(
KERN_WARNING
 "JBD3: journal fileÅoo short\n");

1571 
out
;

1574 i‡(
	`be32_to_˝u
(
sb
->
s_fú°
) == 0 ||

1575 
	`be32_to_˝u
(
sb
->
s_fú°
Ë>
jou∫Æ
->
j_maxÀn
) {

1576 
	`¥ötk
(
KERN_WARNING


1578 
	`be32_to_˝u
(
sb
->
s_fú°
));

1579 
out
;

1582 i‡(
	`jbd3_has_„©uª_csum2
(
jou∫Æ
) &&

1583 
	`jbd3_has_„©uª_csum3
(
jou∫Æ
)) {

1585 
	`¥ötk
(
KERN_ERR
 "JBD3: Can'tÉnable checksumming v2ánd v3 "

1587 
out
;

1590 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
jou∫Æ
) &&

1591 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

1593 
	`¥ötk
(
KERN_ERR
 "JBD3: Can'tÉnable checksumming v1ánd v2/3 "

1595 
out
;

1598 i‡(!
	`jbd3_vîify_csum_ty≥
(
jou∫Æ
, 
sb
)) {

1599 
	`¥ötk
(
KERN_ERR
 "JBD3: Unknown checksumÅype\n");

1600 
out
;

1604 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
jou∫Æ
)) {

1605 
jou∫Æ
->
j_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

1606 i‡(
	`IS_ERR
(
jou∫Æ
->
j_chksum_drivî
)) {

1607 
	`¥ötk
(
KERN_ERR
 "JBD3: CannotÜoad crc32c driver.\n");

1608 
îr
 = 
	`PTR_ERR
(
jou∫Æ
->
j_chksum_drivî
);

1609 
jou∫Æ
->
j_chksum_drivî
 = 
NULL
;

1610 
out
;

1614 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
)) {

1616 i‡(
sb
->
s_checksum
 !
	`jbd3_su≥rblock_csum
(
jou∫Æ
, sb)) {

1617 
	`¥ötk
(
KERN_ERR
 "JBD3: journal checksumÉrror\n");

1618 
îr
 = -
EFSBADCRC
;

1619 
out
;

1623 
jou∫Æ
->
j_csum_£ed
 = 
	`jbd3_chksum
(jou∫Æ, ~0, 
sb
->
s_uuid
,

1624 (
sb
->
s_uuid
));

1627 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
 =

1628 
	`jou∫Æ_ªvoke_ªc‹ds_≥r_block
(
jou∫Æ
);

1629 
	`£t_buf„r_vîifõd
(
bh
);

1633 
out
:

1634 
	`jou∫Æ_Áû_su≥rblock
(
jou∫Æ
);

1635  
îr
;

1636 
	}
}

1643 
	$lﬂd_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
)

1645 
îr
;

1646 
jou∫Æ_su≥rblock_t
 *
sb
;

1648 
îr
 = 
	`jou∫Æ_gë_su≥rblock
(
jou∫Æ
);

1649 i‡(
îr
)

1650  
îr
;

1652 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1654 
jou∫Æ
->
j_èû_£quí˚
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
);

1655 
jou∫Æ
->
j_èû
 = 
	`be32_to_˝u
(
sb
->
s_°¨t
);

1656 
jou∫Æ
->
j_fú°
 = 
	`be32_to_˝u
(
sb
->
s_fú°
);

1657 
jou∫Æ
->
j_œ°
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1658 
jou∫Æ
->
j_î∫o
 = 
	`be32_to_˝u
(
sb
->
s_î∫o
);

1661 
	}
}

1672 
	$jbd3_jou∫Æ_lﬂd
(
jou∫Æ_t
 *
jou∫Æ
)

1674 
îr
;

1675 
jou∫Æ_su≥rblock_t
 *
sb
;

1677 
îr
 = 
	`lﬂd_su≥rblock
(
jou∫Æ
);

1678 i‡(
îr
)

1679  
îr
;

1681 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1685 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 >= 2) {

1686 i‡((
sb
->
s_„©uª_ro_com∑t
 &

1687 ~
	`˝u_to_be32
(
JBD3_KNOWN_ROCOMPAT_FEATURES
)) ||

1688 (
sb
->
s_„©uª_öcom∑t
 &

1689 ~
	`˝u_to_be32
(
JBD3_KNOWN_INCOMPAT_FEATURES
))) {

1690 
	`¥ötk
(
KERN_WARNING


1692  -
EINVAL
;

1699 
îr
 = 
	`jbd3_jou∫Æ_¸óã_¶ab
(
	`be32_to_˝u
(
sb
->
s_blocksize
));

1700 i‡(
îr
)

1701  
îr
;

1705 i‡(
	`jbd3_jou∫Æ_ªcovî
(
jou∫Æ
))

1706 
ªcovîy_îr‹
;

1708 i‡(
jou∫Æ
->
j_Áûed_commô
) {

1709 
	`¥ötk
(
KERN_ERR
 "JBD3: journalÅransaction %u on %s "

1710 "i†c‹ru±.\n", 
jou∫Æ
->
j_Áûed_commô
,

1711 
jou∫Æ
->
j_dev«me
);

1712  -
EFSCORRUPTED
;

1718 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT
;

1723 i‡(
	`jou∫Æ_ª£t
(
jou∫Æ
))

1724 
ªcovîy_îr‹
;

1726 
jou∫Æ
->
j_Êags
 |
JBD3_LOADED
;

1729 
ªcovîy_îr‹
:

1730 
	`¥ötk
(
KERN_WARNING
 "JBD3:Ñecovery failed\n");

1731  -
EIO
;

1732 
	}
}

1742 
	$jbd3_jou∫Æ_de°roy
(
jou∫Æ_t
 *
jou∫Æ
)

1744 
îr
 = 0;

1747 
	`jou∫Æ_kûl_thªad
(
jou∫Æ
);

1750 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

1751 
	`jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ
);

1756 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1757 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
) {

1758 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1759 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1760 
îr
 = 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

1761 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1766 i‡(
îr
) {

1767 
	`jbd3_jou∫Æ_de°roy_checkpoöt
(
jou∫Æ
);

1768 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1771 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1774 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 =
NULL
);

1775 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 =
NULL
);

1776 
	`J_ASSERT
(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
NULL
);

1777 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1779 i‡(
jou∫Æ
->
j_sb_buf„r
) {

1780 i‡(!
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)) {

1781 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1783 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1784 
jou∫Æ
->
j_èû_£quí˚
 =

1785 ++
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

1786 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1788 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
,

1789 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1790 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1792 
îr
 = -
EIO
;

1793 
	`bªl£
(
jou∫Æ
->
j_sb_buf„r
);

1796 i‡(
jou∫Æ
->
j_¥oc_íåy
)

1797 
	`jbd3_°©s_¥oc_exô
(
jou∫Æ
);

1798 
	`ùut
(
jou∫Æ
->
j_öode
);

1799 i‡(
jou∫Æ
->
j_ªvoke
)

1800 
	`jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ
);

1801 i‡(
jou∫Æ
->
j_chksum_drivî
)

1802 
	`¸y±o_‰ì_shash
(
jou∫Æ
->
j_chksum_drivî
);

1803 
	`k‰ì
(
jou∫Æ
->
j_wbuf
);

1804 
	`k‰ì
(
jou∫Æ
);

1806  
îr
;

1807 
	}
}

1821 
	$jbd3_jou∫Æ_check_u£d_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1822 
ro
, 
öcom∑t
)

1824 
jou∫Æ_su≥rblock_t
 *
sb
;

1826 i‡(!
com∑t
 && !
ro
 && !
öcom∑t
)

1829 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 == 0 &&

1830 
	`jou∫Æ_gë_su≥rblock
(
jou∫Æ
) != 0)

1832 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 == 1)

1835 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1837 i‡(((
	`be32_to_˝u
(
sb
->
s_„©uª_com∑t
Ë& 
com∑t
) == compat) &&

1838 ((
	`be32_to_˝u
(
sb
->
s_„©uª_ro_com∑t
Ë& 
ro
) ==Ño) &&

1839 ((
	`be32_to_˝u
(
sb
->
s_„©uª_öcom∑t
Ë& 
öcom∑t
) == incompat))

1843 
	}
}

1856 
	$jbd3_jou∫Æ_check_avaûabÀ_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1857 
ro
, 
öcom∑t
)

1859 i‡(!
com∑t
 && !
ro
 && !
öcom∑t
)

1866 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 != 2)

1869 i‡((
com∑t
 & 
JBD3_KNOWN_COMPAT_FEATURES
) == compat &&

1870 (
ro
 & 
JBD3_KNOWN_ROCOMPAT_FEATURES
) ==Ño &&

1871 (
öcom∑t
 & 
JBD3_KNOWN_INCOMPAT_FEATURES
) == incompat)

1875 
	}
}

1889 
	$jbd3_jou∫Æ_£t_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1890 
ro
, 
öcom∑t
)

1892 
	#INCOMPAT_FEATURE_ON
(
f
) \

1893 ((
öcom∑t
 & (
f
)Ë&& !(
sb
->
s_„©uª_öcom∑t
 & 
	`˝u_to_be32
(f)))

	)

1894 
	#COMPAT_FEATURE_ON
(
f
) \

1895 ((
com∑t
 & (
f
)Ë&& !(
sb
->
s_„©uª_com∑t
 & 
	`˝u_to_be32
(f)))

	)

1896 
jou∫Æ_su≥rblock_t
 *
sb
;

1898 i‡(
	`jbd3_jou∫Æ_check_u£d_„©uªs
(
jou∫Æ
, 
com∑t
, 
ro
, 
öcom∑t
))

1901 i‡(!
	`jbd3_jou∫Æ_check_avaûabÀ_„©uªs
(
jou∫Æ
, 
com∑t
, 
ro
, 
öcom∑t
))

1905 i‡(
öcom∑t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V2
) {

1906 
öcom∑t
 &~
JBD3_FEATURE_INCOMPAT_CSUM_V2
;

1907 
öcom∑t
 |
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

1911 i‡(
öcom∑t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 &&

1912 
com∑t
 & 
JBD3_FEATURE_COMPAT_CHECKSUM
)

1913 
com∑t
 &~
JBD3_FEATURE_COMPAT_CHECKSUM
;

1915 
	`jbd_debug
(1, "SettingÇew features 0x%lx/0x%lx/0x%lx\n",

1916 
com∑t
, 
ro
, 
öcom∑t
);

1918 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1921 i‡((
jou∫Æ
->
j_chksum_drivî
 =
NULL
) &&

1922 
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1923 
jou∫Æ
->
j_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

1924 i‡(
	`IS_ERR
(
jou∫Æ
->
j_chksum_drivî
)) {

1925 
	`¥ötk
(
KERN_ERR
 "JBD3: CannotÜoad crc32c driver.\n");

1926 
jou∫Æ
->
j_chksum_drivî
 = 
NULL
;

1930 
jou∫Æ
->
j_csum_£ed
 = 
	`jbd3_chksum
(jou∫Æ, ~0, 
sb
->
s_uuid
,

1931 (
sb
->
s_uuid
));

1934 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1937 i‡(
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1938 
sb
->
s_checksum_ty≥
 = 
JBD3_CRC32C_CHKSUM
;

1939 
sb
->
s_„©uª_com∑t
 &=

1940 ~
	`˝u_to_be32
(
JBD3_FEATURE_COMPAT_CHECKSUM
);

1944 i‡(
	`COMPAT_FEATURE_ON
(
JBD3_FEATURE_COMPAT_CHECKSUM
))

1945 
sb
->
s_„©uª_öcom∑t
 &=

1946 ~
	`˝u_to_be32
(
JBD3_FEATURE_INCOMPAT_CSUM_V2
 |

1947 
JBD3_FEATURE_INCOMPAT_CSUM_V3
);

1949 
sb
->
s_„©uª_com∑t
 |
	`˝u_to_be32
(
com∑t
);

1950 
sb
->
s_„©uª_ro_com∑t
 |
	`˝u_to_be32
(
ro
);

1951 
sb
->
s_„©uª_öcom∑t
 |
	`˝u_to_be32
(
öcom∑t
);

1952 
	`u∆ock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1953 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
 =

1954 
	`jou∫Æ_ªvoke_ªc‹ds_≥r_block
(
jou∫Æ
);

1957 #unde‡
COMPAT_FEATURE_ON


1958 #unde‡
INCOMPAT_FEATURE_ON


1959 
	}
}

1972 
	$jbd3_jou∫Æ_˛ór_„©uªs
(
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1973 
ro
, 
öcom∑t
)

1975 
jou∫Æ_su≥rblock_t
 *
sb
;

1977 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1978 
com∑t
, 
ro
, 
öcom∑t
);

1980 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1982 
sb
->
s_„©uª_com∑t
 &~
	`˝u_to_be32
(
com∑t
);

1983 
sb
->
s_„©uª_ro_com∑t
 &~
	`˝u_to_be32
(
ro
);

1984 
sb
->
s_„©uª_öcom∑t
 &~
	`˝u_to_be32
(
öcom∑t
);

1985 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
 =

1986 
	`jou∫Æ_ªvoke_ªc‹ds_≥r_block
(
jou∫Æ
);

1987 
	}
}

1988 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_˛ór_„©uªs
);

1999 
	$jbd3_jou∫Æ_Êush
(
jou∫Æ_t
 *
jou∫Æ
)

2001 
îr
 = 0;

2002 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
NULL
;

2004 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2007 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

2008 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

2009 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
å™ß˘i⁄
->
t_tid
);

2010 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

2011 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

2014 i‡(
å™ß˘i⁄
) {

2015 
tid_t
 
tid
 = 
å™ß˘i⁄
->
t_tid
;

2017 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2018 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

2020 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2024 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2025 !
îr
 && 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
) {

2026 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2027 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2028 
îr
 = 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

2029 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2030 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2032 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2034 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

2035  -
EIO
;

2037 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2038 i‡(!
îr
) {

2039 
îr
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

2040 i‡(
îr
 < 0) {

2041 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2042 
out
;

2044 
îr
 = 0;

2052 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

2053 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2054 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2055 
	`J_ASSERT
(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2056 
	`J_ASSERT
(!
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2057 
	`J_ASSERT
(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
);

2058 
	`J_ASSERT
(
jou∫Æ
->
j_hód
 =jou∫Æ->
j_èû
);

2059 
	`J_ASSERT
(
jou∫Æ
->
j_èû_£quí˚
 =jou∫Æ->
j_å™ß˘i⁄_£quí˚
);

2060 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2061 
out
:

2062  
îr
;

2063 
	}
}

2078 
	$jbd3_jou∫Æ_wùe
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe
)

2080 
îr
 = 0;

2082 
	`J_ASSERT
 (!(
jou∫Æ
->
j_Êags
 & 
JBD3_LOADED
));

2084 
îr
 = 
	`lﬂd_su≥rblock
(
jou∫Æ
);

2085 i‡(
îr
)

2086  
îr
;

2088 i‡(!
jou∫Æ
->
j_èû
)

2089 
no_ªcovîy
;

2091 
	`¥ötk
(
KERN_WARNING
 "JBD3: %sÑecovery information on journal\n",

2092 
wrôe
 ? "Clearing" : "Ignoring");

2094 
îr
 = 
	`jbd3_jou∫Æ_skù_ªcovîy
(
jou∫Æ
);

2095 i‡(
wrôe
) {

2097 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2098 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

2099 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2102 
no_ªcovîy
:

2103  
îr
;

2104 
	}
}

2119 
	$__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ_t
 *
jou∫Æ
)

2121 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

2123 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2126 
	`¥ötk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2127 
jou∫Æ
->
j_dev«me
);

2129 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2130 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT
;

2131 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

2132 i‡(
å™ß˘i⁄
)

2133 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
å™ß˘i⁄
->
t_tid
);

2134 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2135 
	}
}

2139 
	$__jou∫Æ_ab‹t_so·
 (
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
)

2141 
ﬁd_î∫o
;

2143 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2144 
ﬁd_î∫o
 = 
jou∫Æ
->
j_î∫o
;

2145 i‡(!
jou∫Æ
->
j_î∫o
 || 
î∫o
 =-
ESHUTDOWN
)

2146 
jou∫Æ
->
j_î∫o
 = 
î∫o
;

2148 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
) {

2149 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2150 i‡(
ﬁd_î∫o
 !-
ESHUTDOWN
 && 
î∫o
 == -ESHUTDOWN)

2151 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

2154 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2156 
	`__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ
);

2158 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

2159 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2160 
jou∫Æ
->
j_Êags
 |
JBD3_REC_ERR
;

2161 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2162 
	}
}

2205 
	$jbd3_jou∫Æ_ab‹t
(
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
)

2207 
	`__jou∫Æ_ab‹t_so·
(
jou∫Æ
, 
î∫o
);

2208 
	}
}

2221 
	$jbd3_jou∫Æ_î∫o
(
jou∫Æ_t
 *
jou∫Æ
)

2223 
îr
;

2225 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

2226 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2227 
îr
 = -
EROFS
;

2229 
îr
 = 
jou∫Æ
->
j_î∫o
;

2230 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2231  
îr
;

2232 
	}
}

2241 
	$jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ_t
 *
jou∫Æ
)

2243 
îr
 = 0;

2245 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2246 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2247 
îr
 = -
EROFS
;

2249 
jou∫Æ
->
j_î∫o
 = 0;

2250 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2251  
îr
;

2252 
	}
}

2261 
	$jbd3_jou∫Æ_ack_îr
(
jou∫Æ_t
 *
jou∫Æ
)

2263 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2264 i‡(
jou∫Æ
->
j_î∫o
)

2265 
jou∫Æ
->
j_Êags
 |
JBD3_ACK_ERR
;

2266 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2267 
	}
}

2269 
	$jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

2271  1 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

2272 
	}
}

2277 
size_t
 
	$jou∫Æ_èg_byãs
(
jou∫Æ_t
 *
jou∫Æ
)

2279 
size_t
 
sz
;

2281 i‡(
	`jbd3_has_„©uª_csum3
(
jou∫Æ
))

2282  (
jou∫Æ_block_èg3_t
);

2284 
sz
 = (
jou∫Æ_block_èg_t
);

2286 i‡(
	`jbd3_has_„©uª_csum2
(
jou∫Æ
))

2287 
sz
 +(
__u16
);

2289 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

2290  
sz
;

2292  
sz
 - (
__u32
);

2293 
	}
}

2310 
	#JBD3_MAX_SLABS
 8

	)

2311 
kmem_ˇche
 *
	gjbd3_¶ab
[
JBD3_MAX_SLABS
];

2313 c⁄° *
	gjbd3_¶ab_«mes
[
JBD3_MAX_SLABS
] = {

2319 
	$jbd3_jou∫Æ_de°roy_¶abs
()

2321 
i
;

2323 
i
 = 0; i < 
JBD3_MAX_SLABS
; i++) {

2324 
	`kmem_ˇche_de°roy
(
jbd3_¶ab
[
i
]);

2325 
jbd3_¶ab
[
i
] = 
NULL
;

2327 
	}
}

2329 
	$jbd3_jou∫Æ_¸óã_¶ab
(
size_t
 
size
)

2331 
	`DEFINE_MUTEX
(
jbd3_¶ab_¸óã_muãx
);

2332 
i
 = 
	`‹dî_ba£_2
(
size
) - 10;

2333 
size_t
 
¶ab_size
;

2335 i‡(
size
 =
PAGE_SIZE
)

2338 i‡(
i
 >
JBD3_MAX_SLABS
)

2339  -
EINVAL
;

2341 i‡(
	`u∆ikñy
(
i
 < 0))

2342 
i
 = 0;

2343 
	`muãx_lock
(&
jbd3_¶ab_¸óã_muãx
);

2344 i‡(
jbd3_¶ab
[
i
]) {

2345 
	`muãx_u∆ock
(&
jbd3_¶ab_¸óã_muãx
);

2349 
¶ab_size
 = 1 << (
i
+10);

2350 
jbd3_¶ab
[
i
] = 
	`kmem_ˇche_¸óã
(
jbd3_¶ab_«mes
[i], 
¶ab_size
,

2351 
¶ab_size
, 0, 
NULL
);

2352 
	`muãx_u∆ock
(&
jbd3_¶ab_¸óã_muãx
);

2353 i‡(!
jbd3_¶ab
[
i
]) {

2354 
	`¥ötk
(
KERN_EMERG
 "JBD3:Ço memory for jbd3_slab cache\n");

2355  -
ENOMEM
;

2358 
	}
}

2360 
kmem_ˇche
 *
	$gë_¶ab
(
size_t
 
size
)

2362 
i
 = 
	`‹dî_ba£_2
(
size
) - 10;

2364 
	`BUG_ON
(
i
 >
JBD3_MAX_SLABS
);

2365 i‡(
	`u∆ikñy
(
i
 < 0))

2366 
i
 = 0;

2367 
	`BUG_ON
(
jbd3_¶ab
[
i
] =
NULL
);

2368  
jbd3_¶ab
[
i
];

2369 
	}
}

2371 *
	$jbd3_Æloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

2373 *
±r
;

2375 
	`BUG_ON
(
size
 & (size-1));

2377 i‡(
size
 < 
PAGE_SIZE
)

2378 
±r
 = 
	`kmem_ˇche_Æloc
(
	`gë_¶ab
(
size
), 
Êags
);

2380 
±r
 = (*)
	`__gë_‰ì_∑ges
(
Êags
, 
	`gë_‹dî
(
size
));

2384 
	`BUG_ON
(((Ë
±r
Ë& (
size
-1));

2386  
±r
;

2387 
	}
}

2389 
	$jbd3_‰ì
(*
±r
, 
size_t
 
size
)

2391 i‡(
size
 < 
PAGE_SIZE
)

2392 
	`kmem_ˇche_‰ì
(
	`gë_¶ab
(
size
), 
±r
);

2394 
	`‰ì_∑ges
(()
±r
, 
	`gë_‹dî
(
size
));

2395 
	}
};

2400 
kmem_ˇche
 *
	gjbd3_jou∫Æ_hód_ˇche
;

2401 #ifde‡
CONFIG_JBD3_DEBUG


2402 
©omic_t
 
	gƒ_jou∫Æ_hóds
 = 
ATOMIC_INIT
(0);

2405 
__öô
 
	$jbd3_jou∫Æ_öô_jou∫Æ_hód_ˇche
()

2407 
	`J_ASSERT
(!
jbd3_jou∫Æ_hód_ˇche
);

2408 
jbd3_jou∫Æ_hód_ˇche
 = 
	`kmem_ˇche_¸óã
("jbd3_journal_head",

2409 (
jou∫Æ_hód
),

2411 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2412 
NULL
);

2413 i‡(!
jbd3_jou∫Æ_hód_ˇche
) {

2414 
	`¥ötk
(
KERN_EMERG
 "JBD3:Ço memory for journal_head cache\n");

2415  -
ENOMEM
;

2418 
	}
}

2420 
	$jbd3_jou∫Æ_de°roy_jou∫Æ_hód_ˇche
()

2422 
	`kmem_ˇche_de°roy
(
jbd3_jou∫Æ_hód_ˇche
);

2423 
jbd3_jou∫Æ_hód_ˇche
 = 
NULL
;

2424 
	}
}

2429 
jou∫Æ_hód
 *
	$jou∫Æ_Æloc_jou∫Æ_hód
()

2431 
jou∫Æ_hód
 *
ªt
;

2433 #ifde‡
CONFIG_JBD3_DEBUG


2434 
	`©omic_öc
(&
ƒ_jou∫Æ_hóds
);

2436 
ªt
 = 
	`kmem_ˇche_zÆloc
(
jbd3_jou∫Æ_hód_ˇche
, 
GFP_NOFS
);

2437 i‡(!
ªt
) {

2438 
	`jbd_debug
(1, "out of memory for journal_head\n");

2439 
	`¥_nŸi˚_øãlimôed
("ENOMEM i¿%s,Ñëryög.\n", 
__func__
);

2440 
ªt
 = 
	`kmem_ˇche_zÆloc
(
jbd3_jou∫Æ_hód_ˇche
,

2441 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2443 i‡(
ªt
)

2444 
	`•ö_lock_öô
(&
ªt
->
b_°©e_lock
);

2445  
ªt
;

2446 
	}
}

2448 
	$jou∫Æ_‰ì_jou∫Æ_hód
(
jou∫Æ_hód
 *
jh
)

2450 #ifde‡
CONFIG_JBD3_DEBUG


2451 
	`©omic_dec
(&
ƒ_jou∫Æ_hóds
);

2452 
	`mem£t
(
jh
, 
JBD3_POISON_FREE
, (*jh));

2454 
	`kmem_ˇche_‰ì
(
jbd3_jou∫Æ_hód_ˇche
, 
jh
);

2455 
	}
}

2498 
jou∫Æ_hód
 *
	$jbd3_jou∫Æ_add_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2500 
jou∫Æ_hód
 *
jh
;

2501 
jou∫Æ_hód
 *
√w_jh
 = 
NULL
;

2503 
ª≥©
:

2504 i‡(!
	`buf„r_jbd
(
bh
))

2505 
√w_jh
 = 
	`jou∫Æ_Æloc_jou∫Æ_hód
();

2507 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2508 i‡(
	`buf„r_jbd
(
bh
)) {

2509 
jh
 = 
	`bh2jh
(
bh
);

2511 
	`J_ASSERT_BH
(
bh
,

2512 (
	`©omic_ªad
(&
bh
->
b_cou¡
) > 0) ||

2513 (
bh
->
b_∑ge
 && bh->b_∑ge->
m≠pög
));

2515 i‡(!
√w_jh
) {

2516 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2517 
ª≥©
;

2520 
jh
 = 
√w_jh
;

2521 
√w_jh
 = 
NULL
;

2522 
	`£t_buf„r_jbd
(
bh
);

2523 
bh
->
b_¥iv©e
 = 
jh
;

2524 
jh
->
b_bh
 = 
bh
;

2525 
	`gë_bh
(
bh
);

2526 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2528 
jh
->
b_jcou¡
++;

2529 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2530 i‡(
√w_jh
)

2531 
	`jou∫Æ_‰ì_jou∫Æ_hód
(
√w_jh
);

2532  
bh
->
b_¥iv©e
;

2533 
	}
}

2539 
jou∫Æ_hód
 *
	$jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2541 
jou∫Æ_hód
 *
jh
 = 
NULL
;

2543 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2544 i‡(
	`buf„r_jbd
(
bh
)) {

2545 
jh
 = 
	`bh2jh
(
bh
);

2546 
jh
->
b_jcou¡
++;

2548 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2549  
jh
;

2550 
	}
}

2552 
	$__jou∫Æ_ªmove_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2554 
jou∫Æ_hód
 *
jh
 = 
	`bh2jh
(
bh
);

2556 
	`J_ASSERT_JH
(
jh
, jh->
b_jcou¡
 >= 0);

2557 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
NULL
);

2558 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

2559 
	`J_ASSERT_JH
(
jh
, jh->
b_˝_å™ß˘i⁄
 =
NULL
);

2560 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 =
BJ_N⁄e
);

2561 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_jbd
(bh));

2562 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2563 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2566 
bh
->
b_¥iv©e
 = 
NULL
;

2567 
jh
->
b_bh
 = 
NULL
;

2568 
	`˛ór_buf„r_jbd
(
bh
);

2569 
	}
}

2571 
	$jou∫Æ_ªÀa£_jou∫Æ_hód
(
jou∫Æ_hód
 *
jh
, 
size_t
 
b_size
)

2573 i‡(
jh
->
b_‰ozí_d©a
) {

2574 
	`¥ötk
(
KERN_WARNING
 "%s: fªeög b_‰ozí_d©a\n", 
__func__
);

2575 
	`jbd3_‰ì
(
jh
->
b_‰ozí_d©a
, 
b_size
);

2577 i‡(
jh
->
b_commôãd_d©a
) {

2578 
	`¥ötk
(
KERN_WARNING
 "%s: fªeög b_commôãd_d©a\n", 
__func__
);

2579 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
b_size
);

2581 
	`jou∫Æ_‰ì_jou∫Æ_hód
(
jh
);

2582 
	}
}

2588 
	$jbd3_jou∫Æ_put_jou∫Æ_hód
(
jou∫Æ_hód
 *
jh
)

2590 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2592 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2593 
	`J_ASSERT_JH
(
jh
, jh->
b_jcou¡
 > 0);

2594 --
jh
->
b_jcou¡
;

2595 i‡(!
jh
->
b_jcou¡
) {

2596 
	`__jou∫Æ_ªmove_jou∫Æ_hód
(
bh
);

2597 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2598 
	`jou∫Æ_ªÀa£_jou∫Æ_hód
(
jh
, 
bh
->
b_size
);

2599 
	`__bªl£
(
bh
);

2601 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2603 
	}
}

2608 
	$jbd3_jou∫Æ_öô_jbd_öode
(
jbd3_öode
 *
jöode
, 
öode
 *inode)

2610 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

2611 
jöode
->
i_√xt_å™ß˘i⁄
 = 
NULL
;

2612 
jöode
->
i_vfs_öode
 = 
öode
;

2613 
jöode
->
i_Êags
 = 0;

2614 
jöode
->
i_dúty_°¨t
 = 0;

2615 
jöode
->
i_dúty_íd
 = 0;

2616 
	`INIT_LIST_HEAD
(&
jöode
->
i_li°
);

2617 
	}
}

2624 
	$jbd3_jou∫Æ_ªÀa£_jbd_öode
(
jou∫Æ_t
 *
jou∫Æ
,

2625 
jbd3_öode
 *
jöode
)

2627 i‡(!
jou∫Æ
)

2629 
ª°¨t
:

2630 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2632 i‡(
jöode
->
i_Êags
 & 
JI_COMMIT_RUNNING
) {

2633 
waô_queue_hód_t
 *
wq
;

2634 
	`DEFINE_WAIT_BIT
(
waô
, &
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

2635 
wq
 = 
	`bô_waôqueue
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

2636 
	`¥ï¨e_to_waô
(
wq
, &
waô
.
wq_íåy
, 
TASK_UNINTERRUPTIBLE
);

2637 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2638 
	`scheduÀ
();

2639 
	`föish_waô
(
wq
, &
waô
.
wq_íåy
);

2640 
ª°¨t
;

2643 i‡(
jöode
->
i_å™ß˘i⁄
) {

2644 
	`li°_dñ
(&
jöode
->
i_li°
);

2645 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

2647 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2648 
	}
}

2651 #ifde‡
CONFIG_PROC_FS


2653 
	#JBD3_STATS_PROC_NAME
 "fs/jbd3"

	)

2655 
__öô
 
	$jbd3_¸óã_jbd_°©s_¥oc_íåy
()

2657 
¥oc_jbd3_°©s
 = 
	`¥oc_mkdú
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2658 
	}
}

2660 
__exô
 
	$jbd3_ªmove_jbd_°©s_¥oc_íåy
()

2662 i‡(
¥oc_jbd3_°©s
)

2663 
	`ªmove_¥oc_íåy
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2664 
	}
}

2668 
	#jbd3_¸óã_jbd_°©s_¥oc_íåy
(Ëdÿ{} 0)

	)

2669 
	#jbd3_ªmove_jbd_°©s_¥oc_íåy
(Ëdÿ{} 0)

	)

2673 
kmem_ˇche
 *
	gjbd3_h™dÀ_ˇche
, *
	gjbd3_öode_ˇche
;

2675 
__öô
 
	$jbd3_jou∫Æ_öô_öode_ˇche
()

2677 
	`J_ASSERT
(!
jbd3_öode_ˇche
);

2678 
jbd3_öode_ˇche
 = 
	`KMEM_CACHE
(
jbd3_öode
, 0);

2679 i‡(!
jbd3_öode_ˇche
) {

2680 
	`¥_emîg
("JBD3: failedÅo create inode cache\n");

2681  -
ENOMEM
;

2684 
	}
}

2686 
__öô
 
	$jbd3_jou∫Æ_öô_h™dÀ_ˇche
()

2688 
	`J_ASSERT
(!
jbd3_h™dÀ_ˇche
);

2689 
jbd3_h™dÀ_ˇche
 = 
	`KMEM_CACHE
(
jbd3_jou∫Æ_h™dÀ
, 
SLAB_TEMPORARY
);

2690 i‡(!
jbd3_h™dÀ_ˇche
) {

2691 
	`¥ötk
(
KERN_EMERG
 "JBD3: failedÅo create handle cache\n");

2692  -
ENOMEM
;

2695 
	}
}

2697 
	$jbd3_jou∫Æ_de°roy_öode_ˇche
()

2699 
	`kmem_ˇche_de°roy
(
jbd3_öode_ˇche
);

2700 
jbd3_öode_ˇche
 = 
NULL
;

2701 
	}
}

2703 
	$jbd3_jou∫Æ_de°roy_h™dÀ_ˇche
()

2705 
	`kmem_ˇche_de°roy
(
jbd3_h™dÀ_ˇche
);

2706 
jbd3_h™dÀ_ˇche
 = 
NULL
;

2707 
	}
}

2713 
__öô
 
	$jou∫Æ_öô_ˇches
()

2715 
ªt
;

2717 
ªt
 = 
	`jbd3_jou∫Æ_öô_ªvoke_ªc‹d_ˇche
();

2718 i‡(
ªt
 == 0)

2719 
ªt
 = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ_ˇche
();

2720 i‡(
ªt
 == 0)

2721 
ªt
 = 
	`jbd3_jou∫Æ_öô_jou∫Æ_hód_ˇche
();

2722 i‡(
ªt
 == 0)

2723 
ªt
 = 
	`jbd3_jou∫Æ_öô_h™dÀ_ˇche
();

2724 i‡(
ªt
 == 0)

2725 
ªt
 = 
	`jbd3_jou∫Æ_öô_öode_ˇche
();

2726 i‡(
ªt
 == 0)

2727 
ªt
 = 
	`jbd3_jou∫Æ_öô_å™ß˘i⁄_ˇche
();

2728  
ªt
;

2729 
	}
}

2731 
	$jbd3_jou∫Æ_de°roy_ˇches
()

2733 
	`jbd3_jou∫Æ_de°roy_ªvoke_ªc‹d_ˇche
();

2734 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ_ˇche
();

2735 
	`jbd3_jou∫Æ_de°roy_jou∫Æ_hód_ˇche
();

2736 
	`jbd3_jou∫Æ_de°roy_h™dÀ_ˇche
();

2737 
	`jbd3_jou∫Æ_de°roy_öode_ˇche
();

2738 
	`jbd3_jou∫Æ_de°roy_å™ß˘i⁄_ˇche
();

2739 
	`jbd3_jou∫Æ_de°roy_¶abs
();

2740 
	}
}

2742 
__öô
 
	$jou∫Æ_öô
()

2744 
ªt
;

2746 
	`BUILD_BUG_ON
((
jou∫Æ_su≥rblock_s
) != 1024);

2748 
ªt
 = 
	`jou∫Æ_öô_ˇches
();

2749 i‡(
ªt
 == 0) {

2750 
	`jbd3_¸óã_jbd_°©s_¥oc_íåy
();

2752 
	`jbd3_jou∫Æ_de°roy_ˇches
();

2754  
ªt
;

2755 
	}
}

2757 
__exô
 
	$jou∫Æ_exô
()

2759 #ifde‡
CONFIG_JBD3_DEBUG


2760 
n
 = 
	`©omic_ªad
(&
ƒ_jou∫Æ_hóds
);

2761 i‡(
n
)

2762 
	`¥ötk
(
KERN_ERR
 "JBD3:Üóked %d jou∫Æ_hóds!\n", 
n
);

2764 
	`jbd3_ªmove_jbd_°©s_¥oc_íåy
();

2765 
	`jbd3_jou∫Æ_de°roy_ˇches
();

2766 
	}
}

2768 
MODULE_LICENSE
("GPL");

2769 
moduÀ_öô
(
jou∫Æ_öô
);

2770 
moduÀ_exô
(
jou∫Æ_exô
);

	@jbd3/recovery.c

13 #i‚de‡
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/jbd3.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/¸c32.h
>

21 
	~<löux/blkdev.h
>

28 
	sªcovîy_öfo


30 
tid_t
 
	m°¨t_å™ß˘i⁄
;

31 
tid_t
 
	míd_å™ß˘i⁄
;

33 
	mƒ_ª∂ays
;

34 
	mƒ_ªvokes
;

35 
	mƒ_ªvoke_hôs
;

38 
	e∑s°y≥
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_⁄e_∑ss
(
jou∫Æ_t
 *
jou∫Æ
,

40 
ªcovîy_öfo
 *
öfo
, 
∑s°y≥
 
∑ss
);

41 
sˇn_ªvoke_ªc‹ds
(
jou∫Æ_t
 *, 
buf„r_hód
 *,

42 
tid_t
, 
ªcovîy_öfo
 *);

44 #ifde‡
__KERNEL__


47 
	$jou∫Æ_bªl£_¨øy
(
buf„r_hód
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`bªl£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_ªadahód
(
jou∫Æ_t
 *
jou∫Æ
, 
°¨t
)

69 
îr
;

70 
max
, 
nbufs
, 
√xt
;

71 
blockƒ
;

72 
buf„r_hód
 *
bh
;

74 
buf„r_hód
 * 
bufs
[
MAXBUF
];

77 
max
 = 
°¨t
 + (128 * 1024 / 
jou∫Æ
->
j_blocksize
);

78 i‡(
max
 > 
jou∫Æ
->
j_maxÀn
)

79 
max
 = 
jou∫Æ
->
j_maxÀn
;

84 
nbufs
 = 0;

86 
√xt
 = 
°¨t
;Çexà< 
max
;Çext++) {

87 
îr
 = 
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
√xt
, &
blockƒ
);

89 i‡(
îr
) {

90 
	`¥ötk
(
KERN_ERR
 "JBD3: bad blockát offset %u\n",

91 
√xt
);

92 
Áûed
;

95 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

96 i‡(!
bh
) {

97 
îr
 = -
ENOMEM
;

98 
Áûed
;

101 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 i‡(
nbufs
 =
MAXBUF
) {

104 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jou∫Æ_bªl£_¨øy
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`bªl£
(
bh
);

112 i‡(
nbufs
)

113 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
îr
 = 0;

116 
Áûed
:

117 i‡(
nbufs
)

118 
	`jou∫Æ_bªl£_¨øy
(
bufs
, 
nbufs
);

119  
îr
;

120 
	}
}

129 
	$jªad
(
buf„r_hód
 **
bhp
, 
jou∫Æ_t
 *
jou∫Æ
,

130 
off£t
)

132 
îr
;

133 
blockƒ
;

134 
buf„r_hód
 *
bh
;

136 *
bhp
 = 
NULL
;

138 i‡(
off£t
 >
jou∫Æ
->
j_maxÀn
) {

139 
	`¥ötk
(
KERN_ERR
 "JBD3: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
îr
 = 
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
off£t
, &
blockƒ
);

145 i‡(
îr
) {

146 
	`¥ötk
(
KERN_ERR
 "JBD3: bad blockát offset %u\n",

147 
off£t
);

148  
îr
;

151 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

152 i‡(!
bh
)

153  -
ENOMEM
;

155 i‡(!
	`buf„r_u±od©e
(
bh
)) {

158 i‡(!
	`buf„r_ªq
(
bh
))

159 
	`do_ªadahód
(
jou∫Æ
, 
off£t
);

160 
	`waô_⁄_buf„r
(
bh
);

163 i‡(!
	`buf„r_u±od©e
(
bh
)) {

164 
	`¥ötk
(
KERN_ERR
 "JBD3: FailedÅoÑead blockát offset %u\n",

165 
off£t
);

166 
	`bªl£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ_t
 *
j
, *
buf
)

176 
jbd3_jou∫Æ_block_èû
 *
èû
;

177 
__be32
 
¥ovided
;

178 
__u32
 
ˇlcuœãd
;

180 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

183 
èû
 = (
jbd3_jou∫Æ_block_èû
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd3_jou∫Æ_block_èû
));

185 
¥ovided
 = 
èû
->
t_checksum
;

186 
èû
->
t_checksum
 = 0;

187 
ˇlcuœãd
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 
èû
->
t_checksum
 = 
¥ovided
;

190  
¥ovided
 =
	`˝u_to_be32
(
ˇlcuœãd
);

191 
	}
}

197 
	$cou¡_ègs
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
)

199 * 
ègp
;

200 
jou∫Æ_block_èg_t
 * 
èg
;

201 
ƒ
 = 0, 
size
 = 
jou∫Æ
->
j_blocksize
;

202 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

204 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

205 
size
 -(
jbd3_jou∫Æ_block_èû
);

207 
ègp
 = &
bh
->
b_d©a
[(
jou∫Æ_hódî_t
)];

209 (
ègp
 - 
bh
->
b_d©a
 + 
èg_byãs
Ë<
size
) {

210 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

212 
ƒ
++;

213 
ègp
 +
èg_byãs
;

214 i‡(!(
èg
->
t_Êags
 & 
	`˝u_to_be16
(
JBD3_FLAG_SAME_UUID
)))

215 
ègp
 += 16;

217 i‡(
èg
->
t_Êags
 & 
	`˝u_to_be16
(
JBD3_FLAG_LAST_TAG
))

221  
ƒ
;

222 
	}
}

226 
	#wøp
(
jou∫Æ
, 
v¨
) \

228 i‡(
v¨
 >(
jou∫Æ
)->
j_œ°
) \

229 
v¨
 -((
jou∫Æ
)->
j_œ°
 - (jou∫Æ)->
j_fú°
); \

230 } 0)

	)

244 
	$jbd3_jou∫Æ_ªcovî
(
jou∫Æ_t
 *
jou∫Æ
)

246 
îr
, 
îr2
;

247 
jou∫Æ_su≥rblock_t
 * 
sb
;

249 
ªcovîy_öfo
 
öfo
;

251 
	`mem£t
(&
öfo
, 0, (info));

252 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

260 i‡(!
sb
->
s_°¨t
) {

261 
	`jbd_debug
(1, "NoÑecoveryÑequired,ÜastÅransaction %d\n",

262 
	`be32_to_˝u
(
sb
->
s_£quí˚
));

263 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
) + 1;

267 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_SCAN
);

268 i‡(!
îr
)

269 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_REVOKE
);

270 i‡(!
îr
)

271 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD3:Ñecovery,Éxit status %d, "

275 
îr
, 
öfo
.
°¨t_å™ß˘i⁄
, info.
íd_å™ß˘i⁄
);

276 
	`jbd_debug
(1, "JBD3: Replayed %dándÑevoked %d/%d blocks\n",

277 
öfo
.
ƒ_ª∂ays
, info.
ƒ_ªvoke_hôs
, info.
ƒ_ªvokes
);

281 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = ++
öfo
.
íd_å™ß˘i⁄
;

283 
	`jbd3_jou∫Æ_˛ór_ªvoke
(
jou∫Æ
);

284 
îr2
 = 
	`sync_blockdev
(
jou∫Æ
->
j_fs_dev
);

285 i‡(!
îr
)

286 
îr
 = 
îr2
;

288 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
) {

289 
îr2
 = 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 i‡(!
îr
)

291 
îr
 = 
îr2
;

293  
îr
;

294 
	}
}

309 
	$jbd3_jou∫Æ_skù_ªcovîy
(
jou∫Æ_t
 *
jou∫Æ
)

311 
îr
;

313 
ªcovîy_öfo
 
öfo
;

315 
	`mem£t
 (&
öfo
, 0, (info));

317 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_SCAN
);

319 i‡(
îr
) {

320 
	`¥ötk
(
KERN_ERR
 "JBD3:Éº‹ %d sˇ¬ög jou∫Æ\n", 
îr
);

321 ++
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

323 #ifde‡
CONFIG_JBD3_DEBUG


324 
dr›≥d
 = 
öfo
.
íd_å™ß˘i⁄
 -

325 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_£quí˚
);

326 
	`jbd_debug
(1,

328 
dr›≥d
, (dropped == 1) ? "" : "s");

330 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = ++
öfo
.
íd_å™ß˘i⁄
;

333 
jou∫Æ
->
j_èû
 = 0;

334  
îr
;

335 
	}
}

337 
ölöe
 
	$ªad_èg_block
(
jou∫Æ_t
 *
jou∫Æ
,

338 
jou∫Æ_block_èg_t
 *
èg
)

340 
block
 = 
	`be32_to_˝u
(
èg
->
t_blockƒ
);

341 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

342 
block
 |(
u64
)
	`be32_to_˝u
(
èg
->
t_blockƒ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ˇlc_chksums
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

351 *
√xt_log_block
, 
__u32
 *
¸c32_sum
)

353 
i
, 
num_blks
, 
îr
;

354 
io_block
;

355 
buf„r_hód
 *
obh
;

357 
num_blks
 = 
	`cou¡_ègs
(
jou∫Æ
, 
bh
);

359 *
¸c32_sum
 = 
	`¸c32_be
(*¸c32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
√xt_log_block
)++;

363 
	`wøp
(
jou∫Æ
, *
√xt_log_block
);

364 
îr
 = 
	`jªad
(&
obh
, 
jou∫Æ
, 
io_block
);

365 i‡(
îr
) {

366 
	`¥ötk
(
KERN_ERR
 "JBD3: IOÉrror %dÑecovering block "

367 "%lu i¿log\n", 
îr
, 
io_block
);

370 *
¸c32_sum
 = 
	`¸c32_be
(*¸c32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd3_commô_block_csum_vîify
(
jou∫Æ_t
 *
j
, *
buf
)

380 
commô_hódî
 *
h
;

381 
__be32
 
¥ovided
;

382 
__u32
 
ˇlcuœãd
;

384 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

387 
h
 = 
buf
;

388 
¥ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ˇlcuœãd
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
¥ovided
;

393  
¥ovided
 =
	`˝u_to_be32
(
ˇlcuœãd
);

394 
	}
}

396 
	$jbd3_block_èg_csum_vîify
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

397 *
buf
, 
__u32
 
£quí˚
)

399 
jou∫Æ_block_èg3_t
 *
èg3
 = (jou∫Æ_block_èg3_à*)
èg
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

406 
£q
 = 
	`˝u_to_be32
(
£quí˚
);

407 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 i‡(
	`jbd3_has_„©uª_csum3
(
j
))

411  
èg3
->
t_checksum
 =
	`˝u_to_be32
(
csum32
);

413  
èg
->
t_checksum
 =
	`˝u_to_be16
(
csum32
);

414 
	}
}

416 
	$do_⁄e_∑ss
(
jou∫Æ_t
 *
jou∫Æ
,

417 
ªcovîy_öfo
 *
öfo
, 
∑s°y≥
 
∑ss
)

419 
fú°_commô_ID
, 
√xt_commô_ID
;

420 
√xt_log_block
;

421 
îr
, 
suc˚ss
 = 0;

422 
jou∫Æ_su≥rblock_t
 * 
sb
;

423 
jou∫Æ_hódî_t
 * 
tmp
;

424 
buf„r_hód
 * 
bh
;

425 
£quí˚
;

426 
blockty≥
;

427 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

428 
__u32
 
¸c32_sum
 = ~0;

429 
des¸_csum_size
 = 0;

430 
block_îr‹
 = 0;

438 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

439 
√xt_commô_ID
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
);

440 
√xt_log_block
 = 
	`be32_to_˝u
(
sb
->
s_°¨t
);

442 
fú°_commô_ID
 = 
√xt_commô_ID
;

443 i‡(
∑ss
 =
PASS_SCAN
)

444 
öfo
->
°¨t_å™ß˘i⁄
 = 
fú°_commô_ID
;

446 
	`jbd_debug
(1, "SèπögÑecovîyÖas†%d\n", 
∑ss
);

456 
Êags
;

457 * 
ègp
;

458 
jou∫Æ_block_èg_t
 * 
èg
;

459 
buf„r_hód
 * 
obh
;

460 
buf„r_hód
 * 
nbh
;

462 
	`c⁄d_ªsched
();

468 i‡(
∑ss
 !
PASS_SCAN
)

469 i‡(
	`tid_geq
(
√xt_commô_ID
, 
öfo
->
íd_å™ß˘i⁄
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %uát %lu/%lu\n",

473 
√xt_commô_ID
, 
√xt_log_block
, 
jou∫Æ
->
j_œ°
);

479 
	`jbd_debug
(3, "JBD3: checkög block %ld\n", 
√xt_log_block
);

480 
îr
 = 
	`jªad
(&
bh
, 
jou∫Æ
, 
√xt_log_block
);

481 i‡(
îr
)

482 
Áûed
;

484 
√xt_log_block
++;

485 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

493 
tmp
 = (
jou∫Æ_hódî_t
 *)
bh
->
b_d©a
;

495 i‡(
tmp
->
h_magic
 !
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
)) {

496 
	`bªl£
(
bh
);

500 
blockty≥
 = 
	`be32_to_˝u
(
tmp
->
h_blockty≥
);

501 
£quí˚
 = 
	`be32_to_˝u
(
tmp
->
h_£quí˚
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty≥
, 
£quí˚
);

505 i‡(
£quí˚
 !
√xt_commô_ID
) {

506 
	`bªl£
(
bh
);

514 
blockty≥
) {

515 
JBD3_DESCRIPTOR_BLOCK
:

517 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

518 
des¸_csum_size
 =

519 (
jbd3_jou∫Æ_block_èû
);

520 i‡(
des¸_csum_size
 > 0 &&

521 !
	`jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ
,

522 
bh
->
b_d©a
)) {

523 
	`¥ötk
(
KERN_ERR
 "JBD3: Invalid checksum "

525 
√xt_log_block
);

526 
îr
 = -
EFSBADCRC
;

527 
	`bªl£
(
bh
);

528 
Áûed
;

535 i‡(
∑ss
 !
PASS_REPLAY
) {

536 i‡(
∑ss
 =
PASS_SCAN
 &&

537 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
) &&

538 !
öfo
->
íd_å™ß˘i⁄
) {

539 i‡(
	`ˇlc_chksums
(
jou∫Æ
, 
bh
,

540 &
√xt_log_block
,

541 &
¸c32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
√xt_log_block
 +
	`cou¡_ègs
(
jou∫Æ
, 
bh
);

549 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

550 
	`put_bh
(
bh
);

558 
ègp
 = &
bh
->
b_d©a
[(
jou∫Æ_hódî_t
)];

559 (
ègp
 - 
bh
->
b_d©a
 + 
èg_byãs
)

560 <
jou∫Æ
->
j_blocksize
 - 
des¸_csum_size
) {

561 
io_block
;

563 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

564 
Êags
 = 
	`be16_to_˝u
(
èg
->
t_Êags
);

566 
io_block
 = 
√xt_log_block
++;

567 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

568 
îr
 = 
	`jªad
(&
obh
, 
jou∫Æ
, 
io_block
);

569 i‡(
îr
) {

572 
suc˚ss
 = 
îr
;

573 
	`¥ötk
(
KERN_ERR


576 
îr
, 
io_block
);

578 
blockƒ
;

580 
	`J_ASSERT
(
obh
 !
NULL
);

581 
blockƒ
 = 
	`ªad_èg_block
(
jou∫Æ
,

582 
èg
);

587 i‡(
jbd3_jou∫Æ_ã°_ªvoke


588 (
jou∫Æ
, 
blockƒ
,

589 
√xt_commô_ID
)) {

590 
	`bªl£
(
obh
);

591 ++
öfo
->
ƒ_ªvoke_hôs
;

592 
skù_wrôe
;

596 i‡(!
	`jbd3_block_èg_csum_vîify
(

597 
jou∫Æ
, 
èg
, 
obh
->
b_d©a
,

598 
	`be32_to_˝u
(
tmp
->
h_£quí˚
))) {

599 
	`bªl£
(
obh
);

600 
suc˚ss
 = -
EFSBADCRC
;

601 
	`¥ötk
(
KERN_ERR
 "JBD3: Invalid "

604 "log\n", 
blockƒ
);

605 
block_îr‹
 = 1;

606 
skù_wrôe
;

611 
nbh
 = 
	`__gëblk
(
jou∫Æ
->
j_fs_dev
,

612 
blockƒ
,

613 
jou∫Æ
->
j_blocksize
);

614 i‡(
nbh
 =
NULL
) {

615 
	`¥ötk
(
KERN_ERR


618 
îr
 = -
ENOMEM
;

619 
	`bªl£
(
bh
);

620 
	`bªl£
(
obh
);

621 
Áûed
;

624 
	`lock_buf„r
(
nbh
);

625 
	`mem˝y
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jou∫Æ
->
j_blocksize
);

627 i‡(
Êags
 & 
JBD3_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_buf„r_u±od©e
(
nbh
);

634 
	`m¨k_buf„r_dúty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
öfo
->
ƒ_ª∂ays
;

638 
	`u∆ock_buf„r
(
nbh
);

639 
	`bªl£
(
obh
);

640 
	`bªl£
(
nbh
);

643 
skù_wrôe
:

644 
ègp
 +
èg_byãs
;

645 i‡(!(
Êags
 & 
JBD3_FLAG_SAME_UUID
))

646 
ègp
 += 16;

648 i‡(
Êags
 & 
JBD3_FLAG_LAST_TAG
)

652 
	`bªl£
(
bh
);

655 
JBD3_COMMIT_BLOCK
:

691 i‡(
∑ss
 =
PASS_SCAN
 &&

692 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

693 
chksum_îr
, 
chksum_£í
;

694 
commô_hódî
 *
cbh
 =

695 (
commô_hódî
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_˝u
(
cbh
->
h_chksum
[0]);

699 
chksum_îr
 = 
chksum_£í
 = 0;

701 i‡(
öfo
->
íd_å™ß˘i⁄
) {

702 
jou∫Æ
->
j_Áûed_commô
 =

703 
öfo
->
íd_å™ß˘i⁄
;

704 
	`bªl£
(
bh
);

708 i‡(
¸c32_sum
 =
found_chksum
 &&

709 
cbh
->
h_chksum_ty≥
 =
JBD3_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD3_CRC32_CHKSUM_SIZE
)

712 
chksum_£í
 = 1;

713 i‡(!(
cbh
->
h_chksum_ty≥
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£í
))

727 
chksum_îr
 = 1;

729 i‡(
chksum_îr
) {

730 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

732 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

733 
jou∫Æ
->
j_Áûed_commô
 =

734 
√xt_commô_ID
;

735 
	`bªl£
(
bh
);

739 
¸c32_sum
 = ~0;

741 i‡(
∑ss
 =
PASS_SCAN
 &&

742 !
	`jbd3_commô_block_csum_vîify
(
jou∫Æ
,

743 
bh
->
b_d©a
)) {

744 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

746 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

747 
jou∫Æ
->
j_Áûed_commô
 =

748 
√xt_commô_ID
;

749 
	`bªl£
(
bh
);

753 
	`bªl£
(
bh
);

754 
√xt_commô_ID
++;

757 
JBD3_REVOKE_BLOCK
:

760 i‡(
∑ss
 !
PASS_REVOKE
) {

761 
	`bªl£
(
bh
);

765 
îr
 = 
	`sˇn_ªvoke_ªc‹ds
(
jou∫Æ
, 
bh
,

766 
√xt_commô_ID
, 
öfo
);

767 
	`bªl£
(
bh
);

768 i‡(
îr
)

769 
Áûed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,Énd of scan.\n",

774 
blockty≥
);

775 
	`bªl£
(
bh
);

776 
d⁄e
;

780 
d⁄e
:

788 i‡(
∑ss
 =
PASS_SCAN
) {

789 i‡(!
öfo
->
íd_å™ß˘i⁄
)

790 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

794 i‡(
öfo
->
íd_å™ß˘i⁄
 !
√xt_commô_ID
) {

795 
	`¥ötk
(
KERN_ERR
 "JBD3:ÑecoveryÖass %dÉndedát "

797 
∑ss
, 
√xt_commô_ID
, 
öfo
->
íd_å™ß˘i⁄
);

798 i‡(!
suc˚ss
)

799 
suc˚ss
 = -
EIO
;

802 i‡(
block_îr‹
 && 
suc˚ss
 == 0)

803 
suc˚ss
 = -
EIO
;

804  
suc˚ss
;

806 
Áûed
:

807  
îr
;

808 
	}
}

812 
	$sˇn_ªvoke_ªc‹ds
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

813 
tid_t
 
£quí˚
, 
ªcovîy_öfo
 *
öfo
)

815 
jbd3_jou∫Æ_ªvoke_hódî_t
 *
hódî
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcou¡
;

819 
ªc‹d_Àn
 = 4;

821 
hódî
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
 *Ë
bh
->
b_d©a
;

822 
off£t
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
);

823 
rcou¡
 = 
	`be32_to_˝u
(
hódî
->
r_cou¡
);

825 i‡(!
	`jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ
, 
hódî
))

826  -
EFSBADCRC
;

828 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

829 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

830 i‡(
rcou¡
 > 
jou∫Æ
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcou¡
;

834 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

835 
ªc‹d_Àn
 = 8;

837 
off£t
 + 
ªc‹d_Àn
 <
max
) {

838 
blockƒ
;

839 
îr
;

841 i‡(
ªc‹d_Àn
 == 4)

842 
blockƒ
 = 
	`be32_to_˝u
(* ((
__be32
 *Ë(
bh
->
b_d©a
+
off£t
)));

844 
blockƒ
 = 
	`be64_to_˝u
(* ((
__be64
 *Ë(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +
ªc‹d_Àn
;

846 
îr
 = 
	`jbd3_jou∫Æ_£t_ªvoke
(
jou∫Æ
, 
blockƒ
, 
£quí˚
);

847 i‡(
îr
)

848  
îr
;

849 ++
öfo
->
ƒ_ªvokes
;

852 
	}
}

	@jbd3/revoke.c

80 #i‚de‡
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<löux/time.h
>

84 
	~<löux/fs.h
>

85 
	~<löux/jbd3.h
>

86 
	~<löux/î∫o.h
>

87 
	~<löux/¶ab.h
>

88 
	~<löux/li°.h
>

89 
	~<löux/öô.h
>

90 
	~<löux/bio.h
>

91 
	~<löux/log2.h
>

92 
	~<löux/hash.h
>

95 
kmem_ˇche
 *
	gjbd3_ªvoke_ªc‹d_ˇche
;

96 
kmem_ˇche
 *
	gjbd3_ªvoke_èbÀ_ˇche
;

102 
	sjbd3_ªvoke_ªc‹d_s


104 
li°_hód
 
	mhash
;

105 
tid_t
 
	m£quí˚
;

106 
	mblockƒ
;

111 
	sjbd3_ªvoke_èbÀ_s


115 
	mhash_size
;

116 
	mhash_shi·
;

117 
li°_hód
 *
	mhash_èbÀ
;

121 #ifde‡
__KERNEL__


122 
wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄_t
 *,

123 
li°_hód
 *,

124 
buf„r_hód
 **, *,

125 
jbd3_ªvoke_ªc‹d_s
 *);

126 
Êush_des¸ùt‹
(
jou∫Æ_t
 *, 
buf„r_hód
 *, );

131 
ölöe
 
	$hash
(
jou∫Æ_t
 *
jou∫Æ
, 
block
)

133  
	`hash_64
(
block
, 
jou∫Æ
->
j_ªvoke
->
hash_shi·
);

134 
	}
}

136 
	$ö£π_ªvoke_hash
(
jou∫Æ_t
 *
jou∫Æ
, 
blockƒ
,

137 
tid_t
 
£q
)

139 
li°_hód
 *
hash_li°
;

140 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

141 
gÂ_t
 
gÂ_mask
 = 
GFP_NOFS
;

143 i‡(
jou∫Æ_oom_ªåy
)

144 
gÂ_mask
 |
__GFP_NOFAIL
;

145 
ªc‹d
 = 
	`kmem_ˇche_Æloc
(
jbd3_ªvoke_ªc‹d_ˇche
, 
gÂ_mask
);

146 i‡(!
ªc‹d
)

147  -
ENOMEM
;

149 
ªc‹d
->
£quí˚
 = 
£q
;

150 
ªc‹d
->
blockƒ
 = blocknr;

151 
hash_li°
 = &
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
	`hash
(jou∫Æ, 
blockƒ
)];

152 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

153 
	`li°_add
(&
ªc‹d
->
hash
, 
hash_li°
);

154 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

156 
	}
}

160 
jbd3_ªvoke_ªc‹d_s
 *
	$föd_ªvoke_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

161 
blockƒ
)

163 
li°_hód
 *
hash_li°
;

164 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

166 
hash_li°
 = &
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
	`hash
(jou∫Æ, 
blockƒ
)];

168 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

169 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *Ë
hash_li°
->
√xt
;

170 &(
ªc‹d
->
hash
Ë!
hash_li°
) {

171 i‡(
ªc‹d
->
blockƒ
 == blocknr) {

172 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

173  
ªc‹d
;

175 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *Ëªc‹d->
hash
.
√xt
;

177 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd3_jou∫Æ_de°roy_ªvoke_ªc‹d_ˇche
()

183 
	`kmem_ˇche_de°roy
(
jbd3_ªvoke_ªc‹d_ˇche
);

184 
jbd3_ªvoke_ªc‹d_ˇche
 = 
NULL
;

185 
	}
}

187 
	$jbd3_jou∫Æ_de°roy_ªvoke_èbÀ_ˇche
()

189 
	`kmem_ˇche_de°roy
(
jbd3_ªvoke_èbÀ_ˇche
);

190 
jbd3_ªvoke_èbÀ_ˇche
 = 
NULL
;

191 
	}
}

193 
__öô
 
	$jbd3_jou∫Æ_öô_ªvoke_ªc‹d_ˇche
()

195 
	`J_ASSERT
(!
jbd3_ªvoke_ªc‹d_ˇche
);

196 
jbd3_ªvoke_ªc‹d_ˇche
 = 
	`KMEM_CACHE
(
jbd3_ªvoke_ªc‹d_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 i‡(!
jbd3_ªvoke_ªc‹d_ˇche
) {

200 
	`¥_emîg
("JBD3: failedÅo createÑevoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__öô
 
	$jbd3_jou∫Æ_öô_ªvoke_èbÀ_ˇche
()

208 
	`J_ASSERT
(!
jbd3_ªvoke_èbÀ_ˇche
);

209 
jbd3_ªvoke_èbÀ_ˇche
 = 
	`KMEM_CACHE
(
jbd3_ªvoke_èbÀ_s
,

210 
SLAB_TEMPORARY
);

211 i‡(!
jbd3_ªvoke_èbÀ_ˇche
) {

212 
	`¥_emîg
("JBD3: failedÅo createÑevoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd3_ªvoke_èbÀ_s
 *
	$jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
)

220 
shi·
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd3_ªvoke_èbÀ_s
 *
èbÀ
;

224 
èbÀ
 = 
	`kmem_ˇche_Æloc
(
jbd3_ªvoke_èbÀ_ˇche
, 
GFP_KERNEL
);

225 i‡(!
èbÀ
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shi·
++;

231 
èbÀ
->
hash_size
 = hash_size;

232 
èbÀ
->
hash_shi·
 = 
shi·
;

233 
èbÀ
->
hash_èbÀ
 =

234 
	`kmÆloc_¨øy
(
hash_size
, (
li°_hód
), 
GFP_KERNEL
);

235 i‡(!
èbÀ
->
hash_èbÀ
) {

236 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_èbÀ_ˇche
, 
èbÀ
);

237 
èbÀ
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;Åm∞< 
hash_size
;Åmp++)

242 
	`INIT_LIST_HEAD
(&
èbÀ
->
hash_èbÀ
[
tmp
]);

244 
out
:

245  
èbÀ
;

246 
	}
}

248 
	$jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jbd3_ªvoke_èbÀ_s
 *
èbÀ
)

250 
i
;

251 
li°_hód
 *
hash_li°
;

253 
i
 = 0; i < 
èbÀ
->
hash_size
; i++) {

254 
hash_li°
 = &
èbÀ
->
hash_èbÀ
[
i
];

255 
	`J_ASSERT
(
	`li°_em±y
(
hash_li°
));

258 
	`k‰ì
(
èbÀ
->
hash_èbÀ
);

259 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_èbÀ_ˇche
, 
èbÀ
);

260 
	}
}

263 
	$jbd3_jou∫Æ_öô_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
, 
hash_size
)

265 
	`J_ASSERT
(
jou∫Æ
->
j_ªvoke_èbÀ
[0] =
NULL
);

266 
	`J_ASSERT
(
	`is_powî_of_2
(
hash_size
));

268 
jou∫Æ
->
j_ªvoke_èbÀ
[0] = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
);

269 i‡(!
jou∫Æ
->
j_ªvoke_èbÀ
[0])

270 
Áû0
;

272 
jou∫Æ
->
j_ªvoke_èbÀ
[1] = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
);

273 i‡(!
jou∫Æ
->
j_ªvoke_èbÀ
[1])

274 
Áû1
;

276 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[1];

278 
	`•ö_lock_öô
(&
jou∫Æ
->
j_ªvoke_lock
);

282 
Áû1
:

283 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[0]);

284 
jou∫Æ
->
j_ªvoke_èbÀ
[0] = 
NULL
;

285 
Áû0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
)

292 
jou∫Æ
->
j_ªvoke
 = 
NULL
;

293 i‡(
jou∫Æ
->
j_ªvoke_èbÀ
[0])

294 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[0]);

295 i‡(
jou∫Æ
->
j_ªvoke_èbÀ
[1])

296 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[1]);

297 
	}
}

300 #ifde‡
__KERNEL__


326 
	$jbd3_jou∫Æ_ªvoke
(
h™dÀ_t
 *
h™dÀ
, 
blockƒ
,

327 
buf„r_hód
 *
bh_ö
)

329 
buf„r_hód
 *
bh
 = 
NULL
;

330 
jou∫Æ_t
 *
jou∫Æ
;

331 
block_devi˚
 *
bdev
;

332 
îr
;

334 
	`might_¶ìp
();

335 i‡(
bh_ö
)

336 
	`BUFFER_TRACE
(
bh_ö
, "enter");

338 
jou∫Æ
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
;

339 i‡(!
	`jbd3_jou∫Æ_£t_„©uªs
(
jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot setÑevoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jou∫Æ
->
j_fs_dev
;

345 
bh
 = 
bh_ö
;

347 i‡(!
bh
) {

348 
bh
 = 
	`__föd_gë_block
(
bdev
, 
blockƒ
, 
jou∫Æ
->
j_blocksize
);

349 i‡(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifde‡
JBD3_EXPENSIVE_CHECKING


354 
buf„r_hód
 *
bh2
;

358 
bh2
 = 
	`__föd_gë_block
(
bdev
, 
blockƒ
, 
jou∫Æ
->
j_blocksize
);

359 i‡(
bh2
) {

361 i‡(
bh2
 !
bh
 && 
	`buf„r_ªvokevÆid
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`buf„r_ªvoked
(bh2));

369 
	`put_bh
(
bh2
);

374 i‡(
	`WARN_ON_ONCE
(
h™dÀ
->
h_ªvoke_¸edôs
 <= 0)) {

375 i‡(!
bh_ö
)

376 
	`bªl£
(
bh
);

377  -
EIO
;

382 i‡(
bh
) {

383 i‡(!
	`J_EXPECT_BH
(
bh
, !
	`buf„r_ªvoked
(bh),

385 i‡(!
bh_ö
)

386 
	`bªl£
(
bh
);

387  -
EIO
;

389 
	`£t_buf„r_ªvoked
(
bh
);

390 
	`£t_buf„r_ªvokevÆid
(
bh
);

391 i‡(
bh_ö
) {

392 
	`BUFFER_TRACE
(
bh_ö
, "call jbd3_journal_forget");

393 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh_ö
);

395 
	`BUFFER_TRACE
(
bh
, "call brelse");

396 
	`__bªl£
(
bh
);

399 
h™dÀ
->
h_ªvoke_¸edôs
--;

401 
	`jbd_debug
(2, "ö£πÑevokêf‹ block %Œu, bh_ö=%p\n",
blockƒ
, 
bh_ö
);

402 
îr
 = 
	`ö£π_ªvoke_hash
(
jou∫Æ
, 
blockƒ
,

403 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
);

404 
	`BUFFER_TRACE
(
bh_ö
, "exit");

405  
îr
;

406 
	}
}

423 
	$jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ_t
 *
h™dÀ
, 
jou∫Æ_hód
 *
jh
)

425 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

426 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
;

427 
√ed_ˇn˚l
;

428 
did_ªvoke
 = 0;

429 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

431 
	`jbd_debug
(4, "jou∫Æ_hód %p, c™˚ŒögÑevoke\n", 
jh
);

437 i‡(
	`ã°_£t_buf„r_ªvokevÆid
(
bh
)) {

438 
√ed_ˇn˚l
 = 
	`ã°_˛ór_buf„r_ªvoked
(
bh
);

440 
√ed_ˇn˚l
 = 1;

441 
	`˛ór_buf„r_ªvoked
(
bh
);

444 i‡(
√ed_ˇn˚l
) {

445 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
bh
->
b_blockƒ
);

446 i‡(
ªc‹d
) {

447 
	`jbd_debug
(4, "cancelledÉxistingÑevoke on "

448 "blockƒ %Œu\n", ()
bh
->
b_blockƒ
);

449 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

450 
	`li°_dñ
(&
ªc‹d
->
hash
);

451 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

452 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

453 
did_ªvoke
 = 1;

457 #ifde‡
JBD3_EXPENSIVE_CHECKING


459 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
bh
->
b_blockƒ
);

460 
	`J_ASSERT_JH
(
jh
, 
ªc‹d
 =
NULL
);

467 i‡(
√ed_ˇn˚l
) {

468 
buf„r_hód
 *
bh2
;

469 
bh2
 = 
	`__föd_gë_block
(
bh
->
b_bdev
, bh->
b_blockƒ
, bh->
b_size
);

470 i‡(
bh2
) {

471 i‡(
bh2
 !
bh
)

472 
	`˛ór_buf„r_ªvoked
(
bh2
);

473 
	`__bªl£
(
bh2
);

476  
did_ªvoke
;

477 
	}
}

484 
	$jbd3_˛ór_buf„r_ªvoked_Êags
(
jou∫Æ_t
 *
jou∫Æ
)

486 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
 = 
jou∫Æ
->
j_ªvoke
;

487 
i
 = 0;

489 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

490 
li°_hód
 *
hash_li°
;

491 
li°_hód
 *
li°_íåy
;

492 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

494 
	`li°_f‹_óch
(
li°_íåy
, 
hash_li°
) {

495 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

496 
buf„r_hód
 *
bh
;

497 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *)
li°_íåy
;

498 
bh
 = 
	`__föd_gë_block
(
jou∫Æ
->
j_fs_dev
,

499 
ªc‹d
->
blockƒ
,

500 
jou∫Æ
->
j_blocksize
);

501 i‡(
bh
) {

502 
	`˛ór_buf„r_ªvoked
(
bh
);

503 
	`__bªl£
(
bh
);

507 
	}
}

513 
	$jbd3_jou∫Æ_swôch_ªvoke_èbÀ
(
jou∫Æ_t
 *
jou∫Æ
)

515 
i
;

517 i‡(
jou∫Æ
->
j_ªvoke
 =jou∫Æ->
j_ªvoke_èbÀ
[0])

518 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[1];

520 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[0];

522 
i
 = 0; i < 
jou∫Æ
->
j_ªvoke
->
hash_size
; i++)

523 
	`INIT_LIST_HEAD
(&
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
i
]);

524 
	}
}

530 
	$jbd3_jou∫Æ_wrôe_ªvoke_ªc‹ds
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

531 
li°_hód
 *
log_bufs
)

533 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

534 
buf„r_hód
 *
des¸ùt‹
;

535 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

536 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
;

537 
li°_hód
 *
hash_li°
;

538 
i
, 
off£t
, 
cou¡
;

540 
des¸ùt‹
 = 
NULL
;

541 
off£t
 = 0;

542 
cou¡
 = 0;

545 
ªvoke
 = 
jou∫Æ
->
j_ªvoke
 =jou∫Æ->
j_ªvoke_èbÀ
[0] ?

546 
jou∫Æ
->
j_ªvoke_èbÀ
[1] : journal->j_revoke_table[0];

548 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

549 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

551 !
	`li°_em±y
(
hash_li°
)) {

552 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *)

553 
hash_li°
->
√xt
;

554 
	`wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄
, 
log_bufs
,

555 &
des¸ùt‹
, &
off£t
, 
ªc‹d
);

556 
cou¡
++;

557 
	`li°_dñ
(&
ªc‹d
->
hash
);

558 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

561 i‡(
des¸ùt‹
)

562 
	`Êush_des¸ùt‹
(
jou∫Æ
, 
des¸ùt‹
, 
off£t
);

563 
	`jbd_debug
(1, "WrŸê%dÑevokêªc‹ds\n", 
cou¡
);

564 
	}
}

571 
	$wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

572 
li°_hód
 *
log_bufs
,

573 
buf„r_hód
 **
des¸ùt‹p
,

574 *
off£ç
,

575 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
)

577 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

578 
csum_size
 = 0;

579 
buf„r_hód
 *
des¸ùt‹
;

580 
sz
, 
off£t
;

586 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

589 
des¸ùt‹
 = *
des¸ùt‹p
;

590 
off£t
 = *
off£ç
;

593 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

594 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

596 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

597 
sz
 = 8;

599 
sz
 = 4;

602 i‡(
des¸ùt‹
) {

603 i‡(
off£t
 + 
sz
 > 
jou∫Æ
->
j_blocksize
 - 
csum_size
) {

604 
	`Êush_des¸ùt‹
(
jou∫Æ
, 
des¸ùt‹
, 
off£t
);

605 
des¸ùt‹
 = 
NULL
;

609 i‡(!
des¸ùt‹
) {

610 
des¸ùt‹
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
å™ß˘i⁄
,

611 
JBD3_REVOKE_BLOCK
);

612 i‡(!
des¸ùt‹
)

616 
	`BUFFER_TRACE
(
des¸ùt‹
, "file inÜog_bufs");

617 
	`jbd3_fûe_log_bh
(
log_bufs
, 
des¸ùt‹
);

619 
off£t
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
);

620 *
des¸ùt‹p
 = 
des¸ùt‹
;

623 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

624 * ((
__be64
 *)(&
des¸ùt‹
->
b_d©a
[
off£t
])) =

625 
	`˝u_to_be64
(
ªc‹d
->
blockƒ
);

627 * ((
__be32
 *)(&
des¸ùt‹
->
b_d©a
[
off£t
])) =

628 
	`˝u_to_be32
(
ªc‹d
->
blockƒ
);

629 
off£t
 +
sz
;

631 *
off£ç
 = 
off£t
;

632 
	}
}

641 
	$Êush_des¸ùt‹
(
jou∫Æ_t
 *
jou∫Æ
,

642 
buf„r_hód
 *
des¸ùt‹
,

643 
off£t
)

645 
jbd3_jou∫Æ_ªvoke_hódî_t
 *
hódî
;

647 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

650 
hódî
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
 *)
des¸ùt‹
->
b_d©a
;

651 
hódî
->
r_cou¡
 = 
	`˝u_to_be32
(
off£t
);

652 
	`jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ
, 
des¸ùt‹
);

654 
	`£t_buf„r_jwrôe
(
des¸ùt‹
);

655 
	`BUFFER_TRACE
(
des¸ùt‹
, "write");

656 
	`£t_buf„r_dúty
(
des¸ùt‹
);

657 
	`wrôe_dúty_buf„r
(
des¸ùt‹
, 
REQ_SYNC
);

658 
	}
}

683 
	$jbd3_jou∫Æ_£t_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
,

684 
blockƒ
,

685 
tid_t
 
£quí˚
)

687 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

689 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
blockƒ
);

690 i‡(
ªc‹d
) {

693 i‡(
	`tid_gt
(
£quí˚
, 
ªc‹d
->sequence))

694 
ªc‹d
->
£quí˚
 = sequence;

697  
	`ö£π_ªvoke_hash
(
jou∫Æ
, 
blockƒ
, 
£quí˚
);

698 
	}
}

707 
	$jbd3_jou∫Æ_ã°_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
,

708 
blockƒ
,

709 
tid_t
 
£quí˚
)

711 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

713 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
blockƒ
);

714 i‡(!
ªc‹d
)

716 i‡(
	`tid_gt
(
£quí˚
, 
ªc‹d
->sequence))

719 
	}
}

726 
	$jbd3_jou∫Æ_˛ór_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
)

728 
i
;

729 
li°_hód
 *
hash_li°
;

730 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

731 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
;

733 
ªvoke
 = 
jou∫Æ
->
j_ªvoke
;

735 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

736 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

737 !
	`li°_em±y
(
hash_li°
)) {

738 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
*Ë
hash_li°
->
√xt
;

739 
	`li°_dñ
(&
ªc‹d
->
hash
);

740 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

743 
	}
}

	@jbd3/transaction.c

17 
	~<löux/time.h
>

18 
	~<löux/fs.h
>

19 
	~<löux/jbd3.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/timî.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/highmem.h
>

25 
	~<löux/hπimî.h
>

26 
	~<löux/backög-dev.h
>

27 
	~<löux/bug.h
>

28 
	~<löux/moduÀ.h
>

29 
	~<löux/sched/mm.h
>

31 
	~<åa˚/evíts/jbd3.h
>

33 
__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jou∫Æ_hód
 *
jh
);

34 
__jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_hód
 *
jh
);

36 
kmem_ˇche
 *
	gå™ß˘i⁄_ˇche
;

37 
__öô
 
	$jbd3_jou∫Æ_öô_å™ß˘i⁄_ˇche
()

39 
	`J_ASSERT
(!
å™ß˘i⁄_ˇche
);

40 
å™ß˘i⁄_ˇche
 = 
	`kmem_ˇche_¸óã
("jbd3_transaction_s",

41 (
å™ß˘i⁄_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 i‡(!
å™ß˘i⁄_ˇche
) {

46 
	`¥_emîg
("JBD3: failedÅo createÅransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd3_jou∫Æ_de°roy_å™ß˘i⁄_ˇche
()

54 
	`kmem_ˇche_de°roy
(
å™ß˘i⁄_ˇche
);

55 
å™ß˘i⁄_ˇche
 = 
NULL
;

56 
	}
}

58 
	$jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

60 i‡(
	`u∆ikñy
(
	`ZERO_OR_NULL_PTR
(
å™ß˘i⁄
)))

62 
	`kmem_ˇche_‰ì
(
å™ß˘i⁄_ˇche
, 
å™ß˘i⁄
);

63 
	}
}

68 
	$jbd3_des¸ùt‹_blocks_≥r_å™s
(
jou∫Æ_t
 *
jou∫Æ
)

70 
èg_•a˚
 = 
jou∫Æ
->
j_blocksize
 - (
jou∫Æ_hódî_t
);

71 
ègs_≥r_block
;

74 
èg_•a˚
 -= 16;

75 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

76 
èg_•a˚
 -(
jbd3_jou∫Æ_block_èû
);

78 
ègs_≥r_block
 = (
èg_•a˚
 - 16Ë/ 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

83  1 + 
	`DIV_ROUND_UP
(
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
,

84 
ègs_≥r_block
);

85 
	}
}

102 
	$jbd3_gë_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
,

103 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

105 
å™ß˘i⁄
->
t_jou∫Æ
 = 
jou∫Æ
;

106 
å™ß˘i⁄
->
t_°©e
 = 
T_RUNNING
;

107 
å™ß˘i⁄
->
t_°¨t_time
 = 
	`ktime_gë
();

108 
å™ß˘i⁄
->
t_tid
 = 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
++;

109 
å™ß˘i⁄
->
t_expúes
 = 
jiffõs
 + 
jou∫Æ
->
j_commô_öãrvÆ
;

110 
	`•ö_lock_öô
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

111 
	`©omic_£t
(&
å™ß˘i⁄
->
t_upd©es
, 0);

112 
	`©omic_£t
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
,

113 
	`jbd3_des¸ùt‹_blocks_≥r_å™s
(
jou∫Æ
) +

114 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
));

115 
	`©omic_£t
(&
å™ß˘i⁄
->
t_out°™dög_ªvokes
, 0);

116 
	`©omic_£t
(&
å™ß˘i⁄
->
t_h™dÀ_cou¡
, 0);

117 
	`INIT_LIST_HEAD
(&
å™ß˘i⁄
->
t_öode_li°
);

118 
	`INIT_LIST_HEAD
(&
å™ß˘i⁄
->
t_¥iv©e_li°
);

121 
jou∫Æ
->
j_commô_timî
.
expúes
 = 
	`round_jiffõs_up
(
å™ß˘i⁄
->
t_expúes
);

122 
	`add_timî
(&
jou∫Æ
->
j_commô_timî
);

124 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 =
NULL
);

125 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 = 
å™ß˘i⁄
;

126 
å™ß˘i⁄
->
t_max_waô
 = 0;

127 
å™ß˘i⁄
->
t_°¨t
 = 
jiffõs
;

128 
å™ß˘i⁄
->
t_ªque°ed
 = 0;

129 
	}
}

149 
ölöe
 
	$upd©e_t_max_waô
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

150 
ts
)

152 #ifde‡
CONFIG_JBD3_DEBUG


153 i‡(
jbd3_jou∫Æ_íabÀ_debug
 &&

154 
	`time_a·î
(
å™ß˘i⁄
->
t_°¨t
, 
ts
)) {

155 
ts
 = 
	`jbd3_time_diff
—s, 
å™ß˘i⁄
->
t_°¨t
);

156 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

157 i‡(
ts
 > 
å™ß˘i⁄
->
t_max_waô
)

158 
å™ß˘i⁄
->
t_max_waô
 = 
ts
;

159 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

162 
	}
}

169 
	$waô_å™ß˘i⁄_locked
(
jou∫Æ_t
 *
jou∫Æ
)

170 
	`__ªÀa£s
(
jou∫Æ
->
j_°©e_lock
)

172 
	`DEFINE_WAIT
(
waô
);

173 
√ed_to_°¨t
;

174 
tid_t
 
tid
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
;

176 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
,

177 
TASK_UNINTERRUPTIBLE
);

178 
√ed_to_°¨t
 = !
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
);

179 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

180 i‡(
√ed_to_°¨t
)

181 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

182 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

183 
	`scheduÀ
();

184 
	`föish_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
);

185 
	}
}

192 
	$waô_å™ß˘i⁄_swôchög
(
jou∫Æ_t
 *
jou∫Æ
)

193 
	`__ªÀa£s
(
jou∫Æ
->
j_°©e_lock
)

195 
	`DEFINE_WAIT
(
waô
);

197 i‡(
	`WARN_ON
(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ||

198 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_°©e
 !
T_SWITCH
))

200 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
,

201 
TASK_UNINTERRUPTIBLE
);

202 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

209 
	`scheduÀ
();

210 
	`föish_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
);

211 
	}
}

213 
	$sub_ª£rved_¸edôs
(
jou∫Æ_t
 *
jou∫Æ
, 
blocks
)

215 
	`©omic_sub
(
blocks
, &
jou∫Æ
->
j_ª£rved_¸edôs
);

216 
	`wake_up
(&
jou∫Æ
->
j_waô_ª£rved
);

217 
	}
}

225 
	$add_å™ß˘i⁄_¸edôs
(
jou∫Æ_t
 *
jou∫Æ
, 
blocks
,

226 
rsv_blocks
)

228 
å™ß˘i⁄_t
 *
t
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

229 
√eded
;

230 
tŸÆ
 = 
blocks
 + 
rsv_blocks
;

236 i‡(
t
->
t_°©e
 !
T_RUNNING
) {

237 
	`WARN_ON_ONCE
(
t
->
t_°©e
 >
T_FLUSH
);

238 
	`waô_å™ß˘i⁄_locked
(
jou∫Æ
);

247 
√eded
 = 
	`©omic_add_ªtu∫
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

248 i‡(
√eded
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

254 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

260 i‡(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
tŸÆ
 >

261 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

262 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

263 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

264 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

265 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
tŸÆ
 <=

266 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

270 
	`waô_å™ß˘i⁄_locked
(
jou∫Æ
);

285 i‡(
	`jbd3_log_•a˚_À·
(
jou∫Æ
Ë< jou∫Æ->
j_max_å™ß˘i⁄_buf„rs
) {

286 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

287 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

288 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

289 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

290 i‡(
	`jbd3_log_•a˚_À·
(
jou∫Æ
) <

291 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
)

292 
	`__jbd3_log_waô_f‹_•a˚
(
jou∫Æ
);

293 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

298 i‡(!
rsv_blocks
)

301 
√eded
 = 
	`©omic_add_ªtu∫
(
rsv_blocks
, &
jou∫Æ
->
j_ª£rved_¸edôs
);

303 i‡(
√eded
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2) {

304 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
rsv_blocks
);

305 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

306 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

307 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

308 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

309 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
rsv_blocks


310 <
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2);

314 
	}
}

323 
	$°¨t_this_h™dÀ
(
jou∫Æ_t
 *
jou∫Æ
, 
h™dÀ_t
 *
h™dÀ
,

324 
gÂ_t
 
gÂ_mask
)

326 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, *
√w_å™ß˘i⁄
 = 
NULL
;

327 
blocks
 = 
h™dÀ
->
h_tŸÆ_¸edôs
;

328 
rsv_blocks
 = 0;

329 
ts
 = 
jiffõs
;

331 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

332 
rsv_blocks
 = 
h™dÀ
->
h_rsv_h™dÀ
->
h_tŸÆ_¸edôs
;

339 i‡((
rsv_blocks
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2) ||

340 (
rsv_blocks
 + 
blocks
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
)) {

341 
	`¥ötk
(
KERN_ERR
 "JBD3: %s wantsÅoo many credits "

343 
cuºít
->
comm
, 
blocks
, 
rsv_blocks
,

344 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

345 
	`WARN_ON
(1);

346  -
ENOSPC
;

349 
Æloc_å™ß˘i⁄
:

350 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

355 i‡((
gÂ_mask
 & 
__GFP_FS
) == 0)

356 
gÂ_mask
 |
__GFP_NOFAIL
;

357 
√w_å™ß˘i⁄
 = 
	`kmem_ˇche_zÆloc
(
å™ß˘i⁄_ˇche
,

358 
gÂ_mask
);

359 i‡(!
√w_å™ß˘i⁄
)

360  -
ENOMEM
;

363 
	`jbd_debug
(3, "New h™dÀ %∞goögÜive.\n", 
h™dÀ
);

369 
ª≥©
:

370 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

371 
	`BUG_ON
(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
);

372 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
) ||

373 (
jou∫Æ
->
j_î∫o
 !0 && !(jou∫Æ->
j_Êags
 & 
JBD3_ACK_ERR
))) {

374 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

375 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
√w_å™ß˘i⁄
);

376  -
EROFS
;

384 i‡(!
h™dÀ
->
h_ª£rved
 && 
jou∫Æ
->
j_b¨rõr_cou¡
) {

385 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

386 
	`waô_evít
(
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
,

387 
jou∫Æ
->
j_b¨rõr_cou¡
 == 0);

388 
ª≥©
;

391 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

392 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

393 i‡(!
√w_å™ß˘i⁄
)

394 
Æloc_å™ß˘i⁄
;

395 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

396 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

397 (
h™dÀ
->
h_ª£rved
 || !
jou∫Æ
->
j_b¨rõr_cou¡
)) {

398 
	`jbd3_gë_å™ß˘i⁄
(
jou∫Æ
, 
√w_å™ß˘i⁄
);

399 
√w_å™ß˘i⁄
 = 
NULL
;

401 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

402 
ª≥©
;

405 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

407 i‡(!
h™dÀ
->
h_ª£rved
) {

409 i‡(
	`add_å™ß˘i⁄_¸edôs
(
jou∫Æ
, 
blocks
, 
rsv_blocks
))

410 
ª≥©
;

419 i‡(
å™ß˘i⁄
->
t_°©e
 =
T_SWITCH
) {

420 
	`waô_å™ß˘i⁄_swôchög
(
jou∫Æ
);

421 
ª≥©
;

423 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
blocks
);

424 
h™dÀ
->
h_ª£rved
 = 0;

430 
	`upd©e_t_max_waô
(
å™ß˘i⁄
, 
ts
);

431 
h™dÀ
->
h_å™ß˘i⁄
 = 
å™ß˘i⁄
;

432 
h™dÀ
->
h_ªque°ed_¸edôs
 = 
blocks
;

433 
h™dÀ
->
h_ªvoke_¸edôs_ªque°ed
 = h™dÀ->
h_ªvoke_¸edôs
;

434 
h™dÀ
->
h_°¨t_jiffõs
 = 
jiffõs
;

435 
	`©omic_öc
(&
å™ß˘i⁄
->
t_upd©es
);

436 
	`©omic_öc
(&
å™ß˘i⁄
->
t_h™dÀ_cou¡
);

437 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

438 
h™dÀ
, 
blocks
,

439 
	`©omic_ªad
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
),

440 
	`jbd3_log_•a˚_À·
(
jou∫Æ
));

441 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

442 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

444 
	`rw£m_acquúe_ªad
(&
jou∫Æ
->
j_å™s_commô_m≠
, 0, 0, 
_THIS_IP_
);

445 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
√w_å™ß˘i⁄
);

450 
h™dÀ
->
ßved_Æloc_c⁄ãxt
 = 
	`memÆloc_nofs_ßve
();

452 
	}
}

455 
h™dÀ_t
 *
	$√w_h™dÀ
(
nblocks
)

457 
h™dÀ_t
 *
h™dÀ
 = 
	`jbd3_Æloc_h™dÀ
(
GFP_NOFS
);

458 i‡(!
h™dÀ
)

459  
NULL
;

460 
h™dÀ
->
h_tŸÆ_¸edôs
 = 
nblocks
;

461 
h™dÀ
->
h_ªf
 = 1;

463  
h™dÀ
;

464 
	}
}

466 
h™dÀ_t
 *
	$jbd3__jou∫Æ_°¨t
(
jou∫Æ_t
 *
jou∫Æ
, 
nblocks
, 
rsv_blocks
,

467 
ªvoke_ªc‹ds
, 
gÂ_t
 
gÂ_mask
,

468 
ty≥
, 
löe_no
)

470 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

471 
îr
;

473 i‡(!
jou∫Æ
)

474  
	`ERR_PTR
(-
EROFS
);

476 i‡(
h™dÀ
) {

477 
	`J_ASSERT
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
 =
jou∫Æ
);

478 
h™dÀ
->
h_ªf
++;

479  
h™dÀ
;

482 
nblocks
 +
	`DIV_ROUND_UP
(
ªvoke_ªc‹ds
,

483 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
);

484 
h™dÀ
 = 
	`√w_h™dÀ
(
nblocks
);

485 i‡(!
h™dÀ
)

486  
	`ERR_PTR
(-
ENOMEM
);

487 i‡(
rsv_blocks
) {

488 
h™dÀ_t
 *
rsv_h™dÀ
;

490 
rsv_h™dÀ
 = 
	`√w_h™dÀ
(
rsv_blocks
);

491 i‡(!
rsv_h™dÀ
) {

492 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

493  
	`ERR_PTR
(-
ENOMEM
);

495 
rsv_h™dÀ
->
h_ª£rved
 = 1;

496 
rsv_h™dÀ
->
h_jou∫Æ
 = 
jou∫Æ
;

497 
h™dÀ
->
h_rsv_h™dÀ
 = 
rsv_h™dÀ
;

499 
h™dÀ
->
h_ªvoke_¸edôs
 = 
ªvoke_ªc‹ds
;

501 
îr
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
gÂ_mask
);

502 i‡(
îr
 < 0) {

503 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

504 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
->
h_rsv_h™dÀ
);

505 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

506  
	`ERR_PTR
(
îr
);

508 
h™dÀ
->
h_ty≥
 = 
ty≥
;

509 
h™dÀ
->
h_löe_no
 = 
löe_no
;

510 
	`åa˚_jbd3_h™dÀ_°¨t
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

511 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
, 
ty≥
,

512 
löe_no
, 
nblocks
);

514  
h™dÀ
;

515 
	}
}

516 
EXPORT_SYMBOL
(
jbd3__jou∫Æ_°¨t
);

538 
h™dÀ_t
 *
	$jbd3_jou∫Æ_°¨t
(
jou∫Æ_t
 *
jou∫Æ
, 
nblocks
)

540  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
nblocks
, 0, 0, 
GFP_NOFS
, 0, 0);

541 
	}
}

542 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t
);

544 
	$__jbd3_jou∫Æ_uƒe£rve_h™dÀ
(
h™dÀ_t
 *
h™dÀ
)

546 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_jou∫Æ
;

548 
	`WARN_ON
(!
h™dÀ
->
h_ª£rved
);

549 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
h™dÀ
->
h_tŸÆ_¸edôs
);

550 
	}
}

552 
	$jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

554 
	`__jbd3_jou∫Æ_uƒe£rve_h™dÀ
(
h™dÀ
);

555 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

556 
	}
}

557 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_‰ì_ª£rved
);

573 
	$jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
ty≥
,

574 
löe_no
)

576 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_jou∫Æ
;

577 
ªt
 = -
EIO
;

579 i‡(
	`WARN_ON
(!
h™dÀ
->
h_ª£rved
)) {

581 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

582  
ªt
;

588 i‡(
	`WARN_ON
(
cuºít
->
jou∫Æ_öfo
)) {

589 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

590  
ªt
;

593 
h™dÀ
->
h_jou∫Æ
 = 
NULL
;

598 
ªt
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
GFP_NOFS
);

599 i‡(
ªt
 < 0) {

600 
h™dÀ
->
h_jou∫Æ
 = 
jou∫Æ
;

601 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

602  
ªt
;

604 
h™dÀ
->
h_ty≥
 = 
ty≥
;

605 
h™dÀ
->
h_löe_no
 = 
löe_no
;

606 
	`åa˚_jbd3_h™dÀ_°¨t
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

607 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
, 
ty≥
,

608 
löe_no
, 
h™dÀ
->
h_tŸÆ_¸edôs
);

610 
	}
}

611 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t_ª£rved
);

634 
	$jbd3_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
, 
ªvoke_ªc‹ds
)

636 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

637 
jou∫Æ_t
 *
jou∫Æ
;

638 
ªsu…
;

639 
w™ãd
;

641 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

642  -
EROFS
;

643 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

645 
ªsu…
 = 1;

647 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

650 i‡(
å™ß˘i⁄
->
t_°©e
 !
T_RUNNING
) {

651 
	`jbd_debug
(3, "denied handle %p %d blocks: "

652 "å™ß˘i⁄ÇŸÑu¬ög\n", 
h™dÀ
, 
nblocks
);

653 
îr‹_out
;

656 
nblocks
 +
	`DIV_ROUND_UP
(

657 
h™dÀ
->
h_ªvoke_¸edôs_ªque°ed
 + 
ªvoke_ªc‹ds
,

658 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
) -

659 
	`DIV_ROUND_UP
(

660 
h™dÀ
->
h_ªvoke_¸edôs_ªque°ed
,

661 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
);

662 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

663 
w™ãd
 = 
	`©omic_add_ªtu∫
(
nblocks
,

664 &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

666 i‡(
w™ãd
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

667 
	`jbd_debug
(3, "denied handle %p %d blocks: "

668 "å™ß˘i⁄Åoÿœrge\n", 
h™dÀ
, 
nblocks
);

669 
	`©omic_sub
(
nblocks
, &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

670 
u∆ock
;

673 
	`åa˚_jbd3_h™dÀ_exãnd
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

674 
å™ß˘i⁄
->
t_tid
,

675 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

676 
h™dÀ
->
h_tŸÆ_¸edôs
,

677 
nblocks
);

679 
h™dÀ
->
h_tŸÆ_¸edôs
 +
nblocks
;

680 
h™dÀ
->
h_ªque°ed_¸edôs
 +
nblocks
;

681 
h™dÀ
->
h_ªvoke_¸edôs
 +
ªvoke_ªc‹ds
;

682 
h™dÀ
->
h_ªvoke_¸edôs_ªque°ed
 +
ªvoke_ªc‹ds
;

683 
ªsu…
 = 0;

685 
	`jbd_debug
(3, "exãnded h™dÀ %∞by %d\n", 
h™dÀ
, 
nblocks
);

686 
u∆ock
:

687 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

688 
îr‹_out
:

689 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

690  
ªsu…
;

691 
	}
}

693 
	$°›_this_h™dÀ
(
h™dÀ_t
 *
h™dÀ
)

695 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

696 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

697 
ªvokes
;

699 
	`J_ASSERT
(
	`jou∫Æ_cuºít_h™dÀ
(Ë=
h™dÀ
);

700 
	`J_ASSERT
(
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
) > 0);

701 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

708 
ªvokes
 = 
h™dÀ
->
h_ªvoke_¸edôs_ªque°ed
 - h™dÀ->
h_ªvoke_¸edôs
;

709 i‡(
ªvokes
) {

710 
t_ªvokes
, 
ªvoke_des¸ùt‹s
;

711 
º_≥r_blk
 = 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
;

713 
	`WARN_ON_ONCE
(
	`DIV_ROUND_UP
(
ªvokes
, 
º_≥r_blk
)

714 > 
h™dÀ
->
h_tŸÆ_¸edôs
);

715 
t_ªvokes
 = 
	`©omic_add_ªtu∫
(
ªvokes
,

716 &
å™ß˘i⁄
->
t_out°™dög_ªvokes
);

717 
ªvoke_des¸ùt‹s
 =

718 
	`DIV_ROUND_UP
(
t_ªvokes
, 
º_≥r_blk
) -

719 
	`DIV_ROUND_UP
(
t_ªvokes
 - 
ªvokes
, 
º_≥r_blk
);

720 
h™dÀ
->
h_tŸÆ_¸edôs
 -
ªvoke_des¸ùt‹s
;

722 
	`©omic_sub
(
h™dÀ
->
h_tŸÆ_¸edôs
,

723 &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

724 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

725 
	`__jbd3_jou∫Æ_uƒe£rve_h™dÀ
(
h™dÀ
->
h_rsv_h™dÀ
);

726 i‡(
	`©omic_dec_™d_ã°
(&
å™ß˘i⁄
->
t_upd©es
))

727 
	`wake_up
(&
jou∫Æ
->
j_waô_upd©es
);

729 
	`rw£m_ªÀa£
(&
jou∫Æ
->
j_å™s_commô_m≠
, 
_THIS_IP_
);

734 
	`memÆloc_nofs_ª°‹e
(
h™dÀ
->
ßved_Æloc_c⁄ãxt
);

735 
	}
}

754 
	$jbd3__jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
, 
ªvoke_ªc‹ds
,

755 
gÂ_t
 
gÂ_mask
)

757 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

758 
jou∫Æ_t
 *
jou∫Æ
;

759 
tid_t
 
tid
;

760 
√ed_to_°¨t
;

761 
ªt
;

765 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

767 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

768 
tid
 = 
å™ß˘i⁄
->
t_tid
;

774 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

775 
	`°›_this_h™dÀ
(
h™dÀ
);

776 
h™dÀ
->
h_å™ß˘i⁄
 = 
NULL
;

782 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

783 
√ed_to_°¨t
 = !
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
);

784 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

785 i‡(
√ed_to_°¨t
)

786 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

787 
h™dÀ
->
h_tŸÆ_¸edôs
 = 
nblocks
 +

788 
	`DIV_ROUND_UP
(
ªvoke_ªc‹ds
,

789 
jou∫Æ
->
j_ªvoke_ªc‹ds_≥r_block
);

790 
h™dÀ
->
h_ªvoke_¸edôs
 = 
ªvoke_ªc‹ds
;

791 
ªt
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
gÂ_mask
);

792 
	`åa˚_jbd3_h™dÀ_ª°¨t
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

793 
ªt
 ? 0 : 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
,

794 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

795 
h™dÀ
->
h_tŸÆ_¸edôs
);

796  
ªt
;

797 
	}
}

798 
EXPORT_SYMBOL
(
jbd3__jou∫Æ_ª°¨t
);

801 
	$jbd3_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

803  
	`jbd3__jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
, 0, 
GFP_NOFS
);

804 
	}
}

805 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ª°¨t
);

817 
	$jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ_t
 *
jou∫Æ
)

819 
	`DEFINE_WAIT
(
waô
);

821 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

823 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

824 ++
jou∫Æ
->
j_b¨rõr_cou¡
;

827 i‡(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
)) {

828 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

829 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

830 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
) == 0);

831 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

836 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

838 i‡(!
å™ß˘i⁄
)

841 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

842 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
,

843 
TASK_UNINTERRUPTIBLE
);

844 i‡(!
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
)) {

845 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

846 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

849 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

850 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

851 
	`scheduÀ
();

852 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

853 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

855 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

863 
	`muãx_lock
(&
jou∫Æ
->
j_b¨rõr
);

864 
	}
}

874 
	$jbd3_jou∫Æ_u∆ock_upd©es
 (
jou∫Æ_t
 *
jou∫Æ
)

876 
	`J_ASSERT
(
jou∫Æ
->
j_b¨rõr_cou¡
 != 0);

878 
	`muãx_u∆ock
(&
jou∫Æ
->
j_b¨rõr
);

879 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

880 --
jou∫Æ
->
j_b¨rõr_cou¡
;

881 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

882 
	`wake_up
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

883 
	}
}

885 
	$w¨n_dúty_buf„r
(
buf„r_hód
 *
bh
)

887 
	`¥ötk
(
KERN_WARNING


891 
bh
->
b_bdev
, ()bh->
b_blockƒ
);

892 
	}
}

895 
	$jbd3_‰ìze_jh_d©a
(
jou∫Æ_hód
 *
jh
)

897 
∑ge
 *page;

898 
off£t
;

899 *
sour˚
;

900 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

902 
	`J_EXPECT_JH
(
jh
, 
	`buf„r_u±od©e
(
bh
), "Possible IO failure.\n");

903 
∑ge
 = 
bh
->
b_∑ge
;

904 
off£t
 = 
	`off£t_ö_∑ge
(
bh
->
b_d©a
);

905 
sour˚
 = 
	`km≠_©omic
(
∑ge
);

907 
	`jbd3_buf„r_‰ozí_åiggî
(
jh
, 
sour˚
 + 
off£t
, jh->
b_åiggîs
);

908 
	`mem˝y
(
jh
->
b_‰ozí_d©a
, 
sour˚
 + 
off£t
, 
bh
->
b_size
);

909 
	`kunm≠_©omic
(
sour˚
);

915 
jh
->
b_‰ozí_åiggîs
 = jh->
b_åiggîs
;

916 
	}
}

929 
	$do_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
jou∫Æ_hód
 *
jh
,

930 
f‹˚_c›y
)

932 
buf„r_hód
 *
bh
;

933 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

934 
jou∫Æ_t
 *
jou∫Æ
;

935 
îr‹
;

936 *
‰ozí_buf„r
 = 
NULL
;

937 
°¨t_lock
, 
time_lock
;

939 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

941 
	`jbd_debug
(5, "jou∫Æ_hód %p, f‹˚_c›y %d\n", 
jh
, 
f‹˚_c›y
);

943 
	`JBUFFER_TRACE
(
jh
, "entry");

944 
ª≥©
:

945 
bh
 = 
	`jh2bh
(
jh
);

949 
°¨t_lock
 = 
jiffõs
;

950 
	`lock_buf„r
(
bh
);

951 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

954 
time_lock
 = 
	`jbd3_time_diff
(
°¨t_lock
, 
jiffõs
);

955 i‡(
time_lock
 > 
HZ
/10)

956 
	`åa˚_jbd3_lock_buf„r_°Æl
(
bh
->
b_bdev
->
bd_dev
,

957 
	`jiffõs_to_m£cs
(
time_lock
));

972 i‡(
	`buf„r_dúty
(
bh
)) {

977 i‡(
jh
->
b_å™ß˘i⁄
) {

978 
	`J_ASSERT_JH
(
jh
,

979 
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

980 
jh
->
b_å™ß˘i⁄
 ==

981 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

982 i‡(
jh
->
b_√xt_å™ß˘i⁄
)

983 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 ==

984 
å™ß˘i⁄
);

985 
	`w¨n_dúty_buf„r
(
bh
);

992 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

993 
	`˛ór_buf„r_dúty
(
bh
);

994 
	`£t_buf„r_jbddúty
(
bh
);

997 
	`u∆ock_buf„r
(
bh
);

999 
îr‹
 = -
EROFS
;

1000 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
)) {

1001 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1002 
out
;

1004 
îr‹
 = 0;

1010 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

1011 
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
)

1012 
d⁄e
;

1018 
jh
->
b_modifõd
 = 0;

1025 i‡(!
jh
->
b_å™ß˘i⁄
) {

1026 
	`JBUFFER_TRACE
(
jh
, "noÅransaction");

1027 
	`J_ASSERT_JH
(
jh
, !jh->
b_√xt_å™ß˘i⁄
);

1028 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Reserved");

1034 
	`smp_wmb
();

1035 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1036 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Re£rved
);

1037 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1038 
d⁄e
;

1044 i‡(
jh
->
b_‰ozí_d©a
) {

1045 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

1046 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

1047 
©èch_√xt
;

1050 
	`JBUFFER_TRACE
(
jh
, "owned by olderÅransaction");

1051 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

1052 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

1063 i‡(
	`buf„r_shadow
(
bh
)) {

1064 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

1065 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1066 
	`waô_⁄_bô_io
(&
bh
->
b_°©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

1067 
ª≥©
;

1082 i‡(
jh
->
b_jli°
 =
BJ_Mëad©a
 || 
f‹˚_c›y
) {

1083 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1084 i‡(!
‰ozí_buf„r
) {

1085 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1086 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1087 
‰ozí_buf„r
 = 
	`jbd3_Æloc
(
	`jh2bh
(
jh
)->
b_size
,

1088 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1089 
ª≥©
;

1091 
jh
->
b_‰ozí_d©a
 = 
‰ozí_buf„r
;

1092 
‰ozí_buf„r
 = 
NULL
;

1093 
	`jbd3_‰ìze_jh_d©a
(
jh
);

1095 
©èch_√xt
:

1101 
	`smp_wmb
();

1102 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1104 
d⁄e
:

1105 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1111 
	`jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ
, 
jh
);

1113 
out
:

1114 i‡(
	`u∆ikñy
(
‰ozí_buf„r
))

1115 
	`jbd3_‰ì
(
‰ozí_buf„r
, 
bh
->
b_size
);

1117 
	`JBUFFER_TRACE
(
jh
, "exit");

1118  
îr‹
;

1119 
	}
}

1122 
boﬁ
 
	$jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
,

1123 
boﬁ
 
undo
)

1125 
jou∫Æ_hód
 *
jh
;

1126 
boﬁ
 
ªt
 = 
Ál£
;

1129 i‡(
	`buf„r_dúty
(
bh
))

1130  
Ál£
;

1143 
	`rcu_ªad_lock
();

1144 i‡(!
	`buf„r_jbd
(
bh
))

1145 
out
;

1147 
jh
 = 
	`READ_ONCE
(
bh
->
b_¥iv©e
);

1148 i‡(!
jh
)

1149 
out
;

1151 i‡(
undo
 && !
jh
->
b_commôãd_d©a
)

1152 
out
;

1153 i‡(
jh
->
b_å™ß˘i⁄
 !
h™dÀ
->
h_å™ß˘i⁄
 &&

1154 
jh
->
b_√xt_å™ß˘i⁄
 !
h™dÀ
->
h_å™ß˘i⁄
)

1155 
out
;

1165 
	`smp_mb
();

1166 i‡(
	`u∆ikñy
(
jh
->
b_bh
 !
bh
))

1167 
out
;

1168 
ªt
 = 
åue
;

1169 
out
:

1170 
	`rcu_ªad_u∆ock
();

1171  
ªt
;

1172 
	}
}

1185 
	$jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1187 
jou∫Æ_hód
 *
jh
;

1188 
rc
;

1190 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1191  -
EROFS
;

1193 i‡(
	`jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ
, 
bh
, 
Ál£
))

1196 
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1200 
rc
 = 
	`do_gë_wrôe_ac˚ss
(
h™dÀ
, 
jh
, 0);

1201 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1202  
rc
;

1203 
	}
}

1225 
	$jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1227 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1228 
jou∫Æ_t
 *
jou∫Æ
;

1229 
jou∫Æ_hód
 *
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1230 
îr
;

1232 
	`jbd_debug
(5, "jou∫Æ_hód %p\n", 
jh
);

1233 
îr
 = -
EROFS
;

1234 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1235 
out
;

1236 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1237 
îr
 = 0;

1239 
	`JBUFFER_TRACE
(
jh
, "entry");

1247 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1248 
	`J_ASSERT_JH
(
jh
, (jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

1249 
jh
->
b_å™ß˘i⁄
 =
NULL
 ||

1250 (
jh
->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

1251 
jh
->
b_jli°
 =
BJ_F‹gë
)));

1253 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

1254 
	`J_ASSERT_JH
(
jh
, 
	`buf„r_locked
(
	`jh2bh
(jh)));

1256 i‡(
jh
->
b_å™ß˘i⁄
 =
NULL
) {

1265 
	`˛ór_buf„r_dúty
(
	`jh2bh
(
jh
));

1267 
jh
->
b_modifõd
 = 0;

1269 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Reserved");

1270 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1271 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Re£rved
);

1272 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1273 } i‡(
jh
->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

1275 
jh
->
b_modifõd
 = 0;

1277 
	`JBUFFER_TRACE
(
jh
, "setÇextÅransaction");

1278 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1279 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1280 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1282 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1291 
	`JBUFFER_TRACE
(
jh
, "cancellingÑevoke");

1292 
	`jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ
, 
jh
);

1293 
out
:

1294 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1295  
îr
;

1296 
	}
}

1324 
	$jbd3_jou∫Æ_gë_undo_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1326 
îr
;

1327 
jou∫Æ_hód
 *
jh
;

1328 *
commôãd_d©a
 = 
NULL
;

1330 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1331  -
EROFS
;

1333 i‡(
	`jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ
, 
bh
, 
åue
))

1336 
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1337 
	`JBUFFER_TRACE
(
jh
, "entry");

1344 
îr
 = 
	`do_gë_wrôe_ac˚ss
(
h™dÀ
, 
jh
, 1);

1345 i‡(
îr
)

1346 
out
;

1348 
ª≥©
:

1349 i‡(!
jh
->
b_commôãd_d©a
)

1350 
commôãd_d©a
 = 
	`jbd3_Æloc
(
	`jh2bh
(
jh
)->
b_size
,

1351 
GFP_NOFS
|
__GFP_NOFAIL
);

1353 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1354 i‡(!
jh
->
b_commôãd_d©a
) {

1357 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1358 i‡(!
commôãd_d©a
) {

1359 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1360 
ª≥©
;

1363 
jh
->
b_commôãd_d©a
 = 
commôãd_d©a
;

1364 
commôãd_d©a
 = 
NULL
;

1365 
	`mem˝y
(
jh
->
b_commôãd_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1367 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1368 
out
:

1369 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1370 i‡(
	`u∆ikñy
(
commôãd_d©a
))

1371 
	`jbd3_‰ì
(
commôãd_d©a
, 
bh
->
b_size
);

1372  
îr
;

1373 
	}
}

1386 
	$jbd3_jou∫Æ_£t_åiggîs
(
buf„r_hód
 *
bh
,

1387 
jbd3_buf„r_åiggî_ty≥
 *
ty≥
)

1389 
jou∫Æ_hód
 *
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

1391 i‡(
	`WARN_ON
(!
jh
))

1393 
jh
->
b_åiggîs
 = 
ty≥
;

1394 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1395 
	}
}

1397 
	$jbd3_buf„r_‰ozí_åiggî
(
jou∫Æ_hód
 *
jh
, *
m≠≥d_d©a
,

1398 
jbd3_buf„r_åiggî_ty≥
 *
åiggîs
)

1400 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

1402 i‡(!
åiggîs
 || !åiggîs->
t_‰ozí
)

1405 
åiggîs
->
	`t_‰ozí
—riggîs, 
bh
, 
m≠≥d_d©a
, bh->
b_size
);

1406 
	}
}

1408 
	$jbd3_buf„r_ab‹t_åiggî
(
jou∫Æ_hód
 *
jh
,

1409 
jbd3_buf„r_åiggî_ty≥
 *
åiggîs
)

1411 i‡(!
åiggîs
 || !åiggîs->
t_ab‹t
)

1414 
åiggîs
->
	`t_ab‹t
—riggîs, 
	`jh2bh
(
jh
));

1415 
	}
}

1440 
	$jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1442 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1443 
jou∫Æ_t
 *
jou∫Æ
;

1444 
jou∫Æ_hód
 *
jh
;

1445 
ªt
 = 0;

1447 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1448  -
EROFS
;

1449 i‡(!
	`buf„r_jbd
(
bh
))

1450  -
EUCLEAN
;

1456 
jh
 = 
	`bh2jh
(
bh
);

1457 
	`jbd_debug
(5, "jou∫Æ_hód %p\n", 
jh
);

1458 
	`JBUFFER_TRACE
(
jh
, "entry");

1466 i‡(
jh
->
b_å™ß˘i⁄
 !
å™ß˘i⁄
 &&

1467 
jh
->
b_√xt_å™ß˘i⁄
 !
å™ß˘i⁄
) {

1468 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1469 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

1470 
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
);

1471 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1473 i‡(
jh
->
b_modifõd
 == 1) {

1475 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 &&

1476 
jh
->
b_jli°
 !
BJ_Mëad©a
) {

1477 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1478 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 &&

1479 
jh
->
b_jli°
 !
BJ_Mëad©a
)

1480 
	`¥_îr
("JBD3:ássertion failure: h_type=%u "

1482 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

1483 (Ë
bh
->
b_blockƒ
,

1484 
jh
->
b_jli°
);

1485 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 !
å™ß˘i⁄
 ||

1486 
jh
->
b_jli°
 =
BJ_Mëad©a
);

1487 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1489 
out
;

1492 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1493 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1495 i‡(
jh
->
b_modifõd
 == 0) {

1501 i‡(
	`WARN_ON_ONCE
(
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
) <= 0)) {

1502 
ªt
 = -
ENOSPC
;

1503 
out_u∆ock_bh
;

1505 
jh
->
b_modifõd
 = 1;

1506 
h™dÀ
->
h_tŸÆ_¸edôs
--;

1516 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 && jh->
b_jli°
 =
BJ_Mëad©a
) {

1517 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1518 i‡(
	`u∆ikñy
(
jh
->
b_å™ß˘i⁄
 !=

1519 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)) {

1520 
	`¥ötk
(
KERN_ERR
 "JBD3: %s: "

1523 
jou∫Æ
->
j_dev«me
,

1524 (Ë
bh
->
b_blockƒ
,

1525 
jh
->
b_å™ß˘i⁄
,

1526 
jh
->
b_å™ß˘i⁄
 ? jh->b_å™ß˘i⁄->
t_tid
 : 0,

1527 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
,

1528 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ?

1529 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 : 0);

1530 
ªt
 = -
EINVAL
;

1532 
out_u∆ock_bh
;

1535 
	`£t_buf„r_jbddúty
(
bh
);

1543 i‡(
jh
->
b_å™ß˘i⁄
 !
å™ß˘i⁄
) {

1544 
	`JBUFFER_TRACE
(
jh
, "already on otherÅransaction");

1545 i‡(
	`u∆ikñy
(((
jh
->
b_å™ß˘i⁄
 !=

1546 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)) ||

1547 (
jh
->
b_√xt_å™ß˘i⁄
 !
å™ß˘i⁄
))) {

1548 
	`¥ötk
(
KERN_ERR
 "jbd3_journal_dirty_metadata: %s: "

1553 
jou∫Æ
->
j_dev«me
,

1554 (Ë
bh
->
b_blockƒ
,

1555 
å™ß˘i⁄
,Åønß˘i⁄->
t_tid
,

1556 
jh
->
b_å™ß˘i⁄
,

1557 
jh
->
b_å™ß˘i⁄
 ?

1558 
jh
->
b_å™ß˘i⁄
->
t_tid
 : 0,

1559 
jh
->
b_√xt_å™ß˘i⁄
,

1560 
jh
->
b_√xt_å™ß˘i⁄
 ?

1561 
jh
->
b_√xt_å™ß˘i⁄
->
t_tid
 : 0,

1562 
jh
->
b_jli°
);

1563 
	`WARN_ON
(1);

1564 
ªt
 = -
EINVAL
;

1568 
out_u∆ock_bh
;

1572 
	`J_ASSERT_JH
(
jh
, jh->
b_‰ozí_d©a
 =
NULL
);

1574 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Metadata");

1575 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1576 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Mëad©a
);

1577 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1578 
out_u∆ock_bh
:

1579 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1580 
out
:

1581 
	`JBUFFER_TRACE
(
jh
, "exit");

1582  
ªt
;

1583 
	}
}

1602 
	$jbd3_jou∫Æ_f‹gë
 (
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1604 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1605 
jou∫Æ_t
 *
jou∫Æ
;

1606 
jou∫Æ_hód
 *
jh
;

1607 
dr›_ª£rve
 = 0;

1608 
îr
 = 0;

1609 
was_modifõd
 = 0;

1611 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1612  -
EROFS
;

1613 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1615 
	`BUFFER_TRACE
(
bh
, "entry");

1617 
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

1618 i‡(!
jh
) {

1619 
	`__bf‹gë
(
bh
);

1623 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

1627 i‡(!
	`J_EXPECT_JH
(
jh
, !jh->
b_commôãd_d©a
,

1629 
îr
 = -
EIO
;

1630 
dr›
;

1634 
was_modifõd
 = 
jh
->
b_modifõd
;

1640 
jh
->
b_modifõd
 = 0;

1642 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
) {

1643 
	`J_ASSERT_JH
(
jh
, !jh->
b_‰ozí_d©a
);

1648 
	`˛ór_buf„r_dúty
(
bh
);

1649 
	`˛ór_buf„r_jbddúty
(
bh
);

1651 
	`JBUFFER_TRACE
(
jh
, "belongsÅo currentÅransaction: unfile");

1657 i‡(
was_modifõd
)

1658 
dr›_ª£rve
 = 1;

1672 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1673 i‡(
jh
->
b_˝_å™ß˘i⁄
) {

1674 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

1675 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

1677 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

1678 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1680 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1681 } i‡(
jh
->
b_å™ß˘i⁄
) {

1682 
	`J_ASSERT_JH
(
jh
, (jh->
b_å™ß˘i⁄
 ==

1683 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
));

1686 
	`JBUFFER_TRACE
(
jh
, "belongsÅo olderÅransaction");

1694 
	`£t_buf„r_‰ìd
(
bh
);

1696 i‡(!
jh
->
b_√xt_å™ß˘i⁄
) {

1697 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1698 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1699 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1701 
	`J_ASSERT
(
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
);

1707 i‡(
was_modifõd
)

1708 
dr›_ª£rve
 = 1;

1716 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1717 i‡(!
jh
->
b_˝_å™ß˘i⁄
) {

1718 
	`JBUFFER_TRACE
(
jh
, "belongsÅoÇoneÅransaction");

1719 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1720 
dr›
;

1727 i‡(!
	`buf„r_dúty
(
bh
)) {

1728 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

1729 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1730 
dr›
;

1739 
	`˛ór_buf„r_dúty
(
bh
);

1740 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

1741 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1743 
dr›
:

1744 
	`__bªl£
(
bh
);

1745 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

1746 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1747 i‡(
dr›_ª£rve
) {

1749 
h™dÀ
->
h_tŸÆ_¸edôs
++;

1751  
îr
;

1752 
	}
}

1770 
	$jbd3_jou∫Æ_°›
(
h™dÀ_t
 *
h™dÀ
)

1772 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1773 
jou∫Æ_t
 *
jou∫Æ
;

1774 
îr
 = 0, 
waô_f‹_commô
 = 0;

1775 
tid_t
 
tid
;

1776 
pid_t
 
pid
;

1778 i‡(--
h™dÀ
->
h_ªf
 > 0) {

1779 
	`jbd_debug
(4, "h_ª‡%d -> %d\n", 
h™dÀ
->
h_ªf
 + 1,

1780 
h™dÀ
->
h_ªf
);

1781 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1782  -
EIO
;

1785 i‡(!
å™ß˘i⁄
) {

1790 
	`memÆloc_nofs_ª°‹e
(
h™dÀ
->
ßved_Æloc_c⁄ãxt
);

1791 
‰ì_™d_exô
;

1793 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1794 
tid
 = 
å™ß˘i⁄
->
t_tid
;

1796 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1797 
îr
 = -
EIO
;

1799 
	`jbd_debug
(4, "H™dÀ %∞goög down\n", 
h™dÀ
);

1800 
	`åa˚_jbd3_h™dÀ_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

1801 
tid
, 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

1802 
jiffõs
 - 
h™dÀ
->
h_°¨t_jiffõs
,

1803 
h™dÀ
->
h_sync
, h™dÀ->
h_ªque°ed_¸edôs
,

1804 (
h™dÀ
->
h_ªque°ed_¸edôs
 -

1805 
h™dÀ
->
h_tŸÆ_¸edôs
));

1836 
pid
 = 
cuºít
->pid;

1837 i‡(
h™dÀ
->
h_sync
 && 
jou∫Æ
->
j_œ°_sync_wrôî
 !
pid
 &&

1838 
jou∫Æ
->
j_max_b©ch_time
) {

1839 
u64
 
commô_time
, 
å™s_time
;

1841 
jou∫Æ
->
j_œ°_sync_wrôî
 = 
pid
;

1843 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

1844 
commô_time
 = 
jou∫Æ
->
j_avîage_commô_time
;

1845 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1847 
å™s_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(),

1848 
å™ß˘i⁄
->
t_°¨t_time
));

1850 
commô_time
 = 
	`max_t
(
u64
, commit_time,

1851 1000*
jou∫Æ
->
j_mö_b©ch_time
);

1852 
commô_time
 = 
	`mö_t
(
u64
, commit_time,

1853 1000*
jou∫Æ
->
j_max_b©ch_time
);

1855 i‡(
å™s_time
 < 
commô_time
) {

1856 
ktime_t
 
expúes
 = 
	`ktime_add_ns
(
	`ktime_gë
(),

1857 
commô_time
);

1858 
	`£t_cuºít_°©e
(
TASK_UNINTERRUPTIBLE
);

1859 
	`scheduÀ_hπimeout
(&
expúes
, 
HRTIMER_MODE_ABS
);

1863 i‡(
h™dÀ
->
h_sync
)

1864 
å™ß˘i⁄
->
t_synchr⁄ous_commô
 = 1;

1871 i‡(
h™dÀ
->
h_sync
 ||

1872 
	`time_a·î_eq
(
jiffõs
, 
å™ß˘i⁄
->
t_expúes
)) {

1877 
	`jbd_debug
(2, "transactionÅoo old,Ñequesting commit for "

1878 "h™dÀ %p\n", 
h™dÀ
);

1880 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

1886 i‡(
h™dÀ
->
h_sync
 && !(
cuºít
->
Êags
 & 
PF_MEMALLOC
))

1887 
waô_f‹_commô
 = 1;

1896 
	`°›_this_h™dÀ
(
h™dÀ
);

1898 i‡(
waô_f‹_commô
)

1899 
îr
 = 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

1901 
‰ì_™d_exô
:

1902 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

1903 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
->
h_rsv_h™dÀ
);

1904 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

1905  
îr
;

1906 
	}
}

1924 
ölöe
 

1925 
	$__bli°_add_buf„r
(
jou∫Æ_hód
 **
li°
, jou∫Æ_hód *
jh
)

1927 i‡(!*
li°
) {

1928 
jh
->
b_äext
 = jh->
b_çªv
 = jh;

1929 *
li°
 = 
jh
;

1932 
jou∫Æ_hód
 *
fú°
 = *
li°
, *
œ°
 = fú°->
b_çªv
;

1933 
jh
->
b_çªv
 = 
œ°
;

1934 
jh
->
b_äext
 = 
fú°
;

1935 
œ°
->
b_äext
 = 
fú°
->
b_çªv
 = 
jh
;

1937 
	}
}

1948 
ölöe
 

1949 
	$__bli°_dñ_buf„r
(
jou∫Æ_hód
 **
li°
, jou∫Æ_hód *
jh
)

1951 i‡(*
li°
 =
jh
) {

1952 *
li°
 = 
jh
->
b_äext
;

1953 i‡(*
li°
 =
jh
)

1954 *
li°
 = 
NULL
;

1956 
jh
->
b_çªv
->
b_äext
 = jh->b_tnext;

1957 
jh
->
b_äext
->
b_çªv
 = jh->b_tprev;

1958 
	}
}

1971 
	$__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jou∫Æ_hód
 *
jh
)

1973 
jou∫Æ_hód
 **
li°
 = 
NULL
;

1974 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

1975 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

1977 
	`lockdï_as£π_hñd
(&
jh
->
b_°©e_lock
);

1978 
å™ß˘i⁄
 = 
jh
->
b_å™ß˘i⁄
;

1979 i‡(
å™ß˘i⁄
)

1980 
	`as£π_•ö_locked
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

1982 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 < 
BJ_Ty≥s
);

1983 i‡(
jh
->
b_jli°
 !
BJ_N⁄e
)

1984 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
 !
NULL
);

1986 
jh
->
b_jli°
) {

1987 
BJ_N⁄e
:

1989 
BJ_Mëad©a
:

1990 
å™ß˘i⁄
->
t_ƒ_buf„rs
--;

1991 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
->
t_ƒ_buf„rs
 >= 0);

1992 
li°
 = &
å™ß˘i⁄
->
t_buf„rs
;

1994 
BJ_F‹gë
:

1995 
li°
 = &
å™ß˘i⁄
->
t_f‹gë
;

1997 
BJ_Shadow
:

1998 
li°
 = &
å™ß˘i⁄
->
t_shadow_li°
;

2000 
BJ_Re£rved
:

2001 
li°
 = &
å™ß˘i⁄
->
t_ª£rved_li°
;

2005 
	`__bli°_dñ_buf„r
(
li°
, 
jh
);

2006 
jh
->
b_jli°
 = 
BJ_N⁄e
;

2007 i‡(
å™ß˘i⁄
 && 
	`is_jou∫Æ_ab‹ãd
—ønß˘i⁄->
t_jou∫Æ
))

2008 
	`˛ór_buf„r_jbddúty
(
bh
);

2009 i‡(
	`ã°_˛ór_buf„r_jbddúty
(
bh
))

2010 
	`m¨k_buf„r_dúty
(
bh
);

2011 
	}
}

2019 
	$__jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_hód
 *
jh
)

2021 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2022 
jh
->
b_å™ß˘i⁄
 = 
NULL
;

2023 
	}
}

2025 
	$jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
jou∫Æ_hód
 *
jh
)

2027 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2030 
	`gë_bh
(
bh
);

2031 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

2032 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2033 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

2034 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2035 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2036 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2037 
	`__bªl£
(
bh
);

2038 
	}
}

2046 
	$__jou∫Æ_åy_to_‰ì_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
)

2048 
jou∫Æ_hód
 *
jh
;

2050 
jh
 = 
	`bh2jh
(
bh
);

2052 i‡(
	`buf„r_locked
(
bh
Ë|| 
	`buf„r_dúty
(bh))

2053 
out
;

2055 i‡(
jh
->
b_√xt_å™ß˘i⁄
 !
NULL
 || jh->
b_å™ß˘i⁄
 != NULL)

2056 
out
;

2058 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2059 i‡(
jh
->
b_˝_å™ß˘i⁄
 !
NULL
) {

2061 
	`JBUFFER_TRACE
(
jh
, "remove from checkpointÜist");

2062 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2064 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2065 
out
:

2067 
	}
}

2107 
	$jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

2108 
∑ge
 *∑ge, 
gÂ_t
 
gÂ_mask
)

2110 
buf„r_hód
 *
hód
;

2111 
buf„r_hód
 *
bh
;

2112 
ªt
 = 0;

2114 
	`J_ASSERT
(
	`PageLocked
(
∑ge
));

2116 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2117 
bh
 = 
hód
;

2119 
jou∫Æ_hód
 *
jh
;

2126 
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2127 i‡(!
jh
)

2130 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

2131 
	`__jou∫Æ_åy_to_‰ì_buf„r
(
jou∫Æ
, 
bh
);

2132 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2133 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2134 i‡(
	`buf„r_jbd
(
bh
))

2135 
busy
;

2136 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2138 
ªt
 = 
	`åy_to_‰ì_buf„rs
(
∑ge
);

2140 
busy
:

2141  
ªt
;

2142 
	}
}

2156 
	$__di•o£_buf„r
(
jou∫Æ_hód
 *
jh
, 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

2158 
may_‰ì
 = 1;

2159 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2161 i‡(
jh
->
b_˝_å™ß˘i⁄
) {

2162 
	`JBUFFER_TRACE
(
jh
, "onÑunning+cpÅransaction");

2163 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2169 
	`˛ór_buf„r_dúty
(
bh
);

2170 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

2171 
may_‰ì
 = 0;

2173 
	`JBUFFER_TRACE
(
jh
, "onÑunningÅransaction");

2174 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

2175 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2177  
may_‰ì
;

2178 
	}
}

2227 
	$jou∫Æ_unm≠_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

2228 
∑πül_∑ge
)

2230 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

2231 
jou∫Æ_hód
 *
jh
;

2232 
may_‰ì
 = 1;

2234 
	`BUFFER_TRACE
(
bh
, "entry");

2242 
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2243 i‡(!
jh
)

2244 
z≠_buf„r_u∆ocked
;

2247 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2248 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

2249 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2274 
å™ß˘i⁄
 = 
jh
->
b_å™ß˘i⁄
;

2275 i‡(
å™ß˘i⁄
 =
NULL
) {

2280 i‡(!
jh
->
b_˝_å™ß˘i⁄
) {

2281 
	`JBUFFER_TRACE
(
jh
, "not onányÅransaction: zap");

2282 
z≠_buf„r
;

2285 i‡(!
	`buf„r_dúty
(
bh
)) {

2287 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2288 
z≠_buf„r
;

2295 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

2299 
	`JBUFFER_TRACE
(
jh
, "checkpointed:áddÅo BJ_Forget");

2300 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
,

2301 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2302 
z≠_buf„r
;

2308 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

2309 
	`JBUFFER_TRACE
(
jh
, "giveÅo committingÅrans");

2310 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
,

2311 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2312 
z≠_buf„r
;

2316 
	`˛ór_buf„r_jbddúty
(
bh
);

2317 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2318 
z≠_buf„r
;

2321 } i‡(
å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

2322 
	`JBUFFER_TRACE
(
jh
, "on committingÅransaction");

2328 i‡(
∑πül_∑ge
) {

2329 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2330 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2331 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2332 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2333  -
EBUSY
;

2342 
	`£t_buf„r_‰ìd
(
bh
);

2343 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 && 
	`buf„r_jbddúty
(
bh
))

2344 
jh
->
b_√xt_å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

2345 
jh
->
b_modifõd
 = 0;

2346 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2347 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2348 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2349 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2358 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
 =
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2359 
	`JBUFFER_TRACE
(
jh
, "onÑunningÅransaction");

2360 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
, 
å™ß˘i⁄
);

2363 
z≠_buf„r
:

2372 
jh
->
b_modifõd
 = 0;

2373 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2374 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2375 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2376 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2377 
z≠_buf„r_u∆ocked
:

2378 
	`˛ór_buf„r_dúty
(
bh
);

2379 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_jbddúty
(bh));

2380 
	`˛ór_buf„r_m≠≥d
(
bh
);

2381 
	`˛ór_buf„r_ªq
(
bh
);

2382 
	`˛ór_buf„r_√w
(
bh
);

2383 
	`˛ór_buf„r_dñay
(
bh
);

2384 
	`˛ór_buf„r_unwrôãn
(
bh
);

2385 
bh
->
b_bdev
 = 
NULL
;

2386  
may_‰ì
;

2387 
	}
}

2401 
	$jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ_t
 *
jou∫Æ
,

2402 
∑ge
 *page,

2403 
off£t
,

2404 
Àngth
)

2406 
buf„r_hód
 *
hód
, *
bh
, *
√xt
;

2407 
°›
 = 
off£t
 + 
Àngth
;

2408 
cuº_off
 = 0;

2409 
∑πül_∑ge
 = (
off£t
 || 
Àngth
 < 
PAGE_SIZE
);

2410 
may_‰ì
 = 1;

2411 
ªt
 = 0;

2413 i‡(!
	`PageLocked
(
∑ge
))

2414 
	`BUG
();

2415 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

2418 
	`BUG_ON
(
°›
 > 
PAGE_SIZE
 || st› < 
Àngth
);

2424 
hód
 = 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

2426 
√xt_off
 = 
cuº_off
 + 
bh
->
b_size
;

2427 
√xt
 = 
bh
->
b_this_∑ge
;

2429 i‡(
√xt_off
 > 
°›
)

2432 i‡(
off£t
 <
cuº_off
) {

2434 
	`lock_buf„r
(
bh
);

2435 
ªt
 = 
	`jou∫Æ_unm≠_buf„r
(
jou∫Æ
, 
bh
, 
∑πül_∑ge
);

2436 
	`u∆ock_buf„r
(
bh
);

2437 i‡(
ªt
 < 0)

2438  
ªt
;

2439 
may_‰ì
 &
ªt
;

2441 
cuº_off
 = 
√xt_off
;

2442 
bh
 = 
√xt
;

2444 } 
bh
 !
hód
);

2446 i‡(!
∑πül_∑ge
) {

2447 i‡(
may_‰ì
 && 
	`åy_to_‰ì_buf„rs
(
∑ge
))

2448 
	`J_ASSERT
(!
	`∑ge_has_buf„rs
(
∑ge
));

2451 
	}
}

2456 
	$__jbd3_jou∫Æ_fûe_buf„r
(
jou∫Æ_hód
 *
jh
,

2457 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
jli°
)

2459 
jou∫Æ_hód
 **
li°
 = 
NULL
;

2460 
was_dúty
 = 0;

2461 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2463 
	`lockdï_as£π_hñd
(&
jh
->
b_°©e_lock
);

2464 
	`as£π_•ö_locked
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2466 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 < 
BJ_Ty≥s
);

2467 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

2468 
jh
->
b_å™ß˘i⁄
 =
NULL
);

2470 i‡(
jh
->
b_å™ß˘i⁄
 && jh->
b_jli°
 =
jli°
)

2473 i‡(
jli°
 =
BJ_Mëad©a
 || jli° =
BJ_Re£rved
 ||

2474 
jli°
 =
BJ_Shadow
 || jli° =
BJ_F‹gë
) {

2482 i‡(
	`buf„r_dúty
(
bh
))

2483 
	`w¨n_dúty_buf„r
(
bh
);

2484 i‡(
	`ã°_˛ór_buf„r_dúty
(
bh
) ||

2485 
	`ã°_˛ór_buf„r_jbddúty
(
bh
))

2486 
was_dúty
 = 1;

2489 i‡(
jh
->
b_å™ß˘i⁄
)

2490 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2492 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2493 
jh
->
b_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2495 
jli°
) {

2496 
BJ_N⁄e
:

2497 
	`J_ASSERT_JH
(
jh
, !jh->
b_commôãd_d©a
);

2498 
	`J_ASSERT_JH
(
jh
, !jh->
b_‰ozí_d©a
);

2500 
BJ_Mëad©a
:

2501 
å™ß˘i⁄
->
t_ƒ_buf„rs
++;

2502 
li°
 = &
å™ß˘i⁄
->
t_buf„rs
;

2504 
BJ_F‹gë
:

2505 
li°
 = &
å™ß˘i⁄
->
t_f‹gë
;

2507 
BJ_Shadow
:

2508 
li°
 = &
å™ß˘i⁄
->
t_shadow_li°
;

2510 
BJ_Re£rved
:

2511 
li°
 = &
å™ß˘i⁄
->
t_ª£rved_li°
;

2515 
	`__bli°_add_buf„r
(
li°
, 
jh
);

2516 
jh
->
b_jli°
 = 
jli°
;

2518 i‡(
was_dúty
)

2519 
	`£t_buf„r_jbddúty
(
bh
);

2520 
	}
}

2522 
	$jbd3_jou∫Æ_fûe_buf„r
(
jou∫Æ_hód
 *
jh
,

2523 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
jli°
)

2525 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

2526 
	`•ö_lock
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2527 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
jli°
);

2528 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2529 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2530 
	}
}

2545 
boﬁ
 
	$__jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ_hód
 *
jh
)

2547 
was_dúty
, 
jli°
;

2548 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2550 
	`lockdï_as£π_hñd
(&
jh
->
b_°©e_lock
);

2551 i‡(
jh
->
b_å™ß˘i⁄
)

2552 
	`as£π_•ö_locked
(&
jh
->
b_å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2555 i‡(
jh
->
b_√xt_å™ß˘i⁄
 =
NULL
) {

2556 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

2557  
åue
;

2565 
was_dúty
 = 
	`ã°_˛ór_buf„r_jbddúty
(
bh
);

2566 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2572 
jh
->
b_å™ß˘i⁄
 = jh->
b_√xt_å™ß˘i⁄
;

2573 
jh
->
b_√xt_å™ß˘i⁄
 = 
NULL
;

2574 i‡(
	`buf„r_‰ìd
(
bh
))

2575 
jli°
 = 
BJ_F‹gë
;

2576 i‡(
jh
->
b_modifõd
)

2577 
jli°
 = 
BJ_Mëad©a
;

2579 
jli°
 = 
BJ_Re£rved
;

2580 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, jh->
b_å™ß˘i⁄
, 
jli°
);

2581 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
->
t_°©e
 =
T_RUNNING
);

2583 i‡(
was_dúty
)

2584 
	`£t_buf„r_jbddúty
(
bh
);

2585  
Ál£
;

2586 
	}
}

2594 
	$jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
jou∫Æ_hód
 *
jh
)

2596 
boﬁ
 
dr›
;

2598 
	`•ö_lock
(&
jh
->
b_°©e_lock
);

2599 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2600 
dr›
 = 
	`__jbd3_jou∫Æ_ªfûe_buf„r
(
jh
);

2601 
	`•ö_u∆ock
(&
jh
->
b_°©e_lock
);

2602 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2603 i‡(
dr›
)

2604 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2605 
	}
}

2610 
	$jbd3_jou∫Æ_fûe_öode
(
h™dÀ_t
 *
h™dÀ
, 
jbd3_öode
 *
jöode
,

2611 
Êags
, 
loff_t
 
°¨t_byã
,Üoff_à
íd_byã
)

2613 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

2614 
jou∫Æ_t
 *
jou∫Æ
;

2616 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

2617  -
EROFS
;

2618 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

2620 
	`jbd_debug
(4, "Addög inodê%lu,Åid:%d\n", 
jöode
->
i_vfs_öode
->
i_öo
,

2621 
å™ß˘i⁄
->
t_tid
);

2623 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2624 
jöode
->
i_Êags
 |
Êags
;

2626 i‡(
jöode
->
i_dúty_íd
) {

2627 
jöode
->
i_dúty_°¨t
 = 
	`mö
(jöode->i_dúty_°¨t, 
°¨t_byã
);

2628 
jöode
->
i_dúty_íd
 = 
	`max
(jöode->i_dúty_íd, 
íd_byã
);

2630 
jöode
->
i_dúty_°¨t
 = 
°¨t_byã
;

2631 
jöode
->
i_dúty_íd
 = 
íd_byã
;

2635 i‡(
jöode
->
i_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

2636 
jöode
->
i_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
)

2637 
d⁄e
;

2644 i‡(!
å™ß˘i⁄
->
t_√ed_d©a_Êush
)

2645 
å™ß˘i⁄
->
t_√ed_d©a_Êush
 = 1;

2648 i‡(
jöode
->
i_å™ß˘i⁄
) {

2649 
	`J_ASSERT
(
jöode
->
i_√xt_å™ß˘i⁄
 =
NULL
);

2650 
	`J_ASSERT
(
jöode
->
i_å™ß˘i⁄
 ==

2651 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2652 
jöode
->
i_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2653 
d⁄e
;

2656 
	`J_ASSERT
(!
jöode
->
i_√xt_å™ß˘i⁄
);

2657 
jöode
->
i_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2658 
	`li°_add
(&
jöode
->
i_li°
, &
å™ß˘i⁄
->
t_öode_li°
);

2659 
d⁄e
:

2660 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2663 
	}
}

2665 
	$jbd3_jou∫Æ_öode_ønged_wrôe
(
h™dÀ_t
 *
h™dÀ
,

2666 
jbd3_öode
 *
jöode
, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

2668  
	`jbd3_jou∫Æ_fûe_öode
(
h™dÀ
, 
jöode
,

2669 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
, 
°¨t_byã
,

2670 
°¨t_byã
 + 
Àngth
 - 1);

2671 
	}
}

2673 
	$jbd3_jou∫Æ_öode_ønged_waô
(
h™dÀ_t
 *
h™dÀ
, 
jbd3_öode
 *
jöode
,

2674 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

2676  
	`jbd3_jou∫Æ_fûe_öode
(
h™dÀ
, 
jöode
, 
JI_WAIT_DATA
,

2677 
°¨t_byã
, sèπ_byã + 
Àngth
 - 1);

2678 
	}
}

2700 
	$jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
jou∫Æ_t
 *
jou∫Æ
,

2701 
jbd3_öode
 *
jöode
,

2702 
loff_t
 
√w_size
)

2704 
å™ß˘i⁄_t
 *
öode_å™s
, *
commô_å™s
;

2705 
ªt
 = 0;

2708 i‡(!
jöode
->
i_å™ß˘i⁄
)

2709 
out
;

2713 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

2714 
commô_å™s
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

2715 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2716 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2717 
öode_å™s
 = 
jöode
->
i_å™ß˘i⁄
;

2718 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2719 i‡(
öode_å™s
 =
commô_å™s
) {

2720 
ªt
 = 
	`fûem≠_fd©awrôe_ønge
(
jöode
->
i_vfs_öode
->
i_m≠pög
,

2721 
√w_size
, 
LLONG_MAX
);

2722 i‡(
ªt
)

2723 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªt
);

2725 
out
:

2726  
ªt
;

2727 
	}
}

	@mballoc.c

12 
	~"pxt4_jbd3.h
"

13 
	~"mbÆloc.h
"

14 
	~<löux/log2.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/no•ec.h
>

18 
	~<löux/backög-dev.h
>

19 
	~<åa˚/evíts/pxt4.h
>

21 #ifde‡
CONFIG_PXT4_DEBUG


22 
ush‹t
 
pxt4_mbÆloc_debug
 
	g__ªad_mo°ly
;

24 
moduÀ_∑øm_«med
(
mbÆloc_debug
, 
pxt4_mbÆloc_debug
, 
ush‹t
, 0644);

25 
MODULE_PARM_DESC
(
mbÆloc_debug
, "DebuggingÜevel forÖxt4's mballoc");

339 
kmem_ˇche
 *
	gpxt4_p•a˚_ˇchï
;

340 
kmem_ˇche
 *
	gpxt4_ac_ˇchï
;

341 
kmem_ˇche
 *
	gpxt4_‰ì_d©a_ˇchï
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ˇche
 *
	gpxt4_groupöfo_ˇches
[
NR_GRPINFO_CACHES
];

349 c⁄° * c⁄° 
	gpxt4_groupöfo_¶ab_«mes
[
NR_GRPINFO_CACHES
] = {

355 
pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

356 
pxt4_group_t
 
group
);

357 
pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

358 
pxt4_group_t
 
group
);

360 
ölöe
 *
	$mb_c‹ª˘_addr_™d_bô
(*
bô
, *
addr
)

362 #i‡
BITS_PER_LONG
 == 64

363 *
bô
 +((Ë
addr
 & 7UL) << 3;

364 
addr
 = (*) (()áddr & ~7UL);

365 #ñi‡
BITS_PER_LONG
 == 32

366 *
bô
 +((Ë
addr
 & 3UL) << 3;

367 
addr
 = (*) (()áddr & ~3UL);

371  
addr
;

372 
	}
}

374 
ölöe
 
	$mb_ã°_bô
(
bô
, *
addr
)

380 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

381  
	`pxt4_ã°_bô
(
bô
, 
addr
);

382 
	}
}

384 
ölöe
 
	$mb_£t_bô
(
bô
, *
addr
)

386 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

387 
	`pxt4_£t_bô
(
bô
, 
addr
);

388 
	}
}

390 
ölöe
 
	$mb_˛ór_bô
(
bô
, *
addr
)

392 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

393 
	`pxt4_˛ór_bô
(
bô
, 
addr
);

394 
	}
}

396 
ölöe
 
	$mb_ã°_™d_˛ór_bô
(
bô
, *
addr
)

398 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

399  
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
addr
);

400 
	}
}

402 
ölöe
 
	$mb_föd_√xt_zîo_bô
(*
addr
, 
max
, 
°¨t
)

404 
fix
 = 0, 
ªt
, 
tmpmax
;

405 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
°¨t
 +
fix
;

409 
ªt
 = 
	`pxt4_föd_√xt_zîo_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

410 i‡(
ªt
 > 
max
)

411  
max
;

412  
ªt
;

413 
	}
}

415 
ölöe
 
	$mb_föd_√xt_bô
(*
addr
, 
max
, 
°¨t
)

417 
fix
 = 0, 
ªt
, 
tmpmax
;

418 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
°¨t
 +
fix
;

422 
ªt
 = 
	`pxt4_föd_√xt_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

423 i‡(
ªt
 > 
max
)

424  
max
;

425  
ªt
;

426 
	}
}

428 *
	$mb_föd_buddy
(
pxt4_buddy
 *
e4b
, 
‹dî
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =
NULL
);

435 i‡(
‹dî
 > 
e4b
->
bd_blkbôs
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 i‡(
‹dî
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkbôs
 + 3);

443  
e4b
->
bd_bôm≠
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`PXT4_SB
”4b->
bd_sb
)->
s_mb_off£ts
[
‹dî
];

447 *
max
 = 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
‹dî
];

449  
bb
;

450 
	}
}

452 #ifde‡
DOUBLE_CHECK


453 
	$mb_‰ì_blocks_doubÀ
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

454 
fú°
, 
cou¡
)

456 
i
;

457 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

461 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
cou¡
; i++) {

463 i‡(!
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
)) {

464 
pxt4_fsblk_t
 
blockƒ
;

466 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockƒ
 +
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
fú°
 + 
i
);

468 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

469 
öode
 ? inode->
i_öo
 : 0,

470 
blockƒ
,

473 
fú°
 + 
i
);

474 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

475 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_˛ór_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

479 
	}
}

481 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

483 
i
;

485 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

487 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

488 
i
 = 0; i < 
cou¡
; i++) {

489 
	`BUG_ON
(
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
));

490 
	`mb_£t_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

492 
	}
}

494 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

496 i‡(
	`memcmp
(
e4b
->
bd_öfo
->
bb_bôm≠
, 
bôm≠
,É4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*Ë
e4b
->
bd_öfo
->
bb_bôm≠
;

500 
b2
 = (*Ë
bôm≠
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 i‡(
b1
[
i
] !
b2
[i]) {

503 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
ölöe
 
	$mb_‰ì_blocks_doubÀ
(
öode
 *inode,

516 
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

519 
	}
}

520 
ölöe
 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
,

521 
fú°
, 
cou¡
)

524 
	}
}

525 
ölöe
 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

528 
	}
}

531 #ifde‡
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£π
) \

535 i‡(!(
as£π
)) { \

536 
	`¥ötk
(
KERN_EMERG
 \

538 
fun˘i⁄
, 
fûe
, 
löe
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
pxt4_buddy
 *
e4b
, *
fûe
,

544 c⁄° *
fun˘i⁄
, 
löe
)

546 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
‹dî
 = 
e4b
->
bd_blkbôs
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
cou¡
;

554 
pxt4_group_öfo
 *
gΩ
;

555 
‰agmíts
 = 0;

556 
f°¨t
;

557 
li°_hód
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_cou¡î
;

563 i‡(
mb_check_cou¡î
++ % 100 != 0)

567 
‹dî
 > 1) {

568 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =
max2
);

575 
cou¡
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 i‡(
	`mb_ã°_bô
(
i
, 
buddy
)) {

580 i‡(!
	`mb_ã°_bô
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_ã°_bô
((
i
<<1)+1, 
buddy2
));

583 } i‡(!
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
‹dî
); j++) {

595 
k
 = (
i
 * (1 << 
‹dî
)Ë+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_ã°_bô
(
k
, 
e4b
->
bd_bôm≠
));

599 
cou¡
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] =
cou¡
);

602 
‹dî
--;

605 
f°¨t
 = -1;

606 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 i‡(!
	`mb_ã°_bô
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >
e4b
->
bd_öfo
->
bb_fú°_‰ì
);

610 i‡(
f°¨t
 == -1) {

611 
‰agmíts
++;

612 
f°¨t
 = 
i
;

616 
f°¨t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkbôs
 + 1; j++) {

619 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`PXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_öfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_‰agmíts
 =
‰agmíts
);

628 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

630 
pxt4_group_t
 
grou≤r
;

631 
pxt4_¥óŒoc_•a˚
 *
∑
;

632 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

633 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
grou≤r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou≤r
 =
e4b
->
bd_group
);

635 
i
 = 0; i < 
∑
->
∑_Àn
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #unde‡
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
Ë
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$pxt4_mb_m¨k_‰ì_sim∂e
(
su≥r_block
 *
sb
,

654 *
buddy
, 
pxt4_gΩblk_t
 
fú°
,Öxt4_gΩblk_à
Àn
,

655 
pxt4_group_öfo
 *
gΩ
)

657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

658 
pxt4_gΩblk_t
 
mö
;

659 
pxt4_gΩblk_t
 
max
;

660 
pxt4_gΩblk_t
 
chunk
;

661 
b‹dî
;

663 
	`BUG_ON
(
Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
b‹dî
 = 2 << 
sb
->
s_blocksize_bôs
;

667 
Àn
 > 0) {

669 
max
 = 
	`ffs
(
fú°
 | 
b‹dî
) - 1;

672 
mö
 = 
	`Ês
(
Àn
) - 1;

674 i‡(
max
 < 
mö
)

675 
mö
 = 
max
;

676 
chunk
 = 1 << 
mö
;

679 
gΩ
->
bb_cou¡îs
[
mö
]++;

680 i‡(
mö
 > 0)

681 
	`mb_˛ór_bô
(
fú°
 >> 
mö
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mö
]);

684 
Àn
 -
chunk
;

685 
fú°
 +
chunk
;

687 
	}
}

694 
	$mb_£t_œrge°_‰ì_‹dî
(
su≥r_block
 *
sb
, 
pxt4_group_öfo
 *
gΩ
)

696 
i
;

697 
bôs
;

699 
gΩ
->
bb_œrge°_‰ì_‹dî
 = -1;

701 
bôs
 = 
sb
->
s_blocksize_bôs
 + 1;

702 
i
 = 
bôs
; i >= 0; i--) {

703 i‡(
gΩ
->
bb_cou¡îs
[
i
] > 0) {

704 
gΩ
->
bb_œrge°_‰ì_‹dî
 = 
i
;

708 
	}
}

710 
noölöe_f‹_°ack


711 
	$pxt4_mb_gíî©e_buddy
(
su≥r_block
 *
sb
,

712 *
buddy
, *
bôm≠
, 
pxt4_group_t
 
group
)

714 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

715 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

716 
pxt4_gΩblk_t
 
max
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
pxt4_gΩblk_t
 
i
 = 0;

718 
pxt4_gΩblk_t
 
fú°
;

719 
pxt4_gΩblk_t
 
Àn
;

720 
‰ì
 = 0;

721 
‰agmíts
 = 0;

722 
≥riod
 = 
	`gë_cy˛es
();

726 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, 0);

727 
gΩ
->
bb_fú°_‰ì
 = 
i
;

728 
i
 < 
max
) {

729 
‰agmíts
++;

730 
fú°
 = 
i
;

731 
i
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
, i);

732 
Àn
 = 
i
 - 
fú°
;

733 
‰ì
 +
Àn
;

734 i‡(
Àn
 > 1)

735 
	`pxt4_mb_m¨k_‰ì_sim∂e
(
sb
, 
buddy
, 
fú°
, 
Àn
, 
gΩ
);

737 
gΩ
->
bb_cou¡îs
[0]++;

738 i‡(
i
 < 
max
)

739 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, i);

741 
gΩ
->
bb_‰agmíts
 = 
‰agmíts
;

743 i‡(
‰ì
 !
gΩ
->
bb_‰ì
) {

744 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0,

747 
‰ì
, 
gΩ
->
bb_‰ì
);

752 
gΩ
->
bb_‰ì
 = 
‰ì
;

753 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

754 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
gΩ
);

758 
	`˛ór_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &(
gΩ
->
bb_°©e
));

760 
≥riod
 = 
	`gë_cy˛es
() -Öeriod;

761 
	`•ö_lock
(&
sbi
->
s_bÆ_lock
);

762 
sbi
->
s_mb_buddõs_gíî©ed
++;

763 
sbi
->
s_mb_gíî©i⁄_time
 +
≥riod
;

764 
	`•ö_u∆ock
(&
sbi
->
s_bÆ_lock
);

765 
	}
}

767 
	$mb_ªgíî©e_buddy
(
pxt4_buddy
 *
e4b
)

769 
cou¡
;

770 
‹dî
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
++, &
cou¡
))) {

774 
	`pxt4_£t_bôs
(
buddy
, 0, 
cou¡
);

776 
e4b
->
bd_öfo
->
bb_‰agmíts
 = 0;

777 
	`mem£t
(
e4b
->
bd_öfo
->
bb_cou¡îs
, 0,

778 (*
e4b
->
bd_öfo
->
bb_cou¡îs
) *

779 (
e4b
->
bd_sb
->
s_blocksize_bôs
 + 2));

781 
	`pxt4_mb_gíî©e_buddy
(
e4b
->
bd_sb
,É4b->
bd_buddy
,

782 
e4b
->
bd_bôm≠
,É4b->
bd_group
);

783 
	}
}

805 
	$pxt4_mb_öô_ˇche
(
∑ge
 *∑ge, *
öc‹e
, 
gÂ_t
 
gÂ
)

807 
pxt4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_≥r_∑ge
;

810 
groups_≥r_∑ge
;

811 
îr
 = 0;

812 
i
;

813 
pxt4_group_t
 
fú°_group
, 
group
;

814 
fú°_block
;

815 
su≥r_block
 *
sb
;

816 
buf„r_hód
 *
bhs
;

817 
buf„r_hód
 **
bh
 = 
NULL
;

818 
öode
 *inode;

819 *
d©a
;

820 *
bôm≠
;

821 
pxt4_group_öfo
 *
gröfo
;

823 
	`mb_debug
(1, "öôÖagê%lu\n", 
∑ge
->
ödex
);

825 
öode
 = 
∑ge
->
m≠pög
->
ho°
;

826 
sb
 = 
öode
->
i_sb
;

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
öode
);

829 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_≥r_∑ge
 = 
blocks_≥r_∑ge
 >> 1;

832 i‡(
groups_≥r_∑ge
 == 0)

833 
groups_≥r_∑ge
 = 1;

836 i‡(
groups_≥r_∑ge
 > 1) {

837 
i
 = (
buf„r_hód
 *Ë* 
groups_≥r_∑ge
;

838 
bh
 = 
	`kzÆloc
(
i
, 
gÂ
);

839 i‡(
bh
 =
NULL
) {

840 
îr
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fú°_group
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
 / 2;

849 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

850 i‡(
group
 >
ngroups
)

853 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

860 i‡(
	`PageU±od©e
(
∑ge
Ë&& !
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
group
);

865 i‡(
	`IS_ERR
(
bh
[
i
])) {

866 
îr
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "ªad bôm≠ f‹ grou∞%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

875 
îr2
;

877 i‡(!
bh
[
i
])

879 
îr2
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
group
, 
bh
[
i
]);

880 i‡(!
îr
)

881 
îr
 = 
îr2
;

884 
fú°_block
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
;

885 
i
 = 0; i < 
blocks_≥r_∑ge
; i++) {

886 
group
 = (
fú°_block
 + 
i
) >> 1;

887 i‡(
group
 >
ngroups
)

890 i‡(!
bh
[
group
 - 
fú°_group
])

894 i‡(!
	`buf„r_vîifõd
(
bh
[
group
 - 
fú°_group
]))

897 
îr
 = 0;

905 
d©a
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
i
 * 
blocksize
);

906 
bôm≠
 = 
bh
[
group
 - 
fú°_group
]->
b_d©a
;

912 i‡((
fú°_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
öc‹e
 =
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u inÖage %lu/%x\n",

916 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

917 
	`åa˚_pxt4_mb_buddy_bôm≠_lﬂd
(
sb
, 
group
);

918 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

919 
gröfo
->
bb_‰agmíts
 = 0;

920 
	`mem£t
(
gröfo
->
bb_cou¡îs
, 0,

921 (*
gröfo
->
bb_cou¡îs
) *

922 (
sb
->
s_blocksize_bôs
+2));

926 
	`pxt4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`pxt4_mb_gíî©e_buddy
(
sb
, 
d©a
, 
öc‹e
, 
group
);

930 
	`pxt4_u∆ock_group
(
sb
, 
group
);

931 
öc‹e
 = 
NULL
;

934 
	`BUG_ON
(
öc‹e
 !
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u inÖage %lu/%x\n",

936 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

937 
	`åa˚_pxt4_mb_bôm≠_lﬂd
(
sb
, 
group
);

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
	`mem˝y
(
d©a
, 
bôm≠
, 
blocksize
);

944 
	`pxt4_mb_gíî©e_‰om_∑
(
sb
, 
d©a
, 
group
);

945 
	`pxt4_mb_gíî©e_‰om_‰ìli°
(
sb
, 
d©a
, 
group
);

946 
	`pxt4_u∆ock_group
(
sb
, 
group
);

951 
öc‹e
 = 
d©a
;

954 
	`SëPageU±od©e
(
∑ge
);

956 
out
:

957 i‡(
bh
) {

958 
i
 = 0; i < 
groups_≥r_∑ge
; i++)

959 
	`bªl£
(
bh
[
i
]);

960 i‡(
bh
 !&
bhs
)

961 
	`k‰ì
(
bh
);

963  
îr
;

964 
	}
}

972 
	$pxt4_mb_gë_buddy_∑ge_lock
(
su≥r_block
 *
sb
,

973 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

975 
öode
 *öodê
	`PXT4_SB
(
sb
)->
s_buddy_ˇche
;

976 
block
, 
≤um
, 
poff
;

977 
blocks_≥r_∑ge
;

978 
∑ge
 *page;

980 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

981 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

983 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

991 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

993 i‡(!
∑ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

996 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

997 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

999 i‡(
blocks_≥r_∑ge
 >= 2) {

1004 
block
++;

1005 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1007 i‡(!
∑ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1010 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1012 
	}
}

1014 
	$pxt4_mb_put_buddy_∑ge_lock
(
pxt4_buddy
 *
e4b
)

1016 i‡(
e4b
->
bd_bôm≠_∑ge
) {

1017 
	`u∆ock_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1018 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1020 i‡(
e4b
->
bd_buddy_∑ge
) {

1021 
	`u∆ock_∑ge
(
e4b
->
bd_buddy_∑ge
);

1022 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1024 
	}
}

1031 
noölöe_f‹_°ack


1032 
	$pxt4_mb_öô_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
gÂ_t
 
gÂ
)

1035 
pxt4_group_öfo
 *
this_gΩ
;

1036 
pxt4_buddy
 
e4b
;

1037 
∑ge
 *page;

1038 
ªt
 = 0;

1040 
	`might_¶ìp
();

1041 
	`mb_debug
(1, "öô grou∞%u\n", 
group
);

1042 
this_gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1052 
ªt
 = 
	`pxt4_mb_gë_buddy_∑ge_lock
(
sb
, 
group
, &
e4b
, 
gÂ
);

1053 i‡(
ªt
 || !
	`PXT4_MB_GRP_NEED_INIT
(
this_gΩ
)) {

1058 
îr
;

1061 
∑ge
 = 
e4b
.
bd_bôm≠_∑ge
;

1062 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1063 i‡(
ªt
)

1064 
îr
;

1065 i‡(!
	`PageU±od©e
(
∑ge
)) {

1066 
ªt
 = -
EIO
;

1067 
îr
;

1070 i‡(
e4b
.
bd_buddy_∑ge
 =
NULL
) {

1076 
ªt
 = 0;

1077 
îr
;

1080 
∑ge
 = 
e4b
.
bd_buddy_∑ge
;

1081 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
.
bd_bôm≠
, 
gÂ
);

1082 i‡(
ªt
)

1083 
îr
;

1084 i‡(!
	`PageU±od©e
(
∑ge
)) {

1085 
ªt
 = -
EIO
;

1086 
îr
;

1088 
îr
:

1089 
	`pxt4_mb_put_buddy_∑ge_lock
(&
e4b
);

1090  
ªt
;

1091 
	}
}

1098 
noölöe_f‹_°ack
 

1099 
	$pxt4_mb_lﬂd_buddy_gÂ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1100 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

1102 
blocks_≥r_∑ge
;

1103 
block
;

1104 
≤um
;

1105 
poff
;

1106 
∑ge
 *page;

1107 
ªt
;

1108 
pxt4_group_öfo
 *
gΩ
;

1109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1110 
öode
 *öodê
sbi
->
s_buddy_ˇche
;

1112 
	`might_¶ìp
();

1113 
	`mb_debug
(1, "lﬂd grou∞%u\n", 
group
);

1115 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkbôs
 = 
sb
->
s_blocksize_bôs
;

1119 
e4b
->
bd_öfo
 = 
gΩ
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

1123 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

1125 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

1130 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
gÂ
);

1131 i‡(
ªt
)

1132  
ªt
;

1140 
block
 = 
group
 * 2;

1141 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1142 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1146 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1147 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1148 i‡(
∑ge
)

1157 
	`put_∑ge
(
∑ge
);

1158 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1159 i‡(
∑ge
) {

1160 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1161 i‡(!
	`PageU±od©e
(
∑ge
)) {

1162 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1163 i‡(
ªt
) {

1164 
	`u∆ock_∑ge
(
∑ge
);

1165 
îr
;

1167 
	`mb_cmp_bôm≠s
(
e4b
, 
	`∑ge_addªss
(
∑ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`u∆ock_∑ge
(
∑ge
);

1173 i‡(
∑ge
 =
NULL
) {

1174 
ªt
 = -
ENOMEM
;

1175 
îr
;

1177 i‡(!
	`PageU±od©e
(
∑ge
)) {

1178 
ªt
 = -
EIO
;

1179 
îr
;

1183 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

1184 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1188 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1190 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1191 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1192 i‡(
∑ge
)

1193 
	`put_∑ge
(
∑ge
);

1194 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1195 i‡(
∑ge
) {

1196 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1197 i‡(!
	`PageU±od©e
(
∑ge
)) {

1198 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
->
bd_bôm≠
,

1199 
gÂ
);

1200 i‡(
ªt
) {

1201 
	`u∆ock_∑ge
(
∑ge
);

1202 
îr
;

1205 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
∑ge
 =
NULL
) {

1209 
ªt
 = -
ENOMEM
;

1210 
îr
;

1212 i‡(!
	`PageU±od©e
(
∑ge
)) {

1213 
ªt
 = -
EIO
;

1214 
îr
;

1218 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1219 
e4b
->
bd_buddy
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

1226 
îr
:

1227 i‡(
∑ge
)

1228 
	`put_∑ge
(
∑ge
);

1229 i‡(
e4b
->
bd_bôm≠_∑ge
)

1230 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1231 i‡(
e4b
->
bd_buddy_∑ge
)

1232 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_bôm≠
 = 
NULL
;

1235  
ªt
;

1236 
	}
}

1238 
	$pxt4_mb_lﬂd_buddy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1239 
pxt4_buddy
 *
e4b
)

1241  
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$pxt4_mb_u∆ﬂd_buddy
(
pxt4_buddy
 *
e4b
)

1246 i‡(
e4b
->
bd_bôm≠_∑ge
)

1247 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1248 i‡(
e4b
->
bd_buddy_∑ge
)

1249 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1250 
	}
}

1253 
	$mb_föd_‹dî_f‹_block
(
pxt4_buddy
 *
e4b
, 
block
)

1255 
‹dî
 = 1;

1256 
bb_ö¸
 = 1 << (
e4b
->
bd_blkbôs
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >(1 << (
e4b
->
bd_blkbôs
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
‹dî
 <
e4b
->
bd_blkbôs
 + 1) {

1264 
block
 = block >> 1;

1265 i‡(!
	`mb_ã°_bô
(
block
, 
bb
)) {

1267  
‹dî
;

1269 
bb
 +
bb_ö¸
;

1270 
bb_ö¸
 >>= 1;

1271 
‹dî
++;

1274 
	}
}

1276 
	$mb_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1278 
__u32
 *
addr
;

1280 
Àn
 = 
cur
 +Üen;

1281 
cur
 < 
Àn
) {

1282 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_˛ór_bô
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_ã°_™d_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1299 
__u32
 *
addr
;

1300 
zîo_bô
 = -1;

1302 
Àn
 = 
cur
 +Üen;

1303 
cur
 < 
Àn
) {

1304 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 i‡(*
addr
 !(
__u32
)(-1Ë&& 
zîo_bô
 == -1)

1308 
zîo_bô
 = 
cur
 + 
	`mb_föd_√xt_zîo_bô
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 i‡(!
	`mb_ã°_™d_˛ór_bô
(
cur
, 
bm
Ë&& 
zîo_bô
 == -1)

1314 
zîo_bô
 = 
cur
;

1315 
cur
++;

1318  
zîo_bô
;

1319 
	}
}

1321 
	$pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
)

1323 
__u32
 *
addr
;

1325 
Àn
 = 
cur
 +Üen;

1326 
cur
 < 
Àn
) {

1327 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_bô
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
ölöe
 
	$mb_buddy_adju°_b‹dî
(* 
bô
, * 
bôm≠
, 
side
)

1344 i‡(
	`mb_ã°_bô
(*
bô
 + 
side
, 
bôm≠
)) {

1345 
	`mb_˛ór_bô
(*
bô
, 
bôm≠
);

1346 (*
bô
Ë-
side
;

1350 (*
bô
Ë+
side
;

1351 
	`mb_£t_bô
(*
bô
, 
bôm≠
);

1354 
	}
}

1356 
	$mb_buddy_m¨k_‰ì
(
pxt4_buddy
 *
e4b
, 
fú°
, 
œ°
)

1358 
max
;

1359 
‹dî
 = 1;

1360 *
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 i‡(
fú°
 & 1)

1395 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
fú°
, 
buddy
, -1);

1396 i‡(!(
œ°
 & 1))

1397 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
œ°
, 
buddy
, 1);

1398 i‡(
fú°
 > 
œ°
)

1400 
‹dî
++;

1402 i‡(
fú°
 =
œ°
 || !(
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
))) {

1403 
	`mb_˛ór_bôs
(
buddy
, 
fú°
, 
œ°
 - first + 1);

1404 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
 - 1] +
œ°
 - 
fú°
 + 1;

1407 
fú°
 >>= 1;

1408 
œ°
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_‰ì_blocks
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

1414 
fú°
, 
cou¡
)

1416 
À·_is_‰ì
 = 0;

1417 
right_is_‰ì
 = 0;

1418 
block
;

1419 
œ°
 = 
fú°
 + 
cou¡
 - 1;

1420 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 i‡(
	`WARN_ON
(
cou¡
 == 0))

1424 
	`BUG_ON
(
œ°
 >(
sb
->
s_blocksize
 << 3));

1425 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_‰ì_blocks_doubÀ
(
öode
, 
e4b
, 
fú°
, 
cou¡
);

1433 
e4b
->
bd_öfo
->
bb_‰ì
 +
cou¡
;

1434 i‡(
fú°
 < 
e4b
->
bd_öfo
->
bb_fú°_‰ì
)

1435 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 = 
fú°
;

1440 i‡(
fú°
 != 0)

1441 
À·_is_‰ì
 = !
	`mb_ã°_bô
(
fú°
 - 1, 
e4b
->
bd_bôm≠
);

1442 
block
 = 
	`mb_ã°_™d_˛ór_bôs
(
e4b
->
bd_bôm≠
, 
fú°
, 
cou¡
);

1443 i‡(
œ°
 + 1 < 
	`PXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_‰ì
 = !
	`mb_ã°_bô
(
œ°
 + 1, 
e4b
->
bd_bôm≠
);

1446 i‡(
	`u∆ikñy
(
block
 != -1)) {

1447 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1448 
pxt4_fsblk_t
 
blockƒ
;

1450 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockƒ
 +
	`PXT4_C2B
(
sbi
, 
block
);

1452 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

1453 
öode
 ? inode->
i_öo
 : 0,

1454 
blockƒ
,

1457 
block
);

1458 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_ªgíî©e_buddy
(
e4b
);

1461 
d⁄e
;

1465 i‡(
À·_is_‰ì
 && 
right_is_‰ì
)

1466 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1467 i‡(!
À·_is_‰ì
 && !
right_is_‰ì
)

1468 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1476 i‡(
fú°
 & 1) {

1477 
fú°
 +!
À·_is_‰ì
;

1478 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
À·_is_‰ì
 ? -1 : 1;

1480 i‡(!(
œ°
 & 1)) {

1481 
œ°
 -!
right_is_‰ì
;

1482 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
right_is_‰ì
 ? -1 : 1;

1485 i‡(
fú°
 <
œ°
)

1486 
	`mb_buddy_m¨k_‰ì
(
e4b
, 
fú°
 >> 1, 
œ°
 >> 1);

1488 
d⁄e
:

1489 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
e4b
->
bd_öfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_föd_exã¡
(
pxt4_buddy
 *
e4b
, 
block
,

1494 
√eded
, 
pxt4_‰ì_exã¡
 *
ex
)

1496 
√xt
 = 
block
;

1497 
max
, 
‹dî
;

1498 *
buddy
;

1500 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =
NULL
);

1503 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =
NULL
);

1505 
	`BUG_ON
(
block
 >
max
);

1506 i‡(
	`mb_ã°_bô
(
block
, 
buddy
)) {

1507 
ex
->
„_Àn
 = 0;

1508 
ex
->
„_°¨t
 = 0;

1509 
ex
->
„_group
 = 0;

1514 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
block
);

1515 
block
 = block >> 
‹dî
;

1517 
ex
->
„_Àn
 = 1 << 
‹dî
;

1518 
ex
->
„_°¨t
 = 
block
 << 
‹dî
;

1519 
ex
->
„_group
 = 
e4b
->
bd_group
;

1522 
√xt
 =Çexà- 
ex
->
„_°¨t
;

1523 
ex
->
„_Àn
 -
√xt
;

1524 
ex
->
„_°¨t
 +
√xt
;

1526 
√eded
 > 
ex
->
„_Àn
 &&

1527 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
)) {

1529 i‡(
block
 + 1 >
max
)

1532 
√xt
 = (
block
 + 1Ë* (1 << 
‹dî
);

1533 i‡(
	`mb_ã°_bô
(
√xt
, 
e4b
->
bd_bôm≠
))

1536 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
√xt
);

1538 
block
 = 
√xt
 >> 
‹dî
;

1539 
ex
->
„_Àn
 +1 << 
‹dî
;

1542 i‡(
ex
->
„_°¨t
 +Éx->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`pxt4_îr‹
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1547 
block
, 
‹dî
, 
√eded
, 
ex
->
„_group
,Éx->
„_°¨t
,

1548 
ex
->
„_Àn
,Éx->
„_logiˇl
);

1549 
ex
->
„_Àn
 = 0;

1550 
ex
->
„_°¨t
 = 0;

1551 
ex
->
„_group
 = 0;

1553  
ex
->
„_Àn
;

1554 
	}
}

1556 
	$mb_m¨k_u£d
(
pxt4_buddy
 *
e4b
, 
pxt4_‰ì_exã¡
 *
ex
)

1558 
‹d
;

1559 
mÀn
 = 0;

1560 
max
 = 0;

1561 
cur
;

1562 
°¨t
 = 
ex
->
„_°¨t
;

1563 
Àn
 = 
ex
->
„_Àn
;

1564 
ªt
 = 0;

1565 
Àn0
 = 
Àn
;

1566 *
buddy
;

1568 
	`BUG_ON
(
°¨t
 + 
Àn
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1569 
	`BUG_ON
(
e4b
->
bd_group
 !
ex
->
„_group
);

1570 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1571 
	`mb_check_buddy
(
e4b
);

1572 
	`mb_m¨k_u£d_doubÀ
(
e4b
, 
°¨t
, 
Àn
);

1574 
e4b
->
bd_öfo
->
bb_‰ì
 -
Àn
;

1575 i‡(
e4b
->
bd_öfo
->
bb_fú°_‰ì
 =
°¨t
)

1576 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 +
Àn
;

1579 i‡(
°¨t
 != 0)

1580 
mÀn
 = !
	`mb_ã°_bô
(
°¨t
 - 1, 
e4b
->
bd_bôm≠
);

1581 i‡(
°¨t
 + 
Àn
 < 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1582 
max
 = !
	`mb_ã°_bô
(
°¨t
 + 
Àn
, 
e4b
->
bd_bôm≠
);

1583 i‡(
mÀn
 && 
max
)

1584 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1585 i‡(!
mÀn
 && !
max
)

1586 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1589 
Àn
) {

1590 
‹d
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
°¨t
);

1592 i‡(((
°¨t
 >> 
‹d
Ë<< ordË=°¨à&& 
Àn
 >= (1 << ord)) {

1594 
mÀn
 = 1 << 
‹d
;

1595 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1596 
	`BUG_ON
((
°¨t
 >> 
‹d
Ë>
max
);

1597 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1598 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1599 
°¨t
 +
mÀn
;

1600 
Àn
 -
mÀn
;

1601 
	`BUG_ON
(
Àn
 < 0);

1606 i‡(
ªt
 == 0)

1607 
ªt
 = 
Àn
 | (
‹d
 << 16);

1610 
	`BUG_ON
(
‹d
 <= 0);

1611 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1612 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1613 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1615 
‹d
--;

1616 
cur
 = (
°¨t
 >> 
‹d
) & ~1U;

1617 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1618 
	`mb_˛ór_bô
(
cur
, 
buddy
);

1619 
	`mb_˛ór_bô
(
cur
 + 1, 
buddy
);

1620 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1621 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1623 
	`mb_£t_œrge°_‰ì_‹dî
(
e4b
->
bd_sb
,É4b->
bd_öfo
);

1625 
	`pxt4_£t_bôs
(
e4b
->
bd_bôm≠
, 
ex
->
„_°¨t
, 
Àn0
);

1626 
	`mb_check_buddy
(
e4b
);

1628  
ªt
;

1629 
	}
}

1634 
	$pxt4_mb_u£_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1635 
pxt4_buddy
 *
e4b
)

1637 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1638 
ªt
;

1640 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_group
 !
e4b
->
bd_group
);

1641 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

1643 
ac
->
ac_b_ex
.
„_Àn
 = 
	`mö
◊c->ac_b_ex.„_Àn,ác->
ac_g_ex
.fe_len);

1644 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_g_ex
.fe_logical;

1645 
ªt
 = 
	`mb_m¨k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1649 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

1651 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

1652 
ac
->
ac_èû
 = 
ªt
 & 0xffff;

1653 
ac
->
ac_buddy
 = 
ªt
 >> 16;

1662 
ac
->
ac_bôm≠_∑ge
 = 
e4b
->
bd_bôm≠_∑ge
;

1663 
	`gë_∑ge
(
ac
->
ac_bôm≠_∑ge
);

1664 
ac
->
ac_buddy_∑ge
 = 
e4b
->
bd_buddy_∑ge
;

1665 
	`gë_∑ge
(
ac
->
ac_buddy_∑ge
);

1667 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

1668 
	`•ö_lock
(&
sbi
->
s_md_lock
);

1669 
sbi
->
s_mb_œ°_group
 = 
ac
->
ac_f_ex
.
„_group
;

1670 
sbi
->
s_mb_œ°_°¨t
 = 
ac
->
ac_f_ex
.
„_°¨t
;

1671 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

1673 
	}
}

1679 
	$pxt4_mb_check_limôs
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1680 
pxt4_buddy
 *
e4b
,

1681 
föish_group
)

1683 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1684 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1685 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1686 
pxt4_‰ì_exã¡
 
ex
;

1687 
max
;

1689 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

1694 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
 &&

1695 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1696 
ac
->
ac_°©us
 = 
AC_STATUS_BREAK
;

1703 i‡(
bex
->
„_Àn
 < 
gex
->fe_len)

1706 i‡((
föish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mö_to_sˇn
)

1707 && 
bex
->
„_group
 =
e4b
->
bd_group
) {

1711 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
bex
->
„_°¨t
, 
gex
->
„_Àn
, &
ex
);

1712 i‡(
max
 >
gex
->
„_Àn
) {

1713 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1717 
	}
}

1729 
	$pxt4_mb_mósuª_exã¡
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1730 
pxt4_‰ì_exã¡
 *
ex
,

1731 
pxt4_buddy
 *
e4b
)

1733 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1734 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1736 
	`BUG_ON
(
ex
->
„_Àn
 <= 0);

1737 
	`BUG_ON
(
ex
->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1738 
	`BUG_ON
(
ex
->
„_°¨t
 >
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
);

1741 
ac
->
ac_found
++;

1746 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1747 *
bex
 = *
ex
;

1748 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1755 i‡(
ex
->
„_Àn
 =
gex
->fe_len) {

1756 *
bex
 = *
ex
;

1757 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1764 i‡(
bex
->
„_Àn
 == 0) {

1765 *
bex
 = *
ex
;

1772 i‡(
bex
->
„_Àn
 < 
gex
->fe_len) {

1775 i‡(
ex
->
„_Àn
 > 
bex
->fe_len)

1776 *
bex
 = *
ex
;

1777 } i‡(
ex
->
„_Àn
 > 
gex
->fe_len) {

1781 i‡(
ex
->
„_Àn
 < 
bex
->fe_len)

1782 *
bex
 = *
ex
;

1785 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 0);

1786 
	}
}

1788 
noölöe_f‹_°ack


1789 
	$pxt4_mb_åy_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1790 
pxt4_buddy
 *
e4b
)

1792 
pxt4_‰ì_exã¡
 
ex
 = 
ac
->
ac_b_ex
;

1793 
pxt4_group_t
 
group
 = 
ex
.
„_group
;

1794 
max
;

1795 
îr
;

1797 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1798 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1799 i‡(
îr
)

1800  
îr
;

1802 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1803 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ex
.
„_°¨t
,Éx.
„_Àn
, &ex);

1805 i‡(
max
 > 0) {

1806 
ac
->
ac_b_ex
 = 
ex
;

1807 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1810 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1811 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1814 
	}
}

1816 
noölöe_f‹_°ack


1817 
	$pxt4_mb_föd_by_gﬂl
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1818 
pxt4_buddy
 *
e4b
)

1820 
pxt4_group_t
 
group
 = 
ac
->
ac_g_ex
.
„_group
;

1821 
max
;

1822 
îr
;

1823 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1824 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

1825 
pxt4_‰ì_exã¡
 
ex
;

1827 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_TRY_GOAL
))

1829 i‡(
gΩ
->
bb_‰ì
 == 0)

1832 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1833 i‡(
îr
)

1834  
îr
;

1836 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
))) {

1837 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1841 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1842 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ac
->
ac_g_ex
.
„_°¨t
,

1843 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1844 
ex
.
„_logiˇl
 = 0xDEADFA11;

1846 i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
 &&ác->ac_g_ex.„_À¿=
sbi
->
s_°rùe
) {

1847 
pxt4_fsblk_t
 
°¨t
;

1849 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1850 
ex
.
„_°¨t
;

1852 i‡(
	`do_div
(
°¨t
, 
sbi
->
s_°rùe
) == 0) {

1853 
ac
->
ac_found
++;

1854 
ac
->
ac_b_ex
 = 
ex
;

1855 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1857 } i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
) {

1858 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1859 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1860 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1861 
ac
->
ac_found
++;

1862 
ac
->
ac_b_ex
 = 
ex
;

1863 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1864 } i‡(
max
 > 0 && (
ac
->
ac_Êags
 & 
PXT4_MB_HINT_MERGE
)) {

1867 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1868 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1869 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1870 
ac
->
ac_found
++;

1871 
ac
->
ac_b_ex
 = 
ex
;

1872 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1874 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1875 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1878 
	}
}

1884 
noölöe_f‹_°ack


1885 
	$pxt4_mb_sim∂e_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1886 
pxt4_buddy
 *
e4b
)

1888 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1889 
pxt4_group_öfo
 *
gΩ
 = 
e4b
->
bd_öfo
;

1890 *
buddy
;

1891 
i
;

1892 
k
;

1893 
max
;

1895 
	`BUG_ON
(
ac
->
ac_2‹dî
 <= 0);

1896 
i
 = 
ac
->
ac_2‹dî
; i <
sb
->
s_blocksize_bôs
 + 1; i++) {

1897 i‡(
gΩ
->
bb_cou¡îs
[
i
] == 0)

1900 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
i
, &
max
);

1901 
	`BUG_ON
(
buddy
 =
NULL
);

1903 
k
 = 
	`mb_föd_√xt_zîo_bô
(
buddy
, 
max
, 0);

1904 
	`BUG_ON
(
k
 >
max
);

1906 
ac
->
ac_found
++;

1908 
ac
->
ac_b_ex
.
„_Àn
 = 1 << 
i
;

1909 
ac
->
ac_b_ex
.
„_°¨t
 = 
k
 << 
i
;

1910 
ac
->
ac_b_ex
.
„_group
 = 
e4b
->
bd_group
;

1912 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1914 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 !ac->
ac_g_ex
.fe_len);

1916 i‡(
	`PXT4_SB
(
sb
)->
s_mb_°©s
)

1917 
	`©omic_öc
(&
	`PXT4_SB
(
sb
)->
s_bÆ_2‹dîs
);

1921 
	}
}

1928 
noölöe_f‹_°ack


1929 
	$pxt4_mb_com∂ex_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1930 
pxt4_buddy
 *
e4b
)

1932 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1933 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1934 
pxt4_‰ì_exã¡
 
ex
;

1935 
i
;

1936 
‰ì
;

1938 
‰ì
 = 
e4b
->
bd_öfo
->
bb_‰ì
;

1939 
	`BUG_ON
(
‰ì
 <= 0);

1941 
i
 = 
e4b
->
bd_öfo
->
bb_fú°_‰ì
;

1943 
‰ì
 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
) {

1944 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
,

1945 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1946 i‡(
i
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1952 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1955 
‰ì
);

1956 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1957 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1961 
	`mb_föd_exã¡
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1962 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1963 i‡(
‰ì
 < 
ex
.
„_Àn
) {

1964 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1967 
‰ì
, 
ex
.
„_Àn
);

1968 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1969 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1977 
ex
.
„_logiˇl
 = 0xDEADC0DE;

1978 
	`pxt4_mb_mósuª_exã¡
(
ac
, &
ex
, 
e4b
);

1980 
i
 +
ex
.
„_Àn
;

1981 
‰ì
 -
ex
.
„_Àn
;

1984 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 1);

1985 
	}
}

1991 
noölöe_f‹_°ack


1992 
	$pxt4_mb_sˇn_Æig√d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1993 
pxt4_buddy
 *
e4b
)

1995 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1996 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1997 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1998 
pxt4_‰ì_exã¡
 
ex
;

1999 
pxt4_fsblk_t
 
fú°_group_block
;

2000 
pxt4_fsblk_t
 
a
;

2001 
pxt4_gΩblk_t
 
i
;

2002 
max
;

2004 
	`BUG_ON
(
sbi
->
s_°rùe
 == 0);

2007 
fú°_group_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

2009 
a
 = 
fú°_group_block
 + 
sbi
->
s_°rùe
 - 1;

2010 
	`do_div
(
a
, 
sbi
->
s_°rùe
);

2011 
i
 = (
a
 * 
sbi
->
s_°rùe
Ë- 
fú°_group_block
;

2013 
i
 < 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2014 i‡(!
	`mb_ã°_bô
(
i
, 
bôm≠
)) {

2015 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
i
, 
sbi
->
s_°rùe
, &
ex
);

2016 i‡(
max
 >
sbi
->
s_°rùe
) {

2017 
ac
->
ac_found
++;

2018 
ex
.
„_logiˇl
 = 0xDEADF00D;

2019 
ac
->
ac_b_ex
 = 
ex
;

2020 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

2024 
i
 +
sbi
->
s_°rùe
;

2026 
	}
}

2034 
	$pxt4_mb_good_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2035 
pxt4_group_t
 
group
, 
¸
)

2037 
‰ì
, 
‰agmíts
;

2038 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
ac
->
ac_sb
));

2039 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

2041 
	`BUG_ON
(
¸
 < 0 || cr >= 4);

2043 
‰ì
 = 
gΩ
->
bb_‰ì
;

2044 i‡(
‰ì
 == 0)

2046 i‡(
¸
 <2 && 
‰ì
 < 
ac
->
ac_g_ex
.
„_Àn
)

2049 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
)))

2053 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

2054 
ªt
 = 
	`pxt4_mb_öô_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2055 i‡(
ªt
)

2056  
ªt
;

2059 
‰agmíts
 = 
gΩ
->
bb_‰agmíts
;

2060 i‡(
‰agmíts
 == 0)

2063 
¸
) {

2065 
	`BUG_ON
(
ac
->
ac_2‹dî
 == 0);

2068 i‡((
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
) &&

2069 (
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2070 ((
group
 % 
Êex_size
) == 0))

2073 i‡((
ac
->
ac_2‹dî
 >ác->
ac_sb
->
s_blocksize_bôs
+1) ||

2074 (
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2077 i‡(
gΩ
->
bb_œrge°_‰ì_‹dî
 < 
ac
->
ac_2‹dî
)

2082 i‡((
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2086 i‡(
‰ì
 >
ac
->
ac_g_ex
.
„_Àn
)

2092 
	`BUG
();

2096 
	}
}

2098 
noölöe_f‹_°ack
 

2099 
	$pxt4_mb_ªguœr_Æloˇt‹
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

2101 
pxt4_group_t
 
ngroups
, 
group
, 
i
;

2102 
¸
;

2103 
îr
 = 0, 
fú°_îr
 = 0;

2104 
pxt4_sb_öfo
 *
sbi
;

2105 
su≥r_block
 *
sb
;

2106 
pxt4_buddy
 
e4b
;

2108 
sb
 = 
ac
->
ac_sb
;

2109 
sbi
 = 
	`PXT4_SB
(
sb
);

2110 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2112 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)))

2113 
ngroups
 = 
sbi
->
s_blockfûe_groups
;

2115 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

2118 
îr
 = 
	`pxt4_mb_föd_by_gﬂl
(
ac
, &
e4b
);

2119 i‡(
îr
 || 
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

2120 
out
;

2122 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

2123 
out
;

2130 
i
 = 
	`Ês
(
ac
->
ac_g_ex
.
„_Àn
);

2131 
ac
->
ac_2‹dî
 = 0;

2139 i‡(
i
 >
sbi
->
s_mb_‹dî2_ªqs
 && i <
sb
->
s_blocksize_bôs
 + 2) {

2143 i‡((
ac
->
ac_g_ex
.
„_Àn
 & (~(1 << (
i
 - 1)))) == 0)

2144 
ac
->
ac_2‹dî
 = 
	`¨øy_ödex_no•ec
(
i
 - 1,

2145 
sb
->
s_blocksize_bôs
 + 2);

2149 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

2151 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2152 
ac
->
ac_g_ex
.
„_group
 = 
sbi
->
s_mb_œ°_group
;

2153 
ac
->
ac_g_ex
.
„_°¨t
 = 
sbi
->
s_mb_œ°_°¨t
;

2154 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2158 
¸
 = 
ac
->
ac_2‹dî
 ? 0 : 1;

2163 
ª≥©
:

2164 ; 
¸
 < 4 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
; cr++) {

2165 
ac
->
ac_¸ôîü
 = 
¸
;

2170 
group
 = 
ac
->
ac_g_ex
.
„_group
;

2172 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2173 
ªt
 = 0;

2174 
	`c⁄d_ªsched
();

2179 i‡(
group
 >
ngroups
)

2180 
group
 = 0;

2183 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2184 i‡(
ªt
 <= 0) {

2185 i‡(!
fú°_îr
)

2186 
fú°_îr
 = 
ªt
;

2190 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2191 i‡(
îr
)

2192 
out
;

2194 
	`pxt4_lock_group
(
sb
, 
group
);

2200 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2201 i‡(
ªt
 <= 0) {

2202 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2203 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2204 i‡(!
fú°_îr
)

2205 
fú°_îr
 = 
ªt
;

2209 
ac
->
ac_groups_sˇ¬ed
++;

2210 i‡(
¸
 == 0)

2211 
	`pxt4_mb_sim∂e_sˇn_group
(
ac
, &
e4b
);

2212 i‡(
¸
 =1 && 
sbi
->
s_°rùe
 &&

2213 !(
ac
->
ac_g_ex
.
„_Àn
 % 
sbi
->
s_°rùe
))

2214 
	`pxt4_mb_sˇn_Æig√d
(
ac
, &
e4b
);

2216 
	`pxt4_mb_com∂ex_sˇn_group
(
ac
, &
e4b
);

2218 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2219 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2221 i‡(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
)

2226 i‡(
ac
->
ac_b_ex
.
„_Àn
 > 0 &&ác->
ac_°©us
 !
AC_STATUS_FOUND
 &&

2227 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

2233 
	`pxt4_mb_åy_be°_found
(
ac
, &
e4b
);

2234 i‡(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
) {

2241 
ac
->
ac_b_ex
.
„_group
 = 0;

2242 
ac
->
ac_b_ex
.
„_°¨t
 = 0;

2243 
ac
->
ac_b_ex
.
„_Àn
 = 0;

2244 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

2245 
ac
->
ac_Êags
 |
PXT4_MB_HINT_FIRST
;

2246 
¸
 = 3;

2247 
	`©omic_öc
(&
sbi
->
s_mb_lo°_chunks
);

2248 
ª≥©
;

2251 
out
:

2252 i‡(!
îr
 && 
ac
->
ac_°©us
 !
AC_STATUS_FOUND
 && 
fú°_îr
)

2253 
îr
 = 
fú°_îr
;

2254  
îr
;

2255 
	}
}

2257 *
	$pxt4_mb_£q_groups_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

2259 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2260 
pxt4_group_t
 
group
;

2262 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2263  
NULL
;

2264 
group
 = *
pos
 + 1;

2265  (*Ë((Ë
group
);

2266 
	}
}

2268 *
	$pxt4_mb_£q_groups_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2270 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2271 
pxt4_group_t
 
group
;

2273 ++*
pos
;

2274 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2275  
NULL
;

2276 
group
 = *
pos
 + 1;

2277  (*Ë((Ë
group
);

2278 
	}
}

2280 
	$pxt4_mb_£q_groups_show
(
£q_fûe
 *
£q
, *
v
)

2282 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2283 
pxt4_group_t
 
group
 = (pxt4_group_tË((Ë
v
);

2284 
i
;

2285 
îr
, 
buddy_lﬂded
 = 0;

2286 
pxt4_buddy
 
e4b
;

2287 
pxt4_group_öfo
 *
gröfo
;

2288 
blocksize_bôs
 = 
	`mö_t
(,

2289 
sb
->
s_blocksize_bôs
,

2290 
PXT4_MAX_BLOCK_LOG_SIZE
);

2291 
	ssg
 {

2292 
pxt4_group_öfo
 
öfo
;

2293 
pxt4_gΩblk_t
 
cou¡îs
[
PXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2294 } 
sg
;

2296 
group
--;

2297 i‡(
group
 == 0)

2298 
	`£q_puts
(
£q
, "#group: free frags first ["

2302 
i
 = (
blocksize_bôs
 + 2Ë* (
sg
.
öfo
.
bb_cou¡îs
[0]) +

2303 (
pxt4_group_öfo
);

2305 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

2307 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
))) {

2308 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2309 i‡(
îr
) {

2310 
	`£q_¥ötf
(
£q
, "#%-5u: I/OÉº‹\n", 
group
);

2313 
buddy_lﬂded
 = 1;

2316 
	`mem˝y
(&
sg
, 
	`pxt4_gë_group_öfo
(
sb
, 
group
), 
i
);

2318 i‡(
buddy_lﬂded
)

2319 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2321 
	`£q_¥ötf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
öfo
.
bb_‰ì
,

2322 
sg
.
öfo
.
bb_‰agmíts
, sg.öfo.
bb_fú°_‰ì
);

2323 
i
 = 0; i <= 13; i++)

2324 
	`£q_¥ötf
(
£q
, " %-5u", 
i
 <
blocksize_bôs
 + 1 ?

2325 
sg
.
öfo
.
bb_cou¡îs
[
i
] : 0);

2326 
	`£q_¥ötf
(
£q
, " ]\n");

2329 
	}
}

2331 
	$pxt4_mb_£q_groups_°›
(
£q_fûe
 *
£q
, *
v
)

2333 
	}
}

2335 c⁄° 
£q_›î©i⁄s
 
	gpxt4_mb_£q_groups_›s
 = {

2336 .
°¨t
 = 
pxt4_mb_£q_groups_°¨t
,

2337 .
	g√xt
 = 
pxt4_mb_£q_groups_√xt
,

2338 .
	g°›
 = 
pxt4_mb_£q_groups_°›
,

2339 .
	gshow
 = 
pxt4_mb_£q_groups_show
,

2342 
kmem_ˇche
 *
	$gë_groupöfo_ˇche
(
blocksize_bôs
)

2344 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2345 
kmem_ˇche
 *
ˇchï
 = 
pxt4_groupöfo_ˇches
[
ˇche_ödex
];

2347 
	`BUG_ON
(!
ˇchï
);

2348  
ˇchï
;

2349 
	}
}

2355 
	$pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroups
)

2357 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2358 
size
;

2359 
pxt4_group_öfo
 ***
ﬁd_groupöfo
, ***
√w_groupöfo
;

2361 
size
 = (
ngroups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2362 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2363 i‡(
size
 <
sbi
->
s_group_öfo_size
)

2366 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_öfo
) * size);

2367 
√w_groupöfo
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2368 i‡(!
√w_groupöfo
) {

2369 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy meta group");

2370  -
ENOMEM
;

2372 
	`rcu_ªad_lock
();

2373 
ﬁd_groupöfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2374 i‡(
ﬁd_groupöfo
)

2375 
	`mem˝y
(
√w_groupöfo
, 
ﬁd_groupöfo
,

2376 
sbi
->
s_group_öfo_size
 * (*sbi->
s_group_öfo
));

2377 
	`rcu_ªad_u∆ock
();

2378 
	`rcu_assign_poöãr
(
sbi
->
s_group_öfo
, 
√w_groupöfo
);

2379 
sbi
->
s_group_öfo_size
 = 
size
 / (*sbi->
s_group_öfo
);

2380 i‡(
ﬁd_groupöfo
)

2381 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groupöfo
);

2382 
	`pxt4_debug
("allocated s_groupinfoárray for %d meta_bg's\n",

2383 
sbi
->
s_group_öfo_size
);

2385 
	}
}

2388 
	$pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2389 
pxt4_group_desc
 *
desc
)

2391 
i
;

2392 
mëÆí
 = 0;

2393 
idx
 = 
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2394 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2395 
pxt4_group_öfo
 **
mëa_group_öfo
;

2396 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2403 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2404 
mëÆí
 = (*
mëa_group_öfo
) <<

2405 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2406 
mëa_group_öfo
 = 
	`kmÆloc
(
mëÆí
, 
GFP_NOFS
);

2407 i‡(
mëa_group_öfo
 =
NULL
) {

2408 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate mem "

2410 
exô_mëa_group_öfo
;

2412 
	`rcu_ªad_lock
();

2413 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
)[
idx
] = 
mëa_group_öfo
;

2414 
	`rcu_ªad_u∆ock
();

2417 
mëa_group_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_öfo
, 
idx
);

2418 
i
 = 
group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

2420 
mëa_group_öfo
[
i
] = 
	`kmem_ˇche_zÆloc
(
ˇchï
, 
GFP_NOFS
);

2421 i‡(
mëa_group_öfo
[
i
] =
NULL
) {

2422 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy mem");

2423 
exô_group_öfo
;

2425 
	`£t_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
,

2426 &(
mëa_group_öfo
[
i
]->
bb_°©e
));

2432 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2433 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2434 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2435 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
desc
);

2437 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2438 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

2441 
	`INIT_LIST_HEAD
(&
mëa_group_öfo
[
i
]->
bb_¥óŒoc_li°
);

2442 
	`öô_rw£m
(&
mëa_group_öfo
[
i
]->
Æloc_£m
);

2443 
mëa_group_öfo
[
i
]->
bb_‰ì_roŸ
 = 
RB_ROOT
;

2444 
mëa_group_öfo
[
i
]->
bb_œrge°_‰ì_‹dî
 = -1;

2446 #ifde‡
DOUBLE_CHECK


2448 
buf„r_hód
 *
bh
;

2449 
mëa_group_öfo
[
i
]->
bb_bôm≠
 =

2450 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2451 
	`BUG_ON
(
mëa_group_öfo
[
i
]->
bb_bôm≠
 =
NULL
);

2452 
bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

2453 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2454 
	`mem˝y
(
mëa_group_öfo
[
i
]->
bb_bôm≠
, 
bh
->
b_d©a
,

2455 
sb
->
s_blocksize
);

2456 
	`put_bh
(
bh
);

2462 
exô_group_öfo
:

2464 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2465 
pxt4_group_öfo
 ***
group_öfo
;

2467 
	`rcu_ªad_lock
();

2468 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2469 
	`k‰ì
(
group_öfo
[
idx
]);

2470 
group_öfo
[
idx
] = 
NULL
;

2471 
	`rcu_ªad_u∆ock
();

2473 
exô_mëa_group_öfo
:

2474  -
ENOMEM
;

2475 
	}
}

2477 
	$pxt4_mb_öô_backíd
(
su≥r_block
 *
sb
)

2479 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2480 
pxt4_group_t
 
i
;

2481 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2482 
îr
;

2483 
pxt4_group_desc
 *
desc
;

2484 
pxt4_group_öfo
 ***
group_öfo
;

2485 
kmem_ˇche
 *
ˇchï
;

2487 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
ngroups
);

2488 i‡(
îr
)

2489  
îr
;

2491 
sbi
->
s_buddy_ˇche
 = 
	`√w_öode
(
sb
);

2492 i‡(
sbi
->
s_buddy_ˇche
 =
NULL
) {

2493 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't getÇew inode");

2494 
îr_‰ìsgi
;

2500 
sbi
->
s_buddy_ˇche
->
i_öo
 = 
PXT4_BAD_INO
;

2501 
	`PXT4_I
(
sbi
->
s_buddy_ˇche
)->
i_disksize
 = 0;

2502 
i
 = 0; i < 
ngroups
; i++) {

2503 
	`c⁄d_ªsched
();

2504 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2505 i‡(
desc
 =
NULL
) {

2506 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "ˇn'àªad des¸ùt‹ %u", 
i
);

2507 
îr_‰ìbuddy
;

2509 i‡(
	`pxt4_mb_add_groupöfo
(
sb
, 
i
, 
desc
) != 0)

2510 
îr_‰ìbuddy
;

2515 
îr_‰ìbuddy
:

2516 
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2517 
i
-- > 0)

2518 
	`kmem_ˇche_‰ì
(
ˇchï
, 
	`pxt4_gë_group_öfo
(
sb
, 
i
));

2519 
i
 = 
sbi
->
s_group_öfo_size
;

2520 
	`rcu_ªad_lock
();

2521 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2522 
i
-- > 0)

2523 
	`k‰ì
(
group_öfo
[
i
]);

2524 
	`rcu_ªad_u∆ock
();

2525 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2526 
îr_‰ìsgi
:

2527 
	`rcu_ªad_lock
();

2528 
	`kv‰ì
(
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
));

2529 
	`rcu_ªad_u∆ock
();

2530  -
ENOMEM
;

2531 
	}
}

2533 
	$pxt4_groupöfo_de°roy_¶abs
()

2535 
i
;

2537 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2538 
	`kmem_ˇche_de°roy
(
pxt4_groupöfo_ˇches
[
i
]);

2539 
pxt4_groupöfo_ˇches
[
i
] = 
NULL
;

2541 
	}
}

2543 
	$pxt4_groupöfo_¸óã_¶ab
(
size_t
 
size
)

2545 
	`DEFINE_MUTEX
(
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2546 
¶ab_size
;

2547 
blocksize_bôs
 = 
	`‹dî_ba£_2
(
size
);

2548 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2549 
kmem_ˇche
 *
ˇchï
;

2551 i‡(
ˇche_ödex
 >
NR_GRPINFO_CACHES
)

2552  -
EINVAL
;

2554 i‡(
	`u∆ikñy
(
ˇche_ödex
 < 0))

2555 
ˇche_ödex
 = 0;

2557 
	`muãx_lock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2558 i‡(
pxt4_groupöfo_ˇches
[
ˇche_ödex
]) {

2559 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2563 
¶ab_size
 = 
	`off£tof
(
pxt4_group_öfo
,

2564 
bb_cou¡îs
[
blocksize_bôs
 + 2]);

2566 
ˇchï
 = 
	`kmem_ˇche_¸óã
(
pxt4_groupöfo_¶ab_«mes
[
ˇche_ödex
],

2567 
¶ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2568 
NULL
);

2570 
pxt4_groupöfo_ˇches
[
ˇche_ödex
] = 
ˇchï
;

2572 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2573 i‡(!
ˇchï
) {

2574 
	`¥ötk
(
KERN_EMERG


2576  -
ENOMEM
;

2580 
	}
}

2582 
	$pxt4_mb_öô
(
su≥r_block
 *
sb
)

2584 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2585 
i
, 
j
;

2586 
off£t
, 
off£t_ö¸
;

2587 
max
;

2588 
ªt
;

2590 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_off£ts
);

2592 
sbi
->
s_mb_off£ts
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2593 i‡(
sbi
->
s_mb_off£ts
 =
NULL
) {

2594 
ªt
 = -
ENOMEM
;

2595 
out
;

2598 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_maxs
);

2599 
sbi
->
s_mb_maxs
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2600 i‡(
sbi
->
s_mb_maxs
 =
NULL
) {

2601 
ªt
 = -
ENOMEM
;

2602 
out
;

2605 
ªt
 = 
	`pxt4_groupöfo_¸óã_¶ab
(
sb
->
s_blocksize
);

2606 i‡(
ªt
 < 0)

2607 
out
;

2610 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2611 
sbi
->
s_mb_off£ts
[0] = 0;

2613 
i
 = 1;

2614 
off£t
 = 0;

2615 
off£t_ö¸
 = 1 << (
sb
->
s_blocksize_bôs
 - 1);

2616 
max
 = 
sb
->
s_blocksize
 << 2;

2618 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2619 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2620 
off£t
 +
off£t_ö¸
;

2621 
off£t_ö¸
 = offset_incr >> 1;

2622 
max
 = max >> 1;

2623 
i
++;

2624 } 
i
 <
sb
->
s_blocksize_bôs
 + 1);

2626 
	`•ö_lock_öô
(&
sbi
->
s_md_lock
);

2627 
	`•ö_lock_öô
(&
sbi
->
s_bÆ_lock
);

2628 
sbi
->
s_mb_‰ì_≥ndög
 = 0;

2629 
	`INIT_LIST_HEAD
(&
sbi
->
s_‰ìd_d©a_li°
);

2631 
sbi
->
s_mb_max_to_sˇn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2632 
sbi
->
s_mb_mö_to_sˇn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2633 
sbi
->
s_mb_°©s
 = 
MB_DEFAULT_STATS
;

2634 
sbi
->
s_mb_°ªam_ªque°
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2635 
sbi
->
s_mb_‹dî2_ªqs
 = 
MB_DEFAULT_ORDER2_REQS
;

2648 
sbi
->
s_mb_group_¥óŒoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2649 
sbi
->
s_˛u°î_bôs
, 32);

2658 i‡(
sbi
->
s_°rùe
 > 1) {

2659 
sbi
->
s_mb_group_¥óŒoc
 = 
	`roundup
(

2660 
sbi
->
s_mb_group_¥óŒoc
, sbi->
s_°rùe
);

2663 
sbi
->
s_loˇlôy_groups
 = 
	`Æloc_≥r˝u
(
pxt4_loˇlôy_group
);

2664 i‡(
sbi
->
s_loˇlôy_groups
 =
NULL
) {

2665 
ªt
 = -
ENOMEM
;

2666 
out
;

2668 
	`f‹_óch_possibÀ_˝u
(
i
) {

2669 
pxt4_loˇlôy_group
 *
lg
;

2670 
lg
 = 
	`≥r_˝u_±r
(
sbi
->
s_loˇlôy_groups
, 
i
);

2671 
	`muãx_öô
(&
lg
->
lg_muãx
);

2672 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2673 
	`INIT_LIST_HEAD
(&
lg
->
lg_¥óŒoc_li°
[
j
]);

2674 
	`•ö_lock_öô
(&
lg
->
lg_¥óŒoc_lock
);

2678 
ªt
 = 
	`pxt4_mb_öô_backíd
(
sb
);

2679 i‡(
ªt
 != 0)

2680 
out_‰ì_loˇlôy_groups
;

2684 
out_‰ì_loˇlôy_groups
:

2685 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2686 
sbi
->
s_loˇlôy_groups
 = 
NULL
;

2687 
out
:

2688 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2689 
sbi
->
s_mb_off£ts
 = 
NULL
;

2690 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2691 
sbi
->
s_mb_maxs
 = 
NULL
;

2692  
ªt
;

2693 
	}
}

2696 
	$pxt4_mb_˛ónup_∑
(
pxt4_group_öfo
 *
gΩ
)

2698 
pxt4_¥óŒoc_•a˚
 *
∑
;

2699 
li°_hód
 *
cur
, *
tmp
;

2700 
cou¡
 = 0;

2702 
	`li°_f‹_óch_ß„
(
cur
, 
tmp
, &
gΩ
->
bb_¥óŒoc_li°
) {

2703 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

2704 
	`li°_dñ
(&
∑
->
∑_group_li°
);

2705 
cou¡
++;

2706 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

2708 i‡(
cou¡
)

2709 
	`mb_debug
(1, "mbÆloc: %u PA†À·\n", 
cou¡
);

2711 
	}
}

2713 
	$pxt4_mb_ªÀa£
(
su≥r_block
 *
sb
)

2715 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2716 
pxt4_group_t
 
i
;

2717 
num_mëa_group_öfos
;

2718 
pxt4_group_öfo
 *
gröfo
, ***
group_öfo
;

2719 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2720 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2722 i‡(
sbi
->
s_group_öfo
) {

2723 
i
 = 0; i < 
ngroups
; i++) {

2724 
	`c⁄d_ªsched
();

2725 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

2726 #ifde‡
DOUBLE_CHECK


2727 
	`k‰ì
(
gröfo
->
bb_bôm≠
);

2729 
	`pxt4_lock_group
(
sb
, 
i
);

2730 
	`pxt4_mb_˛ónup_∑
(
gröfo
);

2731 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2732 
	`kmem_ˇche_‰ì
(
ˇchï
, 
gröfo
);

2734 
num_mëa_group_öfos
 = (
ngroups
 +

2735 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2736 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2737 
	`rcu_ªad_lock
();

2738 
group_öfo
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_öfo
);

2739 
i
 = 0; i < 
num_mëa_group_öfos
; i++)

2740 
	`k‰ì
(
group_öfo
[
i
]);

2741 
	`kv‰ì
(
group_öfo
);

2742 
	`rcu_ªad_u∆ock
();

2744 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2745 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2746 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2747 i‡(
sbi
->
s_mb_°©s
) {

2748 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2750 
	`©omic_ªad
(&
sbi
->
s_bÆ_Æloˇãd
),

2751 
	`©omic_ªad
(&
sbi
->
s_bÆ_ªqs
),

2752 
	`©omic_ªad
(&
sbi
->
s_bÆ_suc˚ss
));

2753 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2756 
	`©omic_ªad
(&
sbi
->
s_bÆ_ex_sˇ¬ed
),

2757 
	`©omic_ªad
(&
sbi
->
s_bÆ_gﬂls
),

2758 
	`©omic_ªad
(&
sbi
->
s_bÆ_2‹dîs
),

2759 
	`©omic_ªad
(&
sbi
->
s_bÆ_bªaks
),

2760 
	`©omic_ªad
(&
sbi
->
s_mb_lo°_chunks
));

2761 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2763 
sbi
->
s_mb_buddõs_gíî©ed
,

2764 
sbi
->
s_mb_gíî©i⁄_time
);

2765 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2767 
	`©omic_ªad
(&
sbi
->
s_mb_¥óŒoˇãd
),

2768 
	`©omic_ªad
(&
sbi
->
s_mb_disˇrded
));

2771 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2774 
	}
}

2776 
ölöe
 
	$pxt4_issue_disˇrd
(
su≥r_block
 *
sb
,

2777 
pxt4_group_t
 
block_group
, 
pxt4_gΩblk_t
 
˛u°î
, 
cou¡
,

2778 
bio
 **
bi›
)

2780 
pxt4_fsblk_t
 
disˇrd_block
;

2782 
disˇrd_block
 = (
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
˛u°î
) +

2783 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
));

2784 
cou¡
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), count);

2785 
	`åa˚_pxt4_disˇrd_blocks
(
sb
,

2786 (Ë
disˇrd_block
, 
cou¡
);

2787 i‡(
bi›
) {

2788  
	`__blkdev_issue_disˇrd
(
sb
->
s_bdev
,

2789 (
£˘‹_t
)
disˇrd_block
 << (
sb
->
s_blocksize_bôs
 - 9),

2790 (
£˘‹_t
)
cou¡
 << (
sb
->
s_blocksize_bôs
 - 9),

2791 
GFP_NOFS
, 0, 
bi›
);

2793  
	`sb_issue_disˇrd
(
sb
, 
disˇrd_block
, 
cou¡
, 
GFP_NOFS
, 0);

2794 
	}
}

2796 
	$pxt4_‰ì_d©a_ö_buddy
(
su≥r_block
 *
sb
,

2797 
pxt4_‰ì_d©a
 *
íåy
)

2799 
pxt4_buddy
 
e4b
;

2800 
pxt4_group_öfo
 *
db
;

2801 
îr
, 
cou¡
 = 0, 
cou¡2
 = 0;

2803 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2804 
íåy
->
efd_cou¡
,É¡ry->
efd_group
,Éntry);

2806 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
íåy
->
efd_group
, &
e4b
);

2808 
	`BUG_ON
(
îr
 != 0);

2810 
	`•ö_lock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2811 
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 -
íåy
->
efd_cou¡
;

2812 
	`•ö_u∆ock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2814 
db
 = 
e4b
.
bd_öfo
;

2816 
cou¡
 +
íåy
->
efd_cou¡
;

2817 
cou¡2
++;

2818 
	`pxt4_lock_group
(
sb
, 
íåy
->
efd_group
);

2820 
	`rb_îa£
(&
íåy
->
efd_node
, &(
db
->
bb_‰ì_roŸ
));

2821 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

2829 i‡(!
	`ã°_›t
(
sb
, 
DISCARD
))

2830 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2832 i‡(!
db
->
bb_‰ì_roŸ
.
rb_node
) {

2836 
	`put_∑ge
(
e4b
.
bd_buddy_∑ge
);

2837 
	`put_∑ge
(
e4b
.
bd_bôm≠_∑ge
);

2839 
	`pxt4_u∆ock_group
(
sb
, 
íåy
->
efd_group
);

2840 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

2841 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2843 
	`mb_debug
(1, "‰ìd %u block†ö %u såu˘uªs\n", 
cou¡
, 
cou¡2
);

2844 
	}
}

2850 
	$pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
)

2852 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2853 
pxt4_‰ì_d©a
 *
íåy
, *
tmp
;

2854 
bio
 *
disˇrd_bio
 = 
NULL
;

2855 
li°_hód
 
‰ìd_d©a_li°
;

2856 
li°_hód
 *
cut_pos
 = 
NULL
;

2857 
îr
;

2859 
	`INIT_LIST_HEAD
(&
‰ìd_d©a_li°
);

2861 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2862 
	`li°_f‹_óch_íåy
(
íåy
, &
sbi
->
s_‰ìd_d©a_li°
, 
efd_li°
) {

2863 i‡(
íåy
->
efd_tid
 !
commô_tid
)

2865 
cut_pos
 = &
íåy
->
efd_li°
;

2867 i‡(
cut_pos
)

2868 
	`li°_cut_posôi⁄
(&
‰ìd_d©a_li°
, &
sbi
->
s_‰ìd_d©a_li°
,

2869 
cut_pos
);

2870 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2872 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

2873 
	`li°_f‹_óch_íåy
(
íåy
, &
‰ìd_d©a_li°
, 
efd_li°
) {

2874 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
íåy
->
efd_group
,

2875 
íåy
->
efd_°¨t_˛u°î
,

2876 
íåy
->
efd_cou¡
,

2877 &
disˇrd_bio
);

2878 i‡(
îr
 &&Éº !-
EOPNOTSUPP
) {

2879 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

2881 " wôh %d", 
íåy
->
efd_group
,

2882 
íåy
->
efd_°¨t_˛u°î
,

2883 
íåy
->
efd_cou¡
, 
îr
);

2884 } i‡(
îr
 =-
EOPNOTSUPP
)

2888 i‡(
disˇrd_bio
) {

2889 
	`submô_bio_waô
(
disˇrd_bio
);

2890 
	`bio_put
(
disˇrd_bio
);

2894 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
‰ìd_d©a_li°
, 
efd_li°
)

2895 
	`pxt4_‰ì_d©a_ö_buddy
(
sb
, 
íåy
);

2896 
	}
}

2898 
__öô
 
	$pxt4_öô_mbÆloc
()

2900 
pxt4_p•a˚_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_¥óŒoc_•a˚
,

2901 
SLAB_RECLAIM_ACCOUNT
);

2902 i‡(
pxt4_p•a˚_ˇchï
 =
NULL
)

2903  -
ENOMEM
;

2905 
pxt4_ac_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_Æloˇti⁄_c⁄ãxt
,

2906 
SLAB_RECLAIM_ACCOUNT
);

2907 i‡(
pxt4_ac_ˇchï
 =
NULL
) {

2908 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2909  -
ENOMEM
;

2912 
pxt4_‰ì_d©a_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_‰ì_d©a
,

2913 
SLAB_RECLAIM_ACCOUNT
);

2914 i‡(
pxt4_‰ì_d©a_ˇchï
 =
NULL
) {

2915 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2916 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2917  -
ENOMEM
;

2920 
	}
}

2922 
	$pxt4_exô_mbÆloc
()

2928 
	`rcu_b¨rõr
();

2929 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2930 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2931 
	`kmem_ˇche_de°roy
(
pxt4_‰ì_d©a_ˇchï
);

2932 
	`pxt4_groupöfo_de°roy_¶abs
();

2933 
	}
}

2940 
noölöe_f‹_°ack
 

2941 
	$pxt4_mb_m¨k_disk•a˚_u£d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2942 
h™dÀ_t
 *
h™dÀ
, 
ª£rv_˛°rs
)

2944 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

2945 
pxt4_group_desc
 *
gdp
;

2946 
buf„r_hód
 *
gdp_bh
;

2947 
pxt4_sb_öfo
 *
sbi
;

2948 
su≥r_block
 *
sb
;

2949 
pxt4_fsblk_t
 
block
;

2950 
îr
, 
Àn
;

2952 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

2953 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 <= 0);

2955 
sb
 = 
ac
->
ac_sb
;

2956 
sbi
 = 
	`PXT4_SB
(
sb
);

2958 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2959 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

2960 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

2961 
bôm≠_bh
 = 
NULL
;

2962 
out_îr
;

2965 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

2966 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

2967 i‡(
îr
)

2968 
out_îr
;

2970 
îr
 = -
EIO
;

2971 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ac
->
ac_b_ex
.
„_group
, &
gdp_bh
);

2972 i‡(!
gdp
)

2973 
out_îr
;

2975 
	`pxt4_debug
("usög block grou∞%u(%d)\n", 
ac
->
ac_b_ex
.
„_group
,

2976 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
));

2978 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2979 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdp_bh
);

2980 i‡(
îr
)

2981 
out_îr
;

2983 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2985 
Àn
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

2986 i‡(!
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
Àn
)) {

2987 
	`pxt4_îr‹
(
sb
, "Allocating blocks %llu-%llu which overlap "

2988 "f†mëad©a", 
block
, block+
Àn
);

2993 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2994 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2995 
ac
->
ac_b_ex
.
„_Àn
);

2996 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2997 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

2998 i‡(!
îr
)

2999 
îr
 = -
EFSCORRUPTED
;

3000 
out_îr
;

3003 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3004 #ifde‡
AGGRESSIVE_CHECK


3006 
i
;

3007 
i
 = 0; i < 
ac
->
ac_b_ex
.
„_Àn
; i++) {

3008 
	`BUG_ON
(
	`mb_ã°_bô
(
ac
->
ac_b_ex
.
„_°¨t
 + 
i
,

3009 
bôm≠_bh
->
b_d©a
));

3013 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

3014 
ac
->
ac_b_ex
.
„_Àn
);

3015 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

3016 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

3017 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

3018 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

3019 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
,

3020 
ac
->
ac_b_ex
.
„_group
, 
gdp
));

3022 
Àn
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë- 
ac
->
ac_b_ex
.
„_Àn
;

3023 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
Àn
);

3024 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
, 
bôm≠_bh
);

3025 
	`pxt4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
);

3027 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3028 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
ac
->
ac_b_ex
.
„_Àn
);

3032 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_DELALLOC_RESERVED
))

3034 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

3035 
ª£rv_˛°rs
);

3037 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

3038 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
,

3039 
ac
->
ac_b_ex
.
„_group
);

3040 
	`©omic64_sub
(
ac
->
ac_b_ex
.
„_Àn
,

3041 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

3042 
Êex_group
)->
‰ì_˛u°îs
);

3045 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3046 i‡(
îr
)

3047 
out_îr
;

3048 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdp_bh
);

3050 
out_îr
:

3051 
	`bªl£
(
bôm≠_bh
);

3052  
îr
;

3053 
	}
}

3064 
	$pxt4_mb_n‹mÆize_group_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3066 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3067 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

3069 
	`BUG_ON
(
lg
 =
NULL
);

3070 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_SB
(
sb
)->
s_mb_group_¥óŒoc
;

3071 
	`mb_debug
(1, "#%u: goal %u blocks forÜocality group\n",

3072 
cuºít
->
pid
, 
ac
->
ac_g_ex
.
„_Àn
);

3073 
	}
}

3079 
noölöe_f‹_°ack
 

3080 
	$pxt4_mb_n‹mÆize_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3081 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

3083 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3084 
bsbôs
, 
max
;

3085 
pxt4_lblk_t
 
íd
;

3086 
loff_t
 
size
, 
°¨t_off
;

3087 
loff_t
 
‹ig_size
 
__maybe_unu£d
;

3088 
pxt4_lblk_t
 
°¨t
;

3089 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3090 
pxt4_¥óŒoc_•a˚
 *
∑
;

3094 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3098 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

3103 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_NOPREALLOC
)

3106 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
) {

3107 
	`pxt4_mb_n‹mÆize_group_ªque°
(
ac
);

3111 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

3115 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

3116 
size
 = sizê<< 
bsbôs
;

3117 i‡(
size
 < 
	`i_size_ªad
(
ac
->
ac_öode
))

3118 
size
 = 
	`i_size_ªad
(
ac
->
ac_öode
);

3119 
‹ig_size
 = 
size
;

3122 
max
 = 2 << 
bsbôs
;

3124 
	#NRL_CHECK_SIZE
(
ªq
, 
size
, 
max
, 
chunk_size
) \

3125 (
ªq
 <(
size
Ë|| 
max
 <(
chunk_size
))

	)

3129 
°¨t_off
 = 0;

3130 i‡(
size
 <= 16 * 1024) {

3131 
size
 = 16 * 1024;

3132 } i‡(
size
 <= 32 * 1024) {

3133 
size
 = 32 * 1024;

3134 } i‡(
size
 <= 64 * 1024) {

3135 
size
 = 64 * 1024;

3136 } i‡(
size
 <= 128 * 1024) {

3137 
size
 = 128 * 1024;

3138 } i‡(
size
 <= 256 * 1024) {

3139 
size
 = 256 * 1024;

3140 } i‡(
size
 <= 512 * 1024) {

3141 
size
 = 512 * 1024;

3142 } i‡(
size
 <= 1024 * 1024) {

3143 
size
 = 1024 * 1024;

3144 } i‡(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3145 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3146 (21 - 
bsbôs
)) << 21;

3147 
size
 = 2 * 1024 * 1024;

3148 } i‡(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3149 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3150 (22 - 
bsbôs
)) << 22;

3151 
size
 = 4 * 1024 * 1024;

3152 } i‡(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
„_Àn
,

3153 (8<<20)>>
bsbôs
, 
max
, 8 * 1024)) {

3154 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3155 (23 - 
bsbôs
)) << 23;

3156 
size
 = 8 * 1024 * 1024;

3158 
°¨t_off
 = (
loff_t
Ë
ac
->
ac_o_ex
.
„_logiˇl
 << 
bsbôs
;

3159 
size
 = (
loff_t
Ë
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3160 
ac
->
ac_o_ex
.
„_Àn
Ë<< 
bsbôs
;

3162 
size
 = sizê>> 
bsbôs
;

3163 
°¨t
 = 
°¨t_off
 >> 
bsbôs
;

3166 i‡(
¨
->
∂e·
 && 
°¨t
 <¨->
Œe·
) {

3167 
size
 -
¨
->
Œe·
 + 1 - 
°¨t
;

3168 
°¨t
 = 
¨
->
Œe·
 + 1;

3170 i‡(
¨
->
¥ight
 && 
°¨t
 + 
size
 - 1 >¨->
Ãight
)

3171 
size
 -
°¨t
 + sizê- 
¨
->
Ãight
;

3177 i‡(
size
 > 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3178 
size
 = 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3180 
íd
 = 
°¨t
 + 
size
;

3183 
	`rcu_ªad_lock
();

3184 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3185 
pxt4_lblk_t
 
∑_íd
;

3187 i‡(
∑
->
∑_dñëed
)

3189 
	`•ö_lock
(&
∑
->
∑_lock
);

3190 i‡(
∑
->
∑_dñëed
) {

3191 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3195 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3196 
∑
->
∑_Àn
);

3199 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
„_logiˇl
 >
∑_íd
 ||

3200 
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
));

3203 i‡(
∑
->
∑_l°¨t
 >
íd
 || 
∑_íd
 <
°¨t
) {

3204 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3207 
	`BUG_ON
(
∑
->
∑_l°¨t
 <
°¨t
 && 
∑_íd
 >
íd
);

3210 i‡(
∑_íd
 <
ac
->
ac_o_ex
.
„_logiˇl
) {

3211 
	`BUG_ON
(
∑_íd
 < 
°¨t
);

3212 
°¨t
 = 
∑_íd
;

3213 } i‡(
∑
->
∑_l°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3214 
	`BUG_ON
(
∑
->
∑_l°¨t
 > 
íd
);

3215 
íd
 = 
∑
->
∑_l°¨t
;

3217 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3219 
	`rcu_ªad_u∆ock
();

3220 
size
 = 
íd
 - 
°¨t
;

3223 
	`rcu_ªad_lock
();

3224 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3225 
pxt4_lblk_t
 
∑_íd
;

3227 
	`•ö_lock
(&
∑
->
∑_lock
);

3228 i‡(
∑
->
∑_dñëed
 == 0) {

3229 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3230 
∑
->
∑_Àn
);

3231 
	`BUG_ON
(!(
°¨t
 >
∑_íd
 || 
íd
 <
∑
->
∑_l°¨t
));

3233 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3235 
	`rcu_ªad_u∆ock
();

3237 i‡(
°¨t
 + 
size
 <
ac
->
ac_o_ex
.
„_logiˇl
 &&

3238 
°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3239 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3241 (Ë
°¨t
, (Ë
size
,

3242 (Ë
ac
->
ac_o_ex
.
„_logiˇl
);

3243 
	`BUG
();

3245 
	`BUG_ON
(
size
 <0 || sizê> 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3251 
ac
->
ac_g_ex
.
„_logiˇl
 = 
°¨t
;

3252 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
size
);

3255 i‡(
¨
->
¥ight
 && (¨->
Ãight
 =(
°¨t
 + 
size
))) {

3257 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
¥ight
 - 
size
,

3258 &
ac
->
ac_f_ex
.
„_group
,

3259 &
ac
->
ac_f_ex
.
„_°¨t
);

3260 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3262 i‡(
¨
->
∂e·
 && (¨->
Œe·
 + 1 =
°¨t
)) {

3264 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
∂e·
 + 1,

3265 &
ac
->
ac_f_ex
.
„_group
,

3266 &
ac
->
ac_f_ex
.
„_°¨t
);

3267 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3270 
	`mb_debug
(1, "gﬂl: %u(wa†%uËblock†© %u\n", (Ë
size
,

3271 (Ë
‹ig_size
, (Ë
°¨t
);

3272 
	}
}

3274 
	$pxt4_mb_cﬁÀ˘_°©s
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3276 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3278 i‡(
sbi
->
s_mb_°©s
 && 
ac
->
ac_g_ex
.
„_Àn
 > 1) {

3279 
	`©omic_öc
(&
sbi
->
s_bÆ_ªqs
);

3280 
	`©omic_add
(
ac
->
ac_b_ex
.
„_Àn
, &
sbi
->
s_bÆ_Æloˇãd
);

3281 i‡(
ac
->
ac_b_ex
.
„_Àn
 >ac->
ac_o_ex
.fe_len)

3282 
	`©omic_öc
(&
sbi
->
s_bÆ_suc˚ss
);

3283 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_bÆ_ex_sˇ¬ed
);

3284 i‡(
ac
->
ac_g_ex
.
„_°¨t
 =ac->
ac_b_ex
.fe_start &&

3285 
ac
->
ac_g_ex
.
„_group
 =ac->
ac_b_ex
.fe_group)

3286 
	`©omic_öc
(&
sbi
->
s_bÆ_gﬂls
);

3287 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
)

3288 
	`©omic_öc
(&
sbi
->
s_bÆ_bªaks
);

3291 i‡(
ac
->
ac_›
 =
PXT4_MB_HISTORY_ALLOC
)

3292 
	`åa˚_pxt4_mbÆloc_Æloc
(
ac
);

3294 
	`åa˚_pxt4_mbÆloc_¥óŒoc
(
ac
);

3295 
	}
}

3303 
	$pxt4_disˇrd_Æloˇãd_blocks
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3305 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

3306 
pxt4_buddy
 
e4b
;

3307 
îr
;

3309 i‡(
∑
 =
NULL
) {

3310 i‡(
ac
->
ac_f_ex
.
„_Àn
 == 0)

3312 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
, &
e4b
);

3313 i‡(
îr
) {

3319 
	`WARN
(1, "mb_lﬂd_buddy faûed (%d)", 
îr
);

3322 
	`pxt4_lock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3323 
	`mb_‰ì_blocks
(
ac
->
ac_öode
, &
e4b
,ác->
ac_f_ex
.
„_°¨t
,

3324 
ac
->
ac_f_ex
.
„_Àn
);

3325 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3326 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3329 i‡(
∑
->
∑_ty≥
 =
MB_INODE_PA
)

3330 
∑
->
∑_‰ì
 +
ac
->
ac_b_ex
.
„_Àn
;

3331 
	}
}

3336 
	$pxt4_mb_u£_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3337 
pxt4_¥óŒoc_•a˚
 *
∑
)

3339 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3340 
pxt4_fsblk_t
 
°¨t
;

3341 
pxt4_fsblk_t
 
íd
;

3342 
Àn
;

3345 
°¨t
 = 
∑
->
∑_p°¨t
 + (
ac
->
ac_o_ex
.
„_logiˇl
 -Öa->
∑_l°¨t
);

3346 
íd
 = 
	`mö
(
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
),

3347 
°¨t
 + 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
„_Àn
));

3348 
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
íd
 - 
°¨t
);

3349 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
°¨t
, &ac->
ac_b_ex
.
„_group
,

3350 &
ac
->
ac_b_ex
.
„_°¨t
);

3351 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3352 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3353 
ac
->
ac_∑
 = 
∑
;

3355 
	`BUG_ON
(
°¨t
 < 
∑
->
∑_p°¨t
);

3356 
	`BUG_ON
(
íd
 > 
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
));

3357 
	`BUG_ON
(
∑
->
∑_‰ì
 < 
Àn
);

3358 
∑
->
∑_‰ì
 -
Àn
;

3360 
	`mb_debug
(1, "u£ %Œu/%u from inodê∑ %p\n", 
°¨t
, 
Àn
, 
∑
);

3361 
	}
}

3366 
	$pxt4_mb_u£_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3367 
pxt4_¥óŒoc_•a˚
 *
∑
)

3369 
Àn
 = 
ac
->
ac_o_ex
.
„_Àn
;

3371 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
∑
->
∑_p°¨t
,

3372 &
ac
->
ac_b_ex
.
„_group
,

3373 &
ac
->
ac_b_ex
.
„_°¨t
);

3374 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3375 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3376 
ac
->
ac_∑
 = 
∑
;

3384 
	`mb_debug
(1, "u£ %u/%u from grou∞∑ %p\n", 
∑
->
∑_l°¨t
-
Àn
,Üen,Öa);

3385 
	}
}

3393 
pxt4_¥óŒoc_•a˚
 *

3394 
	$pxt4_mb_check_group_∑
(
pxt4_fsblk_t
 
gﬂl_block
,

3395 
pxt4_¥óŒoc_•a˚
 *
∑
,

3396 
pxt4_¥óŒoc_•a˚
 *
˝a
)

3398 
pxt4_fsblk_t
 
cur_di°™˚
, 
√w_di°™˚
;

3400 i‡(
˝a
 =
NULL
) {

3401 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3402  
∑
;

3404 
cur_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
˝a
->
∑_p°¨t
);

3405 
√w_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
∑
->
∑_p°¨t
);

3407 i‡(
cur_di°™˚
 <
√w_di°™˚
)

3408  
˝a
;

3411 
	`©omic_dec
(&
˝a
->
∑_cou¡
);

3412 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3413  
∑
;

3414 
	}
}

3419 
noölöe_f‹_°ack
 

3420 
	$pxt4_mb_u£_¥óŒoˇãd
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3422 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3423 
‹dî
, 
i
;

3424 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3425 
pxt4_loˇlôy_group
 *
lg
;

3426 
pxt4_¥óŒoc_•a˚
 *
∑
, *
˝a
 = 
NULL
;

3427 
pxt4_fsblk_t
 
gﬂl_block
;

3430 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3434 
	`rcu_ªad_lock
();

3435 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3439 i‡(
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
 ||

3440 
ac
->
ac_o_ex
.
„_logiˇl
 >(
∑
->
∑_l°¨t
 +

3441 
	`PXT4_C2B
(
sbi
, 
∑
->
∑_Àn
)))

3445 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)) &&

3446 (
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
) >

3447 
PXT4_MAX_BLOCK_FILE_PHYS
))

3451 
	`•ö_lock
(&
∑
->
∑_lock
);

3452 i‡(
∑
->
∑_dñëed
 =0 &&Öa->
∑_‰ì
) {

3453 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3454 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3455 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3456 
ac
->
ac_¸ôîü
 = 10;

3457 
	`rcu_ªad_u∆ock
();

3460 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3462 
	`rcu_ªad_u∆ock
();

3465 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
))

3469 
lg
 = 
ac
->
ac_lg
;

3470 i‡(
lg
 =
NULL
)

3472 
‹dî
 = 
	`Ês
(
ac
->
ac_o_ex
.
„_Àn
) - 1;

3473 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

3475 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

3477 
gﬂl_block
 = 
	`pxt4_gΩ_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3482 
i
 = 
‹dî
; i < 
PREALLOC_TB_SIZE
; i++) {

3483 
	`rcu_ªad_lock
();

3484 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
i
],

3485 
∑_öode_li°
) {

3486 
	`•ö_lock
(&
∑
->
∑_lock
);

3487 i‡(
∑
->
∑_dñëed
 == 0 &&

3488 
∑
->
∑_‰ì
 >
ac
->
ac_o_ex
.
„_Àn
) {

3490 
˝a
 = 
	`pxt4_mb_check_group_∑
(
gﬂl_block
,

3491 
∑
, 
˝a
);

3493 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3495 
	`rcu_ªad_u∆ock
();

3497 i‡(
˝a
) {

3498 
	`pxt4_mb_u£_group_∑
(
ac
, 
˝a
);

3499 
ac
->
ac_¸ôîü
 = 20;

3503 
	}
}

3511 
	$pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

3512 
pxt4_group_t
 
group
)

3514 
rb_node
 *
n
;

3515 
pxt4_group_öfo
 *
gΩ
;

3516 
pxt4_‰ì_d©a
 *
íåy
;

3518 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3519 
n
 = 
	`rb_fú°
(&(
gΩ
->
bb_‰ì_roŸ
));

3521 
n
) {

3522 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_‰ì_d©a
, 
efd_node
);

3523 
	`pxt4_£t_bôs
(
bôm≠
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

3524 
n
 = 
	`rb_√xt
(n);

3527 
	}
}

3534 
noölöe_f‹_°ack


3535 
	$pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

3536 
pxt4_group_t
 
group
)

3538 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3539 
pxt4_¥óŒoc_•a˚
 *
∑
;

3540 
li°_hód
 *
cur
;

3541 
pxt4_group_t
 
grou≤r
;

3542 
pxt4_gΩblk_t
 
°¨t
;

3543 
¥óŒoˇãd
 = 0;

3544 
Àn
;

3554 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

3555 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

3556 
	`•ö_lock
(&
∑
->
∑_lock
);

3557 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

3558 &
grou≤r
, &
°¨t
);

3559 
Àn
 = 
∑
->
∑_Àn
;

3560 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3561 i‡(
	`u∆ikñy
(
Àn
 == 0))

3563 
	`BUG_ON
(
grou≤r
 !
group
);

3564 
	`pxt4_£t_bôs
(
bôm≠
, 
°¨t
, 
Àn
);

3565 
¥óŒoˇãd
 +
Àn
;

3567 
	`mb_debug
(1, "¥óŒoˇãd %u f‹ grou∞%u\n", 
¥óŒoˇãd
, 
group
);

3568 
	}
}

3570 
	$pxt4_mb_∑_ˇŒback
(
rcu_hód
 *
hód
)

3572 
pxt4_¥óŒoc_•a˚
 *
∑
;

3573 
∑
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_¥óŒoc_•a˚
, 
u
.
∑_rcu
);

3575 
	`BUG_ON
(
	`©omic_ªad
(&
∑
->
∑_cou¡
));

3576 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3577 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

3578 
	}
}

3584 
	$pxt4_mb_put_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3585 
su≥r_block
 *
sb
, 
pxt4_¥óŒoc_•a˚
 *
∑
)

3587 
pxt4_group_t
 
gΩ
;

3588 
pxt4_fsblk_t
 
gΩ_blk
;

3591 
	`•ö_lock
(&
∑
->
∑_lock
);

3592 i‡(!
	`©omic_dec_™d_ã°
(&
∑
->
∑_cou¡
Ë||Öa->
∑_‰ì
 != 0) {

3593 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3597 i‡(
∑
->
∑_dñëed
 == 1) {

3598 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3602 
∑
->
∑_dñëed
 = 1;

3603 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3605 
gΩ_blk
 = 
∑
->
∑_p°¨t
;

3610 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3611 
gΩ_blk
--;

3613 
gΩ
 = 
	`pxt4_gë_group_numbî
(
sb
, 
gΩ_blk
);

3629 
	`pxt4_lock_group
(
sb
, 
gΩ
);

3630 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3631 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

3633 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3634 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3635 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3637 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3638 
	}
}

3643 
noölöe_f‹_°ack
 

3644 
	$pxt4_mb_√w_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3646 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3647 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3648 
pxt4_¥óŒoc_•a˚
 *
∑
;

3649 
pxt4_group_öfo
 *
gΩ
;

3650 
pxt4_öode_öfo
 *
ei
;

3653 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3654 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3655 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3657 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3658 i‡(
∑
 =
NULL
)

3659  -
ENOMEM
;

3661 i‡(
ac
->
ac_b_ex
.
„_Àn
 <ác->
ac_g_ex
.fe_len) {

3662 
wöl
;

3663 
wös
;

3664 
wö
;

3665 
offs
;

3670 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_logiˇl
 >ác->
ac_o_ex
.fe_logical);

3671 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_Àn
 <ác->
ac_o_ex
.fe_len);

3676 
wöl
 = 
ac
->
ac_o_ex
.
„_logiˇl
 -ác->
ac_g_ex
.fe_logical;

3679 
wös
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
 -ác->
ac_o_ex
.fe_len);

3682 
wö
 = 
	`mö
(
wöl
, 
wös
);

3684 
offs
 = 
ac
->
ac_o_ex
.
„_logiˇl
 %

3685 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

3686 i‡(
offs
 && off†< 
wö
)

3687 
wö
 = 
offs
;

3689 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_o_ex
.fe_logical -

3690 
	`PXT4_NUM_B2C
(
sbi
, 
wö
);

3691 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_logiˇl
 <ác->
ac_b_ex
.fe_logical);

3692 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ác->
ac_b_ex
.fe_len);

3697 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3699 
∑
->
∑_l°¨t
 = 
ac
->
ac_b_ex
.
„_logiˇl
;

3700 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3701 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3702 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3703 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3704 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3705 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3706 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3707 
∑
->
∑_dñëed
 = 0;

3708 
∑
->
∑_ty≥
 = 
MB_INODE_PA
;

3710 
	`mb_debug
(1, "√w inodê∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3711 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3712 
	`åa˚_pxt4_mb_√w_öode_∑
(
ac
, 
∑
);

3714 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3715 
	`©omic_add
(
∑
->
∑_‰ì
, &
sbi
->
s_mb_¥óŒoˇãd
);

3717 
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3718 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3720 
∑
->
∑_obj_lock
 = &
ei
->
i_¥óŒoc_lock
;

3721 
∑
->
∑_öode
 = 
ac
->
ac_öode
;

3723 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3724 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3725 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3727 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3728 
	`li°_add_rcu
(&
∑
->
∑_öode_li°
, &
ei
->
i_¥óŒoc_li°
);

3729 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3732 
	}
}

3737 
noölöe_f‹_°ack
 

3738 
	$pxt4_mb_√w_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3740 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3741 
pxt4_loˇlôy_group
 *
lg
;

3742 
pxt4_¥óŒoc_•a˚
 *
∑
;

3743 
pxt4_group_öfo
 *
gΩ
;

3746 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3747 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3748 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3750 
	`BUG_ON
(
pxt4_p•a˚_ˇchï
 =
NULL
);

3751 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3752 i‡(
∑
 =
NULL
)

3753  -
ENOMEM
;

3757 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3759 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3760 
∑
->
∑_l°¨t
 =Öa->
∑_p°¨t
;

3761 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3762 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3763 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3764 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3765 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3766 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3767 
∑
->
∑_dñëed
 = 0;

3768 
∑
->
∑_ty≥
 = 
MB_GROUP_PA
;

3770 
	`mb_debug
(1, "√w grou∞∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3771 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3772 
	`åa˚_pxt4_mb_√w_group_∑
(
ac
, 
∑
);

3774 
	`pxt4_mb_u£_group_∑
(
ac
, 
∑
);

3775 
	`©omic_add
(
∑
->
∑_‰ì
, &
	`PXT4_SB
(
sb
)->
s_mb_¥óŒoˇãd
);

3777 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3778 
lg
 = 
ac
->
ac_lg
;

3779 
	`BUG_ON
(
lg
 =
NULL
);

3781 
∑
->
∑_obj_lock
 = &
lg
->
lg_¥óŒoc_lock
;

3782 
∑
->
∑_öode
 = 
NULL
;

3784 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3785 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3786 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3793 
	}
}

3795 
	$pxt4_mb_√w_¥óŒoˇti⁄
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3797 
îr
;

3799 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

3800 
îr
 = 
	`pxt4_mb_√w_group_∑
(
ac
);

3802 
îr
 = 
	`pxt4_mb_√w_öode_∑
(
ac
);

3803  
îr
;

3804 
	}
}

3814 
noölöe_f‹_°ack
 

3815 
	$pxt4_mb_ªÀa£_öode_∑
(
pxt4_buddy
 *
e4b
, 
buf„r_hód
 *
bôm≠_bh
,

3816 
pxt4_¥óŒoc_•a˚
 *
∑
)

3818 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3819 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3820 
íd
;

3821 
√xt
;

3822 
pxt4_group_t
 
group
;

3823 
pxt4_gΩblk_t
 
bô
;

3824 
gΩ_blk_°¨t
;

3825 
‰ì
 = 0;

3827 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3828 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3829 
gΩ_blk_°¨t
 = 
∑
->
∑_p°¨t
 - 
	`PXT4_C2B
(
sbi
, 
bô
);

3830 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3831 
íd
 = 
bô
 + 
∑
->
∑_Àn
;

3833 
bô
 < 
íd
) {

3834 
bô
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, bit);

3835 i‡(
bô
 >
íd
)

3837 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, 
bô
);

3838 
	`mb_debug
(1, " freeÖreallocated %u/%u in group %u\n",

3839 (Ë
	`pxt4_group_fú°_block_no
(
sb
, 
group
Ë+ 
bô
,

3840 (Ë
√xt
 - 
bô
, (Ë
group
);

3841 
‰ì
 +
√xt
 - 
bô
;

3843 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
√xt
 - bit);

3844 
	`åa˚_pxt4_mb_ªÀa£_öode_∑
(
∑
, (
gΩ_blk_°¨t
 +

3845 
	`PXT4_C2B
(
sbi
, 
bô
)),

3846 
√xt
 - 
bô
);

3847 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
, 
√xt
 - bit);

3848 
bô
 = 
√xt
 + 1;

3850 i‡(
‰ì
 !
∑
->
∑_‰ì
) {

3851 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3853 
∑
, (Ë∑->
∑_l°¨t
,

3854 (Ë
∑
->
∑_p°¨t
,

3855 (Ë
∑
->
∑_Àn
);

3856 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0, "free %u,Öa_free %u",

3857 
‰ì
, 
∑
->
∑_‰ì
);

3863 
	`©omic_add
(
‰ì
, &
sbi
->
s_mb_disˇrded
);

3866 
	}
}

3868 
noölöe_f‹_°ack
 

3869 
	$pxt4_mb_ªÀa£_group_∑
(
pxt4_buddy
 *
e4b
,

3870 
pxt4_¥óŒoc_•a˚
 *
∑
)

3872 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3873 
pxt4_group_t
 
group
;

3874 
pxt4_gΩblk_t
 
bô
;

3876 
	`åa˚_pxt4_mb_ªÀa£_group_∑
(
sb
, 
∑
);

3877 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3878 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3879 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3880 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
,Öa->
∑_Àn
);

3881 
	`©omic_add
(
∑
->
∑_Àn
, &
	`PXT4_SB
(
sb
)->
s_mb_disˇrded
);

3882 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
∑
->
∑_Àn
);

3885 
	}
}

3896 
noölöe_f‹_°ack
 

3897 
	$pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

3898 
pxt4_group_t
 
group
, 
√eded
)

3900 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3901 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3902 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3903 
li°_hód
 
li°
;

3904 
pxt4_buddy
 
e4b
;

3905 
îr
;

3906 
busy
 = 0;

3907 
‰ì
 = 0;

3909 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ grou∞%u\n", 
group
);

3911 i‡(
	`li°_em±y
(&
gΩ
->
bb_¥óŒoc_li°
))

3914 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

3915 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

3916 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

3917 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

3918 
îr
, 
group
);

3922 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

3923 i‡(
îr
) {

3924 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

3925 
îr
, 
group
);

3926 
	`put_bh
(
bôm≠_bh
);

3930 i‡(
√eded
 == 0)

3931 
√eded
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3933 
	`INIT_LIST_HEAD
(&
li°
);

3934 
ª≥©
:

3935 
	`pxt4_lock_group
(
sb
, 
group
);

3936 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
,

3937 &
gΩ
->
bb_¥óŒoc_li°
, 
∑_group_li°
) {

3938 
	`•ö_lock
(&
∑
->
∑_lock
);

3939 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

3940 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3941 
busy
 = 1;

3944 i‡(
∑
->
∑_dñëed
) {

3945 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3950 
∑
->
∑_dñëed
 = 1;

3953 
‰ì
 +
∑
->
∑_‰ì
;

3955 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3957 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3958 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

3962 i‡(
‰ì
 < 
√eded
 && 
busy
) {

3963 
busy
 = 0;

3964 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3965 
	`c⁄d_ªsched
();

3966 
ª≥©
;

3970 i‡(
	`li°_em±y
(&
li°
)) {

3971 
	`BUG_ON
(
‰ì
 != 0);

3972 
out
;

3976 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

3979 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3980 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3981 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3983 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3984 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

3986 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

3988 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

3989 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3992 
out
:

3993 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3994 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3995 
	`put_bh
(
bôm≠_bh
);

3996  
‰ì
;

3997 
	}
}

4008 
	$pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *inode)

4010 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4011 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4012 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4013 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4014 
pxt4_group_t
 
group
 = 0;

4015 
li°_hód
 
li°
;

4016 
pxt4_buddy
 
e4b
;

4017 
îr
;

4019 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

4024 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ inodê%lu\n", 
öode
->
i_öo
);

4025 
	`åa˚_pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4027 
	`INIT_LIST_HEAD
(&
li°
);

4029 
ª≥©
:

4031 
	`•ö_lock
(&
ei
->
i_¥óŒoc_lock
);

4032 !
	`li°_em±y
(&
ei
->
i_¥óŒoc_li°
)) {

4033 
∑
 = 
	`li°_íåy
(
ei
->
i_¥óŒoc_li°
.
√xt
,

4034 
pxt4_¥óŒoc_•a˚
, 
∑_öode_li°
);

4035 
	`BUG_ON
(
∑
->
∑_obj_lock
 !&
ei
->
i_¥óŒoc_lock
);

4036 
	`•ö_lock
(&
∑
->
∑_lock
);

4037 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4040 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4041 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4042 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4044 
	`WARN_ON
(1);

4045 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4046 
ª≥©
;

4049 i‡(
∑
->
∑_dñëed
 == 0) {

4050 
∑
->
∑_dñëed
 = 1;

4051 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4052 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4053 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

4058 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4059 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4073 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4074 
ª≥©
;

4076 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4078 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

4079 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_INODE_PA
);

4080 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4082 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4083 
GFP_NOFS
|
__GFP_NOFAIL
);

4084 i‡(
îr
) {

4085 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4086 
îr
, 
group
);

4090 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

4091 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4092 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4093 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

4094 
îr
, 
group
);

4095 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4099 
	`pxt4_lock_group
(
sb
, 
group
);

4100 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4101 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

4102 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4104 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4105 
	`put_bh
(
bôm≠_bh
);

4107 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4108 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4110 
	}
}

4112 #ifde‡
CONFIG_PXT4_DEBUG


4113 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4115 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4116 
pxt4_group_t
 
ngroups
, 
i
;

4118 i‡(!
pxt4_mbÆloc_debug
 ||

4119 (
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
))

4122 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can'tállocate:"

4124 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4125 
ac
->
ac_°©us
,ác->
ac_Êags
);

4126 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4129 ()
ac
->
ac_o_ex
.
„_group
,

4130 ()
ac
->
ac_o_ex
.
„_°¨t
,

4131 ()
ac
->
ac_o_ex
.
„_Àn
,

4132 ()
ac
->
ac_o_ex
.
„_logiˇl
,

4133 ()
ac
->
ac_g_ex
.
„_group
,

4134 ()
ac
->
ac_g_ex
.
„_°¨t
,

4135 ()
ac
->
ac_g_ex
.
„_Àn
,

4136 ()
ac
->
ac_g_ex
.
„_logiˇl
,

4137 ()
ac
->
ac_b_ex
.
„_group
,

4138 ()
ac
->
ac_b_ex
.
„_°¨t
,

4139 ()
ac
->
ac_b_ex
.
„_Àn
,

4140 ()
ac
->
ac_b_ex
.
„_logiˇl
,

4141 ()
ac
->
ac_¸ôîü
);

4142 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",ác->
ac_found
);

4143 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4144 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4145 
i
 = 0; i < 
ngroups
; i++) {

4146 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

4147 
pxt4_¥óŒoc_•a˚
 *
∑
;

4148 
pxt4_gΩblk_t
 
°¨t
;

4149 
li°_hód
 *
cur
;

4150 
	`pxt4_lock_group
(
sb
, 
i
);

4151 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

4152 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
,

4153 
∑_group_li°
);

4154 
	`•ö_lock
(&
∑
->
∑_lock
);

4155 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

4156 
NULL
, &
°¨t
);

4157 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4158 
	`¥ötk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4159 
°¨t
, 
∑
->
∑_Àn
);

4161 
	`pxt4_u∆ock_group
(
sb
, 
i
);

4163 i‡(
gΩ
->
bb_‰ì
 == 0)

4165 
	`¥ötk
(
KERN_ERR
 "%u: %d/%d \n",

4166 
i
, 
gΩ
->
bb_‰ì
, gΩ->
bb_‰agmíts
);

4168 
	`¥ötk
(
KERN_ERR
 "\n");

4169 
	}
}

4171 
ölöe
 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4174 
	}
}

4184 
	$pxt4_mb_group_‹_fûe
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4186 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4187 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

4188 
loff_t
 
size
, 
isize
;

4190 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

4193 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

4196 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

4197 
isize
 = (
	`i_size_ªad
(
ac
->
ac_öode
Ë+ác->
ac_sb
->
s_blocksize
 - 1)

4198 >> 
bsbôs
;

4200 i‡((
size
 =
isize
Ë&& !
	`pxt4_fs_is_busy
(
sbi
) &&

4201 !
	`öode_is_›í_f‹_wrôe
(
ac
->
ac_öode
)) {

4202 
ac
->
ac_Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4206 i‡(
sbi
->
s_mb_group_¥óŒoc
 <= 0) {

4207 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4212 
size
 = 
	`max
(size, 
isize
);

4213 i‡(
size
 > 
sbi
->
s_mb_°ªam_ªque°
) {

4214 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4218 
	`BUG_ON
(
ac
->
ac_lg
 !
NULL
);

4224 
ac
->
ac_lg
 = 
	`øw_˝u_±r
(
sbi
->
s_loˇlôy_groups
);

4227 
ac
->
ac_Êags
 |
PXT4_MB_HINT_GROUP_ALLOC
;

4230 
	`muãx_lock
(&
ac
->
ac_lg
->
lg_muãx
);

4231 
	}
}

4233 
noölöe_f‹_°ack
 

4234 
	$pxt4_mb_öôülize_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

4235 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

4237 
su≥r_block
 *
sb
 = 
¨
->
öode
->
i_sb
;

4238 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4239 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

4240 
pxt4_group_t
 
group
;

4241 
Àn
;

4242 
pxt4_fsblk_t
 
gﬂl
;

4243 
pxt4_gΩblk_t
 
block
;

4246 
Àn
 = 
¨
->len;

4249 i‡(
Àn
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

4250 
Àn
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

4253 
gﬂl
 = 
¨
->goal;

4254 i‡(
gﬂl
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

4255 
gﬂl
 >
	`pxt4_blocks_cou¡
(
es
))

4256 
gﬂl
 = 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

4257 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
gﬂl
, &
group
, &
block
);

4260 
ac
->
ac_b_ex
.
„_logiˇl
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
¨
->
logiˇl
);

4261 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

4262 
ac
->
ac_sb
 = 
sb
;

4263 
ac
->
ac_öode
 = 
¨
->
öode
;

4264 
ac
->
ac_o_ex
.
„_logiˇl
 =ác->
ac_b_ex
.fe_logical;

4265 
ac
->
ac_o_ex
.
„_group
 = 
group
;

4266 
ac
->
ac_o_ex
.
„_°¨t
 = 
block
;

4267 
ac
->
ac_o_ex
.
„_Àn
 = 
Àn
;

4268 
ac
->
ac_g_ex
 =ác->
ac_o_ex
;

4269 
ac
->
ac_Êags
 = 
¨
->
Êags
;

4273 
	`pxt4_mb_group_‹_fûe
(
ac
);

4275 
	`mb_debug
(1, "initác: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4277 (Ë
¨
->
Àn
, (Ë¨->
logiˇl
,

4278 (Ë
¨
->
gﬂl
, 
ac
->
ac_Êags
,ác->
ac_2‹dî
,

4279 (Ë
¨
->
Œe·
, (Ë¨->
∂e·
,

4280 (Ë
¨
->
Ãight
, (Ë¨->
¥ight
,

4281 
	`öode_is_›í_f‹_wrôe
(
¨
->
öode
) ? "" : "non-");

4284 
	}
}

4286 
noölöe_f‹_°ack
 

4287 
	$pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

4288 
pxt4_loˇlôy_group
 *
lg
,

4289 
‹dî
, 
tŸÆ_íåõs
)

4291 
pxt4_group_t
 
group
 = 0;

4292 
pxt4_buddy
 
e4b
;

4293 
li°_hód
 
disˇrd_li°
;

4294 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4296 
	`mb_debug
(1, "discardÜocality groupÖreallocation\n");

4298 
	`INIT_LIST_HEAD
(&
disˇrd_li°
);

4300 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4301 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4302 
∑_öode_li°
) {

4303 
	`•ö_lock
(&
∑
->
∑_lock
);

4304 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4310 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4313 i‡(
∑
->
∑_dñëed
) {

4314 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4318 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_GROUP_PA
);

4321 
∑
->
∑_dñëed
 = 1;

4322 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4324 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4325 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
disˇrd_li°
);

4327 
tŸÆ_íåõs
--;

4328 i‡(
tŸÆ_íåõs
 <= 5) {

4338 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4340 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
disˇrd_li°
, 
u
.
∑_tmp_li°
) {

4341 
îr
;

4343 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4344 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4345 
GFP_NOFS
|
__GFP_NOFAIL
);

4346 i‡(
îr
) {

4347 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4348 
îr
, 
group
);

4351 
	`pxt4_lock_group
(
sb
, 
group
);

4352 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4353 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

4354 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4356 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4357 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4358 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4360 
	}
}

4371 
	$pxt4_mb_add_n_åim
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4373 
‹dî
, 
added
 = 0, 
lg_¥óŒoc_cou¡
 = 1;

4374 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4375 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

4376 
pxt4_¥óŒoc_•a˚
 *
tmp_∑
, *
∑
 = 
ac
->
ac_∑
;

4378 
‹dî
 = 
	`Ês
(
∑
->
∑_‰ì
) - 1;

4379 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

4381 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

4383 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4384 
	`li°_f‹_óch_íåy_rcu
(
tmp_∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4385 
∑_öode_li°
) {

4386 
	`•ö_lock
(&
tmp_∑
->
∑_lock
);

4387 i‡(
tmp_∑
->
∑_dñëed
) {

4388 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4391 i‡(!
added
 && 
∑
->
∑_‰ì
 < 
tmp_∑
->pa_free) {

4393 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4394 &
tmp_∑
->
∑_öode_li°
);

4395 
added
 = 1;

4401 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4402 
lg_¥óŒoc_cou¡
++;

4404 i‡(!
added
)

4405 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4406 &
lg
->
lg_¥óŒoc_li°
[
‹dî
]);

4407 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4410 i‡(
lg_¥óŒoc_cou¡
 > 8) {

4411 
	`pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
sb
, 
lg
,

4412 
‹dî
, 
lg_¥óŒoc_cou¡
);

4416 
	}
}

4421 
	$pxt4_mb_ªÀa£_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4423 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4424 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

4425 i‡(
∑
) {

4426 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
) {

4428 
	`•ö_lock
(&
∑
->
∑_lock
);

4429 
∑
->
∑_p°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4430 
∑
->
∑_l°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4431 
∑
->
∑_‰ì
 -
ac
->
ac_b_ex
.
„_Àn
;

4432 
∑
->
∑_Àn
 -
ac
->
ac_b_ex
.
„_Àn
;

4433 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4436 i‡(
∑
) {

4443 i‡((
∑
->
∑_ty≥
 =
MB_GROUP_PA
Ë&& 
	`likñy
’a->
∑_‰ì
)) {

4444 
	`•ö_lock
(
∑
->
∑_obj_lock
);

4445 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4446 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

4447 
	`pxt4_mb_add_n_åim
(
ac
);

4449 
	`pxt4_mb_put_∑
(
ac
,ác->
ac_sb
, 
∑
);

4451 i‡(
ac
->
ac_bôm≠_∑ge
)

4452 
	`put_∑ge
(
ac
->
ac_bôm≠_∑ge
);

4453 i‡(
ac
->
ac_buddy_∑ge
)

4454 
	`put_∑ge
(
ac
->
ac_buddy_∑ge
);

4455 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

4456 
	`muãx_u∆ock
(&
ac
->
ac_lg
->
lg_muãx
);

4457 
	`pxt4_mb_cﬁÀ˘_°©s
(
ac
);

4459 
	}
}

4461 
	$pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
, 
√eded
)

4463 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4464 
ªt
;

4465 
‰ìd
 = 0;

4467 
	`åa˚_pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
√eded
);

4468 
i
 = 0; i < 
ngroups
 && 
√eded
 > 0; i++) {

4469 
ªt
 = 
	`pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
sb
, 
i
, 
√eded
);

4470 
‰ìd
 +
ªt
;

4471 
√eded
 -
ªt
;

4474  
‰ìd
;

4475 
	}
}

4482 
pxt4_fsblk_t
 
	$pxt4_mb_√w_blocks
(
h™dÀ_t
 *
h™dÀ
,

4483 
pxt4_Æloˇti⁄_ªque°
 *
¨
, *
îΩ
)

4485 
‰ìd
;

4486 
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
 = 
NULL
;

4487 
pxt4_sb_öfo
 *
sbi
;

4488 
su≥r_block
 *
sb
;

4489 
pxt4_fsblk_t
 
block
 = 0;

4490 
öquŸa
 = 0;

4491 
ª£rv_˛°rs
 = 0;

4493 
	`might_¶ìp
();

4494 
sb
 = 
¨
->
öode
->
i_sb
;

4495 
sbi
 = 
	`PXT4_SB
(
sb
);

4497 
	`åa˚_pxt4_ªque°_blocks
(
¨
);

4500 i‡(
	`pxt4_is_quŸa_fûe
(
¨
->
öode
))

4501 
¨
->
Êags
 |
PXT4_MB_USE_ROOT_BLOCKS
;

4503 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0) {

4508 
¨
->
Àn
 &&

4509 
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 
¨
->
Àn
,ár->
Êags
)) {

4512 
	`c⁄d_ªsched
();

4513 
¨
->
Àn
 =ár->len >> 1;

4515 i‡(!
¨
->
Àn
) {

4516 *
îΩ
 = -
ENOSPC
;

4519 
ª£rv_˛°rs
 = 
¨
->
Àn
;

4520 i‡(
¨
->
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
) {

4521 
	`dquŸ_Æloc_block_noÁû
(
¨
->
öode
,

4522 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
));

4524 
¨
->
Àn
 &&

4525 
	`dquŸ_Æloc_block
(
¨
->
öode
,

4526 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
))) {

4528 
¨
->
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4529 
¨
->
Àn
--;

4532 
öquŸa
 = 
¨
->
Àn
;

4533 i‡(
¨
->
Àn
 == 0) {

4534 *
îΩ
 = -
EDQUOT
;

4535 
out
;

4539 
ac
 = 
	`kmem_ˇche_zÆloc
(
pxt4_ac_ˇchï
, 
GFP_NOFS
);

4540 i‡(!
ac
) {

4541 
¨
->
Àn
 = 0;

4542 *
îΩ
 = -
ENOMEM
;

4543 
out
;

4546 *
îΩ
 = 
	`pxt4_mb_öôülize_c⁄ãxt
(
ac
, 
¨
);

4547 i‡(*
îΩ
) {

4548 
¨
->
Àn
 = 0;

4549 
out
;

4552 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_PREALLOC
;

4553 i‡(!
	`pxt4_mb_u£_¥óŒoˇãd
(
ac
)) {

4554 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_ALLOC
;

4555 
	`pxt4_mb_n‹mÆize_ªque°
(
ac
, 
¨
);

4556 
ª≥©
:

4558 *
îΩ
 = 
	`pxt4_mb_ªguœr_Æloˇt‹
(
ac
);

4559 i‡(*
îΩ
)

4560 
disˇrd_™d_exô
;

4565 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
 &&

4566 
ac
->
ac_o_ex
.
„_Àn
 <ác->
ac_b_ex
.fe_len)

4567 *
îΩ
 = 
	`pxt4_mb_√w_¥óŒoˇti⁄
(
ac
);

4568 i‡(*
îΩ
) {

4569 
disˇrd_™d_exô
:

4570 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4571 
îrout
;

4574 i‡(
	`likñy
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)) {

4575 *
îΩ
 = 
	`pxt4_mb_m¨k_disk•a˚_u£d
(
ac
, 
h™dÀ
, 
ª£rv_˛°rs
);

4576 i‡(*
îΩ
) {

4577 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4578 
îrout
;

4580 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4581 
¨
->
Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

4584 
‰ìd
 = 
	`pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
ac
->
ac_o_ex
.
„_Àn
);

4585 i‡(
‰ìd
)

4586 
ª≥©
;

4587 *
îΩ
 = -
ENOSPC
;

4590 
îrout
:

4591 i‡(*
îΩ
) {

4592 
ac
->
ac_b_ex
.
„_Àn
 = 0;

4593 
¨
->
Àn
 = 0;

4594 
	`pxt4_mb_show_ac
(
ac
);

4596 
	`pxt4_mb_ªÀa£_c⁄ãxt
(
ac
);

4597 
out
:

4598 i‡(
ac
)

4599 
	`kmem_ˇche_‰ì
(
pxt4_ac_ˇchï
, 
ac
);

4600 i‡(
öquŸa
 && 
¨
->
Àn
 < inquota)

4601 
	`dquŸ_‰ì_block
(
¨
->
öode
, 
	`PXT4_C2B
(
sbi
, 
öquŸa
 -ár->
Àn
));

4602 i‡(!
¨
->
Àn
) {

4603 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0)

4605 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

4606 
ª£rv_˛°rs
);

4609 
	`åa˚_pxt4_Æloˇã_blocks
(
¨
, ()
block
);

4611  
block
;

4612 
	}
}

4619 
	$pxt4_åy_mîge_‰ìd_exã¡
(
pxt4_sb_öfo
 *
sbi
,

4620 
pxt4_‰ì_d©a
 *
íåy
,

4621 
pxt4_‰ì_d©a
 *
√w_íåy
,

4622 
rb_roŸ
 *
íåy_rb_roŸ
)

4624 i‡((
íåy
->
efd_tid
 !
√w_íåy
->efd_tid) ||

4625 (
íåy
->
efd_group
 !
√w_íåy
->efd_group))

4627 i‡(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
 ==

4628 
√w_íåy
->
efd_°¨t_˛u°î
) {

4629 
√w_íåy
->
efd_°¨t_˛u°î
 = 
íåy
->efd_start_cluster;

4630 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4631 } i‡(
√w_íåy
->
efd_°¨t_˛u°î
 +Çew_íåy->
efd_cou¡
 ==

4632 
íåy
->
efd_°¨t_˛u°î
) {

4633 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4636 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4637 
	`li°_dñ
(&
íåy
->
efd_li°
);

4638 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4639 
	`rb_îa£
(&
íåy
->
efd_node
, 
íåy_rb_roŸ
);

4640 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

4641 
	}
}

4643 
noölöe_f‹_°ack
 

4644 
	$pxt4_mb_‰ì_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_buddy
 *
e4b
,

4645 
pxt4_‰ì_d©a
 *
√w_íåy
)

4647 
pxt4_group_t
 
group
 = 
e4b
->
bd_group
;

4648 
pxt4_gΩblk_t
 
˛u°î
;

4649 
pxt4_gΩblk_t
 
˛u°îs
 = 
√w_íåy
->
efd_cou¡
;

4650 
pxt4_‰ì_d©a
 *
íåy
;

4651 
pxt4_group_öfo
 *
db
 = 
e4b
->
bd_öfo
;

4652 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

4653 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4654 
rb_node
 **
n
 = &
db
->
bb_‰ì_roŸ
.rb_node, *
node
;

4655 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
;

4657 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

4658 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

4659 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

4661 
√w_node
 = &
√w_íåy
->
efd_node
;

4662 
˛u°î
 = 
√w_íåy
->
efd_°¨t_˛u°î
;

4664 i‡(!*
n
) {

4670 
	`gë_∑ge
(
e4b
->
bd_buddy_∑ge
);

4671 
	`gë_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

4673 *
n
) {

4674 
∑ª¡
 = *
n
;

4675 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_‰ì_d©a
, 
efd_node
);

4676 i‡(
˛u°î
 < 
íåy
->
efd_°¨t_˛u°î
)

4677 
n
 = &(*n)->
rb_À·
;

4678 i‡(
˛u°î
 >(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
))

4679 
n
 = &(*n)->
rb_right
;

4681 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0,

4682 
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

4683 
	`PXT4_C2B
(
sbi
, 
˛u°î
),

4689 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

4690 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
db
->
bb_‰ì_roŸ
);

4693 
node
 = 
	`rb_¥ev
(
√w_node
);

4694 i‡(
node
) {

4695 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4696 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4697 &(
db
->
bb_‰ì_roŸ
));

4700 
node
 = 
	`rb_√xt
(
√w_node
);

4701 i‡(
node
) {

4702 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4703 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4704 &(
db
->
bb_‰ì_roŸ
));

4707 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4708 
	`li°_add_èû
(&
√w_íåy
->
efd_li°
, &
sbi
->
s_‰ìd_d©a_li°
);

4709 
sbi
->
s_mb_‰ì_≥ndög
 +
˛u°îs
;

4710 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4712 
	}
}

4723 
	$pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4724 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

4725 
cou¡
, 
Êags
)

4727 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4728 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4729 
pxt4_group_desc
 *
gdp
;

4730 
ovîÊow
;

4731 
pxt4_gΩblk_t
 
bô
;

4732 
buf„r_hód
 *
gd_bh
;

4733 
pxt4_group_t
 
block_group
;

4734 
pxt4_sb_öfo
 *
sbi
;

4735 
pxt4_buddy
 
e4b
;

4736 
cou¡_˛u°îs
;

4737 
îr
 = 0;

4738 
ªt
;

4740 
	`might_¶ìp
();

4741 i‡(
bh
) {

4742 i‡(
block
)

4743 
	`BUG_ON
(
block
 !
bh
->
b_blockƒ
);

4745 
block
 = 
bh
->
b_blockƒ
;

4748 
sbi
 = 
	`PXT4_SB
(
sb
);

4749 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_VALIDATED
) &&

4750 !
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
cou¡
)) {

4751 
	`pxt4_îr‹
(
sb
, "Freeing blocksÇot in datazone - "

4752 "block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4753 
îr‹_ªtu∫
;

4756 
	`pxt4_debug
("‰ìög block %Œu\n", 
block
);

4757 
	`åa˚_pxt4_‰ì_blocks
(
öode
, 
block
, 
cou¡
, 
Êags
);

4759 i‡(
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4760 
	`BUG_ON
(
cou¡
 > 1);

4762 
	`pxt4_f‹gë
(
h™dÀ
, 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
,

4763 
öode
, 
bh
, 
block
);

4773 
ovîÊow
 = 
	`PXT4_PBLK_COFF
(
sbi
, 
block
);

4774 i‡(
ovîÊow
) {

4775 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4776 
ovîÊow
 = 
sbi
->
s_˛u°î_øtio
 - overflow;

4777 
block
 +
ovîÊow
;

4778 i‡(
cou¡
 > 
ovîÊow
)

4779 
cou¡
 -
ovîÊow
;

4783 
block
 -
ovîÊow
;

4784 
cou¡
 +
ovîÊow
;

4787 
ovîÊow
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
cou¡
);

4788 i‡(
ovîÊow
) {

4789 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4790 i‡(
cou¡
 > 
ovîÊow
)

4791 
cou¡
 -
ovîÊow
;

4795 
cou¡
 +
sbi
->
s_˛u°î_øtio
 - 
ovîÊow
;

4798 i‡(!
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4799 
i
;

4800 
is_mëad©a
 = 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
;

4802 
i
 = 0; i < 
cou¡
; i++) {

4803 
	`c⁄d_ªsched
();

4804 i‡(
is_mëad©a
)

4805 
bh
 = 
	`sb_föd_gë_block
(
öode
->
i_sb
, 
block
 + 
i
);

4806 
	`pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block
 + 
i
);

4810 
do_m‹e
:

4811 
ovîÊow
 = 0;

4812 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4814 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(

4815 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
))))

4822 i‡(
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

4823 
ovîÊow
 = 
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 -

4824 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

4825 
cou¡
 -
ovîÊow
;

4827 
cou¡_˛u°îs
 = 
	`PXT4_NUM_B2C
(
sbi
, 
cou¡
);

4828 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4829 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4830 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4831 
bôm≠_bh
 = 
NULL
;

4832 
îr‹_ªtu∫
;

4834 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4835 i‡(!
gdp
) {

4836 
îr
 = -
EIO
;

4837 
îr‹_ªtu∫
;

4840 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4841 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4842 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4843 
sbi
->
s_ôb_≥r_group
) ||

4844 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4845 
sbi
->
s_ôb_≥r_group
)) {

4847 
	`pxt4_îr‹
(
sb
, "Freeing blocks in system zone - "

4848 "Block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4850 
îr‹_ªtu∫
;

4853 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

4854 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

4855 i‡(
îr
)

4856 
îr‹_ªtu∫
;

4863 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4864 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

4865 i‡(
îr
)

4866 
îr‹_ªtu∫
;

4867 #ifde‡
AGGRESSIVE_CHECK


4869 
i
;

4870 
i
 = 0; i < 
cou¡_˛u°îs
; i++)

4871 
	`BUG_ON
(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
));

4874 
	`åa˚_pxt4_mbÆloc_‰ì
(
sb
, 
öode
, 
block_group
, 
bô
, 
cou¡_˛u°îs
);

4877 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
block_group
, &
e4b
,

4878 
GFP_NOFS
|
__GFP_NOFAIL
);

4879 i‡(
îr
)

4880 
îr‹_ªtu∫
;

4888 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

4889 ((
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
) ||

4890 !
	`pxt4_should_wrôeback_d©a
(
öode
))) {

4891 
pxt4_‰ì_d©a
 *
√w_íåy
;

4896 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_‰ì_d©a_ˇchï
,

4897 
GFP_NOFS
|
__GFP_NOFAIL
);

4898 
√w_íåy
->
efd_°¨t_˛u°î
 = 
bô
;

4899 
√w_íåy
->
efd_group
 = 
block_group
;

4900 
√w_íåy
->
efd_cou¡
 = 
cou¡_˛u°îs
;

4901 
√w_íåy
->
efd_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

4903 
	`pxt4_lock_group
(
sb
, 
block_group
);

4904 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4905 
	`pxt4_mb_‰ì_mëad©a
(
h™dÀ
, &
e4b
, 
√w_íåy
);

4911 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4912 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
block_group
, 
bô
, 
cou¡
,

4913 
NULL
);

4914 i‡(
îr
 &&Éº !-
EOPNOTSUPP
)

4915 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

4917 " wôh %d", 
block_group
, 
bô
, 
cou¡
,

4918 
îr
);

4920 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_öfo
);

4922 
	`pxt4_lock_group
(
sb
, 
block_group
);

4923 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4924 
	`mb_‰ì_blocks
(
öode
, &
e4b
, 
bô
, 
cou¡_˛u°îs
);

4927 
ªt
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë+ 
cou¡_˛u°îs
;

4928 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
ªt
);

4929 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
);

4930 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4931 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

4933 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

4934 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

4935 
	`©omic64_add
(
cou¡_˛u°îs
,

4936 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

4937 
Êex_group
)->
‰ì_˛u°îs
);

4945 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4946 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4947 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
cou¡_˛u°îs
));

4948 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

4949 
cou¡_˛u°îs
);

4952 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4955 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

4956 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

4959 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4960 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

4961 i‡(!
îr
)

4962 
îr
 = 
ªt
;

4964 i‡(
ovîÊow
 && !
îr
) {

4965 
block
 +
cou¡
;

4966 
cou¡
 = 
ovîÊow
;

4967 
	`put_bh
(
bôm≠_bh
);

4968 
do_m‹e
;

4970 
îr‹_ªtu∫
:

4971 
	`bªl£
(
bôm≠_bh
);

4972 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

4974 
	}
}

4985 
	$pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

4986 
pxt4_fsblk_t
 
block
, 
cou¡
)

4988 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4989 
buf„r_hód
 *
gd_bh
;

4990 
pxt4_group_t
 
block_group
;

4991 
pxt4_gΩblk_t
 
bô
;

4992 
i
;

4993 
pxt4_group_desc
 *
desc
;

4994 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4995 
pxt4_buddy
 
e4b
;

4996 
îr
 = 0, 
ªt
, 
‰ì_˛u°îs_cou¡
;

4997 
pxt4_gΩblk_t
 
˛u°îs_‰ìd
;

4998 
pxt4_fsblk_t
 
fú°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
);

4999 
pxt4_fsblk_t
 
œ°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
 + 
cou¡
 - 1);

5000 
˛u°î_cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

5002 
	`pxt4_debug
("Addög block(sË%Œu-%Œu\n", 
block
, block + 
cou¡
 - 1);

5004 i‡(
cou¡
 == 0)

5007 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

5012 i‡(
bô
 + 
˛u°î_cou¡
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

5013 
	`pxt4_w¨nög
(
sb
, "too many blocksáddedÅo group %u",

5014 
block_group
);

5015 
îr
 = -
EINVAL
;

5016 
îr‹_ªtu∫
;

5019 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

5020 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

5021 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

5022 
bôm≠_bh
 = 
NULL
;

5023 
îr‹_ªtu∫
;

5026 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5027 i‡(!
desc
) {

5028 
îr
 = -
EIO
;

5029 
îr‹_ªtu∫
;

5032 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5033 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5034 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
), 
sbi
->
s_ôb_≥r_group
) ||

5035 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
),

5036 
sbi
->
s_ôb_≥r_group
)) {

5037 
	`pxt4_îr‹
(
sb
, "Adding blocks in system zones - "

5039 
block
, 
cou¡
);

5040 
îr
 = -
EINVAL
;

5041 
îr‹_ªtu∫
;

5044 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

5045 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

5046 i‡(
îr
)

5047 
îr‹_ªtu∫
;

5054 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5055 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

5056 i‡(
îr
)

5057 
îr‹_ªtu∫
;

5059 
i
 = 0, 
˛u°îs_‰ìd
 = 0; i < 
˛u°î_cou¡
; i++) {

5060 
	`BUFFER_TRACE
(
bôm≠_bh
, "clear bit");

5061 i‡(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
)) {

5062 
	`pxt4_îr‹
(
sb
, "bitálready cleared for block %llu",

5063 (
pxt4_fsblk_t
)(
block
 + 
i
));

5064 
	`BUFFER_TRACE
(
bôm≠_bh
, "bitálready cleared");

5066 
˛u°îs_‰ìd
++;

5070 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
block_group
, &
e4b
);

5071 i‡(
îr
)

5072 
îr‹_ªtu∫
;

5079 
	`pxt4_lock_group
(
sb
, 
block_group
);

5080 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
˛u°î_cou¡
);

5081 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
bô
, 
˛u°î_cou¡
);

5082 
‰ì_˛u°îs_cou¡
 = 
˛u°îs_‰ìd
 +

5083 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

5084 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
desc
, 
‰ì_˛u°îs_cou¡
);

5085 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
desc
, 
bôm≠_bh
);

5086 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5087 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

5088 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

5089 
˛u°îs_‰ìd
);

5091 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

5092 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

5093 
	`©omic64_add
(
˛u°îs_‰ìd
,

5094 &
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
,

5095 
Êex_group
)->
‰ì_˛u°îs
);

5098 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5101 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

5102 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

5105 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5106 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

5107 i‡(!
îr
)

5108 
îr
 = 
ªt
;

5110 
îr‹_ªtu∫
:

5111 
	`bªl£
(
bôm≠_bh
);

5112 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

5113  
îr
;

5114 
	}
}

5128 
	$pxt4_åim_exã¡
(
su≥r_block
 *
sb
, 
°¨t
, 
cou¡
,

5129 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
)

5130 
	$__ªÀa£s
(
bôlock
)

5131 
	$__acquúes
(
bôlock
)

5133 
pxt4_‰ì_exã¡
 
ex
;

5134 
ªt
 = 0;

5136 
	`åa˚_pxt4_åim_exã¡
(
sb
, 
group
, 
°¨t
, 
cou¡
);

5138 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

5140 
ex
.
„_°¨t
 = 
°¨t
;

5141 
ex
.
„_group
 = 
group
;

5142 
ex
.
„_Àn
 = 
cou¡
;

5148 
	`mb_m¨k_u£d
(
e4b
, &
ex
);

5149 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5150 
ªt
 = 
	`pxt4_issue_disˇrd
(
sb
, 
group
, 
°¨t
, 
cou¡
, 
NULL
);

5151 
	`pxt4_lock_group
(
sb
, 
group
);

5152 
	`mb_‰ì_blocks
(
NULL
, 
e4b
, 
°¨t
, 
ex
.
„_Àn
);

5153  
ªt
;

5154 
	}
}

5174 
pxt4_gΩblk_t


5175 
	$pxt4_åim_Æl_‰ì
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

5176 
pxt4_gΩblk_t
 
°¨t
,Öxt4_gΩblk_à
max
,

5177 
pxt4_gΩblk_t
 
möblocks
)

5179 *
bôm≠
;

5180 
pxt4_gΩblk_t
 
√xt
, 
cou¡
 = 0, 
‰ì_cou¡
 = 0;

5181 
pxt4_buddy
 
e4b
;

5182 
ªt
 = 0;

5184 
	`åa˚_pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
°¨t
, 
max
);

5186 
ªt
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5187 i‡(
ªt
) {

5188 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

5189 
ªt
, 
group
);

5190  
ªt
;

5192 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5194 
	`pxt4_lock_group
(
sb
, 
group
);

5195 i‡(
	`PXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_öfo
) &&

5196 
möblocks
 >
	`©omic_ªad
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
))

5197 
out
;

5199 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5200 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5202 
°¨t
 <
max
) {

5203 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
 + 1, start);

5204 i‡(
°¨t
 > 
max
)

5206 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
 + 1, 
°¨t
);

5208 i‡((
√xt
 - 
°¨t
Ë>
möblocks
) {

5209 
ªt
 = 
	`pxt4_åim_exã¡
(
sb
, 
°¨t
,

5210 
√xt
 - 
°¨t
, 
group
, &
e4b
);

5211 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
)

5213 
ªt
 = 0;

5214 
cou¡
 +
√xt
 - 
°¨t
;

5216 
‰ì_cou¡
 +
√xt
 - 
°¨t
;

5217 
°¨t
 = 
√xt
 + 1;

5219 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

5220 
cou¡
 = -
ERESTARTSYS
;

5224 i‡(
	`√ed_ªsched
()) {

5225 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5226 
	`c⁄d_ªsched
();

5227 
	`pxt4_lock_group
(
sb
, 
group
);

5230 i‡((
e4b
.
bd_öfo
->
bb_‰ì
 - 
‰ì_cou¡
Ë< 
möblocks
)

5234 i‡(!
ªt
) {

5235 
ªt
 = 
cou¡
;

5236 
	`PXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_öfo
);

5238 
out
:

5239 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5240 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5242 
	`pxt4_debug
("trimmed %d blocks inÅhe group %d\n",

5243 
cou¡
, 
group
);

5245  
ªt
;

5246 
	}
}

5260 
	$pxt4_åim_fs
(
su≥r_block
 *
sb
, 
f°rim_ønge
 *
ønge
)

5262 
pxt4_group_öfo
 *
gΩ
;

5263 
pxt4_group_t
 
group
, 
fú°_group
, 
œ°_group
;

5264 
pxt4_gΩblk_t
 
˙t
 = 0, 
fú°_˛u°î
, 
œ°_˛u°î
;

5265 
uöt64_t
 
°¨t
, 
íd
, 
möÀn
, 
åimmed
 = 0;

5266 
pxt4_fsblk_t
 
fú°_d©a_blk
 =

5267 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

5268 
pxt4_fsblk_t
 
max_blks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
);

5269 
ªt
 = 0;

5271 
°¨t
 = 
ønge
->°¨à>> 
sb
->
s_blocksize_bôs
;

5272 
íd
 = 
°¨t
 + (
ønge
->
Àn
 >> 
sb
->
s_blocksize_bôs
) - 1;

5273 
möÀn
 = 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

5274 
ønge
->
möÀn
 >> 
sb
->
s_blocksize_bôs
);

5276 i‡(
möÀn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5277 
°¨t
 >
max_blks
 ||

5278 
ønge
->
Àn
 < 
sb
->
s_blocksize
)

5279  -
EINVAL
;

5280 i‡(
íd
 >
max_blks
)

5281 
íd
 = 
max_blks
 - 1;

5282 i‡(
íd
 <
fú°_d©a_blk
)

5283 
out
;

5284 i‡(
°¨t
 < 
fú°_d©a_blk
)

5285 
°¨t
 = 
fú°_d©a_blk
;

5288 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
°¨t
,

5289 &
fú°_group
, &
fú°_˛u°î
);

5290 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
íd
,

5291 &
œ°_group
, &
œ°_˛u°î
);

5294 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5296 
group
 = 
fú°_group
; grou∞<
œ°_group
; group++) {

5297 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

5299 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

5300 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
GFP_NOFS
);

5301 i‡(
ªt
)

5311 i‡(
group
 =
œ°_group
)

5312 
íd
 = 
œ°_˛u°î
;

5314 i‡(
gΩ
->
bb_‰ì
 >
möÀn
) {

5315 
˙t
 = 
	`pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
fú°_˛u°î
,

5316 
íd
, 
möÀn
);

5317 i‡(
˙t
 < 0) {

5318 
ªt
 = 
˙t
;

5321 
åimmed
 +
˙t
;

5328 
fú°_˛u°î
 = 0;

5331 i‡(!
ªt
)

5332 
	`©omic_£t
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
, 
möÀn
);

5334 
out
:

5335 
ønge
->
Àn
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
åimmed
Ë<< sb->
s_blocksize_bôs
;

5336  
ªt
;

5337 
	}
}

5341 
	$pxt4_mbÆloc_quîy_ønge
(

5342 
su≥r_block
 *
sb
,

5343 
pxt4_group_t
 
group
,

5344 
pxt4_gΩblk_t
 
°¨t
,

5345 
pxt4_gΩblk_t
 
íd
,

5346 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

5347 *
¥iv
)

5349 *
bôm≠
;

5350 
pxt4_gΩblk_t
 
√xt
;

5351 
pxt4_buddy
 
e4b
;

5352 
îr‹
;

5354 
îr‹
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5355 i‡(
îr‹
)

5356  
îr‹
;

5357 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5359 
	`pxt4_lock_group
(
sb
, 
group
);

5361 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5362 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5363 i‡(
íd
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

5364 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5366 
°¨t
 <
íd
) {

5367 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
íd
 + 1, start);

5368 i‡(
°¨t
 > 
íd
)

5370 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
íd
 + 1, 
°¨t
);

5372 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5373 
îr‹
 = 
	`f‹m©ãr
(
sb
, 
group
, 
°¨t
, 
√xt
 - sèπ, 
¥iv
);

5374 i‡(
îr‹
)

5375 
out_u∆ﬂd
;

5376 
	`pxt4_lock_group
(
sb
, 
group
);

5378 
°¨t
 = 
√xt
 + 1;

5381 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5382 
out_u∆ﬂd
:

5383 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5385  
îr‹
;

5386 
	}
}

	@mballoc.h

8 #i‚de‡
_PXT4_MBALLOC_H


9 
	#_PXT4_MBALLOC_H


	)

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/buf„r_hód.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/¥oc_fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/£q_fûe.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/muãx.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

28 #ifde‡
CONFIG_PXT4_DEBUG


29 
ush‹t
 
pxt4_mbÆloc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 i‡((
n
Ë<
pxt4_mbÆloc_debug
) { \

34 
	`¥ötk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#PXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#PXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	spxt4_‰ì_d©a
 {

83 
li°_hód
 
	mefd_li°
;

86 
rb_node
 
	mefd_node
;

89 
pxt4_group_t
 
	mefd_group
;

92 
pxt4_gΩblk_t
 
	mefd_°¨t_˛u°î
;

93 
pxt4_gΩblk_t
 
	mefd_cou¡
;

96 
tid_t
 
	mefd_tid
;

99 
	spxt4_¥óŒoc_•a˚
 {

100 
li°_hód
 
	m∑_öode_li°
;

101 
li°_hód
 
	m∑_group_li°
;

103 
li°_hód
 
	m∑_tmp_li°
;

104 
rcu_hód
 
	m∑_rcu
;

105 } 
	mu
;

106 
•ölock_t
 
	m∑_lock
;

107 
©omic_t
 
	m∑_cou¡
;

108 
	m∑_dñëed
;

109 
pxt4_fsblk_t
 
	m∑_p°¨t
;

110 
pxt4_lblk_t
 
	m∑_l°¨t
;

111 
pxt4_gΩblk_t
 
	m∑_Àn
;

112 
pxt4_gΩblk_t
 
	m∑_‰ì
;

113 
	m∑_ty≥
;

114 
•ölock_t
 *
	m∑_obj_lock
;

115 
öode
 *
	m∑_öode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	spxt4_‰ì_exã¡
 {

124 
pxt4_lblk_t
 
	m„_logiˇl
;

125 
pxt4_gΩblk_t
 
	m„_°¨t
;

126 
pxt4_group_t
 
	m„_group
;

127 
pxt4_gΩblk_t
 
	m„_Àn
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	spxt4_loˇlôy_group
 {

142 
muãx
 
	mlg_muãx
;

144 
li°_hód
 
	mlg_¥óŒoc_li°
[
PREALLOC_TB_SIZE
];

145 
•ölock_t
 
	mlg_¥óŒoc_lock
;

148 
	spxt4_Æloˇti⁄_c⁄ãxt
 {

149 
öode
 *
	mac_öode
;

150 
su≥r_block
 *
	mac_sb
;

153 
pxt4_‰ì_exã¡
 
	mac_o_ex
;

156 
pxt4_‰ì_exã¡
 
	mac_g_ex
;

159 
pxt4_‰ì_exã¡
 
	mac_b_ex
;

162 
pxt4_‰ì_exã¡
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sˇ¬ed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_èû
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_Êags
;

169 
__u8
 
	mac_°©us
;

170 
__u8
 
	mac_¸ôîü
;

171 
__u8
 
	mac_2‹dî
;

173 
__u8
 
	mac_›
;

174 
∑ge
 *
	mac_bôm≠_∑ge
;

175 
∑ge
 *
	mac_buddy_∑ge
;

176 
pxt4_¥óŒoc_•a˚
 *
	mac_∑
;

177 
pxt4_loˇlôy_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	spxt4_buddy
 {

185 
∑ge
 *
	mbd_buddy_∑ge
;

186 *
	mbd_buddy
;

187 
∑ge
 *
	mbd_bôm≠_∑ge
;

188 *
	mbd_bôm≠
;

189 
pxt4_group_öfo
 *
	mbd_öfo
;

190 
su≥r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkbôs
;

192 
pxt4_group_t
 
	mbd_group
;

195 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_gΩ_offs_to_block
(
su≥r_block
 *
sb
,

196 
pxt4_‰ì_exã¡
 *
„x
)

198  
	`pxt4_group_fú°_block_no
(
sb
, 
„x
->
„_group
) +

199 (
„x
->
„_°¨t
 << 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

200 
	}
}

202 (*
	tpxt4_mbÆloc_quîy_ønge_‚
)(

203 
	tsu≥r_block
 *
	tsb
,

204 
	tpxt4_group_t
 
	tagno
,

205 
	tpxt4_gΩblk_t
 
	t°¨t
,

206 
	tpxt4_gΩblk_t
 
	tÀn
,

207 *
	t¥iv
);

210 
	`pxt4_mbÆloc_quîy_ønge
(

211 
su≥r_block
 *
sb
,

212 
pxt4_group_t
 
agno
,

213 
pxt4_gΩblk_t
 
°¨t
,

214 
pxt4_gΩblk_t
 
íd
,

215 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

216 *
¥iv
);

	@migrate.c

8 
	~<löux/¶ab.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4_exã¡s.h
"

16 
	smigøã_°ru˘
 {

17 
pxt4_lblk_t
 
	mfú°_block
, 
	mœ°_block
, 
	mcuº_block
;

18 
pxt4_fsblk_t
 
	mfú°_pblock
, 
	mœ°_pblock
;

21 
	$föish_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

22 
migøã_°ru˘
 *
lb
)

25 
ªtvÆ
 = 0, 
√eded
;

26 
pxt4_exã¡
 
√wext
;

27 
pxt4_ext_∑th
 *
∑th
;

28 i‡(
lb
->
fú°_pblock
 == 0)

32 
√wext
.
ì_block
 = 
	`˝u_to_À32
(
lb
->
fú°_block
);

33 
√wext
.
ì_Àn
 = 
	`˝u_to_À16
(
lb
->
œ°_block
 -Üb->
fú°_block
 + 1);

34 
	`pxt4_ext_°‹e_pblock
(&
√wext
, 
lb
->
fú°_pblock
);

36 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

37 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lb
->
fú°_block
, 
NULL
, 0);

38 i‡(
	`IS_ERR
(
∑th
)) {

39 
ªtvÆ
 = 
	`PTR_ERR
(
∑th
);

40 
∑th
 = 
NULL
;

41 
îr_out
;

50 
√eded
 = 
	`pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
,

51 
lb
->
œ°_block
 -Üb->
fú°_block
 + 1, 
∑th
);

53 
ªtvÆ
 = 
	`pxt4_d©a£m_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
√eded
,Çeeded, 0);

54 i‡(
ªtvÆ
 < 0)

55 
îr_out
;

56 
ªtvÆ
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
, &
√wext
, 0);

57 
îr_out
:

58 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

59 
	`pxt4_ext_dr›_ªfs
(
∑th
);

60 
	`k‰ì
(
∑th
);

61 
lb
->
fú°_pblock
 = 0;

62  
ªtvÆ
;

63 
	}
}

65 
	$upd©e_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

66 
pxt4_fsblk_t
 
pblock
, 
migøã_°ru˘
 *
lb
)

68 
ªtvÆ
;

72 i‡(
lb
->
fú°_pblock
 &&

73 (
lb
->
œ°_pblock
+1 =
pblock
) &&

74 (
lb
->
œ°_block
+1 =lb->
cuº_block
)) {

75 
lb
->
œ°_pblock
 = 
pblock
;

76 
lb
->
œ°_block
 =Üb->
cuº_block
;

77 
lb
->
cuº_block
++;

83 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
öode
, 
lb
);

84 
lb
->
fú°_pblock
 =Üb->
œ°_pblock
 = 
pblock
;

85 
lb
->
fú°_block
 =Üb->
œ°_block
 =Üb->
cuº_block
;

86 
lb
->
cuº_block
++;

87  
ªtvÆ
;

88 
	}
}

90 
	$upd©e_öd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

91 
pxt4_fsblk_t
 
pblock
,

92 
migøã_°ru˘
 *
lb
)

94 
buf„r_hód
 *
bh
;

95 
__À32
 *
i_d©a
;

96 
i
, 
ªtvÆ
 = 0;

97 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

99 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

100 i‡(
	`IS_ERR
(
bh
))

101  
	`PTR_ERR
(
bh
);

103 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

104 
i
 = 0; i < 
max_íåõs
; i++) {

105 i‡(
i_d©a
[
i
]) {

106 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
öode
,

107 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

108 i‡(
ªtvÆ
)

111 
lb
->
cuº_block
++;

114 
	`put_bh
(
bh
);

115  
ªtvÆ
;

117 
	}
}

119 
	$upd©e_död_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

120 
pxt4_fsblk_t
 
pblock
,

121 
migøã_°ru˘
 *
lb
)

123 
buf„r_hód
 *
bh
;

124 
__À32
 *
i_d©a
;

125 
i
, 
ªtvÆ
 = 0;

126 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

128 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

129 i‡(
	`IS_ERR
(
bh
))

130  
	`PTR_ERR
(
bh
);

132 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

133 
i
 = 0; i < 
max_íåõs
; i++) {

134 i‡(
i_d©a
[
i
]) {

135 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
öode
,

136 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

137 i‡(
ªtvÆ
)

141 
lb
->
cuº_block
 +
max_íåõs
;

144 
	`put_bh
(
bh
);

145  
ªtvÆ
;

147 
	}
}

149 
	$upd©e_töd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

150 
pxt4_fsblk_t
 
pblock
,

151 
migøã_°ru˘
 *
lb
)

153 
buf„r_hód
 *
bh
;

154 
__À32
 *
i_d©a
;

155 
i
, 
ªtvÆ
 = 0;

156 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

158 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

159 i‡(
	`IS_ERR
(
bh
))

160  
	`PTR_ERR
(
bh
);

162 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

163 
i
 = 0; i < 
max_íåõs
; i++) {

164 i‡(
i_d©a
[
i
]) {

165 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
öode
,

166 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

167 i‡(
ªtvÆ
)

171 
lb
->
cuº_block
 +
max_íåõs
 * max_entries;

174 
	`put_bh
(
bh
);

175  
ªtvÆ
;

177 
	}
}

179 
	$‰ì_död_blocks
(
h™dÀ_t
 *
h™dÀ
,

180 
öode
 *öode, 
__À32
 
i_d©a
)

182 
i
;

183 
__À32
 *
tmp_id©a
;

184 
buf„r_hód
 *
bh
;

185 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

186 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

187 
îr
;

189 
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

190 i‡(
	`IS_ERR
(
bh
))

191  
	`PTR_ERR
(
bh
);

193 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

194 
i
 = 0; i < 
max_íåõs
; i++) {

195 i‡(
tmp_id©a
[
i
]) {

196 
îr
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
,

197 
PXT4_RESERVE_TRANS_BLOCKS
,

198 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
sb
, 1));

199 i‡(
îr
 < 0) {

200 
	`put_bh
(
bh
);

201  
îr
;

203 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

204 
	`À32_to_˝u
(
tmp_id©a
[
i
]), 1,

205 
PXT4_FREE_BLOCKS_METADATA
 |

206 
PXT4_FREE_BLOCKS_FORGET
);

209 
	`put_bh
(
bh
);

210 
îr
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
,

211 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
sb
, 1));

212 i‡(
îr
 < 0)

213  
îr
;

214 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

215 
PXT4_FREE_BLOCKS_METADATA
 |

216 
PXT4_FREE_BLOCKS_FORGET
);

218 
	}
}

220 
	$‰ì_töd_blocks
(
h™dÀ_t
 *
h™dÀ
,

221 
öode
 *öode, 
__À32
 
i_d©a
)

223 
i
, 
ªtvÆ
 = 0;

224 
__À32
 *
tmp_id©a
;

225 
buf„r_hód
 *
bh
;

226 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

228 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

229 i‡(
	`IS_ERR
(
bh
))

230  
	`PTR_ERR
(
bh
);

232 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

233 
i
 = 0; i < 
max_íåõs
; i++) {

234 i‡(
tmp_id©a
[
i
]) {

235 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
,

236 
öode
, 
tmp_id©a
[
i
]);

237 i‡(
ªtvÆ
) {

238 
	`put_bh
(
bh
);

239  
ªtvÆ
;

243 
	`put_bh
(
bh
);

244 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
,

245 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 1));

246 i‡(
ªtvÆ
 < 0)

247  
ªtvÆ
;

248 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

249 
PXT4_FREE_BLOCKS_METADATA
 |

250 
PXT4_FREE_BLOCKS_FORGET
);

252 
	}
}

254 
	$‰ì_öd_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
__À32
 *
i_d©a
)

256 
ªtvÆ
;

259 i‡(
i_d©a
[0]) {

260 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
,

261 
PXT4_RESERVE_TRANS_BLOCKS
,

262 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 1));

263 i‡(
ªtvÆ
 < 0)

264  
ªtvÆ
;

265 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

266 
	`À32_to_˝u
(
i_d©a
[0]), 1,

267 
PXT4_FREE_BLOCKS_METADATA
 |

268 
PXT4_FREE_BLOCKS_FORGET
);

272 i‡(
i_d©a
[1]) {

273 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[1]);

274 i‡(
ªtvÆ
)

275  
ªtvÆ
;

279 i‡(
i_d©a
[2]) {

280 
ªtvÆ
 = 
	`‰ì_töd_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[2]);

281 i‡(
ªtvÆ
)

282  
ªtvÆ
;

285 
	}
}

287 
	$pxt4_ext_sw≠_öode_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

288 
öode
 *
tmp_öode
)

290 
ªtvÆ
;

291 
__À32
 
i_d©a
[3];

292 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

293 
pxt4_öode_öfo
 *
tmp_ei
 = 
	`PXT4_I
(
tmp_öode
);

299 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 1, 0);

300 i‡(
ªtvÆ
 < 0)

301 
îr_out
;

303 
i_d©a
[0] = 
ei
->i_d©a[
PXT4_IND_BLOCK
];

304 
i_d©a
[1] = 
ei
->i_d©a[
PXT4_DIND_BLOCK
];

305 
i_d©a
[2] = 
ei
->i_d©a[
PXT4_TIND_BLOCK
];

307 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

313 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
)) {

314 
ªtvÆ
 = -
EAGAIN
;

315 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

316 
îr_out
;

318 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

323 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

324 
	`mem˝y
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

335 
	`•ö_lock
(&
öode
->
i_lock
);

336 
öode
->
i_blocks
 +
tmp_öode
->i_blocks;

337 
	`•ö_u∆ock
(&
öode
->
i_lock
);

338 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

344 
ªtvÆ
 = 
	`‰ì_öd_block
(
h™dÀ
, 
öode
, 
i_d©a
);

345 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

347 
îr_out
:

348  
ªtvÆ
;

349 
	}
}

351 
	$‰ì_ext_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

352 
pxt4_exã¡_idx
 *
ix
)

354 
i
, 
ªtvÆ
 = 0;

355 
pxt4_fsblk_t
 
block
;

356 
buf„r_hód
 *
bh
;

357 
pxt4_exã¡_hódî
 *
eh
;

359 
block
 = 
	`pxt4_idx_pblock
(
ix
);

360 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
block
, 0);

361 i‡(
	`IS_ERR
(
bh
))

362  
	`PTR_ERR
(
bh
);

364 
eh
 = (
pxt4_exã¡_hódî
 *)
bh
->
b_d©a
;

365 i‡(
eh
->
eh_dïth
 != 0) {

366 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

367 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

368 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

369 i‡(
ªtvÆ
) {

370 
	`put_bh
(
bh
);

371  
ªtvÆ
;

375 
	`put_bh
(
bh
);

376 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
,

377 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 1));

378 i‡(
ªtvÆ
 < 0)

379  
ªtvÆ
;

380 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

381 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

383 
	}
}

388 
	$‰ì_ext_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

390 
i
, 
ªtvÆ
 = 0;

391 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

392 
pxt4_exã¡_hódî
 *
eh
 = (pxt4_exã¡_hódî *)
ei
->
i_d©a
;

393 
pxt4_exã¡_idx
 *
ix
;

394 i‡(
eh
->
eh_dïth
 == 0)

399 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

400 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

401 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

402 i‡(
ªtvÆ
)

403  
ªtvÆ
;

405  
ªtvÆ
;

406 
	}
}

408 
	$pxt4_ext_migøã
(
öode
 *inode)

410 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

411 
h™dÀ_t
 *
h™dÀ
;

412 
ªtvÆ
 = 0, 
i
;

413 
__À32
 *
i_d©a
;

414 
pxt4_öode_öfo
 *
ei
;

415 
öode
 *
tmp_öode
 = 
NULL
;

416 
migøã_°ru˘
 
lb
;

417 
max_íåõs
;

418 
__u32
 
gﬂl
;

419 
uid_t
 
ow√r
[2];

425 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

426 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

427  -
EINVAL
;

429 i‡(
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 == 0)

433  
ªtvÆ
;

435 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

442 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
,

443 4 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
));

445 i‡(
	`IS_ERR
(
h™dÀ
)) {

446 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

447 
out_u∆ock
;

449 
gﬂl
 = (((
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(öode->
i_sb
)) *

450 
	`PXT4_INODES_PER_GROUP
(
öode
->
i_sb
)) + 1;

451 
ow√r
[0] = 
	`i_uid_ªad
(
öode
);

452 
ow√r
[1] = 
	`i_gid_ªad
(
öode
);

453 
tmp_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
	`d_öode
(
öode
->
i_sb
->
s_roŸ
),

454 
S_IFREG
, 
NULL
, 
gﬂl
, 
ow√r
, 0);

455 i‡(
	`IS_ERR
(
tmp_öode
)) {

456 
ªtvÆ
 = 
	`PTR_ERR
(
tmp_öode
);

457 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

458 
out_u∆ock
;

460 
	`i_size_wrôe
(
tmp_öode
, 
	`i_size_ªad
(
öode
));

465 
	`˛ór_∆ök
(
tmp_öode
);

467 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

468 
	`pxt4_‹ph™_add
(
h™dÀ
, 
tmp_öode
);

469 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

487 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

488 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

489 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

491 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

492 i‡(
	`IS_ERR
(
h™dÀ
)) {

498 
	`pxt4_‹ph™_dñ
(
NULL
, 
tmp_öode
);

499 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

500 
out_tmp_öode
;

503 
ei
 = 
	`PXT4_I
(
öode
);

504 
i_d©a
 = 
ei
->i_data;

505 
	`mem£t
(&
lb
, 0, (lb));

508 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

509 
i
 = 0; i < 
PXT4_NDIR_BLOCKS
; i++) {

510 i‡(
i_d©a
[
i
]) {

511 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

512 
	`À32_to_˝u
(
i_d©a
[
i
]), &
lb
);

513 i‡(
ªtvÆ
)

514 
îr_out
;

516 
lb
.
cuº_block
++;

518 i‡(
i_d©a
[
PXT4_IND_BLOCK
]) {

519 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

520 
	`À32_to_˝u
(
i_d©a
[
PXT4_IND_BLOCK
]), &
lb
);

521 i‡(
ªtvÆ
)

522 
îr_out
;

524 
lb
.
cuº_block
 +
max_íåõs
;

525 i‡(
i_d©a
[
PXT4_DIND_BLOCK
]) {

526 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

527 
	`À32_to_˝u
(
i_d©a
[
PXT4_DIND_BLOCK
]), &
lb
);

528 i‡(
ªtvÆ
)

529 
îr_out
;

531 
lb
.
cuº_block
 +
max_íåõs
 * max_entries;

532 i‡(
i_d©a
[
PXT4_TIND_BLOCK
]) {

533 
ªtvÆ
 = 
	`upd©e_töd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

534 
	`À32_to_˝u
(
i_d©a
[
PXT4_TIND_BLOCK
]), &
lb
);

535 i‡(
ªtvÆ
)

536 
îr_out
;

541 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
tmp_öode
, &
lb
);

542 
îr_out
:

543 i‡(
ªtvÆ
)

548 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

550 
ªtvÆ
 = 
	`pxt4_ext_sw≠_öode_d©a
(
h™dÀ
, 
öode
, 
tmp_öode
);

551 i‡(
ªtvÆ
)

556 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

560 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 1, 0);

561 i‡(
ªtvÆ
 < 0)

562 
out_°›
;

566 
	`i_size_wrôe
(
tmp_öode
, 0);

576 
tmp_öode
->
i_blocks
 = 0;

579 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

580 
out_°›
:

581 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

582 
out_tmp_öode
:

583 
	`u∆ock_√w_öode
(
tmp_öode
);

584 
	`ùut
(
tmp_öode
);

585 
out_u∆ock
:

586 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

587  
ªtvÆ
;

588 
	}
}

593 
	$pxt4_öd_migøã
(
öode
 *inode)

595 
pxt4_exã¡_hódî
 *
eh
;

596 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

597 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

598 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

599 
pxt4_exã¡
 *
ex
;

600 
i
, 
Àn
;

601 
pxt4_lblk_t
 
°¨t
, 
íd
;

602 
pxt4_fsblk_t
 
blk
;

603 
h™dÀ_t
 *
h™dÀ
;

604 
ªt
;

606 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

607 (!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

608  -
EINVAL
;

610 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
))

611  -
EOPNOTSUPP
;

618 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

619 
	`pxt4_Æloc_da_blocks
(
öode
);

621 
	`≥r˝u_down_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

623 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

624 i‡(
	`IS_ERR
(
h™dÀ
)) {

625 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

626 
out_u∆ock
;

629 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

630 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

631 i‡(
ªt
)

632 
îrout
;

634 
eh
 = 
	`ext_öode_hdr
(
öode
);

635 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

636 i‡(
	`pxt4_blocks_cou¡
(
es
Ë> 
PXT4_MAX_BLOCK_FILE_PHYS
 ||

637 
eh
->
eh_dïth
 !0 || 
	`À16_to_˝u
”h->
eh_íåõs
) > 1) {

638 
ªt
 = -
EOPNOTSUPP
;

639 
îrout
;

641 i‡(
eh
->
eh_íåõs
 == 0)

642 
blk
 = 
Àn
 = 
°¨t
 = 
íd
 = 0;

644 
Àn
 = 
	`À16_to_˝u
(
ex
->
ì_Àn
);

645 
blk
 = 
	`pxt4_ext_pblock
(
ex
);

646 
°¨t
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

647 
íd
 = 
°¨t
 + 
Àn
 - 1;

648 i‡(
íd
 >
PXT4_NDIR_BLOCKS
) {

649 
ªt
 = -
EOPNOTSUPP
;

650 
îrout
;

654 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

655 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

656 
i
 = 
°¨t
; i <
íd
; i++)

657 
ei
->
i_d©a
[
i
] = 
	`˝u_to_À32
(
blk
++);

658 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

659 
îrout
:

660 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

661 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

662 
out_u∆ock
:

663 
	`≥r˝u_up_wrôe
(&
sbi
->
s_wrôïages_rw£m
);

664  
ªt
;

665 
	}
}

	@mmp.c

2 
	~<löux/fs.h
>

3 
	~<löux/øndom.h
>

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/ut¢ame.h
>

6 
	~<löux/kthªad.h
>

8 
	~"pxt4.h
"

11 
__À32
 
	$pxt4_mmp_csum
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

13 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_°ru˘
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`˝u_to_À32
(
csum
);

20 
	}
}

22 
	$pxt4_mmp_csum_vîify
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

24 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =
	`pxt4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$pxt4_mmp_csum_£t
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

32 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`pxt4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wrôe_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 *
bh
)

44 
mmp_°ru˘
 *
mmp
 = (mmp_°ru˘ *)(
bh
->
b_d©a
);

50 
	`sb_°¨t_wrôe
(
sb
);

51 
	`pxt4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_buf„r
(
bh
);

53 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

54 
	`gë_bh
(
bh
);

55 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`waô_⁄_buf„r
(
bh
);

57 
	`sb_íd_wrôe
(
sb
);

58 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

62 
	}
}

68 
	$ªad_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bh
,

69 
pxt4_fsblk_t
 
mmp_block
)

71 
mmp_°ru˘
 *
mmp
;

72 
ªt
;

74 i‡(*
bh
)

75 
	`˛ór_buf„r_u±od©e
(*
bh
);

80 i‡(!*
bh
) {

81 *
bh
 = 
	`sb_gëblk
(
sb
, 
mmp_block
);

82 i‡(!*
bh
) {

83 
ªt
 = -
ENOMEM
;

84 
w¨n_exô
;

88 
	`gë_bh
(*
bh
);

89 
	`lock_buf„r
(*
bh
);

90 (*
bh
)->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

91 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`waô_⁄_buf„r
(*
bh
);

93 i‡(!
	`buf„r_u±od©e
(*
bh
)) {

94 
ªt
 = -
EIO
;

95 
w¨n_exô
;

97 
mmp
 = (
mmp_°ru˘
 *)((*
bh
)->
b_d©a
);

98 i‡(
	`À32_to_˝u
(
mmp
->
mmp_magic
Ë!
PXT4_MMP_MAGIC
) {

99 
ªt
 = -
EFSCORRUPTED
;

100 
w¨n_exô
;

102 i‡(!
	`pxt4_mmp_csum_vîify
(
sb
, 
mmp
)) {

103 
ªt
 = -
EFSBADCRC
;

104 
w¨n_exô
;

107 
w¨n_exô
:

108 
	`bªl£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`pxt4_w¨nög
(
sb
, "Error %d whileÑeading MMP block %llu",

111 
ªt
, 
mmp_block
);

112  
ªt
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
,

119 c⁄° *
fun˘i⁄
, 
löe
, c⁄° *
msg
)

121 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
, "%s", 
msg
);

122 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
,

124 ()
	`À64_to_˝u
(
mmp
->
mmp_time
),

125 ()(
mmp
->
mmp_nodíame
), mmp->mmp_nodename,

126 ()(
mmp
->
mmp_bdev«me
), mmp->mmp_bdevname);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su≥r_block
 *
sb
 = ((
mmpd_d©a
 *Ë
d©a
)->sb;

135 
buf„r_hód
 *
bh
 = ((
mmpd_d©a
 *Ë
d©a
)->bh;

136 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

137 
mmp_°ru˘
 *
mmp
;

138 
pxt4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
Áûed_wrôes
 = 0;

141 
mmp_upd©e_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

142 
mmp_check_öãrvÆ
;

143 
œ°_upd©e_time
;

144 
diff
;

145 
ªtvÆ
;

147 
mmp_block
 = 
	`À64_to_˝u
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

154 
mmp_check_öãrvÆ
 = 
	`max
(
PXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_öãrvÆ
,

155 
PXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

157 
	`BUILD_BUG_ON
((
mmp
->
mmp_bdev«me
Ë< 
BDEVNAME_SIZE
);

158 
	`bdev«me
(
bh
->
b_bdev
, 
mmp
->
mmp_bdev«me
);

160 
	`mem˝y
(
mmp
->
mmp_nodíame
, 
	`öô_ut¢ame
()->
nodíame
,

161 (
mmp
->
mmp_nodíame
));

163 !
	`kthªad_should_°›
()) {

164 i‡(++
£q
 > 
PXT4_MMP_SEQ_MAX
)

165 
£q
 = 1;

167 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

168 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

169 
œ°_upd©e_time
 = 
jiffõs
;

171 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

176 i‡(
ªtvÆ
) {

177 i‡((
Áûed_wrôes
 % 60) == 0)

178 
	`pxt4_îr‹
(
sb
, "Error writingÅo MMP block");

179 
Áûed_wrôes
++;

182 i‡(!(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

183 
PXT4_FEATURE_INCOMPAT_MMP
)) {

184 
	`pxt4_w¨nög
(
sb
, "kmmpd being stopped since MMP feature"

186 
exô_thªad
;

189 i‡(
	`sb_rd⁄ly
(
sb
))

192 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

193 i‡(
diff
 < 
mmp_upd©e_öãrvÆ
 * 
HZ
)

194 
	`scheduÀ_timeout_öãºu±ibÀ
(
mmp_upd©e_öãrvÆ
 *

195 
HZ
 - 
diff
);

202 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

203 i‡(
diff
 > 
mmp_check_öãrvÆ
 * 
HZ
) {

204 
buf„r_hód
 *
bh_check
 = 
NULL
;

205 
mmp_°ru˘
 *
mmp_check
;

207 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

208 i‡(
ªtvÆ
) {

209 
	`pxt4_îr‹
(
sb
, "errorÑeading MMP data: %d",

210 
ªtvÆ
);

211 
exô_thªad
;

214 
mmp_check
 = (
mmp_°ru˘
 *)(
bh_check
->
b_d©a
);

215 i‡(
mmp
->
mmp_£q
 !
mmp_check
->mmp_seq ||

216 
	`memcmp
(
mmp
->
mmp_nodíame
, 
mmp_check
->mmp_nodename,

217 (
mmp
->
mmp_nodíame
))) {

218 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

222 
	`pxt4_îr‹
(
sb
, "abort");

223 
	`put_bh
(
bh_check
);

224 
ªtvÆ
 = -
EBUSY
;

225 
exô_thªad
;

227 
	`put_bh
(
bh_check
);

234 
mmp_check_öãrvÆ
 = 
	`max
(
	`mö
(
PXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

235 
PXT4_MMP_MAX_CHECK_INTERVAL
),

236 
PXT4_MMP_MIN_CHECK_INTERVAL
);

237 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

243 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
PXT4_MMP_SEQ_CLEAN
);

244 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

246 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

248 
exô_thªad
:

249 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

250 
	`k‰ì
(
d©a
);

251 
	`bªl£
(
bh
);

252  
ªtvÆ
;

253 
	}
}

259 
	$mmp_√w_£q
()

261 
u32
 
√w_£q
;

264 
√w_£q
 = 
	`¥™dom_u32
();

265 } 
√w_£q
 > 
PXT4_MMP_SEQ_MAX
);

267  
√w_£q
;

268 
	}
}

273 
	$pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *
sb
,

274 
pxt4_fsblk_t
 
mmp_block
)

276 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

277 
buf„r_hód
 *
bh
 = 
NULL
;

278 
mmp_°ru˘
 *
mmp
 = 
NULL
;

279 
mmpd_d©a
 *mmpd_data;

280 
u32
 
£q
;

281 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

282 
waô_time
 = 0;

283 
ªtvÆ
;

285 i‡(
mmp_block
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

286 
mmp_block
 >
	`pxt4_blocks_cou¡
(
es
)) {

287 
	`pxt4_w¨nög
(
sb
, "Invalid MMP block in superblock");

288 
Áûed
;

291 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

292 i‡(
ªtvÆ
)

293 
Áûed
;

295 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

297 i‡(
mmp_check_öãrvÆ
 < 
PXT4_MMP_MIN_CHECK_INTERVAL
)

298 
mmp_check_öãrvÆ
 = 
PXT4_MMP_MIN_CHECK_INTERVAL
;

304 i‡(
	`À16_to_˝u
(
mmp
->
mmp_check_öãrvÆ
) > mmp_check_interval)

305 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
mmp
->mmp_check_interval);

307 
£q
 = 
	`À32_to_˝u
(
mmp
->
mmp_£q
);

308 i‡(
£q
 =
PXT4_MMP_SEQ_CLEAN
)

309 
skù
;

311 i‡(
£q
 =
PXT4_MMP_SEQ_FSCK
) {

312 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck isÑunning onÅhe filesystem");

313 
Áûed
;

316 
waô_time
 = 
	`mö
(
mmp_check_öãrvÆ
 * 2 + 1,

317 
mmp_check_öãrvÆ
 + 60);

320 i‡(
waô_time
 > 
PXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

321 
	`pxt4_w¨nög
(
sb
, "MMP interval %u higherÅhanÉxpected,Ölease"

322 " waô.\n", 
waô_time
 * 2);

324 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

325 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount\n");

326 
Áûed
;

329 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

330 i‡(
ªtvÆ
)

331 
Áûed
;

332 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

333 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

334 
	`dump_mmp_msg
(
sb
, 
mmp
,

336 
Áûed
;

339 
skù
:

343 
£q
 = 
	`mmp_√w_£q
();

344 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

346 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

347 i‡(
ªtvÆ
)

348 
Áûed
;

353 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

354 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount");

355 
Áûed
;

358 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

359 i‡(
ªtvÆ
)

360 
Áûed
;

361 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

362 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

363 
	`dump_mmp_msg
(
sb
, 
mmp
,

365 
Áûed
;

368 
mmpd_d©a
 = 
	`kmÆloc
((*mmpd_d©a), 
GFP_KERNEL
);

369 i‡(!
mmpd_d©a
) {

370 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for mmpd_data");

371 
Áûed
;

373 
mmpd_d©a
->
sb
 = sb;

374 
mmpd_d©a
->
bh
 = bh;

379 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kthªad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%.*s",

380 ()(
mmp
->
mmp_bdev«me
),

381 
	`bdev«me
(
bh
->
b_bdev
,

382 
mmp
->
mmp_bdev«me
));

383 i‡(
	`IS_ERR
(
	`PXT4_SB
(
sb
)->
s_mmp_tsk
)) {

384 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

385 
	`k‰ì
(
mmpd_d©a
);

386 
	`pxt4_w¨nög
(
sb
, "UnableÅo create kmmpdÅhread for %s.",

387 
sb
->
s_id
);

388 
Áûed
;

393 
Áûed
:

394 
	`bªl£
(
bh
);

396 
	}
}

	@move_extent.c

8 
	~<löux/fs.h
>

9 
	~<löux/quŸa›s.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"pxt4_exã¡s.h
"

24 
ölöe
 

25 
	$gë_ext_∑th
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
,

26 
pxt4_ext_∑th
 **
µ©h
)

28 
pxt4_ext_∑th
 *
∑th
;

30 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lblock
, 
µ©h
, 
PXT4_EX_NOCACHE
);

31 i‡(
	`IS_ERR
(
∑th
))

32  
	`PTR_ERR
(
∑th
);

33 i‡(
∑th
[
	`ext_dïth
(
öode
)].
p_ext
 =
NULL
) {

34 
	`pxt4_ext_dr›_ªfs
(
∑th
);

35 
	`k‰ì
(
∑th
);

36 *
µ©h
 = 
NULL
;

37  -
ENODATA
;

39 *
µ©h
 = 
∑th
;

41 
	}
}

51 
	$pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
, öodê*
£c⁄d
)

53 i‡(
fú°
 < 
£c⁄d
) {

54 
	`down_wrôe
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
);

55 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wrôe
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
);

58 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

72 
öode
 *
d⁄‹_öode
)

74 
	`up_wrôe
(&
	`PXT4_I
(
‹ig_öode
)->
i_d©a_£m
);

75 
	`up_wrôe
(&
	`PXT4_I
(
d⁄‹_öode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_covîage
(
öode
 *öode, 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
cou¡
,

91 
unwrôãn
, *
îr
)

93 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

94 
pxt4_exã¡
 *
ext
;

95 
ªt
 = 0;

96 
pxt4_lblk_t
 
œ°
 = 
‰om
 + 
cou¡
;

97 
‰om
 < 
œ°
) {

98 *
îr
 = 
	`gë_ext_∑th
(
öode
, 
‰om
, &
∑th
);

99 i‡(*
îr
)

100 
out
;

101 
ext
 = 
∑th
[
	`ext_dïth
(
öode
)].
p_ext
;

102 i‡(
unwrôãn
 !
	`pxt4_ext_is_unwrôãn
(
ext
))

103 
out
;

104 
‰om
 +
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

105 
	`pxt4_ext_dr›_ªfs
(
∑th
);

107 
ªt
 = 1;

108 
out
:

109 
	`pxt4_ext_dr›_ªfs
(
∑th
);

110 
	`k‰ì
(
∑th
);

111  
ªt
;

112 
	}
}

126 
	$mext_∑ge_doubÀ_lock
(
öode
 *
öode1
, öodê*
öode2
,

127 
pgoff_t
 
ödex1
,Ögoff_à
ödex2
, 
∑ge
 *page[2])

129 
addªss_•a˚
 *
m≠pög
[2];

130 
Ê
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
öode1
 || !
öode2
);

133 i‡(
öode1
 < 
öode2
) {

134 
m≠pög
[0] = 
öode1
->
i_m≠pög
;

135 
m≠pög
[1] = 
öode2
->
i_m≠pög
;

137 
	`sw≠
(
ödex1
, 
ödex2
);

138 
m≠pög
[0] = 
öode2
->
i_m≠pög
;

139 
m≠pög
[1] = 
öode1
->
i_m≠pög
;

142 
∑ge
[0] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[0], 
ödex1
, 
Ê
);

143 i‡(!
∑ge
[0])

144  -
ENOMEM
;

146 
∑ge
[1] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[1], 
ödex2
, 
Ê
);

147 i‡(!
∑ge
[1]) {

148 
	`u∆ock_∑ge
(
∑ge
[0]);

149 
	`put_∑ge
(
∑ge
[0]);

150  -
ENOMEM
;

157 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[0]);

158 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[1]);

159 i‡(
öode1
 > 
öode2
)

160 
	`sw≠
(
∑ge
[0],Öage[1]);

163 
	}
}

167 
	$mext_∑ge_mku±od©e
(
∑ge
 *∑ge, 
‰om
, 
to
)

169 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

170 
£˘‹_t
 
block
;

171 
buf„r_hód
 *
bh
, *
hód
, *
¨r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_°¨t
, 
block_íd
;

173 
i
, 
îr
, 
ƒ
 = 0, 
∑πül
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

175 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

177 i‡(
	`PageU±od©e
(
∑ge
))

180 
blocksize
 = 
	`i_blocksize
(
öode
);

181 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

182 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

185 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

186 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

187 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

188 
block_íd
 = 
block_°¨t
 + 
blocksize
;

189 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

190 i‡(!
	`buf„r_u±od©e
(
bh
))

191 
∑πül
 = 1;

194 i‡(
	`buf„r_u±od©e
(
bh
))

196 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

197 
îr
 = 
	`pxt4_gë_block
(
öode
, 
block
, 
bh
, 0);

198 i‡(
îr
) {

199 
	`SëPageEº‹
(
∑ge
);

200  
îr
;

202 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

203 
	`zîo_u£r
(
∑ge
, 
block_°¨t
, 
blocksize
);

204 
	`£t_buf„r_u±od©e
(
bh
);

208 
	`BUG_ON
(
ƒ
 >
MAX_BUF_PER_PAGE
);

209 
¨r
[
ƒ
++] = 
bh
;

212 i‡(!
ƒ
)

213 
out
;

215 
i
 = 0; i < 
ƒ
; i++) {

216 
bh
 = 
¨r
[
i
];

217 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

218 
îr
 = 
	`bh_submô_ªad
(
bh
);

219 i‡(
îr
)

220  
îr
;

223 
out
:

224 i‡(!
∑πül
)

225 
	`SëPageU±od©e
(
∑ge
);

227 
	}
}

247 
	$move_exã¡_≥r_∑ge
(
fûe
 *
o_fûp
, 
öode
 *
d⁄‹_öode
,

248 
pgoff_t
 
‹ig_∑ge_off£t
,Ögoff_à
d⁄‹_∑ge_off£t
,

249 
d©a_off£t_ö_∑ge
,

250 
block_Àn_ö_∑ge
, 
unwrôãn
, *
îr
)

252 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

253 
∑ge
 *
∑gï
[2] = {
NULL
, NULL};

254 
h™dÀ_t
 *
h™dÀ
;

255 
pxt4_lblk_t
 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
;

256 
blocksize
 = 
‹ig_öode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
ª∂a˚d_size
;

258 
i
, 
îr2
, 
jblocks
, 
ªåõs
 = 0;

259 
ª∂a˚d_cou¡
 = 0;

260 
‰om
 = 
d©a_off£t_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

261 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

262 
su≥r_block
 *
sb
 = 
‹ig_öode
->
i_sb
;

263 
buf„r_hód
 *
bh
 = 
NULL
;

269 
agaö
:

270 *
îr
 = 0;

271 
jblocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
‹ig_öode
) * 2;

272 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
‹ig_öode
, 
PXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 i‡(
	`IS_ERR
(
h™dÀ
)) {

274 *
îr
 = 
	`PTR_ERR
(
h™dÀ
);

278 
‹ig_blk_off£t
 = 
‹ig_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

279 
d©a_off£t_ö_∑ge
;

281 
d⁄‹_blk_off£t
 = 
d⁄‹_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

282 
d©a_off£t_ö_∑ge
;

285 i‡((
‹ig_blk_off£t
 + 
block_Àn_ö_∑ge
 - 1) ==

286 ((
‹ig_öode
->
i_size
 - 1Ë>> orig_öode->
i_blkbôs
)) {

288 
tmp_d©a_size
 = 
‹ig_öode
->
i_size
 & (
blocksize
 - 1);

293 i‡(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Àn_ö_∑ge
 - 1Ë<< 
‹ig_öode
->
i_blkbôs
);

299 
d©a_size
 = 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

301 
ª∂a˚d_size
 = 
d©a_size
;

303 *
îr
 = 
	`mext_∑ge_doubÀ_lock
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_∑ge_off£t
,

304 
d⁄‹_∑ge_off£t
, 
∑gï
);

305 i‡(
	`u∆ikñy
(*
îr
 < 0))

306 
°›_jou∫Æ
;

314 i‡(
unwrôãn
) {

315 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

318 
unwrôãn
 = 
	`mext_check_covîage
(
‹ig_öode
, 
‹ig_blk_off£t
,

319 
block_Àn_ö_∑ge
, 1, 
îr
);

320 i‡(*
îr
)

321 
dr›_d©a_£m
;

323 
unwrôãn
 &
	`mext_check_covîage
(
d⁄‹_öode
, 
d⁄‹_blk_off£t
,

324 
block_Àn_ö_∑ge
, 1, 
îr
);

325 i‡(*
îr
)

326 
dr›_d©a_£m
;

328 i‡(!
unwrôãn
) {

329 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

330 
d©a_c›y
;

332 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]) &&

333 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[0], 0)) ||

334 (
	`∑ge_has_¥iv©e
(
∑gï
[1]) &&

335 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[1], 0))) {

336 *
îr
 = -
EBUSY
;

337 
dr›_d©a_£m
;

339 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
,

340 
d⁄‹_öode
, 
‹ig_blk_off£t
,

341 
d⁄‹_blk_off£t
,

342 
block_Àn_ö_∑ge
, 1, 
îr
);

343 
dr›_d©a_£m
:

344 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

345 
u∆ock_∑ges
;

347 
d©a_c›y
:

348 *
îr
 = 
	`mext_∑ge_mku±od©e
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

349 i‡(*
îr
)

350 
u∆ock_∑ges
;

354 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[0], 0)) ||

355 (
	`∑ge_has_¥iv©e
(
∑gï
[1]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[1], 0))) {

356 *
îr
 = -
EBUSY
;

357 
u∆ock_∑ges
;

359 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

360 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
, 
d⁄‹_öode
,

361 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

362 
block_Àn_ö_∑ge
, 1, 
îr
);

363 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

364 i‡(*
îr
) {

365 i‡(
ª∂a˚d_cou¡
) {

366 
block_Àn_ö_∑ge
 = 
ª∂a˚d_cou¡
;

367 
ª∂a˚d_size
 =

368 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

370 
u∆ock_∑ges
;

374 i‡(!
	`∑ge_has_buf„rs
(
∑gï
[0]))

375 
	`¸óã_em±y_buf„rs
(
∑gï
[0], 1 << 
‹ig_öode
->
i_blkbôs
, 0);

376 
bh
 = 
	`∑ge_buf„rs
(
∑gï
[0]);

377 
i
 = 0; i < 
d©a_off£t_ö_∑ge
; i++)

378 
bh
 = bh->
b_this_∑ge
;

379 
i
 = 0; i < 
block_Àn_ö_∑ge
; i++) {

380 *
îr
 = 
	`pxt4_gë_block
(
‹ig_öode
, 
‹ig_blk_off£t
 + 
i
, 
bh
, 0);

381 i‡(*
îr
 < 0)

383 
bh
 = bh->
b_this_∑ge
;

385 i‡(!*
îr
)

386 *
îr
 = 
	`block_commô_wrôe
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

388 i‡(
	`u∆ikñy
(*
îr
 < 0))

389 
ª∑ú_bønches
;

393 *
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
‹ig_öode
,

394 (
loff_t
)
‹ig_∑ge_off£t
 << 
PAGE_SHIFT
, 
ª∂a˚d_size
);

396 
u∆ock_∑ges
:

397 
	`u∆ock_∑ge
(
∑gï
[0]);

398 
	`put_∑ge
(
∑gï
[0]);

399 
	`u∆ock_∑ge
(
∑gï
[1]);

400 
	`put_∑ge
(
∑gï
[1]);

401 
°›_jou∫Æ
:

402 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

403 i‡(*
îr
 =-
ENOSPC
 &&

404 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

405 
agaö
;

408 i‡(*
îr
 =-
EBUSY
 && 
ªåõs
++ < 4 && 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

409 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
))

410 
agaö
;

411  
ª∂a˚d_cou¡
;

413 
ª∑ú_bønches
:

419 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

420 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
d⁄‹_öode
, 
‹ig_öode
,

421 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

422 
block_Àn_ö_∑ge
, 0, &
îr2
);

423 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

424 i‡(
ª∂a˚d_cou¡
 !
block_Àn_ö_∑ge
) {

425 
	`PXT4_ERROR_INODE_BLOCK
(
‹ig_öode
, (
£˘‹_t
)(
‹ig_blk_off£t
),

428 *
îr
 = -
EIO
;

430 
ª∂a˚d_cou¡
 = 0;

431 
u∆ock_∑ges
;

432 
	}
}

448 
	$mext_check_¨gumíts
(
öode
 *
‹ig_öode
,

449 
öode
 *
d⁄‹_öode
, 
__u64
 
‹ig_°¨t
,

450 
__u64
 
d⁄‹_°¨t
, __u64 *
Àn
)

452 
__u64
 
‹ig_eof
, 
d⁄‹_eof
;

453 
blkbôs
 = 
‹ig_öode
->
i_blkbôs
;

454 
blocksize
 = 1 << 
blkbôs
;

456 
‹ig_eof
 = (
	`i_size_ªad
(
‹ig_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

457 
d⁄‹_eof
 = (
	`i_size_ªad
(
d⁄‹_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

460 i‡(
d⁄‹_öode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

461 
	`pxt4_debug
("pxt4 moveÉxtent: suid or sgid is set"

463 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

464  -
EINVAL
;

467 i‡(
	`IS_IMMUTABLE
(
d⁄‹_öode
Ë|| 
	`IS_APPEND
(donor_inode))

468  -
EPERM
;

471 i‡(
	`IS_SWAPFILE
(
‹ig_öode
Ë|| IS_SWAPFILE(
d⁄‹_öode
)) {

472 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

474 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

475  -
EBUSY
;

478 i‡(
	`pxt4_is_quŸa_fûe
(
‹ig_öode
Ë&&Öxt4_is_quŸa_fûe(
d⁄‹_öode
)) {

479 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

481 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

482  -
EBUSY
;

486 i‡(!(
	`pxt4_ã°_öode_Êag
(
‹ig_öode
, 
PXT4_INODE_EXTENTS
))) {

487 
	`pxt4_debug
("pxt4 moveÉxtent: orig file isÇotÉxtents "

488 "ba£d fûê[öo:‹ig %lu]\n", 
‹ig_öode
->
i_öo
);

489  -
EOPNOTSUPP
;

490 } i‡(!(
	`pxt4_ã°_öode_Êag
(
d⁄‹_öode
, 
PXT4_INODE_EXTENTS
))) {

491 
	`pxt4_debug
("pxt4 moveÉxtent: donor file isÇotÉxtents "

492 "ba£d fûê[öo:d⁄‹ %lu]\n", 
d⁄‹_öode
->
i_öo
);

493  -
EOPNOTSUPP
;

496 i‡((!
‹ig_öode
->
i_size
Ë|| (!
d⁄‹_öode
->i_size)) {

497 
	`pxt4_debug
("pxt4 moveÉxtent: File size is 0 byte\n");

498  -
EINVAL
;

502 i‡((
‹ig_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
)) !=

503 (
d⁄‹_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
))) {

504 
	`pxt4_debug
("pxt4 moveÉxtent: origánd donor's start "

506 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

507  -
EINVAL
;

510 i‡((
‹ig_°¨t
 >
EXT_MAX_BLOCKS
) ||

511 (
d⁄‹_°¨t
 >
EXT_MAX_BLOCKS
) ||

512 (*
Àn
 > 
EXT_MAX_BLOCKS
) ||

513 (
d⁄‹_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
) ||

514 (
‹ig_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
)) {

515 
	`pxt4_debug
("pxt4 moveÉxtent: Can't handle over [%u] blocks "

516 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
EXT_MAX_BLOCKS
,

517 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

518  -
EINVAL
;

520 i‡(
‹ig_eof
 <
‹ig_°¨t
)

521 *
Àn
 = 0;

522 i‡(
‹ig_eof
 < 
‹ig_°¨t
 + *
Àn
 - 1)

523 *
Àn
 = 
‹ig_eof
 - 
‹ig_°¨t
;

524 i‡(
d⁄‹_eof
 <
d⁄‹_°¨t
)

525 *
Àn
 = 0;

526 i‡(
d⁄‹_eof
 < 
d⁄‹_°¨t
 + *
Àn
 - 1)

527 *
Àn
 = 
d⁄‹_eof
 - 
d⁄‹_°¨t
;

528 i‡(!*
Àn
) {

529 
	`pxt4_debug
("pxt4 moveÉxtent:Üen shouldÇot be 0 "

530 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
‹ig_öode
->
i_öo
,

531 
d⁄‹_öode
->
i_öo
);

532  -
EINVAL
;

536 
	}
}

553 
	$pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
, 
__u64
 
‹ig_blk
,

554 
__u64
 
d⁄‹_blk
, __u64 
Àn
, __u64 *
moved_Àn
)

556 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

557 
öode
 *
d⁄‹_öode
 = 
	`fûe_öode
(
d_fûp
);

558 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

559 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

560 
pxt4_lblk_t
 
o_íd
, 
o_°¨t
 = 
‹ig_blk
;

561 
pxt4_lblk_t
 
d_°¨t
 = 
d⁄‹_blk
;

562 
ªt
;

564 i‡(
‹ig_öode
->
i_sb
 !
d⁄‹_öode
->i_sb) {

565 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files "

567 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

568  -
EINVAL
;

572 i‡(
‹ig_öode
 =
d⁄‹_öode
) {

573 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files shouldÇot "

575 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

576  -
EINVAL
;

580 i‡(!
	`S_ISREG
(
‹ig_öode
->
i_mode
Ë|| !S_ISREG(
d⁄‹_öode
->i_mode)) {

581 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should be "

583 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

584  -
EINVAL
;

589 i‡(
	`pxt4_should_jou∫Æ_d©a
(
‹ig_öode
) ||

590 
	`pxt4_should_jou∫Æ_d©a
(
d⁄‹_öode
)) {

591 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

593  -
EOPNOTSUPP
;

596 i‡(
	`IS_ENCRYPTED
(
‹ig_öode
Ë|| IS_ENCRYPTED(
d⁄‹_öode
)) {

597 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

599  -
EOPNOTSUPP
;

603 
	`lock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

606 
	`öode_dio_waô
(
‹ig_öode
);

607 
	`öode_dio_waô
(
d⁄‹_öode
);

610 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

612 
ªt
 = 
	`mext_check_¨gumíts
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_blk
,

613 
d⁄‹_blk
, &
Àn
);

614 i‡(
ªt
)

615 
out
;

616 
o_íd
 = 
o_°¨t
 + 
Àn
;

618 
o_°¨t
 < 
o_íd
) {

619 
pxt4_exã¡
 *
ex
;

620 
pxt4_lblk_t
 
cur_blk
, 
√xt_blk
;

621 
pgoff_t
 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
;

622 
off£t_ö_∑ge
;

623 
unwrôãn
, 
cur_Àn
;

625 
ªt
 = 
	`gë_ext_∑th
(
‹ig_öode
, 
o_°¨t
, &
∑th
);

626 i‡(
ªt
)

627 
out
;

628 
ex
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

629 
√xt_blk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

630 
cur_blk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

631 
cur_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

633 i‡(
cur_blk
 + 
cur_Àn
 - 1 < 
o_°¨t
) {

634 i‡(
√xt_blk
 =
EXT_MAX_BLOCKS
) {

635 
o_°¨t
 = 
o_íd
;

636 
ªt
 = -
ENODATA
;

637 
out
;

639 
d_°¨t
 +
√xt_blk
 - 
o_°¨t
;

640 
o_°¨t
 = 
√xt_blk
;

643 } i‡(
cur_blk
 > 
o_°¨t
) {

645 
d_°¨t
 +
cur_blk
 - 
o_°¨t
;

646 
o_°¨t
 = 
cur_blk
;

648 i‡(
cur_blk
 >
o_íd
)

649 
out
;

651 
cur_Àn
 +
cur_blk
 - 
o_°¨t
;

653 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

654 i‡(
o_íd
 - 
o_°¨t
 < 
cur_Àn
)

655 
cur_Àn
 = 
o_íd
 - 
o_°¨t
;

657 
‹ig_∑ge_ödex
 = 
o_°¨t
 >> (
PAGE_SHIFT
 -

658 
‹ig_öode
->
i_blkbôs
);

659 
d⁄‹_∑ge_ödex
 = 
d_°¨t
 >> (
PAGE_SHIFT
 -

660 
d⁄‹_öode
->
i_blkbôs
);

661 
off£t_ö_∑ge
 = 
o_°¨t
 % 
blocks_≥r_∑ge
;

662 i‡(
cur_Àn
 > 
blocks_≥r_∑ge
- 
off£t_ö_∑ge
)

663 
cur_Àn
 = 
blocks_≥r_∑ge
 - 
off£t_ö_∑ge
;

671 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

673 
	`move_exã¡_≥r_∑ge
(
o_fûp
, 
d⁄‹_öode
,

674 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
,

675 
off£t_ö_∑ge
, 
cur_Àn
,

676 
unwrôãn
, &
ªt
);

677 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

678 i‡(
ªt
 < 0)

680 
o_°¨t
 +
cur_Àn
;

681 
d_°¨t
 +
cur_Àn
;

683 *
moved_Àn
 = 
o_°¨t
 - 
‹ig_blk
;

684 i‡(*
moved_Àn
 > 
Àn
)

685 *
moved_Àn
 = 
Àn
;

687 
out
:

688 i‡(*
moved_Àn
) {

689 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
‹ig_öode
);

690 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
d⁄‹_öode
);

693 
	`pxt4_ext_dr›_ªfs
(
∑th
);

694 
	`k‰ì
(
∑th
);

695 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

696 
	`u∆ock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

698  
ªt
;

699 
	}
}

	@namei.c

28 
	~<löux/fs.h
>

29 
	~<löux/∑gem≠.h
>

30 
	~<löux/time.h
>

31 
	~<löux/f˙é.h
>

32 
	~<löux/°©.h
>

33 
	~<löux/°rög.h
>

34 
	~<löux/quŸa›s.h
>

35 
	~<löux/buf„r_hód.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/ivîsi⁄.h
>

38 
	~<löux/unicode.h
>

39 
	~"pxt4.h
"

40 
	~"pxt4_jbd3.h
"

42 
	~"x©å.h
"

43 
	~"a˛.h
"

45 
	~<åa˚/evíts/pxt4.h
>

49 
	#NAMEI_RA_CHUNKS
 2

	)

50 
	#NAMEI_RA_BLOCKS
 4

	)

51 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

53 
buf„r_hód
 *
	$pxt4_≠≥nd
(
h™dÀ_t
 *
h™dÀ
,

54 
öode
 *inode,

55 
pxt4_lblk_t
 *
block
)

57 
buf„r_hód
 *
bh
;

58 
îr
;

60 i‡(
	`u∆ikñy
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
 &&

61 ((
öode
->
i_size
 >> 10) >=

62 
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
)))

63  
	`ERR_PTR
(-
ENOSPC
);

65 *
block
 = 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
;

67 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, *
block
, 
PXT4_GET_BLOCKS_CREATE
);

68 i‡(
	`IS_ERR
(
bh
))

69  
bh
;

70 
öode
->
i_size
 +öode->
i_sb
->
s_blocksize
;

71 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

72 
	`BUFFER_TRACE
(
bh
, "get_write_access");

73 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

74 i‡(
îr
) {

75 
	`bªl£
(
bh
);

76 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

77  
	`ERR_PTR
(
îr
);

79  
bh
;

80 
	}
}

82 
pxt4_dx_csum_vîify
(
öode
 *inode,

83 
pxt4_dú_íåy
 *
dúít
);

96 
	mEITHER
, 
	mINDEX
, 
	mDIRENT
, 
	mDIRENT_HTREE


97 } 
	tdúblock_ty≥_t
;

99 
	#pxt4_ªad_dúblock
(
öode
, 
block
, 
ty≥
) \

100 
	`__pxt4_ªad_dúblock
((
öode
), (
block
), (
ty≥
), 
__func__
, 
__LINE__
)

	)

102 
buf„r_hód
 *
	$__pxt4_ªad_dúblock
(
öode
 *inode,

103 
pxt4_lblk_t
 
block
,

104 
dúblock_ty≥_t
 
ty≥
,

105 c⁄° *
func
,

106 
löe
)

108 
buf„r_hód
 *
bh
;

109 
pxt4_dú_íåy
 *
dúít
;

110 
is_dx_block
 = 0;

112 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
block
, 0);

113 i‡(
	`IS_ERR
(
bh
)) {

114 
	`__pxt4_w¨nög
(
öode
->
i_sb
, 
func
, 
löe
,

117 
öode
->
i_öo
, ()
block
,

118 
cuºít
->
comm
, 
	`PTR_ERR
(
bh
));

120  
bh
;

122 i‡(!
bh
 && (
ty≥
 =
INDEX
 ||Åy≥ =
DIRENT_HTREE
)) {

123 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

125 (
ty≥
 =
INDEX
) ? "index" : "leaf");

126  
	`ERR_PTR
(-
EFSCORRUPTED
);

128 i‡(!
bh
)

129  
NULL
;

130 
dúít
 = (
pxt4_dú_íåy
 *Ë
bh
->
b_d©a
;

132 i‡(
	`is_dx
(
öode
)) {

133 i‡(
block
 == 0)

134 
is_dx_block
 = 1;

135 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
dúít
->
ªc_Àn
,

136 
öode
->
i_sb
->
s_blocksize
) ==

137 
öode
->
i_sb
->
s_blocksize
)

138 
is_dx_block
 = 1;

140 i‡(!
is_dx_block
 && 
ty≥
 =
INDEX
) {

141 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

143 
	`bªl£
(
bh
);

144  
	`ERR_PTR
(-
EFSCORRUPTED
);

146 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
) ||

147 
	`buf„r_vîifõd
(
bh
))

148  
bh
;

155 i‡(
is_dx_block
 && 
ty≥
 =
INDEX
) {

156 i‡(
	`pxt4_dx_csum_vîify
(
öode
, 
dúít
))

157 
	`£t_buf„r_vîifõd
(
bh
);

159 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

161 
	`bªl£
(
bh
);

162  
	`ERR_PTR
(-
EFSBADCRC
);

165 i‡(!
is_dx_block
) {

166 i‡(
	`pxt4_dúblock_csum_vîify
(
öode
, 
bh
))

167 
	`£t_buf„r_vîifõd
(
bh
);

169 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

171 
	`bªl£
(
bh
);

172  
	`ERR_PTR
(-
EFSBADCRC
);

175  
bh
;

176 
	}
}

178 #i‚de‡
as£π


179 
	#as£π
(
ã°
Ë
	`J_ASSERT
—e°)

	)

182 #ifde‡
DX_DEBUG


183 
	#dxåa˚
(
comm™d
Ë
	)
command

185 
	#dxåa˚
(
comm™d
)

	)

188 
	sÁke_dúít


190 
__À32
 
	möode
;

191 
__À16
 
	mªc_Àn
;

192 
u8
 
	m«me_Àn
;

193 
u8
 
	mfûe_ty≥
;

196 
	sdx_cou¡limô


198 
__À16
 
	mlimô
;

199 
__À16
 
	mcou¡
;

202 
	sdx_íåy


204 
__À32
 
	mhash
;

205 
__À32
 
	mblock
;

214 
	sdx_roŸ


216 
Áke_dúít
 
	mdŸ
;

217 
	mdŸ_«me
[4];

218 
Áke_dúít
 
	mdŸdŸ
;

219 
	mdŸdŸ_«me
[4];

220 
	sdx_roŸ_öfo


222 
__À32
 
	mª£rved_zîo
;

223 
u8
 
	mhash_vîsi⁄
;

224 
u8
 
	möfo_Àngth
;

225 
u8
 
	mödúe˘_Àvñs
;

226 
u8
 
	munu£d_Êags
;

228 
	möfo
;

229 
dx_íåy
 
	míåõs
[0];

232 
	sdx_node


234 
Áke_dúít
 
	mÁke
;

235 
dx_íåy
 
	míåõs
[0];

239 
	sdx_‰ame


241 
buf„r_hód
 *
	mbh
;

242 
dx_íåy
 *
	míåõs
;

243 
dx_íåy
 *
	m©
;

246 
	sdx_m≠_íåy


248 
u32
 
	mhash
;

249 
u16
 
	moffs
;

250 
u16
 
	msize
;

256 
	sdx_èû
 {

257 
u32
 
	mdt_ª£rved
;

258 
__À32
 
	mdt_checksum
;

261 
ölöe
 
pxt4_lblk_t
 
dx_gë_block
(
dx_íåy
 *
íåy
);

262 
dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
);

263 
ölöe
 
dx_gë_hash
(
dx_íåy
 *
íåy
);

264 
dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
);

265 
dx_gë_cou¡
(
dx_íåy
 *
íåõs
);

266 
dx_gë_limô
(
dx_íåy
 *
íåõs
);

267 
dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
);

268 
dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
);

269 
dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
);

270 
dx_node_limô
(
öode
 *
dú
);

271 
dx_‰ame
 *
dx_¥obe
(
pxt4_fûíame
 *
‚ame
,

272 
öode
 *
dú
,

273 
dx_hash_öfo
 *
höfo
,

274 
dx_‰ame
 *
‰ame
);

275 
dx_ªÀa£
(
dx_‰ame
 *
‰ames
);

276 
dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

277 
blocksize
, 
dx_hash_öfo
 *
höfo
,

278 
dx_m≠_íåy
 
m≠
[]);

279 
dx_s‹t_m≠
(
dx_m≠_íåy
 *
m≠
, 
cou¡
);

280 
pxt4_dú_íåy_2
 *
dx_move_dúíts
(*
‰om
, *
to
,

281 
dx_m≠_íåy
 *
off£ts
, 
cou¡
, 
blocksize
);

282 
pxt4_dú_íåy_2
* 
dx_∑ck_dúíts
(*
ba£
, 
blocksize
);

283 
dx_ö£π_block
(
dx_‰ame
 *
‰ame
,

284 
u32
 
hash
, 
pxt4_lblk_t
 
block
);

285 
pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

286 
dx_‰ame
 *
‰ame
,

287 
dx_‰ame
 *
‰ames
,

288 
__u32
 *
°¨t_hash
);

289 
buf„r_hód
 * 
pxt4_dx_föd_íåy
(
öode
 *
dú
,

290 
pxt4_fûíame
 *
‚ame
,

291 
pxt4_dú_íåy_2
 **
ªs_dú
);

292 
pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

293 
öode
 *
dú
, inode *inode);

296 
	$pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

297 
blocksize
)

299 
pxt4_dú_íåy_èû
 *
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

301 
	`mem£t
(
t
, 0, (
pxt4_dú_íåy_èû
));

302 
t
->
dë_ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

303 (
pxt4_dú_íåy_èû
), 
blocksize
);

304 
t
->
dë_ª£rved_·
 = 
PXT4_FT_DIR_CSUM
;

305 
	}
}

308 
pxt4_dú_íåy_èû
 *
	$gë_dúít_èû
(
öode
 *inode,

309 
buf„r_hód
 *
bh
)

311 
pxt4_dú_íåy_èû
 *
t
;

313 #ifde‡
PARANOID


314 
pxt4_dú_íåy
 *
d
, *
t›
;

316 
d
 = (
pxt4_dú_íåy
 *)
bh
->
b_d©a
;

317 
t›
 = (
pxt4_dú_íåy
 *)(
bh
->
b_d©a
 +

318 (
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) -

319 (
pxt4_dú_íåy_èû
)));

320 
d
 < 
t›
 && d->
ªc_Àn
)

321 
d
 = (
pxt4_dú_íåy
 *)(((*)d) +

322 
	`À16_to_˝u
(
d
->
ªc_Àn
));

324 i‡(
d
 !
t›
)

325  
NULL
;

327 
t
 = (
pxt4_dú_íåy_èû
 *)
d
;

329 
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
));

332 i‡(
t
->
dë_ª£rved_zîo1
 ||

333 
	`À16_to_˝u
(
t
->
dë_ªc_Àn
Ë!(
pxt4_dú_íåy_èû
) ||

334 
t
->
dë_ª£rved_zîo2
 ||

335 
t
->
dë_ª£rved_·
 !
PXT4_FT_DIR_CSUM
)

336  
NULL
;

338  
t
;

339 
	}
}

341 
__À32
 
	$pxt4_dúblock_csum
(
öode
 *öode, *
dúít
, 
size
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

344 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

345 
__u32
 
csum
;

347 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

348  
	`˝u_to_À32
(
csum
);

349 
	}
}

351 
	#w¨n_no_•a˚_f‹_csum
(
öode
) \

352 
	`__w¨n_no_•a˚_f‹_csum
((
öode
), 
__func__
, 
__LINE__
)

	)

354 
	$__w¨n_no_•a˚_f‹_csum
(
öode
 *öode, c⁄° *
func
,

355 
löe
)

357 
	`__pxt4_w¨nög_öode
(
öode
, 
func
, 
löe
,

359 
	}
}

361 
	$pxt4_dúblock_csum_vîify
(
öode
 *öode, 
buf„r_hód
 *
bh
)

363 
pxt4_dú_íåy_èû
 *
t
;

365 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

368 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

369 i‡(!
t
) {

370 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

374 i‡(
t
->
dë_checksum
 !
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

375 (*)
t
 - 
bh
->
b_d©a
))

379 
	}
}

381 
	$pxt4_dúblock_csum_£t
(
öode
 *inode,

382 
buf„r_hód
 *
bh
)

384 
pxt4_dú_íåy_èû
 *
t
;

386 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

389 
t
 = 
	`gë_dúít_èû
(
öode
, 
bh
);

390 i‡(!
t
) {

391 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

395 
t
->
dë_checksum
 = 
	`pxt4_dúblock_csum
(
öode
, 
bh
->
b_d©a
,

396 (*)
t
 - 
bh
->
b_d©a
);

397 
	}
}

399 
	$pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
,

400 
öode
 *inode,

401 
buf„r_hód
 *
bh
)

403 
	`pxt4_dúblock_csum_£t
(
öode
, 
bh
);

404  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

405 
	}
}

407 
dx_cou¡limô
 *
	$gë_dx_cou¡limô
(
öode
 *inode,

408 
pxt4_dú_íåy
 *
dúít
,

409 *
off£t
)

411 
pxt4_dú_íåy
 *
dp
;

412 
dx_roŸ_öfo
 *
roŸ
;

413 
cou¡_off£t
;

415 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
Ë=
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
))

416 
cou¡_off£t
 = 8;

417 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
) == 12) {

418 
dp
 = (
pxt4_dú_íåy
 *)(((*)
dúít
) + 12);

419 i‡(
	`À16_to_˝u
(
dp
->
ªc_Àn
) !=

420 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) - 12)

421  
NULL
;

422 
roŸ
 = (
dx_roŸ_öfo
 *)(((*)
dp
 + 12));

423 i‡(
roŸ
->
ª£rved_zîo
 ||

424 
roŸ
->
öfo_Àngth
 !(
dx_roŸ_öfo
))

425  
NULL
;

426 
cou¡_off£t
 = 32;

428  
NULL
;

430 i‡(
off£t
)

431 *
off£t
 = 
cou¡_off£t
;

432  (
dx_cou¡limô
 *)(((*)
dúít
Ë+ 
cou¡_off£t
);

433 
	}
}

435 
__À32
 
	$pxt4_dx_csum
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
,

436 
cou¡_off£t
, 
cou¡
, 
dx_èû
 *
t
)

438 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

439 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

440 
__u32
 
csum
;

441 
size
;

442 
__u32
 
dummy_csum
 = 0;

443 
off£t
 = 
	`off£tof
(
dx_èû
, 
dt_checksum
);

445 
size
 = 
cou¡_off£t
 + (
cou¡
 * (
dx_íåy
));

446 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

447 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

448 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

450  
	`˝u_to_À32
(
csum
);

451 
	}
}

453 
	$pxt4_dx_csum_vîify
(
öode
 *inode,

454 
pxt4_dú_íåy
 *
dúít
)

456 
dx_cou¡limô
 *
c
;

457 
dx_èû
 *
t
;

458 
cou¡_off£t
, 
limô
, 
cou¡
;

460 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

463 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

464 i‡(!
c
) {

465 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

468 
limô
 = 
	`À16_to_˝u
(
c
->limit);

469 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

470 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

471 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

472 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

475 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

477 i‡(
t
->
dt_checksum
 !
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
,

478 
cou¡
, 
t
))

481 
	}
}

483 
	$pxt4_dx_csum_£t
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

485 
dx_cou¡limô
 *
c
;

486 
dx_èû
 *
t
;

487 
cou¡_off£t
, 
limô
, 
cou¡
;

489 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

492 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

493 i‡(!
c
) {

494 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

497 
limô
 = 
	`À16_to_˝u
(
c
->limit);

498 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

499 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

500 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

501 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

504 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

506 
t
->
dt_checksum
 = 
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
, 
cou¡
,Å);

507 
	}
}

509 
ölöe
 
	$pxt4_h™dÀ_dúty_dx_node
(
h™dÀ_t
 *
h™dÀ
,

510 
öode
 *inode,

511 
buf„r_hód
 *
bh
)

513 
	`pxt4_dx_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

514  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

515 
	}
}

520 
ölöe
 
pxt4_dú_íåy_2
 *

521 
	$pxt4_√xt_íåy
(
pxt4_dú_íåy_2
 *
p
, 
blocksize
)

523  (
pxt4_dú_íåy_2
 *)((*)
p
 +

524 
	`pxt4_ªc_Àn_‰om_disk
(
p
->
ªc_Àn
, 
blocksize
));

525 
	}
}

532 
ölöe
 
pxt4_lblk_t
 
	$dx_gë_block
(
dx_íåy
 *
íåy
)

534  
	`À32_to_˝u
(
íåy
->
block
) & 0x0fffffff;

535 
	}
}

537 
ölöe
 
	$dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
)

539 
íåy
->
block
 = 
	`˝u_to_À32
(
vÆue
);

540 
	}
}

542 
ölöe
 
	$dx_gë_hash
(
dx_íåy
 *
íåy
)

544  
	`À32_to_˝u
(
íåy
->
hash
);

545 
	}
}

547 
ölöe
 
	$dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
)

549 
íåy
->
hash
 = 
	`˝u_to_À32
(
vÆue
);

550 
	}
}

552 
ölöe
 
	$dx_gë_cou¡
(
dx_íåy
 *
íåõs
)

554  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
);

555 
	}
}

557 
ölöe
 
	$dx_gë_limô
(
dx_íåy
 *
íåõs
)

559  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
limô
);

560 
	}
}

562 
ölöe
 
	$dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
)

564 ((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
 = 
	`˝u_to_À16
(
vÆue
);

565 
	}
}

567 
ölöe
 
	$dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
)

569 ((
dx_cou¡limô
 *Ë
íåõs
)->
limô
 = 
	`˝u_to_À16
(
vÆue
);

570 
	}
}

572 
ölöe
 
	$dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
)

574 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(1) -

575 
	`PXT4_DIR_REC_LEN
(2Ë- 
öfosize
;

577 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

578 
íåy_•a˚
 -(
dx_èû
);

579  
íåy_•a˚
 / (
dx_íåy
);

580 
	}
}

582 
ölöe
 
	$dx_node_limô
(
öode
 *
dú
)

584 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(0);

586 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

587 
íåy_•a˚
 -(
dx_èû
);

588  
íåy_•a˚
 / (
dx_íåy
);

589 
	}
}

594 #ifde‡
DX_DEBUG


595 
	$dx_show_ödex
(* 
œbñ
, 
dx_íåy
 *
íåõs
)

597 
i
, 
n
 = 
	`dx_gë_cou¡
 (
íåõs
);

598 
	`¥ötk
(
KERN_DEBUG
 "%†ödex", 
œbñ
);

599 
i
 = 0; i < 
n
; i++) {

600 
	`¥ötk
(
KERN_CONT
 " %x->%lu",

601 
i
 ? 
	`dx_gë_hash
(
íåõs
 + i) : 0,

602 ()
	`dx_gë_block
(
íåõs
 + 
i
));

604 
	`¥ötk
(
KERN_CONT
 "\n");

605 
	}
}

607 
	s°©s


609 
	m«mes
;

610 
	m•a˚
;

611 
	mbcou¡
;

614 
°©s
 
	$dx_show_Àaf
(
öode
 *
dú
,

615 
dx_hash_öfo
 *
höfo
,

616 
pxt4_dú_íåy_2
 *
de
,

617 
size
, 
show_«mes
)

619 
«mes
 = 0, 
•a˚
 = 0;

620 *
ba£
 = (*Ë
de
;

621 
dx_hash_öfo
 
h
 = *
höfo
;

623 
	`¥ötk
("names: ");

624 (*Ë
de
 < 
ba£
 + 
size
)

626 i‡(
de
->
öode
)

628 i‡(
show_«mes
)

630 #ifde‡
CONFIG_FS_ENCRYPTION


631 
Àn
;

632 *
«me
;

633 
fs¸y±_°r
 
‚ame_¸y±o_°r
 =

634 
	`FSTR_INIT
(
NULL
, 0);

635 
ªs
 = 0;

637 
«me
 = 
de
->name;

638 
Àn
 = 
de
->
«me_Àn
;

639 i‡(
	`IS_ENCRYPTED
(
dú
))

640 
ªs
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

641 i‡(
ªs
) {

642 
	`¥ötk
(
KERN_WARNING
 "Error setting up"

643 " f«mê¸y±o: %d\n", 
ªs
);

645 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
)) {

647 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

648 
de
->
«me_Àn
, &
h
);

649 
	`¥ötk
("%*.s:(U)%x.%u ", 
Àn
,

650 
«me
, 
h
.
hash
,

651 (Ë((*Ë
de


652 - 
ba£
));

654 
fs¸y±_°r
 
de_«me
 =

655 
	`FSTR_INIT
(
«me
, 
Àn
);

658 
ªs
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(

659 
dú
, 
Àn
,

660 &
‚ame_¸y±o_°r
);

661 i‡(
ªs
)

662 
	`¥ötk
(
KERN_WARNING
 "Error "

666 
ªs
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
,

667 0, 0, &
de_«me
,

668 &
‚ame_¸y±o_°r
);

669 i‡(
ªs
) {

670 
	`¥ötk
(
KERN_WARNING
 "Error "

674 
«me
 = "??";

675 
Àn
 = 2;

677 
«me
 = 
‚ame_¸y±o_°r
.name;

678 
Àn
 = 
‚ame_¸y±o_°r
.len;

680 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
,

681 
de
->
«me_Àn
, &
h
);

682 
	`¥ötk
("%*.s:(E)%x.%u ", 
Àn
, 
«me
,

683 
h
.
hash
, (Ë((*Ë
de


684 - 
ba£
));

685 
	`fs¸y±_‚ame_‰ì_buf„r
(

686 &
‚ame_¸y±o_°r
);

689 
Àn
 = 
de
->
«me_Àn
;

690 *
«me
 = 
de
->name;

691 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

692 
	`¥ötk
("%*.s:%x.%u ", 
Àn
, 
«me
, 
h
.
hash
,

693 (Ë((*Ë
de
 - 
ba£
));

696 
•a˚
 +
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

697 
«mes
++;

699 
de
 = 
	`pxt4_√xt_íåy
(de, 
size
);

701 
	`¥ötk
(
KERN_CONT
 "(%i)\n", 
«mes
);

702  (
°©s
Ë{ 
«mes
, 
•a˚
, 1 };

703 
	}
}

705 
°©s
 
	$dx_show_íåõs
(
dx_hash_öfo
 *
höfo
, 
öode
 *
dú
,

706 
dx_íåy
 *
íåõs
, 
Àvñs
)

708 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

709 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
), 
«mes
 = 0, 
•a˚
 = 0, 
i
;

710 
bcou¡
 = 0;

711 
buf„r_hód
 *
bh
;

712 
	`¥ötk
("%òödexed blocks...\n", 
cou¡
);

713 
i
 = 0; i < 
cou¡
; i++, 
íåõs
++)

715 
pxt4_lblk_t
 
block
 = 
	`dx_gë_block
(
íåõs
);

716 
pxt4_lblk_t
 
hash
 = 
i
 ? 
	`dx_gë_hash
(
íåõs
): 0;

717 
u32
 
ønge
 = 
i
 < 
cou¡
 - 1? (
	`dx_gë_hash
(
íåõs
 + 1Ë- 
hash
): ~hash;

718 
°©s
 stats;

719 
	`¥ötk
("%s%3u:%03u hash %8x/%8x ",
Àvñs
?"":" ", 
i
, 
block
, 
hash
, 
ønge
);

720 
bh
 = 
	`pxt4_bªad
(
NULL
,
dú
, 
block
, 0);

721 i‡(!
bh
 || 
	`IS_ERR
(bh))

723 
°©s
 = 
Àvñs
?

724 
	`dx_show_íåõs
(
höfo
, 
dú
, ((
dx_node
 *Ë
bh
->
b_d©a
)->
íåõs
, 
Àvñs
 - 1):

725 
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *)

726 
bh
->
b_d©a
, 
blocksize
, 0);

727 
«mes
 +
°©s
.names;

728 
•a˚
 +
°©s
.space;

729 
bcou¡
 +
°©s
.bcount;

730 
	`bªl£
(
bh
);

732 i‡(
bcou¡
)

733 
	`¥ötk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

734 
Àvñs
 ? "" : " ", 
«mes
, 
•a˚
/
bcou¡
,

735 (
•a˚
/
bcou¡
)*100/
blocksize
);

736  (
°©s
Ë{ 
«mes
, 
•a˚
, 
bcou¡
};

737 
	}
}

749 
dx_‰ame
 *

750 
	$dx_¥obe
(
pxt4_fûíame
 *
‚ame
, 
öode
 *
dú
,

751 
dx_hash_öfo
 *
höfo
, 
dx_‰ame
 *
‰ame_ö
)

753 
cou¡
, 
ödúe˘
;

754 
dx_íåy
 *
©
, *
íåõs
, *
p
, *
q
, *
m
;

755 
dx_roŸ
 *
roŸ
;

756 
dx_‰ame
 *
‰ame
 = 
‰ame_ö
;

757 
dx_‰ame
 *
ªt_îr
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

758 
u32
 
hash
;

760 
	`mem£t
(
‰ame_ö
, 0, 
PXT4_HTREE_LEVEL
 * (frame_in[0]));

761 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 0, 
INDEX
);

762 i‡(
	`IS_ERR
(
‰ame
->
bh
))

763  (
dx_‰ame
 *Ë
‰ame
->
bh
;

765 
roŸ
 = (
dx_roŸ
 *Ë
‰ame
->
bh
->
b_d©a
;

766 i‡(
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_TEA
 &&

767 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_HALF_MD4
 &&

768 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_LEGACY
) {

769 
	`pxt4_w¨nög_öode
(
dú
, "Unrecognised inode hash code %u",

770 
roŸ
->
öfo
.
hash_vîsi⁄
);

771 
Áû
;

773 i‡(
‚ame
)

774 
höfo
 = &
‚ame
->hinfo;

775 
höfo
->
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

776 i‡(
höfo
->
hash_vîsi⁄
 <
DX_HASH_TEA
)

777 
höfo
->
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

778 
höfo
->
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

779 i‡(
‚ame
 && 
	`‚ame_«me
(fname))

780 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), 
höfo
);

781 
hash
 = 
höfo
->hash;

783 i‡(
roŸ
->
öfo
.
unu£d_Êags
 & 1) {

784 
	`pxt4_w¨nög_öode
(
dú
, "Unimplemented hash flags: %#06x",

785 
roŸ
->
öfo
.
unu£d_Êags
);

786 
Áû
;

789 
ödúe˘
 = 
roŸ
->
öfo
.
ödúe˘_Àvñs
;

790 i‡(
ödúe˘
 >
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
)) {

791 
	`pxt4_w¨nög
(
dú
->
i_sb
,

793 "suµ‹ãd vÆue", 
dú
->
i_öo
,

794 
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
));

795 i‡(
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
Ë< 
PXT4_HTREE_LEVEL
) {

796 
	`pxt4_w¨nög
(
dú
->
i_sb
, "EnableÜarge directory "

799 
Áû
;

802 
íåõs
 = (
dx_íåy
 *)(((*)&
roŸ
->
öfo
) +

803 
roŸ
->
öfo
.
öfo_Àngth
);

805 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_roŸ_limô
(
dú
,

806 
roŸ
->
öfo
.
öfo_Àngth
)) {

807 
	`pxt4_w¨nög_öode
(
dú
, "dxÉntry:Üimit %u !=ÑootÜimit %u",

808 
	`dx_gë_limô
(
íåõs
),

809 
	`dx_roŸ_limô
(
dú
, 
roŸ
->
öfo
.
öfo_Àngth
));

810 
Áû
;

813 
	`dxåa˚
(
	`¥ötk
("Look u∞%x", 
hash
));

815 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

816 i‡(!
cou¡
 || cou¡ > 
	`dx_gë_limô
(
íåõs
)) {

817 
	`pxt4_w¨nög_öode
(
dú
,

819 
cou¡
, 
	`dx_gë_limô
(
íåõs
));

820 
Áû
;

823 
p
 = 
íåõs
 + 1;

824 
q
 = 
íåõs
 + 
cou¡
 - 1;

825 
p
 <
q
) {

826 
m
 = 
p
 + (
q
 -Ö) / 2;

827 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 "."));

828 i‡(
	`dx_gë_hash
(
m
Ë> 
hash
)

829 
q
 = 
m
 - 1;

831 
p
 = 
m
 + 1;

835 
n
 = 
cou¡
 - 1;

836 
©
 = 
íåõs
;

837 
n
--)

839 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 ","));

840 i‡(
	`dx_gë_hash
(++
©
Ë> 
hash
)

842 
©
--;

846 
	`as£π
 (
©
 =
p
 - 1);

849 
©
 = 
p
 - 1;

850 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 " %x->%u\n",

851 
©
 =
íåõs
 ? 0 : 
	`dx_gë_hash
(at),

852 
	`dx_gë_block
(
©
)));

853 
‰ame
->
íåõs
 =Éntries;

854 
‰ame
->
©
 =át;

855 i‡(!
ödúe˘
--)

856  
‰ame
;

857 
‰ame
++;

858 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
©
), 
INDEX
);

859 i‡(
	`IS_ERR
(
‰ame
->
bh
)) {

860 
ªt_îr
 = (
dx_‰ame
 *Ë
‰ame
->
bh
;

861 
‰ame
->
bh
 = 
NULL
;

862 
Áû
;

864 
íåõs
 = ((
dx_node
 *Ë
‰ame
->
bh
->
b_d©a
)->entries;

866 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_node_limô
(
dú
)) {

867 
	`pxt4_w¨nög_öode
(
dú
,

869 
	`dx_gë_limô
(
íåõs
), 
	`dx_node_limô
(
dú
));

870 
Áû
;

873 
Áû
:

874 
‰ame
 >
‰ame_ö
) {

875 
	`bªl£
(
‰ame
->
bh
);

876 
‰ame
--;

879 i‡(
ªt_îr
 =
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

880 
	`pxt4_w¨nög_öode
(
dú
,

882  
ªt_îr
;

883 
	}
}

885 
	$dx_ªÀa£
(
dx_‰ame
 *
‰ames
)

887 
dx_roŸ_öfo
 *
öfo
;

888 
i
;

889 
ödúe˘_Àvñs
;

891 i‡(
‰ames
[0].
bh
 =
NULL
)

894 
öfo
 = &((
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
)->info;

896 
ödúe˘_Àvñs
 = 
öfo
->indirect_levels;

897 
i
 = 0; i <
ödúe˘_Àvñs
; i++) {

898 i‡(
‰ames
[
i
].
bh
 =
NULL
)

900 
	`bªl£
(
‰ames
[
i
].
bh
);

901 
‰ames
[
i
].
bh
 = 
NULL
;

903 
	}
}

922 
	$pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

923 
dx_‰ame
 *
‰ame
,

924 
dx_‰ame
 *
‰ames
,

925 
__u32
 *
°¨t_hash
)

927 
dx_‰ame
 *
p
;

928 
buf„r_hód
 *
bh
;

929 
num_‰ames
 = 0;

930 
__u32
 
bhash
;

932 
p
 = 
‰ame
;

941 i‡(++(
p
->
©
Ë<Ö->
íåõs
 + 
	`dx_gë_cou¡
(p->entries))

943 i‡(
p
 =
‰ames
)

945 
num_‰ames
++;

946 
p
--;

956 
bhash
 = 
	`dx_gë_hash
(
p
->
©
);

957 i‡(
°¨t_hash
)

958 *
°¨t_hash
 = 
bhash
;

959 i‡((
hash
 & 1) == 0) {

960 i‡((
bhash
 & ~1Ë!
hash
)

967 
num_‰ames
--) {

968 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
p
->
©
), 
INDEX
);

969 i‡(
	`IS_ERR
(
bh
))

970  
	`PTR_ERR
(
bh
);

971 
p
++;

972 
	`bªl£
(
p
->
bh
);

973 
p
->
bh
 = bh;

974 
p
->
©
 =Ö->
íåõs
 = ((
dx_node
 *Ë
bh
->
b_d©a
)->entries;

977 
	}
}

985 
	$håì_dúblock_to_åì
(
fûe
 *
dú_fûe
,

986 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

987 
dx_hash_öfo
 *
höfo
,

988 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
)

990 
buf„r_hód
 *
bh
;

991 
pxt4_dú_íåy_2
 *
de
, *
t›
;

992 
îr
 = 0, 
cou¡
 = 0;

993 
fs¸y±_°r
 
‚ame_¸y±o_°r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_°r
;

995 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

996 ()
block
));

997 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

998 i‡(
	`IS_ERR
(
bh
))

999  
	`PTR_ERR
(
bh
);

1001 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

1002 
t›
 = (
pxt4_dú_íåy_2
 *Ë((*Ë
de
 +

1003 
dú
->
i_sb
->
s_blocksize
 -

1004 
	`PXT4_DIR_REC_LEN
(0));

1005 #ifde‡
CONFIG_FS_ENCRYPTION


1007 i‡(
	`IS_ENCRYPTED
(
dú
)) {

1008 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

1009 i‡(
îr
 < 0) {

1010 
	`bªl£
(
bh
);

1011  
îr
;

1013 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
dú
, 
PXT4_NAME_LEN
,

1014 &
‚ame_¸y±o_°r
);

1015 i‡(
îr
 < 0) {

1016 
	`bªl£
(
bh
);

1017  
îr
;

1021 ; 
de
 < 
t›
; dê
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
)) {

1022 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1023 
bh
->
b_d©a
, bh->
b_size
,

1024 (
block
<<
	`PXT4_BLOCK_SIZE_BITS
(
dú
->
i_sb
))

1025 + ((*)
de
 - 
bh
->
b_d©a
))) {

1029 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, 
höfo
);

1030 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1031 ((
höfo
->
hash
 =
°¨t_hash
) &&

1032 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1034 i‡(
de
->
öode
 == 0)

1036 i‡(!
	`IS_ENCRYPTED
(
dú
)) {

1037 
tmp_°r
.
«me
 = 
de
->name;

1038 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1039 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1040 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1041 &
tmp_°r
);

1043 
ßve_Àn
 = 
‚ame_¸y±o_°r
.
Àn
;

1044 
fs¸y±_°r
 
de_«me
 = 
	`FSTR_INIT
(
de
->
«me
,

1045 
de
->
«me_Àn
);

1048 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
, 
höfo
->
hash
,

1049 
höfo
->
mö‹_hash
, &
de_«me
,

1050 &
‚ame_¸y±o_°r
);

1051 i‡(
îr
) {

1052 
cou¡
 = 
îr
;

1053 
îrout
;

1055 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1056 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1057 &
‚ame_¸y±o_°r
);

1058 
‚ame_¸y±o_°r
.
Àn
 = 
ßve_Àn
;

1060 i‡(
îr
 != 0) {

1061 
cou¡
 = 
îr
;

1062 
îrout
;

1064 
cou¡
++;

1066 
îrout
:

1067 
	`bªl£
(
bh
);

1068 #ifde‡
CONFIG_FS_ENCRYPTION


1069 
	`fs¸y±_‚ame_‰ì_buf„r
(&
‚ame_¸y±o_°r
);

1071  
cou¡
;

1072 
	}
}

1083 
	$pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

1084 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
)

1086 
dx_hash_öfo
 
höfo
;

1087 
pxt4_dú_íåy_2
 *
de
;

1088 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1089 
öode
 *
dú
;

1090 
pxt4_lblk_t
 
block
;

1091 
cou¡
 = 0;

1092 
ªt
, 
îr
;

1093 
__u32
 
hashvÆ
;

1094 
fs¸y±_°r
 
tmp_°r
;

1096 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1097 
°¨t_hash
, 
°¨t_mö‹_hash
));

1098 
dú
 = 
	`fûe_öode
(
dú_fûe
);

1099 i‡(!(
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
))) {

1100 
höfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1101 i‡(
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1102 
höfo
.
hash_vîsi⁄
 +=

1103 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1104 
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1105 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1106 
has_ölöe_d©a
 = 1;

1107 
cou¡
 = 
	`pxt4_ölöedú_to_åì
(
dú_fûe
, 
dú
, 0,

1108 &
höfo
, 
°¨t_hash
,

1109 
°¨t_mö‹_hash
,

1110 &
has_ölöe_d©a
);

1111 i‡(
has_ölöe_d©a
) {

1112 *
√xt_hash
 = ~0;

1113  
cou¡
;

1116 
cou¡
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 0, &
höfo
,

1117 
°¨t_hash
, 
°¨t_mö‹_hash
);

1118 *
√xt_hash
 = ~0;

1119  
cou¡
;

1121 
höfo
.
hash
 = 
°¨t_hash
;

1122 
höfo
.
mö‹_hash
 = 0;

1123 
‰ame
 = 
	`dx_¥obe
(
NULL
, 
dú
, &
höfo
, 
‰ames
);

1124 i‡(
	`IS_ERR
(
‰ame
))

1125  
	`PTR_ERR
(
‰ame
);

1128 i‡(!
°¨t_hash
 && !
°¨t_mö‹_hash
) {

1129 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1130 
tmp_°r
.
«me
 = 
de
->name;

1131 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1132 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 0, 0,

1133 
de
, &
tmp_°r
);

1134 i‡(
îr
 != 0)

1135 
îrout
;

1136 
cou¡
++;

1138 i‡(
°¨t_hash
 < 2 || (°¨t_hash ==2 && 
°¨t_mö‹_hash
==0)) {

1139 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1140 
de
 = 
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
);

1141 
tmp_°r
.
«me
 = 
de
->name;

1142 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1143 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 2, 0,

1144 
de
, &
tmp_°r
);

1145 i‡(
îr
 != 0)

1146 
îrout
;

1147 
cou¡
++;

1151 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1152 
îr
 = -
ERESTARTSYS
;

1153 
îrout
;

1155 
	`c⁄d_ªsched
();

1156 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1157 
ªt
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 
block
, &
höfo
,

1158 
°¨t_hash
, 
°¨t_mö‹_hash
);

1159 i‡(
ªt
 < 0) {

1160 
îr
 = 
ªt
;

1161 
îrout
;

1163 
cou¡
 +
ªt
;

1164 
hashvÆ
 = ~0;

1165 
ªt
 = 
	`pxt4_håì_√xt_block
(
dú
, 
HASH_NB_ALWAYS
,

1166 
‰ame
, 
‰ames
, &
hashvÆ
);

1167 *
√xt_hash
 = 
hashvÆ
;

1168 i‡(
ªt
 < 0) {

1169 
îr
 = 
ªt
;

1170 
îrout
;

1177 i‡((
ªt
 == 0) ||

1178 (
cou¡
 && ((
hashvÆ
 & 1) == 0)))

1181 
	`dx_ªÀa£
(
‰ames
);

1182 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "FillÅree:Ñeturned %dÉntries, "

1183 "√xàhash: %x\n", 
cou¡
, *
√xt_hash
));

1184  
cou¡
;

1185 
îrout
:

1186 
	`dx_ªÀa£
(
‰ames
);

1187  (
îr
);

1188 
	}
}

1190 
ölöe
 
	$£¨ch_dúblock
(
buf„r_hód
 *
bh
,

1191 
öode
 *
dú
,

1192 
pxt4_fûíame
 *
‚ame
,

1193 
off£t
,

1194 
pxt4_dú_íåy_2
 **
ªs_dú
)

1196  
	`pxt4_£¨ch_dú
(
bh
, bh->
b_d©a
, 
dú
->
i_sb
->
s_blocksize
, dir,

1197 
‚ame
, 
off£t
, 
ªs_dú
);

1198 
	}
}

1208 
	$dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

1209 
blocksize
, 
dx_hash_öfo
 *
höfo
,

1210 
dx_m≠_íåy
 *
m≠_èû
)

1212 
cou¡
 = 0;

1213 *
ba£
 = (*Ë
de
;

1214 
dx_hash_öfo
 
h
 = *
höfo
;

1216 (*Ë
de
 < 
ba£
 + 
blocksize
) {

1217 i‡(
de
->
«me_Àn
 && de->
öode
) {

1218 
	`pxt4fs_dúhash
(
dú
, 
de
->
«me
, de->
«me_Àn
, &
h
);

1219 
m≠_èû
--;

1220 
m≠_èû
->
hash
 = 
h
.hash;

1221 
m≠_èû
->
offs
 = ((*Ë
de
 - 
ba£
)>>2;

1222 
m≠_èû
->
size
 = 
	`À16_to_˝u
(
de
->
ªc_Àn
);

1223 
cou¡
++;

1224 
	`c⁄d_ªsched
();

1227 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

1229  
cou¡
;

1230 
	}
}

1233 
	$dx_s‹t_m≠
 (
dx_m≠_íåy
 *
m≠
, 
cou¡
)

1235 
dx_m≠_íåy
 *
p
, *
q
, *
t›
 = 
m≠
 + 
cou¡
 - 1;

1236 
m‹e
;

1238 
cou¡
 > 2) {

1239 
cou¡
 = count*10/13;

1240 i‡(
cou¡
 - 9 < 2)

1241 
cou¡
 = 11;

1242 
p
 = 
t›
, 
q
 =Ö - 
cou¡
; q >
m≠
;Ö--, q--)

1243 i‡(
p
->
hash
 < 
q
->hash)

1244 
	`sw≠
(*
p
, *
q
);

1248 
m‹e
 = 0;

1249 
q
 = 
t›
;

1250 
q
-- > 
m≠
) {

1251 i‡(
q
[1].
hash
 >= q[0].hash)

1253 
	`sw≠
(*(
q
+1), *q);

1254 
m‹e
 = 1;

1256 } 
m‹e
);

1257 
	}
}

1259 
	$dx_ö£π_block
(
dx_‰ame
 *
‰ame
, 
u32
 
hash
, 
pxt4_lblk_t
 
block
)

1261 
dx_íåy
 *
íåõs
 = 
‰ame
->entries;

1262 
dx_íåy
 *
ﬁd
 = 
‰ame
->
©
, *
√w
 = old + 1;

1263 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

1265 
	`as£π
(
cou¡
 < 
	`dx_gë_limô
(
íåõs
));

1266 
	`as£π
(
ﬁd
 < 
íåõs
 + 
cou¡
);

1267 
	`memmove
(
√w
 + 1,Çew, (*)(
íåõs
 + 
cou¡
) - (*)(new));

1268 
	`dx_£t_hash
(
√w
, 
hash
);

1269 
	`dx_£t_block
(
√w
, 
block
);

1270 
	`dx_£t_cou¡
(
íåõs
, 
cou¡
 + 1);

1271 
	}
}

1273 #ifde‡
CONFIG_UNICODE


1282 
	$pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
, c⁄° 
q°r
 *
«me
,

1283 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
)

1285 c⁄° 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
∑ª¡
->
i_sb
);

1286 c⁄° 
unicode_m≠
 *
um
 = 
sbi
->
s_ícodög
;

1287 
ªt
;

1289 i‡(
quick
)

1290 
ªt
 = 
	`utf8_°∫ˇ£cmp_fﬁded
(
um
, 
«me
, 
íåy
);

1292 
ªt
 = 
	`utf8_°∫ˇ£cmp
(
um
, 
«me
, 
íåy
);

1294 i‡(
ªt
 < 0) {

1298 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
))

1299  -
EINVAL
;

1301 i‡(
«me
->
Àn
 !
íåy
->len)

1304  !!
	`memcmp
(
«me
->«me, 
íåy
->«me,Çame->
Àn
);

1307  
ªt
;

1308 
	}
}

1310 
	$pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
, c⁄° 
q°r
 *
öame
,

1311 
fs¸y±_°r
 *
cf_«me
)

1313 
Àn
;

1315 i‡(!
	`IS_CASEFOLDED
(
dú
Ë|| !
	`PXT4_SB
(dú->
i_sb
)->
s_ícodög
) {

1316 
cf_«me
->
«me
 = 
NULL
;

1320 
cf_«me
->
«me
 = 
	`kmÆloc
(
PXT4_NAME_LEN
, 
GFP_NOFS
);

1321 i‡(!
cf_«me
->
«me
)

1324 
Àn
 = 
	`utf8_ˇ£fﬁd
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_ícodög
,

1325 
öame
, 
cf_«me
->
«me
,

1326 
PXT4_NAME_LEN
);

1327 i‡(
Àn
 <= 0) {

1328 
	`k‰ì
(
cf_«me
->
«me
);

1329 
cf_«me
->
«me
 = 
NULL
;

1332 
cf_«me
->
Àn
 = ()Üen;

1334 
	}
}

1342 
ölöe
 
boﬁ
 
	$pxt4_m©ch
(c⁄° 
öode
 *
∑ª¡
,

1343 c⁄° 
pxt4_fûíame
 *
‚ame
,

1344 c⁄° 
pxt4_dú_íåy_2
 *
de
)

1346 
fs¸y±_«me
 
f
;

1347 #ifde‡
CONFIG_UNICODE


1348 c⁄° 
q°r
 
íåy
 = {.
«me
 = 
de
->«me, .
Àn
 = de->
«me_Àn
};

1351 i‡(!
de
->
öode
)

1352  
Ál£
;

1354 
f
.
u§_‚ame
 = 
‚ame
->usr_fname;

1355 
f
.
disk_«me
 = 
‚ame
->disk_name;

1356 #ifde‡
CONFIG_FS_ENCRYPTION


1357 
f
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

1360 #ifde‡
CONFIG_UNICODE


1361 i‡(
	`PXT4_SB
(
∑ª¡
->
i_sb
)->
s_ícodög
 && 
	`IS_CASEFOLDED
(parent)) {

1362 i‡(
‚ame
->
cf_«me
.
«me
) {

1363 
q°r
 
cf
 = {.
«me
 = 
‚ame
->
cf_«me
.name,

1364 .
Àn
 = 
‚ame
->
cf_«me
.len};

1365  !
	`pxt4_ci_com∑ª
(
∑ª¡
, &
cf
, &
íåy
, 
åue
);

1367  !
	`pxt4_ci_com∑ª
(
∑ª¡
, 
‚ame
->
u§_‚ame
, &
íåy
,

1368 
Ál£
);

1372  
	`fs¸y±_m©ch_«me
(&
f
, 
de
->
«me
, de->
«me_Àn
);

1373 
	}
}

1378 
	$pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
, *
£¨ch_buf
, 
buf_size
,

1379 
öode
 *
dú
, 
pxt4_fûíame
 *
‚ame
,

1380 
off£t
, 
pxt4_dú_íåy_2
 **
ªs_dú
)

1382 
pxt4_dú_íåy_2
 * 
de
;

1383 * 
dlimô
;

1384 
de_Àn
;

1386 
de
 = (
pxt4_dú_íåy_2
 *)
£¨ch_buf
;

1387 
dlimô
 = 
£¨ch_buf
 + 
buf_size
;

1388 (*Ë
de
 < 
dlimô
) {

1391 i‡((*Ë
de
 + de->
«me_Àn
 <
dlimô
 &&

1392 
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
)) {

1395 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
,

1396 
bh
->
b_size
, 
off£t
))

1398 *
ªs_dú
 = 
de
;

1402 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1403 
dú
->
i_sb
->
s_blocksize
);

1404 i‡(
de_Àn
 <= 0)

1406 
off£t
 +
de_Àn
;

1407 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1410 
	}
}

1412 
	$is_dx_öã∫Æ_node
(
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1413 
pxt4_dú_íåy
 *
de
)

1415 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1417 i‡(!
	`is_dx
(
dú
))

1419 i‡(
block
 == 0)

1421 i‡(
de
->
öode
 == 0 &&

1422 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) ==

1423 
sb
->
s_blocksize
)

1426 
	}
}

1439 
buf„r_hód
 *
	$__pxt4_föd_íåy
(
öode
 *
dú
,

1440 
pxt4_fûíame
 *
‚ame
,

1441 
pxt4_dú_íåy_2
 **
ªs_dú
,

1442 *
ölöed
)

1444 
su≥r_block
 *
sb
;

1445 
buf„r_hód
 *
bh_u£
[
NAMEI_RA_SIZE
];

1446 
buf„r_hód
 *
bh
, *
ªt
 = 
NULL
;

1447 
pxt4_lblk_t
 
°¨t
, 
block
;

1448 c⁄° 
u8
 *
«me
 = 
‚ame
->
u§_‚ame
->name;

1449 
size_t
 
ø_max
 = 0;

1451 
size_t
 
ø_±r
 = 0;

1453 
pxt4_lblk_t
 
nblocks
;

1454 
i
, 
«mñí
, 
ªtvÆ
;

1456 *
ªs_dú
 = 
NULL
;

1457 
sb
 = 
dú
->
i_sb
;

1458 
«mñí
 = 
‚ame
->
u§_‚ame
->
Àn
;

1459 i‡(
«mñí
 > 
PXT4_NAME_LEN
)

1460  
NULL
;

1462 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1463 
has_ölöe_d©a
 = 1;

1464 
ªt
 = 
	`pxt4_föd_ölöe_íåy
(
dú
, 
‚ame
, 
ªs_dú
,

1465 &
has_ölöe_d©a
);

1466 i‡(
has_ölöe_d©a
) {

1467 i‡(
ölöed
)

1468 *
ölöed
 = 1;

1469 
˛ónup_™d_exô
;

1473 i‡((
«mñí
 <2Ë&& (
«me
[0] == '.') &&

1474 (
«me
[1] == '.' ||Çame[1] == '\0')) {

1479 
block
 = 
°¨t
 = 0;

1480 
nblocks
 = 1;

1481 
ª°¨t
;

1483 i‡(
	`is_dx
(
dú
)) {

1484 
ªt
 = 
	`pxt4_dx_föd_íåy
(
dú
, 
‚ame
, 
ªs_dú
);

1490 i‡(!
	`IS_ERR
(
ªt
Ë|| 
	`PTR_ERR
‘ëË!
ERR_BAD_DX_DIR
)

1491 
˛ónup_™d_exô
;

1492 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "pxt4_find_entry: dx failed, "

1494 
ªt
 = 
NULL
;

1496 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1497 i‡(!
nblocks
) {

1498 
ªt
 = 
NULL
;

1499 
˛ónup_™d_exô
;

1501 
°¨t
 = 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
;

1502 i‡(
°¨t
 >
nblocks
)

1503 
°¨t
 = 0;

1504 
block
 = 
°¨t
;

1505 
ª°¨t
:

1510 
	`c⁄d_ªsched
();

1511 i‡(
ø_±r
 >
ø_max
) {

1513 
ø_±r
 = 0;

1514 i‡(
block
 < 
°¨t
)

1515 
ø_max
 = 
°¨t
 - 
block
;

1517 
ø_max
 = 
nblocks
 - 
block
;

1518 
ø_max
 = 
	`mö
‘a_max, 
	`ARRAY_SIZE
(
bh_u£
));

1519 
ªtvÆ
 = 
	`pxt4_bªad_b©ch
(
dú
, 
block
, 
ø_max
,

1520 
Ál£
 , 
bh_u£
);

1521 i‡(
ªtvÆ
) {

1522 
ªt
 = 
	`ERR_PTR
(
ªtvÆ
);

1523 
ø_max
 = 0;

1524 
˛ónup_™d_exô
;

1527 i‡((
bh
 = 
bh_u£
[
ø_±r
++]Ë=
NULL
)

1528 
√xt
;

1529 
	`waô_⁄_buf„r
(
bh
);

1530 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1531 
	`PXT4_ERROR_INODE
(
dú
, "reading directoryÜblock %lu",

1532 (Ë
block
);

1533 
	`bªl£
(
bh
);

1534 
ªt
 = 
	`ERR_PTR
(-
EIO
);

1535 
˛ónup_™d_exô
;

1537 i‡(!
	`buf„r_vîifõd
(
bh
) &&

1538 !
	`is_dx_öã∫Æ_node
(
dú
, 
block
,

1539 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
) &&

1540 !
	`pxt4_dúblock_csum_vîify
(
dú
, 
bh
)) {

1541 
	`PXT4_ERROR_INODE
(
dú
, "checksumming directory "

1542 "block %lu", ()
block
);

1543 
	`bªl£
(
bh
);

1544 
ªt
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1545 
˛ónup_™d_exô
;

1547 
	`£t_buf„r_vîifõd
(
bh
);

1548 
i
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1549 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
), 
ªs_dú
);

1550 i‡(
i
 == 1) {

1551 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
 = 
block
;

1552 
ªt
 = 
bh
;

1553 
˛ónup_™d_exô
;

1555 
	`bªl£
(
bh
);

1556 i‡(
i
 < 0)

1557 
˛ónup_™d_exô
;

1559 
√xt
:

1560 i‡(++
block
 >
nblocks
)

1561 
block
 = 0;

1562 } 
block
 !
°¨t
);

1568 
block
 = 
nblocks
;

1569 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1570 i‡(
block
 < 
nblocks
) {

1571 
°¨t
 = 0;

1572 
ª°¨t
;

1575 
˛ónup_™d_exô
:

1577 ; 
ø_±r
 < 
ø_max
;Ña_ptr++)

1578 
	`bªl£
(
bh_u£
[
ø_±r
]);

1579  
ªt
;

1580 
	}
}

1582 
buf„r_hód
 *
	$pxt4_föd_íåy
(
öode
 *
dú
,

1583 c⁄° 
q°r
 *
d_«me
,

1584 
pxt4_dú_íåy_2
 **
ªs_dú
,

1585 *
ölöed
)

1587 
îr
;

1588 
pxt4_fûíame
 
‚ame
;

1589 
buf„r_hód
 *
bh
;

1591 
îr
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, 
d_«me
, 1, &
‚ame
);

1592 i‡(
îr
 =-
ENOENT
)

1593  
NULL
;

1594 i‡(
îr
)

1595  
	`ERR_PTR
(
îr
);

1597 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
ölöed
);

1599 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1600  
bh
;

1601 
	}
}

1603 
buf„r_hód
 *
	$pxt4_lookup_íåy
(
öode
 *
dú
,

1604 
díåy
 *dentry,

1605 
pxt4_dú_íåy_2
 **
ªs_dú
)

1607 
îr
;

1608 
pxt4_fûíame
 
‚ame
;

1609 
buf„r_hód
 *
bh
;

1611 
îr
 = 
	`pxt4_‚ame_¥ï¨e_lookup
(
dú
, 
díåy
, &
‚ame
);

1612 i‡(
îr
 =-
ENOENT
)

1613  
NULL
;

1614 i‡(
îr
)

1615  
	`ERR_PTR
(
îr
);

1617 
bh
 = 
	`__pxt4_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
, 
NULL
);

1619 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1620  
bh
;

1621 
	}
}

1623 
buf„r_hód
 * 
	$pxt4_dx_föd_íåy
(
öode
 *
dú
,

1624 
pxt4_fûíame
 *
‚ame
,

1625 
pxt4_dú_íåy_2
 **
ªs_dú
)

1627 
su≥r_block
 * 
sb
 = 
dú
->
i_sb
;

1628 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1629 
buf„r_hód
 *
bh
;

1630 
pxt4_lblk_t
 
block
;

1631 
ªtvÆ
;

1633 #ifde‡
CONFIG_FS_ENCRYPTION


1634 *
ªs_dú
 = 
NULL
;

1636 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

1637 i‡(
	`IS_ERR
(
‰ame
))

1638  (
buf„r_hód
 *Ë
‰ame
;

1640 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1641 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT_HTREE
);

1642 i‡(
	`IS_ERR
(
bh
))

1643 
îrout
;

1645 
ªtvÆ
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1646 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
),

1647 
ªs_dú
);

1648 i‡(
ªtvÆ
 == 1)

1649 
suc˚ss
;

1650 
	`bªl£
(
bh
);

1651 i‡(
ªtvÆ
 == -1) {

1652 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1653 
îrout
;

1657 
ªtvÆ
 = 
	`pxt4_håì_√xt_block
(
dú
, 
‚ame
->
höfo
.
hash
, 
‰ame
,

1658 
‰ames
, 
NULL
);

1659 i‡(
ªtvÆ
 < 0) {

1660 
	`pxt4_w¨nög_öode
(
dú
,

1662 
ªtvÆ
);

1663 
bh
 = 
	`ERR_PTR
(
ªtvÆ
);

1664 
îrout
;

1666 } 
ªtvÆ
 == 1);

1668 
bh
 = 
NULL
;

1669 
îrout
:

1670 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "%†nŸ found\n", 
‚ame
->
u§_‚ame
->
«me
));

1671 
suc˚ss
:

1672 
	`dx_ªÀa£
(
‰ames
);

1673  
bh
;

1674 
	}
}

1676 
díåy
 *
	$pxt4_lookup
(
öode
 *
dú
, 
díåy
 *díåy, 
Êags
)

1678 
öode
 *inode;

1679 
pxt4_dú_íåy_2
 *
de
;

1680 
buf„r_hód
 *
bh
;

1682 i‡(
díåy
->
d_«me
.
Àn
 > 
PXT4_NAME_LEN
)

1683  
	`ERR_PTR
(-
ENAMETOOLONG
);

1685 
bh
 = 
	`pxt4_lookup_íåy
(
dú
, 
díåy
, &
de
);

1686 i‡(
	`IS_ERR
(
bh
))

1687  
	`ERR_CAST
(
bh
);

1688 
öode
 = 
NULL
;

1689 i‡(
bh
) {

1690 
__u32
 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1691 
	`bªl£
(
bh
);

1692 i‡(!
	`pxt4_vÆid_öum
(
dú
->
i_sb
, 
öo
)) {

1693 
	`PXT4_ERROR_INODE
(
dú
, "bad inodênumbî: %u", 
öo
);

1694  
	`ERR_PTR
(-
EFSCORRUPTED
);

1696 i‡(
	`u∆ikñy
(
öo
 =
dú
->
i_öo
)) {

1697 
	`PXT4_ERROR_INODE
(
dú
, "'%pd'ÜinkedÅoÖarent dir",

1698 
díåy
);

1699  
	`ERR_PTR
(-
EFSCORRUPTED
);

1701 
öode
 = 
	`pxt4_igë
(
dú
->
i_sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1702 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
)) {

1703 
	`PXT4_ERROR_INODE
(
dú
,

1705 
öo
);

1706  
	`ERR_PTR
(-
EFSCORRUPTED
);

1708 i‡(!
	`IS_ERR
(
öode
Ë&& 
	`IS_ENCRYPTED
(
dú
) &&

1709 (
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) &&

1710 !
	`fs¸y±_has_≥rmôãd_c⁄ãxt
(
dú
, 
öode
)) {

1711 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1713 
dú
->
i_öo
, 
öode
->i_ino);

1714 
	`ùut
(
öode
);

1715  
	`ERR_PTR
(-
EPERM
);

1719 #ifde‡
CONFIG_UNICODE


1720 i‡(!
öode
 && 
	`IS_CASEFOLDED
(
dú
)) {

1726  
NULL
;

1729  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

1730 
	}
}

1733 
díåy
 *
	$pxt4_gë_∑ª¡
(
díåy
 *
chûd
)

1735 
__u32
 
öo
;

1736 c⁄° 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

1737 
pxt4_dú_íåy_2
 * 
de
;

1738 
buf„r_hód
 *
bh
;

1740 
bh
 = 
	`pxt4_föd_íåy
(
	`d_öode
(
chûd
), &
dŸdŸ
, &
de
, 
NULL
);

1741 i‡(
	`IS_ERR
(
bh
))

1742  
	`ERR_CAST
(
bh
);

1743 i‡(!
bh
)

1744  
	`ERR_PTR
(-
ENOENT
);

1745 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1746 
	`bªl£
(
bh
);

1748 i‡(!
	`pxt4_vÆid_öum
(
chûd
->
d_sb
, 
öo
)) {

1749 
	`PXT4_ERROR_INODE
(
	`d_öode
(
chûd
),

1750 "badÖ¨íàöodênumbî: %u", 
öo
);

1751  
	`ERR_PTR
(-
EFSCORRUPTED
);

1754  
	`d_obèö_Æüs
(
	`pxt4_igë
(
chûd
->
d_sb
, 
öo
, 
PXT4_IGET_NORMAL
));

1755 
	}
}

1761 
pxt4_dú_íåy_2
 *

1762 
	$dx_move_dúíts
(*
‰om
, *
to
, 
dx_m≠_íåy
 *
m≠
, 
cou¡
,

1763 
blocksize
)

1765 
ªc_Àn
 = 0;

1767 
cou¡
--) {

1768 
pxt4_dú_íåy_2
 *
de
 = (pxt4_dir_entry_2 *)

1769 (
‰om
 + (
m≠
->
offs
<<2));

1770 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1771 
	`mem˝y
 (
to
, 
de
, 
ªc_Àn
);

1772 ((
pxt4_dú_íåy_2
 *Ë
to
)->
ªc_Àn
 =

1773 
	`pxt4_ªc_Àn_to_disk
(
ªc_Àn
, 
blocksize
);

1774 
de
->
öode
 = 0;

1775 
m≠
++;

1776 
to
 +
ªc_Àn
;

1778  (
pxt4_dú_íåy_2
 *Ë(
to
 - 
ªc_Àn
);

1779 
	}
}

1785 
pxt4_dú_íåy_2
* 
	$dx_∑ck_dúíts
(*
ba£
, 
blocksize
)

1787 
pxt4_dú_íåy_2
 *
√xt
, *
to
, *
¥ev
, *
de
 = (pxt4_dú_íåy_2 *Ë
ba£
;

1788 
ªc_Àn
 = 0;

1790 
¥ev
 = 
to
 = 
de
;

1791 (*)
de
 < 
ba£
 + 
blocksize
) {

1792 
√xt
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

1793 i‡(
de
->
öode
 && de->
«me_Àn
) {

1794 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1795 i‡(
de
 > 
to
)

1796 
	`memmove
(
to
, 
de
, 
ªc_Àn
);

1797 
to
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
‘ec_Àn, 
blocksize
);

1798 
¥ev
 = 
to
;

1799 
to
 = (
pxt4_dú_íåy_2
 *Ë(((*ËtoË+ 
ªc_Àn
);

1801 
de
 = 
√xt
;

1803  
¥ev
;

1804 
	}
}

1811 
pxt4_dú_íåy_2
 *
	$do_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1812 
buf„r_hód
 **
bh
,
dx_‰ame
 *
‰ame
,

1813 
dx_hash_öfo
 *
höfo
)

1815 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1816 
cou¡
, 
c⁄töued
;

1817 
buf„r_hód
 *
bh2
;

1818 
pxt4_lblk_t
 
√wblock
;

1819 
u32
 
hash2
;

1820 
dx_m≠_íåy
 *
m≠
;

1821 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1822 
•lô
, 
move
, 
size
;

1823 
pxt4_dú_íåy_2
 *
de
 = 
NULL
, *
de2
;

1824 
csum_size
 = 0;

1825 
îr
 = 0, 
i
;

1827 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

1828 
csum_size
 = (
pxt4_dú_íåy_èû
);

1830 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

1831 i‡(
	`IS_ERR
(
bh2
)) {

1832 
	`bªl£
(*
bh
);

1833 *
bh
 = 
NULL
;

1834  (
pxt4_dú_íåy_2
 *Ë
bh2
;

1837 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1838 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, *
bh
);

1839 i‡(
îr
)

1840 
jou∫Æ_îr‹
;

1842 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

1843 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

1844 i‡(
îr
)

1845 
jou∫Æ_îr‹
;

1847 
d©a2
 = 
bh2
->
b_d©a
;

1850 
m≠
 = (
dx_m≠_íåy
 *Ë(
d©a2
 + 
blocksize
);

1851 
cou¡
 = 
	`dx_make_m≠
(
dú
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1852 
blocksize
, 
höfo
, 
m≠
);

1853 
m≠
 -
cou¡
;

1854 
	`dx_s‹t_m≠
(
m≠
, 
cou¡
);

1856 
size
 = 0;

1857 
move
 = 0;

1858 
i
 = 
cou¡
-1; i >= 0; i--) {

1860 i‡(
size
 + 
m≠
[
i
].size/2 > 
blocksize
/2)

1862 
size
 +
m≠
[
i
].size;

1863 
move
++;

1866 
•lô
 = 
cou¡
 - 
move
;

1867 
hash2
 = 
m≠
[
•lô
].
hash
;

1868 
c⁄töued
 = 
hash2
 =
m≠
[
•lô
 - 1].
hash
;

1869 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "Split block %luát %x, %i/%i\n",

1870 ()
	`dx_gë_block
(
‰ame
->
©
),

1871 
hash2
, 
•lô
, 
cou¡
-split));

1874 
de2
 = 
	`dx_move_dúíts
(
d©a1
, 
d©a2
, 
m≠
 + 
•lô
, 
cou¡
 - split,

1875 
blocksize
);

1876 
de
 = 
	`dx_∑ck_dúíts
(
d©a1
, 
blocksize
);

1877 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1878 (*Ë
de
,

1879 
blocksize
);

1880 
de2
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1881 (*Ë
de2
,

1882 
blocksize
);

1883 i‡(
csum_size
) {

1884 
	`pxt4_öôülize_dúít_èû
(*
bh
, 
blocksize
);

1885 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

1888 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1889 
blocksize
, 1));

1890 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a2
,

1891 
blocksize
, 1));

1894 i‡(
höfo
->
hash
 >
hash2
) {

1895 
	`sw≠
(*
bh
, 
bh2
);

1896 
de
 = 
de2
;

1898 
	`dx_ö£π_block
(
‰ame
, 
hash2
 + 
c⁄töued
, 
√wblock
);

1899 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

1900 i‡(
îr
)

1901 
jou∫Æ_îr‹
;

1902 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1903 i‡(
îr
)

1904 
jou∫Æ_îr‹
;

1905 
	`bªl£
(
bh2
);

1906 
	`dxåa˚
(
	`dx_show_ödex
("‰ame", 
‰ame
->
íåõs
));

1907  
de
;

1909 
jou∫Æ_îr‹
:

1910 
	`bªl£
(*
bh
);

1911 
	`bªl£
(
bh2
);

1912 *
bh
 = 
NULL
;

1913 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1914  
	`ERR_PTR
(
îr
);

1915 
	}
}

1917 
	$pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

1918 
buf„r_hód
 *
bh
,

1919 *
buf
, 
buf_size
,

1920 
pxt4_fûíame
 *
‚ame
,

1921 
pxt4_dú_íåy_2
 **
de°_de
)

1923 
pxt4_dú_íåy_2
 *
de
;

1924 
ª˛í
 = 
	`PXT4_DIR_REC_LEN
(
	`‚ame_Àn
(
‚ame
));

1925 
∆í
, 
æí
;

1926 
off£t
 = 0;

1927 *
t›
;

1929 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

1930 
t›
 = 
buf
 + 
buf_size
 - 
ª˛í
;

1931 (*Ë
de
 <
t›
) {

1932 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1933 
buf
, 
buf_size
, 
off£t
))

1934  -
EFSCORRUPTED
;

1935 i‡(
	`pxt4_m©ch
(
dú
, 
‚ame
, 
de
))

1936  -
EEXIST
;

1937 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1938 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1939 i‡((
de
->
öode
 ? 
æí
 - 
∆í
 :ÑÀnË>
ª˛í
)

1941 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

1942 
off£t
 +
æí
;

1944 i‡((*Ë
de
 > 
t›
)

1945  -
ENOSPC
;

1947 *
de°_de
 = 
de
;

1949 
	}
}

1951 
	$pxt4_ö£π_díåy
(
öode
 *inode,

1952 
pxt4_dú_íåy_2
 *
de
,

1953 
buf_size
,

1954 
pxt4_fûíame
 *
‚ame
)

1957 
∆í
, 
æí
;

1959 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1960 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1961 i‡(
de
->
öode
) {

1962 
pxt4_dú_íåy_2
 *
de1
 =

1963 (
pxt4_dú_íåy_2
 *)((*)
de
 + 
∆í
);

1964 
de1
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
æí
 - 
∆í
, 
buf_size
);

1965 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
∆í
, 
buf_size
);

1966 
de
 = 
de1
;

1968 
de
->
fûe_ty≥
 = 
PXT4_FT_UNKNOWN
;

1969 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1970 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, inode->
i_mode
);

1971 
de
->
«me_Àn
 = 
	`‚ame_Àn
(
‚ame
);

1972 
	`mem˝y
(
de
->
«me
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(fname));

1973 
	}
}

1983 
	$add_dúít_to_buf
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1984 
öode
 *
dú
,

1985 
öode
 *öode, 
pxt4_dú_íåy_2
 *
de
,

1986 
buf„r_hód
 *
bh
)

1988 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1989 
csum_size
 = 0;

1990 
îr
;

1992 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1993 
csum_size
 = (
pxt4_dú_íåy_èû
);

1995 i‡(!
de
) {

1996 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
bh
, bh->
b_d©a
,

1997 
blocksize
 - 
csum_size
, 
‚ame
, &
de
);

1998 i‡(
îr
)

1999  
îr
;

2001 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2002 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2003 i‡(
îr
) {

2004 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2005  
îr
;

2009 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
blocksize
, 
‚ame
);

2022 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

2023 
	`pxt4_upd©e_dx_Êag
(
dú
);

2024 
	`öode_öc_ivîsi⁄
(
dú
);

2025 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2026 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2027 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2028 i‡(
îr
)

2029 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2031 
	}
}

2037 
	$make_ödexed_dú
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2038 
öode
 *
dú
,

2039 
öode
 *öode, 
buf„r_hód
 *
bh
)

2041 
buf„r_hód
 *
bh2
;

2042 
dx_roŸ
 *
roŸ
;

2043 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2044 
dx_íåy
 *
íåõs
;

2045 
pxt4_dú_íåy_2
 *
de
, *
de2
;

2046 *
d©a2
, *
t›
;

2047 
Àn
;

2048 
ªtvÆ
;

2049 
blocksize
;

2050 
pxt4_lblk_t
 
block
;

2051 
Áke_dúít
 *
fde
;

2052 
csum_size
 = 0;

2054 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2055 
csum_size
 = (
pxt4_dú_íåy_èû
);

2057 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2058 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Cª©ög index: inodê%lu\n", 
dú
->
i_öo
));

2059 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2060 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2061 i‡(
ªtvÆ
) {

2062 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
ªtvÆ
);

2063 
	`bªl£
(
bh
);

2064  
ªtvÆ
;

2066 
roŸ
 = (
dx_roŸ
 *Ë
bh
->
b_d©a
;

2069 
fde
 = &
roŸ
->
dŸdŸ
;

2070 
de
 = (
pxt4_dú_íåy_2
 *)((*)
fde
 +

2071 
	`pxt4_ªc_Àn_‰om_disk
(
fde
->
ªc_Àn
, 
blocksize
));

2072 i‡((*Ë
de
 >(((*Ë
roŸ
Ë+ 
blocksize
)) {

2073 
	`PXT4_ERROR_INODE
(
dú
, "invalidÑec_len for '..'");

2074 
	`bªl£
(
bh
);

2075  -
EFSCORRUPTED
;

2077 
Àn
 = ((*Ë
roŸ
Ë+ (
blocksize
 - 
csum_size
Ë- (*Ë
de
;

2080 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2081 i‡(
	`IS_ERR
(
bh2
)) {

2082 
	`bªl£
(
bh
);

2083  
	`PTR_ERR
(
bh2
);

2085 
	`pxt4_£t_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2086 
d©a2
 = 
bh2
->
b_d©a
;

2088 
	`mem˝y
(
d©a2
, 
de
, 
Àn
);

2089 
de
 = (
pxt4_dú_íåy_2
 *Ë
d©a2
;

2090 
t›
 = 
d©a2
 + 
Àn
;

2091 (*)(
de2
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
)Ë< 
t›
)

2092 
de
 = 
de2
;

2093 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

2094 (*Ë
de
, 
blocksize
);

2096 i‡(
csum_size
)

2097 
	`pxt4_öôülize_dúít_èû
(
bh2
, 
blocksize
);

2100 
de
 = (
pxt4_dú_íåy_2
 *Ë(&
roŸ
->
dŸdŸ
);

2101 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
	`PXT4_DIR_REC_LEN
(2),

2102 
blocksize
);

2103 
	`mem£t
 (&
roŸ
->
öfo
, 0, (root->info));

2104 
roŸ
->
öfo
.
öfo_Àngth
 = (root->info);

2105 
roŸ
->
öfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

2106 
íåõs
 = 
roŸ
->entries;

2107 
	`dx_£t_block
(
íåõs
, 1);

2108 
	`dx_£t_cou¡
(
íåõs
, 1);

2109 
	`dx_£t_limô
(
íåõs
, 
	`dx_roŸ_limô
(
dú
, (
roŸ
->
öfo
)));

2112 
‚ame
->
höfo
.
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

2113 i‡(
‚ame
->
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

2114 
‚ame
->
höfo
.
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

2115 
‚ame
->
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

2116 
	`pxt4fs_dúhash
(
dú
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), &‚ame->
höfo
);

2118 
	`mem£t
(
‰ames
, 0, (frames));

2119 
‰ame
 = 
‰ames
;

2120 
‰ame
->
íåõs
 =Éntries;

2121 
‰ame
->
©
 = 
íåõs
;

2122 
‰ame
->
bh
 = bh;

2124 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2125 i‡(
ªtvÆ
)

2126 
out_‰ames
;

2127 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh2
);

2128 i‡(
ªtvÆ
)

2129 
out_‰ames
;

2131 
de
 = 
	`do_•lô
(
h™dÀ
,
dú
, &
bh2
, 
‰ame
, &
‚ame
->
höfo
);

2132 i‡(
	`IS_ERR
(
de
)) {

2133 
ªtvÆ
 = 
	`PTR_ERR
(
de
);

2134 
out_‰ames
;

2137 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh2
);

2138 
out_‰ames
:

2144 i‡(
ªtvÆ
)

2145 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2146 
	`dx_ªÀa£
(
‰ames
);

2147 
	`bªl£
(
bh2
);

2148  
ªtvÆ
;

2149 
	}
}

2161 
	$pxt4_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
díåy
 *dentry,

2162 
öode
 *inode)

2164 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2165 
buf„r_hód
 *
bh
 = 
NULL
;

2166 
pxt4_dú_íåy_2
 *
de
;

2167 
su≥r_block
 *
sb
;

2168 #ifde‡
CONFIG_UNICODE


2169 
pxt4_sb_öfo
 *
sbi
;

2171 
pxt4_fûíame
 
‚ame
;

2172 
ªtvÆ
;

2173 
dx_ÁŒback
=0;

2174 
blocksize
;

2175 
pxt4_lblk_t
 
block
, 
blocks
;

2176 
csum_size
 = 0;

2178 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2179 
csum_size
 = (
pxt4_dú_íåy_èû
);

2181 
sb
 = 
dú
->
i_sb
;

2182 
blocksize
 = 
sb
->
s_blocksize
;

2183 i‡(!
díåy
->
d_«me
.
Àn
)

2184  -
EINVAL
;

2186 #ifde‡
CONFIG_UNICODE


2187 
sbi
 = 
	`PXT4_SB
(
sb
);

2188 i‡(
	`pxt4_has_°ri˘_mode
(
sbi
Ë&& 
	`IS_CASEFOLDED
(
dú
) &&

2189 
sbi
->
s_ícodög
 && 
	`utf8_vÆid©e
(sbi->s_ícodög, &
díåy
->
d_«me
))

2190  -
EINVAL
;

2193 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

2194 i‡(
ªtvÆ
)

2195  
ªtvÆ
;

2197 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2198 
ªtvÆ
 = 
	`pxt4_åy_add_ölöe_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2199 i‡(
ªtvÆ
 < 0)

2200 
out
;

2201 i‡(
ªtvÆ
 == 1) {

2202 
ªtvÆ
 = 0;

2203 
out
;

2207 i‡(
	`is_dx
(
dú
)) {

2208 
ªtvÆ
 = 
	`pxt4_dx_add_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2209 i‡(!
ªtvÆ
 || (ªtvÆ !
ERR_BAD_DX_DIR
))

2210 
out
;

2212 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

2213 
	`PXT4_ERROR_INODE
(
dú
,

2215 
ªtvÆ
 = -
EFSCORRUPTED
;

2216 
out
;

2218 
	`pxt4_˛ór_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2219 
dx_ÁŒback
++;

2220 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2222 
blocks
 = 
dú
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

2223 
block
 = 0; block < 
blocks
; block++) {

2224 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

2225 i‡(
bh
 =
NULL
) {

2226 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
dú
, 
block
,

2227 
PXT4_GET_BLOCKS_CREATE
);

2228 
add_to_√w_block
;

2230 i‡(
	`IS_ERR
(
bh
)) {

2231 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2232 
bh
 = 
NULL
;

2233 
out
;

2235 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
,

2236 
NULL
, 
bh
);

2237 i‡(
ªtvÆ
 !-
ENOSPC
)

2238 
out
;

2240 i‡(
blocks
 =1 && !
dx_ÁŒback
 &&

2241 
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

2242 
ªtvÆ
 = 
	`make_ödexed_dú
(
h™dÀ
, &
‚ame
, 
dú
,

2243 
öode
, 
bh
);

2244 
bh
 = 
NULL
;

2245 
out
;

2247 
	`bªl£
(
bh
);

2249 
bh
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2250 
add_to_√w_block
:

2251 i‡(
	`IS_ERR
(
bh
)) {

2252 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2253 
bh
 = 
NULL
;

2254 
out
;

2256 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2257 
de
->
öode
 = 0;

2258 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2260 i‡(
csum_size
)

2261 
	`pxt4_öôülize_dúít_èû
(
bh
, 
blocksize
);

2263 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2264 
out
:

2265 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

2266 
	`bªl£
(
bh
);

2267 i‡(
ªtvÆ
 == 0)

2268 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

2269  
ªtvÆ
;

2270 
	}
}

2275 
	$pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2276 
öode
 *
dú
, inode *inode)

2278 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2279 
dx_íåy
 *
íåõs
, *
©
;

2280 
buf„r_hód
 *
bh
;

2281 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

2282 
pxt4_dú_íåy_2
 *
de
;

2283 
ª°¨t
;

2284 
îr
;

2286 
agaö
:

2287 
ª°¨t
 = 0;

2288 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

2289 i‡(
	`IS_ERR
(
‰ame
))

2290  
	`PTR_ERR
(
‰ame
);

2291 
íåõs
 = 
‰ame
->entries;

2292 
©
 = 
‰ame
->at;

2293 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
‰ame
->
©
), 
DIRENT_HTREE
);

2294 i‡(
	`IS_ERR
(
bh
)) {

2295 
îr
 = 
	`PTR_ERR
(
bh
);

2296 
bh
 = 
NULL
;

2297 
˛ónup
;

2300 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2301 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2302 i‡(
îr
)

2303 
jou∫Æ_îr‹
;

2305 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
NULL
, 
bh
);

2306 i‡(
îr
 !-
ENOSPC
)

2307 
˛ónup
;

2309 
îr
 = 0;

2311 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "using %u of %uÇodeÉntries\n",

2312 
	`dx_gë_cou¡
(
íåõs
), 
	`dx_gë_limô
(entries)));

2314 i‡(
	`dx_gë_cou¡
(
íåõs
Ë=
	`dx_gë_limô
(entries)) {

2315 
pxt4_lblk_t
 
√wblock
;

2316 
Àvñs
 = 
‰ame
 - 
‰ames
 + 1;

2317 
icou¡
;

2318 
add_Àvñ
 = 1;

2319 
dx_íåy
 *
íåõs2
;

2320 
dx_node
 *
node2
;

2321 
buf„r_hód
 *
bh2
;

2323 
‰ame
 > 
‰ames
) {

2324 i‡(
	`dx_gë_cou¡
((
‰ame
 - 1)->
íåõs
) <

2325 
	`dx_gë_limô
((
‰ame
 - 1)->
íåõs
)) {

2326 
add_Àvñ
 = 0;

2329 
‰ame
--;

2330 
©
 = 
‰ame
->at;

2331 
íåõs
 = 
‰ame
->entries;

2332 
ª°¨t
 = 1;

2334 i‡(
add_Àvñ
 && 
Àvñs
 =
	`pxt4_dú_håì_Àvñ
(
sb
)) {

2335 
	`pxt4_w¨nög
(
sb
, "Directory (ino: %lu) index full, "

2337 
dú
->
i_öo
, 
Àvñs
);

2338 i‡(
	`pxt4_dú_håì_Àvñ
(
sb
Ë< 
PXT4_HTREE_LEVEL
) {

2339 
	`pxt4_w¨nög
(
sb
, "Large directory feature is "

2343 
îr
 = -
ENOSPC
;

2344 
˛ónup
;

2346 
icou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

2347 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

2348 i‡(
	`IS_ERR
(
bh2
)) {

2349 
îr
 = 
	`PTR_ERR
(
bh2
);

2350 
˛ónup
;

2352 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2353 
íåõs2
 = 
node2
->
íåõs
;

2354 
	`mem£t
(&
node2
->
Áke
, 0, (
Áke_dúít
));

2355 
node2
->
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
sb
->
s_blocksize
,

2356 
sb
->
s_blocksize
);

2357 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2358 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

2359 i‡(
îr
)

2360 
jou∫Æ_îr‹
;

2361 i‡(!
add_Àvñ
) {

2362 
icou¡1
 = 
icou¡
/2, 
icou¡2
 = icount - icount1;

2363 
hash2
 = 
	`dx_gë_hash
(
íåõs
 + 
icou¡1
);

2364 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Split index %i/%i\n",

2365 
icou¡1
, 
icou¡2
));

2367 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2368 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2369 (
‰ame
 - 1)->
bh
);

2370 i‡(
îr
)

2371 
jou∫Æ_îr‹
;

2373 
	`mem˝y
((*Ë
íåõs2
, (*Ë(
íåõs
 + 
icou¡1
),

2374 
icou¡2
 * (
dx_íåy
));

2375 
	`dx_£t_cou¡
(
íåõs
, 
icou¡1
);

2376 
	`dx_£t_cou¡
(
íåõs2
, 
icou¡2
);

2377 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2380 i‡(
©
 - 
íåõs
 >
icou¡1
) {

2381 
‰ame
->
©
 =áà© - 
íåõs
 - 
icou¡1
 + 
íåõs2
;

2382 
‰ame
->
íåõs
 =É¡rõ†
íåõs2
;

2383 
	`sw≠
(
‰ame
->
bh
, 
bh2
);

2385 
	`dx_ö£π_block
((
‰ame
 - 1), 
hash2
, 
√wblock
);

2386 
	`dxåa˚
(
	`dx_show_ödex
("node", 
‰ame
->
íåõs
));

2387 
	`dxåa˚
(
	`dx_show_ödex
("node",

2388 ((
dx_node
 *Ë
bh2
->
b_d©a
)->
íåõs
));

2389 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2390 i‡(
îr
)

2391 
jou∫Æ_îr‹
;

2392 
	`bªl£
 (
bh2
);

2393 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2394 (
‰ame
 - 1)->
bh
);

2395 i‡(
îr
)

2396 
jou∫Æ_îr‹
;

2397 i‡(
ª°¨t
) {

2398 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2399 
‰ame
->
bh
);

2400 
jou∫Æ_îr‹
;

2403 
dx_roŸ
 *
dxroŸ
;

2404 
	`mem˝y
((*Ë
íåõs2
, (*Ë
íåõs
,

2405 
icou¡
 * (
dx_íåy
));

2406 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2409 
	`dx_£t_cou¡
(
íåõs
, 1);

2410 
	`dx_£t_block
(
íåõs
 + 0, 
√wblock
);

2411 
dxroŸ
 = (
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
;

2412 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
 += 1;

2413 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG


2415 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
));

2416 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2417 i‡(
îr
)

2418 
jou∫Æ_îr‹
;

2419 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2420 
	`bªl£
(
bh2
);

2421 
ª°¨t
 = 1;

2422 
jou∫Æ_îr‹
;

2425 
de
 = 
	`do_•lô
(
h™dÀ
, 
dú
, &
bh
, 
‰ame
, &
‚ame
->
höfo
);

2426 i‡(
	`IS_ERR
(
de
)) {

2427 
îr
 = 
	`PTR_ERR
(
de
);

2428 
˛ónup
;

2430 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2431 
˛ónup
;

2433 
jou∫Æ_îr‹
:

2434 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2435 
˛ónup
:

2436 
	`bªl£
(
bh
);

2437 
	`dx_ªÀa£
(
‰ames
);

2441 i‡(
ª°¨t
 && 
îr
 == 0)

2442 
agaö
;

2443  
îr
;

2444 
	}
}

2450 
	$pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2451 
öode
 *
dú
,

2452 
pxt4_dú_íåy_2
 *
de_dñ
,

2453 
buf„r_hód
 *
bh
,

2454 *
íåy_buf
,

2455 
buf_size
,

2456 
csum_size
)

2458 
pxt4_dú_íåy_2
 *
de
, *
pde
;

2459 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2460 
i
;

2462 
i
 = 0;

2463 
pde
 = 
NULL
;

2464 
de
 = (
pxt4_dú_íåy_2
 *)
íåy_buf
;

2465 
i
 < 
buf_size
 - 
csum_size
) {

2466 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

2467 
bh
->
b_d©a
, bh->
b_size
, 
i
))

2468  -
EFSCORRUPTED
;

2469 i‡(
de
 =
de_dñ
) {

2470 i‡(
pde
)

2471 
pde
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2472 
	`pxt4_ªc_Àn_‰om_disk
(
pde
->
ªc_Àn
,

2473 
blocksize
) +

2474 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

2475 
blocksize
),

2476 
blocksize
);

2478 
de
->
öode
 = 0;

2479 
	`öode_öc_ivîsi⁄
(
dú
);

2482 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
blocksize
);

2483 
pde
 = 
de
;

2484 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2486  -
ENOENT
;

2487 
	}
}

2489 
	$pxt4_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2490 
öode
 *
dú
,

2491 
pxt4_dú_íåy_2
 *
de_dñ
,

2492 
buf„r_hód
 *
bh
)

2494 
îr
, 
csum_size
 = 0;

2496 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2497 
has_ölöe_d©a
 = 1;

2498 
îr
 = 
	`pxt4_dñëe_ölöe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

2499 &
has_ölöe_d©a
);

2500 i‡(
has_ölöe_d©a
)

2501  
îr
;

2504 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2505 
csum_size
 = (
pxt4_dú_íåy_èû
);

2507 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2508 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2509 i‡(
	`u∆ikñy
(
îr
))

2510 
out
;

2512 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
,

2513 
bh
, bh->
b_d©a
,

2514 
dú
->
i_sb
->
s_blocksize
, 
csum_size
);

2515 i‡(
îr
)

2516 
out
;

2518 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2519 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
dú
, 
bh
);

2520 i‡(
	`u∆ikñy
(
îr
))

2521 
out
;

2524 
out
:

2525 i‡(
îr
 !-
ENOENT
)

2526 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2527  
îr
;

2528 
	}
}

2541 
	$pxt4_öc_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2543 
	`öc_∆ök
(
öode
);

2544 i‡(
	`is_dx
(
öode
) &&

2545 (
öode
->
i_∆ök
 > 
PXT4_LINK_MAX
 || inode->i_nlink == 2))

2546 
	`£t_∆ök
(
öode
, 1);

2547 
	}
}

2553 
	$pxt4_dec_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2555 i‡(!
	`S_ISDIR
(
öode
->
i_mode
Ë|| inode->
i_∆ök
 > 2)

2556 
	`dr›_∆ök
(
öode
);

2557 
	}
}

2566 
	$pxt4_add_n⁄dú
(
h™dÀ_t
 *
h™dÀ
,

2567 
díåy
 *díåy, 
öode
 **
öodï
)

2569 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2570 
öode
 *öodê*
öodï
;

2571 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2572 i‡(!
îr
) {

2573 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2574 i‡(
	`IS_DIRSYNC
(
dú
))

2575 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2576 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2577 *
öodï
 = 
NULL
;

2580 
	`dr›_∆ök
(
öode
);

2581 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2582 
	`u∆ock_√w_öode
(
öode
);

2583  
îr
;

2584 
	}
}

2594 
	$pxt4_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

2595 
boﬁ
 
ex˛
)

2597 
h™dÀ_t
 *
h™dÀ
;

2598 
öode
 *inode;

2599 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2601 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2602 i‡(
îr
)

2603  
îr
;

2605 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2606 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2607 
ªåy
:

2608 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2609 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2610 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2611 
îr
 = 
	`PTR_ERR
(
öode
);

2612 i‡(!
	`IS_ERR
(
öode
)) {

2613 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2614 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2615 
	`pxt4_£t_a›s
(
öode
);

2616 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, &
öode
);

2618 i‡(
h™dÀ
)

2619 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2620 i‡(!
	`IS_ERR_OR_NULL
(
öode
))

2621 
	`ùut
(
öode
);

2622 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2623 
ªåy
;

2624  
îr
;

2625 
	}
}

2627 
	$pxt4_mknod
(
öode
 *
dú
, 
díåy
 *dentry,

2628 
umode_t
 
mode
, 
dev_t
 
rdev
)

2630 
h™dÀ_t
 *
h™dÀ
;

2631 
öode
 *inode;

2632 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2634 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2635 i‡(
îr
)

2636  
îr
;

2638 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2639 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2640 
ªåy
:

2641 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2642 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2643 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2644 
îr
 = 
	`PTR_ERR
(
öode
);

2645 i‡(!
	`IS_ERR
(
öode
)) {

2646 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

2647 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

2648 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, &
öode
);

2650 i‡(
h™dÀ
)

2651 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2652 i‡(!
	`IS_ERR_OR_NULL
(
öode
))

2653 
	`ùut
(
öode
);

2654 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2655 
ªåy
;

2656  
îr
;

2657 
	}
}

2659 
	$pxt4_tmpfûe
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2661 
h™dÀ_t
 *
h™dÀ
;

2662 
öode
 *inode;

2663 
îr
, 
ªåõs
 = 0;

2665 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2666 i‡(
îr
)

2667  
îr
;

2669 
ªåy
:

2670 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
,

2671 
NULL
, 0, NULL,

2672 
PXT4_HT_DIR
,

2673 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

2674 4 + 
PXT4_XATTR_TRANS_BLOCKS
);

2675 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2676 
îr
 = 
	`PTR_ERR
(
öode
);

2677 i‡(!
	`IS_ERR
(
öode
)) {

2678 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2679 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2680 
	`pxt4_£t_a›s
(
öode
);

2681 
	`d_tmpfûe
(
díåy
, 
öode
);

2682 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2683 i‡(
îr
)

2684 
îr_u∆ock_öode
;

2685 
	`m¨k_öode_dúty
(
öode
);

2686 
	`u∆ock_√w_öode
(
öode
);

2688 i‡(
h™dÀ
)

2689 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2690 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2691 
ªåy
;

2692  
îr
;

2693 
îr_u∆ock_öode
:

2694 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2695 
	`u∆ock_√w_öode
(
öode
);

2696  
îr
;

2697 
	}
}

2699 
pxt4_dú_íåy_2
 *
	$pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

2700 
pxt4_dú_íåy_2
 *
de
,

2701 
blocksize
, 
csum_size
,

2702 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
)

2704 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

2705 
de
->
«me_Àn
 = 1;

2706 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
	`PXT4_DIR_REC_LEN
(de->
«me_Àn
),

2707 
blocksize
);

2708 
	`°r˝y
(
de
->
«me
, ".");

2709 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2711 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2712 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

2713 
de
->
«me_Àn
 = 2;

2714 i‡(!
dŸdŸ_ªÆ_Àn
)

2715 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 -

2716 (
csum_size
 + 
	`PXT4_DIR_REC_LEN
(1)),

2717 
blocksize
);

2719 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2720 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
), 
blocksize
);

2721 
	`°r˝y
(
de
->
«me
, "..");

2722 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2724  
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

2725 
	}
}

2727 
	$pxt4_öô_√w_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

2728 
öode
 *inode)

2730 
buf„r_hód
 *
dú_block
 = 
NULL
;

2731 
pxt4_dú_íåy_2
 *
de
;

2732 
pxt4_lblk_t
 
block
 = 0;

2733 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2734 
csum_size
 = 0;

2735 
îr
;

2737 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2738 
csum_size
 = (
pxt4_dú_íåy_èû
);

2740 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2741 
îr
 = 
	`pxt4_åy_¸óã_ölöe_dú
(
h™dÀ
, 
dú
, 
öode
);

2742 i‡(
îr
 < 0 &&Éº !-
ENOSPC
)

2743 
out
;

2744 i‡(!
îr
)

2745 
out
;

2748 
öode
->
i_size
 = 0;

2749 
dú_block
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
öode
, &
block
);

2750 i‡(
	`IS_ERR
(
dú_block
))

2751  
	`PTR_ERR
(
dú_block
);

2752 
de
 = (
pxt4_dú_íåy_2
 *)
dú_block
->
b_d©a
;

2753 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, 
de
, 
blocksize
, 
csum_size
, 
dú
->
i_öo
, 0);

2754 
	`£t_∆ök
(
öode
, 2);

2755 i‡(
csum_size
)

2756 
	`pxt4_öôülize_dúít_èû
(
dú_block
, 
blocksize
);

2758 
	`BUFFER_TRACE
(
dú_block
, "callÖxt4_handle_dirty_metadata");

2759 
îr
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
öode
, 
dú_block
);

2760 i‡(
îr
)

2761 
out
;

2762 
	`£t_buf„r_vîifõd
(
dú_block
);

2763 
out
:

2764 
	`bªl£
(
dú_block
);

2765  
îr
;

2766 
	}
}

2768 
	$pxt4_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2770 
h™dÀ_t
 *
h™dÀ
;

2771 
öode
 *inode;

2772 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2774 i‡(
	`PXT4_DIR_LINK_MAX
(
dú
))

2775  -
EMLINK
;

2777 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2778 i‡(
îr
)

2779  
îr
;

2781 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2782 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2783 
ªåy
:

2784 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFDIR
 | 
mode
,

2785 &
díåy
->
d_«me
,

2786 0, 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2787 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2788 
îr
 = 
	`PTR_ERR
(
öode
);

2789 i‡(
	`IS_ERR
(
öode
))

2790 
out_°›
;

2792 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

2793 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

2794 
îr
 = 
	`pxt4_öô_√w_dú
(
h™dÀ
, 
dú
, 
öode
);

2795 i‡(
îr
)

2796 
out_˛ór_öode
;

2797 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2798 i‡(!
îr
)

2799 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2800 i‡(
îr
) {

2801 
out_˛ór_öode
:

2802 
	`˛ór_∆ök
(
öode
);

2803 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2804 
	`u∆ock_√w_öode
(
öode
);

2805 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2806 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2807 
	`ùut
(
öode
);

2808 
out_ªåy
;

2810 
	`pxt4_öc_cou¡
(
h™dÀ
, 
dú
);

2811 
	`pxt4_upd©e_dx_Êag
(
dú
);

2812 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2813 i‡(
îr
)

2814 
out_˛ór_öode
;

2815 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2816 i‡(
	`IS_DIRSYNC
(
dú
))

2817 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2819 
out_°›
:

2820 i‡(
h™dÀ
)

2821 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2822 
out_ªåy
:

2823 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2824 
ªåy
;

2825  
îr
;

2826 
	}
}

2831 
boﬁ
 
	$pxt4_em±y_dú
(
öode
 *inode)

2833 
off£t
;

2834 
buf„r_hód
 *
bh
;

2835 
pxt4_dú_íåy_2
 *
de
;

2836 
su≥r_block
 *
sb
;

2838 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2839 
has_ölöe_d©a
 = 1;

2840 
ªt
;

2842 
ªt
 = 
	`em±y_ölöe_dú
(
öode
, &
has_ölöe_d©a
);

2843 i‡(
has_ölöe_d©a
)

2844  
ªt
;

2847 
sb
 = 
öode
->
i_sb
;

2848 i‡(
öode
->
i_size
 < 
	`PXT4_DIR_REC_LEN
(1) + PXT4_DIR_REC_LEN(2)) {

2849 
	`PXT4_ERROR_INODE
(
öode
, "invalid size");

2850  
åue
;

2855 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

2856 i‡(
	`IS_ERR
(
bh
))

2857  
åue
;

2859 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2860 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2862 
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
 || 
	`°rcmp
(".", de->
«me
)) {

2863 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '.'");

2864 
	`bªl£
(
bh
);

2865  
åue
;

2867 
off£t
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2868 
de
 = 
	`pxt4_√xt_íåy
(de, 
sb
->
s_blocksize
);

2869 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
, bh->
b_size
,

2870 
off£t
) ||

2871 
	`À32_to_˝u
(
de
->
öode
Ë=0 || 
	`°rcmp
("..", de->
«me
)) {

2872 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '..'");

2873 
	`bªl£
(
bh
);

2874  
åue
;

2876 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2877 
off£t
 < 
öode
->
i_size
) {

2878 i‡(!(
off£t
 & (
sb
->
s_blocksize
 - 1))) {

2879 
lblock
;

2880 
	`bªl£
(
bh
);

2881 
lblock
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

2882 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 
lblock
, 
EITHER
);

2883 i‡(
bh
 =
NULL
) {

2884 
off£t
 +
sb
->
s_blocksize
;

2887 i‡(
	`IS_ERR
(
bh
))

2888  
åue
;

2890 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 +

2891 (
off£t
 & (
sb
->
s_blocksize
 - 1)));

2892 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
,

2893 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2894 
off£t
 = (off£à| (
sb
->
s_blocksize
 - 1)) + 1;

2897 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

2898 
	`bªl£
(
bh
);

2899  
Ál£
;

2901 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2903 
	`bªl£
(
bh
);

2904  
åue
;

2905 
	}
}

2919 
	$pxt4_‹ph™_add
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2921 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2922 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2923 
pxt4_ûoc
 
ûoc
;

2924 
îr
 = 0, 
rc
;

2925 
boﬁ
 
dúty
 = 
Ál£
;

2927 i‡(!
sbi
->
s_jou∫Æ
 || 
	`is_bad_öode
(
öode
))

2930 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2931 !
	`öode_is_locked
(
öode
));

2936 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

2945 
	`J_ASSERT
((
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

2946 
	`S_ISLNK
(
öode
->
i_mode
)Ë|| inode->
i_∆ök
 == 0);

2948 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2949 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2950 i‡(
îr
)

2951 
out
;

2953 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2954 i‡(
îr
)

2955 
out
;

2957 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2962 i‡(!
	`NEXT_ORPHAN
(
öode
) || NEXT_ORPHAN(inode) >

2963 (
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
))) {

2965 
	`NEXT_ORPHAN
(
öode
Ë
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
);

2966 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

2967 
dúty
 = 
åue
;

2969 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
sbi
->
s_‹ph™
);

2970 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2972 i‡(
dúty
) {

2973 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

2974 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2975 i‡(!
îr
)

2976 
îr
 = 
rc
;

2977 i‡(
îr
) {

2983 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2984 
	`li°_dñ_öô
(&
	`PXT4_I
(
öode
)->
i_‹ph™
);

2985 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2988 
	`bªl£
(
ûoc
.
bh
);

2990 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%lu\n", 
öode
->
i_öo
);

2991 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %d\n",

2992 
öode
->
i_öo
, 
	`NEXT_ORPHAN
(inode));

2993 
out
:

2994 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

2995  
îr
;

2996 
	}
}

3002 
	$pxt4_‹ph™_dñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

3004 
li°_hód
 *
¥ev
;

3005 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3006 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3007 
__u32
 
öo_√xt
;

3008 
pxt4_ûoc
 
ûoc
;

3009 
îr
 = 0;

3011 i‡(!
sbi
->
s_jou∫Æ
 && !(sbi->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
))

3014 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

3015 !
	`öode_is_locked
(
öode
));

3017 i‡(
	`li°_em±y
(&
ei
->
i_‹ph™
))

3020 i‡(
h™dÀ
) {

3022 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

3025 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

3026 
	`jbd_debug
(4, "ªmovêöodê%lu from oΩh™Üi°\n", 
öode
->
i_öo
);

3028 
¥ev
 = 
ei
->
i_‹ph™
.prev;

3029 
	`li°_dñ_öô
(&
ei
->
i_‹ph™
);

3035 i‡(!
h™dÀ
 || 
îr
) {

3036 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3037 
out_îr
;

3040 
öo_√xt
 = 
	`NEXT_ORPHAN
(
öode
);

3041 i‡(
¥ev
 =&
sbi
->
s_‹ph™
) {

3042 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%u\n", 
öo_√xt
);

3043 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

3044 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

3045 i‡(
îr
) {

3046 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3047 
out_bªl£
;

3049 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öo_√xt
);

3050 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3051 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
öode
->
i_sb
);

3053 
pxt4_ûoc
 
ûoc2
;

3054 
öode
 *
i_¥ev
 =

3055 &
	`li°_íåy
(
¥ev
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

3057 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %u\n",

3058 
i_¥ev
->
i_öo
, 
öo_√xt
);

3059 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3060 i‡(
îr
) {

3061 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3062 
out_bªl£
;

3064 
	`NEXT_ORPHAN
(
i_¥ev
Ë
öo_√xt
;

3065 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

3066 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

3068 i‡(
îr
)

3069 
out_bªl£
;

3070 
	`NEXT_ORPHAN
(
öode
) = 0;

3071 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

3072 
out_îr
:

3073 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

3074  
îr
;

3076 
out_bªl£
:

3077 
	`bªl£
(
ûoc
.
bh
);

3078 
out_îr
;

3079 
	}
}

3081 
	$pxt4_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

3083 
ªtvÆ
;

3084 
öode
 *inode;

3085 
buf„r_hód
 *
bh
;

3086 
pxt4_dú_íåy_2
 *
de
;

3087 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3089 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3090  -
EIO
;

3094 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3095 i‡(
ªtvÆ
)

3096  
ªtvÆ
;

3097 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3098 i‡(
ªtvÆ
)

3099  
ªtvÆ
;

3101 
ªtvÆ
 = -
ENOENT
;

3102 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3103 i‡(
	`IS_ERR
(
bh
))

3104  
	`PTR_ERR
(
bh
);

3105 i‡(!
bh
)

3106 
íd_rmdú
;

3108 
öode
 = 
	`d_öode
(
díåy
);

3110 
ªtvÆ
 = -
EFSCORRUPTED
;

3111 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3112 
íd_rmdú
;

3114 
ªtvÆ
 = -
ENOTEMPTY
;

3115 i‡(!
	`pxt4_em±y_dú
(
öode
))

3116 
íd_rmdú
;

3118 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3119 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3120 i‡(
	`IS_ERR
(
h™dÀ
)) {

3121 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3122 
h™dÀ
 = 
NULL
;

3123 
íd_rmdú
;

3126 i‡(
	`IS_DIRSYNC
(
dú
))

3127 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3129 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3130 i‡(
ªtvÆ
)

3131 
íd_rmdú
;

3132 i‡(!
	`PXT4_DIR_LINK_EMPTY
(
öode
))

3133 
	`pxt4_w¨nög_öode
(
öode
,

3135 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
,

3136 
öode
->
i_∆ök
);

3137 
	`öode_öc_ivîsi⁄
(
öode
);

3138 
	`˛ór_∆ök
(
öode
);

3142 
öode
->
i_size
 = 0;

3143 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3144 
öode
->
i_˘ime
 = 
dú
->i_˘imêdú->
i_mtime
 = 
	`cuºít_time
(inode);

3145 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3146 
	`pxt4_dec_cou¡
(
h™dÀ
, 
dú
);

3147 
	`pxt4_upd©e_dx_Êag
(
dú
);

3148 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3150 #ifde‡
CONFIG_UNICODE


3157 i‡(
	`IS_CASEFOLDED
(
dú
))

3158 
	`d_övÆid©e
(
díåy
);

3161 
íd_rmdú
:

3162 
	`bªl£
(
bh
);

3163 i‡(
h™dÀ
)

3164 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3165  
ªtvÆ
;

3166 
	}
}

3168 
	$pxt4_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

3170 
ªtvÆ
;

3171 
öode
 *inode;

3172 
buf„r_hód
 *
bh
;

3173 
pxt4_dú_íåy_2
 *
de
;

3174 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3176 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3177  -
EIO
;

3179 
	`åa˚_pxt4_u∆ök_íãr
(
dú
, 
díåy
);

3182 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3183 i‡(
ªtvÆ
)

3184  
ªtvÆ
;

3185 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3186 i‡(
ªtvÆ
)

3187  
ªtvÆ
;

3189 
ªtvÆ
 = -
ENOENT
;

3190 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3191 i‡(
	`IS_ERR
(
bh
))

3192  
	`PTR_ERR
(
bh
);

3193 i‡(!
bh
)

3194 
íd_u∆ök
;

3196 
öode
 = 
	`d_öode
(
díåy
);

3198 
ªtvÆ
 = -
EFSCORRUPTED
;

3199 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3200 
íd_u∆ök
;

3202 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3203 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3204 i‡(
	`IS_ERR
(
h™dÀ
)) {

3205 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3206 
h™dÀ
 = 
NULL
;

3207 
íd_u∆ök
;

3210 i‡(
	`IS_DIRSYNC
(
dú
))

3211 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3213 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3214 i‡(
ªtvÆ
)

3215 
íd_u∆ök
;

3216 
dú
->
i_˘ime
 = dú->
i_mtime
 = 
	`cuºít_time
(dir);

3217 
	`pxt4_upd©e_dx_Êag
(
dú
);

3218 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3219 i‡(
öode
->
i_∆ök
 == 0)

3220 
	`pxt4_w¨nög_öode
(
öode
, "Deleting file '%.*s' withÇoÜinks",

3221 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
);

3223 
	`dr›_∆ök
(
öode
);

3224 i‡(!
öode
->
i_∆ök
)

3225 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3226 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3227 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3229 #ifde‡
CONFIG_UNICODE


3236 i‡(
	`IS_CASEFOLDED
(
dú
))

3237 
	`d_övÆid©e
(
díåy
);

3240 
íd_u∆ök
:

3241 
	`bªl£
(
bh
);

3242 i‡(
h™dÀ
)

3243 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3244 
	`åa˚_pxt4_u∆ök_exô
(
díåy
, 
ªtvÆ
);

3245  
ªtvÆ
;

3246 
	}
}

3248 
	$pxt4_symlök
(
öode
 *
dú
,

3249 
díåy
 *díåy, c⁄° *
sym«me
)

3251 
h™dÀ_t
 *
h™dÀ
;

3252 
öode
 *inode;

3253 
îr
, 
Àn
 = 
	`°æí
(
sym«me
);

3254 
¸edôs
;

3255 
fs¸y±_°r
 
disk_lök
;

3257 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3258  -
EIO
;

3260 
îr
 = 
	`fs¸y±_¥ï¨e_symlök
(
dú
, 
sym«me
, 
Àn
, dú->
i_sb
->
s_blocksize
,

3261 &
disk_lök
);

3262 i‡(
îr
)

3263  
îr
;

3265 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3266 i‡(
îr
)

3267  
îr
;

3269 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3276 
¸edôs
 = 4 + 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

3277 
PXT4_XATTR_TRANS_BLOCKS
;

3285 
¸edôs
 = 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3286 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3289 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFLNK
|
S_IRWXUGO
,

3290 &
díåy
->
d_«me
, 0, 
NULL
,

3291 
PXT4_HT_DIR
, 
¸edôs
);

3292 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3293 i‡(
	`IS_ERR
(
öode
)) {

3294 i‡(
h™dÀ
)

3295 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3296  
	`PTR_ERR
(
öode
);

3299 i‡(
	`IS_ENCRYPTED
(
öode
)) {

3300 
îr
 = 
	`fs¸y±_í¸y±_symlök
(
öode
, 
sym«me
, 
Àn
, &
disk_lök
);

3301 i‡(
îr
)

3302 
îr_dr›_öode
;

3303 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3306 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3307 i‡(!
	`IS_ENCRYPTED
(
öode
))

3308 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

3309 
	`öode_nohighmem
(
öode
);

3310 
	`pxt4_£t_a›s
(
öode
);

3321 
	`dr›_∆ök
(
öode
);

3322 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3323 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3324 
h™dÀ
 = 
NULL
;

3325 i‡(
îr
)

3326 
îr_dr›_öode
;

3327 
îr
 = 
	`__∑ge_symlök
(
öode
, 
disk_lök
.
«me
, disk_lök.
Àn
, 1);

3328 i‡(
îr
)

3329 
îr_dr›_öode
;

3334 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3335 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3336 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3337 i‡(
	`IS_ERR
(
h™dÀ
)) {

3338 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

3339 
h™dÀ
 = 
NULL
;

3340 
îr_dr›_öode
;

3342 
	`£t_∆ök
(
öode
, 1);

3343 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3344 i‡(
îr
)

3345 
îr_dr›_öode
;

3348 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

3349 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

3350 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

3351 
öode
->
i_lök
 = (*)&
	`PXT4_I
(öode)->
i_d©a
;

3353 
	`mem˝y
((*)&
	`PXT4_I
(
öode
)->
i_d©a
, 
disk_lök
.
«me
,

3354 
disk_lök
.
Àn
);

3355 
öode
->
i_size
 = 
disk_lök
.
Àn
 - 1;

3357 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

3358 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, &
öode
);

3359 i‡(
h™dÀ
)

3360 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3361 i‡(
öode
)

3362 
	`ùut
(
öode
);

3363 
out_‰ì_í¸y±ed_lök
;

3365 
îr_dr›_öode
:

3366 i‡(
h™dÀ
)

3367 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3368 
	`˛ór_∆ök
(
öode
);

3369 
	`u∆ock_√w_öode
(
öode
);

3370 
	`ùut
(
öode
);

3371 
out_‰ì_í¸y±ed_lök
:

3372 i‡(
disk_lök
.
«me
 !(*)
sym«me
)

3373 
	`k‰ì
(
disk_lök
.
«me
);

3374  
îr
;

3375 
	}
}

3377 
	$pxt4_lök
(
díåy
 *
ﬁd_díåy
,

3378 
öode
 *
dú
, 
díåy
 *dentry)

3380 
h™dÀ_t
 *
h™dÀ
;

3381 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

3382 
îr
, 
ªåõs
 = 0;

3384 i‡(
öode
->
i_∆ök
 >
PXT4_LINK_MAX
)

3385  -
EMLINK
;

3387 
îr
 = 
	`fs¸y±_¥ï¨e_lök
(
ﬁd_díåy
, 
dú
, 
díåy
);

3388 i‡(
îr
)

3389  
îr
;

3391 i‡((
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3392 (!
	`¥ojid_eq
(
	`PXT4_I
(
dú
)->
i_¥ojid
,

3393 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3394  -
EXDEV
;

3396 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3397 i‡(
îr
)

3398  
îr
;

3400 
ªåy
:

3401 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3402 (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3403 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3404 i‡(
	`IS_ERR
(
h™dÀ
))

3405  
	`PTR_ERR
(
h™dÀ
);

3407 i‡(
	`IS_DIRSYNC
(
dú
))

3408 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3410 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3411 
	`pxt4_öc_cou¡
(
h™dÀ
, 
öode
);

3412 
	`ihﬁd
(
öode
);

3414 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

3415 i‡(!
îr
) {

3416 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3420 i‡(
öode
->
i_∆ök
 == 1)

3421 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3422 
	`d_ö°™tüã
(
díåy
, 
öode
);

3424 
	`dr›_∆ök
(
öode
);

3425 
	`ùut
(
öode
);

3427 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3428 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

3429 
ªåy
;

3430  
îr
;

3431 
	}
}

3439 
buf„r_hód
 *
	$pxt4_gë_fú°_dú_block
(
h™dÀ_t
 *
h™dÀ
,

3440 
öode
 *inode,

3441 *
ªtvÆ
,

3442 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3443 *
ölöed
)

3445 
buf„r_hód
 *
bh
;

3447 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

3451 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
DIRENT_HTREE
);

3452 i‡(
	`IS_ERR
(
bh
)) {

3453 *
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

3454  
NULL
;

3456 *
∑ª¡_de
 = 
	`pxt4_√xt_íåy
(

3457 (
pxt4_dú_íåy_2
 *)
bh
->
b_d©a
,

3458 
öode
->
i_sb
->
s_blocksize
);

3459  
bh
;

3462 *
ölöed
 = 1;

3463  
	`pxt4_gë_fú°_ölöe_block
(
öode
, 
∑ª¡_de
, 
ªtvÆ
);

3464 
	}
}

3466 
	spxt4_ª«mít
 {

3467 
öode
 *
	mdú
;

3468 
díåy
 *
	mdíåy
;

3469 
öode
 *
	möode
;

3470 
boﬁ
 
	mis_dú
;

3471 
	mdú_∆ök_dñè
;

3474 
buf„r_hód
 *
	mbh
;

3475 
pxt4_dú_íåy_2
 *
	mde
;

3476 
	mölöed
;

3479 
buf„r_hód
 *
	mdú_bh
;

3480 
pxt4_dú_íåy_2
 *
	m∑ª¡_de
;

3481 
	mdú_ölöed
;

3484 
	$pxt4_ª«me_dú_¥ï¨e
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3486 
ªtvÆ
;

3488 
ít
->
dú_bh
 = 
	`pxt4_gë_fú°_dú_block
(
h™dÀ
,É¡->
öode
,

3489 &
ªtvÆ
, &
ít
->
∑ª¡_de
,

3490 &
ít
->
dú_ölöed
);

3491 i‡(!
ít
->
dú_bh
)

3492  
ªtvÆ
;

3493 i‡(
	`À32_to_˝u
(
ít
->
∑ª¡_de
->
öode
Ë!ít->
dú
->
i_öo
)

3494  -
EFSCORRUPTED
;

3495 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "get_write_access");

3496  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
dú_bh
);

3497 
	}
}

3499 
	$pxt4_ª«me_dú_föish
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3500 
dú_öo
)

3502 
ªtvÆ
;

3504 
ít
->
∑ª¡_de
->
öode
 = 
	`˝u_to_À32
(
dú_öo
);

3505 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "callÖxt4_handle_dirty_metadata");

3506 i‡(!
ít
->
dú_ölöed
) {

3507 i‡(
	`is_dx
(
ít
->
öode
)) {

3508 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
,

3509 
ít
->
öode
,

3510 
ít
->
dú_bh
);

3512 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
öode
,

3513 
ít
->
dú_bh
);

3516 
ªtvÆ
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
öode
);

3518 i‡(
ªtvÆ
) {

3519 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3520  
ªtvÆ
;

3523 
	}
}

3525 
	$pxt4_£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3526 
öo
, 
fûe_ty≥
)

3528 
ªtvÆ
;

3530 
	`BUFFER_TRACE
(
ít
->
bh
, "get writeáccess");

3531 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
bh
);

3532 i‡(
ªtvÆ
)

3533  
ªtvÆ
;

3534 
ít
->
de
->
öode
 = 
	`˝u_to_À32
(
öo
);

3535 i‡(
	`pxt4_has_„©uª_fûëy≥
(
ít
->
dú
->
i_sb
))

3536 
ít
->
de
->
fûe_ty≥
 = file_type;

3537 
	`öode_öc_ivîsi⁄
(
ít
->
dú
);

3538 
ít
->
dú
->
i_˘ime
 =É¡->dú->
i_mtime
 =

3539 
	`cuºít_time
(
ít
->
dú
);

3540 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3541 
	`BUFFER_TRACE
(
ít
->
bh
, "callÖxt4_handle_dirty_metadata");

3542 i‡(!
ít
->
ölöed
) {

3543 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúblock
(
h™dÀ
, 
ít
->
dú
,É¡->
bh
);

3544 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

3545 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3546  
ªtvÆ
;

3549 
	`bªl£
(
ít
->
bh
);

3550 
ít
->
bh
 = 
NULL
;

3553 
	}
}

3555 
	$pxt4_föd_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

3556 c⁄° 
q°r
 *
d_«me
)

3558 
ªtvÆ
 = -
ENOENT
;

3559 
buf„r_hód
 *
bh
;

3560 
pxt4_dú_íåy_2
 *
de
;

3562 
bh
 = 
	`pxt4_föd_íåy
(
dú
, 
d_«me
, &
de
, 
NULL
);

3563 i‡(
	`IS_ERR
(
bh
))

3564  
	`PTR_ERR
(
bh
);

3565 i‡(
bh
) {

3566 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3567 
	`bªl£
(
bh
);

3569  
ªtvÆ
;

3570 
	}
}

3572 
	$pxt4_ª«me_dñëe
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3573 
f‹˚_ªªad
)

3575 
ªtvÆ
;

3582 i‡(
	`À32_to_˝u
(
ít
->
de
->
öode
Ë!ít->öode->
i_öo
 ||

3583 
ít
->
de
->
«me_Àn
 !ít->
díåy
->
d_«me
.
Àn
 ||

3584 
	`°∫cmp
(
ít
->
de
->
«me
,É¡->
díåy
->
d_«me
.name,

3585 
ít
->
de
->
«me_Àn
) ||

3586 
f‹˚_ªªad
) {

3587 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3588 &
ít
->
díåy
->
d_«me
);

3590 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,É¡->
de
,É¡->
bh
);

3591 i‡(
ªtvÆ
 =-
ENOENT
) {

3592 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3593 &
ít
->
díåy
->
d_«me
);

3597 i‡(
ªtvÆ
) {

3598 
	`pxt4_w¨nög_öode
(
ít
->
dú
,

3600 
ít
->
dú
->
i_∆ök
, 
ªtvÆ
);

3602 
	}
}

3604 
	$pxt4_upd©e_dú_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3606 i‡(
ít
->
dú_∆ök_dñè
) {

3607 i‡(
ít
->
dú_∆ök_dñè
 == -1)

3608 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ít
->
dú
);

3610 
	`pxt4_öc_cou¡
(
h™dÀ
, 
ít
->
dú
);

3611 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3613 
	}
}

3615 
öode
 *
	$pxt4_whôeout_f‹_ª«me
(
pxt4_ª«mít
 *
ít
,

3616 
¸edôs
, 
h™dÀ_t
 **
h
)

3618 
öode
 *
wh
;

3619 
h™dÀ_t
 *
h™dÀ
;

3620 
ªåõs
 = 0;

3626 
¸edôs
 +(
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
ít
->
dú
->
i_sb
) +

3627 
PXT4_XATTR_TRANS_BLOCKS
 + 4);

3628 
ªåy
:

3629 
wh
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
ít
->
dú
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3630 &
ít
->
díåy
->
d_«me
, 0, 
NULL
,

3631 
PXT4_HT_DIR
, 
¸edôs
);

3633 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3634 i‡(
	`IS_ERR
(
wh
)) {

3635 i‡(
h™dÀ
)

3636 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3637 i‡(
	`PTR_ERR
(
wh
Ë=-
ENOSPC
 &&

3638 
	`pxt4_should_ªåy_Æloc
(
ít
->
dú
->
i_sb
, &
ªåõs
))

3639 
ªåy
;

3641 *
h
 = 
h™dÀ
;

3642 
	`öô_•ecül_öode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3643 
wh
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

3645  
wh
;

3646 
	}
}

3656 
	$pxt4_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3657 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3658 
Êags
)

3660 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3661 
pxt4_ª«mít
 
ﬁd
 = {

3662 .
dú
 = 
ﬁd_dú
,

3663 .
díåy
 = 
ﬁd_díåy
,

3664 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3666 
pxt4_ª«mít
 
√w
 = {

3667 .
dú
 = 
√w_dú
,

3668 .
díåy
 = 
√w_díåy
,

3669 .
öode
 = 
	`d_öode
(
√w_díåy
),

3671 
f‹˚_ªªad
;

3672 
ªtvÆ
;

3673 
öode
 *
whôeout
 = 
NULL
;

3674 
¸edôs
;

3675 
u8
 
ﬁd_fûe_ty≥
;

3677 i‡(
√w
.
öode
 &&Çew.öode->
i_∆ök
 == 0) {

3678 
	`PXT4_ERROR_INODE
(
√w
.
öode
,

3680  -
EFSCORRUPTED
;

3683 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3684 (!
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3685 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3686  -
EXDEV
;

3688 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3689 i‡(
ªtvÆ
)

3690  
ªtvÆ
;

3691 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3692 i‡(
ªtvÆ
)

3693  
ªtvÆ
;

3697 i‡(
√w
.
öode
) {

3698 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
öode
);

3699 i‡(
ªtvÆ
)

3700  
ªtvÆ
;

3703 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3704 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3705  
	`PTR_ERR
(
ﬁd
.
bh
);

3712 
ªtvÆ
 = -
ENOENT
;

3713 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3714 
íd_ª«me
;

3716 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3717 &
√w
.
de
, &√w.
ölöed
);

3718 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3719 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3720 
√w
.
bh
 = 
NULL
;

3721 
íd_ª«me
;

3723 i‡(
√w
.
bh
) {

3724 i‡(!
√w
.
öode
) {

3725 
	`bªl£
(
√w
.
bh
);

3726 
√w
.
bh
 = 
NULL
;

3729 i‡(
√w
.
öode
 && !
	`ã°_›t
“ew.
dú
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3730 
	`pxt4_Æloc_da_blocks
(
ﬁd
.
öode
);

3732 
¸edôs
 = (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3733 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3734 i‡(!(
Êags
 & 
RENAME_WHITEOUT
)) {

3735 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
, 
¸edôs
);

3736 i‡(
	`IS_ERR
(
h™dÀ
)) {

3737 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3738 
h™dÀ
 = 
NULL
;

3739 
íd_ª«me
;

3742 
whôeout
 = 
	`pxt4_whôeout_f‹_ª«me
(&
ﬁd
, 
¸edôs
, &
h™dÀ
);

3743 i‡(
	`IS_ERR
(
whôeout
)) {

3744 
ªtvÆ
 = 
	`PTR_ERR
(
whôeout
);

3745 
whôeout
 = 
NULL
;

3746 
íd_ª«me
;

3750 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3751 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3753 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3754 i‡(
√w
.
öode
) {

3755 
ªtvÆ
 = -
ENOTEMPTY
;

3756 i‡(!
	`pxt4_em±y_dú
(
√w
.
öode
))

3757 
íd_ª«me
;

3759 
ªtvÆ
 = -
EMLINK
;

3760 i‡(
√w
.
dú
 !
ﬁd
.dú && 
	`PXT4_DIR_LINK_MAX
(new.dir))

3761 
íd_ª«me
;

3763 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3764 i‡(
ªtvÆ
)

3765 
íd_ª«me
;

3774 
f‹˚_ªªad
 = (
√w
.
dú
->
i_öo
 =
ﬁd
.dir->i_ino &&

3775 
	`pxt4_ã°_öode_Êag
(
√w
.
dú
, 
PXT4_INODE_INLINE_DATA
));

3777 
ﬁd_fûe_ty≥
 = 
ﬁd
.
de
->
fûe_ty≥
;

3778 i‡(
whôeout
) {

3783 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
whôeout
->
i_öo
,

3784 
PXT4_FT_CHRDEV
);

3785 i‡(
ªtvÆ
)

3786 
íd_ª«me
;

3787 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
whôeout
);

3789 i‡(!
√w
.
bh
) {

3790 
ªtvÆ
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
√w
.
díåy
, 
ﬁd
.
öode
);

3791 i‡(
ªtvÆ
)

3792 
íd_ª«me
;

3794 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
,

3795 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3796 i‡(
ªtvÆ
)

3797 
íd_ª«me
;

3799 i‡(
f‹˚_ªªad
)

3800 
f‹˚_ªªad
 = !
	`pxt4_ã°_öode_Êag
(
√w
.
dú
,

3801 
PXT4_INODE_INLINE_DATA
);

3807 
ﬁd
.
öode
->
i_˘ime
 = 
	`cuºít_time
(old.inode);

3808 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3810 i‡(!
whôeout
) {

3814 
	`pxt4_ª«me_dñëe
(
h™dÀ
, &
ﬁd
, 
f‹˚_ªªad
);

3817 i‡(
√w
.
öode
) {

3818 
	`pxt4_dec_cou¡
(
h™dÀ
, 
√w
.
öode
);

3819 
√w
.
öode
->
i_˘ime
 = 
	`cuºít_time
(new.inode);

3821 
ﬁd
.
dú
->
i_˘ime
 = old.dú->
i_mtime
 = 
	`cuºít_time
(old.dir);

3822 
	`pxt4_upd©e_dx_Êag
(
ﬁd
.
dú
);

3823 i‡(
ﬁd
.
dú_bh
) {

3824 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3825 i‡(
ªtvÆ
)

3826 
íd_ª«me
;

3828 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ﬁd
.
dú
);

3829 i‡(
√w
.
öode
) {

3833 
	`˛ór_∆ök
(
√w
.
öode
);

3835 
	`pxt4_öc_cou¡
(
h™dÀ
, 
√w
.
dú
);

3836 
	`pxt4_upd©e_dx_Êag
(
√w
.
dú
);

3837 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
dú
);

3840 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
dú
);

3841 i‡(
√w
.
öode
) {

3842 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3843 i‡(!
√w
.
öode
->
i_∆ök
)

3844 
	`pxt4_‹ph™_add
(
h™dÀ
, 
√w
.
öode
);

3846 
ªtvÆ
 = 0;

3848 
íd_ª«me
:

3849 
	`bªl£
(
ﬁd
.
dú_bh
);

3850 
	`bªl£
(
ﬁd
.
bh
);

3851 
	`bªl£
(
√w
.
bh
);

3852 i‡(
whôeout
) {

3853 i‡(
ªtvÆ
)

3854 
	`dr›_∆ök
(
whôeout
);

3855 
	`u∆ock_√w_öode
(
whôeout
);

3856 
	`ùut
(
whôeout
);

3858 i‡(
h™dÀ
)

3859 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3860  
ªtvÆ
;

3861 
	}
}

3863 
	$pxt4_¸oss_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3864 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

3866 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3867 
pxt4_ª«mít
 
ﬁd
 = {

3868 .
dú
 = 
ﬁd_dú
,

3869 .
díåy
 = 
ﬁd_díåy
,

3870 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3872 
pxt4_ª«mít
 
√w
 = {

3873 .
dú
 = 
√w_dú
,

3874 .
díåy
 = 
√w_díåy
,

3875 .
öode
 = 
	`d_öode
(
√w_díåy
),

3877 
u8
 
√w_fûe_ty≥
;

3878 
ªtvÆ
;

3879 
time•ec64
 
˘ime
;

3881 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3882 !
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3883 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)) ||

3884 (
	`pxt4_ã°_öode_Êag
(
ﬁd_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3885 !
	`¥ojid_eq
(
	`PXT4_I
(
ﬁd_dú
)->
i_¥ojid
,

3886 
	`PXT4_I
(
√w_díåy
->
d_öode
)->
i_¥ojid
)))

3887  -
EXDEV
;

3889 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3890 i‡(
ªtvÆ
)

3891  
ªtvÆ
;

3892 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3893 i‡(
ªtvÆ
)

3894  
ªtvÆ
;

3896 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
,

3897 &
ﬁd
.
de
, &ﬁd.
ölöed
);

3898 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3899  
	`PTR_ERR
(
ﬁd
.
bh
);

3906 
ªtvÆ
 = -
ENOENT
;

3907 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3908 
íd_ª«me
;

3910 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3911 &
√w
.
de
, &√w.
ölöed
);

3912 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3913 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3914 
√w
.
bh
 = 
NULL
;

3915 
íd_ª«me
;

3919 i‡(!
√w
.
bh
 || 
	`À32_to_˝u
“ew.
de
->
öode
Ë!√w.öode->
i_öo
)

3920 
íd_ª«me
;

3922 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
,

3923 (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3924 2 * 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3925 i‡(
	`IS_ERR
(
h™dÀ
)) {

3926 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3927 
h™dÀ
 = 
NULL
;

3928 
íd_ª«me
;

3931 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3932 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3934 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3935 
ﬁd
.
is_dú
 = 
åue
;

3936 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3937 i‡(
ªtvÆ
)

3938 
íd_ª«me
;

3940 i‡(
	`S_ISDIR
(
√w
.
öode
->
i_mode
)) {

3941 
√w
.
is_dú
 = 
åue
;

3942 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
√w
);

3943 i‡(
ªtvÆ
)

3944 
íd_ª«me
;

3951 i‡(
ﬁd
.
dú
 !
√w
.dú && old.
is_dú
 !=Çew.is_dir) {

3952 
ﬁd
.
dú_∆ök_dñè
 = old.
is_dú
 ? -1 : 1;

3953 
√w
.
dú_∆ök_dñè
 = -
ﬁd
.dir_nlink_delta;

3954 
ªtvÆ
 = -
EMLINK
;

3955 i‡((
ﬁd
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
(ﬁd.
dú
)) ||

3956 (
√w
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
“ew.
dú
)))

3957 
íd_ª«me
;

3960 
√w_fûe_ty≥
 = 
√w
.
de
->
fûe_ty≥
;

3961 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
, 
ﬁd
.
öode
->
i_öo
, old.
de
->
fûe_ty≥
);

3962 i‡(
ªtvÆ
)

3963 
íd_ª«me
;

3965 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
√w
.
öode
->
i_öo
, 
√w_fûe_ty≥
);

3966 i‡(
ªtvÆ
)

3967 
íd_ª«me
;

3973 
˘ime
 = 
	`cuºít_time
(
ﬁd
.
öode
);

3974 
ﬁd
.
öode
->
i_˘ime
 = 
˘ime
;

3975 
√w
.
öode
->
i_˘ime
 = 
˘ime
;

3976 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3977 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3979 i‡(
ﬁd
.
dú_bh
) {

3980 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3981 i‡(
ªtvÆ
)

3982 
íd_ª«me
;

3984 i‡(
√w
.
dú_bh
) {

3985 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
√w
, 
ﬁd
.
dú
->
i_öo
);

3986 i‡(
ªtvÆ
)

3987 
íd_ª«me
;

3989 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
ﬁd
);

3990 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
√w
);

3991 
ªtvÆ
 = 0;

3993 
íd_ª«me
:

3994 
	`bªl£
(
ﬁd
.
dú_bh
);

3995 
	`bªl£
(
√w
.
dú_bh
);

3996 
	`bªl£
(
ﬁd
.
bh
);

3997 
	`bªl£
(
√w
.
bh
);

3998 i‡(
h™dÀ
)

3999 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4000  
ªtvÆ
;

4001 
	}
}

4003 
	$pxt4_ª«me2
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

4004 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

4005 
Êags
)

4007 
îr
;

4009 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
ﬁd_dú
->
i_sb
))))

4010  -
EIO
;

4012 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

4013  -
EINVAL
;

4015 
îr
 = 
	`fs¸y±_¥ï¨e_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
,

4016 
Êags
);

4017 i‡(
îr
)

4018  
îr
;

4020 i‡(
Êags
 & 
RENAME_EXCHANGE
) {

4021  
	`pxt4_¸oss_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
,

4022 
√w_dú
, 
√w_díåy
);

4025  
	`pxt4_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
, 
Êags
);

4026 
	}
}

4031 c⁄° 
öode_›î©i⁄s
 
	gpxt4_dú_öode_›î©i⁄s
 = {

4032 .
¸óã
 = 
pxt4_¸óã
,

4033 .
	glookup
 = 
pxt4_lookup
,

4034 .
	glök
 = 
pxt4_lök
,

4035 .
	gu∆ök
 = 
pxt4_u∆ök
,

4036 .
	gsymlök
 = 
pxt4_symlök
,

4037 .
	gmkdú
 = 
pxt4_mkdú
,

4038 .
	grmdú
 = 
pxt4_rmdú
,

4039 .
	gmknod
 = 
pxt4_mknod
,

4040 .
	gtmpfûe
 = 
pxt4_tmpfûe
,

4041 .
	gª«me
 = 
pxt4_ª«me2
,

4042 .
	g£èâr
 = 
pxt4_£èâr
,

4043 .
	ggë©å
 = 
pxt4_gë©å
,

4044 .
	gli°x©å
 = 
pxt4_li°x©å
,

4045 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4046 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

4047 .
	gfõm≠
 = 
pxt4_fõm≠
,

4050 c⁄° 
öode_›î©i⁄s
 
	gpxt4_•ecül_öode_›î©i⁄s
 = {

4051 .
£èâr
 = 
pxt4_£èâr
,

4052 .
	ggë©å
 = 
pxt4_gë©å
,

4053 .
	gli°x©å
 = 
pxt4_li°x©å
,

4054 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

4055 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

	@page-io.c

10 
	~<löux/fs.h
>

11 
	~<löux/time.h
>

12 
	~<löux/highuid.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/∑gevec.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/«mei.h
>

21 
	~<löux/uio.h
>

22 
	~<löux/bio.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/backög-dev.h
>

29 
	~"pxt4_jbd3.h
"

30 
	~"x©å.h
"

31 
	~"a˛.h
"

33 
kmem_ˇche
 *
	gio_íd_ˇchï
;

34 
kmem_ˇche
 *
	gio_íd_vec_ˇchï
;

36 
__öô
 
	$pxt4_öô_∑geio
()

38 
io_íd_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd
, 
SLAB_RECLAIM_ACCOUNT
);

39 i‡(
io_íd_ˇchï
 =
NULL
)

40  -
ENOMEM
;

42 
io_íd_vec_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd_vec
, 0);

43 i‡(
io_íd_vec_ˇchï
 =
NULL
) {

44 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

45  -
ENOMEM
;

48 
	}
}

50 
	$pxt4_exô_∑geio
()

52 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

53 
	`kmem_ˇche_de°roy
(
io_íd_vec_ˇchï
);

54 
	}
}

56 
pxt4_io_íd_vec
 *
	$pxt4_Æloc_io_íd_vec
(
pxt4_io_íd_t
 *
io_íd
)

58 
pxt4_io_íd_vec
 *
io_íd_vec
;

60 
io_íd_vec
 = 
	`kmem_ˇche_zÆloc
(
io_íd_vec_ˇchï
, 
GFP_NOFS
);

61 i‡(!
io_íd_vec
)

62  
	`ERR_PTR
(-
ENOMEM
);

63 
	`INIT_LIST_HEAD
(&
io_íd_vec
->
li°
);

64 
	`li°_add_èû
(&
io_íd_vec
->
li°
, &
io_íd
->
li°_vec
);

65  
io_íd_vec
;

66 
	}
}

68 
	$pxt4_‰ì_io_íd_vec
(
pxt4_io_íd_t
 *
io_íd
)

70 
pxt4_io_íd_vec
 *
io_íd_vec
, *
tmp
;

72 i‡(
	`li°_em±y
(&
io_íd
->
li°_vec
))

74 
	`li°_f‹_óch_íåy_ß„
(
io_íd_vec
, 
tmp
, &
io_íd
->
li°_vec
, 
li°
) {

75 
	`li°_dñ
(&
io_íd_vec
->
li°
);

76 
	`kmem_ˇche_‰ì
(
io_íd_vec_ˇchï
, 
io_íd_vec
);

78 
	}
}

80 
pxt4_io_íd_vec
 *
	$pxt4_œ°_io_íd_vec
(
pxt4_io_íd_t
 *
io_íd
)

82 
	`BUG_ON
(
	`li°_em±y
(&
io_íd
->
li°_vec
));

83  
	`li°_œ°_íåy
(&
io_íd
->
li°_vec
, 
pxt4_io_íd_vec
, 
li°
);

84 
	}
}

93 
	$buf„r_io_îr‹
(
buf„r_hód
 *
bh
)

95 
	`¥ötk_øãlimôed
(
KERN_ERR
 "Buffer I/OÉrror on device %pg,Üogical block %llu\n",

96 
bh
->
b_bdev
,

97 ()
bh
->
b_blockƒ
);

98 
	}
}

100 
	$pxt4_föish_bio
(
bio
 *bio)

102 
bio_vec
 *
bvec
;

103 
bvec_ôî_Æl
 
ôî_Æl
;

105 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
ôî_Æl
) {

106 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

107 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

108 
buf„r_hód
 *
bh
, *
hód
;

109 
bio_°¨t
 = 
bvec
->
bv_off£t
;

110 
bio_íd
 = 
bio_°¨t
 + 
bvec
->
bv_Àn
;

111 
undî_io
 = 0;

112 
Êags
;

114 i‡(!
∑ge
)

117 i‡(
	`fs¸y±_is_boun˚_∑ge
(
∑ge
)) {

118 
boun˚_∑ge
 = 
∑ge
;

119 
∑ge
 = 
	`fs¸y±_∑geˇche_∑ge
(
boun˚_∑ge
);

122 i‡(
bio
->
bi_°©us
) {

123 
	`SëPageEº‹
(
∑ge
);

124 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, -
EIO
);

126 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

131 
	`loˇl_úq_ßve
(
Êags
);

132 
	`bô_•ö_lock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

134 i‡(
	`bh_off£t
(
bh
Ë< 
bio_°¨t
 ||

135 
	`bh_off£t
(
bh
Ë+ bh->
b_size
 > 
bio_íd
) {

136 i‡(
	`buf„r_async_wrôe
(
bh
))

137 
undî_io
++;

140 
	`˛ór_buf„r_async_wrôe
(
bh
);

141 i‡(
bio
->
bi_°©us
)

142 
	`buf„r_io_îr‹
(
bh
);

143 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

144 
	`bô_•ö_u∆ock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

145 
	`loˇl_úq_ª°‹e
(
Êags
);

146 i‡(!
undî_io
) {

147 
	`fs¸y±_‰ì_boun˚_∑ge
(
boun˚_∑ge
);

148 
	`íd_∑ge_wrôeback
(
∑ge
);

151 
	}
}

153 
	$pxt4_ªÀa£_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

155 
bio
 *bio, *
√xt_bio
;

157 
	`BUG_ON
(!
	`li°_em±y
(&
io_íd
->
li°
));

158 
	`BUG_ON
(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
);

159 
	`WARN_ON
(
io_íd
->
h™dÀ
);

161 
bio
 = 
io_íd
->bio; bio; biÿ
√xt_bio
) {

162 
√xt_bio
 = 
bio
->
bi_¥iv©e
;

163 
	`pxt4_föish_bio
(
bio
);

164 
	`bio_put
(
bio
);

166 
	`pxt4_‰ì_io_íd_vec
(
io_íd
);

167 
	`kmem_ˇche_‰ì
(
io_íd_ˇchï
, 
io_íd
);

168 
	}
}

178 
	$pxt4_íd_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

180 
öode
 *öodê
io_íd
->inode;

181 
h™dÀ_t
 *
h™dÀ
 = 
io_íd
->handle;

182 
ªt
 = 0;

184 
	`pxt4_debug
("pxt4_end_io_nolock: io_end 0x%p from inode %lu,list->next 0x%p,"

186 
io_íd
, 
öode
->
i_öo
, io_íd->
li°
.
√xt
, io_íd->li°.
¥ev
);

188 
io_íd
->
h™dÀ
 = 
NULL
;

189 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_io_íd_vec
(
h™dÀ
, 
io_íd
);

190 i‡(
ªt
 < 0 && !
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))) {

191 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_EMERG
,

194 "(öodê%lu,Éº‹ %d)", 
öode
->
i_öo
, 
ªt
);

196 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

197 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

198  
ªt
;

199 
	}
}

201 
	$dump_com∂ëed_IO
(
öode
 *öode, 
li°_hód
 *
hód
)

203 #ifdef 
PXT4FS_DEBUG


204 
li°_hód
 *
cur
, *
bef‹e
, *
a·î
;

205 
pxt4_io_íd_t
 *
io_íd
, *
io_íd0
, *
io_íd1
;

207 i‡(
	`li°_em±y
(
hód
))

210 
	`pxt4_debug
("Dum∞öodê%lu com∂ëed iÿli°\n", 
öode
->
i_öo
);

211 
	`li°_f‹_óch_íåy
(
io_íd
, 
hód
, 
li°
) {

212 
cur
 = &
io_íd
->
li°
;

213 
bef‹e
 = 
cur
->
¥ev
;

214 
io_íd0
 = 
	`c⁄èöî_of
(
bef‹e
, 
pxt4_io_íd_t
, 
li°
);

215 
a·î
 = 
cur
->
√xt
;

216 
io_íd1
 = 
	`c⁄èöî_of
(
a·î
, 
pxt4_io_íd_t
, 
li°
);

218 
	`pxt4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

219 
io_íd
, 
öode
->
i_öo
, 
io_íd0
, 
io_íd1
);

222 
	}
}

225 
	$pxt4_add_com∂ëe_io
(
pxt4_io_íd_t
 *
io_íd
)

227 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
io_íd
->
öode
);

228 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
io_íd
->
öode
->
i_sb
);

229 
w‹kqueue_°ru˘
 *
wq
;

230 
Êags
;

233 
	`WARN_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

234 
	`WARN_ON
(!
io_íd
->
h™dÀ
 && 
sbi
->
s_jou∫Æ
);

235 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

236 
wq
 = 
sbi
->
rsv_c⁄vîsi⁄_wq
;

237 i‡(
	`li°_em±y
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
))

238 
	`queue_w‹k
(
wq
, &
ei
->
i_rsv_c⁄vîsi⁄_w‹k
);

239 
	`li°_add_èû
(&
io_íd
->
li°
, &
ei
->
i_rsv_c⁄vîsi⁄_li°
);

240 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

241 
	}
}

243 
	$pxt4_do_Êush_com∂ëed_IO
(
öode
 *inode,

244 
li°_hód
 *
hód
)

246 
pxt4_io_íd_t
 *
io_íd
;

247 
li°_hód
 
unwrôãn
;

248 
Êags
;

249 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

250 
îr
, 
ªt
 = 0;

252 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

253 
	`dump_com∂ëed_IO
(
öode
, 
hód
);

254 
	`li°_ª∂a˚_öô
(
hód
, &
unwrôãn
);

255 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

257 !
	`li°_em±y
(&
unwrôãn
)) {

258 
io_íd
 = 
	`li°_íåy
(
unwrôãn
.
√xt
, 
pxt4_io_íd_t
, 
li°
);

259 
	`BUG_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

260 
	`li°_dñ_öô
(&
io_íd
->
li°
);

262 
îr
 = 
	`pxt4_íd_io_íd
(
io_íd
);

263 i‡(
	`u∆ikñy
(!
ªt
 && 
îr
))

264 
ªt
 = 
îr
;

266  
ªt
;

267 
	}
}

272 
	$pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
)

274 
pxt4_öode_öfo
 *
ei
 = 
	`c⁄èöî_of
(
w‹k
, pxt4_inode_info,

275 
i_rsv_c⁄vîsi⁄_w‹k
);

276 
	`pxt4_do_Êush_com∂ëed_IO
(&
ei
->
vfs_öode
, &ei->
i_rsv_c⁄vîsi⁄_li°
);

277 
	}
}

279 
pxt4_io_íd_t
 *
	$pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
)

281 
pxt4_io_íd_t
 *
io_íd
 = 
	`kmem_ˇche_zÆloc
(
io_íd_ˇchï
, 
Êags
);

283 i‡(
io_íd
) {

284 
io_íd
->
öode
 = inode;

285 
	`INIT_LIST_HEAD
(&
io_íd
->
li°
);

286 
	`INIT_LIST_HEAD
(&
io_íd
->
li°_vec
);

287 
	`©omic_£t
(&
io_íd
->
cou¡
, 1);

289  
io_íd
;

290 
	}
}

292 
	$pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
)

294 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

295 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) ||

296 
	`li°_em±y
(&
io_íd
->
li°_vec
)) {

297 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

300 
	`pxt4_add_com∂ëe_io
(
io_íd
);

302 
	}
}

304 
	$pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

306 
îr
 = 0;

308 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

309 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

310 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_io_íd_vec
(
io_íd
->
h™dÀ
,

311 
io_íd
);

312 
io_íd
->
h™dÀ
 = 
NULL
;

313 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

315 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

317  
îr
;

318 
	}
}

320 
pxt4_io_íd_t
 *
	$pxt4_gë_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

322 
	`©omic_öc
(&
io_íd
->
cou¡
);

323  
io_íd
;

324 
	}
}

327 
	$pxt4_íd_bio
(
bio
 *bio)

329 
pxt4_io_íd_t
 *
io_íd
 = 
bio
->
bi_¥iv©e
;

330 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

331 
b
[
BDEVNAME_SIZE
];

333 i‡(
	`WARN_ONCE
(!
io_íd
, "io_end is NULL: %s: sector %LuÜen %uÉrr %d\n",

334 
	`bio_dev«me
(
bio
, 
b
),

335 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

336 (Ë
	`bio_£˘‹s
(
bio
),

337 
bio
->
bi_°©us
)) {

338 
	`pxt4_föish_bio
(
bio
);

339 
	`bio_put
(
bio
);

342 
bio
->
bi_íd_io
 = 
NULL
;

344 i‡(
bio
->
bi_°©us
) {

345 
öode
 *öodê
io_íd
->inode;

347 
	`pxt4_w¨nög
(
öode
->
i_sb
, "I/OÉrror %d writingÅo inode %lu "

349 
bio
->
bi_°©us
, 
öode
->
i_öo
,

351 
bi_£˘‹
 >> (
öode
->
i_blkbôs
 - 9));

352 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
,

353 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

356 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

362 
bio
->
bi_¥iv©e
 = 
	`xchg
(&
io_íd
->bio, bio);

363 
	`pxt4_put_io_íd_de„r
(
io_íd
);

369 
	`pxt4_put_io_íd_de„r
(
io_íd
);

370 
	`pxt4_föish_bio
(
bio
);

371 
	`bio_put
(
bio
);

373 
	}
}

375 
	$pxt4_io_submô
(
pxt4_io_submô
 *
io
)

377 
bio
 *biÿ
io
->
io_bio
;

379 i‡(
bio
) {

380 
io_›_Êags
 = 
io
->
io_wbc
->
sync_mode
 =
WB_SYNC_ALL
 ?

381 
REQ_SYNC
 : 0;

382 
io
->
io_bio
->
bi_wrôe_höt
 = io->
io_íd
->
öode
->
i_wrôe_höt
;

383 
	`bio_£t_›_©ås
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_›_Êags
);

384 
	`submô_bio
(
io
->
io_bio
);

386 
io
->
io_bio
 = 
NULL
;

387 
	}
}

389 
	$pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

390 
wrôeback_c⁄åﬁ
 *
wbc
)

392 
io
->
io_wbc
 = 
wbc
;

393 
io
->
io_bio
 = 
NULL
;

394 
io
->
io_íd
 = 
NULL
;

395 
	}
}

397 
	$io_submô_öô_bio
(
pxt4_io_submô
 *
io
,

398 
buf„r_hód
 *
bh
)

400 
bio
 *bio;

406 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

407 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bh
->
b_blockƒ
 * (bh->
b_size
 >> 9);

408 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

409 
bio
->
bi_íd_io
 = 
pxt4_íd_bio
;

410 
bio
->
bi_¥iv©e
 = 
	`pxt4_gë_io_íd
(
io
->
io_íd
);

411 
io
->
io_bio
 = 
bio
;

412 
io
->
io_√xt_block
 = 
bh
->
b_blockƒ
;

413 
	`wbc_öô_bio
(
io
->
io_wbc
, 
bio
);

414 
	}
}

416 
	$io_submô_add_bh
(
pxt4_io_submô
 *
io
,

417 
öode
 *inode,

418 
∑ge
 *page,

419 
buf„r_hód
 *
bh
)

421 
ªt
;

423 i‡(
io
->
io_bio
 && 
bh
->
b_blockƒ
 !io->
io_√xt_block
) {

424 
submô_™d_ªåy
:

425 
	`pxt4_io_submô
(
io
);

427 i‡(
io
->
io_bio
 =
NULL
) {

428 
	`io_submô_öô_bio
(
io
, 
bh
);

429 
io
->
io_bio
->
bi_wrôe_höt
 = 
öode
->
i_wrôe_höt
;

431 
ªt
 = 
	`bio_add_∑ge
(
io
->
io_bio
, 
∑ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

432 i‡(
ªt
 !
bh
->
b_size
)

433 
submô_™d_ªåy
;

434 
	`wbc_accou¡_cgroup_ow√r
(
io
->
io_wbc
, 
∑ge
, 
bh
->
b_size
);

435 
io
->
io_√xt_block
++;

436 
	}
}

438 
	$pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

439 
∑ge
 *page,

440 
Àn
,

441 
wrôeback_c⁄åﬁ
 *
wbc
,

442 
boﬁ
 
kìp_towrôe
)

444 
∑ge
 *
boun˚_∑ge
 = 
NULL
;

445 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

446 
block_°¨t
;

447 
buf„r_hód
 *
bh
, *
hód
;

448 
ªt
 = 0;

449 
ƒ_submôãd
 = 0;

450 
ƒ_to_submô
 = 0;

452 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

453 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

455 i‡(
kìp_towrôe
)

456 
	`£t_∑ge_wrôeback_kìpwrôe
(
∑ge
);

458 
	`£t_∑ge_wrôeback
(
∑ge
);

459 
	`CÀ¨PageEº‹
(
∑ge
);

470 i‡(
Àn
 < 
PAGE_SIZE
)

471 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

479 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

481 
block_°¨t
 = 
	`bh_off£t
(
bh
);

482 i‡(
block_°¨t
 >
Àn
) {

483 
	`˛ór_buf„r_dúty
(
bh
);

484 
	`£t_buf„r_u±od©e
(
bh
);

487 i‡(!
	`buf„r_dúty
(
bh
Ë|| 
	`buf„r_dñay
(bh) ||

488 !
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)) {

490 i‡(!
	`buf„r_m≠≥d
(
bh
))

491 
	`˛ór_buf„r_dúty
(
bh
);

492 i‡(
io
->
io_bio
)

493 
	`pxt4_io_submô
(
io
);

496 i‡(
	`buf„r_√w
(
bh
))

497 
	`˛ór_buf„r_√w
(
bh
);

498 
	`£t_buf„r_async_wrôe
(
bh
);

499 
ƒ_to_submô
++;

500 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

502 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

511 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
Ë&& 
ƒ_to_submô
) {

512 
gÂ_t
 
gÂ_Êags
 = 
GFP_NOFS
;

513 
íc_byãs
 = 
	`round_up
(
Àn
, 
	`i_blocksize
(
öode
));

520 i‡(
io
->
io_bio
)

521 
gÂ_Êags
 = 
GFP_NOWAIT
 | 
__GFP_NOWARN
;

522 
ªåy_í¸y±
:

523 
boun˚_∑ge
 = 
	`fs¸y±_í¸y±_∑geˇche_blocks
(
∑ge
, 
íc_byãs
,

524 0, 
gÂ_Êags
);

525 i‡(
	`IS_ERR
(
boun˚_∑ge
)) {

526 
ªt
 = 
	`PTR_ERR
(
boun˚_∑ge
);

527 i‡(
ªt
 =-
ENOMEM
 &&

528 (
io
->
io_bio
 || 
wbc
->
sync_mode
 =
WB_SYNC_ALL
)) {

529 
gÂ_Êags
 = 
GFP_NOFS
;

530 i‡(
io
->
io_bio
)

531 
	`pxt4_io_submô
(
io
);

533 
gÂ_Êags
 |
__GFP_NOFAIL
;

534 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

535 
ªåy_í¸y±
;

538 
	`¥ötk_øãlimôed
(
KERN_ERR
 "%s:Ñë = %d\n", 
__func__
, 
ªt
);

539 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

541 
	`˛ór_buf„r_async_wrôe
(
bh
);

542 
bh
 = bh->
b_this_∑ge
;

543 } 
bh
 !
hód
);

544 
u∆ock
;

550 i‡(!
	`buf„r_async_wrôe
(
bh
))

552 
	`io_submô_add_bh
(
io
, 
öode
,

553 
boun˚_∑ge
 ? boun˚_∑gê: 
∑ge
, 
bh
);

554 
ƒ_submôãd
++;

555 
	`˛ór_buf„r_dúty
(
bh
);

556 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

558 
u∆ock
:

559 
	`u∆ock_∑ge
(
∑ge
);

561 i‡(!
ƒ_submôãd
)

562 
	`íd_∑ge_wrôeback
(
∑ge
);

563  
ªt
;

564 
	}
}

	@pxt4.h

17 #i‚de‡
_PXT4_H


18 
	#_PXT4_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/magic.h
>

23 
	~<löux/jbd3.h
>

24 
	~<löux/quŸa.h
>

25 
	~<löux/rw£m.h
>

26 
	~<löux/rbåì.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/muãx.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/vîsi⁄.h
>

31 
	~<löux/waô.h
>

32 
	~<löux/sched/sig«l.h
>

33 
	~<löux/blockgroup_lock.h
>

34 
	~<löux/≥r˝u_cou¡î.h
>

35 
	~<löux/øãlimô.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<löux/ÁŒoc.h
>

38 
	~<löux/≥r˝u-rw£m.h
>

39 #ifde‡
__KERNEL__


40 
	~<löux/com∑t.h
>

43 
	~<löux/fs¸y±.h
>

44 
	~<löux/fsvîôy.h
>

46 
	~<löux/compûî.h
>

56 
	#AGGRESSIVE_CHECK__


	)

62 
	#DOUBLE_CHECK__


	)

67 #unde‡
PXT4FS_DEBUG


72 #ifde‡
PXT4FS_DEBUG


73 
	#pxt4_debug
(
f
, 
a
...) \

75 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs DEBUG (%s, %d): %s:", \

76 
__FILE__
, 
__LINE__
, 
__func__
); \

77 
	`¥ötk
(
KERN_DEBUG
 
f
, ## 
a
); \

78 } 0)

	)

80 
	#pxt4_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

86 
	#EXT_DEBUG__


	)

87 #ifde‡
EXT_DEBUG


88 
	#ext_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

90 
	#ext_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

94 
	tpxt4_gΩblk_t
;

97 
	tpxt4_fsblk_t
;

100 
__u32
 
	tpxt4_lblk_t
;

103 
	tpxt4_group_t
;

105 
	eSHIFT_DIRECTION
 {

106 
	mSHIFT_LEFT
 = 0,

107 
	mSHIFT_RIGHT
,

118 
	#PXT4_MB_HINT_MERGE
 0x0001

	)

120 
	#PXT4_MB_HINT_RESERVED
 0x0002

	)

122 
	#PXT4_MB_HINT_METADATA
 0x0004

	)

124 
	#PXT4_MB_HINT_FIRST
 0x0008

	)

126 
	#PXT4_MB_HINT_BEST
 0x0010

	)

128 
	#PXT4_MB_HINT_DATA
 0x0020

	)

130 
	#PXT4_MB_HINT_NOPREALLOC
 0x0040

	)

132 
	#PXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

134 
	#PXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

136 
	#PXT4_MB_HINT_TRY_GOAL
 0x0200

	)

138 
	#PXT4_MB_DELALLOC_RESERVED
 0x0400

	)

140 
	#PXT4_MB_STREAM_ALLOC
 0x0800

	)

142 
	#PXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

144 
	#PXT4_MB_USE_RESERVED
 0x2000

	)

146 
	spxt4_Æloˇti⁄_ªque°
 {

148 
öode
 *
	möode
;

150 
	mÀn
;

152 
pxt4_lblk_t
 
	mlogiˇl
;

154 
pxt4_lblk_t
 
	mŒe·
;

156 
pxt4_lblk_t
 
	mÃight
;

158 
pxt4_fsblk_t
 
	mgﬂl
;

160 
pxt4_fsblk_t
 
	m∂e·
;

162 
pxt4_fsblk_t
 
	m¥ight
;

164 
	mÊags
;

174 
	#PXT4_MAP_NEW
 (1 << 
BH_New
)

	)

175 
	#PXT4_MAP_MAPPED
 (1 << 
BH_M≠≥d
)

	)

176 
	#PXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwrôãn
)

	)

177 
	#PXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¨y
)

	)

178 
	#PXT4_MAP_FLAGS
 (
PXT4_MAP_NEW
 | 
PXT4_MAP_MAPPED
 |\

179 
PXT4_MAP_UNWRITTEN
 | 
PXT4_MAP_BOUNDARY
)

	)

181 
	spxt4_m≠_blocks
 {

182 
pxt4_fsblk_t
 
	mm_pblk
;

183 
pxt4_lblk_t
 
	mm_lblk
;

184 
	mm_Àn
;

185 
	mm_Êags
;

191 
	spxt4_sy°em_blocks
 {

192 
rb_roŸ
 
	mroŸ
;

193 
rcu_hód
 
	mrcu
;

199 
	#PXT4_IO_END_UNWRITTEN
 0x0001

	)

201 
	spxt4_io_íd_vec
 {

202 
li°_hód
 
	mli°
;

203 
loff_t
 
	moff£t
;

204 
ssize_t
 
	msize
;

211 
	spxt4_io_íd
 {

212 
li°_hód
 
	mli°
;

213 
h™dÀ_t
 *
	mh™dÀ
;

215 
öode
 *
	möode
;

216 
bio
 *
	mbio
;

218 
	mÊag
;

219 
©omic_t
 
	mcou¡
;

220 
li°_hód
 
	mli°_vec
;

221 } 
	tpxt4_io_íd_t
;

223 
	spxt4_io_submô
 {

224 
wrôeback_c⁄åﬁ
 *
	mio_wbc
;

225 
bio
 *
	mio_bio
;

226 
pxt4_io_íd_t
 *
	mio_íd
;

227 
£˘‹_t
 
	mio_√xt_block
;

233 
	#PXT4_BAD_INO
 1

	)

234 
	#PXT4_ROOT_INO
 2

	)

235 
	#PXT4_USR_QUOTA_INO
 3

	)

236 
	#PXT4_GRP_QUOTA_INO
 4

	)

237 
	#PXT4_BOOT_LOADER_INO
 5

	)

238 
	#PXT4_UNDEL_DIR_INO
 6

	)

239 
	#PXT4_RESIZE_INO
 7

	)

240 
	#PXT4_JOURNAL_INO
 8

	)

243 
	#PXT4_GOOD_OLD_FIRST_INO
 11

	)

248 
	#PXT4_LINK_MAX
 65000

	)

253 
	#PXT4_MIN_BLOCK_SIZE
 1024

	)

254 
	#PXT4_MAX_BLOCK_SIZE
 65536

	)

255 
	#PXT4_MIN_BLOCK_LOG_SIZE
 10

	)

256 
	#PXT4_MAX_BLOCK_LOG_SIZE
 16

	)

257 
	#PXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

258 #ifde‡
__KERNEL__


259 
	#PXT4_BLOCK_SIZE
(
s
Ë((s)->
s_blocksize
)

	)

261 
	#PXT4_BLOCK_SIZE
(
s
Ë(
PXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

263 
	#PXT4_ADDR_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ (
__u32
))

	)

264 
	#PXT4_CLUSTER_SIZE
(
s
Ë(
	`PXT4_BLOCK_SIZE
(s) << \

265 
	`PXT4_SB
(
s
)->
s_˛u°î_bôs
)

	)

266 #ifde‡
__KERNEL__


267 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_blocksize_bôs
)

	)

268 
	#PXT4_CLUSTER_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°î_bôs
)

	)

270 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_log_block_size
 + 10)

	)

272 #ifde‡
__KERNEL__


273 
	#PXT4_ADDR_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_addr_≥r_block_bôs
)

	)

274 
	#PXT4_INODE_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_öode_size
)

	)

275 
	#PXT4_FIRST_INO
(
s
Ë(
	`PXT4_SB
(s)->
s_fú°_öo
)

	)

277 
	#PXT4_INODE_SIZE
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

278 
PXT4_GOOD_OLD_INODE_SIZE
 : \

279 (
s
)->
s_öode_size
)

	)

280 
	#PXT4_FIRST_INO
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

281 
PXT4_GOOD_OLD_FIRST_INO
 : \

282 (
s
)->
s_fú°_öo
)

	)

284 
	#PXT4_BLOCK_ALIGN
(
size
, 
blkbôs
Ë
	`ALIGN
((size), (1 << (blkbôs)))

	)

285 
	#PXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkbôs
) \

286 ((
	`PXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkbôs
) >> blkbits) - (offset >> \

287 
blkbôs
))

	)

290 
	#PXT4_B2C
(
sbi
, 
blk
Ë((blkË>> (sbi)->
s_˛u°î_bôs
)

	)

292 
	#PXT4_C2B
(
sbi
, 
˛u°î
Ë((˛u°îË<< (sbi)->
s_˛u°î_bôs
)

	)

294 
	#PXT4_NUM_B2C
(
sbi
, 
blks
Ë(((blksË+ (sbi)->
s_˛u°î_øtio
 - 1) >> \

295 (
sbi
)->
s_˛u°î_bôs
)

	)

297 
	#PXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

298 ~((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

299 
	#PXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

300 ~((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

302 
	#PXT4_LBLK_CFILL
(
sbi
, 
lblk
) ((lblk) | \

303 ((
pxt4_lblk_t
Ë(
sbi
)->
s_˛u°î_øtio
 - 1))

	)

305 
	#PXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

306 ((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

307 
	#PXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

308 ((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

313 
	spxt4_group_desc


315 
__À32
 
	mbg_block_bôm≠_lo
;

316 
__À32
 
	mbg_öode_bôm≠_lo
;

317 
__À32
 
	mbg_öode_èbÀ_lo
;

318 
__À16
 
	mbg_‰ì_blocks_cou¡_lo
;

319 
__À16
 
	mbg_‰ì_öodes_cou¡_lo
;

320 
__À16
 
	mbg_u£d_dús_cou¡_lo
;

321 
__À16
 
	mbg_Êags
;

322 
__À32
 
	mbg_ex˛ude_bôm≠_lo
;

323 
__À16
 
	mbg_block_bôm≠_csum_lo
;

324 
__À16
 
	mbg_öode_bôm≠_csum_lo
;

325 
__À16
 
	mbg_ôabÀ_unu£d_lo
;

326 
__À16
 
	mbg_checksum
;

327 
__À32
 
	mbg_block_bôm≠_hi
;

328 
__À32
 
	mbg_öode_bôm≠_hi
;

329 
__À32
 
	mbg_öode_èbÀ_hi
;

330 
__À16
 
	mbg_‰ì_blocks_cou¡_hi
;

331 
__À16
 
	mbg_‰ì_öodes_cou¡_hi
;

332 
__À16
 
	mbg_u£d_dús_cou¡_hi
;

333 
__À16
 
	mbg_ôabÀ_unu£d_hi
;

334 
__À32
 
	mbg_ex˛ude_bôm≠_hi
;

335 
__À16
 
	mbg_block_bôm≠_csum_hi
;

336 
__À16
 
	mbg_öode_bôm≠_csum_hi
;

337 
__u32
 
	mbg_ª£rved
;

340 
	#PXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

341 (
	`off£tof
(
pxt4_group_desc
, 
bg_öode_bôm≠_csum_hi
) + \

342 (
__À16
))

	)

343 
	#PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

344 (
	`off£tof
(
pxt4_group_desc
, 
bg_block_bôm≠_csum_hi
) + \

345 (
__À16
))

	)

351 
	sÊex_groups
 {

352 
©omic64_t
 
	m‰ì_˛u°îs
;

353 
©omic_t
 
	m‰ì_öodes
;

354 
©omic_t
 
	mu£d_dús
;

357 
	#PXT4_BG_INODE_UNINIT
 0x0001

	)

358 
	#PXT4_BG_BLOCK_UNINIT
 0x0002

	)

359 
	#PXT4_BG_INODE_ZEROED
 0x0004

	)

364 
	#PXT4_MIN_DESC_SIZE
 32

	)

365 
	#PXT4_MIN_DESC_SIZE_64BIT
 64

	)

366 
	#PXT4_MAX_DESC_SIZE
 
PXT4_MIN_BLOCK_SIZE


	)

367 
	#PXT4_DESC_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_size
)

	)

368 #ifde‡
__KERNEL__


369 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_blocks_≥r_group
)

	)

370 
	#PXT4_CLUSTERS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°îs_≥r_group
)

	)

371 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block
)

	)

372 
	#PXT4_INODES_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_öodes_≥r_group
)

	)

373 
	#PXT4_DESC_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block_bôs
)

	)

375 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë((s)->
s_blocks_≥r_group
)

	)

376 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ 
	`PXT4_DESC_SIZE
(s))

	)

377 
	#PXT4_INODES_PER_GROUP
(
s
Ë((s)->
s_öodes_≥r_group
)

	)

383 
	#PXT4_NDIR_BLOCKS
 12

	)

384 
	#PXT4_IND_BLOCK
 
PXT4_NDIR_BLOCKS


	)

385 
	#PXT4_DIND_BLOCK
 (
PXT4_IND_BLOCK
 + 1)

	)

386 
	#PXT4_TIND_BLOCK
 (
PXT4_DIND_BLOCK
 + 1)

	)

387 
	#PXT4_N_BLOCKS
 (
PXT4_TIND_BLOCK
 + 1)

	)

392 
	#PXT4_SECRM_FL
 0x00000001

	)

393 
	#PXT4_UNRM_FL
 0x00000002

	)

394 
	#PXT4_COMPR_FL
 0x00000004

	)

395 
	#PXT4_SYNC_FL
 0x00000008

	)

396 
	#PXT4_IMMUTABLE_FL
 0x00000010

	)

397 
	#PXT4_APPEND_FL
 0x00000020

	)

398 
	#PXT4_NODUMP_FL
 0x00000040

	)

399 
	#PXT4_NOATIME_FL
 0x00000080

	)

401 
	#PXT4_DIRTY_FL
 0x00000100

	)

402 
	#PXT4_COMPRBLK_FL
 0x00000200

	)

403 
	#PXT4_NOCOMPR_FL
 0x00000400

	)

405 
	#PXT4_ENCRYPT_FL
 0x00000800

	)

407 
	#PXT4_INDEX_FL
 0x00001000

	)

408 
	#PXT4_IMAGIC_FL
 0x00002000

	)

409 
	#PXT4_JOURNAL_DATA_FL
 0x00004000

	)

410 
	#PXT4_NOTAIL_FL
 0x00008000

	)

411 
	#PXT4_DIRSYNC_FL
 0x00010000

	)

412 
	#PXT4_TOPDIR_FL
 0x00020000

	)

413 
	#PXT4_HUGE_FILE_FL
 0x00040000

	)

414 
	#PXT4_EXTENTS_FL
 0x00080000

	)

415 
	#PXT4_VERITY_FL
 0x00100000

	)

416 
	#PXT4_EA_INODE_FL
 0x00200000

	)

417 
	#PXT4_EOFBLOCKS_FL
 0x00400000

	)

418 
	#PXT4_INLINE_DATA_FL
 0x10000000

	)

419 
	#PXT4_PROJINHERIT_FL
 0x20000000

	)

420 
	#PXT4_CASEFOLD_FL
 0x40000000

	)

421 
	#PXT4_RESERVED_FL
 0x80000000

	)

423 
	#PXT4_FL_USER_VISIBLE
 0x705BDFFF

	)

424 
	#PXT4_FL_USER_MODIFIABLE
 0x604BC0FF

	)

427 
	#PXT4_FL_XFLAG_VISIBLE
 (
PXT4_SYNC_FL
 | \

428 
PXT4_IMMUTABLE_FL
 | \

429 
PXT4_APPEND_FL
 | \

430 
PXT4_NODUMP_FL
 | \

431 
PXT4_NOATIME_FL
 | \

432 
PXT4_PROJINHERIT_FL
)

	)

435 
	#PXT4_FL_INHERITED
 (
PXT4_SECRM_FL
 | 
PXT4_UNRM_FL
 | 
PXT4_COMPR_FL
 |\

436 
PXT4_SYNC_FL
 | 
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
 |\

437 
PXT4_NOCOMPR_FL
 | 
PXT4_JOURNAL_DATA_FL
 |\

438 
PXT4_NOTAIL_FL
 | 
PXT4_DIRSYNC_FL
 |\

439 
PXT4_PROJINHERIT_FL
 | 
PXT4_CASEFOLD_FL
)

	)

442 
	#PXT4_REG_FLMASK
 (~(
PXT4_DIRSYNC_FL
 | 
PXT4_TOPDIR_FL
 | 
PXT4_CASEFOLD_FL
 |\

443 
PXT4_PROJINHERIT_FL
))

	)

446 
	#PXT4_OTHER_FLMASK
 (
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
)

	)

449 
	#PXT4_FL_SHOULD_SWAP
 (
PXT4_HUGE_FILE_FL
 | 
PXT4_EXTENTS_FL
)

	)

452 
ölöe
 
__u32
 
	$pxt4_mask_Êags
(
umode_t
 
mode
, 
__u32
 
Êags
)

454 i‡(
	`S_ISDIR
(
mode
))

455  
Êags
;

456 i‡(
	`S_ISREG
(
mode
))

457  
Êags
 & 
PXT4_REG_FLMASK
;

459  
Êags
 & 
PXT4_OTHER_FLMASK
;

460 
	}
}

466 
	mPXT4_INODE_SECRM
 = 0,

467 
	mPXT4_INODE_UNRM
 = 1,

468 
	mPXT4_INODE_COMPR
 = 2,

469 
	mPXT4_INODE_SYNC
 = 3,

470 
	mPXT4_INODE_IMMUTABLE
 = 4,

471 
	mPXT4_INODE_APPEND
 = 5,

472 
	mPXT4_INODE_NODUMP
 = 6,

473 
	mPXT4_INODE_NOATIME
 = 7,

475 
	mPXT4_INODE_DIRTY
 = 8,

476 
	mPXT4_INODE_COMPRBLK
 = 9,

477 
	mPXT4_INODE_NOCOMPR
 = 10,

478 
	mPXT4_INODE_ENCRYPT
 = 11,

480 
	mPXT4_INODE_INDEX
 = 12,

481 
	mPXT4_INODE_IMAGIC
 = 13,

482 
	mPXT4_INODE_JOURNAL_DATA
 = 14,

483 
	mPXT4_INODE_NOTAIL
 = 15,

484 
	mPXT4_INODE_DIRSYNC
 = 16,

485 
	mPXT4_INODE_TOPDIR
 = 17,

486 
	mPXT4_INODE_HUGE_FILE
 = 18,

487 
	mPXT4_INODE_EXTENTS
 = 19,

488 
	mPXT4_INODE_VERITY
 = 20,

489 
	mPXT4_INODE_EA_INODE
 = 21,

490 
	mPXT4_INODE_EOFBLOCKS
 = 22,

491 
	mPXT4_INODE_INLINE_DATA
 = 28,

492 
	mPXT4_INODE_PROJINHERIT
 = 29,

493 
	mPXT4_INODE_RESERVED
 = 31,

509 
	#TEST_FLAG_VALUE
(
FLAG
Ë(
PXT4_
##FLAG##
_FL
 =(1 << 
PXT4_INODE_
##FLAG))

	)

510 
	#CHECK_FLAG_VALUE
(
FLAG
Ë
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

512 
ölöe
 
	$pxt4_check_Êag_vÆues
()

514 
	`CHECK_FLAG_VALUE
(
SECRM
);

515 
	`CHECK_FLAG_VALUE
(
UNRM
);

516 
	`CHECK_FLAG_VALUE
(
COMPR
);

517 
	`CHECK_FLAG_VALUE
(
SYNC
);

518 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

519 
	`CHECK_FLAG_VALUE
(
APPEND
);

520 
	`CHECK_FLAG_VALUE
(
NODUMP
);

521 
	`CHECK_FLAG_VALUE
(
NOATIME
);

522 
	`CHECK_FLAG_VALUE
(
DIRTY
);

523 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

524 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

525 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

526 
	`CHECK_FLAG_VALUE
(
INDEX
);

527 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

528 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

529 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

530 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

531 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

532 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

533 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

534 
	`CHECK_FLAG_VALUE
(
VERITY
);

535 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

536 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

537 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

538 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

539 
	`CHECK_FLAG_VALUE
(
RESERVED
);

540 
	}
}

543 
	spxt4_√w_group_öput
 {

544 
__u32
 
	mgroup
;

545 
__u64
 
	mblock_bôm≠
;

546 
__u64
 
	möode_bôm≠
;

547 
__u64
 
	möode_èbÀ
;

548 
__u32
 
	mblocks_cou¡
;

549 
__u16
 
	mª£rved_blocks
;

550 
__u16
 
	munu£d
;

553 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

554 
	scom∑t_pxt4_√w_group_öput
 {

555 
u32
 
	mgroup
;

556 
com∑t_u64
 
	mblock_bôm≠
;

557 
com∑t_u64
 
	möode_bôm≠
;

558 
com∑t_u64
 
	möode_èbÀ
;

559 
u32
 
	mblocks_cou¡
;

560 
u16
 
	mª£rved_blocks
;

561 
u16
 
	munu£d
;

566 
	spxt4_√w_group_d©a
 {

567 
__u32
 
	mgroup
;

568 
__u64
 
	mblock_bôm≠
;

569 
__u64
 
	möode_bôm≠
;

570 
__u64
 
	möode_èbÀ
;

571 
__u32
 
	mblocks_cou¡
;

572 
__u16
 
	mª£rved_blocks
;

573 
__u16
 
	mmd©a_blocks
;

574 
__u32
 
	m‰ì_˛u°îs_cou¡
;

579 
	mBLOCK_BITMAP
 = 0,

580 
	mINODE_BITMAP
,

581 
	mINODE_TABLE
,

582 
	mGROUP_TABLE_COUNT
,

590 
	#PXT4_GET_BLOCKS_CREATE
 0x0001

	)

592 
	#PXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

593 
	#PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
PXT4_GET_BLOCKS_UNWRIT_EXT
|\

594 
PXT4_GET_BLOCKS_CREATE
)

	)

597 
	#PXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

601 
	#PXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

602 
	#PXT4_GET_BLOCKS_CONVERT
 0x0010

	)

603 
	#PXT4_GET_BLOCKS_IO_CREATE_EXT
 (
PXT4_GET_BLOCKS_PRE_IO
|\

604 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

606 
	#PXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
PXT4_GET_BLOCKS_CONVERT
|\

607 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

610 
	#PXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

612 
	#PXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

614 
	#PXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

616 
	#PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

618 
	#PXT4_GET_BLOCKS_ZERO
 0x0200

	)

619 
	#PXT4_GET_BLOCKS_CREATE_ZERO
 (
PXT4_GET_BLOCKS_CREATE
 |\

620 
PXT4_GET_BLOCKS_ZERO
)

	)

623 
	#PXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

634 
	#PXT4_EX_NOCACHE
 0x40000000

	)

635 
	#PXT4_EX_FORCE_CACHE
 0x20000000

	)

640 
	#PXT4_FREE_BLOCKS_METADATA
 0x0001

	)

641 
	#PXT4_FREE_BLOCKS_FORGET
 0x0002

	)

642 
	#PXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

643 
	#PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

644 
	#PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

645 
	#PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

646 
	#PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

651 
	#PXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

652 
	#PXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

653 
	#PXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

654 
	#PXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

655 
	#PXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

656 
	#PXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

657 
	#PXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

658 
	#PXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

659 
	#PXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

660 
	#PXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
pxt4_√w_group_öput
)

	)

661 
	#PXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

664 
	#PXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

665 
	#PXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_exã¡
)

	)

666 
	#PXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

667 
	#PXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

668 
	#PXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

669 
	#PXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

670 
	#PXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

671 
	#PXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

673 
	#PXT4_IOC_CLEAR_ES_CACHE
 
	`_IO
('f', 40)

	)

674 
	#PXT4_IOC_GETSTATE
 
	`_IOW
('f', 41, 
__u32
)

	)

675 
	#PXT4_IOC_GET_ES_CACHE
 
	`_IOWR
('f', 42, 
fõm≠
)

	)

677 
	#PXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

678 
	#PXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

680 
	#PXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

685 
	#PXT4_GOING_FLAGS_DEFAULT
 0x0

	)

686 
	#PXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

687 
	#PXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

695 
	#PXT4_STATE_FLAG_EXT_PRECACHED
 0x00000001

	)

696 
	#PXT4_STATE_FLAG_NEW
 0x00000002

	)

697 
	#PXT4_STATE_FLAG_NEWENTRY
 0x00000004

	)

698 
	#PXT4_STATE_FLAG_DA_ALLOC_CLOSE
 0x00000008

	)

700 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

704 
	#PXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

705 
	#PXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

706 
	#PXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

707 
	#PXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

708 
	#PXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

709 
	#PXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

710 
	#PXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

711 
	#PXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com∑t_pxt4_√w_group_öput
)

	)

712 
	#PXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

713 
	#PXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

720 
	#PXT4_FIEMAP_EXTENT_HOLE
 0x08000000

	)

723 
	#PXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

726 
	#PXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFF

	)

731 
	spxt4_öode
 {

732 
__À16
 
	mi_mode
;

733 
__À16
 
	mi_uid
;

734 
__À32
 
	mi_size_lo
;

735 
__À32
 
	mi_©ime
;

736 
__À32
 
	mi_˘ime
;

737 
__À32
 
	mi_mtime
;

738 
__À32
 
	mi_dtime
;

739 
__À16
 
	mi_gid
;

740 
__À16
 
	mi_löks_cou¡
;

741 
__À32
 
	mi_blocks_lo
;

742 
__À32
 
	mi_Êags
;

745 
__À32
 
	ml_i_vîsi⁄
;

746 } 
	mlöux1
;

748 
__u32
 
	mh_i_å™¶©‹
;

749 } 
	mhurd1
;

751 
__u32
 
	mm_i_ª£rved1
;

752 } 
	mmasix1
;

753 } 
	mosd1
;

754 
__À32
 
	mi_block
[
PXT4_N_BLOCKS
];

755 
__À32
 
	mi_gíî©i⁄
;

756 
__À32
 
	mi_fûe_a˛_lo
;

757 
__À32
 
	mi_size_high
;

758 
__À32
 
	mi_obso_Áddr
;

761 
__À16
 
	ml_i_blocks_high
;

762 
__À16
 
	ml_i_fûe_a˛_high
;

763 
__À16
 
	ml_i_uid_high
;

764 
__À16
 
	ml_i_gid_high
;

765 
__À16
 
	ml_i_checksum_lo
;

766 
__À16
 
	ml_i_ª£rved
;

767 } 
	mlöux2
;

769 
__À16
 
	mh_i_ª£rved1
;

770 
__u16
 
	mh_i_mode_high
;

771 
__u16
 
	mh_i_uid_high
;

772 
__u16
 
	mh_i_gid_high
;

773 
__u32
 
	mh_i_auth‹
;

774 } 
	mhurd2
;

776 
__À16
 
	mh_i_ª£rved1
;

777 
__À16
 
	mm_i_fûe_a˛_high
;

778 
__u32
 
	mm_i_ª£rved2
[2];

779 } 
	mmasix2
;

780 } 
	mosd2
;

781 
__À16
 
	mi_exåa_isize
;

782 
__À16
 
	mi_checksum_hi
;

783 
__À32
 
	mi_˘ime_exåa
;

784 
__À32
 
	mi_mtime_exåa
;

785 
__À32
 
	mi_©ime_exåa
;

786 
__À32
 
	mi_¸time
;

787 
__À32
 
	mi_¸time_exåa
;

788 
__À32
 
	mi_vîsi⁄_hi
;

789 
__À32
 
	mi_¥ojid
;

792 
	smove_exã¡
 {

793 
__u32
 
	mª£rved
;

794 
__u32
 
	md⁄‹_fd
;

795 
__u64
 
	m‹ig_°¨t
;

796 
__u64
 
	md⁄‹_°¨t
;

797 
__u64
 
	mÀn
;

798 
__u64
 
	mmoved_Àn
;

801 
	#PXT4_EPOCH_BITS
 2

	)

802 
	#PXT4_EPOCH_MASK
 ((1 << 
PXT4_EPOCH_BITS
Ë- 1)

	)

803 
	#PXT4_NSEC_MASK
 (~0UL << 
PXT4_EPOCH_BITS
)

	)

815 
	#PXT4_FITS_IN_INODE
(
pxt4_öode
, 
eöode
, 
fõld
) \

816 ((
	`off£tof
(
	`ty≥of
(*
pxt4_öode
), 
fõld
) + \

817 ((
pxt4_öode
)->
fõld
)) \

818 <(
PXT4_GOOD_OLD_INODE_SIZE
 + \

819 (
eöode
)->
i_exåa_isize
)) \

820 

	)

842 
ölöe
 
__À32
 
	$pxt4_ícode_exåa_time
(
time•ec64
 *
time
)

844 
u32
 
exåa
 =((
time
->
tv_£c
 - (
s32
Èime->tv_£cË>> 32Ë& 
PXT4_EPOCH_MASK
;

845  
	`˝u_to_À32
(
exåa
 | (
time
->
tv_n£c
 << 
PXT4_EPOCH_BITS
));

846 
	}
}

848 
ölöe
 
	$pxt4_decode_exåa_time
(
time•ec64
 *
time
,

849 
__À32
 
exåa
)

851 i‡(
	`u∆ikñy
(
exåa
 & 
	`˝u_to_À32
(
PXT4_EPOCH_MASK
)))

852 
time
->
tv_£c
 +(
u64
)(
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
) << 32;

853 
time
->
tv_n£c
 = (
	`À32_to_˝u
(
exåa
Ë& 
PXT4_NSEC_MASK
Ë>> 
PXT4_EPOCH_BITS
;

854 
	}
}

856 
	#PXT4_INODE_SET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

858 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) {\

859 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
öode
)->xtime.
tv_£c
); \

860 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

861 
	`pxt4_ícode_exåa_time
(&(
öode
)->
xtime
); \

864 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
(
	`˛amp_t
(
öt32_t
, (
öode
)->xtime.
tv_£c
, 
S32_MIN
, 
S32_MAX
)); \

865 } 0)

	)

867 
	#PXT4_EINODE_SET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

869 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

870 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
eöode
)->xtime.
tv_£c
); \

871 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

872 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

873 
	`pxt4_ícode_exåa_time
(&(
eöode
)->
xtime
); \

874 } 0)

	)

876 
	#PXT4_INODE_GET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

878 (
öode
)->
xtime
.
tv_£c
 = (sig√d)
	`À32_to_˝u
((
øw_öode
)->xtime); \

879 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) { \

880 
	`pxt4_decode_exåa_time
(&(
öode
)->
xtime
, \

881 
øw_öode
->
xtime
 ## 
_exåa
); \

884 (
öode
)->
xtime
.
tv_n£c
 = 0; \

885 } 0)

	)

888 
	#PXT4_EINODE_GET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

890 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

891 (
eöode
)->
xtime
.
tv_£c
 = \

892 (sig√d)
	`À32_to_˝u
((
øw_öode
)->
xtime
); \

894 (
eöode
)->
xtime
.
tv_£c
 = 0; \

895 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

896 
	`pxt4_decode_exåa_time
(&(
eöode
)->
xtime
, \

897 
øw_öode
->
xtime
 ## 
_exåa
); \

899 (
eöode
)->
xtime
.
tv_n£c
 = 0; \

900 } 0)

	)

902 
	#i_disk_vîsi⁄
 
osd1
.
löux1
.
l_i_vîsi⁄


	)

904 #i‡
deföed
(
__KERNEL__
Ë|| deföed(
__löux__
)

905 
	#i_ª£rved1
 
osd1
.
löux1
.
l_i_ª£rved1


	)

906 
	#i_fûe_a˛_high
 
osd2
.
löux2
.
l_i_fûe_a˛_high


	)

907 
	#i_blocks_high
 
osd2
.
löux2
.
l_i_blocks_high


	)

908 
	#i_uid_low
 
i_uid


	)

909 
	#i_gid_low
 
i_gid


	)

910 
	#i_uid_high
 
osd2
.
löux2
.
l_i_uid_high


	)

911 
	#i_gid_high
 
osd2
.
löux2
.
l_i_gid_high


	)

912 
	#i_checksum_lo
 
osd2
.
löux2
.
l_i_checksum_lo


	)

914 #ñi‡
deföed
(
__GNU__
)

916 
	#i_å™¶©‹
 
osd1
.
hurd1
.
h_i_å™¶©‹


	)

917 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

918 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

919 
	#i_auth‹
 
osd2
.
hurd2
.
h_i_auth‹


	)

921 #ñi‡
deföed
(
__masix__
)

923 
	#i_ª£rved1
 
osd1
.
masix1
.
m_i_ª£rved1


	)

924 
	#i_fûe_a˛_high
 
osd2
.
masix2
.
m_i_fûe_a˛_high


	)

925 
	#i_ª£rved2
 
osd2
.
masix2
.
m_i_ª£rved2


	)

929 
	~"exã¡s_°©us.h
"

948 
	mI_DATA_SEM_NORMAL
 = 0,

949 
	mI_DATA_SEM_OTHER
,

950 
	mI_DATA_SEM_QUOTA
,

957 
	spxt4_öode_öfo
 {

958 
__À32
 
	mi_d©a
[15];

959 
__u32
 
	mi_dtime
;

960 
pxt4_fsblk_t
 
	mi_fûe_a˛
;

969 
pxt4_group_t
 
	mi_block_group
;

970 
pxt4_lblk_t
 
	mi_dú_°¨t_lookup
;

971 #i‡(
BITS_PER_LONG
 < 64)

972 
	mi_°©e_Êags
;

974 
	mi_Êags
;

983 
rw_£m≠h‹e
 
	mx©å_£m
;

985 
li°_hód
 
	mi_‹ph™
;

1002 
loff_t
 
	mi_disksize
;

1014 
rw_£m≠h‹e
 
	mi_d©a_£m
;

1023 
rw_£m≠h‹e
 
	mi_mm≠_£m
;

1024 
öode
 
	mvfs_öode
;

1025 
jbd3_öode
 *
	mjöode
;

1027 
•ölock_t
 
	mi_øw_lock
;

1033 
time•ec64
 
	mi_¸time
;

1036 
li°_hód
 
	mi_¥óŒoc_li°
;

1037 
•ölock_t
 
	mi_¥óŒoc_lock
;

1040 
pxt4_es_åì
 
	mi_es_åì
;

1041 
rwlock_t
 
	mi_es_lock
;

1042 
li°_hód
 
	mi_es_li°
;

1043 
	mi_es_Æl_ƒ
;

1044 
	mi_es_shk_ƒ
;

1045 
pxt4_lblk_t
 
	mi_es_shrök_lblk
;

1050 
pxt4_group_t
 
	mi_œ°_Æloc_group
;

1054 
	mi_ª£rved_d©a_blocks
;

1055 
pxt4_lblk_t
 
	mi_da_mëad©a_ˇlc_œ°_lblock
;

1056 
	mi_da_mëad©a_ˇlc_Àn
;

1059 
pxt4_≥ndög_åì
 
	mi_≥ndög_åì
;

1062 
__u16
 
	mi_exåa_isize
;

1065 
u16
 
	mi_ölöe_off
;

1066 
u16
 
	mi_ölöe_size
;

1068 #ifde‡
CONFIG_QUOTA


1070 
qsize_t
 
	mi_ª£rved_quŸa
;

1074 
•ölock_t
 
	mi_com∂ëed_io_lock
;

1079 
li°_hód
 
	mi_rsv_c⁄vîsi⁄_li°
;

1080 
w‹k_°ru˘
 
	mi_rsv_c⁄vîsi⁄_w‹k
;

1081 
©omic_t
 
	mi_unwrôãn
;

1083 
•ölock_t
 
	mi_block_ª£rv©i⁄_lock
;

1089 
tid_t
 
	mi_sync_tid
;

1090 
tid_t
 
	mi_d©async_tid
;

1092 #ifde‡
CONFIG_QUOTA


1093 
dquŸ
 *
	mi_dquŸ
[
MAXQUOTAS
];

1097 
__u32
 
	mi_csum_£ed
;

1099 
k¥ojid_t
 
	mi_¥ojid
;

1105 
	#PXT4_VALID_FS
 0x0001

	)

1106 
	#PXT4_ERROR_FS
 0x0002

	)

1107 
	#PXT4_ORPHAN_FS
 0x0004

	)

1112 
	#PXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1113 
	#PXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1114 
	#PXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1119 
	#PXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1120 
	#PXT4_MOUNT_GRPID
 0x00004

	)

1121 
	#PXT4_MOUNT_DEBUG
 0x00008

	)

1122 
	#PXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1123 
	#PXT4_MOUNT_ERRORS_RO
 0x00020

	)

1124 
	#PXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1125 
	#PXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1126 
	#PXT4_MOUNT_MINIX_DF
 0x00080

	)

1127 
	#PXT4_MOUNT_NOLOAD
 0x00100

	)

1128 #ifde‡
CONFIG_FS_DAX


1129 
	#PXT4_MOUNT_DAX
 0x00200

	)

1131 
	#PXT4_MOUNT_DAX
 0

	)

1133 
	#PXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1134 
	#PXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1135 
	#PXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1136 
	#PXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1137 
	#PXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1138 
	#PXT4_MOUNT_NO_UID32
 0x02000

	)

1139 
	#PXT4_MOUNT_XATTR_USER
 0x04000

	)

1140 
	#PXT4_MOUNT_POSIX_ACL
 0x08000

	)

1141 
	#PXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1142 
	#PXT4_MOUNT_BARRIER
 0x20000

	)

1143 
	#PXT4_MOUNT_QUOTA
 0x40000

	)

1144 
	#PXT4_MOUNT_USRQUOTA
 0x80000

	)

1147 
	#PXT4_MOUNT_GRPQUOTA
 0x100000

	)

1150 
	#PXT4_MOUNT_PRJQUOTA
 0x200000

	)

1152 
	#PXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1153 
	#PXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1154 
	#PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1155 
	#PXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1156 
	#PXT4_MOUNT_DELALLOC
 0x8000000

	)

1157 
	#PXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1158 
	#PXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1159 
	#PXT4_MOUNT_DISCARD
 0x40000000

	)

1160 
	#PXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1167 
	#PXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1169 
	#PXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1172 
	#PXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1175 
	#PXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1178 
	#˛ór_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 &= \

1179 ~
PXT4_MOUNT_
##
›t


	)

1180 
	#£t_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 |= \

1181 
PXT4_MOUNT_
##
›t


	)

1182 
	#ã°_›t
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t
 & \

1183 
PXT4_MOUNT_
##
›t
)

	)

1185 
	#˛ór_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 &= \

1186 ~
PXT4_MOUNT2_
##
›t


	)

1187 
	#£t_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 |= \

1188 
PXT4_MOUNT2_
##
›t


	)

1189 
	#ã°_›t2
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t2
 & \

1190 
PXT4_MOUNT2_
##
›t
)

	)

1192 
	#pxt4_ã°_™d_£t_bô
 
__ã°_™d_£t_bô_À


	)

1193 
	#pxt4_£t_bô
 
__£t_bô_À


	)

1194 
	#pxt4_£t_bô_©omic
 
pxt2_£t_bô_©omic


	)

1195 
	#pxt4_ã°_™d_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

1196 
	#pxt4_˛ór_bô
 
__˛ór_bô_À


	)

1197 
	#pxt4_˛ór_bô_©omic
 
pxt2_˛ór_bô_©omic


	)

1198 
	#pxt4_ã°_bô
 
ã°_bô_À


	)

1199 
	#pxt4_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

1200 
	#pxt4_föd_√xt_bô
 
föd_√xt_bô_À


	)

1202 
pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
);

1207 
	#PXT4_DFL_MAX_MNT_COUNT
 20

	)

1208 
	#PXT4_DFL_CHECKINTERVAL
 0

	)

1213 
	#PXT4_ERRORS_CONTINUE
 1

	)

1214 
	#PXT4_ERRORS_RO
 2

	)

1215 
	#PXT4_ERRORS_PANIC
 3

	)

1216 
	#PXT4_ERRORS_DEFAULT
 
PXT4_ERRORS_CONTINUE


	)

1219 
	#PXT4_CRC32C_CHKSUM
 1

	)

1224 
	spxt4_su≥r_block
 {

1225  
__À32
 
	ms_öodes_cou¡
;

1226 
__À32
 
	ms_blocks_cou¡_lo
;

1227 
__À32
 
	ms_r_blocks_cou¡_lo
;

1228 
__À32
 
	ms_‰ì_blocks_cou¡_lo
;

1229  
__À32
 
	ms_‰ì_öodes_cou¡
;

1230 
__À32
 
	ms_fú°_d©a_block
;

1231 
__À32
 
	ms_log_block_size
;

1232 
__À32
 
	ms_log_˛u°î_size
;

1233  
__À32
 
	ms_blocks_≥r_group
;

1234 
__À32
 
	ms_˛u°îs_≥r_group
;

1235 
__À32
 
	ms_öodes_≥r_group
;

1236 
__À32
 
	ms_mtime
;

1237  
__À32
 
	ms_wtime
;

1238 
__À16
 
	ms_m¡_cou¡
;

1239 
__À16
 
	ms_max_m¡_cou¡
;

1240 
__À16
 
	ms_magic
;

1241 
__À16
 
	ms_°©e
;

1242 
__À16
 
	ms_îr‹s
;

1243 
__À16
 
	ms_mö‹_ªv_Àvñ
;

1244  
__À32
 
	ms_œ°check
;

1245 
__À32
 
	ms_checköãrvÆ
;

1246 
__À32
 
	ms_¸ót‹_os
;

1247 
__À32
 
	ms_ªv_Àvñ
;

1248  
__À16
 
	ms_def_ªsuid
;

1249 
__À16
 
	ms_def_ªsgid
;

1263 
__À32
 
	ms_fú°_öo
;

1264 
__À16
 
	ms_öode_size
;

1265 
__À16
 
	ms_block_group_ƒ
;

1266 
__À32
 
	ms_„©uª_com∑t
;

1267  
__À32
 
	ms_„©uª_öcom∑t
;

1268 
__À32
 
	ms_„©uª_ro_com∑t
;

1269  
__u8
 
	ms_uuid
[16];

1270  
	ms_vﬁume_«me
[16];

1271  
	ms_œ°_mou¡ed
[64] 
	m__n⁄°rög
;

1272  
__À32
 
	ms_Æg‹ôhm_ußge_bôm≠
;

1277 
__u8
 
	ms_¥óŒoc_blocks
;

1278 
__u8
 
	ms_¥óŒoc_dú_blocks
;

1279 
__À16
 
	ms_ª£rved_gdt_blocks
;

1283  
__u8
 
	ms_jou∫Æ_uuid
[16];

1284  
__À32
 
	ms_jou∫Æ_öum
;

1285 
__À32
 
	ms_jou∫Æ_dev
;

1286 
__À32
 
	ms_œ°_‹ph™
;

1287 
__À32
 
	ms_hash_£ed
[4];

1288 
__u8
 
	ms_def_hash_vîsi⁄
;

1289 
__u8
 
	ms_j∆_backup_ty≥
;

1290 
__À16
 
	ms_desc_size
;

1291  
__À32
 
	ms_deÁu…_mou¡_›ts
;

1292 
__À32
 
	ms_fú°_mëa_bg
;

1293 
__À32
 
	ms_mkfs_time
;

1294 
__À32
 
	ms_j∆_blocks
[17];

1296  
__À32
 
	ms_blocks_cou¡_hi
;

1297 
__À32
 
	ms_r_blocks_cou¡_hi
;

1298 
__À32
 
	ms_‰ì_blocks_cou¡_hi
;

1299 
__À16
 
	ms_mö_exåa_isize
;

1300 
__À16
 
	ms_w™t_exåa_isize
;

1301 
__À32
 
	ms_Êags
;

1302 
__À16
 
	ms_øid_°ride
;

1303 
__À16
 
	ms_mmp_upd©e_öãrvÆ
;

1304 
__À64
 
	ms_mmp_block
;

1305 
__À32
 
	ms_øid_°rùe_width
;

1306 
__u8
 
	ms_log_groups_≥r_Êex
;

1307 
__u8
 
	ms_checksum_ty≥
;

1308 
__u8
 
	ms_í¸y±i⁄_Àvñ
;

1309 
__u8
 
	ms_ª£rved_∑d
;

1310 
__À64
 
	ms_kbyãs_wrôãn
;

1311 
__À32
 
	ms_¢≠shŸ_öum
;

1312 
__À32
 
	ms_¢≠shŸ_id
;

1313 
__À64
 
	ms_¢≠shŸ_r_blocks_cou¡
;

1315 
__À32
 
	ms_¢≠shŸ_li°
;

1317 
	#PXT4_S_ERR_START
 
	`off£tof
(
pxt4_su≥r_block
, 
s_îr‹_cou¡
)

	)

1318 
__À32
 
	ms_îr‹_cou¡
;

1319 
__À32
 
	ms_fú°_îr‹_time
;

1320 
__À32
 
	ms_fú°_îr‹_öo
;

1321 
__À64
 
	ms_fú°_îr‹_block
;

1322 
__u8
 
	ms_fú°_îr‹_func
[32] 
	m__n⁄°rög
;

1323 
__À32
 
	ms_fú°_îr‹_löe
;

1324 
__À32
 
	ms_œ°_îr‹_time
;

1325 
__À32
 
	ms_œ°_îr‹_öo
;

1326 
__À32
 
	ms_œ°_îr‹_löe
;

1327 
__À64
 
	ms_œ°_îr‹_block
;

1328 
__u8
 
	ms_œ°_îr‹_func
[32] 
	m__n⁄°rög
;

1329 
	#PXT4_S_ERR_END
 
	`off£tof
(
pxt4_su≥r_block
, 
s_mou¡_›ts
)

	)

1330 
__u8
 
	ms_mou¡_›ts
[64];

1331 
__À32
 
	ms_u§_quŸa_öum
;

1332 
__À32
 
	ms_gΩ_quŸa_öum
;

1333 
__À32
 
	ms_ovîhód_˛u°îs
;

1334 
__À32
 
	ms_backup_bgs
[2];

1335 
__u8
 
	ms_í¸y±_Ægos
[4];

1336 
__u8
 
	ms_í¸y±_pw_ß…
[16];

1337 
__À32
 
	ms_Õf_öo
;

1338 
__À32
 
	ms_¥j_quŸa_öum
;

1339 
__À32
 
	ms_checksum_£ed
;

1340 
__u8
 
	ms_wtime_hi
;

1341 
__u8
 
	ms_mtime_hi
;

1342 
__u8
 
	ms_mkfs_time_hi
;

1343 
__u8
 
	ms_œ°check_hi
;

1344 
__u8
 
	ms_fú°_îr‹_time_hi
;

1345 
__u8
 
	ms_œ°_îr‹_time_hi
;

1346 
__u8
 
	ms_∑d
[2];

1347 
__À16
 
	ms_ícodög
;

1348 
__À16
 
	ms_ícodög_Êags
;

1349 
__À32
 
	ms_ª£rved
[95];

1350 
__À32
 
	ms_checksum
;

1353 
	#PXT4_S_ERR_LEN
 (
PXT4_S_ERR_END
 - 
PXT4_S_ERR_START
)

	)

1355 #ifde‡
__KERNEL__


1360 
	#PXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1361 
	#PXT4_MF_FS_ABORTED
 0x0002

	)

1362 
	#PXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1364 #ifde‡
CONFIG_FS_ENCRYPTION


1365 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(
	`u∆ikñy
((sbi)->
s_mou¡_Êags
 & \

1366 
PXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1368 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(0)

	)

1372 
	#PXT4_MAXQUOTAS
 3

	)

1374 
	#PXT4_ENC_UTF8_12_1
 1

	)

1379 
	#PXT4_ENC_STRICT_MODE_FL
 (1 << 0)

	)

1381 
	#pxt4_has_°ri˘_mode
(
sbi
) \

1382 (
sbi
->
s_ícodög_Êags
 & 
PXT4_ENC_STRICT_MODE_FL
)

	)

1387 
	spxt4_sb_öfo
 {

1388 
	ms_desc_size
;

1389 
	ms_öodes_≥r_block
;

1390 
	ms_blocks_≥r_group
;

1391 
	ms_˛u°îs_≥r_group
;

1392 
	ms_öodes_≥r_group
;

1393 
	ms_ôb_≥r_group
;

1394 
	ms_gdb_cou¡
;

1395 
	ms_desc_≥r_block
;

1396 
pxt4_group_t
 
	ms_groups_cou¡
;

1397 
pxt4_group_t
 
	ms_blockfûe_groups
;

1398 
	ms_ovîhód
;

1399 
	ms_˛u°î_øtio
;

1400 
	ms_˛u°î_bôs
;

1401 
loff_t
 
	ms_bôm≠_maxbyãs
;

1402 
buf„r_hód
 * 
	ms_sbh
;

1403 
pxt4_su≥r_block
 *
	ms_es
;

1404 
buf„r_hód
 * 
__rcu
 *
	ms_group_desc
;

1405 
	ms_mou¡_›t
;

1406 
	ms_mou¡_›t2
;

1407 
	ms_mou¡_Êags
;

1408 
	ms_def_mou¡_›t
;

1409 
pxt4_fsblk_t
 
	ms_sb_block
;

1410 
©omic64_t
 
	ms_ªsv_˛u°îs
;

1411 
kuid_t
 
	ms_ªsuid
;

1412 
kgid_t
 
	ms_ªsgid
;

1413 
	ms_mou¡_°©e
;

1414 
	ms_∑d
;

1415 
	ms_addr_≥r_block_bôs
;

1416 
	ms_desc_≥r_block_bôs
;

1417 
	ms_öode_size
;

1418 
	ms_fú°_öo
;

1419 
	ms_öode_ªadahód_blks
;

1420 
	ms_öode_gﬂl
;

1421 
u32
 
	ms_hash_£ed
[4];

1422 
	ms_def_hash_vîsi⁄
;

1423 
	ms_hash_unsig√d
;

1424 
≥r˝u_cou¡î
 
	ms_‰ì˛u°îs_cou¡î
;

1425 
≥r˝u_cou¡î
 
	ms_‰ìöodes_cou¡î
;

1426 
≥r˝u_cou¡î
 
	ms_dús_cou¡î
;

1427 
≥r˝u_cou¡î
 
	ms_dúty˛u°îs_cou¡î
;

1428 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1429 
¥oc_dú_íåy
 *
	ms_¥oc
;

1430 
kobje˘
 
	ms_kobj
;

1431 
com∂ëi⁄
 
	ms_kobj_uƒegi°î
;

1432 
su≥r_block
 *
	ms_sb
;

1433 #ifde‡
CONFIG_UNICODE


1434 
unicode_m≠
 *
	ms_ícodög
;

1435 
__u16
 
	ms_ícodög_Êags
;

1439 
jou∫Æ_s
 *
	ms_jou∫Æ
;

1440 
li°_hód
 
	ms_‹ph™
;

1441 
muãx
 
	ms_‹ph™_lock
;

1442 
	ms_pxt4_Êags
;

1443 
	ms_commô_öãrvÆ
;

1444 
u32
 
	ms_max_b©ch_time
;

1445 
u32
 
	ms_mö_b©ch_time
;

1446 
block_devi˚
 *
	mjou∫Æ_bdev
;

1447 #ifde‡
CONFIG_QUOTA


1449 
__rcu
 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

1450 
	ms_jquŸa_fmt
;

1452 
	ms_w™t_exåa_isize
;

1453 
pxt4_sy°em_blocks
 
__rcu
 *
	msy°em_blks
;

1455 #ifde‡
EXTENTS_STATS


1457 
	ms_ext_mö
;

1458 
	ms_ext_max
;

1459 
	ms_dïth_max
;

1460 
•ölock_t
 
	ms_ext_°©s_lock
;

1461 
	ms_ext_blocks
;

1462 
	ms_ext_exã¡s
;

1466 
pxt4_group_öfo
 ** 
__rcu
 *
	ms_group_öfo
;

1467 
öode
 *
	ms_buddy_ˇche
;

1468 
•ölock_t
 
	ms_md_lock
;

1469 *
	ms_mb_off£ts
;

1470 *
	ms_mb_maxs
;

1471 
	ms_group_öfo_size
;

1472 
	ms_mb_‰ì_≥ndög
;

1473 
li°_hód
 
	ms_‰ìd_d©a_li°
;

1477 
	ms_°rùe
;

1478 
	ms_mb_°ªam_ªque°
;

1479 
	ms_mb_max_to_sˇn
;

1480 
	ms_mb_mö_to_sˇn
;

1481 
	ms_mb_°©s
;

1482 
	ms_mb_‹dî2_ªqs
;

1483 
	ms_mb_group_¥óŒoc
;

1484 
	ms_max_dú_size_kb
;

1486 
	ms_mb_œ°_group
;

1487 
	ms_mb_œ°_°¨t
;

1490 
©omic_t
 
	ms_bÆ_ªqs
;

1491 
©omic_t
 
	ms_bÆ_suc˚ss
;

1492 
©omic_t
 
	ms_bÆ_Æloˇãd
;

1493 
©omic_t
 
	ms_bÆ_ex_sˇ¬ed
;

1494 
©omic_t
 
	ms_bÆ_gﬂls
;

1495 
©omic_t
 
	ms_bÆ_bªaks
;

1496 
©omic_t
 
	ms_bÆ_2‹dîs
;

1497 
•ölock_t
 
	ms_bÆ_lock
;

1498 
	ms_mb_buddõs_gíî©ed
;

1499 
	ms_mb_gíî©i⁄_time
;

1500 
©omic_t
 
	ms_mb_lo°_chunks
;

1501 
©omic_t
 
	ms_mb_¥óŒoˇãd
;

1502 
©omic_t
 
	ms_mb_disˇrded
;

1503 
©omic_t
 
	ms_lock_busy
;

1506 
pxt4_loˇlôy_group
 
__≥r˝u
 *
	ms_loˇlôy_groups
;

1509 
	ms_£˘‹s_wrôãn_°¨t
;

1510 
u64
 
	ms_kbyãs_wrôãn
;

1513 
	ms_exã¡_max_zîoout_kb
;

1515 
	ms_log_groups_≥r_Êex
;

1516 
Êex_groups
 * 
__rcu
 *
	ms_Êex_groups
;

1517 
pxt4_group_t
 
	ms_Êex_groups_Æloˇãd
;

1520 
w‹kqueue_°ru˘
 *
	mrsv_c⁄vîsi⁄_wq
;

1523 
timî_li°
 
	ms_îr_ªp‹t
;

1526 
pxt4_li_ªque°
 *
	ms_li_ªque°
;

1528 
	ms_li_waô_mu…
;

1531 
èsk_°ru˘
 *
	ms_mmp_tsk
;

1534 
©omic_t
 
	ms_œ°_åim_möblks
;

1537 
¸y±o_shash
 *
	ms_chksum_drivî
;

1540 
__u32
 
	ms_csum_£ed
;

1543 
shrökî
 
	ms_es_shrökî
;

1544 
li°_hód
 
	ms_es_li°
;

1545 
	ms_es_ƒ_öode
;

1546 
pxt4_es_°©s
 
	ms_es_°©s
;

1547 
mb_ˇche
 *
	ms_ó_block_ˇche
;

1548 
mb_ˇche
 *
	ms_ó_öode_ˇche
;

1549 
•ölock_t
 
s_es_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

1552 
øãlimô_°©e
 
	ms_îr_øãlimô_°©e
;

1553 
øãlimô_°©e
 
	ms_w¨nög_øãlimô_°©e
;

1554 
øãlimô_°©e
 
	ms_msg_øãlimô_°©e
;

1560 
≥r˝u_rw_£m≠h‹e
 
	ms_wrôïages_rw£m
;

1561 
dax_devi˚
 *
	ms_daxdev
;

1564 
ölöe
 
pxt4_sb_öfo
 *
	$PXT4_SB
(
su≥r_block
 *
sb
)

1566  
sb
->
s_fs_öfo
;

1567 
	}
}

1568 
ölöe
 
pxt4_öode_öfo
 *
	$PXT4_I
(
öode
 *inode)

1570  
	`c⁄èöî_of
(
öode
, 
pxt4_öode_öfo
, 
vfs_öode
);

1571 
	}
}

1573 
ölöe
 
	$pxt4_vÆid_öum
(
su≥r_block
 *
sb
, 
öo
)

1575  
öo
 =
PXT4_ROOT_INO
 ||

1576 (
öo
 >
	`PXT4_FIRST_INO
(
sb
) &&

1577 
öo
 <
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
));

1578 
	}
}

1588 
	#sbi_¨øy_rcu_dîef
(
sbi
, 
fõld
, 
ödex
) \

1590 
	`ty≥of
(*((
sbi
)->
fõld
)Ë
_v
; \

1591 
	`rcu_ªad_lock
(); \

1592 
_v
 = ((
	`ty≥of
(_v)*)
	`rcu_dîe„ªn˚
((
sbi
)->
fõld
))[
ödex
]; \

1593 
	`rcu_ªad_u∆ock
(); \

1594 
_v
; \

1595 })

	)

1601 
	mPXT4_STATE_JDATA
,

1602 
	mPXT4_STATE_NEW
,

1603 
	mPXT4_STATE_XATTR
,

1604 
	mPXT4_STATE_NO_EXPAND
,

1605 
	mPXT4_STATE_DA_ALLOC_CLOSE
,

1606 
	mPXT4_STATE_EXT_MIGRATE
,

1607 
	mPXT4_STATE_NEWENTRY
,

1608 
	mPXT4_STATE_MAY_INLINE_DATA
,

1609 
	mPXT4_STATE_EXT_PRECACHED
,

1610 
	mPXT4_STATE_LUSTRE_EA_INODE
,

1611 
	mPXT4_STATE_VERITY_IN_PROGRESS
,

1614 
	#PXT4_INODE_BIT_FNS
(
«me
, 
fõld
, 
off£t
) \

1615 
ölöe
 
pxt4_ã°_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1617  
	`ã°_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1619 
ölöe
 
pxt4_£t_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1621 
	`£t_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1623 
ölöe
 
pxt4_˛ór_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1625 
	`˛ór_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1626 }

	)

1630 
ölöe
 
pxt4_ã°_öode_Êag
(
öode
 *öode, 
bô
);

1631 
ölöe
 
pxt4_£t_öode_Êag
(
öode
 *öode, 
bô
);

1632 
ölöe
 
pxt4_˛ór_öode_Êag
(
öode
 *öode, 
bô
);

1633 
	$PXT4_INODE_BIT_FNS
(
Êag
, 
Êags
, 0)

1637 
ölöe
 
	`pxt4_ã°_öode_°©e
(
öode
 *öode, 
bô
);

1638 
ölöe
 
	`pxt4_£t_öode_°©e
(
öode
 *öode, 
bô
);

1639 
ölöe
 
	`pxt4_˛ór_öode_°©e
(
öode
 *öode, 
bô
);

1640 #i‡(
BITS_PER_LONG
 < 64)

1641 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
°©e_Êags
, 0)

1643 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1645 (
ei
)->
i_°©e_Êags
 = 0;

1646 
	}
}

1648 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
Êags
, 32)

1650 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1653 
	}
}

1659 
	#PXT4_SB
(
sb
Ë(sb)

	)

1662 
ölöe
 
boﬁ
 
	$pxt4_vîôy_ö_¥ogªss
(
öode
 *inode)

1664  
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

1665 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

1666 
	}
}

1668 
	#NEXT_ORPHAN
(
öode
Ë
	`PXT4_I
(öode)->
i_dtime


	)

1673 
	#PXT4_OS_LINUX
 0

	)

1674 
	#PXT4_OS_HURD
 1

	)

1675 
	#PXT4_OS_MASIX
 2

	)

1676 
	#PXT4_OS_FREEBSD
 3

	)

1677 
	#PXT4_OS_LITES
 4

	)

1682 
	#PXT4_GOOD_OLD_REV
 0

	)

1683 
	#PXT4_DYNAMIC_REV
 1

	)

1685 
	#PXT4_CURRENT_REV
 
PXT4_GOOD_OLD_REV


	)

1686 
	#PXT4_MAX_SUPP_REV
 
PXT4_DYNAMIC_REV


	)

1688 
	#PXT4_GOOD_OLD_INODE_SIZE
 128

	)

1690 
	#PXT4_EXTRA_TIMESTAMP_MAX
 (((
s64
)1 << 34Ë- 1 + 
S32_MIN
)

	)

1691 
	#PXT4_NON_EXTRA_TIMESTAMP_MAX
 
S32_MAX


	)

1692 
	#PXT4_TIMESTAMP_MIN
 
S32_MIN


	)

1698 
	#PXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1699 
	#PXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1700 
	#PXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1701 
	#PXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1702 
	#PXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1703 
	#PXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1704 
	#PXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1705 
	#PXT4_FEATURE_COMPAT_STABLE_INODES
 0x0800

	)

1707 
	#PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1708 
	#PXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1709 
	#PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1710 
	#PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1711 
	#PXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1712 
	#PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1713 
	#PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1714 
	#PXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1715 
	#PXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1722 
	#PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1723 
	#PXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1724 
	#PXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1725 
	#PXT4_FEATURE_RO_COMPAT_VERITY
 0x8000

	)

1727 
	#PXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1728 
	#PXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1729 
	#PXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1730 
	#PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1731 
	#PXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1732 
	#PXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1733 
	#PXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1734 
	#PXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1735 
	#PXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1736 
	#PXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1737 
	#PXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1738 
	#PXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1739 
	#PXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1740 
	#PXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1741 
	#PXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1742 
	#PXT4_FEATURE_INCOMPAT_CASEFOLD
 0x20000

	)

1744 
pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
);

1746 
	#PXT4_FEATURE_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1747 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1749  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1750 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
)) != 0); \

1752 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1754 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1755 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 |= \

1756 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1758 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1760 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 &= \

1761 ~
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1762 }

	)

1764 
	#PXT4_FEATURE_RO_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1765 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1767  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1768 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
)) != 0); \

1770 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1772 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1773 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 |= \

1774 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1776 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1778 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 &= \

1779 ~
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1780 }

	)

1782 
	#PXT4_FEATURE_INCOMPAT_FUNCS
(
«me
, 
Êag«me
) \

1783 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1785  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1786 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
)) != 0); \

1788 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1790 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1791 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 |= \

1792 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1794 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1796 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 &= \

1797 ~
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1798 }

	)

1800 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_¥óŒoc
, 
DIR_PREALLOC
)

1801 
	$PXT4_FEATURE_COMPAT_FUNCS
(
imagic_öodes
, 
IMAGIC_INODES
)

1802 
	$PXT4_FEATURE_COMPAT_FUNCS
(
jou∫Æ
, 
HAS_JOURNAL
)

1803 
	$PXT4_FEATURE_COMPAT_FUNCS
(
x©å
, 
EXT_ATTR
)

1804 
	$PXT4_FEATURE_COMPAT_FUNCS
(
ªsize_öode
, 
RESIZE_INODE
)

1805 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_ödex
, 
DIR_INDEX
)

1806 
	$PXT4_FEATURE_COMPAT_FUNCS
(
•¨£_su≥r2
, 
SPARSE_SUPER2
)

1807 
	$PXT4_FEATURE_COMPAT_FUNCS
(
°abÀ_öodes
, 
STABLE_INODES
)

1809 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
•¨£_su≥r
, 
SPARSE_SUPER
)

1810 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
œrge_fûe
, 
LARGE_FILE
)

1811 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
båì_dú
, 
BTREE_DIR
)

1812 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fûe
, 
HUGE_FILE
)

1813 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1814 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
dú_∆ök
, 
DIR_NLINK
)

1815 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
exåa_isize
, 
EXTRA_ISIZE
)

1816 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
quŸa
, 
QUOTA
)

1817 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
bigÆloc
, 
BIGALLOC
)

1818 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
mëad©a_csum
, 
METADATA_CSUM
)

1819 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
ªad⁄ly
, 
READONLY
)

1820 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
¥oje˘
, 
PROJECT
)

1821 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
vîôy
, 
VERITY
)

1823 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
com¥essi⁄
, 
COMPRESSION
)

1824 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
fûëy≥
, 
FILETYPE
)

1825 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_√eds_ªcovîy
, 
RECOVER
)

1826 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_dev
, 
JOURNAL_DEV
)

1827 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mëa_bg
, 
META_BG
)

1828 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
exã¡s
, 
EXTENTS
)

1829 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(64b
ô
, 64B
IT
)

1830 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1831 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
Êex_bg
, 
FLEX_BG
)

1832 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ó_öode
, 
EA_INODE
)

1833 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
dúd©a
, 
DIRDATA
)

1834 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1835 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
œrgedú
, 
LARGEDIR
)

1836 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ölöe_d©a
, 
INLINE_DATA
)

1837 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
í¸y±
, 
ENCRYPT
)

1838 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ˇ£fﬁd
, 
CASEFOLD
)

1840 
	#PXT2_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1841 
	#PXT2_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1842 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1843 
	#PXT2_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1844 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1845 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1847 
	#PXT3_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1848 
	#PXT3_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1849 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1850 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1851 
	#PXT3_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1852 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1853 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1855 
	#PXT4_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1856 
	#PXT4_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1857 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1858 
PXT4_FEATURE_INCOMPAT_META_BG
| \

1859 
PXT4_FEATURE_INCOMPAT_EXTENTS
| \

1860 
PXT4_FEATURE_INCOMPAT_64BIT
| \

1861 
PXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1862 
PXT4_FEATURE_INCOMPAT_EA_INODE
| \

1863 
PXT4_FEATURE_INCOMPAT_MMP
 | \

1864 
PXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1865 
PXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1866 
PXT4_FEATURE_INCOMPAT_CASEFOLD
 | \

1867 
PXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1868 
PXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1869 
	#PXT4_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1870 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1871 
PXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1872 
PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1873 
PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1874 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1875 
PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1876 
PXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1877 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1878 
PXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1879 
PXT4_FEATURE_RO_COMPAT_PROJECT
 |\

1880 
PXT4_FEATURE_RO_COMPAT_VERITY
)

	)

1882 
	#EXTN_FEATURE_FUNCS
(
vî
) \

1883 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1885  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1886 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1887 
	}
} \

1888 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1890  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1891 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1893 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_öcom∑t_„©uªs
(
su≥r_block
 *
sb
) \

1895  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1896 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1897 }

	)

1899 
	$EXTN_FEATURE_FUNCS
(2)

1900 
	$EXTN_FEATURE_FUNCS
(3)

1901 
	$EXTN_FEATURE_FUNCS
(4)

1903 
ölöe
 
boﬁ
 
	$pxt4_has_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1905  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 != 0);

1906 
	}
}

1907 
ölöe
 
boﬁ
 
	$pxt4_has_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1909  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 != 0);

1910 
	}
}

1911 
ölöe
 
boﬁ
 
	$pxt4_has_öcom∑t_„©uªs
(
su≥r_block
 *
sb
)

1913  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 != 0);

1914 
	}
}

1919 
	#PXT4_FLAGS_RESIZING
 0

	)

1920 
	#PXT4_FLAGS_SHUTDOWN
 1

	)

1922 
ölöe
 
	$pxt4_f‹˚d_shutdown
(
pxt4_sb_öfo
 *
sbi
)

1924  
	`ã°_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

1925 
	}
}

1931 
	#PXT4_DEF_RESUID
 0

	)

1932 
	#PXT4_DEF_RESGID
 0

	)

1937 
	#PXT4_DEF_PROJID
 0

	)

1939 
	#PXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1944 
	#PXT4_DEFM_DEBUG
 0x0001

	)

1945 
	#PXT4_DEFM_BSDGROUPS
 0x0002

	)

1946 
	#PXT4_DEFM_XATTR_USER
 0x0004

	)

1947 
	#PXT4_DEFM_ACL
 0x0008

	)

1948 
	#PXT4_DEFM_UID16
 0x0010

	)

1949 
	#PXT4_DEFM_JMODE
 0x0060

	)

1950 
	#PXT4_DEFM_JMODE_DATA
 0x0020

	)

1951 
	#PXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1952 
	#PXT4_DEFM_JMODE_WBACK
 0x0060

	)

1953 
	#PXT4_DEFM_NOBARRIER
 0x0100

	)

1954 
	#PXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1955 
	#PXT4_DEFM_DISCARD
 0x0400

	)

1956 
	#PXT4_DEFM_NODELALLOC
 0x0800

	)

1961 
	#PXT4_DEF_MIN_BATCH_TIME
 0

	)

1962 
	#PXT4_DEF_MAX_BATCH_TIME
 15000

	)

1968 
	#PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1973 
	#PXT4_NAME_LEN
 255

	)

1975 
	spxt4_dú_íåy
 {

1976 
__À32
 
	möode
;

1977 
__À16
 
	mªc_Àn
;

1978 
__À16
 
	m«me_Àn
;

1979 
	m«me
[
PXT4_NAME_LEN
];

1988 
	spxt4_dú_íåy_2
 {

1989 
__À32
 
	möode
;

1990 
__À16
 
	mªc_Àn
;

1991 
__u8
 
	m«me_Àn
;

1992 
__u8
 
	mfûe_ty≥
;

1993 
	m«me
[
PXT4_NAME_LEN
];

2000 
	spxt4_dú_íåy_èû
 {

2001 
__À32
 
	mdë_ª£rved_zîo1
;

2002 
__À16
 
	mdë_ªc_Àn
;

2003 
__u8
 
	mdë_ª£rved_zîo2
;

2004 
__u8
 
	mdë_ª£rved_·
;

2005 
__À32
 
	mdë_checksum
;

2008 
	#PXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

2009 ((
pxt4_dú_íåy_èû
 *)(((*)(
block
)) + \

2010 ((
blocksize
) - \

2011 (
pxt4_dú_íåy_èû
))))

	)

2017 
	#PXT4_FT_UNKNOWN
 0

	)

2018 
	#PXT4_FT_REG_FILE
 1

	)

2019 
	#PXT4_FT_DIR
 2

	)

2020 
	#PXT4_FT_CHRDEV
 3

	)

2021 
	#PXT4_FT_BLKDEV
 4

	)

2022 
	#PXT4_FT_FIFO
 5

	)

2023 
	#PXT4_FT_SOCK
 6

	)

2024 
	#PXT4_FT_SYMLINK
 7

	)

2026 
	#PXT4_FT_MAX
 8

	)

2028 
	#PXT4_FT_DIR_CSUM
 0xDE

	)

2035 
	#PXT4_DIR_PAD
 4

	)

2036 
	#PXT4_DIR_ROUND
 (
PXT4_DIR_PAD
 - 1)

	)

2037 
	#PXT4_DIR_REC_LEN
(
«me_Àn
Ë((“ame_ÀnË+ 8 + 
PXT4_DIR_ROUND
) & \

2038 ~
PXT4_DIR_ROUND
)

	)

2039 
	#PXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2045 
ölöe
 

2046 
	$pxt4_ªc_Àn_‰om_disk
(
__À16
 
dÀn
, 
blocksize
)

2048 
Àn
 = 
	`À16_to_˝u
(
dÀn
);

2050 #i‡(
PAGE_SIZE
 >= 65536)

2051 i‡(
Àn
 =
PXT4_MAX_REC_LEN
 ||Üen == 0)

2052  
blocksize
;

2053  (
Àn
 & 65532) | ((len & 3) << 16);

2055  
Àn
;

2057 
	}
}

2059 
ölöe
 
__À16
 
	$pxt4_ªc_Àn_to_disk
(
Àn
, 
blocksize
)

2061 i‡((
Àn
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2062 
	`BUG
();

2063 #i‡(
PAGE_SIZE
 >= 65536)

2064 i‡(
Àn
 < 65536)

2065  
	`˝u_to_À16
(
Àn
);

2066 i‡(
Àn
 =
blocksize
) {

2067 i‡(
blocksize
 == 65536)

2068  
	`˝u_to_À16
(
PXT4_MAX_REC_LEN
);

2070  
	`˝u_to_À16
(0);

2072  
	`˝u_to_À16
((
Àn
 & 65532) | ((len >> 16) & 3));

2074  
	`˝u_to_À16
(
Àn
);

2076 
	}
}

2083 
	#is_dx
(
dú
Ë(
	`pxt4_has_„©uª_dú_ödex
((dú)->
i_sb
) && \

2084 
	`pxt4_ã°_öode_Êag
((
dú
), 
PXT4_INODE_INDEX
))

	)

2085 
	#PXT4_DIR_LINK_MAX
(
dú
Ë
	`u∆ikñy
((dú)->
i_∆ök
 >
PXT4_LINK_MAX
 && \

2086 !(
	`pxt4_has_„©uª_dú_∆ök
((
dú
)->
i_sb
Ë&& 
	`is_dx
(dú)))

	)

2087 
	#PXT4_DIR_LINK_EMPTY
(
dú
Ë((dú)->
i_∆ök
 =2 || (dú)->i_∆ök =1)

	)

2091 
	#DX_HASH_LEGACY
 0

	)

2092 
	#DX_HASH_HALF_MD4
 1

	)

2093 
	#DX_HASH_TEA
 2

	)

2094 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2095 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2096 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2098 
ölöe
 
u32
 
	$pxt4_chksum
(
pxt4_sb_öfo
 *
sbi
, 
u32
 
¸c
,

2099 c⁄° *
addªss
, 
Àngth
)

2102 
shash_desc
 
shash
;

2103 
˘x
[4];

2104 } 
desc
;

2106 
	`BUG_ON
(
	`¸y±o_shash_descsize
(
sbi
->
s_chksum_drivî
)!=(
desc
.
˘x
));

2108 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_drivî
;

2109 *(
u32
 *)
desc
.
˘x
 = 
¸c
;

2111 
	`BUG_ON
(
	`¸y±o_shash_upd©e
(&
desc
.
shash
, 
addªss
, 
Àngth
));

2113  *(
u32
 *)
desc
.
˘x
;

2114 
	}
}

2116 #ifde‡
__KERNEL__


2119 
	sdx_hash_öfo


2121 
u32
 
	mhash
;

2122 
u32
 
	mmö‹_hash
;

2123 
	mhash_vîsi⁄
;

2124 
u32
 *
	m£ed
;

2129 
	#PXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)Ë- 1)

	)

2130 
	#PXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)Ë- 1)

	)

2136 
	#HASH_NB_ALWAYS
 1

	)

2138 
	spxt4_fûíame
 {

2139 c⁄° 
q°r
 *
	mu§_‚ame
;

2140 
fs¸y±_°r
 
	mdisk_«me
;

2141 
dx_hash_öfo
 
	mhöfo
;

2142 #ifde‡
CONFIG_FS_ENCRYPTION


2143 
fs¸y±_°r
 
	m¸y±o_buf
;

2145 #ifde‡
CONFIG_UNICODE


2146 
fs¸y±_°r
 
	mcf_«me
;

2150 
	#‚ame_«me
(
p
Ë(’)->
disk_«me
.
«me
)

	)

2151 
	#‚ame_Àn
(
p
Ë(’)->
disk_«me
.
Àn
)

	)

2156 
	spxt4_ûoc


2158 
buf„r_hód
 *
	mbh
;

2159 
	moff£t
;

2160 
pxt4_group_t
 
	mblock_group
;

2163 
ölöe
 
pxt4_öode
 *
	$pxt4_øw_öode
(
pxt4_ûoc
 *
ûoc
)

2165  (
pxt4_öode
 *Ë(
ûoc
->
bh
->
b_d©a
 + iloc->
off£t
);

2166 
	}
}

2168 
ölöe
 
boﬁ
 
	$pxt4_is_quŸa_fûe
(
öode
 *inode)

2170  
	`IS_NOQUOTA
(
öode
) &&

2171 !(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
);

2172 
	}
}

2179 
	sdú_¥iv©e_öfo
 {

2180 
rb_roŸ
 
	mroŸ
;

2181 
rb_node
 *
	mcuº_node
;

2182 
‚ame
 *
	mexåa_‚ame
;

2183 
loff_t
 
	mœ°_pos
;

2184 
__u32
 
	mcuº_hash
;

2185 
__u32
 
	mcuº_mö‹_hash
;

2186 
__u32
 
	m√xt_hash
;

2190 
ölöe
 
pxt4_fsblk_t


2191 
	$pxt4_group_fú°_block_no
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group_no
)

2193  
group_no
 * (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2194 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

2195 
	}
}

2200 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2203 
	#PXT4_HTREE_LEVEL_COMPAT
 2

	)

2204 
	#PXT4_HTREE_LEVEL
 3

	)

2206 
ölöe
 
	$pxt4_dú_håì_Àvñ
(
su≥r_block
 *
sb
)

2208  
	`pxt4_has_„©uª_œrgedú
(
sb
) ?

2209 
PXT4_HTREE_LEVEL
 : 
PXT4_HTREE_LEVEL_COMPAT
;

2210 
	}
}

2215 
	#PXT4_DEF_LI_WAIT_MULT
 10

	)

2216 
	#PXT4_DEF_LI_MAX_START_DELAY
 5

	)

2217 
	#PXT4_LAZYINIT_QUIT
 0x0001

	)

2218 
	#PXT4_LAZYINIT_RUNNING
 0x0002

	)

2223 
	spxt4_œzy_öô
 {

2224 
	mli_°©e
;

2225 
li°_hód
 
	mli_ªque°_li°
;

2226 
muãx
 
	mli_li°_mtx
;

2229 
	spxt4_li_ªque°
 {

2230 
su≥r_block
 *
	mÃ_su≥r
;

2231 
pxt4_sb_öfo
 *
	mÃ_sbi
;

2232 
pxt4_group_t
 
	mÃ_√xt_group
;

2233 
li°_hód
 
	mÃ_ªque°
;

2234 
	mÃ_√xt_sched
;

2235 
	mÃ_timeout
;

2238 
	spxt4_„©uªs
 {

2239 
kobje˘
 
	mf_kobj
;

2240 
com∂ëi⁄
 
	mf_kobj_uƒegi°î
;

2250 
	#PXT4_MMP_MAGIC
 0x004D4D50U

	)

2251 
	#PXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2252 
	#PXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2253 
	#PXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2255 
	smmp_°ru˘
 {

2256 
__À32
 
	mmmp_magic
;

2257 
__À32
 
	mmmp_£q
;

2263 
__À64
 
	mmmp_time
;

2264 
	mmmp_nodíame
[64];

2265 
	mmmp_bdev«me
[32];

2272 
__À16
 
	mmmp_check_öãrvÆ
;

2274 
__À16
 
	mmmp_∑d1
;

2275 
__À32
 
	mmmp_∑d2
[226];

2276 
__À32
 
	mmmp_checksum
;

2280 
	smmpd_d©a
 {

2281 
buf„r_hód
 *
	mbh
;

2282 
su≥r_block
 *
	msb
;

2293 
	#PXT4_MMP_CHECK_MULT
 2UL

	)

2298 
	#PXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2303 
	#PXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2313 
	#NORET_TYPE


	)

2314 
	#ATTRIB_NORET
 
	`__©åibuã__
((
n‹ëu∫
))

	)

2315 
	#NORET_AND
 
n‹ëu∫
,

	)

2318 
pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
);

2319 
pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2320 
pxt4_group_desc
 *
gdp
,

2321 
buf„r_hód
 *
bh
, 
sz
);

2322 
pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2323 
pxt4_group_desc
 *
gdp
,

2324 
buf„r_hód
 *
bh
, 
sz
);

2325 
pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2326 
pxt4_group_desc
 *
gdp
,

2327 
buf„r_hód
 *
bh
);

2328 
pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2329 
pxt4_group_desc
 *
gdp
,

2330 
buf„r_hód
 *
bh
);

2333 
pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
,

2334 
pxt4_fsblk_t
 
blockƒ
,

2335 
pxt4_group_t
 *
blockgΩp
,

2336 
pxt4_gΩblk_t
 *
off£ç
);

2337 
pxt4_group_t
 
pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

2338 
pxt4_fsblk_t
 
block
);

2340 
pxt4_block_group
(
su≥r_block
 *
sb
,

2341 
pxt4_fsblk_t
 
blockƒ
);

2342 
pxt4_gΩblk_t
 
pxt4_block_group_off£t
(
su≥r_block
 *
sb
,

2343 
pxt4_fsblk_t
 
blockƒ
);

2344 
pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
);

2345 
pxt4_bg_num_gdb
(
su≥r_block
 *
sb
,

2346 
pxt4_group_t
 
group
);

2347 
pxt4_fsblk_t
 
pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2348 
pxt4_fsblk_t
 
gﬂl
,

2349 
Êags
,

2350 *
cou¡
,

2351 *
îΩ
);

2352 
pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

2353 
s64
 
n˛u°îs
, 
Êags
);

2354 
pxt4_fsblk_t
 
pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *);

2355 
pxt4_check_blocks_bôm≠
(
su≥r_block
 *);

2356 
pxt4_group_desc
 * 
pxt4_gë_group_desc
(
su≥r_block
 * 
sb
,

2357 
pxt4_group_t
 
block_group
,

2358 
buf„r_hód
 ** 
bh
);

2359 
pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
);

2361 
buf„r_hód
 *
pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
,

2362 
pxt4_group_t
 
block_group
);

2363 
pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
,

2364 
pxt4_group_t
 
block_group
,

2365 
buf„r_hód
 *
bh
);

2366 
buf„r_hód
 *
pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
,

2367 
pxt4_group_t
 
block_group
);

2368 
pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

2369 
pxt4_group_t
 
block_group
,

2370 
pxt4_group_desc
 *
gdp
);

2371 
pxt4_fsblk_t
 
pxt4_öode_to_gﬂl_block
(
öode
 *);

2373 #ifde‡
CONFIG_UNICODE


2374 
pxt4_‚ame_£tup_ci_fûíame
(
öode
 *
dú
,

2375 c⁄° 
q°r
 *
öame
,

2376 
fs¸y±_°r
 *
‚ame
);

2379 #ifde‡
CONFIG_FS_ENCRYPTION


2380 
ölöe
 
	$pxt4_‚ame_‰om_fs¸y±_«me
(
pxt4_fûíame
 *
d°
,

2381 c⁄° 
fs¸y±_«me
 *
§c
)

2383 
	`mem£t
(
d°
, 0, (*dst));

2385 
d°
->
u§_‚ame
 = 
§c
->usr_fname;

2386 
d°
->
disk_«me
 = 
§c
->disk_name;

2387 
d°
->
höfo
.
hash
 = 
§c
->hash;

2388 
d°
->
höfo
.
mö‹_hash
 = 
§c
->minor_hash;

2389 
d°
->
¸y±o_buf
 = 
§c
->crypto_buf;

2390 
	}
}

2392 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2393 c⁄° 
q°r
 *
öame
,

2394 
lookup
,

2395 
pxt4_fûíame
 *
‚ame
)

2397 
fs¸y±_«me
 
«me
;

2398 
îr
;

2400 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, 
öame
, 
lookup
, &
«me
);

2401 i‡(
îr
)

2402  
îr
;

2404 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2406 #ifde‡
CONFIG_UNICODE


2407 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2410 
	}
}

2412 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2413 
díåy
 *dentry,

2414 
pxt4_fûíame
 *
‚ame
)

2416 
fs¸y±_«me
 
«me
;

2417 
îr
;

2419 
îr
 = 
	`fs¸y±_¥ï¨e_lookup
(
dú
, 
díåy
, &
«me
);

2420 i‡(
îr
)

2421  
îr
;

2423 
	`pxt4_‚ame_‰om_fs¸y±_«me
(
‚ame
, &
«me
);

2425 #ifde‡
CONFIG_UNICODE


2426 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, &
díåy
->
d_«me
, &
‚ame
->
cf_«me
);

2429 
	}
}

2431 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2433 
fs¸y±_«me
 
«me
;

2435 
«me
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

2436 
	`fs¸y±_‰ì_fûíame
(&
«me
);

2438 
‚ame
->
¸y±o_buf
.
«me
 = 
NULL
;

2439 
‚ame
->
u§_‚ame
 = 
NULL
;

2440 
‚ame
->
disk_«me
.
«me
 = 
NULL
;

2442 #ifde‡
CONFIG_UNICODE


2443 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2444 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2446 
	}
}

2448 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2449 c⁄° 
q°r
 *
öame
,

2450 
lookup
,

2451 
pxt4_fûíame
 *
‚ame
)

2453 
‚ame
->
u§_‚ame
 = 
öame
;

2454 
‚ame
->
disk_«me
.
«me
 = (*Ë
öame
->name;

2455 
‚ame
->
disk_«me
.
Àn
 = 
öame
->len;

2457 #ifde‡
CONFIG_UNICODE


2458 
	`pxt4_‚ame_£tup_ci_fûíame
(
dú
, 
öame
, &
‚ame
->
cf_«me
);

2462 
	}
}

2464 
ölöe
 
	$pxt4_‚ame_¥ï¨e_lookup
(
öode
 *
dú
,

2465 
díåy
 *dentry,

2466 
pxt4_fûíame
 *
‚ame
)

2468  
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 1, 
‚ame
);

2469 
	}
}

2471 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2473 #ifde‡
CONFIG_UNICODE


2474 
	`k‰ì
(
‚ame
->
cf_«me
.
«me
);

2475 
‚ame
->
cf_«me
.
«me
 = 
NULL
;

2477 
	}
}

2481 
__pxt4_check_dú_íåy
(c⁄° *, , 
öode
 *,

2482 
fûe
 *,

2483 
pxt4_dú_íåy_2
 *,

2484 
buf„r_hód
 *, *, ,

2486 
	#pxt4_check_dú_íåy
(
dú
, 
fûp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2487 
	`u∆ikñy
(
	`__pxt4_check_dú_íåy
(
__func__
, 
__LINE__
, (
dú
), (
fûp
), \

2488 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2489 
pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

2490 
__u32
 
mö‹_hash
,

2491 
pxt4_dú_íåy_2
 *
dúít
,

2492 
fs¸y±_°r
 *
ít_«me
);

2493 
pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
);

2494 
pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

2495 
buf„r_hód
 *
bh
,

2496 *
buf
, 
buf_size
,

2497 
pxt4_fûíame
 *
‚ame
,

2498 
pxt4_dú_íåy_2
 **
de°_de
);

2499 
pxt4_ö£π_díåy
(
öode
 *inode,

2500 
pxt4_dú_íåy_2
 *
de
,

2501 
buf_size
,

2502 
pxt4_fûíame
 *
‚ame
);

2503 
ölöe
 
	$pxt4_upd©e_dx_Êag
(
öode
 *inode)

2505 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
)) {

2507 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
öode
->
i_sb
));

2508 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

2510 
	}
}

2511 c⁄° 
	gpxt4_fûëy≥_èbÀ
[] = {

2512 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2515 
ölöe
 
	$gë_dty≥
(
su≥r_block
 *
sb
, 
fûëy≥
)

2517 i‡(!
	`pxt4_has_„©uª_fûëy≥
(
sb
Ë|| 
fûëy≥
 >
PXT4_FT_MAX
)

2518  
DT_UNKNOWN
;

2520  
pxt4_fûëy≥_èbÀ
[
fûëy≥
];

2521 
	}
}

2522 
pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

2523 *
buf
, 
buf_size
);

2526 
pxt4_sync_fûe
(
fûe
 *, 
loff_t
,Üoff_t, );

2529 
pxt4fs_dúhash
(c⁄° 
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

2530 
dx_hash_öfo
 *
höfo
);

2533 
öode
 *
__pxt4_√w_öode
(
h™dÀ_t
 *, öodê*, 
umode_t
,

2534 c⁄° 
q°r
 *q°r, 
__u32
 
gﬂl
,

2535 
uid_t
 *
ow√r
, 
__u32
 
i_Êags
,

2536 
h™dÀ_ty≥
, 
löe_no
,

2537 
nblocks
);

2539 
	#pxt4_√w_öode
(
h™dÀ
, 
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, 
i_Êags
) \

2540 
	`__pxt4_√w_öode
((
h™dÀ
), (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2541 
i_Êags
, 0, 0, 0)

	)

2542 
	#pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, \

2543 
ty≥
, 
nblocks
) \

2544 
	`__pxt4_√w_öode
(
NULL
, (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2545 0, (
ty≥
), 
__LINE__
, (
nblocks
))

	)

2548 
pxt4_‰ì_öode
(
h™dÀ_t
 *, 
öode
 *);

2549 
öode
 * 
pxt4_‹ph™_gë
(
su≥r_block
 *, );

2550 
pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *);

2551 
pxt4_cou¡_dús
(
su≥r_block
 *);

2552 
pxt4_check_öodes_bôm≠
(
su≥r_block
 *);

2553 
pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
);

2554 
pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
,

2555 
pxt4_group_t
 
group
, 
b¨rõr
);

2556 
pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
);

2559 c⁄° 
£q_›î©i⁄s
 
pxt4_mb_£q_groups_›s
;

2560 
pxt4_mb_°©s
;

2561 
pxt4_mb_max_to_sˇn
;

2562 
pxt4_mb_öô
(
su≥r_block
 *);

2563 
pxt4_mb_ªÀa£
(
su≥r_block
 *);

2564 
pxt4_fsblk_t
 
pxt4_mb_√w_blocks
(
h™dÀ_t
 *,

2565 
pxt4_Æloˇti⁄_ªque°
 *, *);

2566 
pxt4_mb_ª£rve_blocks
(
su≥r_block
 *, );

2567 
pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *);

2568 
__öô
 
pxt4_öô_mbÆloc
();

2569 
pxt4_exô_mbÆloc
();

2570 
pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2571 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

2572 
cou¡
, 
Êags
);

2573 
pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
,

2574 
pxt4_group_t
 
ngroups
);

2575 
pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
,

2576 
pxt4_group_t
 
i
, 
pxt4_group_desc
 *
desc
);

2577 
pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2578 
pxt4_fsblk_t
 
block
, 
cou¡
);

2579 
pxt4_åim_fs
(
su≥r_block
 *, 
f°rim_ønge
 *);

2580 
pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
);

2583 
pxt4_öode_is_Á°_symlök
(
öode
 *inode);

2584 
buf„r_hód
 *
pxt4_gëblk
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2585 
buf„r_hód
 *
pxt4_bªad
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2586 
pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

2587 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
);

2588 
pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2589 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2590 
pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2591 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2592 
pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2593 
buf„r_hód
 *
bh
, 
¸óã
);

2594 
pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

2595 
buf„r_hód
 *
hód
,

2596 
‰om
,

2597 
to
,

2598 *
∑πül
,

2599 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

2600 
buf„r_hód
 *
bh
));

2601 
	`do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

2602 
buf„r_hód
 *
bh
);

2603 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2604 
	#CONVERT_INLINE_DATA
 2

	)

2607 
PXT4_IGET_NORMAL
 = 0,

2608 
PXT4_IGET_SPECIAL
 = 0x0001,

2609 
PXT4_IGET_HANDLE
 = 0x0002

2610 } 
	tpxt4_igë_Êags
;

2612 
öode
 *
	`__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

2613 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

2614 
löe
);

2616 
	#pxt4_igë
(
sb
, 
öo
, 
Êags
) \

2617 
	`__pxt4_igë
((
sb
), (
öo
), (
Êags
), 
__func__
, 
__LINE__
)

	)

2619 
	`pxt4_wrôe_öode
(
öode
 *, 
wrôeback_c⁄åﬁ
 *);

2620 
	`pxt4_£èâr
(
díåy
 *, 
üâr
 *);

2621 
	`pxt4_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2622 
	`pxt4_evi˘_öode
(
öode
 *);

2623 
	`pxt4_˛ór_öode
(
öode
 *);

2624 
	`pxt4_fûe_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2625 
	`pxt4_sync_öode
(
h™dÀ_t
 *, 
öode
 *);

2626 
	`pxt4_dúty_öode
(
öode
 *, );

2627 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *, );

2628 
	`pxt4_gë_öode_loc
(
öode
 *, 
pxt4_ûoc
 *);

2629 
	`pxt4_öode_©èch_jöode
(
öode
 *inode);

2630 
	`pxt4_ˇn_åunˇã
(
öode
 *inode);

2631 
	`pxt4_åunˇã
(
öode
 *);

2632 
	`pxt4_bªak_œyouts
(
öode
 *);

2633 
	`pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
);

2634 
	`pxt4_£t_öode_Êags
(
öode
 *);

2635 
	`pxt4_Æloc_da_blocks
(
öode
 *inode);

2636 
	`pxt4_£t_a›s
(
öode
 *inode);

2637 
	`pxt4_wrôïage_å™s_blocks
(
öode
 *);

2638 
	`pxt4_chunk_å™s_blocks
(
öode
 *, 
ƒblocks
);

2639 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2640 
loff_t
 
l°¨t
,Üoff_à
Ànd
);

2641 
vm_Áu…_t
 
	`pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

2642 
vm_Áu…_t
 
	`pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
);

2643 
qsize_t
 *
	`pxt4_gë_ª£rved_•a˚
(
öode
 *inode);

2644 
	`pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
);

2645 
	`pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
);

2646 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

2647 
u£d
, 
quŸa_˛aim
);

2648 
	`pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2649 
pxt4_fsblk_t
 
pblk
, 
pxt4_lblk_t
 
Àn
);

2652 
	`pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2653 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

2654 
	`pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
);

2655 
	`pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
);

2656 
	`pxt4_öd_åunˇã
(
h™dÀ_t
 *, 
öode
 *inode);

2657 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2658 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
);

2661 
	`pxt4_io˘l
(
fûe
 *, , );

2662 
	`pxt4_com∑t_io˘l
(
fûe
 *, , );

2665 
	`pxt4_ext_migøã
(
öode
 *);

2666 
	`pxt4_öd_migøã
(
öode
 *inode);

2669 
	`pxt4_dúblock_csum_vîify
(
öode
 *inode,

2670 
buf„r_hód
 *
bh
);

2671 
	`pxt4_‹ph™_add
(
h™dÀ_t
 *, 
öode
 *);

2672 
	`pxt4_‹ph™_dñ
(
h™dÀ_t
 *, 
öode
 *);

2673 
	`pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

2674 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
);

2675 
	`pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
,

2676 *
£¨ch_buf
,

2677 
buf_size
,

2678 
öode
 *
dú
,

2679 
pxt4_fûíame
 *
‚ame
,

2680 
off£t
,

2681 
pxt4_dú_íåy_2
 **
ªs_dú
);

2682 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2683 
öode
 *
dú
,

2684 
pxt4_dú_íåy_2
 *
de_dñ
,

2685 
buf„r_hód
 *
bh
,

2686 *
íåy_buf
,

2687 
buf_size
,

2688 
csum_size
);

2689 
boﬁ
 
	`pxt4_em±y_dú
(
öode
 *inode);

2692 
	`pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
);

2693 
	`pxt4_group_add
(
su≥r_block
 *
sb
,

2694 
pxt4_√w_group_d©a
 *
öput
);

2695 
	`pxt4_group_exãnd
(
su≥r_block
 *
sb
,

2696 
pxt4_su≥r_block
 *
es
,

2697 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2698 
	`pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2701 
buf„r_hód
 *
	`pxt4_sb_bªad
(
su≥r_block
 *
sb
,

2702 
£˘‹_t
 
block
, 
›_Êags
);

2703 
	`pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
);

2704 
	`pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
);

2705 
	`pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
);

2706 *
	`pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2707 *
	`pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2708 
	`pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
,

2709 
pxt4_group_t
 
ngroup
);

2710 c⁄° *
	`pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

2711 
nbuf
[16]);

2712 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

2713 
pxt4_group_t
 
block_group
,

2714 
Êags
);

2716 
	$__¥ötf
(4, 5)

2717 
	`__pxt4_îr‹
(
su≥r_block
 *, const *, ,

2719 
	$__¥ötf
(5, 6)

2720 
	`__pxt4_îr‹_öode
(
öode
 *, c⁄° *, , 
pxt4_fsblk_t
,

2722 
	$__¥ötf
(5, 6)

2723 
	`__pxt4_îr‹_fûe
(
fûe
 *, c⁄° *, , 
pxt4_fsblk_t
,

2725 
	`__pxt4_°d_îr‹
(
su≥r_block
 *, const *,

2727 
	$__¥ötf
(4, 5)

2728 
	`__pxt4_ab‹t
(
su≥r_block
 *, const *, ,

2730 
	$__¥ötf
(4, 5)

2731 
	`__pxt4_w¨nög
(
su≥r_block
 *, const *, ,

2733 
	$__¥ötf
(4, 5)

2734 
	`__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

2735 
löe
, c⁄° *
fmt
, ...);

2736 
	$__¥ötf
(3, 4)

2737 
	`__pxt4_msg
(
su≥r_block
 *, const *, const *, ...);

2738 
	`__dump_mmp_msg
(
su≥r_block
 *, 
mmp_°ru˘
 *
mmp
,

2740 
	$__¥ötf
(7, 8)

2741 
	`__pxt4_gΩ_locked_îr‹
(const *, ,

2742 
su≥r_block
 *, 
pxt4_group_t
,

2743 , 
pxt4_fsblk_t
,

2746 
	#PXT4_ERROR_INODE
(
öode
, 
fmt
, 
a
...) \

2747 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2749 
	#PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
, 
fmt
, 
a
...) \

2750 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2752 
	#PXT4_ERROR_FILE
(
fûe
, 
block
, 
fmt
, 
a
...) \

2753 
	`pxt4_îr‹_fûe
((
fûe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2755 #ifde‡
CONFIG_PRINTK


2757 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2758 
	`__pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2759 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2760 
	`__pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2761 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2762 
	`__pxt4_îr‹
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2763 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2764 
	`__pxt4_ab‹t
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2765 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2766 
	`__pxt4_w¨nög
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2767 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2768 
	`__pxt4_w¨nög_öode
(
öode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2769 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2770 
	`__pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ##
__VA_ARGS__
)

	)

2771 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2772 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2773 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2774 
	`__pxt4_gΩ_locked_îr‹
(
__func__
, 
__LINE__
, 
sb
, 
gΩ
, 
öo
, 
block
, \

2775 
fmt
, ##
__VA_ARGS__
)

	)

2779 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2781 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2782 
	`__pxt4_îr‹_öode
(
öode
, "", 0, 
block
, " "); \

2783 
	}
} 0)

	)

2784 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2786 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2787 
	`__pxt4_îr‹_fûe
(
fûe
, "", 0, 
block
, " "); \

2788 } 0)

	)

2789 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2791 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2792 
	`__pxt4_îr‹
(
sb
, "", 0, " "); \

2793 } 0)

	)

2794 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2796 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2797 
	`__pxt4_ab‹t
(
sb
, "", 0, " "); \

2798 } 0)

	)

2799 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2801 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2802 
	`__pxt4_w¨nög
(
sb
, "", 0, " "); \

2803 } 0)

	)

2804 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2806 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2807 
	`__pxt4_w¨nög_öode
(
öode
, "", 0, " "); \

2808 } 0)

	)

2809 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2811 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2812 
	`__pxt4_msg
(
sb
, "", " "); \

2813 } 0)

	)

2814 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2815 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2816 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2818 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2819 
	`__pxt4_gΩ_locked_îr‹
("", 0, 
sb
, 
gΩ
, 
öo
, 
block
, " "); \

2820 } 0)

	)

2824 
pxt4_upd©e_com∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2825 
__u32
 
com∑t
);

2826 
pxt4_upd©e_rocom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2827 
su≥r_block
 *
sb
, 
__u32
 
rocom∑t
);

2828 
pxt4_upd©e_öcom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2829 
su≥r_block
 *
sb
, 
__u32
 
öcom∑t
);

2830 
pxt4_fsblk_t
 
pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

2831 
pxt4_group_desc
 *
bg
);

2832 
pxt4_fsblk_t
 
pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

2833 
pxt4_group_desc
 *
bg
);

2834 
pxt4_fsblk_t
 
pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

2835 
pxt4_group_desc
 *
bg
);

2836 
__u32
 
pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

2837 
pxt4_group_desc
 *
bg
);

2838 
__u32
 
pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

2839 
pxt4_group_desc
 *
bg
);

2840 
__u32
 
pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

2841 
pxt4_group_desc
 *
bg
);

2842 
__u32
 
pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

2843 
pxt4_group_desc
 *
bg
);

2844 
pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

2845 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2846 
pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

2847 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2848 
pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

2849 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2850 
pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

2851 
pxt4_group_desc
 *
bg
,

2852 
__u32
 
cou¡
);

2853 
pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

2854 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2855 
pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

2856 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2857 
pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

2858 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2859 
pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2860 
pxt4_group_desc
 *
gdp
);

2861 
pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2862 
pxt4_group_desc
 *
gdp
);

2863 
pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

2864 
pxt4_group_t
 
fú°_nŸ_zî€d
);

2866 
ölöe
 
	$pxt4_has_mëad©a_csum
(
su≥r_block
 *
sb
)

2868 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2869 !
	`PXT4_SB
(
sb
)->
s_chksum_drivî
);

2871  
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2872 (
	`PXT4_SB
(
sb
)->
s_chksum_drivî
 !
NULL
);

2873 
	}
}

2875 
ölöe
 
	$pxt4_has_group_desc_csum
(
su≥r_block
 *
sb
)

2877  
	`pxt4_has_„©uª_gdt_csum
(
sb
Ë|| 
	`pxt4_has_mëad©a_csum
(sb);

2878 
	}
}

2880 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2882  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_blocks_cou¡_hi
) << 32) |

2883 
	`À32_to_˝u
(
es
->
s_blocks_cou¡_lo
);

2884 
	}
}

2886 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_r_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2888  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_hi
) << 32) |

2889 
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_lo
);

2890 
	}
}

2892 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_‰ì_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2894  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_hi
) << 32) |

2895 
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_lo
);

2896 
	}
}

2898 
ölöe
 
	$pxt4_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2899 
pxt4_fsblk_t
 
blk
)

2901 
es
->
s_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2902 
es
->
s_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2903 
	}
}

2905 
ölöe
 
	$pxt4_‰ì_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2906 
pxt4_fsblk_t
 
blk
)

2908 
es
->
s_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2909 
es
->
s_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2910 
	}
}

2912 
ölöe
 
	$pxt4_r_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2913 
pxt4_fsblk_t
 
blk
)

2915 
es
->
s_r_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2916 
es
->
s_r_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2917 
	}
}

2919 
ölöe
 
loff_t
 
	$pxt4_isize
(
su≥r_block
 *
sb
,

2920 
pxt4_öode
 *
øw_öode
)

2922 i‡(
	`pxt4_has_„©uª_œrgedú
(
sb
) ||

2923 
	`S_ISREG
(
	`À16_to_˝u
(
øw_öode
->
i_mode
)))

2924  ((
loff_t
)
	`À32_to_˝u
(
øw_öode
->
i_size_high
) << 32) |

2925 
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2927  (
loff_t
Ë
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2928 
	}
}

2930 
ölöe
 
	$pxt4_isize_£t
(
pxt4_öode
 *
øw_öode
, 
loff_t
 
i_size
)

2932 
øw_öode
->
i_size_lo
 = 
	`˝u_to_À32
(
i_size
);

2933 
øw_öode
->
i_size_high
 = 
	`˝u_to_À32
(
i_size
 >> 32);

2934 
	}
}

2936 
ölöe


2937 
pxt4_group_öfo
 *
	$pxt4_gë_group_öfo
(
su≥r_block
 *
sb
,

2938 
pxt4_group_t
 
group
)

2940 
pxt4_group_öfo
 **
gΩ_öfo
;

2941 
ödexv
, 
ödexh
;

2942 
	`BUG_ON
(
group
 >
	`PXT4_SB
(
sb
)->
s_groups_cou¡
);

2943 
ödexv
 = 
group
 >> (
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
));

2944 
ödexh
 = 
group
 & ((
	`PXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2945 
gΩ_öfo
 = 
	`sbi_¨øy_rcu_dîef
(
	`PXT4_SB
(
sb
), 
s_group_öfo
, 
ödexv
);

2946  
gΩ_öfo
[
ödexh
];

2947 
	}
}

2954 
ölöe
 
pxt4_group_t
 
	$pxt4_gë_groups_cou¡
(
su≥r_block
 *
sb
)

2956 
pxt4_group_t
 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2958 
	`smp_rmb
();

2959  
ngroups
;

2960 
	}
}

2962 
ölöe
 
pxt4_group_t
 
	$pxt4_Êex_group
(
pxt4_sb_öfo
 *
sbi
,

2963 
pxt4_group_t
 
block_group
)

2965  
block_group
 >> 
sbi
->
s_log_groups_≥r_Êex
;

2966 
	}
}

2968 
ölöe
 
	$pxt4_Êex_bg_size
(
pxt4_sb_öfo
 *
sbi
)

2970  1 << 
sbi
->
s_log_groups_≥r_Êex
;

2971 
	}
}

2973 
	#pxt4_°d_îr‹
(
sb
, 
î∫o
) \

2975 i‡((
î∫o
)) \

2976 
	`__pxt4_°d_îr‹
((
sb
), 
__func__
, 
__LINE__
, (
î∫o
)); \

2977 } 0)

	)

2979 #ifde‡
CONFIG_SMP


2984 
	#PXT4_FREECLUSTERS_WATERMARK
 (4 * (
≥r˝u_cou¡î_b©ch
 * 
ƒ_˝u_ids
))

	)

2986 
	#PXT4_FREECLUSTERS_WATERMARK
 0

	)

2990 
ölöe
 
	$pxt4_upd©e_i_disksize
(
öode
 *öode, 
loff_t
 
√wsize
)

2992 
	`WARN_ON_ONCE
(
	`S_ISREG
(
öode
->
i_mode
) &&

2993 !
	`öode_is_locked
(
öode
));

2994 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2995 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2996 
	`WRITE_ONCE
(
	`PXT4_I
(
öode
)->
i_disksize
, 
√wsize
);

2997 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2998 
	}
}

3001 
ölöe
 
	$pxt4_upd©e_öode_size
(
öode
 *öode, 
loff_t
 
√wsize
)

3003 
ch™ged
 = 0;

3005 i‡(
√wsize
 > 
öode
->
i_size
) {

3006 
	`i_size_wrôe
(
öode
, 
√wsize
);

3007 
ch™ged
 = 1;

3009 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3010 
	`pxt4_upd©e_i_disksize
(
öode
, 
√wsize
);

3011 
ch™ged
 |= 2;

3013  
ch™ged
;

3014 
	}
}

3016 
pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

3017 
loff_t
 
Àn
);

3019 
	spxt4_group_öfo
 {

3020 
	mbb_°©e
;

3021 
rb_roŸ
 
	mbb_‰ì_roŸ
;

3022 
pxt4_gΩblk_t
 
	mbb_fú°_‰ì
;

3023 
pxt4_gΩblk_t
 
	mbb_‰ì
;

3024 
pxt4_gΩblk_t
 
	mbb_‰agmíts
;

3025 
pxt4_gΩblk_t
 
	mbb_œrge°_‰ì_‹dî
;

3026 
li°_hód
 
	mbb_¥óŒoc_li°
;

3027 #ifde‡
DOUBLE_CHECK


3028 *
	mbb_bôm≠
;

3030 
rw_£m≠h‹e
 
	mÆloc_£m
;

3031 
pxt4_gΩblk_t
 
	mbb_cou¡îs
[];

3037 
	#PXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3038 
	#PXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3039 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3040 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3041 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

3042 (1 << 
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

3043 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

3044 (1 << 
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

3046 
	#PXT4_MB_GRP_NEED_INIT
(
gΩ
) \

3047 (
	`ã°_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3048 
	#PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
) \

3049 (
	`ã°_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3050 
	#PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) \

3051 (
	`ã°_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3053 
	#PXT4_MB_GRP_WAS_TRIMMED
(
gΩ
) \

3054 (
	`ã°_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3055 
	#PXT4_MB_GRP_SET_TRIMMED
(
gΩ
) \

3056 (
	`£t_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3057 
	#PXT4_MB_GRP_CLEAR_TRIMMED
(
gΩ
) \

3058 (
	`˛ór_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

3060 
	#PXT4_MAX_CONTENTION
 8

	)

3061 
	#PXT4_CONTENTION_THRESHOLD
 2

	)

3063 
ölöe
 
•ölock_t
 *
	$pxt4_group_lock_±r
(
su≥r_block
 *
sb
,

3064 
pxt4_group_t
 
group
)

3066  
	`bgl_lock_±r
(
	`PXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3067 
	}
}

3073 
ölöe
 
	$pxt4_fs_is_busy
(
pxt4_sb_öfo
 *
sbi
)

3075  (
	`©omic_ªad
(&
sbi
->
s_lock_busy
Ë> 
PXT4_CONTENTION_THRESHOLD
);

3076 
	}
}

3078 
ölöe
 
	$pxt4_lock_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

3080 
•ölock_t
 *
lock
 = 
	`pxt4_group_lock_±r
(
sb
, 
group
);

3081 i‡(
	`•ö_åylock
(
lock
))

3086 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3092 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, 1,

3093 
PXT4_MAX_CONTENTION
);

3094 
	`•ö_lock
(
lock
);

3096 
	}
}

3098 
ölöe
 
	$pxt4_u∆ock_group
(
su≥r_block
 *
sb
,

3099 
pxt4_group_t
 
group
)

3101 
	`•ö_u∆ock
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

3102 
	}
}

3107 
	#pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
) \

3108 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3109 (
__À32
 *)(
bh
)->
b_d©a
, \

3110 
	`PXT4_ADDR_PER_BLOCK
((
öode
)->
i_sb
))

	)

3112 
	#pxt4_öd_check_öode
(
öode
) \

3113 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

3114 
	`PXT4_I
(
öode
)->
i_d©a
, \

3115 
PXT4_NDIR_BLOCKS
)

	)

3122 c⁄° 
fûe_›î©i⁄s
 
pxt4_dú_›î©i⁄s
;

3124 #ifde‡
CONFIG_UNICODE


3125 c⁄° 
díåy_›î©i⁄s
 
pxt4_díåy_›s
;

3129 c⁄° 
öode_›î©i⁄s
 
pxt4_fûe_öode_›î©i⁄s
;

3130 c⁄° 
fûe_›î©i⁄s
 
pxt4_fûe_›î©i⁄s
;

3131 
loff_t
 
pxt4_Œ£ek
(
fûe
 *fûe,Üoff_à
off£t
, 
‹igö
);

3134 
pxt4_gë_max_ölöe_size
(
öode
 *inode);

3135 
pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode);

3136 
pxt4_öô_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3137 
Àn
);

3138 
pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

3140 
pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page);

3141 
pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

3142 
öode
 *inode,

3143 
loff_t
 
pos
, 
Àn
,

3144 
Êags
,

3145 
∑ge
 **
∑gï
);

3146 
pxt4_wrôe_ölöe_d©a_íd
(
öode
 *inode,

3147 
loff_t
 
pos
, 
Àn
,

3148 
c›õd
,

3149 
∑ge
 *page);

3150 
buf„r_hód
 *

3151 
pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

3152 
Àn
,

3153 
∑ge
 *page);

3154 
pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

3155 
öode
 *inode,

3156 
loff_t
 
pos
, 
Àn
,

3157 
Êags
,

3158 
∑ge
 **
∑gï
,

3159 **
fsd©a
);

3160 
pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

3161 
Àn
, 
c›õd
,

3162 
∑ge
 *page);

3163 
pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3164 
pxt4_fûíame
 *
‚ame
,

3165 
öode
 *
dú
, inode *inode);

3166 
pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

3167 
öode
 *
∑ª¡
,

3168 
öode
 *inode);

3169 
pxt4_ªad_ölöe_dú
(
fûe
 *
fûp
,

3170 
dú_c⁄ãxt
 *
˘x
,

3171 *
has_ölöe_d©a
);

3172 
pxt4_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

3173 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

3174 
dx_hash_öfo
 *
höfo
,

3175 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

3176 *
has_ölöe_d©a
);

3177 
buf„r_hód
 *
pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

3178 
pxt4_fûíame
 *
‚ame
,

3179 
pxt4_dú_íåy_2
 **
ªs_dú
,

3180 *
has_ölöe_d©a
);

3181 
pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3182 
öode
 *
dú
,

3183 
pxt4_dú_íåy_2
 *
de_dñ
,

3184 
buf„r_hód
 *
bh
,

3185 *
has_ölöe_d©a
);

3186 
boﬁ
 
em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
);

3187 
buf„r_hód
 *
pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

3188 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3189 *
ªtvÆ
);

3190 
pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

3191 
fõm≠_exã¡_öfo
 *
fõöfo
,

3192 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
);

3194 
	giom≠
;

3195 
pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap);

3197 
pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
);

3199 
pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode);

3201 
ölöe
 
	$pxt4_has_ölöe_d©a
(
öode
 *inode)

3203  
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
) &&

3204 
	`PXT4_I
(
öode
)->
i_ölöe_off
;

3205 
	}
}

3208 c⁄° 
öode_›î©i⁄s
 
pxt4_dú_öode_›î©i⁄s
;

3209 c⁄° 
öode_›î©i⁄s
 
pxt4_•ecül_öode_›î©i⁄s
;

3210 
díåy
 *
pxt4_gë_∑ª¡
(díåy *
chûd
);

3211 
pxt4_dú_íåy_2
 *
pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

3212 
pxt4_dú_íåy_2
 *
de
,

3213 
blocksize
, 
csum_size
,

3214 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
);

3215 
pxt4_öôülize_dúít_èû
(
buf„r_hód
 *
bh
,

3216 
blocksize
);

3217 
pxt4_h™dÀ_dúty_dúblock
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3218 
buf„r_hód
 *
bh
);

3219 
pxt4_ci_com∑ª
(c⁄° 
öode
 *
∑ª¡
,

3220 c⁄° 
q°r
 *
‚ame
,

3221 c⁄° 
q°r
 *
íåy
, 
boﬁ
 
quick
);

3223 
	#S_SHIFT
 12

	)

3224 c⁄° 
	gpxt4_ty≥_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3225 [
S_IFREG
 >> 
S_SHIFT
] = 
PXT4_FT_REG_FILE
,

3226 [
S_IFDIR
 >> 
S_SHIFT
] = 
PXT4_FT_DIR
,

3227 [
S_IFCHR
 >> 
S_SHIFT
] = 
PXT4_FT_CHRDEV
,

3228 [
S_IFBLK
 >> 
S_SHIFT
] = 
PXT4_FT_BLKDEV
,

3229 [
S_IFIFO
 >> 
S_SHIFT
] = 
PXT4_FT_FIFO
,

3230 [
S_IFSOCK
 >> 
S_SHIFT
] = 
PXT4_FT_SOCK
,

3231 [
S_IFLNK
 >> 
S_SHIFT
] = 
PXT4_FT_SYMLINK
,

3234 
ölöe
 
	$pxt4_£t_de_ty≥
(
su≥r_block
 *
sb
,

3235 
pxt4_dú_íåy_2
 *
de
,

3236 
umode_t
 
mode
) {

3237 i‡(
	`pxt4_has_„©uª_fûëy≥
(
sb
))

3238 
de
->
fûe_ty≥
 = 
pxt4_ty≥_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3239 
	}
}

3242 
pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

3243 
li°_hód
 *
∑ges
, 
∑ge
 *page,

3244 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
);

3245 
__öô
 
pxt4_öô_po°_ªad_¥o˚ssög
();

3246 
pxt4_exô_po°_ªad_¥o˚ssög
();

3249 c⁄° 
öode_›î©i⁄s
 
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3250 c⁄° 
öode_›î©i⁄s
 
pxt4_symlök_öode_›î©i⁄s
;

3251 c⁄° 
öode_›î©i⁄s
 
pxt4_Á°_symlök_öode_›î©i⁄s
;

3254 
pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
);

3255 
pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
);

3256 
__öô
 
pxt4_öô_sysfs
();

3257 
pxt4_exô_sysfs
();

3260 
pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3261 
pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3262 
__öô
 
pxt4_öô_sy°em_z⁄e
();

3263 
pxt4_exô_sy°em_z⁄e
();

3264 
pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
,

3265 
pxt4_fsblk_t
 
°¨t_blk
,

3266 
cou¡
);

3267 
pxt4_check_blockªf
(const *, ,

3268 
öode
 *, 
__À32
 *, );

3271 
	gpxt4_ext_∑th
;

3272 
	gpxt4_exã¡
;

3278 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3280 
pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *);

3281 
pxt4_ext_wrôïage_å™s_blocks
(
öode
 *, );

3282 
pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
);

3283 
pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3284 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3285 
pxt4_ext_åunˇã
(
h™dÀ_t
 *, 
öode
 *);

3286 
pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

3287 
pxt4_lblk_t
 
íd
);

3288 
pxt4_ext_öô
(
su≥r_block
 *);

3289 
pxt4_ext_ªÀa£
(
su≥r_block
 *);

3290 
pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

3291 
loff_t
 
Àn
);

3292 
pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3293 
loff_t
 
off£t
, 
ssize_t
 
Àn
);

3294 
pxt4_c⁄vît_unwrôãn_io_íd_vec
(
h™dÀ_t
 *
h™dÀ
,

3295 
pxt4_io_íd_t
 *
io_íd
);

3296 
pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3297 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3298 
pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *inode,

3299 
pxt4_lblk_t
 
lblocks
);

3300 
pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *inode,

3301 
num
,

3302 
pxt4_ext_∑th
 *
∑th
);

3303 
pxt4_ˇn_exã¡s_be_mîged
(
öode
 *inode,

3304 
pxt4_exã¡
 *
ex1
,

3305 
pxt4_exã¡
 *
ex2
);

3306 
pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *, 
öode
 *,

3307 
pxt4_ext_∑th
 **,

3308 
pxt4_exã¡
 *, );

3309 
pxt4_ext_∑th
 *
pxt4_föd_exã¡
(
öode
 *, 
pxt4_lblk_t
,

3310 
pxt4_ext_∑th
 **,

3311 
Êags
);

3312 
pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *);

3313 
pxt4_ext_check_öode
(
öode
 *inode);

3314 
pxt4_lblk_t
 
pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
);

3315 
pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

3316 
__u64
 
°¨t
, __u64 
Àn
);

3317 
pxt4_gë_es_ˇche
(
öode
 *inode,

3318 
fõm≠_exã¡_öfo
 *
fõöfo
,

3319 
__u64
 
°¨t
, __u64 
Àn
);

3320 
pxt4_ext_¥eˇche
(
öode
 *inode);

3321 
pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3322 
pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3323 
pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

3324 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,

3325 
pxt4_lblk_t
 
lblk2
,Öxt4_lblk_à
cou¡
,

3326 
m¨k_unwrôãn
,*
îr
);

3327 
pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
);

3328 
pxt4_d©a£m_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3329 
check_¸ed
, 
ª°¨t_¸ed
,

3330 
ªvoke_¸ed
);

3334 
pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
,

3335 
öode
 *
£c⁄d
);

3336 
pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

3337 
öode
 *
d⁄‹_öode
);

3338 
pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
,

3339 
__u64
 
°¨t_‹ig
, __u64 
°¨t_d⁄‹
,

3340 
__u64
 
Àn
, __u64 *
moved_Àn
);

3343 
__öô
 
pxt4_öô_∑geio
();

3344 
pxt4_exô_∑geio
();

3345 
pxt4_io_íd_t
 *
pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
);

3346 
pxt4_io_íd_t
 *
pxt4_gë_io_íd
’xt4_io_íd_à*
io_íd
);

3347 
pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
);

3348 
pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
);

3349 
pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

3350 
wrôeback_c⁄åﬁ
 *
wbc
);

3351 
pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
);

3352 
pxt4_io_submô
(pxt4_io_submô *
io
);

3353 
pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

3354 
∑ge
 *page,

3355 
Àn
,

3356 
wrôeback_c⁄åﬁ
 *
wbc
,

3357 
boﬁ
 
kìp_towrôe
);

3358 
pxt4_io_íd_vec
 *
pxt4_Æloc_io_íd_vec
(
pxt4_io_íd_t
 *
io_íd
);

3359 
pxt4_io_íd_vec
 *
pxt4_œ°_io_íd_vec
(
pxt4_io_íd_t
 *
io_íd
);

3362 
pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *, 
pxt4_fsblk_t
);

3365 c⁄° 
fsvîôy_›î©i⁄s
 
pxt4_vîôy›s
;

3372 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eSèπ


	)

3374 
ölöe
 
	$bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3376  (
	`buf„r_u±od©e
(
bh
) &&

3377 
	`ã°_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
));

3378 
	}
}

3379 
ölöe
 
	$£t_bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3381 
	`£t_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
);

3382 
	}
}

3384 
	#ö_ønge
(
b
, 
fú°
, 
Àn
Ë((bË>(fú°Ë&& (bË<(fú°Ë+ (ÀnË- 1)

	)

3387 
	#PXT4_WQ_HASH_SZ
 37

	)

3388 
	#pxt4_i€nd_wq
(
v
Ë(&
pxt4__i€nd_wq
[(()(v)) %\

3389 
PXT4_WQ_HASH_SZ
])

	)

3390 
waô_queue_hód_t
 
pxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

3392 
pxt4_ªsize_begö
(
su≥r_block
 *
sb
);

3393 
pxt4_ªsize_íd
(
su≥r_block
 *
sb
);

3395 
ölöe
 
	$pxt4_£t_io_unwrôãn_Êag
(
öode
 *inode,

3396 
pxt4_io_íd
 *
io_íd
)

3398 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
)) {

3399 
io_íd
->
Êag
 |
PXT4_IO_END_UNWRITTEN
;

3400 
	`©omic_öc
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
);

3402 
	}
}

3404 
ölöe
 
	$pxt4_˛ór_io_unwrôãn_Êag
(
pxt4_io_íd_t
 *
io_íd
)

3406 
öode
 *öodê
io_íd
->inode;

3408 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

3409 
io_íd
->
Êag
 &~
PXT4_IO_END_UNWRITTEN
;

3411 i‡(
	`©omic_dec_™d_ã°
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
))

3412 
	`wake_up_Æl
(
	`pxt4_i€nd_wq
(
öode
));

3414 
	}
}

3416 c⁄° 
iom≠_›s
 
pxt4_iom≠_›s
;

3417 c⁄° 
iom≠_›s
 
pxt4_iom≠_ªp‹t_›s
;

3419 
ölöe
 
	$pxt4_buf„r_u±od©e
(
buf„r_hód
 *
bh
)

3427 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& 
	`buf„r_wrôe_io_îr‹
(bh))

3428 
	`£t_buf„r_u±od©e
(
bh
);

3429  
	`buf„r_u±od©e
(
bh
);

3430 
	}
}

3434 
	#EFSBADCRC
 
EBADMSG


	)

3435 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@pxt4.mod.c

1 
	~<löux/buûd-ß….h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/vîmagic.h
>

4 
	~<löux/compûî.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

11 
__visibÀ
 
moduÀ
 
__this_moduÀ


12 
__£˘i⁄
(.
gnu
.
lök⁄˚
.
this_moduÀ
) = {

13 .
«me
 = 
KBUILD_MODNAME
,

14 .
	göô
 = 
öô_moduÀ
,

15 #ifde‡
CONFIG_MODULE_UNLOAD


16 .
	gexô
 = 
˛ónup_moduÀ
,

18 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

21 #ifde‡
CONFIG_RETPOLINE


22 
MODULE_INFO
(
ªçﬁöe
, "Y");

25 
MODULE_INFO
(
dïíds
, "");

	@pxt4_extents.h

7 #i‚de‡
_PXT4_EXTENTS


8 
	#_PXT4_EXTENTS


	)

10 
	~"pxt4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	spxt4_exã¡_èû
 {

56 
__À32
 
	më_checksum
;

63 
	spxt4_exã¡
 {

64 
__À32
 
	mì_block
;

65 
__À16
 
	mì_Àn
;

66 
__À16
 
	mì_°¨t_hi
;

67 
__À32
 
	mì_°¨t_lo
;

74 
	spxt4_exã¡_idx
 {

75 
__À32
 
	mei_block
;

76 
__À32
 
	mei_Àaf_lo
;

78 
__À16
 
	mei_Àaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	spxt4_exã¡_hódî
 {

86 
__À16
 
	meh_magic
;

87 
__À16
 
	meh_íåõs
;

88 
__À16
 
	meh_max
;

89 
__À16
 
	meh_dïth
;

90 
__À32
 
	meh_gíî©i⁄
;

93 
	#PXT4_EXT_MAGIC
 
	`˝u_to_À16
(0xf30a)

	)

94 
	#PXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#PXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
pxt4_exã¡_hódî
) + \

98 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
((
hdr
)->
eh_max
)))

	)

100 
ölöe
 
pxt4_exã¡_èû
 *

101 
	$föd_pxt4_exã¡_èû
(
pxt4_exã¡_hódî
 *
eh
)

103  (
pxt4_exã¡_èû
 *)(((*)
eh
) +

104 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	spxt4_ext_∑th
 {

113 
pxt4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_dïth
;

115 
__u16
 
	mp_maxdïth
;

116 
pxt4_exã¡
 *
	mp_ext
;

117 
pxt4_exã¡_idx
 *
	mp_idx
;

118 
pxt4_exã¡_hódî
 *
	mp_hdr
;

119 
buf„r_hód
 *
	mp_bh
;

129 
	s∑πül_˛u°î
 {

130 
pxt4_fsblk_t
 
	mp˛u
;

131 
pxt4_lblk_t
 
	mlblk
;

132 íum {
	möôül
, 
	mto‰ì
, 
	mno‰ì
} 
	m°©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
pxt4_exã¡
 *Ë(((*Ë(
__hdr__
)) + \

162 (
pxt4_exã¡_hódî
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
pxt4_exã¡_idx
 *Ë(((*Ë(
__hdr__
)) + \

165 (
pxt4_exã¡_hódî
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__∑th__
) \

167 (
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_íåõs
) \

168 < 
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

175 
	#EXT_MAX_INDEX
(
__hdr__
) \

176 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

178 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_öode_hdr
(
öode
 *inode)

180  (
pxt4_exã¡_hódî
 *Ë
	`PXT4_I
(
öode
)->
i_d©a
;

181 
	}
}

183 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_block_hdr
(
buf„r_hód
 *
bh
)

185  (
pxt4_exã¡_hódî
 *Ë
bh
->
b_d©a
;

186 
	}
}

188 
ölöe
 
	$ext_dïth
(
öode
 *inode)

190  
	`À16_to_˝u
(
	`ext_öode_hdr
(
öode
)->
eh_dïth
);

191 
	}
}

193 
ölöe
 
	$pxt4_ext_m¨k_unwrôãn
(
pxt4_exã¡
 *
ext
)

196 
	`BUG_ON
((
	`À16_to_˝u
(
ext
->
ì_Àn
Ë& ~
EXT_INIT_MAX_LEN
) == 0);

197 
ext
->
ì_Àn
 |
	`˝u_to_À16
(
EXT_INIT_MAX_LEN
);

198 
	}
}

200 
ölöe
 
	$pxt4_ext_is_unwrôãn
(
pxt4_exã¡
 *
ext
)

203  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë> 
EXT_INIT_MAX_LEN
);

204 
	}
}

206 
ölöe
 
	$pxt4_ext_gë_a˘uÆ_Àn
(
pxt4_exã¡
 *
ext
)

208  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë<
EXT_INIT_MAX_LEN
 ?

209 
	`À16_to_˝u
(
ext
->
ì_Àn
) :

210 (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë- 
EXT_INIT_MAX_LEN
));

211 
	}
}

213 
ölöe
 
	$pxt4_ext_m¨k_öôülized
(
pxt4_exã¡
 *
ext
)

215 
ext
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ext));

216 
	}
}

222 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_ext_pblock
(
pxt4_exã¡
 *
ex
)

224 
pxt4_fsblk_t
 
block
;

226 
block
 = 
	`À32_to_˝u
(
ex
->
ì_°¨t_lo
);

227 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ex
->
ì_°¨t_hi
) << 31) << 1;

228  
block
;

229 
	}
}

235 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_idx_pblock
(
pxt4_exã¡_idx
 *
ix
)

237 
pxt4_fsblk_t
 
block
;

239 
block
 = 
	`À32_to_˝u
(
ix
->
ei_Àaf_lo
);

240 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ix
->
ei_Àaf_hi
) << 31) << 1;

241  
block
;

242 
	}
}

249 
ölöe
 
	$pxt4_ext_°‹e_pblock
(
pxt4_exã¡
 *
ex
,

250 
pxt4_fsblk_t
 
pb
)

252 
ex
->
ì_°¨t_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

253 
ex
->
ì_°¨t_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

255 
	}
}

262 
ölöe
 
	$pxt4_idx_°‹e_pblock
(
pxt4_exã¡_idx
 *
ix
,

263 
pxt4_fsblk_t
 
pb
)

265 
ix
->
ei_Àaf_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

266 
ix
->
ei_Àaf_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

268 
	}
}

270 
	#pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
) \

271 
	`__pxt4_ext_dúty
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), (
∑th
))

	)

272 
__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

273 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
);

	@pxt4_jbd3.c

6 
	~"pxt4_jbd3.h
"

8 
	~<åa˚/evíts/pxt4.h
>

11 
h™dÀ_t
 *
	$pxt4_gë_nojou∫Æ
()

13 
h™dÀ_t
 *
h™dÀ
 = 
cuºít
->
jou∫Æ_öfo
;

14 
ªf_˙t
 = ()
h™dÀ
;

16 
	`BUG_ON
(
ªf_˙t
 >
PXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
ªf_˙t
++;

19 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

21 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

22  
h™dÀ
;

23 
	}
}

27 
	$pxt4_put_nojou∫Æ
(
h™dÀ_t
 *
h™dÀ
)

29 
ªf_˙t
 = ()
h™dÀ
;

31 
	`BUG_ON
(
ªf_˙t
 == 0);

33 
ªf_˙t
--;

34 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

36 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

37 
	}
}

42 
	$pxt4_jou∫Æ_check_°¨t
(
su≥r_block
 *
sb
)

44 
jou∫Æ_t
 *
jou∫Æ
;

46 
	`might_¶ìp
();

48 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

49  -
EIO
;

51 i‡(
	`sb_rd⁄ly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wrôîs
.
‰ozí
 =
SB_FREEZE_COMPLETE
);

54 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

60 i‡(
jou∫Æ
 && 
	`is_jou∫Æ_ab‹ãd
(journal)) {

61 
	`pxt4_ab‹t
(
sb
, "Detectedáborted journal");

62  -
EROFS
;

65 
	}
}

67 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

68 
ty≥
, 
blocks
, 
rsv_blocks
,

69 
ªvoke_¸eds
)

71 
jou∫Æ_t
 *
jou∫Æ
;

72 
îr
;

74 
	`åa˚_pxt4_jou∫Æ_°¨t
(
sb
, 
blocks
, 
rsv_blocks
, 
ªvoke_¸eds
,

75 
_RET_IP_
);

76 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

77 i‡(
îr
 < 0)

78  
	`ERR_PTR
(
îr
);

80 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

81 i‡(!
jou∫Æ
)

82  
	`pxt4_gë_nojou∫Æ
();

83  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
blocks
, 
rsv_blocks
, 
ªvoke_¸eds
,

84 
GFP_NOFS
, 
ty≥
, 
löe
);

85 
	}
}

87 
	$__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
)

89 
su≥r_block
 *
sb
;

90 
îr
;

91 
rc
;

93 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

94 
	`pxt4_put_nojou∫Æ
(
h™dÀ
);

98 
îr
 = 
h™dÀ
->
h_îr
;

99 i‡(!
h™dÀ
->
h_å™ß˘i⁄
) {

100 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

101  
îr
 ?Éº : 
rc
;

104 
sb
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
;

105 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

107 i‡(!
îr
)

108 
îr
 = 
rc
;

109 i‡(
îr
)

110 
	`__pxt4_°d_îr‹
(
sb
, 
whîe
, 
löe
, 
îr
);

111  
îr
;

112 
	}
}

114 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
löe
,

115 
ty≥
)

117 
su≥r_block
 *
sb
;

118 
îr
;

120 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

121  
	`pxt4_gë_nojou∫Æ
();

123 
sb
 = 
h™dÀ
->
h_jou∫Æ
->
j_¥iv©e
;

124 
	`åa˚_pxt4_jou∫Æ_°¨t_ª£rved
(
sb
,

125 
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
), 
_RET_IP_
);

126 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

127 i‡(
îr
 < 0) {

128 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

129  
	`ERR_PTR
(
îr
);

132 
îr
 = 
	`jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
, 
löe
);

133 i‡(
îr
 < 0)

134  
	`ERR_PTR
(
îr
);

135  
h™dÀ
;

136 
	}
}

138 
	$__pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
check_¸ed
,

139 
exãnd_¸ed
, 
ªvoke_¸ed
)

141 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

143 i‡(
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
Ë>
check_¸ed
 &&

144 
h™dÀ
->
h_ªvoke_¸edôs
 >
ªvoke_¸ed
)

146 
exãnd_¸ed
 = 
	`max
(0,Éxãnd_¸ed - 
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
));

147 
ªvoke_¸ed
 = 
	`max
(0,Ñevoke_¸ed - 
h™dÀ
->
h_ªvoke_¸edôs
);

148  
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
exãnd_¸ed
, 
ªvoke_¸ed
);

149 
	}
}

151 
	$pxt4_jou∫Æ_ab‹t_h™dÀ
(c⁄° *
ˇŒî
, 
löe
,

152 c⁄° *
îr_‚
,

153 
buf„r_hód
 *
bh
,

154 
h™dÀ_t
 *
h™dÀ
, 
îr
)

156 
nbuf
[16];

157 c⁄° *
îr°r
 = 
	`pxt4_decode_îr‹
(
NULL
, 
îr
, 
nbuf
);

159 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

161 i‡(
bh
)

162 
	`BUFFER_TRACE
(
bh
, "abort");

164 i‡(!
h™dÀ
->
h_îr
)

165 
h™dÀ
->
h_îr
 = 
îr
;

167 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

170 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d:ábortingÅransaction: %s in %s\n",

171 
ˇŒî
, 
löe
, 
îr°r
, 
îr_‚
);

173 
	`jbd3_jou∫Æ_ab‹t_h™dÀ
(
h™dÀ
);

174 
	}
}

176 
	$__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

177 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

179 
îr
 = 0;

181 
	`might_¶ìp
();

183 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

184 
îr
 = 
	`jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

185 i‡(
îr
)

186 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

187 
h™dÀ
, 
îr
);

189  
îr
;

190 
	}
}

204 
	$__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

205 
is_mëad©a
, 
öode
 *inode,

206 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
)

208 
îr
;

210 
	`might_¶ìp
();

212 
	`åa˚_pxt4_f‹gë
(
öode
, 
is_mëad©a
, 
blockƒ
);

213 
	`BUFFER_TRACE
(
bh
, "enter");

215 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

217 
bh
, 
is_mëad©a
, 
öode
->
i_mode
,

218 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
));

221 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

222 
	`bf‹gë
(
bh
);

231 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

232 (!
is_mëad©a
 && !
	`pxt4_should_jou∫Æ_d©a
(
öode
))) {

233 i‡(
bh
) {

234 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_forget");

235 
îr
 = 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh
);

236 i‡(
îr
)

237 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

238 
bh
, 
h™dÀ
, 
îr
);

239  
îr
;

247 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_revoke");

248 
îr
 = 
	`jbd3_jou∫Æ_ªvoke
(
h™dÀ
, 
blockƒ
, 
bh
);

249 i‡(
îr
) {

250 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

251 
bh
, 
h™dÀ
, 
îr
);

252 
	`__pxt4_ab‹t
(
öode
->
i_sb
, 
whîe
, 
löe
,

253 "îr‹ %d whíáâem±ögÑevoke", 
îr
);

255 
	`BUFFER_TRACE
(
bh
, "exit");

256  
îr
;

257 
	}
}

259 
	$__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

260 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

262 
îr
 = 0;

264 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

265 
îr
 = 
	`jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

266 i‡(
îr
)

267 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

268 
bh
, 
h™dÀ
, 
îr
);

270  
îr
;

271 
	}
}

273 
	$__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

274 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

275 
buf„r_hód
 *
bh
)

277 
îr
 = 0;

279 
	`might_¶ìp
();

281 
	`£t_buf„r_mëa
(
bh
);

282 
	`£t_buf„r_¥io
(
bh
);

283 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

284 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

286 i‡(!
	`is_h™dÀ_ab‹ãd
(
h™dÀ
Ë&& 
	`WARN_ON_ONCE
(
îr
)) {

287 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

288 
h™dÀ
, 
îr
);

289 i‡(
öode
 =
NULL
) {

290 
	`¥_îr
("PXT4: jbd3_journal_dirty_metadata "

293 
h™dÀ
->
h_ty≥
,

294 
h™dÀ
->
h_löe_no
,

295 
h™dÀ
->
h_ªque°ed_¸edôs
,

296 
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
), 
îr
);

297  
îr
;

299 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

300 
bh
->
b_blockƒ
,

304 
h™dÀ
->
h_ty≥
,

305 
h™dÀ
->
h_löe_no
,

306 
h™dÀ
->
h_ªque°ed_¸edôs
,

307 
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
),

308 
îr
);

311 i‡(
öode
)

312 
	`m¨k_buf„r_dúty_öode
(
bh
, 
öode
);

314 
	`m¨k_buf„r_dúty
(
bh
);

315 i‡(
öode
 && 
	`öode_√eds_sync
(inode)) {

316 
	`sync_dúty_buf„r
(
bh
);

317 i‡(
	`buf„r_ªq
(
bh
Ë&& !
	`buf„r_u±od©e
(bh)) {

318 
pxt4_su≥r_block
 *
es
;

320 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

321 
es
->
s_œ°_îr‹_block
 =

322 
	`˝u_to_À64
(
bh
->
b_blockƒ
);

323 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

324 
bh
->
b_blockƒ
,

326 
îr
 = -
EIO
;

330  
îr
;

331 
	}
}

333 
	$__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

334 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
)

336 
buf„r_hód
 *
bh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

337 
îr
 = 0;

339 
	`pxt4_su≥rblock_csum_£t
(
sb
);

340 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

341 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

342 i‡(
îr
)

343 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

344 
bh
, 
h™dÀ
, 
îr
);

346 
	`m¨k_buf„r_dúty
(
bh
);

347  
îr
;

348 
	}
}

	@pxt4_jbd3.h

12 #i‚de‡
_PXT4_JBD3_H


13 
	#_PXT4_JBD3_H


	)

15 
	~<löux/fs.h
>

16 
	~<löux/jbd3.h
>

17 
	~"pxt4.h
"

19 
	#PXT4_JOURNAL
(
öode
Ë(
	`PXT4_SB
((öode)->
i_sb
)->
s_jou∫Æ
)

	)

33 
	#PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`pxt4_has_„©uª_exã¡s
(
sb
Ë? 20U : 8U)

	)

40 
	#PXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#PXT4_DATA_TRANS_BLOCKS
(
sb
Ë(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
PXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#PXT4_META_TRANS_BLOCKS
(
sb
Ë(
PXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#PXT4_MAX_TRANS_DATA
 64U

	)

75 
	#PXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#PXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifde‡
CONFIG_QUOTA


89 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

90 
	`pxt4_has_„©uª_quŸa
(
sb
)Ë? 1 : 0)

	)

93 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

94 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
Ë: 0)

	)

98 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

99 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
Ë: 0)

	)

103 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë0

	)

104 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë0

	)

105 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë0

	)

107 
	#PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#PXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#PXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#PXT4_HT_MISC
 0

	)

115 
	#PXT4_HT_INODE
 1

	)

116 
	#PXT4_HT_WRITE_PAGE
 2

	)

117 
	#PXT4_HT_MAP_BLOCKS
 3

	)

118 
	#PXT4_HT_DIR
 4

	)

119 
	#PXT4_HT_TRUNCATE
 5

	)

120 
	#PXT4_HT_QUOTA
 6

	)

121 
	#PXT4_HT_RESIZE
 7

	)

122 
	#PXT4_HT_MIGRATE
 8

	)

123 
	#PXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#PXT4_HT_XATTR
 10

	)

125 
	#PXT4_HT_EXT_CONVERT
 11

	)

126 
	#PXT4_HT_MAX
 12

	)

136 
	spxt4_jou∫Æ_cb_íåy
 {

138 
li°_hód
 
	mj˚_li°
;

141 (*
	mj˚_func
)(
su≥r_block
 *
	msb
,

142 
pxt4_jou∫Æ_cb_íåy
 *
	mj˚
, 
	mîr‹
);

168 
ölöe
 
	$_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

169 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

172 
	`li°_add_èû
(&
j˚
->
j˚_li°
, &
h™dÀ
->
h_å™ß˘i⁄
->
t_¥iv©e_li°
);

173 
	}
}

175 
ölöe
 
	$pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

176 (*
func
)(
su≥r_block
 *
sb
,

177 
pxt4_jou∫Æ_cb_íåy
 *
j˚
,

178 
rc
),

179 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

181 
pxt4_sb_öfo
 *
sbi
 =

182 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

185 
j˚
->
j˚_func
 = 
func
;

186 
	`•ö_lock
(&
sbi
->
s_md_lock
);

187 
	`_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ
, 
j˚
);

188 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
ölöe
 
boﬁ
 
	$pxt4_jou∫Æ_ˇŒback_åy_dñ
(
h™dÀ_t
 *
h™dÀ
,

199 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

201 
boﬁ
 
dñëed
;

202 
pxt4_sb_öfo
 *
sbi
 =

203 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

205 
	`•ö_lock
(&
sbi
->
s_md_lock
);

206 
dñëed
 = !
	`li°_em±y
(&
j˚
->
j˚_li°
);

207 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

208 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

209  
dñëed
;

210 
	}
}

213 
pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

214 
öode
 *inode,

215 
pxt4_ûoc
 *
ûoc
);

222 
pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

223 
pxt4_ûoc
 *
ûoc
);

225 
pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

227 
pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

228 
√w_exåa_isize
,

229 
pxt4_ûoc
 *
ûoc
);

233 
__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

234 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

236 
__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

237 
is_mëad©a
, 
öode
 *inode,

238 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
);

240 
__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

241 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

243 
__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

244 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

245 
buf„r_hód
 *
bh
);

247 
__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

248 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
);

250 
	#pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
) \

251 
	`__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

252 
	#pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block_ƒ
) \

253 
	`__pxt4_f‹gë
(
__func__
, 
__LINE__
, (
h™dÀ
), (
is_mëad©a
), (
öode
), \

254 (
bh
), (
block_ƒ
))

	)

255 
	#pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
) \

256 
	`__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

257 
	#pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
) \

258 
	`__pxt4_h™dÀ_dúty_mëad©a
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), \

259 (
bh
))

	)

260 
	#pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
) \

261 
	`__pxt4_h™dÀ_dúty_su≥r
(
__func__
, 
__LINE__
, (
h™dÀ
), (
sb
))

	)

263 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

264 
ty≥
, 
blocks
, 
rsv_blocks
,

265 
ªvoke_¸eds
);

266 
__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
);

268 
	#PXT4_NOJOURNAL_MAX_REF_COUNT
 ((Ë4096)

	)

272 
ölöe
 
	$pxt4_h™dÀ_vÆid
(
h™dÀ_t
 *
h™dÀ
)

274 i‡(()
h™dÀ
 < 
PXT4_NOJOURNAL_MAX_REF_COUNT
)

277 
	}
}

279 
ölöe
 
	$pxt4_h™dÀ_sync
(
h™dÀ_t
 *
h™dÀ
)

281 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

282 
h™dÀ
->
h_sync
 = 1;

283 
	}
}

285 
ölöe
 
	$pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ_t
 *
h™dÀ
)

287 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

288  
	`is_h™dÀ_ab‹ãd
(
h™dÀ
);

290 
	}
}

292 
ölöe
 
	$pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
su≥r_block
 *
sb
,

293 
blocks
)

296  
blocks
 * 
	`PXT4_SB
(
sb
)->
s_˛u°î_øtio
;

297 
	}
}

299 
ölöe
 
	$pxt4_å™s_deÁu…_ªvoke_¸edôs
(
su≥r_block
 *
sb
)

301  
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
sb
, 8);

302 
	}
}

304 
	#pxt4_jou∫Æ_°¨t_sb
(
sb
, 
ty≥
, 
nblocks
) \

305 
	`__pxt4_jou∫Æ_°¨t_sb
((
sb
), 
__LINE__
, (
ty≥
), (
nblocks
), 0, \

306 
	`pxt4_å™s_deÁu…_ªvoke_¸edôs
(
sb
))

	)

308 
	#pxt4_jou∫Æ_°¨t
(
öode
, 
ty≥
, 
nblocks
) \

309 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
nblocks
), 0, \

310 
	`pxt4_å™s_deÁu…_ªvoke_¸edôs
((
öode
)->
i_sb
))

	)

312 
	#pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
, 
ty≥
, 
blocks
, 
rsv_blocks
)\

313 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), (
rsv_blocks
),\

314 
	`pxt4_å™s_deÁu…_ªvoke_¸edôs
((
öode
)->
i_sb
))

	)

316 
	#pxt4_jou∫Æ_°¨t_wôh_ªvoke
(
öode
, 
ty≥
, 
blocks
, 
ªvoke_¸eds
) \

317 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), 0, \

318 (
ªvoke_¸eds
))

	)

320 
ölöe
 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t
(
öode
 *inode,

321 
löe
, 
ty≥
,

322 
blocks
, 
rsv_blocks
,

323 
ªvoke_¸eds
)

325  
	`__pxt4_jou∫Æ_°¨t_sb
(
öode
->
i_sb
, 
löe
, 
ty≥
, 
blocks
,

326 
rsv_blocks
, 
ªvoke_¸eds
);

327 
	}
}

329 
	#pxt4_jou∫Æ_°›
(
h™dÀ
) \

330 
	`__pxt4_jou∫Æ_°›
(
__func__
, 
__LINE__
, (
h™dÀ
))

	)

332 
	#pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
) \

333 
	`__pxt4_jou∫Æ_°¨t_ª£rved
((
h™dÀ
), 
__LINE__
, (
ty≥
))

	)

335 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_ª£rved
(h™dÀ_à*
h™dÀ
, 
löe
,

336 
ty≥
);

338 
ölöe
 
	$pxt4_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

340 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

341 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

342 
	}
}

344 
ölöe
 
h™dÀ_t
 *
	$pxt4_jou∫Æ_cuºít_h™dÀ
()

346  
	`jou∫Æ_cuºít_h™dÀ
();

347 
	}
}

349 
ölöe
 
	$pxt4_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
, 
ªvoke
)

351 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

352  
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
, 
nblocks
, 
ªvoke
);

354 
	}
}

356 
ölöe
 
	$pxt4_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
,

357 
ªvoke
)

359 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

360  
	`jbd3__jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
, 
ªvoke
, 
GFP_NOFS
);

362 
	}
}

364 
__pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
check_¸ed
,

365 
exãnd_¸ed
, 
ªvoke_¸ed
);

378 
	#pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
check_¸ed
, 
exãnd_¸ed
, \

379 
ªvoke_¸ed
, 
‚
) \

381 
__œbñ__
 
__ísuª_íd
; \

382 
îr
 = 
	`__pxt4_jou∫Æ_ísuª_¸edôs
((
h™dÀ
), (
check_¸ed
), \

383 (
exãnd_¸ed
), (
ªvoke_¸ed
)); \

385 i‡(
îr
 <= 0) \

386 
__ísuª_íd
; \

387 
îr
 = (
‚
); \

388 i‡(
îr
 < 0) \

389 
__ísuª_íd
; \

390 
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
((
h™dÀ
), (
exãnd_¸ed
), (
ªvoke_¸ed
)); \

391 i‡(
îr
 == 0) \

392 
îr
 = 1; \

393 
__ísuª_íd
: \

394 
îr
; \

395 })

	)

404 
ölöe
 
	$pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
¸edôs
,

405 
ªvoke_¸eds
)

407  
	`pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
¸edôs
, credits,

408 
ªvoke_¸eds
, 0);

409 
	}
}

411 
ölöe
 
	$pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

413 i‡(
	`PXT4_JOURNAL
(
öode
Ë!
NULL
)

414  
	`jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
);

416 
	}
}

418 
ölöe
 
	$pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

420 i‡(
jou∫Æ
)

421  
	`jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

423 
	}
}

425 
ölöe
 
	$pxt4_jbd3_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
,

426 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

428 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

429  
	`jbd3_jou∫Æ_öode_ønged_wrôe
(
h™dÀ
,

430 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

432 
	}
}

434 
ölöe
 
	$pxt4_jbd3_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
,

435 
öode
 *öode, 
loff_t
 
°¨t_byã
,Üoff_à
Àngth
)

437 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

438  
	`jbd3_jou∫Æ_öode_ønged_waô
(
h™dÀ
,

439 
	`PXT4_I
(
öode
)->
jöode
, 
°¨t_byã
, 
Àngth
);

441 
	}
}

443 
ölöe
 
	$pxt4_upd©e_öode_fsync_å™s
(
h™dÀ_t
 *
h™dÀ
,

444 
öode
 *inode,

445 
d©async
)

447 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

449 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& !
	`is_h™dÀ_ab‹ãd
(handle)) {

450 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

451 i‡(
d©async
)

452 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

454 
	}
}

457 
pxt4_f‹˚_commô
(
su≥r_block
 *
sb
);

462 
	#PXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

463 
	#PXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

464 
	#PXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

466 
ölöe
 
	$pxt4_öode_jou∫Æ_mode
(
öode
 *inode)

468 i‡(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
)

469  
PXT4_INODE_WRITEBACK_DATA_MODE
;

471 i‡(!
	`S_ISREG
(
öode
->
i_mode
) ||

472 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
) ||

473 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

474 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
) &&

475 !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))) {

477 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode))

478  
PXT4_INODE_ORDERED_DATA_MODE
;

479  
PXT4_INODE_JOURNAL_DATA_MODE
;

481 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

482  
PXT4_INODE_ORDERED_DATA_MODE
;

483 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

484  
PXT4_INODE_WRITEBACK_DATA_MODE
;

485 
	`BUG
();

486 
	}
}

488 
ölöe
 
	$pxt4_should_jou∫Æ_d©a
(
öode
 *inode)

490  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_JOURNAL_DATA_MODE
;

491 
	}
}

493 
ölöe
 
	$pxt4_should_‹dî_d©a
(
öode
 *inode)

495  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_ORDERED_DATA_MODE
;

496 
	}
}

498 
ölöe
 
	$pxt4_should_wrôeback_d©a
(
öode
 *inode)

500  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_WRITEBACK_DATA_MODE
;

501 
	}
}

503 
ölöe
 
	$pxt4_‰ì_d©a_ªvoke_¸edôs
(
öode
 *öode, 
blocks
)

505 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

507 i‡(!
	`pxt4_should_jou∫Æ_d©a
(
öode
))

513  
blocks
 + 2*(
	`PXT4_SB
(
öode
->
i_sb
)->
s_˛u°î_øtio
 - 1);

514 
	}
}

525 
ölöe
 
	$pxt4_should_di‹ód_nﬁock
(
öode
 *inode)

527 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DIOREAD_NOLOCK
))

529 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

531 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

533 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

536 
	}
}

	@readpage.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/exp‹t.h
>

33 
	~<löux/mm.h
>

34 
	~<löux/kdev_t.h
>

35 
	~<löux/gÂ.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/fs.h
>

38 
	~<löux/buf„r_hód.h
>

39 
	~<löux/blkdev.h
>

40 
	~<löux/highmem.h
>

41 
	~<löux/¥e„tch.h
>

42 
	~<löux/m∑ge.h
>

43 
	~<löux/wrôeback.h
>

44 
	~<löux/backög-dev.h
>

45 
	~<löux/∑gevec.h
>

46 
	~<löux/˛ónˇche.h
>

48 
	~"pxt4.h
"

50 
	#NUM_PREALLOC_POST_READ_CTXS
 128

	)

52 
kmem_ˇche
 *
	gbio_po°_ªad_˘x_ˇche
;

53 
mempoﬁ_t
 *
	gbio_po°_ªad_˘x_poﬁ
;

56 
	ebio_po°_ªad_°ï
 {

57 
	mSTEP_INITIAL
 = 0,

58 
	mSTEP_DECRYPT
,

59 
	mSTEP_VERITY
,

60 
	mSTEP_MAX
,

63 
	sbio_po°_ªad_˘x
 {

64 
bio
 *
	mbio
;

65 
w‹k_°ru˘
 
	mw‹k
;

66 
	mcur_°ï
;

67 
	míabÀd_°ïs
;

70 
	$__ªad_íd_io
(
bio
 *bio)

72 
∑ge
 *page;

73 
bio_vec
 *
bv
;

74 
bvec_ôî_Æl
 
ôî_Æl
;

76 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
ôî_Æl
) {

77 
∑ge
 = 
bv
->
bv_∑ge
;

80 i‡(
bio
->
bi_°©us
 || 
	`PageEº‹
(
∑ge
)) {

81 
	`CÀ¨PageU±od©e
(
∑ge
);

83 
	`CÀ¨PageEº‹
(
∑ge
);

85 
	`SëPageU±od©e
(
∑ge
);

87 
	`u∆ock_∑ge
(
∑ge
);

89 i‡(
bio
->
bi_¥iv©e
)

90 
	`mempoﬁ_‰ì
(
bio
->
bi_¥iv©e
, 
bio_po°_ªad_˘x_poﬁ
);

91 
	`bio_put
(
bio
);

92 
	}
}

94 
bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
);

96 
	$de¸y±_w‹k
(
w‹k_°ru˘
 *
w‹k
)

98 
bio_po°_ªad_˘x
 *
˘x
 =

99 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

101 
	`fs¸y±_de¸y±_bio
(
˘x
->
bio
);

103 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

104 
	}
}

106 
	$vîôy_w‹k
(
w‹k_°ru˘
 *
w‹k
)

108 
bio_po°_ªad_˘x
 *
˘x
 =

109 
	`c⁄èöî_of
(
w‹k
, 
bio_po°_ªad_˘x
, work);

110 
bio
 *biÿ
˘x
->bio;

119 
	`BUILD_BUG_ON
(
STEP_VERITY
 + 1 !
STEP_MAX
);

120 
	`mempoﬁ_‰ì
(
˘x
, 
bio_po°_ªad_˘x_poﬁ
);

121 
bio
->
bi_¥iv©e
 = 
NULL
;

123 
	`fsvîôy_vîify_bio
(
bio
);

125 
	`__ªad_íd_io
(
bio
);

126 
	}
}

128 
	$bio_po°_ªad_¥o˚ssög
(
bio_po°_ªad_˘x
 *
˘x
)

135 ++
˘x
->
cur_°ï
) {

136 
STEP_DECRYPT
:

137 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_DECRYPT
)) {

138 
	`INIT_WORK
(&
˘x
->
w‹k
, 
de¸y±_w‹k
);

139 
	`fs¸y±_íqueue_de¸y±_w‹k
(&
˘x
->
w‹k
);

142 
˘x
->
cur_°ï
++;

144 
STEP_VERITY
:

145 i‡(
˘x
->
íabÀd_°ïs
 & (1 << 
STEP_VERITY
)) {

146 
	`INIT_WORK
(&
˘x
->
w‹k
, 
vîôy_w‹k
);

147 
	`fsvîôy_íqueue_vîify_w‹k
(&
˘x
->
w‹k
);

150 
˘x
->
cur_°ï
++;

153 
	`__ªad_íd_io
(
˘x
->
bio
);

155 
	}
}

157 
boﬁ
 
	$bio_po°_ªad_ªquúed
(
bio
 *bio)

159  
bio
->
bi_¥iv©e
 && !bio->
bi_°©us
;

160 
	}
}

174 
	$m∑ge_íd_io
(
bio
 *bio)

176 i‡(
	`bio_po°_ªad_ªquúed
(
bio
)) {

177 
bio_po°_ªad_˘x
 *
˘x
 = 
bio
->
bi_¥iv©e
;

179 
˘x
->
cur_°ï
 = 
STEP_INITIAL
;

180 
	`bio_po°_ªad_¥o˚ssög
(
˘x
);

183 
	`__ªad_íd_io
(
bio
);

184 
	}
}

186 
ölöe
 
boﬁ
 
	$pxt4_√ed_vîôy
(c⁄° 
öode
 *öode, 
pgoff_t
 
idx
)

188  
	`fsvîôy_a˘ive
(
öode
) &&

189 
idx
 < 
	`DIV_ROUND_UP
(
öode
->
i_size
, 
PAGE_SIZE
);

190 
	}
}

192 
bio_po°_ªad_˘x
 *
	$gë_bio_po°_ªad_˘x
(
öode
 *inode,

193 
bio
 *bio,

194 
pgoff_t
 
fú°_idx
)

196 
po°_ªad_°ïs
 = 0;

197 
bio_po°_ªad_˘x
 *
˘x
 = 
NULL
;

199 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

200 
po°_ªad_°ïs
 |1 << 
STEP_DECRYPT
;

202 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
fú°_idx
))

203 
po°_ªad_°ïs
 |1 << 
STEP_VERITY
;

205 i‡(
po°_ªad_°ïs
) {

206 
˘x
 = 
	`mempoﬁ_Æloc
(
bio_po°_ªad_˘x_poﬁ
, 
GFP_NOFS
);

207 i‡(!
˘x
)

208  
	`ERR_PTR
(-
ENOMEM
);

209 
˘x
->
bio
 = bio;

210 
˘x
->
íabÀd_°ïs
 = 
po°_ªad_°ïs
;

211 
bio
->
bi_¥iv©e
 = 
˘x
;

213  
˘x
;

214 
	}
}

216 
ölöe
 
loff_t
 
	$pxt4_ªad∑ge_limô
(
öode
 *inode)

218 i‡(
	`IS_ENABLED
(
CONFIG_FS_VERITY
) &&

219 (
	`IS_VERITY
(
öode
Ë|| 
	`pxt4_vîôy_ö_¥ogªss
(inode)))

220  
öode
->
i_sb
->
s_maxbyãs
;

222  
	`i_size_ªad
(
öode
);

223 
	}
}

225 
	$pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

226 
li°_hód
 *
∑ges
, 
∑ge
 *page,

227 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
)

229 
bio
 *biÿ
NULL
;

230 
£˘‹_t
 
œ°_block_ö_bio
 = 0;

232 
öode
 *öodê
m≠pög
->
ho°
;

233 c⁄° 
blkbôs
 = 
öode
->
i_blkbôs
;

234 c⁄° 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
blkbôs
;

235 c⁄° 
blocksize
 = 1 << 
blkbôs
;

236 
£˘‹_t
 
block_ö_fûe
;

237 
£˘‹_t
 
œ°_block
;

238 
£˘‹_t
 
œ°_block_ö_fûe
;

239 
£˘‹_t
 
blocks
[
MAX_BUF_PER_PAGE
];

240 
∑ge_block
;

241 
block_devi˚
 *
bdev
 = 
öode
->
i_sb
->
s_bdev
;

242 
Àngth
;

243 
ªœtive_block
 = 0;

244 
pxt4_m≠_blocks
 
m≠
;

246 
m≠
.
m_pblk
 = 0;

247 
m≠
.
m_lblk
 = 0;

248 
m≠
.
m_Àn
 = 0;

249 
m≠
.
m_Êags
 = 0;

251 ; 
ƒ_∑ges
;Çr_pages--) {

252 
fuŒy_m≠≥d
 = 1;

253 
fú°_hﬁe
 = 
blocks_≥r_∑ge
;

255 i‡(
∑ges
) {

256 
∑ge
 = 
	`Ãu_to_∑ge
(
∑ges
);

258 
	`¥e„tchw
(&
∑ge
->
Êags
);

259 
	`li°_dñ
(&
∑ge
->
Ãu
);

260 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
,Öage->
ödex
,

261 
	`ªadahód_gÂ_mask
(
m≠pög
)))

262 
√xt_∑ge
;

265 i‡(
	`∑ge_has_buf„rs
(
∑ge
))

266 
c⁄fu£d
;

268 
block_ö_fûe
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
blkbôs
);

269 
œ°_block
 = 
block_ö_fûe
 + 
ƒ_∑ges
 * 
blocks_≥r_∑ge
;

270 
œ°_block_ö_fûe
 = (
	`pxt4_ªad∑ge_limô
(
öode
) +

271 
blocksize
 - 1Ë>> 
blkbôs
;

272 i‡(
œ°_block
 > 
œ°_block_ö_fûe
)

273 
œ°_block
 = 
œ°_block_ö_fûe
;

274 
∑ge_block
 = 0;

279 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) &&

280 
block_ö_fûe
 > 
m≠
.
m_lblk
 &&

281 
block_ö_fûe
 < (
m≠
.
m_lblk
 + m≠.
m_Àn
)) {

282 
m≠_off£t
 = 
block_ö_fûe
 - 
m≠
.
m_lblk
;

283 
œ°
 = 
m≠
.
m_Àn
 - 
m≠_off£t
;

285 
ªœtive_block
 = 0; ;Ñelative_block++) {

286 i‡(
ªœtive_block
 =
œ°
) {

288 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

291 i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

293 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
 + 
m≠_off£t
 +

294 
ªœtive_block
;

295 
∑ge_block
++;

296 
block_ö_fûe
++;

304 
∑ge_block
 < 
blocks_≥r_∑ge
) {

305 i‡(
block_ö_fûe
 < 
œ°_block
) {

306 
m≠
.
m_lblk
 = 
block_ö_fûe
;

307 
m≠
.
m_Àn
 = 
œ°_block
 - 
block_ö_fûe
;

309 i‡(
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0) < 0) {

310 
£t_îr‹_∑ge
:

311 
	`SëPageEº‹
(
∑ge
);

312 
	`zîo_u£r_£gmít
(
∑ge
, 0,

313 
PAGE_SIZE
);

314 
	`u∆ock_∑ge
(
∑ge
);

315 
√xt_∑ge
;

318 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) == 0) {

319 
fuŒy_m≠≥d
 = 0;

320 i‡(
fú°_hﬁe
 =
blocks_≥r_∑ge
)

321 
fú°_hﬁe
 = 
∑ge_block
;

322 
∑ge_block
++;

323 
block_ö_fûe
++;

326 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
)

327 
c⁄fu£d
;

330 i‡(
∑ge_block
 && 
blocks
[∑ge_block-1] !
m≠
.
m_pblk
-1)

331 
c⁄fu£d
;

332 
ªœtive_block
 = 0; ;Ñelative_block++) {

333 i‡(
ªœtive_block
 =
m≠
.
m_Àn
) {

335 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

337 } i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

339 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
+
ªœtive_block
;

340 
∑ge_block
++;

341 
block_ö_fûe
++;

344 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
) {

345 
	`zîo_u£r_£gmít
(
∑ge
, 
fú°_hﬁe
 << 
blkbôs
,

346 
PAGE_SIZE
);

347 i‡(
fú°_hﬁe
 == 0) {

348 i‡(
	`pxt4_√ed_vîôy
(
öode
, 
∑ge
->
ödex
) &&

349 !
	`fsvîôy_vîify_∑ge
(
∑ge
))

350 
£t_îr‹_∑ge
;

351 
	`SëPageU±od©e
(
∑ge
);

352 
	`u∆ock_∑ge
(
∑ge
);

353 
√xt_∑ge
;

355 } i‡(
fuŒy_m≠≥d
) {

356 
	`SëPageM≠≥dToDisk
(
∑ge
);

358 i‡(
fuŒy_m≠≥d
 && 
blocks_≥r_∑ge
 == 1 &&

359 !
	`PageU±od©e
(
∑ge
Ë&& 
	`˛ónˇche_gë_∑ge
(page) == 0) {

360 
	`SëPageU±od©e
(
∑ge
);

361 
c⁄fu£d
;

368 i‡(
bio
 && (
œ°_block_ö_bio
 !
blocks
[0] - 1)) {

369 
submô_™d_ªÆloc
:

370 
	`submô_bio
(
bio
);

371 
bio
 = 
NULL
;

373 i‡(
bio
 =
NULL
) {

374 
bio_po°_ªad_˘x
 *
˘x
;

380 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
,

381 
	`mö_t
(, 
ƒ_∑ges
, 
BIO_MAX_PAGES
));

382 
˘x
 = 
	`gë_bio_po°_ªad_˘x
(
öode
, 
bio
, 
∑ge
->
ödex
);

383 i‡(
	`IS_ERR
(
˘x
)) {

384 
	`bio_put
(
bio
);

385 
bio
 = 
NULL
;

386 
£t_îr‹_∑ge
;

388 
	`bio_£t_dev
(
bio
, 
bdev
);

389 
bio
->
bi_ôî
.
bi_£˘‹
 = 
blocks
[0] << (
blkbôs
 - 9);

390 
bio
->
bi_íd_io
 = 
m∑ge_íd_io
;

391 
bio
->
bi_¥iv©e
 = 
˘x
;

392 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
,

393 
is_ªadahód
 ? 
REQ_RAHEAD
 : 0);

396 
Àngth
 = 
fú°_hﬁe
 << 
blkbôs
;

397 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àngth
, 0) <Üength)

398 
submô_™d_ªÆloc
;

400 i‡(((
m≠
.
m_Êags
 & 
PXT4_MAP_BOUNDARY
) &&

401 (
ªœtive_block
 =
m≠
.
m_Àn
)) ||

402 (
fú°_hﬁe
 !
blocks_≥r_∑ge
)) {

403 
	`submô_bio
(
bio
);

404 
bio
 = 
NULL
;

406 
œ°_block_ö_bio
 = 
blocks
[
blocks_≥r_∑ge
 - 1];

407 
√xt_∑ge
;

408 
c⁄fu£d
:

409 i‡(
bio
) {

410 
	`submô_bio
(
bio
);

411 
bio
 = 
NULL
;

413 i‡(!
	`PageU±od©e
(
∑ge
))

414 
	`block_ªad_fuŒ_∑ge
(
∑ge
, 
pxt4_gë_block
);

416 
	`u∆ock_∑ge
(
∑ge
);

417 
√xt_∑ge
:

418 i‡(
∑ges
)

419 
	`put_∑ge
(
∑ge
);

421 
	`BUG_ON
(
∑ges
 && !
	`li°_em±y
(pages));

422 i‡(
bio
)

423 
	`submô_bio
(
bio
);

425 
	}
}

427 
__öô
 
	$pxt4_öô_po°_ªad_¥o˚ssög
()

429 
bio_po°_ªad_˘x_ˇche
 =

430 
	`kmem_ˇche_¸óã
("pxt4_bio_post_read_ctx",

431 (
bio_po°_ªad_˘x
), 0, 0, 
NULL
);

432 i‡(!
bio_po°_ªad_˘x_ˇche
)

433 
Áû
;

434 
bio_po°_ªad_˘x_poﬁ
 =

435 
	`mempoﬁ_¸óã_¶ab_poﬁ
(
NUM_PREALLOC_POST_READ_CTXS
,

436 
bio_po°_ªad_˘x_ˇche
);

437 i‡(!
bio_po°_ªad_˘x_poﬁ
)

438 
Áû_‰ì_ˇche
;

441 
Áû_‰ì_ˇche
:

442 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

443 
Áû
:

444  -
ENOMEM
;

445 
	}
}

447 
	$pxt4_exô_po°_ªad_¥o˚ssög
()

449 
	`mempoﬁ_de°roy
(
bio_po°_ªad_˘x_poﬁ
);

450 
	`kmem_ˇche_de°roy
(
bio_po°_ªad_˘x_ˇche
);

451 
	}
}

	@resize.c

13 
	#PXT4FS_DEBUG


	)

15 
	~<löux/î∫o.h
>

16 
	~<löux/¶ab.h
>

18 
	~"pxt4_jbd3.h
"

20 
	spxt4_rcu_±r
 {

21 
rcu_hód
 
	mrcu
;

22 *
	m±r
;

25 
	$pxt4_rcu_±r_ˇŒback
(
rcu_hód
 *
hód
)

27 
pxt4_rcu_±r
 *
±r
;

29 
±r
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_rcu_±r
, 
rcu
);

30 
	`kv‰ì
(
±r
->ptr);

31 
	`k‰ì
(
±r
);

32 
	}
}

34 
	$pxt4_kv‰ì_¨øy_rcu
(*
to_‰ì
)

36 
pxt4_rcu_±r
 *
±r
 = 
	`kzÆloc
((*±r), 
GFP_KERNEL
);

38 i‡(
±r
) {

39 
±r
->±∏
to_‰ì
;

40 
	`ˇŒ_rcu
(&
±r
->
rcu
, 
pxt4_rcu_±r_ˇŒback
);

43 
	`synchr⁄ize_rcu
();

44 
	`kv‰ì
(
to_‰ì
);

45 
	}
}

47 
	$pxt4_ªsize_begö
(
su≥r_block
 *
sb
)

49 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

50 
ªt
 = 0;

52 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

53  -
EPERM
;

60 i‡(
	`PXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockƒ
) !=

61 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) {

62 
	`pxt4_w¨nög
(
sb
, "won'tÑesize using backup superblockát %llu",

63 ()
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
);

64  -
EPERM
;

71 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

72 
	`pxt4_w¨nög
(
sb
, "ThereáreÉrrors inÅhe filesystem, "

74  -
EPERM
;

77 i‡(
	`ã°_™d_£t_bô_lock
(
PXT4_FLAGS_RESIZING
,

78 &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
))

79 
ªt
 = -
EBUSY
;

81  
ªt
;

82 
	}
}

84 
	$pxt4_ªsize_íd
(
su≥r_block
 *
sb
)

86 
	`˛ór_bô_u∆ock
(
PXT4_FLAGS_RESIZING
, &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
);

87 
	`smp_mb__a·î_©omic
();

88 
	}
}

90 
pxt4_group_t
 
	$pxt4_mëa_bg_fú°_group
(
su≥r_block
 *
sb
,

91 
pxt4_group_t
 
group
) {

92  (
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

93 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

94 
	}
}

96 
pxt4_fsblk_t
 
	$pxt4_mëa_bg_fú°_block_no
(
su≥r_block
 *
sb
,

97 
pxt4_group_t
 
group
) {

98 
group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, group);

99  
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

100 
	}
}

102 
pxt4_gΩblk_t
 
	$pxt4_group_ovîhód_blocks
(
su≥r_block
 *
sb
,

103 
pxt4_group_t
 
group
) {

104 
pxt4_gΩblk_t
 
ovîhód
;

105 
ovîhód
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

106 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

107 
ovîhód
 += 1 +

108 
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

109  
ovîhód
;

110 
	}
}

112 
	#outside
(
b
, 
fú°
, 
œ°
Ë((bË< (fú°Ë|| (bË>÷a°))

	)

113 
	#öside
(
b
, 
fú°
, 
œ°
Ë((bË>(fú°Ë&& (bË< (œ°))

	)

115 
	$vîify_group_öput
(
su≥r_block
 *
sb
,

116 
pxt4_√w_group_d©a
 *
öput
)

118 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

119 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

120 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_blocks_cou¡
(
es
);

121 
pxt4_fsblk_t
 
íd
 = 
°¨t
 + 
öput
->
blocks_cou¡
;

122 
pxt4_group_t
 
group
 = 
öput
->group;

123 
pxt4_fsblk_t
 
ôíd
 = 
öput
->
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
;

124 
ovîhód
;

125 
pxt4_fsblk_t
 
më´nd
;

126 
buf„r_hód
 *
bh
 = 
NULL
;

127 
pxt4_gΩblk_t
 
‰ì_blocks_cou¡
, 
off£t
;

128 
îr
 = -
EINVAL
;

130 i‡(
group
 !
sbi
->
s_groups_cou¡
) {

131 
	`pxt4_w¨nög
(
sb
, "Cannotáddát group %u (only %u groups)",

132 
öput
->
group
, 
sbi
->
s_groups_cou¡
);

133  -
EINVAL
;

136 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

137 
më´nd
 = 
°¨t
 + 
ovîhód
;

138 
öput
->
‰ì_˛u°îs_cou¡
 = 
‰ì_blocks_cou¡
 =

139 
öput
->
blocks_cou¡
 - 2 - 
ovîhód
 - 
sbi
->
s_ôb_≥r_group
;

141 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

142 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádding %s group %u: %u blocks "

144 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ? "normal" :

145 "no-su≥r", 
öput
->
group
, i≈ut->
blocks_cou¡
,

146 
‰ì_blocks_cou¡
, 
öput
->
ª£rved_blocks
);

148 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t
, 
NULL
, &
off£t
);

149 i‡(
off£t
 != 0)

150 
	`pxt4_w¨nög
(
sb
, "Last groupÇot full");

151 i‡(
öput
->
ª£rved_blocks
 > i≈ut->
blocks_cou¡
 / 5)

152 
	`pxt4_w¨nög
(
sb
, "Reserved blocksÅoo high (%u)",

153 
öput
->
ª£rved_blocks
);

154 i‡(
‰ì_blocks_cou¡
 < 0)

155 
	`pxt4_w¨nög
(
sb
, "Bad blocks count %u",

156 
öput
->
blocks_cou¡
);

157 i‡(
	`IS_ERR
(
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
íd
 - 1, 0))) {

158 
îr
 = 
	`PTR_ERR
(
bh
);

159 
bh
 = 
NULL
;

160 
	`pxt4_w¨nög
(
sb
, "CannotÑeadÜast block (%llu)",

161 
íd
 - 1);

162 } i‡(
	`outside
(
öput
->
block_bôm≠
, 
°¨t
, 
íd
))

163 
	`pxt4_w¨nög
(
sb
, "Block bitmapÇot in group (block %llu)",

164 ()
öput
->
block_bôm≠
);

165 i‡(
	`outside
(
öput
->
öode_bôm≠
, 
°¨t
, 
íd
))

166 
	`pxt4_w¨nög
(
sb
, "Inode bitmapÇot in group (block %llu)",

167 ()
öput
->
öode_bôm≠
);

168 i‡(
	`outside
(
öput
->
öode_èbÀ
, 
°¨t
, 
íd
) ||

169 
	`outside
(
ôíd
 - 1, 
°¨t
, 
íd
))

170 
	`pxt4_w¨nög
(
sb
, "InodeÅableÇot in group (blocks %llu-%llu)",

171 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

172 i‡(
öput
->
öode_bôm≠
 =öput->
block_bôm≠
)

173 
	`pxt4_w¨nög
(
sb
, "Block bitmap sameás inode bitmap (%llu)",

174 ()
öput
->
block_bôm≠
);

175 i‡(
	`öside
(
öput
->
block_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

176 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in inodeÅable "

178 ()
öput
->
block_bôm≠
,

179 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

180 i‡(
	`öside
(
öput
->
öode_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

181 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in inodeÅable "

183 ()
öput
->
öode_bôm≠
,

184 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

185 i‡(
	`öside
(
öput
->
block_bôm≠
, 
°¨t
, 
më´nd
))

186 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in GDTÅable (%llu-%llu)",

187 ()
öput
->
block_bôm≠
,

188 
°¨t
, 
më´nd
 - 1);

189 i‡(
	`öside
(
öput
->
öode_bôm≠
, 
°¨t
, 
më´nd
))

190 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in GDTÅable (%llu-%llu)",

191 ()
öput
->
öode_bôm≠
,

192 
°¨t
, 
më´nd
 - 1);

193 i‡(
	`öside
(
öput
->
öode_èbÀ
, 
°¨t
, 
më´nd
) ||

194 
	`öside
(
ôíd
 - 1, 
°¨t
, 
më´nd
))

195 
	`pxt4_w¨nög
(
sb
, "InodeÅable (%llu-%llu) overlaps GDTÅable "

197 ()
öput
->
öode_èbÀ
,

198 
ôíd
 - 1, 
°¨t
, 
më´nd
 - 1);

200 
îr
 = 0;

201 
	`bªl£
(
bh
);

203  
îr
;

204 
	}
}

210 
	spxt4_√w_Êex_group_d©a
 {

211 
pxt4_√w_group_d©a
 *
	mgroups
;

213 
__u16
 *
	mbg_Êags
;

215 
pxt4_group_t
 
	mcou¡
;

225 
pxt4_√w_Êex_group_d©a
 *
	$Æloc_Êex_gd
(
Êexbg_size
)

227 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
;

229 
Êex_gd
 = 
	`kmÆloc
((*Êex_gd), 
GFP_NOFS
);

230 i‡(
Êex_gd
 =
NULL
)

231 
out3
;

233 i‡(
Êexbg_size
 >
UINT_MAX
 / (
pxt4_√w_group_d©a
))

234 
out2
;

235 
Êex_gd
->
cou¡
 = 
Êexbg_size
;

237 
Êex_gd
->
groups
 = 
	`kmÆloc_¨øy
(
Êexbg_size
,

238 (
pxt4_√w_group_d©a
),

239 
GFP_NOFS
);

240 i‡(
Êex_gd
->
groups
 =
NULL
)

241 
out2
;

243 
Êex_gd
->
bg_Êags
 = 
	`kmÆloc_¨øy
(
Êexbg_size
, (
__u16
),

244 
GFP_NOFS
);

245 i‡(
Êex_gd
->
bg_Êags
 =
NULL
)

246 
out1
;

248  
Êex_gd
;

250 
out1
:

251 
	`k‰ì
(
Êex_gd
->
groups
);

252 
out2
:

253 
	`k‰ì
(
Êex_gd
);

254 
out3
:

255  
NULL
;

256 
	}
}

258 
	$‰ì_Êex_gd
(
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

260 
	`k‰ì
(
Êex_gd
->
bg_Êags
);

261 
	`k‰ì
(
Êex_gd
->
groups
);

262 
	`k‰ì
(
Êex_gd
);

263 
	}
}

278 
	$pxt4_Æloc_group_èbÀs
(
su≥r_block
 *
sb
,

279 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

280 
Êexbg_size
)

282 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

283 
pxt4_fsblk_t
 
°¨t_blk
;

284 
pxt4_fsblk_t
 
œ°_blk
;

285 
pxt4_group_t
 
§c_group
;

286 
pxt4_group_t
 
bb_ödex
 = 0;

287 
pxt4_group_t
 
ib_ödex
 = 0;

288 
pxt4_group_t
 
ô_ödex
 = 0;

289 
pxt4_group_t
 
group
;

290 
pxt4_group_t
 
œ°_group
;

291 
ovîhód
;

292 
__u16
 
unöô_mask
 = (
Êexbg_size
 > 1Ë? ~
PXT4_BG_BLOCK_UNINIT
 : ~0;

293 
i
;

295 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

297 
§c_group
 = 
group_d©a
[0].
group
;

298 
œ°_group
 = 
§c_group
 + 
Êex_gd
->
cou¡
 - 1;

300 
	`BUG_ON
((
Êexbg_size
 > 1Ë&& ((
§c_group
 & ~(flexbg_size - 1)) !=

301 (
œ°_group
 & ~(
Êexbg_size
 - 1))));

302 
√xt_group
:

303 
group
 = 
group_d©a
[0].group;

304 i‡(
§c_group
 >
group_d©a
[0].
group
 + 
Êex_gd
->
cou¡
)

305  -
ENOSPC
;

306 
°¨t_blk
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
§c_group
);

307 
œ°_blk
 = 
°¨t_blk
 + 
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

309 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

311 
°¨t_blk
 +
ovîhód
;

314 
§c_group
++;

315 ; 
§c_group
 <
œ°_group
; src_group++) {

316 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

317 i‡(
ovîhód
 == 0)

318 
œ°_blk
 +
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

324 ; 
bb_ödex
 < 
Êex_gd
->
cou¡
; bb_index++) {

325 i‡(
°¨t_blk
 >
œ°_blk
)

326 
√xt_group
;

327 
group_d©a
[
bb_ödex
].
block_bôm≠
 = 
°¨t_blk
++;

328 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

329 
group
 -
group_d©a
[0].group;

330 
group_d©a
[
group
].
md©a_blocks
++;

331 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

335 ; 
ib_ödex
 < 
Êex_gd
->
cou¡
; ib_index++) {

336 i‡(
°¨t_blk
 >
œ°_blk
)

337 
√xt_group
;

338 
group_d©a
[
ib_ödex
].
öode_bôm≠
 = 
°¨t_blk
++;

339 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

340 
group
 -
group_d©a
[0].group;

341 
group_d©a
[
group
].
md©a_blocks
++;

342 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

346 ; 
ô_ödex
 < 
Êex_gd
->
cou¡
; it_index++) {

347 
ôb
 = 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

348 
pxt4_fsblk_t
 
√xt_group_°¨t
;

350 i‡(
°¨t_blk
 + 
ôb
 > 
œ°_blk
)

351 
√xt_group
;

352 
group_d©a
[
ô_ödex
].
öode_èbÀ
 = 
°¨t_blk
;

353 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
);

354 
√xt_group_°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
 + 1);

355 
group
 -
group_d©a
[0].group;

357 i‡(
°¨t_blk
 + 
ôb
 > 
√xt_group_°¨t
) {

358 
Êex_gd
->
bg_Êags
[
group
 + 1] &
unöô_mask
;

359 
ovîhód
 = 
°¨t_blk
 + 
ôb
 - 
√xt_group_°¨t
;

360 
group_d©a
[
group
 + 1].
md©a_blocks
 +
ovîhód
;

361 
ôb
 -
ovîhód
;

364 
group_d©a
[
group
].
md©a_blocks
 +
ôb
;

365 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

366 
°¨t_blk
 +
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

370 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

371 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 -=

372 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

373 
group_d©a
[
i
].
md©a_blocks
);

376 i‡(
	`ã°_›t
(
sb
, 
DEBUG
)) {

377 
i
;

378 
group
 = 
group_d©a
[0].group;

380 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:áddingá flex group with "

381 "%d groups, fÀxbg sizêi†%d:\n", 
Êex_gd
->
cou¡
,

382 
Êexbg_size
);

384 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

385 
	`pxt4_debug
(

387 
	`pxt4_bg_has_su≥r
(
sb
, 
group
 + 
i
) ? "normal" :

388 "no-su≥r", 
group
 + 
i
,

389 
group_d©a
[
i
].
blocks_cou¡
,

390 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
,

391 
group_d©a
[
i
].
md©a_blocks
);

395 
	}
}

397 
buf„r_hód
 *
	$b˛ón
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

398 
pxt4_fsblk_t
 
blk
)

400 
buf„r_hód
 *
bh
;

401 
îr
;

403 
bh
 = 
	`sb_gëblk
(
sb
, 
blk
);

404 i‡(
	`u∆ikñy
(!
bh
))

405  
	`ERR_PTR
(-
ENOMEM
);

406 
	`BUFFER_TRACE
(
bh
, "get_write_access");

407 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

408 
	`bªl£
(
bh
);

409 
bh
 = 
	`ERR_PTR
(
îr
);

411 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

412 
	`£t_buf„r_u±od©e
(
bh
);

415  
bh
;

416 
	}
}

418 
	$pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ_t
 *
h™dÀ
, 
¸edôs
)

420  
	`pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
¸edôs
,

421 
PXT4_MAX_TRANS_DATA
, 0, 0);

422 
	}
}

433 
	$£t_Êexbg_block_bôm≠
(
su≥r_block
 *
sb
, 
h™dÀ_t
 *
h™dÀ
,

434 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

435 
pxt4_fsblk_t
 
fú°_˛u°î
,Öxt4_fsblk_à
œ°_˛u°î
)

437 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

438 
pxt4_group_t
 
cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

439 
pxt4_group_t
 
cou¡2
;

441 
	`pxt4_debug
("m¨k clu°î†[%Œu-%Œu] u£d\n", 
fú°_˛u°î
,

442 
œ°_˛u°î
);

443 
cou¡2
 = 
cou¡
; count > 0;

444 
cou¡
 -
cou¡2
, 
fú°_˛u°î
 += count2) {

445 
pxt4_fsblk_t
 
°¨t
;

446 
buf„r_hód
 *
bh
;

447 
pxt4_group_t
 
group
;

448 
îr
;

450 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
));

451 
°¨t
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

452 
group
 -
Êex_gd
->
groups
[0].group;

454 
cou¡2
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
fú°_˛u°î
 - 
°¨t
);

455 i‡(
cou¡2
 > 
cou¡
)

456 
cou¡2
 = 
cou¡
;

458 i‡(
Êex_gd
->
bg_Êags
[
group
] & 
PXT4_BG_BLOCK_UNINIT
) {

459 
	`BUG_ON
(
Êex_gd
->
cou¡
 > 1);

463 
îr
 = 
	`pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ
, 1);

464 i‡(
îr
 < 0)

465  
îr
;

467 
bh
 = 
	`sb_gëblk
(
sb
, 
Êex_gd
->
groups
[
group
].
block_bôm≠
);

468 i‡(
	`u∆ikñy
(!
bh
))

469  -
ENOMEM
;

471 
	`BUFFER_TRACE
(
bh
, "get_write_access");

472 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

473 i‡(
îr
) {

474 
	`bªl£
(
bh
);

475  
îr
;

477 
	`pxt4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

478 
fú°_˛u°î
, fú°_˛u°î - 
°¨t
, 
cou¡2
);

479 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 
fú°_˛u°î
 - 
°¨t
, 
cou¡2
);

481 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

482 
	`bªl£
(
bh
);

483 i‡(
	`u∆ikñy
(
îr
))

484  
îr
;

488 
	}
}

504 
	$£tup_√w_Êex_group_blocks
(
su≥r_block
 *
sb
,

505 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

507 
group_èbÀ_cou¡
[] = {1, 1, 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
};

508 
pxt4_fsblk_t
 
°¨t
;

509 
pxt4_fsblk_t
 
block
;

510 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

511 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

512 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

513 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

514 
h™dÀ_t
 *
h™dÀ
;

515 
pxt4_group_t
 
group
, 
cou¡
;

516 
buf„r_hód
 *
bh
 = 
NULL
;

517 
ª£rved_gdb
, 
i
, 
j
, 
îr
 = 0, 
îr2
;

518 
mëa_bg
;

520 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !
group_d©a
 ||

521 
group_d©a
[0].
group
 !
sbi
->
s_groups_cou¡
);

523 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

524 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

527 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

528 i‡(
	`IS_ERR
(
h™dÀ
))

529  
	`PTR_ERR
(
h™dÀ
);

531 
group
 = 
group_d©a
[0].group;

532 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group
++) {

533 
gdblocks
;

534 
pxt4_gΩblk_t
 
ovîhód
;

536 
gdblocks
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

537 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

539 i‡(
mëa_bg
 =0 && !
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

540 
h™dÀ_ôb
;

542 i‡(
mëa_bg
 == 1) {

543 
pxt4_group_t
 
fú°_group
;

544 
fú°_group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, 
group
);

545 i‡(
fú°_group
 !
group
 + 1 &&

546 
fú°_group
 !
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1)

547 
h™dÀ_ôb
;

550 
block
 = 
°¨t
 + 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

552 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

553 
buf„r_hód
 *
gdb
;

555 
	`pxt4_debug
("upd©êbacku∞grou∞%#04Œx\n", 
block
);

556 
îr
 = 
	`pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ
, 1);

557 i‡(
îr
 < 0)

558 
out
;

560 
gdb
 = 
	`sb_gëblk
(
sb
, 
block
);

561 i‡(
	`u∆ikñy
(!
gdb
)) {

562 
îr
 = -
ENOMEM
;

563 
out
;

566 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

567 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb
);

568 i‡(
îr
) {

569 
	`bªl£
(
gdb
);

570 
out
;

572 
	`mem˝y
(
gdb
->
b_d©a
, 
	`sbi_¨øy_rcu_dîef
(
sbi
,

573 
s_group_desc
, 
j
)->
b_d©a
, 
gdb
->
b_size
);

574 
	`£t_buf„r_u±od©e
(
gdb
);

576 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb
);

577 i‡(
	`u∆ikñy
(
îr
)) {

578 
	`bªl£
(
gdb
);

579 
out
;

581 
	`bªl£
(
gdb
);

587 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
)) {

588 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
gdblocks
 + 
°¨t
 + 1,

589 
ª£rved_gdb
, 
GFP_NOFS
);

590 i‡(
îr
)

591 
out
;

594 
h™dÀ_ôb
:

596 i‡(!(
bg_Êags
[
i
] & 
PXT4_BG_INODE_ZEROED
))

597 
h™dÀ_bb
;

600 
block
 = 
group_d©a
[
i
].
öode_èbÀ
;

601 
	`pxt4_debug
("clear inodeÅable blocks %#04llx -> %#04lx\n",

602 
block
, 
sbi
->
s_ôb_≥r_group
);

603 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
block
, 
sbi
->
s_ôb_≥r_group
,

604 
GFP_NOFS
);

605 i‡(
îr
)

606 
out
;

608 
h™dÀ_bb
:

609 i‡(
bg_Êags
[
i
] & 
PXT4_BG_BLOCK_UNINIT
)

610 
h™dÀ_ib
;

613 
block
 = 
group_d©a
[
i
].
block_bôm≠
;

614 
îr
 = 
	`pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ
, 1);

615 i‡(
îr
 < 0)

616 
out
;

618 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

619 i‡(
	`IS_ERR
(
bh
)) {

620 
îr
 = 
	`PTR_ERR
(
bh
);

621 
out
;

623 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

624 i‡(
ovîhód
 != 0) {

625 
	`pxt4_debug
("mark backup superblock %#04llx (+0)\n",

626 
°¨t
);

627 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 0,

628 
	`PXT4_NUM_B2C
(
sbi
, 
ovîhód
));

630 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_cou¡
),

631 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

632 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

633 
	`bªl£
(
bh
);

634 i‡(
îr
)

635 
out
;

637 
h™dÀ_ib
:

638 i‡(
bg_Êags
[
i
] & 
PXT4_BG_INODE_UNINIT
)

642 
block
 = 
group_d©a
[
i
].
öode_bôm≠
;

643 
îr
 = 
	`pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ
, 1);

644 i‡(
îr
 < 0)

645 
out
;

647 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

648 i‡(
	`IS_ERR
(
bh
)) {

649 
îr
 = 
	`PTR_ERR
(
bh
);

650 
out
;

653 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

654 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

655 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

656 
	`bªl£
(
bh
);

657 i‡(
îr
)

658 
out
;

662 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

663 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

664 
°¨t
 = (&
group_d©a
[0].
block_bôm≠
)[
j
];

665 
block
 = 
°¨t
;

666 
i
 = 1; i < 
Êex_gd
->
cou¡
; i++) {

667 
block
 +
group_èbÀ_cou¡
[
j
];

668 i‡(
block
 =(&
group_d©a
[
i
].
block_bôm≠
)[
j
]) {

669 
cou¡
 +
group_èbÀ_cou¡
[
j
];

672 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

673 
Êex_gd
,

674 
	`PXT4_B2C
(
sbi
, 
°¨t
),

675 
	`PXT4_B2C
(
sbi
,

676 
°¨t
 + 
cou¡


678 i‡(
îr
)

679 
out
;

680 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

681 
°¨t
 = (&
group_d©a
[
i
].
block_bôm≠
)[
j
];

682 
block
 = 
°¨t
;

685 i‡(
cou¡
) {

686 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

687 
Êex_gd
,

688 
	`PXT4_B2C
(
sbi
, 
°¨t
),

689 
	`PXT4_B2C
(
sbi
,

690 
°¨t
 + 
cou¡


692 i‡(
îr
)

693 
out
;

697 
out
:

698 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

699 i‡(
îr2
 && !
îr
)

700 
îr
 = 
îr2
;

702  
îr
;

703 
	}
}

712 
	$pxt4_li°_backups
(
su≥r_block
 *
sb
, *
thªe
,

713 *
five
, *
£ví
)

715 *
mö
 = 
thªe
;

716 
mu…
 = 3;

717 
ªt
;

719 i‡(!
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

720 
ªt
 = *
mö
;

721 *
mö
 += 1;

722  
ªt
;

725 i‡(*
five
 < *
mö
) {

726 
mö
 = 
five
;

727 
mu…
 = 5;

729 i‡(*
£ví
 < *
mö
) {

730 
mö
 = 
£ví
;

731 
mu…
 = 7;

734 
ªt
 = *
mö
;

735 *
mö
 *
mu…
;

737  
ªt
;

738 
	}
}

745 
	$vîify_ª£rved_gdb
(
su≥r_block
 *
sb
,

746 
pxt4_group_t
 
íd
,

747 
buf„r_hód
 *
¥im¨y
)

749 c⁄° 
pxt4_fsblk_t
 
blk
 = 
¥im¨y
->
b_blockƒ
;

750 
thªe
 = 1;

751 
five
 = 5;

752 
£ví
 = 7;

753 
gΩ
;

754 
__À32
 *
p
 = (__À32 *)
¥im¨y
->
b_d©a
;

755 
gdbackups
 = 0;

757 (
gΩ
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
)Ë< 
íd
) {

758 i‡(
	`À32_to_˝u
(*
p
++) !=

759 
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë+ 
blk
){

760 
	`pxt4_w¨nög
(
sb
, "reserved GDT %llu"

762 
blk
, 
gΩ
,

763 
gΩ
 *

764 (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

765 
blk
);

766  -
EINVAL
;

768 i‡(++
gdbackups
 > 
	`PXT4_ADDR_PER_BLOCK
(
sb
))

769  -
EFBIG
;

772  
gdbackups
;

773 
	}
}

788 
	$add_√w_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

789 
pxt4_group_t
 
group
)

791 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

792 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

793 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

794 
pxt4_fsblk_t
 
gdblock
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + 
gdb_num
;

795 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

796 
buf„r_hód
 *
död
 = 
NULL
;

797 
buf„r_hód
 *
gdb_bh
 = 
NULL
;

798 
gdbackups
;

799 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

800 
__À32
 *
d©a
;

801 
îr
;

803 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

804 
	`¥ötk
(
KERN_DEBUG


806 
gdb_num
);

808 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

809 i‡(
	`IS_ERR
(
gdb_bh
))

810  
	`PTR_ERR
(
gdb_bh
);

812 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

813 i‡(
gdbackups
 < 0) {

814 
îr
 = 
gdbackups
;

815 
îrout
;

818 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

819 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

820 i‡(
	`IS_ERR
(
död
)) {

821 
îr
 = 
	`PTR_ERR
(
död
);

822 
död
 = 
NULL
;

823 
îrout
;

826 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

827 i‡(
	`À32_to_˝u
(
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)]Ë!
gdblock
) {

828 
	`pxt4_w¨nög
(
sb
, "new group %u GDT block %lluÇotÑeserved",

829 
group
, 
gdblock
);

830 
îr
 = -
EINVAL
;

831 
îrout
;

834 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

835 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

836 i‡(
	`u∆ikñy
(
îr
))

837 
îrout
;

839 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

840 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

841 i‡(
	`u∆ikñy
(
îr
))

842 
îrout
;

844 
	`BUFFER_TRACE
(
död
, "get_write_access");

845 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
död
);

846 i‡(
	`u∆ikñy
(
îr
))

847 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

850 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

851 i‡(
	`u∆ikñy
(
îr
))

852 
îrout
;

854 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

855 (
buf„r_hód
 *),

856 
GFP_NOFS
);

857 i‡(!
n_group_desc
) {

858 
îr
 = -
ENOMEM
;

859 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

860 
gdb_num
 + 1);

861 
îrout
;

873 
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

874 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
död
);

875 i‡(
	`u∆ikñy
(
îr
)) {

876 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

877 
îrout
;

879 
öode
->
i_blocks
 -(
gdbackups
 + 1Ë* 
sb
->
s_blocksize
 >>

880 (9 - 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

881 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

882 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

883 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

884 i‡(
	`u∆ikñy
(
îr
)) {

885 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

886 
ûoc
.
bh
 = 
NULL
;

887 
îrout
;

889 
	`bªl£
(
död
);

891 
	`rcu_ªad_lock
();

892 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

893 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

894 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

895 
	`rcu_ªad_u∆ock
();

896 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

897 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

898 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

899 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

901 
	`À16_add_˝u
(&
es
->
s_ª£rved_gdt_blocks
, -1);

902 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

903 i‡(
îr
)

904 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

905  
îr
;

906 
îrout
:

907 
	`kv‰ì
(
n_group_desc
);

908 
	`bªl£
(
ûoc
.
bh
);

909 
	`bªl£
(
död
);

910 
	`bªl£
(
gdb_bh
);

912 
	`pxt4_debug
("Àavög wôhÉº‹ %d\n", 
îr
);

913  
îr
;

914 
	}
}

919 
	$add_√w_gdb_mëa_bg
(
su≥r_block
 *
sb
,

920 
h™dÀ_t
 *
h™dÀ
, 
pxt4_group_t
 
group
) {

921 
pxt4_fsblk_t
 
gdblock
;

922 
buf„r_hód
 *
gdb_bh
;

923 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
;

924 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

925 
îr
;

927 
gdblock
 = 
	`pxt4_mëa_bg_fú°_block_no
(
sb
, 
group
) +

928 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

929 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

930 i‡(
	`IS_ERR
(
gdb_bh
))

931  
	`PTR_ERR
(
gdb_bh
);

932 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

933 (
buf„r_hód
 *),

934 
GFP_NOFS
);

935 i‡(!
n_group_desc
) {

936 
	`bªl£
(
gdb_bh
);

937 
îr
 = -
ENOMEM
;

938 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

939 
gdb_num
 + 1);

940  
îr
;

943 
	`rcu_ªad_lock
();

944 
o_group_desc
 = 
	`rcu_dîe„ªn˚
(
	`PXT4_SB
(
sb
)->
s_group_desc
);

945 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

946 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

947 
	`rcu_ªad_u∆ock
();

948 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

950 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

951 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

952 i‡(
îr
) {

953 
	`kv‰ì
(
n_group_desc
);

954 
	`bªl£
(
gdb_bh
);

955  
îr
;

958 
	`rcu_assign_poöãr
(
	`PXT4_SB
(
sb
)->
s_group_desc
, 
n_group_desc
);

959 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

960 
	`pxt4_kv‰ì_¨øy_rcu
(
o_group_desc
);

961  
îr
;

962 
	}
}

977 
	$ª£rve_backup_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

978 
pxt4_group_t
 
group
)

980 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

981 
ª£rved_gdb
 =
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

982 
˛u°î_bôs
 = 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

983 
buf„r_hód
 **
¥im¨y
;

984 
buf„r_hód
 *
död
;

985 
pxt4_ûoc
 
ûoc
;

986 
pxt4_fsblk_t
 
blk
;

987 
__À32
 *
d©a
, *
íd
;

988 
gdbackups
 = 0;

989 
ªs
, 
i
;

990 
îr
;

992 
¥im¨y
 = 
	`kmÆloc_¨øy
(
ª£rved_gdb
, (*¥im¨y), 
GFP_NOFS
);

993 i‡(!
¥im¨y
)

994  -
ENOMEM
;

996 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

997 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

998 i‡(
	`IS_ERR
(
död
)) {

999 
îr
 = 
	`PTR_ERR
(
död
);

1000 
död
 = 
NULL
;

1001 
exô_‰ì
;

1004 
blk
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + PXT4_SB(sb)->
s_gdb_cou¡
;

1005 
d©a
 = (
__À32
 *)
död
->
b_d©a
 + (
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 %

1006 
	`PXT4_ADDR_PER_BLOCK
(
sb
));

1007 
íd
 = (
__À32
 *)
död
->
b_d©a
 + 
	`PXT4_ADDR_PER_BLOCK
(
sb
);

1010 
ªs
 = 0;Ñe†< 
ª£rved_gdb
;Ñes++, 
blk
++) {

1011 i‡(
	`À32_to_˝u
(*
d©a
Ë!
blk
) {

1012 
	`pxt4_w¨nög
(
sb
, "reserved block %llu"

1014 
blk
,

1015 ()(
d©a
 - (
__À32
 *)
död
->
b_d©a
));

1016 
îr
 = -
EINVAL
;

1017 
exô_bh
;

1019 
¥im¨y
[
ªs
] = 
	`pxt4_sb_bªad
(
sb
, 
blk
, 0);

1020 i‡(
	`IS_ERR
(
¥im¨y
[
ªs
])) {

1021 
îr
 = 
	`PTR_ERR
(
¥im¨y
[
ªs
]);

1022 
¥im¨y
[
ªs
] = 
NULL
;

1023 
exô_bh
;

1025 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
¥im¨y
[
ªs
]);

1026 i‡(
gdbackups
 < 0) {

1027 
	`bªl£
(
¥im¨y
[
ªs
]);

1028 
îr
 = 
gdbackups
;

1029 
exô_bh
;

1031 i‡(++
d©a
 >
íd
)

1032 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

1035 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1036 
	`BUFFER_TRACE
(
¥im¨y
[
i
], "get_write_access");

1037 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
¥im¨y
[
i
])))

1038 
exô_bh
;

1041 i‡((
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
)))

1042 
exô_bh
;

1048 
blk
 = 
group
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1049 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1050 
îr2
;

1051 
d©a
 = (
__À32
 *)
¥im¨y
[
i
]->
b_d©a
;

1055 
d©a
[
gdbackups
] = 
	`˝u_to_À32
(
blk
 + 
¥im¨y
[
i
]->
b_blockƒ
);

1056 
îr2
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
¥im¨y
[
i
]);

1057 i‡(!
îr
)

1058 
îr
 = 
îr2
;

1061 
öode
->
i_blocks
 +
ª£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
˛u°î_bôs
);

1062 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

1064 
exô_bh
:

1065 --
ªs
 >= 0)

1066 
	`bªl£
(
¥im¨y
[
ªs
]);

1067 
	`bªl£
(
död
);

1069 
exô_‰ì
:

1070 
	`k‰ì
(
¥im¨y
);

1072  
îr
;

1073 
	}
}

1091 
	$upd©e_backups
(
su≥r_block
 *
sb
, 
£˘‹_t
 
blk_off
, *
d©a
,

1092 
size
, 
mëa_bg
)

1094 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1095 
pxt4_group_t
 
œ°
;

1096 c⁄° 
bpg
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1097 
thªe
 = 1;

1098 
five
 = 5;

1099 
£ví
 = 7;

1100 
pxt4_group_t
 
group
 = 0;

1101 
ª°
 = 
sb
->
s_blocksize
 - 
size
;

1102 
h™dÀ_t
 *
h™dÀ
;

1103 
îr
 = 0, 
îr2
;

1105 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

1106 i‡(
	`IS_ERR
(
h™dÀ
)) {

1107 
group
 = 1;

1108 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1109 
exô_îr
;

1112 i‡(
mëa_bg
 == 0) {

1113 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1114 
œ°
 = 
sbi
->
s_groups_cou¡
;

1116 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
blk_off
) + 1;

1117 
œ°
 = (
pxt4_group_t
)(
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 2);

1120 
group
 < 
sbi
->
s_groups_cou¡
) {

1121 
buf„r_hód
 *
bh
;

1122 
pxt4_fsblk_t
 
backup_block
;

1125 
îr
 = 
	`pxt4_ªsize_ísuª_¸edôs_b©ch
(
h™dÀ
, 1);

1126 i‡(
îr
 < 0)

1129 i‡(
mëa_bg
 == 0)

1130 
backup_block
 = ((
pxt4_fsblk_t
)
group
Ë* 
bpg
 + 
blk_off
;

1132 
backup_block
 = (
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

1133 
	`pxt4_bg_has_su≥r
(
sb
, 
group
));

1135 
bh
 = 
	`sb_gëblk
(
sb
, 
backup_block
);

1136 i‡(
	`u∆ikñy
(!
bh
)) {

1137 
îr
 = -
ENOMEM
;

1140 
	`pxt4_debug
("update metadata backup %llu(+%llu)\n",

1141 
backup_block
, backup_block -

1142 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

1143 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1144 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

1145 
	`bªl£
(
bh
);

1148 
	`lock_buf„r
(
bh
);

1149 
	`mem˝y
(
bh
->
b_d©a
, 
d©a
, 
size
);

1150 i‡(
ª°
)

1151 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
ª°
);

1152 
	`£t_buf„r_u±od©e
(
bh
);

1153 
	`u∆ock_buf„r
(
bh
);

1154 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1155 i‡(
	`u∆ikñy
(
îr
))

1156 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1157 
	`bªl£
(
bh
);

1159 i‡(
mëa_bg
 == 0)

1160 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1161 i‡(
group
 =
œ°
)

1164 
group
 = 
œ°
;

1166 i‡((
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
)Ë&& !
îr
)

1167 
îr
 = 
îr2
;

1179 
exô_îr
:

1180 i‡(
îr
) {

1181 
	`pxt4_w¨nög
(
sb
, "can't update backup for group %u (err %d), "

1182 "f‹cög fsck o¿√xàªboŸ", 
group
, 
îr
);

1183 
sbi
->
s_mou¡_°©e
 &~
PXT4_VALID_FS
;

1184 
sbi
->
s_es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

1185 
	`m¨k_buf„r_dúty
(
sbi
->
s_sbh
);

1187 
	}
}

1199 
	$pxt4_add_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1200 
pxt4_group_t
 
group
, 
öode
 *
ªsize_öode
,

1201 
pxt4_group_t
 
cou¡
)

1203 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1204 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1205 
buf„r_hód
 *
gdb_bh
;

1206 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1207 
mëa_bg
;

1209 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1210 
i
 = 0; i < 
cou¡
; i++, 
group
++) {

1211 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
group
) ?

1212 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1214 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1215 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1223 i‡(
gdb_off
) {

1224 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1225 
gdb_num
);

1226 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1227 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

1229 i‡(!
îr
 && 
ª£rved_gdb
 && 
	`pxt4_bg_num_gdb
(
sb
, 
group
))

1230 
îr
 = 
	`ª£rve_backup_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1231 } i‡(
mëa_bg
 != 0) {

1232 
îr
 = 
	`add_√w_gdb_mëa_bg
(
sb
, 
h™dÀ
, 
group
);

1234 
îr
 = 
	`add_√w_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1236 i‡(
îr
)

1239  
îr
;

1240 
	}
}

1242 
buf„r_hód
 *
	$pxt4_gë_bôm≠
(
su≥r_block
 *
sb
, 
__u64
 
block
)

1244 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

1245 i‡(
	`u∆ikñy
(!
bh
))

1246  
NULL
;

1247 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

1248 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

1249 
	`bªl£
(
bh
);

1250  
NULL
;

1254  
bh
;

1255 
	}
}

1257 
	$pxt4_£t_bôm≠_checksums
(
su≥r_block
 *
sb
,

1258 
pxt4_group_t
 
group
,

1259 
pxt4_group_desc
 *
gdp
,

1260 
pxt4_√w_group_d©a
 *
group_d©a
)

1262 
buf„r_hód
 *
bh
;

1264 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

1267 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
öode_bôm≠
);

1268 i‡(!
bh
)

1269  -
EIO
;

1270 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1271 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1272 
	`bªl£
(
bh
);

1274 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
block_bôm≠
);

1275 i‡(!
bh
)

1276  -
EIO
;

1277 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1278 
	`bªl£
(
bh
);

1281 
	}
}

1286 
	$pxt4_£tup_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1287 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1289 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1290 
pxt4_group_desc
 *
gdp
;

1291 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1292 
buf„r_hód
 *
gdb_bh
;

1293 
pxt4_group_t
 
group
;

1294 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

1295 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1298 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group_d©a
++, 
bg_Êags
++) {

1299 
group
 = 
group_d©a
->group;

1301 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1302 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1307 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
, 
gdb_num
);

1309 
gdp
 = (
pxt4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1310 
gdb_off
 * 
	`PXT4_DESC_SIZE
(
sb
));

1312 
	`mem£t
(
gdp
, 0, 
	`PXT4_DESC_SIZE
(
sb
));

1313 
	`pxt4_block_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
block_bôm≠
);

1314 
	`pxt4_öode_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_bôm≠
);

1315 
îr
 = 
	`pxt4_£t_bôm≠_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1316 i‡(
îr
) {

1317 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1321 
	`pxt4_öode_èbÀ_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_èbÀ
);

1322 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1323 
group_d©a
->
‰ì_˛u°îs_cou¡
);

1324 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`PXT4_INODES_PER_GROUP
(sb));

1325 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

1326 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1327 
	`PXT4_INODES_PER_GROUP
(
sb
));

1328 
gdp
->
bg_Êags
 = 
	`˝u_to_À16
(*bg_flags);

1329 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1331 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

1332 i‡(
	`u∆ikñy
(
îr
)) {

1333 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1341 
îr
 = 
	`pxt4_mb_add_groupöfo
(
sb
, 
group
, 
gdp
);

1342 i‡(
îr
)

1345  
îr
;

1346 
	}
}

1355 
	$pxt4_upd©e_su≥r
(
su≥r_block
 *
sb
,

1356 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1358 
pxt4_fsblk_t
 
blocks_cou¡
 = 0;

1359 
pxt4_fsblk_t
 
‰ì_blocks
 = 0;

1360 
pxt4_fsblk_t
 
ª£rved_blocks
 = 0;

1361 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1362 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1363 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1364 
i
;

1366 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

1377 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1378 
blocks_cou¡
 +
group_d©a
[
i
].blocks_count;

1379 
‰ì_blocks
 +
	`PXT4_C2B
(
sbi
, 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
);

1382 
ª£rved_blocks
 = 
	`pxt4_r_blocks_cou¡
(
es
) * 100;

1383 
ª£rved_blocks
 = 
	`div64_u64
‘e£rved_blocks, 
	`pxt4_blocks_cou¡
(
es
));

1384 
ª£rved_blocks
 *
blocks_cou¡
;

1385 
	`do_div
(
ª£rved_blocks
, 100);

1387 
	`pxt4_blocks_cou¡_£t
(
es
, 
	`pxt4_blocks_cou¡
”sË+ 
blocks_cou¡
);

1388 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
‰ì_blocks
);

1389 
	`À32_add_˝u
(&
es
->
s_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1390 
Êex_gd
->
cou¡
);

1391 
	`À32_add_˝u
(&
es
->
s_‰ì_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1392 
Êex_gd
->
cou¡
);

1394 
	`pxt4_debug
("‰ì block†cou¡ %Œu", 
	`pxt4_‰ì_blocks_cou¡
(
es
));

1413 
	`smp_wmb
();

1416 
sbi
->
s_groups_cou¡
 +
Êex_gd
->
cou¡
;

1417 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

1418 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

1422 
	`pxt4_r_blocks_cou¡_£t
(
es
, 
	`pxt4_r_blocks_cou¡
(es) +

1423 
ª£rved_blocks
);

1426 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

1427 
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
));

1428 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ìöodes_cou¡î
,

1429 
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
);

1431 
	`pxt4_debug
("free blocks count %llu",

1432 
	`≥r˝u_cou¡î_ªad
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

1433 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
Ë&& 
sbi
->
s_log_groups_≥r_Êex
) {

1434 
pxt4_group_t
 
Êex_group
;

1435 
Êex_groups
 *
fg
;

1437 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group_d©a
[0].
group
);

1438 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

1439 
	`©omic64_add
(
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
),

1440 &
fg
->
‰ì_˛u°îs
);

1441 
	`©omic_add
(
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
,

1442 &
fg
->
‰ì_öodes
);

1448 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

1450 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1451 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádded group %u:"

1452 "%Œu blocks(%Œu fªê%ŒuÑe£rved)\n", 
Êex_gd
->
cou¡
,

1453 
blocks_cou¡
, 
‰ì_blocks
, 
ª£rved_blocks
);

1454 
	}
}

1460 
	$pxt4_Êex_group_add
(
su≥r_block
 *
sb
,

1461 
öode
 *
ªsize_öode
,

1462 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1464 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1465 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1466 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1467 
pxt4_gΩblk_t
 
œ°
;

1468 
pxt4_group_t
 
group
;

1469 
h™dÀ_t
 *
h™dÀ
;

1470 
ª£rved_gdb
;

1471 
îr
 = 0, 
îr2
 = 0, 
¸edô
;

1473 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !Êex_gd->
groups
 || !Êex_gd->
bg_Êags
);

1475 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1476 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1477 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1478 
	`BUG_ON
(
œ°
);

1480 
îr
 = 
	`£tup_√w_Êex_group_blocks
(
sb
, 
Êex_gd
);

1481 i‡(
îr
)

1482 
exô
;

1490 
¸edô
 = 3;

1492 
¸edô
 +1 + 
	`DIV_ROUND_UP
(
Êex_gd
->
cou¡
, 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1493 
¸edô
 +
ª£rved_gdb
;

1494 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edô
);

1495 i‡(
	`IS_ERR
(
h™dÀ
)) {

1496 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1497 
exô
;

1500 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1501 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1502 i‡(
îr
)

1503 
exô_jou∫Æ
;

1505 
group
 = 
Êex_gd
->
groups
[0].group;

1506 
	`BUG_ON
(
group
 !
sbi
->
s_groups_cou¡
);

1507 
îr
 = 
	`pxt4_add_√w_descs
(
h™dÀ
, 
sb
, 
group
,

1508 
ªsize_öode
, 
Êex_gd
->
cou¡
);

1509 i‡(
îr
)

1510 
exô_jou∫Æ
;

1512 
îr
 = 
	`pxt4_£tup_√w_descs
(
h™dÀ
, 
sb
, 
Êex_gd
);

1513 i‡(
îr
)

1514 
exô_jou∫Æ
;

1516 
	`pxt4_upd©e_su≥r
(
sb
, 
Êex_gd
);

1518 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1520 
exô_jou∫Æ
:

1521 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1522 i‡(!
îr
)

1523 
îr
 = 
îr2
;

1525 i‡(!
îr
) {

1526 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1527 
gdb_num_íd
 = ((
group
 + 
Êex_gd
->
cou¡
 - 1) /

1528 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1529 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1530 
£˘‹_t
 
ﬁd_gdb
 = 0;

1532 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockƒ
, (*)
es
,

1533 (
pxt4_su≥r_block
), 0);

1534 ; 
gdb_num
 <
gdb_num_íd
; gdb_num++) {

1535 
buf„r_hód
 *
gdb_bh
;

1537 
gdb_bh
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_group_desc
,

1538 
gdb_num
);

1539 i‡(
ﬁd_gdb
 =
gdb_bh
->
b_blockƒ
)

1541 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockƒ
, gdb_bh->
b_d©a
,

1542 
gdb_bh
->
b_size
, 
mëa_bg
);

1543 
ﬁd_gdb
 = 
gdb_bh
->
b_blockƒ
;

1546 
exô
:

1547  
îr
;

1548 
	}
}

1550 
	$pxt4_£tup_√xt_Êex_gd
(
su≥r_block
 *
sb
,

1551 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

1552 
pxt4_fsblk_t
 
n_blocks_cou¡
,

1553 
Êexbg_size
)

1555 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1556 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1557 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1558 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1559 
pxt4_group_t
 
n_group
;

1560 
pxt4_group_t
 
group
;

1561 
pxt4_group_t
 
œ°_group
;

1562 
pxt4_gΩblk_t
 
œ°
;

1563 
pxt4_gΩblk_t
 
˛u°îs_≥r_group
;

1564 
i
;

1566 
˛u°îs_≥r_group
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1568 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1570 i‡(
o_blocks_cou¡
 =
n_blocks_cou¡
)

1573 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1574 
	`BUG_ON
(
œ°
);

1575 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
n_blocks_cou¡
 - 1, &
n_group
, &
œ°
);

1577 
œ°_group
 = 
group
 | (
Êexbg_size
 - 1);

1578 i‡(
œ°_group
 > 
n_group
)

1579 
œ°_group
 = 
n_group
;

1581 
Êex_gd
->
cou¡
 = 
œ°_group
 - 
group
 + 1;

1583 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1584 
ovîhód
;

1586 
group_d©a
[
i
].
group
 = group + i;

1587 
group_d©a
[
i
].
blocks_cou¡
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1588 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
 + 
i
);

1589 
group_d©a
[
i
].
md©a_blocks
 = 
ovîhód
;

1590 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1591 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1592 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_BLOCK_UNINIT
 |

1593 
PXT4_BG_INODE_UNINIT
;

1594 i‡(!
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1595 
Êex_gd
->
bg_Êags
[
i
] |
PXT4_BG_INODE_ZEROED
;

1597 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_INODE_ZEROED
;

1600 i‡(
œ°_group
 =
n_group
 && 
	`pxt4_has_group_desc_csum
(
sb
))

1602 
Êex_gd
->
bg_Êags
[
i
 - 1] &~
PXT4_BG_BLOCK_UNINIT
;

1604 i‡((
œ°_group
 =
n_group
Ë&& (
œ°
 !
˛u°îs_≥r_group
 - 1)) {

1605 
group_d©a
[
i
 - 1].
blocks_cou¡
 = 
	`PXT4_C2B
(
sbi
, 
œ°
 + 1);

1606 
group_d©a
[
i
 - 1].
‰ì_˛u°îs_cou¡
 -
˛u°îs_≥r_group
 -

1607 
œ°
 - 1;

1611 
	}
}

1626 
	$pxt4_group_add
(
su≥r_block
 *
sb
, 
pxt4_√w_group_d©a
 *
öput
)

1628 
pxt4_√w_Êex_group_d©a
 
Êex_gd
;

1629 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1630 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1631 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ?

1632 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1633 
öode
 *öodê
NULL
;

1634 
gdb_off
;

1635 
îr
;

1636 
__u16
 
bg_Êags
 = 0;

1638 
gdb_off
 = 
öput
->
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1640 i‡(
gdb_off
 =0 && !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

1641 
	`pxt4_w¨nög
(
sb
, "Can'tÑesizeÇon-sparse filesystem further");

1642  -
EPERM
;

1645 i‡(
	`pxt4_blocks_cou¡
(
es
Ë+ 
öput
->
blocks_cou¡
 <

1646 
	`pxt4_blocks_cou¡
(
es
)) {

1647 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1648  -
EINVAL
;

1651 i‡(
	`À32_to_˝u
(
es
->
s_öodes_cou¡
Ë+ 
	`PXT4_INODES_PER_GROUP
(
sb
) <

1652 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

1653 
	`pxt4_w¨nög
(
sb
, "inodes_count overflow");

1654  -
EINVAL
;

1657 i‡(
ª£rved_gdb
 || 
gdb_off
 == 0) {

1658 i‡(!
	`pxt4_has_„©uª_ªsize_öode
(
sb
) ||

1659 !
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1660 
	`pxt4_w¨nög
(
sb
,

1662  -
EPERM
;

1664 
öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
, 
PXT4_IGET_SPECIAL
);

1665 i‡(
	`IS_ERR
(
öode
)) {

1666 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1667  
	`PTR_ERR
(
öode
);

1672 
îr
 = 
	`vîify_group_öput
(
sb
, 
öput
);

1673 i‡(
îr
)

1674 
out
;

1676 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
öput
->
group
 + 1);

1677 i‡(
îr
)

1678 
out
;

1680 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
öput
->
group
 + 1);

1681 i‡(
îr
)

1682 
out
;

1684 
Êex_gd
.
cou¡
 = 1;

1685 
Êex_gd
.
groups
 = 
öput
;

1686 
Êex_gd
.
bg_Êags
 = &bg_flags;

1687 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
öode
, &
Êex_gd
);

1688 
out
:

1689 
	`ùut
(
öode
);

1690  
îr
;

1691 
	}
}

1696 
	$pxt4_group_exãnd_no_check
(
su≥r_block
 *
sb
,

1697 
pxt4_fsblk_t
 
o_blocks_cou¡
, 
pxt4_gΩblk_t
 
add
)

1699 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1700 
h™dÀ_t
 *
h™dÀ
;

1701 
îr
 = 0, 
îr2
;

1706 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 3);

1707 i‡(
	`IS_ERR
(
h™dÀ
)) {

1708 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1709 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ sèπ", 
îr
);

1710  
îr
;

1713 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1714 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

1715 i‡(
îr
) {

1716 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ wrôêac˚ss", 
îr
);

1717 
îrout
;

1720 
	`pxt4_blocks_cou¡_£t
(
es
, 
o_blocks_cou¡
 + 
add
);

1721 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
add
);

1722 
	`pxt4_debug
("‰ìög block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1723 
o_blocks_cou¡
 + 
add
);

1725 
îr
 = 
	`pxt4_group_add_blocks
(
h™dÀ
, 
sb
, 
o_blocks_cou¡
, 
add
);

1726 i‡(
îr
)

1727 
îrout
;

1728 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1729 
	`pxt4_debug
("‰ìd block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1730 
o_blocks_cou¡
 + 
add
);

1731 
îrout
:

1732 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1733 i‡(
îr2
 && !
îr
)

1734 
îr
 = 
îr2
;

1736 i‡(!
îr
) {

1737 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1738 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:Éxtended groupÅo %llu "

1739 "blocks\n", 
	`pxt4_blocks_cou¡
(
es
));

1740 
	`upd©e_backups
(
sb
, 
	`PXT4_SB
(sb)->
s_sbh
->
b_blockƒ
,

1741 (*)
es
, (
pxt4_su≥r_block
), 0);

1743  
îr
;

1744 
	}
}

1756 
	$pxt4_group_exãnd
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

1757 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1759 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1760 
pxt4_gΩblk_t
 
œ°
;

1761 
pxt4_gΩblk_t
 
add
;

1762 
buf„r_hód
 *
bh
;

1763 
îr
;

1764 
pxt4_group_t
 
group
;

1766 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1768 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1769 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

1771 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1773 i‡(
n_blocks_cou¡
 =0 ||Ç_blocks_cou¡ =
o_blocks_cou¡
)

1776 i‡(
n_blocks_cou¡
 > (
£˘‹_t
)(~0ULLË>> (
sb
->
s_blocksize_bôs
 - 9)) {

1777 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1779 
n_blocks_cou¡
);

1780  -
EINVAL
;

1783 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1784 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1785  -
EINVAL
;

1789 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1791 i‡(
œ°
 == 0) {

1792 
	`pxt4_w¨nög
(
sb
, "needÅo useÖxt2onlineÅoÑesize further");

1793  -
EPERM
;

1796 
add
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
œ°
;

1798 i‡(
o_blocks_cou¡
 + 
add
 < o_blocks_count) {

1799 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1800  -
EINVAL
;

1803 i‡(
o_blocks_cou¡
 + 
add
 > 
n_blocks_cou¡
)

1804 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

1806 i‡(
o_blocks_cou¡
 + 
add
 < 
n_blocks_cou¡
)

1807 
	`pxt4_w¨nög
(
sb
, "will only finish group (%llu blocks, %uÇew)",

1808 
o_blocks_cou¡
 + 
add
,ádd);

1811 
bh
 = 
	`sb_bªad
(
sb
, 
o_blocks_cou¡
 + 
add
 - 1);

1812 i‡(!
bh
) {

1813 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1814  -
ENOSPC
;

1816 
	`bªl£
(
bh
);

1818 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

1819  
îr
;

1820 
	}
}

1823 
	$num_desc_blocks
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
groups
)

1825  (
groups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) / PXT4_DESC_PER_BLOCK(sb);

1826 
	}
}

1833 
	$pxt4_c⁄vît_mëa_bg
(
su≥r_block
 *
sb
, 
öode
 *inode)

1835 
h™dÀ_t
 *
h™dÀ
;

1836 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1837 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1838 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1839 
pxt4_fsblk_t
 
ƒ
;

1840 
i
, 
ªt
, 
îr
 = 0;

1841 
¸edôs
 = 1;

1843 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Converting file systemÅo meta_bg");

1844 i‡(
öode
) {

1845 i‡(
es
->
s_ª£rved_gdt_blocks
) {

1846 
	`pxt4_îr‹
(
sb
, "UnexpectedÇon-zero "

1848  -
EPERM
;

1852 i‡(
öode
->
i_blocks
 !1 << (öode->
i_blkbôs
 -

1853 (9 - 
sbi
->
s_˛u°î_bôs
)))

1854 
övÆid_ªsize_öode
;

1855 
i
 = 0; i < 
PXT4_N_BLOCKS
; i++) {

1856 i‡(
i
 =
PXT4_DIND_BLOCK
) {

1857 i‡(
ei
->
i_d©a
[
i
])

1860 
övÆid_ªsize_öode
;

1862 i‡(
ei
->
i_d©a
[
i
])

1863 
övÆid_ªsize_öode
;

1865 
¸edôs
 += 3;

1868 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edôs
);

1869 i‡(
	`IS_ERR
(
h™dÀ
))

1870  
	`PTR_ERR
(
h™dÀ
);

1872 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1873 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1874 i‡(
îr
)

1875 
îrout
;

1877 
	`pxt4_˛ór_„©uª_ªsize_öode
(
sb
);

1878 
	`pxt4_£t_„©uª_mëa_bg
(
sb
);

1879 
sbi
->
s_es
->
s_fú°_mëa_bg
 =

1880 
	`˝u_to_À32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
));

1882 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1883 i‡(
îr
) {

1884 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1885 
îrout
;

1888 i‡(
öode
) {

1889 
ƒ
 = 
	`À32_to_˝u
(
ei
->
i_d©a
[
PXT4_DIND_BLOCK
]);

1890 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1891 
PXT4_FREE_BLOCKS_METADATA
 |

1892 
PXT4_FREE_BLOCKS_FORGET
);

1893 
ei
->
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1894 
öode
->
i_blocks
 = 0;

1896 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1897 i‡(
îr
)

1898 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1901 
îrout
:

1902 
ªt
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1903 i‡(!
îr
)

1904 
îr
 = 
ªt
;

1905  
ªt
;

1907 
övÆid_ªsize_öode
:

1908 
	`pxt4_îr‹
(
sb
, "corrupted/inconsistentÑesize inode");

1909  -
EINVAL
;

1910 
	}
}

1918 
	$pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1920 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
 = 
NULL
;

1921 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1922 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1923 
buf„r_hód
 *
bh
;

1924 
öode
 *
ªsize_öode
 = 
NULL
;

1925 
pxt4_gΩblk_t
 
add
, 
off£t
;

1926 
n_desc_blocks
;

1927 
o_desc_blocks
;

1928 
pxt4_group_t
 
o_group
;

1929 
pxt4_group_t
 
n_group
;

1930 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1931 
pxt4_fsblk_t
 
n_blocks_cou¡_ªåy
 = 0;

1932 
œ°_upd©e_time
 = 0;

1933 
îr
 = 0, 
Êexbg_size
 = 1 << 
sbi
->
s_log_groups_≥r_Êex
;

1934 
mëa_bg
;

1937 
bh
 = 
	`sb_bªad
(
sb
, 
n_blocks_cou¡
 - 1);

1938 i‡(!
bh
) {

1939 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1940  -
ENOSPC
;

1942 
	`bªl£
(
bh
);

1944 
ªåy
:

1945 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1947 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1948 "tÿ%Œu blocks", 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1950 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1952 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1953  -
EINVAL
;

1956 i‡(
n_blocks_cou¡
 =
o_blocks_cou¡
)

1960 
n_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
n_blocks_cou¡
 - 1);

1961 i‡(
n_group
 >(0xFFFFFFFFUL / 
	`PXT4_INODES_PER_GROUP
(
sb
))) {

1962 
	`pxt4_w¨nög
(
sb
, "resize would cause inodes_count overflow");

1963  -
EINVAL
;

1965 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
 - 1, &
o_group
, &
off£t
);

1967 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1968 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
);

1970 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1972 i‡(
	`pxt4_has_„©uª_ªsize_öode
(
sb
)) {

1973 i‡(
mëa_bg
) {

1974 
	`pxt4_îr‹
(
sb
, "resize_inodeánd meta_bgÉnabled "

1976  -
EINVAL
;

1978 i‡(
n_desc_blocks
 > 
o_desc_blocks
 +

1979 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1980 
n_blocks_cou¡_ªåy
 = 
n_blocks_cou¡
;

1981 
n_desc_blocks
 = 
o_desc_blocks
 +

1982 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1983 
n_group
 = 
n_desc_blocks
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1984 
n_blocks_cou¡
 = (
pxt4_fsblk_t
)
n_group
 *

1985 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

1986 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

1987 
n_group
--;

1990 i‡(!
ªsize_öode
)

1991 
ªsize_öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
,

1992 
PXT4_IGET_SPECIAL
);

1993 i‡(
	`IS_ERR
(
ªsize_öode
)) {

1994 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1995  
	`PTR_ERR
(
ªsize_öode
);

1999 i‡((!
ªsize_öode
 && !
mëa_bg
Ë|| 
n_blocks_cou¡
 =
o_blocks_cou¡
) {

2000 
îr
 = 
	`pxt4_c⁄vît_mëa_bg
(
sb
, 
ªsize_öode
);

2001 i‡(
îr
)

2002 
out
;

2003 i‡(
ªsize_öode
) {

2004 
	`ùut
(
ªsize_öode
);

2005 
ªsize_öode
 = 
NULL
;

2007 i‡(
n_blocks_cou¡_ªåy
) {

2008 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2009 
n_blocks_cou¡_ªåy
 = 0;

2010 
ªåy
;

2021 i‡((
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
) +

2022 
	`pxt4_group_ovîhód_blocks
(
sb
, 
n_group
) + 2 +

2023 
sbi
->
s_ôb_≥r_group
 + sbi->
s_˛u°î_øtio
Ë>
n_blocks_cou¡
) {

2024 
n_blocks_cou¡
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
);

2025 
n_group
--;

2026 
n_blocks_cou¡_ªåy
 = 0;

2027 i‡(
ªsize_öode
) {

2028 
	`ùut
(
ªsize_öode
);

2029 
ªsize_öode
 = 
NULL
;

2031 
ªåy
;

2035 i‡(
n_group
 =
o_group
)

2036 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

2038 
add
 = 
	`PXT4_C2B
(
sbi
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
off£t
 + 1));

2039 i‡(
add
 > 0) {

2040 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

2041 i‡(
îr
)

2042 
out
;

2045 i‡(
	`pxt4_blocks_cou¡
(
es
Ë=
n_blocks_cou¡
)

2046 
out
;

2048 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
n_group
 + 1);

2049 i‡(
îr
)

2050 
out
;

2052 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
n_group
 + 1);

2053 i‡(
îr
)

2054 
out
;

2056 
Êex_gd
 = 
	`Æloc_Êex_gd
(
Êexbg_size
);

2057 i‡(
Êex_gd
 =
NULL
) {

2058 
îr
 = -
ENOMEM
;

2059 
out
;

2065 
	`pxt4_£tup_√xt_Êex_gd
(
sb
, 
Êex_gd
, 
n_blocks_cou¡
,

2066 
Êexbg_size
)) {

2067 i‡(
jiffõs
 - 
œ°_upd©e_time
 > 
HZ
 * 10) {

2068 i‡(
œ°_upd©e_time
)

2069 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2071 
	`pxt4_blocks_cou¡
(
es
));

2072 
œ°_upd©e_time
 = 
jiffõs
;

2074 i‡(
	`pxt4_Æloc_group_èbÀs
(
sb
, 
Êex_gd
, 
Êexbg_size
) != 0)

2076 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
ªsize_öode
, 
Êex_gd
);

2077 i‡(
	`u∆ikñy
(
îr
))

2081 i‡(!
îr
 && 
n_blocks_cou¡_ªåy
) {

2082 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2083 
n_blocks_cou¡_ªåy
 = 0;

2084 
	`‰ì_Êex_gd
(
Êex_gd
);

2085 
Êex_gd
 = 
NULL
;

2086 i‡(
ªsize_öode
) {

2087 
	`ùut
(
ªsize_öode
);

2088 
ªsize_öode
 = 
NULL
;

2090 
ªåy
;

2093 
out
:

2094 i‡(
Êex_gd
)

2095 
	`‰ì_Êex_gd
(
Êex_gd
);

2096 i‡(
ªsize_öode
 !
NULL
)

2097 
	`ùut
(
ªsize_öode
);

2098 i‡(
îr
)

2099 
	`pxt4_w¨nög
(
sb
, "error (%d) occurred during "

2100 "fûêsy°emÑesize", 
îr
);

2101 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resized filesystemÅo %llu",

2102 
	`pxt4_blocks_cou¡
(
es
));

2103  
îr
;

2104 
	}
}

	@super.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/vmÆloc.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/blkdev.h
>

28 
	~<löux/backög-dev.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/buf„r_hód.h
>

31 
	~<löux/exp‹tfs.h
>

32 
	~<löux/vfs.h
>

33 
	~<löux/øndom.h
>

34 
	~<löux/mou¡.h
>

35 
	~<löux/«mei.h
>

36 
	~<löux/quŸa›s.h
>

37 
	~<löux/£q_fûe.h
>

38 
	~<löux/˘y≥.h
>

39 
	~<löux/log2.h
>

40 
	~<löux/¸c16.h
>

41 
	~<löux/dax.h
>

42 
	~<löux/˛ónˇche.h
>

43 
	~<löux/uac˚ss.h
>

44 
	~<löux/ivîsi⁄.h
>

45 
	~<löux/unicode.h
>

47 
	~<löux/kthªad.h
>

48 
	~<löux/‰ìzî.h
>

50 
	~"pxt4.h
"

51 
	~"pxt4_exã¡s.h
"

52 
	~"pxt4_jbd3.h
"

53 
	~"x©å.h
"

54 
	~"a˛.h
"

55 
	~"mbÆloc.h
"

56 
	~"fsm≠.h
"

58 
	#CREATE_TRACE_POINTS


	)

59 
	~<åa˚/evíts/pxt4.h
>

61 
pxt4_œzy_öô
 *
	gpxt4_li_öfo
;

62 
muãx
 
	gpxt4_li_mtx
;

63 
øãlimô_°©e
 
	gpxt4_mou¡_msg_øãlimô
;

65 
pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *, 
pxt4_su≥r_block
 *,

66 
jou∫Æ_devnum
);

67 
pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
);

68 
pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
);

69 
pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

70 
pxt4_su≥r_block
 *
es
);

71 
pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

72 
pxt4_su≥r_block
 *
es
);

73 
pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

74 
pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

75 
pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
);

76 
pxt4_un‰ìze
(
su≥r_block
 *
sb
);

77 
pxt4_‰ìze
(
su≥r_block
 *
sb
);

78 
díåy
 *
pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

79 c⁄° *
dev_«me
, *
d©a
);

80 
ölöe
 
pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
);

81 
ölöe
 
ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
);

82 
pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
);

83 
pxt4_de°roy_œzyöô_thªad
();

84 
pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
);

85 
pxt4_˛ór_ªque°_li°
();

86 
öode
 *
pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

87 
jou∫Æ_öum
);

117 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

118 
fûe_sy°em_ty≥
 
	gpxt2_fs_ty≥
 = {

119 .
ow√r
 = 
THIS_MODULE
,

120 .
	g«me
 = "pxt2",

121 .
	gmou¡
 = 
pxt4_mou¡
,

122 .
	gkûl_sb
 = 
kûl_block_su≥r
,

123 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

125 
MODULE_ALIAS_FS
("pxt2");

126 
MODULE_ALIAS
("pxt2");

127 
	#IS_PXT2_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
pxt2_fs_ty≥
)

	)

129 
	#IS_PXT2_SB
(
sb
Ë(0)

	)

133 
fûe_sy°em_ty≥
 
	gext3_fs_ty≥
 = {

134 .
ow√r
 = 
THIS_MODULE
,

135 .
	g«me
 = "ext3",

136 .
	gmou¡
 = 
pxt4_mou¡
,

137 .
	gkûl_sb
 = 
kûl_block_su≥r
,

138 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

140 
MODULE_ALIAS_FS
("ext3");

141 
MODULE_ALIAS
("ext3");

142 
	#IS_EXT3_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
ext3_fs_ty≥
)

	)

150 
buf„r_hód
 *

151 
	$pxt4_sb_bªad
(
su≥r_block
 *
sb
, 
£˘‹_t
 
block
, 
›_Êags
)

153 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

155 i‡(
bh
 =
NULL
)

156  
	`ERR_PTR
(-
ENOMEM
);

157 i‡(
	`buf„r_u±od©e
(
bh
))

158  
bh
;

159 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
›_Êags
, 1, &
bh
);

160 
	`waô_⁄_buf„r
(
bh
);

161 i‡(
	`buf„r_u±od©e
(
bh
))

162  
bh
;

163 
	`put_bh
(
bh
);

164  
	`ERR_PTR
(-
EIO
);

165 
	}
}

167 
	$pxt4_vîify_csum_ty≥
(
su≥r_block
 *
sb
,

168 
pxt4_su≥r_block
 *
es
)

170 i‡(!
	`pxt4_has_„©uª_mëad©a_csum
(
sb
))

173  
es
->
s_checksum_ty≥
 =
PXT4_CRC32C_CHKSUM
;

174 
	}
}

176 
__À32
 
	$pxt4_su≥rblock_csum
(
su≥r_block
 *
sb
,

177 
pxt4_su≥r_block
 *
es
)

179 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

180 
off£t
 = 
	`off£tof
(
pxt4_su≥r_block
, 
s_checksum
);

181 
__u32
 
csum
;

183 
csum
 = 
	`pxt4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

185  
	`˝u_to_À32
(
csum
);

186 
	}
}

188 
	$pxt4_su≥rblock_csum_vîify
(
su≥r_block
 *
sb
,

189 
pxt4_su≥r_block
 *
es
)

191 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

194  
es
->
s_checksum
 =
	`pxt4_su≥rblock_csum
(
sb
,És);

195 
	}
}

197 
	$pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
)

199 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

201 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

204 
es
->
s_checksum
 = 
	`pxt4_su≥rblock_csum
(
sb
,És);

205 
	}
}

207 *
	$pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

209 *
ªt
;

211 
ªt
 = 
	`kmÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

212 i‡(!
ªt
)

213 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
, 
PAGE_KERNEL
);

214  
ªt
;

215 
	}
}

217 *
	$pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

219 *
ªt
;

221 
ªt
 = 
	`kzÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

222 i‡(!
ªt
)

223 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

224  
ªt
;

225 
	}
}

227 
pxt4_fsblk_t
 
	$pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

228 
pxt4_group_desc
 *
bg
)

230  
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_lo
) |

231 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_hi
) << 32 : 0);

233 
	}
}

235 
pxt4_fsblk_t
 
	$pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

236 
pxt4_group_desc
 *
bg
)

238  
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_lo
) |

239 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_hi
) << 32 : 0);

241 
	}
}

243 
pxt4_fsblk_t
 
	$pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

244 
pxt4_group_desc
 *
bg
)

246  
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_lo
) |

247 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_hi
) << 32 : 0);

249 
	}
}

251 
__u32
 
	$pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

252 
pxt4_group_desc
 *
bg
)

254  
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_lo
) |

255 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_hi
) << 16 : 0);

257 
	}
}

259 
__u32
 
	$pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

260 
pxt4_group_desc
 *
bg
)

262  
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_lo
) |

263 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

264 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_hi
) << 16 : 0);

265 
	}
}

267 
__u32
 
	$pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

268 
pxt4_group_desc
 *
bg
)

270  
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_lo
) |

271 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

272 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_hi
) << 16 : 0);

273 
	}
}

275 
__u32
 
	$pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

276 
pxt4_group_desc
 *
bg
)

278  
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_lo
) |

279 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

280 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_hi
) << 16 : 0);

281 
	}
}

283 
	$pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

284 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

286 
bg
->
bg_block_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

287 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_block_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

289 
	}
}

291 
	$pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

292 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

294 
bg
->
bg_öode_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

295 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_öode_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

297 
	}
}

299 
	$pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

300 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

302 
bg
->
bg_öode_èbÀ_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

303 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_öode_èbÀ_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

305 
	}
}

307 
	$pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

308 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

310 
bg
->
bg_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

311 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

313 
	}
}

315 
	$pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

316 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

318 
bg
->
bg_‰ì_öodes_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

319 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

320 
bg
->
bg_‰ì_öodes_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

321 
	}
}

323 
	$pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

324 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

326 
bg
->
bg_u£d_dús_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

327 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

328 
bg
->
bg_u£d_dús_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

329 
	}
}

331 
	$pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

332 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

334 
bg
->
bg_ôabÀ_unu£d_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

335 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

336 
bg
->
bg_ôabÀ_unu£d_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

337 
	}
}

339 
	$__pxt4_upd©e_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

341 
time64_t
 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

343 
now
 = 
	`˛amp_vÆ
(now, 0, (1ull << 40) - 1);

345 *
lo
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
now
));

346 *
hi
 = 
	`uµî_32_bôs
(
now
);

347 
	}
}

349 
time64_t
 
	$__pxt4_gë_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

351  ((
time64_t
)(*
hi
Ë<< 32Ë+ 
	`À32_to_˝u
(*
lo
);

352 
	}
}

353 
	#pxt4_upd©e_t°amp
(
es
, 
t°amp
) \

354 
	`__pxt4_upd©e_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

355 
	#pxt4_gë_t°amp
(
es
, 
t°amp
) \

356 
	`__pxt4_gë_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

358 
	$__ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

359 
löe
)

361 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

363 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

364 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

366 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

367 
	`pxt4_upd©e_t°amp
(
es
, 
s_œ°_îr‹_time
);

368 
	`°∫˝y
(
es
->
s_œ°_îr‹_func
, 
func
, (es->s_last_error_func));

369 
es
->
s_œ°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

370 i‡(!
es
->
s_fú°_îr‹_time
) {

371 
es
->
s_fú°_îr‹_time
 =És->
s_œ°_îr‹_time
;

372 
es
->
s_fú°_îr‹_time_hi
 =És->
s_œ°_îr‹_time_hi
;

373 
	`°∫˝y
(
es
->
s_fú°_îr‹_func
, 
func
,

374 (
es
->
s_fú°_îr‹_func
));

375 
es
->
s_fú°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

376 
es
->
s_fú°_îr‹_öo
 =És->
s_œ°_îr‹_öo
;

377 
es
->
s_fú°_îr‹_block
 =És->
s_œ°_îr‹_block
;

383 i‡(!
es
->
s_îr‹_cou¡
)

384 
	`mod_timî
(&
	`PXT4_SB
(
sb
)->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

385 
	`À32_add_˝u
(&
es
->
s_îr‹_cou¡
, 1);

386 
	}
}

388 
	$ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

389 
löe
)

391 
	`__ßve_îr‹_öfo
(
sb
, 
func
, 
löe
);

392 
	`pxt4_commô_su≥r
(
sb
, 1);

393 
	}
}

403 
	$block_devi˚_eje˘ed
(
su≥r_block
 *
sb
)

405 
öode
 *
bd_öode
 = 
sb
->
s_bdev
->bd_inode;

406 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
bd_öode
);

408  
bdi
->
dev
 =
NULL
;

409 
	}
}

411 
	$pxt4_jou∫Æ_commô_ˇŒback
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
txn
)

413 
su≥r_block
 *
sb
 = 
jou∫Æ
->
j_¥iv©e
;

414 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

415 
îr‹
 = 
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
);

416 
pxt4_jou∫Æ_cb_íåy
 *
j˚
;

418 
	`BUG_ON
(
txn
->
t_°©e
 =
T_FINISHED
);

420 
	`pxt4_¥o˚ss_‰ìd_d©a
(
sb
, 
txn
->
t_tid
);

422 
	`•ö_lock
(&
sbi
->
s_md_lock
);

423 !
	`li°_em±y
(&
txn
->
t_¥iv©e_li°
)) {

424 
j˚
 = 
	`li°_íåy
(
txn
->
t_¥iv©e_li°
.
√xt
,

425 
pxt4_jou∫Æ_cb_íåy
, 
j˚_li°
);

426 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

427 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

428 
j˚
->
	`j˚_func
(
sb
, j˚, 
îr‹
);

429 
	`•ö_lock
(&
sbi
->
s_md_lock
);

431 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

432 
	}
}

434 
boﬁ
 
	$sy°em_goög_down
()

436  
sy°em_°©e
 =
SYSTEM_HALT
 || sy°em_°©ê=
SYSTEM_POWER_OFF


437 || 
sy°em_°©e
 =
SYSTEM_RESTART
;

438 
	}
}

455 
	$pxt4_h™dÀ_îr‹
(
su≥r_block
 *
sb
)

457 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

458 
	`WARN_ON_ONCE
(1);

460 i‡(
	`sb_rd⁄ly
(
sb
))

463 i‡(!
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

464 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

466 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

467 i‡(
jou∫Æ
)

468 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

475 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë|| 
	`sy°em_goög_down
()) {

476 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

481 
	`smp_wmb
();

482 
sb
->
s_Êags
 |
SB_RDONLY
;

483 } i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
)) {

484 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

485 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

487 
	`∑nic
("PXT4-fs (device %s):Öanic forcedáfterÉrror\n",

488 
sb
->
s_id
);

490 
	}
}

492 
	#pxt4_îr‹_øãlimô
(
sb
) \

493 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_îr_øãlimô_°©e
), \

494 "PXT4-f†îr‹")

	)

496 
	$__pxt4_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

497 
löe
, c⁄° *
fmt
, ...)

499 
va_f‹m©
 
vaf
;

500 
va_li°
 
¨gs
;

502 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

505 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

506 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

507 
	`va_°¨t
(
¨gs
, 
fmt
);

508 
vaf
.
fmt
 = fmt;

509 
vaf
.
va
 = &
¨gs
;

510 
	`¥ötk
(
KERN_CRIT


512 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
cuºít
->
comm
, &
vaf
);

513 
	`va_íd
(
¨gs
);

515 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

516 
	`pxt4_h™dÀ_îr‹
(
sb
);

517 
	}
}

519 
	$__pxt4_îr‹_öode
(
öode
 *öode, c⁄° *
fun˘i⁄
,

520 
löe
, 
pxt4_fsblk_t
 
block
,

521 c⁄° *
fmt
, ...)

523 
va_li°
 
¨gs
;

524 
va_f‹m©
 
vaf
;

525 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

527 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

530 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

531 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

532 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

533 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

534 
	`va_°¨t
(
¨gs
, 
fmt
);

535 
vaf
.
fmt
 = fmt;

536 
vaf
.
va
 = &
¨gs
;

537 i‡(
block
)

538 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

540 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

541 
block
, 
cuºít
->
comm
, &
vaf
);

543 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

545 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

546 
cuºít
->
comm
, &
vaf
);

547 
	`va_íd
(
¨gs
);

549 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

550 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

551 
	}
}

553 
	$__pxt4_îr‹_fûe
(
fûe
 *fûe, c⁄° *
fun˘i⁄
,

554 
löe
, 
pxt4_fsblk_t
 
block
,

555 c⁄° *
fmt
, ...)

557 
va_li°
 
¨gs
;

558 
va_f‹m©
 
vaf
;

559 
pxt4_su≥r_block
 *
es
;

560 
öode
 *öodê
	`fûe_öode
(
fûe
);

561 
∑th«me
[80], *
∑th
;

563 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

566 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

567 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

568 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

569 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

570 
∑th
 = 
	`fûe_∑th
(
fûe
, 
∑th«me
, (pathname));

571 i‡(
	`IS_ERR
(
∑th
))

572 
∑th
 = "(unknown)";

573 
	`va_°¨t
(
¨gs
, 
fmt
);

574 
vaf
.
fmt
 = fmt;

575 
vaf
.
va
 = &
¨gs
;

576 i‡(
block
)

577 
	`¥ötk
(
KERN_CRIT


580 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

581 
block
, 
cuºít
->
comm
, 
∑th
, &
vaf
);

583 
	`¥ötk
(
KERN_CRIT


586 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

587 
cuºít
->
comm
, 
∑th
, &
vaf
);

588 
	`va_íd
(
¨gs
);

590 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

591 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

592 
	}
}

594 c⁄° *
	$pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

595 
nbuf
[16])

597 *
îr°r
 = 
NULL
;

599 
î∫o
) {

600 -
EFSCORRUPTED
:

601 
îr°r
 = "Corrupt filesystem";

603 -
EFSBADCRC
:

604 
îr°r
 = "Filesystem failed CRC";

606 -
EIO
:

607 
îr°r
 = "IO failure";

609 -
ENOMEM
:

610 
îr°r
 = "Out of memory";

612 -
EROFS
:

613 i‡(!
sb
 || (
	`PXT4_SB
(sb)->
s_jou∫Æ
 &&

614 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
))

615 
îr°r
 = "Journal hasáborted";

617 
îr°r
 = "Readonly filesystem";

623 i‡(
nbuf
) {

625 i‡(
	`¢¥ötf
(
nbuf
, 16, "îr‹ %d", -
î∫o
) >= 0)

626 
îr°r
 = 
nbuf
;

631  
îr°r
;

632 
	}
}

637 
	$__pxt4_°d_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

638 
löe
, 
î∫o
)

640 
nbuf
[16];

641 c⁄° *
îr°r
;

643 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

649 i‡(
î∫o
 =-
EROFS
 && 
	`jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
 && 
	`sb_rd⁄ly
(
sb
))

652 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

653 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
î∫o
, 
nbuf
);

654 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s) in %s:%d: %s\n",

655 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
îr°r
);

658 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

659 
	`pxt4_h™dÀ_îr‹
(
sb
);

660 
	}
}

672 
	$__pxt4_ab‹t
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

673 
löe
, c⁄° *
fmt
, ...)

675 
va_f‹m©
 
vaf
;

676 
va_li°
 
¨gs
;

678 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

681 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

682 
	`va_°¨t
(
¨gs
, 
fmt
);

683 
vaf
.
fmt
 = fmt;

684 
vaf
.
va
 = &
¨gs
;

685 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: %pV\n",

686 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

687 
	`va_íd
(
¨gs
);

689 i‡(
	`sb_rd⁄ly
(
sb
) == 0) {

690 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

691 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

696 
	`smp_wmb
();

697 
sb
->
s_Êags
 |
SB_RDONLY
;

698 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

699 
	`jbd3_jou∫Æ_ab‹t
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, -
EIO
);

700 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

702 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& !
	`sy°em_goög_down
()) {

703 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

704 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

706 
	`∑nic
("PXT4-fsÖanic fromÖreviousÉrror\n");

708 
	}
}

710 
	$__pxt4_msg
(
su≥r_block
 *
sb
,

711 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

713 
va_f‹m©
 
vaf
;

714 
va_li°
 
¨gs
;

716 i‡(!
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_msg_øãlimô_°©e
), "PXT4-fs"))

719 
	`va_°¨t
(
¨gs
, 
fmt
);

720 
vaf
.
fmt
 = fmt;

721 
vaf
.
va
 = &
¨gs
;

722 
	`¥ötk
("%sPXT4-f†(%s): %pV\n", 
¥efix
, 
sb
->
s_id
, &
vaf
);

723 
	`va_íd
(
¨gs
);

724 
	}
}

726 
	#pxt4_w¨nög_øãlimô
(
sb
) \

727 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_w¨nög_øãlimô_°©e
), \

728 "PXT4-f†w¨nög")

	)

730 
	$__pxt4_w¨nög
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

731 
löe
, c⁄° *
fmt
, ...)

733 
va_f‹m©
 
vaf
;

734 
va_li°
 
¨gs
;

736 i‡(!
	`pxt4_w¨nög_øãlimô
(
sb
))

739 
	`va_°¨t
(
¨gs
, 
fmt
);

740 
vaf
.
fmt
 = fmt;

741 
vaf
.
va
 = &
¨gs
;

742 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: %pV\n",

743 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

744 
	`va_íd
(
¨gs
);

745 
	}
}

747 
	$__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

748 
löe
, c⁄° *
fmt
, ...)

750 
va_f‹m©
 
vaf
;

751 
va_li°
 
¨gs
;

753 i‡(!
	`pxt4_w¨nög_øãlimô
(
öode
->
i_sb
))

756 
	`va_°¨t
(
¨gs
, 
fmt
);

757 
vaf
.
fmt
 = fmt;

758 
vaf
.
va
 = &
¨gs
;

759 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: "

760 "öodê#%lu: comm %s: %pV\n", 
öode
->
i_sb
->
s_id
,

761 
fun˘i⁄
, 
löe
, 
öode
->
i_öo
, 
cuºít
->
comm
, &
vaf
);

762 
	`va_íd
(
¨gs
);

763 
	}
}

765 
	$__pxt4_gΩ_locked_îr‹
(c⁄° *
fun˘i⁄
, 
löe
,

766 
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

767 
öo
, 
pxt4_fsblk_t
 
block
,

768 c⁄° *
fmt
, ...)

769 
	$__ªÀa£s
(
bôlock
)

770 
	$__acquúes
(
bôlock
)

772 
va_f‹m©
 
vaf
;

773 
va_li°
 
¨gs
;

774 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

776 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

779 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

780 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öo
);

781 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

782 
	`__ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

784 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

785 
	`va_°¨t
(
¨gs
, 
fmt
);

786 
vaf
.
fmt
 = fmt;

787 
vaf
.
va
 = &
¨gs
;

788 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: group %u, ",

789 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
gΩ
);

790 i‡(
öo
)

791 
	`¥ötk
(
KERN_CONT
 "öodê%lu: ", 
öo
);

792 i‡(
block
)

793 
	`¥ötk
(
KERN_CONT
 "block %llu:",

794 (Ë
block
);

795 
	`¥ötk
(
KERN_CONT
 "%pV\n", &
vaf
);

796 
	`va_íd
(
¨gs
);

799 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

800 
	`WARN_ON_ONCE
(1);

802 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

803 
	`pxt4_commô_su≥r
(
sb
, 0);

807 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

808 
	`pxt4_commô_su≥r
(
sb
, 1);

809 
	`pxt4_h™dÀ_îr‹
(
sb
);

821 
	`pxt4_lock_group
(
sb
, 
gΩ
);

823 
	}
}

825 
	$pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

826 
pxt4_group_t
 
group
,

827 
Êags
)

829 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

830 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

831 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

832 
ªt
;

834 i‡(
Êags
 & 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

835 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

836 &
gΩ
->
bb_°©e
);

837 i‡(!
ªt
)

838 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

839 
gΩ
->
bb_‰ì
);

842 i‡(
Êags
 & 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

843 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

844 &
gΩ
->
bb_°©e
);

845 i‡(!
ªt
 && 
gdp
) {

846 
cou¡
;

848 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

849 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ìöodes_cou¡î
,

850 
cou¡
);

853 
	}
}

855 
	$pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
)

857 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

859 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_GOOD_OLD_REV
)

862 
	`pxt4_w¨nög
(
sb
,

865 
PXT4_DYNAMIC_REV
);

867 
es
->
s_fú°_öo
 = 
	`˝u_to_À32
(
PXT4_GOOD_OLD_FIRST_INO
);

868 
es
->
s_öode_size
 = 
	`˝u_to_À16
(
PXT4_GOOD_OLD_INODE_SIZE
);

869 
es
->
s_ªv_Àvñ
 = 
	`˝u_to_À32
(
PXT4_DYNAMIC_REV
);

878 
	}
}

883 
block_devi˚
 *
	$pxt4_blkdev_gë
(
dev_t
 
dev
, 
su≥r_block
 *
sb
)

885 
block_devi˚
 *
bdev
;

886 
b
[
BDEVNAME_SIZE
];

888 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

889 i‡(
	`IS_ERR
(
bdev
))

890 
Áû
;

891  
bdev
;

893 
Áû
:

894 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo open journal device %s: %ld",

895 
	`__bdev«me
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

896  
NULL
;

897 
	}
}

902 
	$pxt4_blkdev_put
(
block_devi˚
 *
bdev
)

904 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

905 
	}
}

907 
	$pxt4_blkdev_ªmove
(
pxt4_sb_öfo
 *
sbi
)

909 
block_devi˚
 *
bdev
;

910 
bdev
 = 
sbi
->
jou∫Æ_bdev
;

911 i‡(
bdev
) {

912 
	`pxt4_blkdev_put
(
bdev
);

913 
sbi
->
jou∫Æ_bdev
 = 
NULL
;

915 
	}
}

917 
ölöe
 
öode
 *
	$‹ph™_li°_íåy
(
li°_hód
 *
l
)

919  &
	`li°_íåy
(
l
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

920 
	}
}

922 
	$dump_‹ph™_li°
(
su≥r_block
 *
sb
, 
pxt4_sb_öfo
 *
sbi
)

924 
li°_hód
 *
l
;

926 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

927 
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
));

929 
	`¥ötk
(
KERN_ERR
 "sb_info orphanÜist:\n");

930 
	`li°_f‹_óch
(
l
, &
sbi
->
s_‹ph™
) {

931 
öode
 *öodê
	`‹ph™_li°_íåy
(
l
);

932 
	`¥ötk
(
KERN_ERR
 " "

934 
öode
->
i_sb
->
s_id
, inode->
i_öo
, inode,

935 
öode
->
i_mode
, inode->
i_∆ök
,

936 
	`NEXT_ORPHAN
(
öode
));

938 
	}
}

940 #ifde‡
CONFIG_QUOTA


941 
pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
);

943 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

945 
ty≥
;

948 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++)

949 
	`pxt4_quŸa_off
(
sb
, 
ty≥
);

950 
	}
}

956 
ölöe
 *
	$gë_qf_«me
(
su≥r_block
 *
sb
,

957 
pxt4_sb_öfo
 *
sbi
,

958 
ty≥
)

960  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
sbi
->
s_qf_«mes
[
ty≥
],

961 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

962 
	}
}

964 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

966 
	}
}

969 
	$pxt4_put_su≥r
(
su≥r_block
 *
sb
)

971 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

972 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

973 
buf„r_hód
 **
group_desc
;

974 
Êex_groups
 **flex_groups;

975 
ab‹ãd
 = 0;

976 
i
, 
îr
;

978 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

979 
	`pxt4_quŸa_off_umou¡
(
sb
);

981 
	`de°roy_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

983 i‡(
sbi
->
s_jou∫Æ
) {

984 
ab‹ãd
 = 
	`is_jou∫Æ_ab‹ãd
(
sbi
->
s_jou∫Æ
);

985 
îr
 = 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

986 
sbi
->
s_jou∫Æ
 = 
NULL
;

987 i‡((
îr
 < 0Ë&& !
ab‹ãd
)

988 
	`pxt4_ab‹t
(
sb
, "Couldn't clean upÅhe journal");

991 
	`pxt4_uƒegi°î_sysfs
(
sb
);

992 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

993 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

994 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

995 
	`pxt4_mb_ªÀa£
(
sb
);

996 
	`pxt4_ext_ªÀa£
(
sb
);

998 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& !
ab‹ãd
) {

999 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

1000 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

1002 i‡(!
	`sb_rd⁄ly
(
sb
))

1003 
	`pxt4_commô_su≥r
(
sb
, 1);

1005 
	`rcu_ªad_lock
();

1006 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

1007 
i
 = 0; i < 
sbi
->
s_gdb_cou¡
; i++)

1008 
	`bªl£
(
group_desc
[
i
]);

1009 
	`kv‰ì
(
group_desc
);

1010 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

1011 i‡(
Êex_groups
) {

1012 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

1013 
	`kv‰ì
(
Êex_groups
[
i
]);

1014 
	`kv‰ì
(
Êex_groups
);

1016 
	`rcu_ªad_u∆ock
();

1017 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

1018 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

1019 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

1020 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

1021 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

1022 #ifde‡
CONFIG_QUOTA


1023 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

1024 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

1031 i‡(!
	`li°_em±y
(&
sbi
->
s_‹ph™
))

1032 
	`dump_‹ph™_li°
(
sb
, 
sbi
);

1033 
	`J_ASSERT
(
	`li°_em±y
(&
sbi
->
s_‹ph™
));

1035 
	`sync_blockdev
(
sb
->
s_bdev
);

1036 
	`övÆid©e_bdev
(
sb
->
s_bdev
);

1037 i‡(
sbi
->
jou∫Æ_bdev
 && sbi->jou∫Æ_bdev !
sb
->
s_bdev
) {

1043 
	`sync_blockdev
(
sbi
->
jou∫Æ_bdev
);

1044 
	`övÆid©e_bdev
(
sbi
->
jou∫Æ_bdev
);

1045 
	`pxt4_blkdev_ªmove
(
sbi
);

1048 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

1049 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

1051 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

1052 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

1054 i‡(
sbi
->
s_mmp_tsk
)

1055 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

1056 
	`bªl£
(
sbi
->
s_sbh
);

1057 
sb
->
s_fs_öfo
 = 
NULL
;

1062 
	`kobje˘_put
(&
sbi
->
s_kobj
);

1063 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

1064 i‡(
sbi
->
s_chksum_drivî
)

1065 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

1066 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

1067 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1068 #ifde‡
CONFIG_UNICODE


1069 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

1071 
	`k‰ì
(
sbi
);

1072 
	}
}

1074 
kmem_ˇche
 *
	gpxt4_öode_ˇchï
;

1079 
öode
 *
	$pxt4_Æloc_öode
(
su≥r_block
 *
sb
)

1081 
pxt4_öode_öfo
 *
ei
;

1083 
ei
 = 
	`kmem_ˇche_Æloc
(
pxt4_öode_ˇchï
, 
GFP_NOFS
);

1084 i‡(!
ei
)

1085  
NULL
;

1087 
	`öode_£t_ivîsi⁄
(&
ei
->
vfs_öode
, 1);

1088 
	`•ö_lock_öô
(&
ei
->
i_øw_lock
);

1089 
	`INIT_LIST_HEAD
(&
ei
->
i_¥óŒoc_li°
);

1090 
	`•ö_lock_öô
(&
ei
->
i_¥óŒoc_lock
);

1091 
	`pxt4_es_öô_åì
(&
ei
->
i_es_åì
);

1092 
	`rwlock_öô
(&
ei
->
i_es_lock
);

1093 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li°
);

1094 
ei
->
i_es_Æl_ƒ
 = 0;

1095 
ei
->
i_es_shk_ƒ
 = 0;

1096 
ei
->
i_es_shrök_lblk
 = 0;

1097 
ei
->
i_ª£rved_d©a_blocks
 = 0;

1098 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

1099 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 0;

1100 
	`•ö_lock_öô
(&(
ei
->
i_block_ª£rv©i⁄_lock
));

1101 
	`pxt4_öô_≥ndög_åì
(&
ei
->
i_≥ndög_åì
);

1102 #ifde‡
CONFIG_QUOTA


1103 
ei
->
i_ª£rved_quŸa
 = 0;

1104 
	`mem£t
(&
ei
->
i_dquŸ
, 0, (ei->i_dquot));

1106 
ei
->
jöode
 = 
NULL
;

1107 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
);

1108 
	`•ö_lock_öô
(&
ei
->
i_com∂ëed_io_lock
);

1109 
ei
->
i_sync_tid
 = 0;

1110 
ei
->
i_d©async_tid
 = 0;

1111 
	`©omic_£t
(&
ei
->
i_unwrôãn
, 0);

1112 
	`INIT_WORK
(&
ei
->
i_rsv_c⁄vîsi⁄_w‹k
, 
pxt4_íd_io_rsv_w‹k
);

1113  &
ei
->
vfs_öode
;

1114 
	}
}

1116 
	$pxt4_dr›_öode
(
öode
 *inode)

1118 
dr›
 = 
	`gíîic_dr›_öode
(
öode
);

1120 i‡(!
dr›
)

1121 
dr›
 = 
	`fs¸y±_dr›_öode
(
öode
);

1123 
	`åa˚_pxt4_dr›_öode
(
öode
, 
dr›
);

1124  
dr›
;

1125 
	}
}

1127 
	$pxt4_‰ì_ö_c‹e_öode
(
öode
 *inode)

1129 
	`fs¸y±_‰ì_öode
(
öode
);

1130 
	`kmem_ˇche_‰ì
(
pxt4_öode_ˇchï
, 
	`PXT4_I
(
öode
));

1131 
	}
}

1133 
	$pxt4_de°roy_öode
(
öode
 *inode)

1135 i‡(!
	`li°_em±y
(&(
	`PXT4_I
(
öode
)->
i_‹ph™
))) {

1136 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_ERR
,

1138 
öode
->
i_öo
, 
	`PXT4_I
(inode));

1139 
	`¥öt_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1140 
	`PXT4_I
(
öode
), (
pxt4_öode_öfo
),

1141 
åue
);

1142 
	`dump_°ack
();

1144 
	}
}

1146 
	$öô_⁄˚
(*
foo
)

1148 
pxt4_öode_öfo
 *
ei
 = (pxt4_öode_öfÿ*Ë
foo
;

1150 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

1151 
	`öô_rw£m
(&
ei
->
x©å_£m
);

1152 
	`öô_rw£m
(&
ei
->
i_d©a_£m
);

1153 
	`öô_rw£m
(&
ei
->
i_mm≠_£m
);

1154 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

1155 
	}
}

1157 
__öô
 
	$öô_öodeˇche
()

1159 
pxt4_öode_ˇchï
 = 
	`kmem_ˇche_¸óã_u£rc›y
("pxt4_inode_cache",

1160 (
pxt4_öode_öfo
), 0,

1161 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1162 
SLAB_ACCOUNT
),

1163 
	`off£tof
(
pxt4_öode_öfo
, 
i_d©a
),

1164 
	`sizeof_fõld
(
pxt4_öode_öfo
, 
i_d©a
),

1165 
öô_⁄˚
);

1166 i‡(
pxt4_öode_ˇchï
 =
NULL
)

1167  -
ENOMEM
;

1169 
	}
}

1171 
	$de°roy_öodeˇche
()

1177 
	`rcu_b¨rõr
();

1178 
	`kmem_ˇche_de°roy
(
pxt4_öode_ˇchï
);

1179 
	}
}

1181 
	$pxt4_˛ór_öode
(
öode
 *inode)

1183 
	`övÆid©e_öode_buf„rs
(
öode
);

1184 
	`˛ór_öode
(
öode
);

1185 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

1186 
	`pxt4_es_ªmove_exã¡
(
öode
, 0, 
EXT_MAX_BLOCKS
);

1187 
	`dquŸ_dr›
(
öode
);

1188 i‡(
	`PXT4_I
(
öode
)->
jöode
) {

1189 
	`jbd3_jou∫Æ_ªÀa£_jbd_öode
(
	`PXT4_JOURNAL
(
öode
),

1190 
	`PXT4_I
(
öode
)->
jöode
);

1191 
	`jbd3_‰ì_öode
(
	`PXT4_I
(
öode
)->
jöode
);

1192 
	`PXT4_I
(
öode
)->
jöode
 = 
NULL
;

1194 
	`fs¸y±_put_í¸y±i⁄_öfo
(
öode
);

1195 
	`fsvîôy_˛ónup_öode
(
öode
);

1196 
	}
}

1198 
öode
 *
	$pxt4_nfs_gë_öode
(
su≥r_block
 *
sb
,

1199 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1201 
öode
 *inode;

1207 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_HANDLE
);

1208 i‡(
	`IS_ERR
(
öode
))

1209  
	`ERR_CAST
(
öode
);

1210 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1211 
	`ùut
(
öode
);

1212  
	`ERR_PTR
(-
ESTALE
);

1215  
öode
;

1216 
	}
}

1218 
díåy
 *
	$pxt4_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

1219 
fh_Àn
, 
fh_ty≥
)

1221  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1222 
pxt4_nfs_gë_öode
);

1223 
	}
}

1225 
díåy
 *
	$pxt4_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

1226 
fh_Àn
, 
fh_ty≥
)

1228  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1229 
pxt4_nfs_gë_öode
);

1230 
	}
}

1232 
	$pxt4_nfs_commô_mëad©a
(
öode
 *inode)

1234 
wrôeback_c⁄åﬁ
 
wbc
 = {

1235 .
sync_mode
 = 
WB_SYNC_ALL


1238 
	`åa˚_pxt4_nfs_commô_mëad©a
(
öode
);

1239  
	`pxt4_wrôe_öode
(
öode
, &
wbc
);

1240 
	}
}

1248 
	$bdev_åy_to_‰ì_∑ge
(
su≥r_block
 *
sb
, 
∑ge
 *page,

1249 
gÂ_t
 
waô
)

1251 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

1253 
	`WARN_ON
(
	`PageChecked
(
∑ge
));

1254 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1256 i‡(
jou∫Æ
)

1257  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
,

1258 
waô
 & ~
__GFP_DIRECT_RECLAIM
);

1259  
	`åy_to_‰ì_buf„rs
(
∑ge
);

1260 
	}
}

1262 #ifde‡
CONFIG_FS_ENCRYPTION


1263 
	$pxt4_gë_c⁄ãxt
(
öode
 *öode, *
˘x
, 
size_t
 
Àn
)

1265  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1266 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
˘x
, 
Àn
);

1267 
	}
}

1269 
	$pxt4_£t_c⁄ãxt
(
öode
 *öode, c⁄° *
˘x
, 
size_t
 
Àn
,

1270 *
fs_d©a
)

1272 
h™dÀ_t
 *
h™dÀ
 = 
fs_d©a
;

1273 
ªs
, 
ªs2
, 
¸edôs
, 
ªåõs
 = 0;

1281 i‡(
öode
->
i_öo
 =
PXT4_ROOT_INO
)

1282  -
EPERM
;

1284 i‡(
	`WARN_ON_ONCE
(
	`IS_DAX
(
öode
Ë&& 
	`i_size_ªad
(inode)))

1285  -
EINVAL
;

1287 
ªs
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

1288 i‡(
ªs
)

1289  
ªs
;

1299 i‡(
h™dÀ
) {

1300 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

1301 
PXT4_XATTR_INDEX_ENCRYPTION
,

1302 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1303 
˘x
, 
Àn
, 0);

1304 i‡(!
ªs
) {

1305 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1306 
	`pxt4_˛ór_öode_°©e
(
öode
,

1307 
PXT4_STATE_MAY_INLINE_DATA
);

1312 
	`pxt4_£t_öode_Êags
(
öode
);

1314  
ªs
;

1317 
ªs
 = 
	`dquŸ_öôülize
(
öode
);

1318 i‡(
ªs
)

1319  
ªs
;

1320 
ªåy
:

1321 
ªs
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
Àn
, 
Ál£
 ,

1322 &
¸edôs
);

1323 i‡(
ªs
)

1324  
ªs
;

1326 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

1327 i‡(
	`IS_ERR
(
h™dÀ
))

1328  
	`PTR_ERR
(
h™dÀ
);

1330 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1331 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1332 
˘x
, 
Àn
, 0);

1333 i‡(!
ªs
) {

1334 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1339 
	`pxt4_£t_öode_Êags
(
öode
);

1340 
ªs
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1341 i‡(
ªs
)

1342 
	`PXT4_ERROR_INODE
(
öode
, "FailedÅo mark inode dirty");

1344 
ªs2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1346 i‡(
ªs
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1347 
ªåy
;

1348 i‡(!
ªs
)

1349 
ªs
 = 
ªs2
;

1350  
ªs
;

1351 
	}
}

1353 
boﬁ
 
	$pxt4_dummy_c⁄ãxt
(
öode
 *inode)

1355  
	`DUMMY_ENCRYPTION_ENABLED
(
	`PXT4_SB
(
öode
->
i_sb
));

1356 
	}
}

1358 
boﬁ
 
	$pxt4_has_°abÀ_öodes
(
su≥r_block
 *
sb
)

1360  
	`pxt4_has_„©uª_°abÀ_öodes
(
sb
);

1361 
	}
}

1363 
	$pxt4_gë_öo_™d_lblk_bôs
(
su≥r_block
 *
sb
,

1364 *
öo_bôs_ªt
, *
lblk_bôs_ªt
)

1366 *
öo_bôs_ªt
 = 8 * (
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1367 *
lblk_bôs_ªt
 = 8 * (
pxt4_lblk_t
);

1368 
	}
}

1370 c⁄° 
fs¸y±_›î©i⁄s
 
	gpxt4_¸y±›s
 = {

1371 .
key_¥efix
 = "pxt4:",

1372 .
	ggë_c⁄ãxt
 = 
pxt4_gë_c⁄ãxt
,

1373 .
	g£t_c⁄ãxt
 = 
pxt4_£t_c⁄ãxt
,

1374 .
	gdummy_c⁄ãxt
 = 
pxt4_dummy_c⁄ãxt
,

1375 .
	gem±y_dú
 = 
pxt4_em±y_dú
,

1376 .
	gmax_«mñí
 = 
PXT4_NAME_LEN
,

1377 .
	ghas_°abÀ_öodes
 = 
pxt4_has_°abÀ_öodes
,

1378 .
	ggë_öo_™d_lblk_bôs
 = 
pxt4_gë_öo_™d_lblk_bôs
,

1382 #ifde‡
CONFIG_QUOTA


1383 c⁄° * c⁄° 
	gquŸ©y≥s
[] = 
INITQFNAMES
;

1384 
	#QTYPE2NAME
(
t
Ë(
quŸ©y≥s
[t])

	)

1386 
pxt4_wrôe_dquŸ
(
dquŸ
 *dquot);

1387 
pxt4_acquúe_dquŸ
(
dquŸ
 *dquot);

1388 
pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot);

1389 
pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot);

1390 
pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
);

1391 
pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1392 c⁄° 
∑th
 *path);

1393 
pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
);

1394 
ssize_t
 
pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

1395 
size_t
 
Àn
, 
loff_t
 
off
);

1396 
ssize_t
 
pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

1397 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
);

1398 
pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1399 
Êags
);

1400 
pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
);

1402 
dquŸ
 **
	$pxt4_gë_dquŸs
(
öode
 *inode)

1404  
	`PXT4_I
(
öode
)->
i_dquŸ
;

1405 
	}
}

1407 c⁄° 
dquŸ_›î©i⁄s
 
	gpxt4_quŸa_›î©i⁄s
 = {

1408 .
gë_ª£rved_•a˚
 = 
pxt4_gë_ª£rved_•a˚
,

1409 .
	gwrôe_dquŸ
 = 
pxt4_wrôe_dquŸ
,

1410 .
	gacquúe_dquŸ
 = 
pxt4_acquúe_dquŸ
,

1411 .
	gªÀa£_dquŸ
 = 
pxt4_ªÀa£_dquŸ
,

1412 .
	gm¨k_dúty
 = 
pxt4_m¨k_dquŸ_dúty
,

1413 .
	gwrôe_öfo
 = 
pxt4_wrôe_öfo
,

1414 .
	gÆloc_dquŸ
 = 
dquŸ_Æloc
,

1415 .
	gde°roy_dquŸ
 = 
dquŸ_de°roy
,

1416 .
	ggë_¥ojid
 = 
pxt4_gë_¥ojid
,

1417 .
	ggë_öode_ußge
 = 
pxt4_gë_öode_ußge
,

1418 .
	ggë_√xt_id
 = 
dquŸ_gë_√xt_id
,

1421 c⁄° 
quŸa˘l_›s
 
	gpxt4_q˘l_›î©i⁄s
 = {

1422 .
quŸa_⁄
 = 
pxt4_quŸa_⁄
,

1423 .
	gquŸa_off
 = 
pxt4_quŸa_off
,

1424 .
	gquŸa_sync
 = 
dquŸ_quŸa_sync
,

1425 .
	ggë_°©e
 = 
dquŸ_gë_°©e
,

1426 .
	g£t_öfo
 = 
dquŸ_£t_dqöfo
,

1427 .
	ggë_dqblk
 = 
dquŸ_gë_dqblk
,

1428 .
	g£t_dqblk
 = 
dquŸ_£t_dqblk
,

1429 .
	ggë_√xtdqblk
 = 
dquŸ_gë_√xt_dqblk
,

1433 c⁄° 
su≥r_›î©i⁄s
 
	gpxt4_s›s
 = {

1434 .
Æloc_öode
 = 
pxt4_Æloc_öode
,

1435 .
	g‰ì_öode
 = 
pxt4_‰ì_ö_c‹e_öode
,

1436 .
	gde°roy_öode
 = 
pxt4_de°roy_öode
,

1437 .
	gwrôe_öode
 = 
pxt4_wrôe_öode
,

1438 .
	gdúty_öode
 = 
pxt4_dúty_öode
,

1439 .
	gdr›_öode
 = 
pxt4_dr›_öode
,

1440 .
	gevi˘_öode
 = 
pxt4_evi˘_öode
,

1441 .
	gput_su≥r
 = 
pxt4_put_su≥r
,

1442 .
	gsync_fs
 = 
pxt4_sync_fs
,

1443 .
	g‰ìze_fs
 = 
pxt4_‰ìze
,

1444 .
	gun‰ìze_fs
 = 
pxt4_un‰ìze
,

1445 .
	g°©fs
 = 
pxt4_°©fs
,

1446 .
	gªmou¡_fs
 = 
pxt4_ªmou¡
,

1447 .
	gshow_›ti⁄s
 = 
pxt4_show_›ti⁄s
,

1448 #ifde‡
CONFIG_QUOTA


1449 .
	gquŸa_ªad
 = 
pxt4_quŸa_ªad
,

1450 .
	gquŸa_wrôe
 = 
pxt4_quŸa_wrôe
,

1451 .
	ggë_dquŸs
 = 
pxt4_gë_dquŸs
,

1453 .
	gbdev_åy_to_‰ì_∑ge
 = 
bdev_åy_to_‰ì_∑ge
,

1456 c⁄° 
exp‹t_›î©i⁄s
 
	gpxt4_exp‹t_›s
 = {

1457 .
fh_to_díåy
 = 
pxt4_fh_to_díåy
,

1458 .
	gfh_to_∑ª¡
 = 
pxt4_fh_to_∑ª¡
,

1459 .
	ggë_∑ª¡
 = 
pxt4_gë_∑ª¡
,

1460 .
	gcommô_mëad©a
 = 
pxt4_nfs_commô_mëad©a
,

1464 
	mO±_bsd_df
, 
	mO±_möix_df
, 
	mO±_gΩid
, 
	mO±_nogΩid
,

1465 
	mO±_ªsgid
, 
	mO±_ªsuid
, 
	mO±_sb
, 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

1466 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_ªmoved
,

1467 
	mO±_u£r_x©å
, 
	mO±_nou£r_x©å
, 
	mO±_a˛
, 
	mO±_nﬂ˛
,

1468 
	mO±_auto_da_Æloc
, 
	mO±_nﬂuto_da_Æloc
, 
	mO±_nﬁﬂd
,

1469 
	mO±_commô
, 
	mO±_mö_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jou∫Æ_dev
,

1470 
	mO±_jou∫Æ_∑th
, 
	mO±_jou∫Æ_checksum
, 
	mO±_jou∫Æ_async_commô
,

1471 
	mO±_ab‹t
, 
	mO±_d©a_jou∫Æ
, 
	mO±_d©a_‹dîed
, 
	mO±_d©a_wrôeback
,

1472 
	mO±_d©a_îr_ab‹t
, 
	mO±_d©a_îr_ign‹e
, 
	mO±_ã°_dummy_í¸y±i⁄
,

1473 
	mO±_u§jquŸa
, 
	mO±_gΩjquŸa
, 
	mO±_offu§jquŸa
, 
	mO±_offgΩjquŸa
,

1474 
	mO±_jqfmt_vfsﬁd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quŸa
,

1475 
	mO±_noquŸa
, 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
, 
	mO±_îr
,

1476 
	mO±_u§quŸa
, 
	mO±_gΩquŸa
, 
	mO±_¥jquŸa
, 
	mO±_i_vîsi⁄
, 
	mO±_dax
,

1477 
	mO±_°rùe
, 
	mO±_dñÆloc
, 
	mO±_nodñÆloc
, 
	mO±_w¨n_⁄_îr‹
,

1478 
	mO±_now¨n_⁄_îr‹
, 
	mO±_mblk_io_submô
,

1479 
	mO±_œzytime
, 
	mO±_nﬁazytime
, 
	mO±_debug_w™t_exåa_isize
,

1480 
	mO±_nomblk_io_submô
, 
	mO±_block_vÆidôy
, 
	mO±_noblock_vÆidôy
,

1481 
	mO±_öode_ªadahód_blks
, 
	mO±_jou∫Æ_i›rio
,

1482 
	mO±_di‹ód_nﬁock
, 
	mO±_di‹ód_lock
,

1483 
	mO±_disˇrd
, 
	mO±_nodisˇrd
, 
	mO±_öô_ôabÀ
, 
	mO±_noöô_ôabÀ
,

1484 
	mO±_max_dú_size_kb
, 
	mO±_nojou∫Æ_checksum
, 
	mO±_nombˇche
,

1487 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

1488 {
O±_bsd_df
, "bsddf"},

1489 {
O±_möix_df
, "minixdf"},

1490 {
O±_gΩid
, "grpid"},

1491 {
O±_gΩid
, "bsdgroups"},

1492 {
O±_nogΩid
, "nogrpid"},

1493 {
O±_nogΩid
, "sysvgroups"},

1494 {
O±_ªsgid
, "resgid=%u"},

1495 {
O±_ªsuid
, "resuid=%u"},

1496 {
O±_sb
, "sb=%u"},

1497 {
O±_îr_c⁄t
, "errors=continue"},

1498 {
O±_îr_∑nic
, "errors=panic"},

1499 {
O±_îr_ro
, "errors=remount-ro"},

1500 {
O±_nouid32
, "nouid32"},

1501 {
O±_debug
, "debug"},

1502 {
O±_ªmoved
, "oldalloc"},

1503 {
O±_ªmoved
, "orlov"},

1504 {
O±_u£r_x©å
, "user_xattr"},

1505 {
O±_nou£r_x©å
, "nouser_xattr"},

1506 {
O±_a˛
, "acl"},

1507 {
O±_nﬂ˛
, "noacl"},

1508 {
O±_nﬁﬂd
, "norecovery"},

1509 {
O±_nﬁﬂd
, "noload"},

1510 {
O±_ªmoved
, "nobh"},

1511 {
O±_ªmoved
, "bh"},

1512 {
O±_commô
, "commit=%u"},

1513 {
O±_mö_b©ch_time
, "min_batch_time=%u"},

1514 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1515 {
O±_jou∫Æ_dev
, "journal_dev=%u"},

1516 {
O±_jou∫Æ_∑th
, "journal_path=%s"},

1517 {
O±_jou∫Æ_checksum
, "journal_checksum"},

1518 {
O±_nojou∫Æ_checksum
, "nojournal_checksum"},

1519 {
O±_jou∫Æ_async_commô
, "journal_async_commit"},

1520 {
O±_ab‹t
, "abort"},

1521 {
O±_d©a_jou∫Æ
, "data=journal"},

1522 {
O±_d©a_‹dîed
, "data=ordered"},

1523 {
O±_d©a_wrôeback
, "data=writeback"},

1524 {
O±_d©a_îr_ab‹t
, "data_err=abort"},

1525 {
O±_d©a_îr_ign‹e
, "data_err=ignore"},

1526 {
O±_offu§jquŸa
, "usrjquota="},

1527 {
O±_u§jquŸa
, "usrjquota=%s"},

1528 {
O±_offgΩjquŸa
, "grpjquota="},

1529 {
O±_gΩjquŸa
, "grpjquota=%s"},

1530 {
O±_jqfmt_vfsﬁd
, "jqfmt=vfsold"},

1531 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1532 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1533 {
O±_gΩquŸa
, "grpquota"},

1534 {
O±_noquŸa
, "noquota"},

1535 {
O±_quŸa
, "quota"},

1536 {
O±_u§quŸa
, "usrquota"},

1537 {
O±_¥jquŸa
, "prjquota"},

1538 {
O±_b¨rõr
, "barrier=%u"},

1539 {
O±_b¨rõr
, "barrier"},

1540 {
O±_nob¨rõr
, "nobarrier"},

1541 {
O±_i_vîsi⁄
, "i_version"},

1542 {
O±_dax
, "dax"},

1543 {
O±_°rùe
, "stripe=%u"},

1544 {
O±_dñÆloc
, "delalloc"},

1545 {
O±_w¨n_⁄_îr‹
, "warn_on_error"},

1546 {
O±_now¨n_⁄_îr‹
, "nowarn_on_error"},

1547 {
O±_œzytime
, "lazytime"},

1548 {
O±_nﬁazytime
, "nolazytime"},

1549 {
O±_debug_w™t_exåa_isize
, "debug_want_extra_isize=%u"},

1550 {
O±_nodñÆloc
, "nodelalloc"},

1551 {
O±_ªmoved
, "mblk_io_submit"},

1552 {
O±_ªmoved
, "nomblk_io_submit"},

1553 {
O±_block_vÆidôy
, "block_validity"},

1554 {
O±_noblock_vÆidôy
, "noblock_validity"},

1555 {
O±_öode_ªadahód_blks
, "inode_readahead_blks=%u"},

1556 {
O±_jou∫Æ_i›rio
, "journal_ioprio=%u"},

1557 {
O±_auto_da_Æloc
, "auto_da_alloc=%u"},

1558 {
O±_auto_da_Æloc
, "auto_da_alloc"},

1559 {
O±_nﬂuto_da_Æloc
, "noauto_da_alloc"},

1560 {
O±_di‹ód_nﬁock
, "dioread_nolock"},

1561 {
O±_di‹ód_lock
, "dioread_lock"},

1562 {
O±_disˇrd
, "discard"},

1563 {
O±_nodisˇrd
, "nodiscard"},

1564 {
O±_öô_ôabÀ
, "init_itable=%u"},

1565 {
O±_öô_ôabÀ
, "init_itable"},

1566 {
O±_noöô_ôabÀ
, "noinit_itable"},

1567 {
O±_max_dú_size_kb
, "max_dir_size_kb=%u"},

1568 {
O±_ã°_dummy_í¸y±i⁄
, "test_dummy_encryption"},

1569 {
O±_nombˇche
, "nombcache"},

1570 {
O±_nombˇche
, "no_mbcache"},

1571 {
O±_ªmoved
, "check=none"},

1572 {
O±_ªmoved
, "nocheck"},

1573 {
O±_ªmoved
, "reservation"},

1574 {
O±_ªmoved
, "noreservation"},

1575 {
O±_ªmoved
, "journal=%u"},

1576 {
O±_îr
, 
NULL
},

1579 
pxt4_fsblk_t
 
	$gë_sb_block
(**
d©a
)

1581 
pxt4_fsblk_t
 
sb_block
;

1582 *
›ti⁄s
 = (*Ë*
d©a
;

1584 i‡(!
›ti⁄s
 || 
	`°∫cmp
(options, "sb=", 3) != 0)

1587 
›ti⁄s
 += 3;

1589 
sb_block
 = 
	`sim∂e_°πoul
(
›ti⁄s
, &options, 0);

1590 i‡(*
›ti⁄s
 && *options != ',') {

1591 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: Invalid sb specification: %s\n",

1592 (*Ë*
d©a
);

1595 i‡(*
›ti⁄s
 == ',')

1596 
›ti⁄s
++;

1597 *
d©a
 = (*Ë
›ti⁄s
;

1599  
sb_block
;

1600 
	}
}

1602 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1603 c⁄° 
	gdïªˇãd_msg
[] =

1607 #ifde‡
CONFIG_QUOTA


1608 
	$£t_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
, 
sub°rög_t
 *
¨gs
)

1610 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1611 *
q«me
, *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1612 
ªt
 = -1;

1614 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& !
ﬁd_q«me
) {

1615 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1620 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1621 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1625 
q«me
 = 
	`m©ch_°rdup
(
¨gs
);

1626 i‡(!
q«me
) {

1627 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1631 i‡(
ﬁd_q«me
) {

1632 i‡(
	`°rcmp
(
ﬁd_q«me
, 
q«me
) == 0)

1633 
ªt
 = 1;

1635 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1637 
	`QTYPE2NAME
(
qty≥
));

1638 
îrout
;

1640 i‡(
	`°rchr
(
q«me
, '/')) {

1641 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1643 
îrout
;

1645 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
q«me
);

1646 
	`£t_›t
(
sb
, 
QUOTA
);

1648 
îrout
:

1649 
	`k‰ì
(
q«me
);

1650  
ªt
;

1651 
	}
}

1653 
	$˛ór_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
)

1656 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1657 *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1659 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& 
ﬁd_q«me
) {

1660 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1664 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
NULL
);

1665 
	`synchr⁄ize_rcu
();

1666 
	`k‰ì
(
ﬁd_q«me
);

1668 
	}
}

1671 
	#MOPT_SET
 0x0001

	)

1672 
	#MOPT_CLEAR
 0x0002

	)

1673 
	#MOPT_NOSUPPORT
 0x0004

	)

1674 
	#MOPT_EXPLICIT
 0x0008

	)

1675 
	#MOPT_CLEAR_ERR
 0x0010

	)

1676 
	#MOPT_GTE0
 0x0020

	)

1677 #ifde‡
CONFIG_QUOTA


1678 
	#MOPT_Q
 0

	)

1679 
	#MOPT_QFMT
 0x0040

	)

1681 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1682 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1684 
	#MOPT_DATAJ
 0x0080

	)

1685 
	#MOPT_NO_PXT2
 0x0100

	)

1686 
	#MOPT_NO_EXT3
 0x0200

	)

1687 
	#MOPT_PXT4_ONLY
 (
MOPT_NO_PXT2
 | 
MOPT_NO_EXT3
)

	)

1688 
	#MOPT_STRING
 0x0400

	)

1690 c⁄° 
	smou¡_›ts
 {

1691 
	mtokí
;

1692 
	mmou¡_›t
;

1693 
	mÊags
;

1694 } 
	gpxt4_mou¡_›ts
[] = {

1695 {
O±_möix_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1696 {
O±_bsd_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1697 {
O±_gΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_SET
},

1698 {
O±_nogΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1699 {
O±_block_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1700 {
O±_noblock_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1701 {
O±_di‹ód_nﬁock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1702 
MOPT_PXT4_ONLY
 | 
MOPT_SET
},

1703 {
O±_di‹ód_lock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1704 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1705 {
O±_disˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1706 {
O±_nodisˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1707 {
O±_dñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1708 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1709 {
O±_nodñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1710 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1711 {
O±_w¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1712 {
O±_now¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1713 {
O±_nojou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1714 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1715 {
O±_jou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1716 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1717 {
O±_jou∫Æ_async_commô
, (
PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1718 
PXT4_MOUNT_JOURNAL_CHECKSUM
),

1719 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1720 {
O±_nﬁﬂd
, 
PXT4_MOUNT_NOLOAD
, 
MOPT_NO_PXT2
 | 
MOPT_SET
},

1721 {
O±_îr_∑nic
, 
PXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1722 {
O±_îr_ro
, 
PXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1723 {
O±_îr_c⁄t
, 
PXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1724 {
O±_d©a_îr_ab‹t
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1725 
MOPT_NO_PXT2
},

1726 {
O±_d©a_îr_ign‹e
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1727 
MOPT_NO_PXT2
},

1728 {
O±_b¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1729 {
O±_nob¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1730 {
O±_nﬂuto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1731 {
O±_auto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1732 {
O±_noöô_ôabÀ
, 
PXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1733 {
O±_commô
, 0, 
MOPT_GTE0
},

1734 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1735 {
O±_mö_b©ch_time
, 0, 
MOPT_GTE0
},

1736 {
O±_öode_ªadahód_blks
, 0, 
MOPT_GTE0
},

1737 {
O±_öô_ôabÀ
, 0, 
MOPT_GTE0
},

1738 {
O±_dax
, 
PXT4_MOUNT_DAX
, 
MOPT_SET
},

1739 {
O±_°rùe
, 0, 
MOPT_GTE0
},

1740 {
O±_ªsuid
, 0, 
MOPT_GTE0
},

1741 {
O±_ªsgid
, 0, 
MOPT_GTE0
},

1742 {
O±_jou∫Æ_dev
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1743 {
O±_jou∫Æ_∑th
, 0, 
MOPT_NO_PXT2
 | 
MOPT_STRING
},

1744 {
O±_jou∫Æ_i›rio
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1745 {
O±_d©a_jou∫Æ
, 
PXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1746 {
O±_d©a_‹dîed
, 
PXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1747 {
O±_d©a_wrôeback
, 
PXT4_MOUNT_WRITEBACK_DATA
,

1748 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1749 {
O±_u£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1750 {
O±_nou£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1751 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


1752 {
O±_a˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1753 {
O±_nﬂ˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1755 {
O±_a˛
, 0, 
MOPT_NOSUPPORT
},

1756 {
O±_nﬂ˛
, 0, 
MOPT_NOSUPPORT
},

1758 {
O±_nouid32
, 
PXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1759 {
O±_debug
, 
PXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1760 {
O±_debug_w™t_exåa_isize
, 0, 
MOPT_GTE0
},

1761 {
O±_quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1762 {
O±_u§quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
,

1763 
MOPT_SET
 | 
MOPT_Q
},

1764 {
O±_gΩquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_GRPQUOTA
,

1765 
MOPT_SET
 | 
MOPT_Q
},

1766 {
O±_¥jquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_PRJQUOTA
,

1767 
MOPT_SET
 | 
MOPT_Q
},

1768 {
O±_noquŸa
, (
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
 |

1769 
PXT4_MOUNT_GRPQUOTA
 | 
PXT4_MOUNT_PRJQUOTA
),

1770 
MOPT_CLEAR
 | 
MOPT_Q
},

1771 {
O±_u§jquŸa
, 0, 
MOPT_Q
},

1772 {
O±_gΩjquŸa
, 0, 
MOPT_Q
},

1773 {
O±_offu§jquŸa
, 0, 
MOPT_Q
},

1774 {
O±_offgΩjquŸa
, 0, 
MOPT_Q
},

1775 {
O±_jqfmt_vfsﬁd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1776 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1777 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1778 {
O±_max_dú_size_kb
, 0, 
MOPT_GTE0
},

1779 {
O±_ã°_dummy_í¸y±i⁄
, 0, 
MOPT_GTE0
},

1780 {
O±_nombˇche
, 
PXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1781 {
O±_îr
, 0, 0}

1784 #ifde‡
CONFIG_UNICODE


1785 c⁄° 
	spxt4_sb_ícodögs
 {

1786 
__u16
 
	mmagic
;

1787 *
	m«me
;

1788 *
	mvîsi⁄
;

1789 } 
	gpxt4_sb_ícodög_m≠
[] = {

1790 {
PXT4_ENC_UTF8_12_1
, "utf8", "12.1.0"},

1793 
	$pxt4_sb_ªad_ícodög
(c⁄° 
pxt4_su≥r_block
 *
es
,

1794 c⁄° 
pxt4_sb_ícodögs
 **
ícodög
,

1795 
__u16
 *
Êags
)

1797 
__u16
 
magic
 = 
	`À16_to_˝u
(
es
->
s_ícodög
);

1798 
i
;

1800 
i
 = 0; i < 
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
); i++)

1801 i‡(
magic
 =
pxt4_sb_ícodög_m≠
[
i
].magic)

1804 i‡(
i
 >
	`ARRAY_SIZE
(
pxt4_sb_ícodög_m≠
))

1805  -
EINVAL
;

1807 *
ícodög
 = &
pxt4_sb_ícodög_m≠
[
i
];

1808 *
Êags
 = 
	`À16_to_˝u
(
es
->
s_ícodög_Êags
);

1811 
	}
}

1814 
	$h™dÀ_mou¡_›t
(
su≥r_block
 *
sb
, *
›t
, 
tokí
,

1815 
sub°rög_t
 *
¨gs
, *
jou∫Æ_devnum
,

1816 *
jou∫Æ_i›rio
, 
is_ªmou¡
)

1818 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1819 c⁄° 
mou¡_›ts
 *
m
;

1820 
kuid_t
 
uid
;

1821 
kgid_t
 
gid
;

1822 
¨g
 = 0;

1824 #ifde‡
CONFIG_QUOTA


1825 i‡(
tokí
 =
O±_u§jquŸa
)

1826  
	`£t_qf_«me
(
sb
, 
USRQUOTA
, &
¨gs
[0]);

1827 i‡(
tokí
 =
O±_gΩjquŸa
)

1828  
	`£t_qf_«me
(
sb
, 
GRPQUOTA
, &
¨gs
[0]);

1829 i‡(
tokí
 =
O±_offu§jquŸa
)

1830  
	`˛ór_qf_«me
(
sb
, 
USRQUOTA
);

1831 i‡(
tokí
 =
O±_offgΩjquŸa
)

1832  
	`˛ór_qf_«me
(
sb
, 
GRPQUOTA
);

1834 
tokí
) {

1835 
O±_nﬂ˛
:

1836 
O±_nou£r_x©å
:

1837 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, 
dïªˇãd_msg
, 
›t
, "3.5");

1839 
O±_sb
:

1841 
O±_ªmoved
:

1842 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Ign‹ögÑemoved %†›ti⁄", 
›t
);

1844 
O±_ab‹t
:

1845 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

1847 
O±_i_vîsi⁄
:

1848 
sb
->
s_Êags
 |
SB_I_VERSION
;

1850 
O±_œzytime
:

1851 
sb
->
s_Êags
 |
SB_LAZYTIME
;

1853 
O±_nﬁazytime
:

1854 
sb
->
s_Êags
 &~
SB_LAZYTIME
;

1858 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++)

1859 i‡(
tokí
 =
m
->token)

1862 i‡(
m
->
tokí
 =
O±_îr
) {

1863 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1864 "‹ missög vÆue", 
›t
);

1868 i‡((
m
->
Êags
 & 
MOPT_NO_PXT2
Ë&& 
	`IS_PXT2_SB
(
sb
)) {

1869 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1870 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÖxt2", 
›t
);

1873 i‡((
m
->
Êags
 & 
MOPT_NO_EXT3
Ë&& 
	`IS_EXT3_SB
(
sb
)) {

1874 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1875 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÉxt3", 
›t
);

1879 i‡(
¨gs
->
‰om
 && !(
m
->
Êags
 & 
MOPT_STRING
Ë&& 
	`m©ch_öt
◊rgs, &
¨g
))

1881 i‡(
¨gs
->
‰om
 && (
m
->
Êags
 & 
MOPT_GTE0
Ë&& (
¨g
 < 0))

1883 i‡(
m
->
Êags
 & 
MOPT_EXPLICIT
) {

1884 i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_DELALLOC
) {

1885 
	`£t_›t2
(
sb
, 
EXPLICIT_DELALLOC
);

1886 } i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) {

1887 
	`£t_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1891 i‡(
m
->
Êags
 & 
MOPT_CLEAR_ERR
)

1892 
	`˛ór_›t
(
sb
, 
ERRORS_MASK
);

1893 i‡(
tokí
 =
O±_noquŸa
 && 
	`sb_™y_quŸa_lﬂded
(
sb
)) {

1894 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1899 i‡(
m
->
Êags
 & 
MOPT_NOSUPPORT
) {

1900 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%†›ti⁄ÇŸ suµ‹ãd", 
›t
);

1901 } i‡(
tokí
 =
O±_commô
) {

1902 i‡(
¨g
 == 0)

1903 
¨g
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
;

1904 i‡(
¨g
 > 
INT_MAX
 / 
HZ
) {

1905 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1908 
¨g
, 
INT_MAX
 / 
HZ
);

1911 
sbi
->
s_commô_öãrvÆ
 = 
HZ
 * 
¨g
;

1912 } i‡(
tokí
 =
O±_debug_w™t_exåa_isize
) {

1913 i‡((
¨g
 & 1) ||

1914 (
¨g
 < 4) ||

1915 (
¨g
 > (
sbi
->
s_öode_size
 - 
PXT4_GOOD_OLD_INODE_SIZE
))) {

1916 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1917 "InvÆid w™t_exåa_isizê%d", 
¨g
);

1920 
sbi
->
s_w™t_exåa_isize
 = 
¨g
;

1921 } i‡(
tokí
 =
O±_max_b©ch_time
) {

1922 
sbi
->
s_max_b©ch_time
 = 
¨g
;

1923 } i‡(
tokí
 =
O±_mö_b©ch_time
) {

1924 
sbi
->
s_mö_b©ch_time
 = 
¨g
;

1925 } i‡(
tokí
 =
O±_öode_ªadahód_blks
) {

1926 i‡(
¨g
 && (¨g > (1 << 30Ë|| !
	`is_powî_of_2
(arg))) {

1927 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1932 
sbi
->
s_öode_ªadahód_blks
 = 
¨g
;

1933 } i‡(
tokí
 =
O±_öô_ôabÀ
) {

1934 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

1935 i‡(!
¨gs
->
‰om
)

1936 
¨g
 = 
PXT4_DEF_LI_WAIT_MULT
;

1937 
sbi
->
s_li_waô_mu…
 = 
¨g
;

1938 } i‡(
tokí
 =
O±_max_dú_size_kb
) {

1939 
sbi
->
s_max_dú_size_kb
 = 
¨g
;

1940 } i‡(
tokí
 =
O±_°rùe
) {

1941 
sbi
->
s_°rùe
 = 
¨g
;

1942 } i‡(
tokí
 =
O±_ªsuid
) {

1943 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
¨g
);

1944 i‡(!
	`uid_vÆid
(
uid
)) {

1945 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid uid vÆuê%d", 
¨g
);

1948 
sbi
->
s_ªsuid
 = 
uid
;

1949 } i‡(
tokí
 =
O±_ªsgid
) {

1950 
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
¨g
);

1951 i‡(!
	`gid_vÆid
(
gid
)) {

1952 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid gid vÆuê%d", 
¨g
);

1955 
sbi
->
s_ªsgid
 = 
gid
;

1956 } i‡(
tokí
 =
O±_jou∫Æ_dev
) {

1957 i‡(
is_ªmou¡
) {

1958 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1962 *
jou∫Æ_devnum
 = 
¨g
;

1963 } i‡(
tokí
 =
O±_jou∫Æ_∑th
) {

1964 *
jou∫Æ_∑th
;

1965 
öode
 *
jou∫Æ_öode
;

1966 
∑th
Öath;

1967 
îr‹
;

1969 i‡(
is_ªmou¡
) {

1970 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1974 
jou∫Æ_∑th
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1975 i‡(!
jou∫Æ_∑th
) {

1976 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot dup "

1981 
îr‹
 = 
	`kîn_∑th
(
jou∫Æ_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

1982 i‡(
îr‹
) {

1983 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot find "

1984 "jou∫Æ devi˚Ö©h:Éº‹ %d", 
îr‹
);

1985 
	`k‰ì
(
jou∫Æ_∑th
);

1989 
jou∫Æ_öode
 = 
	`d_öode
(
∑th
.
díåy
);

1990 i‡(!
	`S_ISBLK
(
jou∫Æ_öode
->
i_mode
)) {

1991 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: journalÖath %s "

1992 "i†nŸá block devi˚", 
jou∫Æ_∑th
);

1993 
	`∑th_put
(&
∑th
);

1994 
	`k‰ì
(
jou∫Æ_∑th
);

1998 *
jou∫Æ_devnum
 = 
	`√w_ícode_dev
(
jou∫Æ_öode
->
i_rdev
);

1999 
	`∑th_put
(&
∑th
);

2000 
	`k‰ì
(
jou∫Æ_∑th
);

2001 } i‡(
tokí
 =
O±_jou∫Æ_i›rio
) {

2002 i‡(
¨g
 > 7) {

2003 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IOÖriority"

2007 *
jou∫Æ_i›rio
 =

2008 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¨g
);

2009 } i‡(
tokí
 =
O±_ã°_dummy_í¸y±i⁄
) {

2010 #ifde‡
CONFIG_FS_ENCRYPTION


2011 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_TEST_DUMMY_ENCRYPTION
;

2012 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2015 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2018 } i‡(
m
->
Êags
 & 
MOPT_DATAJ
) {

2019 i‡(
is_ªmou¡
) {

2020 i‡(!
sbi
->
s_jou∫Æ
)

2021 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system withÇo journal so ignoring journalled data option");

2022 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë!
m
->
mou¡_›t
) {

2023 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2028 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

2029 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2031 #ifde‡
CONFIG_QUOTA


2032 } i‡(
m
->
Êags
 & 
MOPT_QFMT
) {

2033 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
) &&

2034 
sbi
->
s_jquŸa_fmt
 !
m
->
mou¡_›t
) {

2035 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

2039 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

2040 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2045 
sbi
->
s_jquŸa_fmt
 = 
m
->
mou¡_›t
;

2047 } i‡(
tokí
 =
O±_dax
) {

2048 #ifde‡
CONFIG_FS_DAX


2049 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2051 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2053 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "dax optionÇot supported");

2056 } i‡(
tokí
 =
O±_d©a_îr_ab‹t
) {

2057 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2058 } i‡(
tokí
 =
O±_d©a_îr_ign‹e
) {

2059 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2061 i‡(!
¨gs
->
‰om
)

2062 
¨g
 = 1;

2063 i‡(
m
->
Êags
 & 
MOPT_CLEAR
)

2064 
¨g
 = !arg;

2065 i‡(
	`u∆ikñy
(!(
m
->
Êags
 & 
MOPT_SET
))) {

2066 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2067 "buggy h™dlög o‡›ti⁄ %s", 
›t
);

2068 
	`WARN_ON
(1);

2071 i‡(
¨g
 != 0)

2072 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

2074 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2077 
	}
}

2079 
	$∑r£_›ti⁄s
(*
›ti⁄s
, 
su≥r_block
 *
sb
,

2080 *
jou∫Æ_devnum
,

2081 *
jou∫Æ_i›rio
,

2082 
is_ªmou¡
)

2084 
pxt4_sb_öfo
 
__maybe_unu£d
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2085 *
p
, 
__maybe_unu£d
 *
u§_qf_«me
, __maybe_unu£d *
gΩ_qf_«me
;

2086 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

2087 
tokí
;

2089 i‡(!
›ti⁄s
)

2092 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

2093 i‡(!*
p
)

2099 
¨gs
[0].
to
 =árgs[0].
‰om
 = 
NULL
;

2100 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

2101 i‡(
	`h™dÀ_mou¡_›t
(
sb
, 
p
, 
tokí
, 
¨gs
, 
jou∫Æ_devnum
,

2102 
jou∫Æ_i›rio
, 
is_ªmou¡
) < 0)

2105 #ifde‡
CONFIG_QUOTA


2111 i‡(
	`ã°_›t
(
sb
, 
PRJQUOTA
Ë&& !
	`pxt4_has_„©uª_¥oje˘
(sb)) {

2112 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Project quota featureÇotÉnabled. "

2116 
u§_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
USRQUOTA
);

2117 
gΩ_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
GRPQUOTA
);

2118 i‡(
u§_qf_«me
 || 
gΩ_qf_«me
) {

2119 i‡(
	`ã°_›t
(
sb
, 
USRQUOTA
Ë&& 
u§_qf_«me
)

2120 
	`˛ór_›t
(
sb
, 
USRQUOTA
);

2122 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë&& 
gΩ_qf_«me
)

2123 
	`˛ór_›t
(
sb
, 
GRPQUOTA
);

2125 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë||Åe°_›t(sb, 
USRQUOTA
)) {

2126 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "oldándÇew quota "

2131 i‡(!
sbi
->
s_jquŸa_fmt
) {

2132 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2139 
	}
}

2141 
ölöe
 
	$pxt4_show_quŸa_›ti⁄s
(
£q_fûe
 *
£q
,

2142 
su≥r_block
 *
sb
)

2144 #i‡
	`deföed
(
CONFIG_QUOTA
)

2145 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2146 *
u§_qf_«me
, *
gΩ_qf_«me
;

2148 i‡(
sbi
->
s_jquŸa_fmt
) {

2149 *
fmäame
 = "";

2151 
sbi
->
s_jquŸa_fmt
) {

2152 
QFMT_VFS_OLD
:

2153 
fmäame
 = "vfsold";

2155 
QFMT_VFS_V0
:

2156 
fmäame
 = "vfsv0";

2158 
QFMT_VFS_V1
:

2159 
fmäame
 = "vfsv1";

2162 
	`£q_¥ötf
(
£q
, ",jqfmt=%s", 
fmäame
);

2165 
	`rcu_ªad_lock
();

2166 
u§_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
USRQUOTA
]);

2167 
gΩ_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
GRPQUOTA
]);

2168 i‡(
u§_qf_«me
)

2169 
	`£q_show_›ti⁄
(
£q
, "u§jquŸa", 
u§_qf_«me
);

2170 i‡(
gΩ_qf_«me
)

2171 
	`£q_show_›ti⁄
(
£q
, "gΩjquŸa", 
gΩ_qf_«me
);

2172 
	`rcu_ªad_u∆ock
();

2174 
	}
}

2176 c⁄° *
	$tokí2°r
(
tokí
)

2178 c⁄° 
m©ch_tokí
 *
t
;

2180 
t
 = 
tokís
;Å->
tokí
 !
O±_îr
;Å++)

2181 i‡(
t
->
tokí
 =tokí && !
	`°rchr
—->
∑âîn
, '='))

2183  
t
->
∑âîn
;

2184 
	}
}

2191 
	$_pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
su≥r_block
 *
sb
,

2192 
nodefs
)

2194 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2195 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2196 
def_îr‹s
, 
def_mou¡_›t
 = 
sbi
->
s_def_mou¡_›t
;

2197 c⁄° 
mou¡_›ts
 *
m
;

2198 
£p
 = 
nodefs
 ? '\n' : ',';

2200 
	#SEQ_OPTS_PUTS
(
°r
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
)

	)

2201 
	#SEQ_OPTS_PRINT
(
°r
, 
¨g
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
,árg)

	)

2203 i‡(
sbi
->
s_sb_block
 != 1)

2204 
	`SEQ_OPTS_PRINT
("sb=%Œu", 
sbi
->
s_sb_block
);

2206 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++) {

2207 
w™t_£t
 = 
m
->
Êags
 & 
MOPT_SET
;

2208 i‡(((
m
->
Êags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2209 (
m
->
Êags
 & 
MOPT_CLEAR_ERR
))

2211 i‡(!
nodefs
 && !(
m
->
mou¡_›t
 & (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)))

2213 i‡((
w™t_£t
 &&

2214 (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
) != m->mount_opt) ||

2215 (!
w™t_£t
 && (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
)))

2217 
	`SEQ_OPTS_PRINT
("%s", 
	`tokí2°r
(
m
->
tokí
));

2220 i‡(
nodefs
 || !
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`make_kuid
(&
öô_u£r_ns
, 
PXT4_DEF_RESUID
)) ||

2221 
	`À16_to_˝u
(
es
->
s_def_ªsuid
Ë!
PXT4_DEF_RESUID
)

2222 
	`SEQ_OPTS_PRINT
("resuid=%u",

2223 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsuid
));

2224 i‡(
nodefs
 || !
	`gid_eq
(
sbi
->
s_ªsgid
, 
	`make_kgid
(&
öô_u£r_ns
, 
PXT4_DEF_RESGID
)) ||

2225 
	`À16_to_˝u
(
es
->
s_def_ªsgid
Ë!
PXT4_DEF_RESGID
)

2226 
	`SEQ_OPTS_PRINT
("resgid=%u",

2227 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsgid
));

2228 
def_îr‹s
 = 
nodefs
 ? -1 : 
	`À16_to_˝u
(
es
->
s_îr‹s
);

2229 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_RO
)

2230 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2231 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_CONTINUE
)

2232 
	`SEQ_OPTS_PUTS
("errors=continue");

2233 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_PANIC
)

2234 
	`SEQ_OPTS_PUTS
("errors=panic");

2235 i‡(
nodefs
 || 
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2236 
	`SEQ_OPTS_PRINT
("commô=%lu", 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

2237 i‡(
nodefs
 || 
sbi
->
s_mö_b©ch_time
 !
PXT4_DEF_MIN_BATCH_TIME
)

2238 
	`SEQ_OPTS_PRINT
("mö_b©ch_time=%u", 
sbi
->
s_mö_b©ch_time
);

2239 i‡(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !
PXT4_DEF_MAX_BATCH_TIME
)

2240 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2241 i‡(
sb
->
s_Êags
 & 
SB_I_VERSION
)

2242 
	`SEQ_OPTS_PUTS
("i_version");

2243 i‡(
nodefs
 || 
sbi
->
s_°rùe
)

2244 
	`SEQ_OPTS_PRINT
("°rùe=%lu", 
sbi
->
s_°rùe
);

2245 i‡(
nodefs
 || 
PXT4_MOUNT_DATA_FLAGS
 &

2246 (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)) {

2247 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

2248 
	`SEQ_OPTS_PUTS
("data=journal");

2249 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

2250 
	`SEQ_OPTS_PUTS
("data=ordered");

2251 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

2252 
	`SEQ_OPTS_PUTS
("data=writeback");

2254 i‡(
nodefs
 ||

2255 
sbi
->
s_öode_ªadahód_blks
 !
PXT4_DEF_INODE_READAHEAD_BLKS
)

2256 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2257 
sbi
->
s_öode_ªadahód_blks
);

2259 i‡(
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
Ë&& (
nodefs
 ||

2260 (
sbi
->
s_li_waô_mu…
 !
PXT4_DEF_LI_WAIT_MULT
)))

2261 
	`SEQ_OPTS_PRINT
("öô_ôabÀ=%u", 
sbi
->
s_li_waô_mu…
);

2262 i‡(
nodefs
 || 
sbi
->
s_max_dú_size_kb
)

2263 
	`SEQ_OPTS_PRINT
("max_dú_size_kb=%u", 
sbi
->
s_max_dú_size_kb
);

2264 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

2265 
	`SEQ_OPTS_PUTS
("data_err=abort");

2266 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2267 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2269 
	`pxt4_show_quŸa_›ti⁄s
(
£q
, 
sb
);

2271 
	}
}

2273 
	$pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

2275  
	`_pxt4_show_›ti⁄s
(
£q
, 
roŸ
->
d_sb
, 0);

2276 
	}
}

2278 
	$pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
)

2280 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

2281 
rc
;

2283 
	`£q_puts
(
£q
, 
	`sb_rd⁄ly
(
sb
) ? "ro" : "rw");

2284 
rc
 = 
	`_pxt4_show_›ti⁄s
(
£q
, 
sb
, 1);

2285 
	`£q_puts
(
£q
, "\n");

2286  
rc
;

2287 
	}
}

2289 
	$pxt4_£tup_su≥r
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

2290 
ªad_⁄ly
)

2292 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2293 
îr
 = 0;

2295 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_MAX_SUPP_REV
) {

2296 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "revisionÜevelÅoo high, "

2298 
îr
 = -
EROFS
;

2300 i‡(
ªad_⁄ly
)

2301 
d⁄e
;

2302 i‡(!(
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

2303 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2305 i‡(
sbi
->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
)

2306 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2309 i‡((
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
) > 0 &&

2310 
	`À16_to_˝u
(
es
->
s_m¡_cou¡
) >=

2311 (Ë(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2312 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2315 i‡(
	`À32_to_˝u
(
es
->
s_checköãrvÆ
) &&

2316 (
	`pxt4_gë_t°amp
(
es
, 
s_œ°check
) +

2317 
	`À32_to_˝u
(
es
->
s_checköãrvÆ
Ë<
	`ktime_gë_ªÆ_£c⁄ds
()))

2318 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2321 i‡(!
sbi
->
s_jou∫Æ
)

2322 
es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

2323 i‡(!(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2324 
es
->
s_max_m¡_cou¡
 = 
	`˝u_to_À16
(
PXT4_DFL_MAX_MNT_COUNT
);

2325 
	`À16_add_˝u
(&
es
->
s_m¡_cou¡
, 1);

2326 
	`pxt4_upd©e_t°amp
(
es
, 
s_mtime
);

2327 i‡(
sbi
->
s_jou∫Æ
)

2328 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

2330 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

2331 
d⁄e
:

2332 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2333 
	`¥ötk
(
KERN_INFO
 "[PXT4 FS bs=%lu, gc=%u, "

2335 
sb
->
s_blocksize
,

2336 
sbi
->
s_groups_cou¡
,

2337 
	`PXT4_BLOCKS_PER_GROUP
(
sb
),

2338 
	`PXT4_INODES_PER_GROUP
(
sb
),

2339 
sbi
->
s_mou¡_›t
, sbi->
s_mou¡_›t2
);

2341 
	`˛ónˇche_öô_fs
(
sb
);

2342  
îr
;

2343 
	}
}

2345 
	$pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroup
)

2347 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2348 
Êex_groups
 **
ﬁd_groups
, **
√w_groups
;

2349 
size
, 
i
, 
j
;

2351 i‡(!
sbi
->
s_log_groups_≥r_Êex
)

2354 
size
 = 
	`pxt4_Êex_group
(
sbi
, 
ngroup
 - 1) + 1;

2355 i‡(
size
 <
sbi
->
s_Êex_groups_Æloˇãd
)

2358 
√w_groups
 = 
	`kvzÆloc
(
	`roundup_pow_of_two
(
size
 *

2359 (*
sbi
->
s_Êex_groups
)), 
GFP_KERNEL
);

2360 i‡(!
√w_groups
) {

2361 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2362 "nŸÉnough mem‹y f‹ %d fÀx grou∞poöãrs", 
size
);

2363  -
ENOMEM
;

2365 
i
 = 
sbi
->
s_Êex_groups_Æloˇãd
; i < 
size
; i++) {

2366 
√w_groups
[
i
] = 
	`kvzÆloc
(
	`roundup_pow_of_two
(

2367 (
Êex_groups
)),

2368 
GFP_KERNEL
);

2369 i‡(!
√w_groups
[
i
]) {

2370 
j
 = 
sbi
->
s_Êex_groups_Æloˇãd
; j < 
i
; j++)

2371 
	`kv‰ì
(
√w_groups
[
j
]);

2372 
	`kv‰ì
(
√w_groups
);

2373 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2374 "nŸÉnough mem‹y f‹ %d fÀx groups", 
size
);

2375  -
ENOMEM
;

2378 
	`rcu_ªad_lock
();

2379 
ﬁd_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

2380 i‡(
ﬁd_groups
)

2381 
	`mem˝y
(
√w_groups
, 
ﬁd_groups
,

2382 (
sbi
->
s_Êex_groups_Æloˇãd
 *

2383 (
Êex_groups
 *)));

2384 
	`rcu_ªad_u∆ock
();

2385 
	`rcu_assign_poöãr
(
sbi
->
s_Êex_groups
, 
√w_groups
);

2386 
sbi
->
s_Êex_groups_Æloˇãd
 = 
size
;

2387 i‡(
ﬁd_groups
)

2388 
	`pxt4_kv‰ì_¨øy_rcu
(
ﬁd_groups
);

2390 
	}
}

2392 
	$pxt4_fûl_Êex_öfo
(
su≥r_block
 *
sb
)

2394 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2395 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2396 
Êex_groups
 *
fg
;

2397 
pxt4_group_t
 
Êex_group
;

2398 
i
, 
îr
;

2400 
sbi
->
s_log_groups_≥r_Êex
 = sbi->
s_es
->s_log_groups_per_flex;

2401 i‡(
sbi
->
s_log_groups_≥r_Êex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2402 
sbi
->
s_log_groups_≥r_Êex
 = 0;

2406 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
sbi
->
s_groups_cou¡
);

2407 i‡(
îr
)

2408 
Áûed
;

2410 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2411 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2413 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
i
);

2414 
fg
 = 
	`sbi_¨øy_rcu_dîef
(
sbi
, 
s_Êex_groups
, 
Êex_group
);

2415 
	`©omic_add
(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), &
fg
->
‰ì_öodes
);

2416 
	`©omic64_add
(
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
),

2417 &
fg
->
‰ì_˛u°îs
);

2418 
	`©omic_add
(
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
), &
fg
->
u£d_dús
);

2422 
Áûed
:

2424 
	}
}

2426 
__À16
 
	$pxt4_group_desc_csum
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2427 
pxt4_group_desc
 *
gdp
)

2429 
off£t
 = 
	`off£tof
(
pxt4_group_desc
, 
bg_checksum
);

2430 
__u16
 
¸c
 = 0;

2431 
__À32
 
À_group
 = 
	`˝u_to_À32
(
block_group
);

2432 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2434 i‡(
	`pxt4_has_mëad©a_csum
(
sbi
->
s_sb
)) {

2436 
__u32
 
csum32
;

2437 
__u16
 
dummy_csum
 = 0;

2439 
csum32
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
À_group
,

2440 (
À_group
));

2441 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2442 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2443 (
dummy_csum
));

2444 
off£t
 +(
dummy_csum
);

2445 i‡(
off£t
 < 
sbi
->
s_desc_size
)

2446 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2447 
sbi
->
s_desc_size
 - 
off£t
);

2449 
¸c
 = 
csum32
 & 0xFFFF;

2450 
out
;

2454 i‡(!
	`pxt4_has_„©uª_gdt_csum
(
sb
))

2457 
¸c
 = 
	`¸c16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2458 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)&
À_group
, (le_group));

2459 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
, 
off£t
);

2460 
off£t
 +(
gdp
->
bg_checksum
);

2462 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

2463 
off£t
 < 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
))

2464 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
 + 
off£t
,

2465 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
) -

2466 
off£t
);

2468 
out
:

2469  
	`˝u_to_À16
(
¸c
);

2470 
	}
}

2472 
	$pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2473 
pxt4_group_desc
 *
gdp
)

2475 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2476 (
gdp
->
bg_checksum
 !
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2480 
	}
}

2482 
	$pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2483 
pxt4_group_desc
 *
gdp
)

2485 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

2487 
gdp
->
bg_checksum
 = 
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp);

2488 
	}
}

2491 
	$pxt4_check_des¸ùt‹s
(
su≥r_block
 *
sb
,

2492 
pxt4_fsblk_t
 
sb_block
,

2493 
pxt4_group_t
 *
fú°_nŸ_zî€d
)

2495 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2496 
pxt4_fsblk_t
 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

2497 
pxt4_fsblk_t
 
œ°_block
;

2498 
pxt4_fsblk_t
 
œ°_bg_block
 = 
sb_block
 + 
	`pxt4_bg_num_gdb
(
sb
, 0);

2499 
pxt4_fsblk_t
 
block_bôm≠
;

2500 
pxt4_fsblk_t
 
öode_bôm≠
;

2501 
pxt4_fsblk_t
 
öode_èbÀ
;

2502 
Êexbg_Êag
 = 0;

2503 
pxt4_group_t
 
i
, 
gΩ
 = 
sbi
->
s_groups_cou¡
;

2505 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

2506 
Êexbg_Êag
 = 1;

2508 
	`pxt4_debug
("Checking group descriptors");

2510 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2511 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2513 i‡(
i
 =
sbi
->
s_groups_cou¡
 - 1 || 
Êexbg_Êag
)

2514 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) - 1;

2516 
œ°_block
 = 
fú°_block
 +

2517 (
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2519 i‡((
gΩ
 =
sbi
->
s_groups_cou¡
) &&

2520 !(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

2521 
gΩ
 = 
i
;

2523 
block_bôm≠
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

2524 i‡(
block_bôm≠
 =
sb_block
) {

2525 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2527 "su≥rblock", 
i
);

2528 i‡(!
	`sb_rd⁄ly
(
sb
))

2531 i‡(
block_bôm≠
 >
sb_block
 + 1 &&

2532 
block_bôm≠
 <
œ°_bg_block
) {

2533 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2535 "block grou∞des¸ùt‹s", 
i
);

2536 i‡(!
	`sb_rd⁄ly
(
sb
))

2539 i‡(
block_bôm≠
 < 
fú°_block
 || block_bôm≠ > 
œ°_block
) {

2540 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2542 "(block %Œu)!", 
i
, 
block_bôm≠
);

2545 
öode_bôm≠
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

2546 i‡(
öode_bôm≠
 =
sb_block
) {

2547 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2549 "su≥rblock", 
i
);

2550 i‡(!
	`sb_rd⁄ly
(
sb
))

2553 i‡(
öode_bôm≠
 >
sb_block
 + 1 &&

2554 
öode_bôm≠
 <
œ°_bg_block
) {

2555 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2557 "block grou∞des¸ùt‹s", 
i
);

2558 i‡(!
	`sb_rd⁄ly
(
sb
))

2561 i‡(
öode_bôm≠
 < 
fú°_block
 || inode_bôm≠ > 
œ°_block
) {

2562 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2564 "(block %Œu)!", 
i
, 
öode_bôm≠
);

2567 
öode_èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

2568 i‡(
öode_èbÀ
 =
sb_block
) {

2569 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2571 "su≥rblock", 
i
);

2572 i‡(!
	`sb_rd⁄ly
(
sb
))

2575 i‡(
öode_èbÀ
 >
sb_block
 + 1 &&

2576 
öode_èbÀ
 <
œ°_bg_block
) {

2577 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2579 "block grou∞des¸ùt‹s", 
i
);

2580 i‡(!
	`sb_rd⁄ly
(
sb
))

2583 i‡(
öode_èbÀ
 < 
fú°_block
 ||

2584 
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
 - 1 > 
œ°_block
) {

2585 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2587 "(block %Œu)!", 
i
, 
öode_èbÀ
);

2590 
	`pxt4_lock_group
(
sb
, 
i
);

2591 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
i
, 
gdp
)) {

2592 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2594 
i
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, i,

2595 
gdp
)), 
	`À16_to_˝u
(gdp->
bg_checksum
));

2596 i‡(!
	`sb_rd⁄ly
(
sb
)) {

2597 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2601 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2602 i‡(!
Êexbg_Êag
)

2603 
fú°_block
 +
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

2605 i‡(
NULL
 !
fú°_nŸ_zî€d
)

2606 *
fú°_nŸ_zî€d
 = 
gΩ
;

2608 
	}
}

2627 
	$pxt4_‹ph™_˛ónup
(
su≥r_block
 *
sb
,

2628 
pxt4_su≥r_block
 *
es
)

2630 
s_Êags
 = 
sb
->s_flags;

2631 
ªt
, 
ƒ_‹ph™s
 = 0, 
ƒ_åunˇãs
 = 0;

2632 #ifde‡
CONFIG_QUOTA


2633 
quŸa_upd©e
 = 0;

2634 
i
;

2636 i‡(!
es
->
s_œ°_‹ph™
) {

2637 
	`jbd_debug
(4, "no orphan inodesÅo clean up\n");

2641 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
)) {

2642 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

2648 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

2649 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueÅo "

2654 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2656 i‡(
es
->
s_œ°_‹ph™
 && !(
s_Êags
 & 
SB_RDONLY
)) {

2657 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2659 
es
->
s_œ°_‹ph™
 = 0;

2661 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2665 i‡(
s_Êags
 & 
SB_RDONLY
) {

2666 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup onÑeadonly fs");

2667 
sb
->
s_Êags
 &~
SB_RDONLY
;

2669 #ifde‡
CONFIG_QUOTA


2671 
sb
->
s_Êags
 |
SB_ACTIVE
;

2677 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& (
s_Êags
 & 
SB_RDONLY
)) {

2678 
ªt
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

2680 i‡(!
ªt
)

2681 
quŸa_upd©e
 = 1;

2683 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2684 "C™nŸÅu∫ o¿quŸas:Éº‹ %d", 
ªt
);

2688 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2689 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
i
]) {

2690 
ªt
 = 
	`pxt4_quŸa_⁄_mou¡
(
sb
, 
i
);

2692 i‡(!
ªt
)

2693 
quŸa_upd©e
 = 1;

2695 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2697 "quŸa:Åy≥ %d:Éº‹ %d", 
i
, 
ªt
);

2702 
es
->
s_œ°_‹ph™
) {

2703 
öode
 *inode;

2709 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2710 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2711 
es
->
s_œ°_‹ph™
 = 0;

2715 
öode
 = 
	`pxt4_‹ph™_gë
(
sb
, 
	`À32_to_˝u
(
es
->
s_œ°_‹ph™
));

2716 i‡(
	`IS_ERR
(
öode
)) {

2717 
es
->
s_œ°_‹ph™
 = 0;

2721 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
	`PXT4_SB
(
sb
)->
s_‹ph™
);

2722 
	`dquŸ_öôülize
(
öode
);

2723 i‡(
öode
->
i_∆ök
) {

2724 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2725 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2727 
__func__
, 
öode
->
i_öo
, inode->
i_size
);

2728 
	`jbd_debug
(2, "truncating inode %luÅo %lld bytes\n",

2729 
öode
->
i_öo
, inode->
i_size
);

2730 
	`öode_lock
(
öode
);

2731 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

2732 
ªt
 = 
	`pxt4_åunˇã
(
öode
);

2733 i‡(
ªt
)

2734 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

2735 
	`öode_u∆ock
(
öode
);

2736 
ƒ_åunˇãs
++;

2738 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2739 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2741 
__func__
, 
öode
->
i_öo
);

2742 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2743 
öode
->
i_öo
);

2744 
ƒ_‹ph™s
++;

2746 
	`ùut
(
öode
);

2749 
	#PLURAL
(
x
Ë(x), ((xË=1Ë? "" : "s"

	)

2751 i‡(
ƒ_‹ph™s
)

2752 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2753 
	`PLURAL
(
ƒ_‹ph™s
));

2754 i‡(
ƒ_åunˇãs
)

2755 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%dÅruncate%s cleaned up",

2756 
	`PLURAL
(
ƒ_åunˇãs
));

2757 #ifde‡
CONFIG_QUOTA


2759 i‡(
quŸa_upd©e
) {

2760 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2761 i‡(
	`sb_dq›t
(
sb
)->
fûes
[
i
])

2762 
	`dquŸ_quŸa_off
(
sb
, 
i
);

2766 
sb
->
s_Êags
 = s_flags;

2767 
	}
}

2784 
loff_t
 
	$pxt4_max_size
(
blkbôs
, 
has_huge_fûes
)

2786 
loff_t
 
ªs
;

2787 
loff_t
 
uµî_limô
 = 
MAX_LFS_FILESIZE
;

2789 
	`BUILD_BUG_ON
((
blk˙t_t
Ë< (
u64
));

2791 i‡(!
has_huge_fûes
) {

2792 
uµî_limô
 = (1LL << 32) - 1;

2795 
uµî_limô
 >>(
blkbôs
 - 9);

2796 
uµî_limô
 <<
blkbôs
;

2804 
ªs
 = (1LL << 32) - 1;

2805 
ªs
 <<
blkbôs
;

2808 i‡(
ªs
 > 
uµî_limô
)

2809 
ªs
 = 
uµî_limô
;

2811  
ªs
;

2812 
	}
}

2819 
loff_t
 
	$pxt4_max_bôm≠_size
(
bôs
, 
has_huge_fûes
)

2821 
loff_t
 
ªs
 = 
PXT4_NDIR_BLOCKS
;

2822 
mëa_blocks
;

2823 
loff_t
 
uµî_limô
;

2832 i‡(!
has_huge_fûes
) {

2838 
uµî_limô
 = (1LL << 32) - 1;

2841 
uµî_limô
 >>(
bôs
 - 9);

2850 
uµî_limô
 = (1LL << 48) - 1;

2855 
mëa_blocks
 = 1;

2857 
mëa_blocks
 +1 + (1LL << (
bôs
-2));

2859 
mëa_blocks
 +1 + (1LL << (
bôs
-2)) + (1LL << (2*(bits-2)));

2861 
uµî_limô
 -
mëa_blocks
;

2862 
uµî_limô
 <<
bôs
;

2864 
ªs
 +1LL << (
bôs
-2);

2865 
ªs
 +1LL << (2*(
bôs
-2));

2866 
ªs
 +1LL << (3*(
bôs
-2));

2867 
ªs
 <<
bôs
;

2868 i‡(
ªs
 > 
uµî_limô
)

2869 
ªs
 = 
uµî_limô
;

2871 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

2872 
ªs
 = 
MAX_LFS_FILESIZE
;

2874  
ªs
;

2875 
	}
}

2877 
pxt4_fsblk_t
 
	$des¸ùt‹_loc
(
su≥r_block
 *
sb
,

2878 
pxt4_fsblk_t
 
logiˇl_sb_block
, 
ƒ
)

2880 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2881 
pxt4_group_t
 
bg
, 
fú°_mëa_bg
;

2882 
has_su≥r
 = 0;

2884 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

2886 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
ƒ
 < 
fú°_mëa_bg
)

2887  
logiˇl_sb_block
 + 
ƒ
 + 1;

2888 
bg
 = 
sbi
->
s_desc_≥r_block
 * 
ƒ
;

2889 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
bg
))

2890 
has_su≥r
 = 1;

2898 i‡(
sb
->
s_blocksize
 =1024 && 
ƒ
 == 0 &&

2899 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) == 0)

2900 
has_su≥r
++;

2902  (
has_su≥r
 + 
	`pxt4_group_fú°_block_no
(
sb
, 
bg
));

2903 
	}
}

2916 
	$pxt4_gë_°rùe_size
(
pxt4_sb_öfo
 *
sbi
)

2918 
°ride
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_øid_°ride
);

2919 
°rùe_width
 =

2920 
	`À32_to_˝u
(
sbi
->
s_es
->
s_øid_°rùe_width
);

2921 
ªt
;

2923 i‡(
sbi
->
s_°rùe
 && sbi->s_°rùê<sbi->
s_blocks_≥r_group
)

2924 
ªt
 = 
sbi
->
s_°rùe
;

2925 i‡(
°rùe_width
 && såùe_width <
sbi
->
s_blocks_≥r_group
)

2926 
ªt
 = 
°rùe_width
;

2927 i‡(
°ride
 && såidê<
sbi
->
s_blocks_≥r_group
)

2928 
ªt
 = 
°ride
;

2930 
ªt
 = 0;

2936 i‡(
ªt
 <= 1)

2937 
ªt
 = 0;

2939  
ªt
;

2940 
	}
}

2948 
	$pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
)

2950 i‡(
	`pxt4_has_unknown_ext4_öcom∑t_„©uªs
(
sb
)) {

2951 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2954 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
) &

2955 ~
PXT4_FEATURE_INCOMPAT_SUPP
));

2959 #i‚de‡
CONFIG_UNICODE


2960 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
)) {

2961 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2968 i‡(
ªad⁄ly
)

2971 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
)) {

2972 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "filesystem isÑead-only");

2973 
sb
->
s_Êags
 |
SB_RDONLY
;

2978 i‡(
	`pxt4_has_unknown_ext4_ro_com∑t_„©uªs
(
sb
)) {

2979 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2981 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
) &

2982 ~
PXT4_FEATURE_RO_COMPAT_SUPP
));

2985 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
Ë&& !
	`pxt4_has_„©uª_exã¡s
(sb)) {

2986 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2992 #i‡!
	`IS_ENABLED
(
CONFIG_QUOTA
Ë|| !IS_ENABLED(
CONFIG_QFMT_V2
)

2993 i‡(!
ªad⁄ly
 && (
	`pxt4_has_„©uª_quŸa
(
sb
) ||

2994 
	`pxt4_has_„©uª_¥oje˘
(
sb
))) {

2995 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3001 
	}
}

3007 
	$¥öt_daûy_îr‹_öfo
(
timî_li°
 *
t
)

3009 
pxt4_sb_öfo
 *
sbi
 = 
	`‰om_timî
(sbi, 
t
, 
s_îr_ªp‹t
);

3010 
su≥r_block
 *
sb
 = 
sbi
->
s_sb
;

3011 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3013 i‡(
es
->
s_îr‹_cou¡
)

3015 
	`pxt4_msg
(
sb
, 
KERN_NOTICE
, "error count sinceÜast fsck: %u",

3016 
	`À32_to_˝u
(
es
->
s_îr‹_cou¡
));

3017 i‡(
es
->
s_fú°_îr‹_time
) {

3018 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s): initialÉrrorátÅime %llu: %.*s:%d",

3019 
sb
->
s_id
,

3020 
	`pxt4_gë_t°amp
(
es
, 
s_fú°_îr‹_time
),

3021 (Ë(
es
->
s_fú°_îr‹_func
),

3022 
es
->
s_fú°_îr‹_func
,

3023 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_löe
));

3024 i‡(
es
->
s_fú°_îr‹_öo
)

3025 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3026 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_öo
));

3027 i‡(
es
->
s_fú°_îr‹_block
)

3028 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3029 
	`À64_to_˝u
(
es
->
s_fú°_îr‹_block
));

3030 
	`¥ötk
(
KERN_CONT
 "\n");

3032 i‡(
es
->
s_œ°_îr‹_time
) {

3033 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s):ÜastÉrrorátÅime %llu: %.*s:%d",

3034 
sb
->
s_id
,

3035 
	`pxt4_gë_t°amp
(
es
, 
s_œ°_îr‹_time
),

3036 (Ë(
es
->
s_œ°_îr‹_func
),

3037 
es
->
s_œ°_îr‹_func
,

3038 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_löe
));

3039 i‡(
es
->
s_œ°_îr‹_öo
)

3040 
	`¥ötk
(
KERN_CONT
 ": inode %u",

3041 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_öo
));

3042 i‡(
es
->
s_œ°_îr‹_block
)

3043 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

3044 
	`À64_to_˝u
(
es
->
s_œ°_îr‹_block
));

3045 
	`¥ötk
(
KERN_CONT
 "\n");

3047 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

3048 
	}
}

3051 
	$pxt4_run_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3053 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3054 
pxt4_group_t
 
group
, 
ngroups
;

3055 
su≥r_block
 *
sb
;

3056 
timeout
 = 0;

3057 
ªt
 = 0;

3059 
sb
 = 
ñr
->
Ã_su≥r
;

3060 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3062 
group
 = 
ñr
->
Ã_√xt_group
; grou∞< 
ngroups
; group++) {

3063 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3064 i‡(!
gdp
) {

3065 
ªt
 = 1;

3069 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3073 i‡(
group
 >
ngroups
)

3074 
ªt
 = 1;

3076 i‡(!
ªt
) {

3077 
timeout
 = 
jiffõs
;

3078 
ªt
 = 
	`pxt4_öô_öode_èbÀ
(
sb
, 
group
,

3079 
ñr
->
Ã_timeout
 ? 0 : 1);

3080 i‡(
ñr
->
Ã_timeout
 == 0) {

3081 
timeout
 = (
jiffõs
 -Åimeout) *

3082 
ñr
->
Ã_sbi
->
s_li_waô_mu…
;

3083 
ñr
->
Ã_timeout
 = 
timeout
;

3085 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +ÉÃ->
Ã_timeout
;

3086 
ñr
->
Ã_√xt_group
 = 
group
 + 1;

3088  
ªt
;

3089 
	}
}

3095 
	$pxt4_ªmove_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3097 
pxt4_sb_öfo
 *
sbi
;

3099 i‡(!
ñr
)

3102 
sbi
 = 
ñr
->
Ã_sbi
;

3104 
	`li°_dñ
(&
ñr
->
Ã_ªque°
);

3105 
sbi
->
s_li_ªque°
 = 
NULL
;

3106 
	`k‰ì
(
ñr
);

3107 
	}
}

3109 
	$pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
)

3111 
	`muãx_lock
(&
pxt4_li_mtx
);

3112 i‡(!
pxt4_li_öfo
) {

3113 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3117 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3118 
	`pxt4_ªmove_li_ªque°
(
	`PXT4_SB
(
sb
)->
s_li_ªque°
);

3119 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3120 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3121 
	}
}

3123 
èsk_°ru˘
 *
	gpxt4_œzyöô_èsk
;

3134 
	$pxt4_œzyöô_thªad
(*
¨g
)

3136 
pxt4_œzy_öô
 *
ñi
 = (pxt4_œzy_öô *)
¨g
;

3137 
li°_hód
 *
pos
, *
n
;

3138 
pxt4_li_ªque°
 *
ñr
;

3139 
√xt_wakeup
, 
cur
;

3141 
	`BUG_ON
(
NULL
 =
ñi
);

3143 
c⁄t_thªad
:

3144 
åue
) {

3145 
√xt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3147 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3148 i‡(
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3149 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3150 
exô_thªad
;

3152 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
ñi
->
li_ªque°_li°
) {

3153 
îr
 = 0;

3154 
¥ogªss
 = 0;

3155 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3156 
Ã_ªque°
);

3158 i‡(
	`time_bef‹e
(
jiffõs
, 
ñr
->
Ã_√xt_sched
)) {

3159 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3160 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3163 i‡(
	`down_ªad_åylock
(&
ñr
->
Ã_su≥r
->
s_umou¡
)) {

3164 i‡(
	`sb_°¨t_wrôe_åylock
(
ñr
->
Ã_su≥r
)) {

3165 
¥ogªss
 = 1;

3171 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3172 
îr
 = 
	`pxt4_run_li_ªque°
(
ñr
);

3173 
	`sb_íd_wrôe
(
ñr
->
Ã_su≥r
);

3174 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3175 
n
 = 
pos
->
√xt
;

3177 
	`up_ªad
((&
ñr
->
Ã_su≥r
->
s_umou¡
));

3180 i‡(
îr
) {

3181 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3184 i‡(!
¥ogªss
) {

3185 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +

3186 (
	`¥™dom_u32
()

3187 % (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3189 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3190 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3192 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3194 
	`åy_to_‰ìze
();

3196 
cur
 = 
jiffõs
;

3197 i‡((
	`time_a·î_eq
(
cur
, 
√xt_wakeup
)) ||

3198 (
MAX_JIFFY_OFFSET
 =
√xt_wakeup
)) {

3199 
	`c⁄d_ªsched
();

3203 
	`scheduÀ_timeout_öãºu±ibÀ
(
√xt_wakeup
 - 
cur
);

3205 i‡(
	`kthªad_should_°›
()) {

3206 
	`pxt4_˛ór_ªque°_li°
();

3207 
exô_thªad
;

3211 
exô_thªad
:

3220 
	`muãx_lock
(&
pxt4_li_mtx
);

3221 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3222 i‡(!
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3223 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3224 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3225 
c⁄t_thªad
;

3227 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3228 
	`k‰ì
(
pxt4_li_öfo
);

3229 
pxt4_li_öfo
 = 
NULL
;

3230 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3233 
	}
}

3235 
	$pxt4_˛ór_ªque°_li°
()

3237 
li°_hód
 *
pos
, *
n
;

3238 
pxt4_li_ªque°
 *
ñr
;

3240 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3241 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
pxt4_li_öfo
->
li_ªque°_li°
) {

3242 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3243 
Ã_ªque°
);

3244 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3246 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3247 
	}
}

3249 
	$pxt4_run_œzyöô_thªad
()

3251 
pxt4_œzyöô_èsk
 = 
	`kthªad_run
(
pxt4_œzyöô_thªad
,

3252 
pxt4_li_öfo
, "pxt4lazyinit");

3253 i‡(
	`IS_ERR
(
pxt4_œzyöô_èsk
)) {

3254 
îr
 = 
	`PTR_ERR
(
pxt4_œzyöô_èsk
);

3255 
	`pxt4_˛ór_ªque°_li°
();

3256 
	`k‰ì
(
pxt4_li_öfo
);

3257 
pxt4_li_öfo
 = 
NULL
;

3258 
	`¥ötk
(
KERN_CRIT
 "PXT4-fs:Érror %d creating inodeÅable "

3260 
îr
);

3261  
îr
;

3263 
pxt4_li_öfo
->
li_°©e
 |
PXT4_LAZYINIT_RUNNING
;

3265 
	}
}

3273 
pxt4_group_t
 
	$pxt4_has_unöô_ôabÀ
(
su≥r_block
 *
sb
)

3275 
pxt4_group_t
 
group
, 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3276 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3278 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

3279  
ngroups
;

3281 
group
 = 0; grou∞< 
ngroups
; group++) {

3282 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3283 i‡(!
gdp
)

3286 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3290  
group
;

3291 
	}
}

3293 
	$pxt4_li_öfo_√w
()

3295 
pxt4_œzy_öô
 *
ñi
 = 
NULL
;

3297 
ñi
 = 
	`kzÆloc
((*ñi), 
GFP_KERNEL
);

3298 i‡(!
ñi
)

3299  -
ENOMEM
;

3301 
	`INIT_LIST_HEAD
(&
ñi
->
li_ªque°_li°
);

3302 
	`muãx_öô
(&
ñi
->
li_li°_mtx
);

3304 
ñi
->
li_°©e
 |
PXT4_LAZYINIT_QUIT
;

3306 
pxt4_li_öfo
 = 
ñi
;

3309 
	}
}

3311 
pxt4_li_ªque°
 *
	$pxt4_li_ªque°_√w
(
su≥r_block
 *
sb
,

3312 
pxt4_group_t
 
°¨t
)

3314 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3315 
pxt4_li_ªque°
 *
ñr
;

3317 
ñr
 = 
	`kzÆloc
((*ñr), 
GFP_KERNEL
);

3318 i‡(!
ñr
)

3319  
NULL
;

3321 
ñr
->
Ã_su≥r
 = 
sb
;

3322 
ñr
->
Ã_sbi
 = 
sbi
;

3323 
ñr
->
Ã_√xt_group
 = 
°¨t
;

3330 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 + (
	`¥™dom_u32
() %

3331 (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3332  
ñr
;

3333 
	}
}

3335 
	$pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

3336 
pxt4_group_t
 
fú°_nŸ_zî€d
)

3338 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3339 
pxt4_li_ªque°
 *
ñr
 = 
NULL
;

3340 
pxt4_group_t
 
ngroups
 = 
sbi
->
s_groups_cou¡
;

3341 
ªt
 = 0;

3343 
	`muãx_lock
(&
pxt4_li_mtx
);

3344 i‡(
sbi
->
s_li_ªque°
 !
NULL
) {

3349 
sbi
->
s_li_ªque°
->
Ã_timeout
 = 0;

3350 
out
;

3353 i‡(
fú°_nŸ_zî€d
 =
ngroups
 || 
	`sb_rd⁄ly
(
sb
) ||

3354 !
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

3355 
out
;

3357 
ñr
 = 
	`pxt4_li_ªque°_√w
(
sb
, 
fú°_nŸ_zî€d
);

3358 i‡(!
ñr
) {

3359 
ªt
 = -
ENOMEM
;

3360 
out
;

3363 i‡(
NULL
 =
pxt4_li_öfo
) {

3364 
ªt
 = 
	`pxt4_li_öfo_√w
();

3365 i‡(
ªt
)

3366 
out
;

3369 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3370 
	`li°_add
(&
ñr
->
Ã_ªque°
, &
pxt4_li_öfo
->
li_ªque°_li°
);

3371 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3373 
sbi
->
s_li_ªque°
 = 
ñr
;

3379 
ñr
 = 
NULL
;

3381 i‡(!(
pxt4_li_öfo
->
li_°©e
 & 
PXT4_LAZYINIT_RUNNING
)) {

3382 
ªt
 = 
	`pxt4_run_œzyöô_thªad
();

3383 i‡(
ªt
)

3384 
out
;

3386 
out
:

3387 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3388 i‡(
ªt
)

3389 
	`k‰ì
(
ñr
);

3390  
ªt
;

3391 
	}
}

3397 
	$pxt4_de°roy_œzyöô_thªad
()

3403 i‡(!
pxt4_li_öfo
 || !
pxt4_œzyöô_èsk
)

3406 
	`kthªad_°›
(
pxt4_œzyöô_èsk
);

3407 
	}
}

3409 
	$£t_jou∫Æ_csum_„©uª_£t
(
su≥r_block
 *
sb
)

3411 
ªt
 = 1;

3412 
com∑t
, 
öcom∑t
;

3413 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3415 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

3417 
com∑t
 = 0;

3418 
öcom∑t
 = 
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

3421 
com∑t
 = 
JBD3_FEATURE_COMPAT_CHECKSUM
;

3422 
öcom∑t
 = 0;

3425 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
,

3426 
JBD3_FEATURE_COMPAT_CHECKSUM
, 0,

3427 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 |

3428 
JBD3_FEATURE_INCOMPAT_CSUM_V2
);

3429 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3430 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3431 
com∑t
, 0,

3432 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3433 
öcom∑t
);

3434 } i‡(
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

3435 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3436 
com∑t
, 0,

3437 
öcom∑t
);

3438 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3439 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3441 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3442 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3445  
ªt
;

3446 
	}
}

3463 
	$cou¡_ovîhód
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

3464 *
buf
)

3466 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3467 
pxt4_group_desc
 *
gdp
;

3468 
pxt4_fsblk_t
 
fú°_block
, 
œ°_block
, 
b
;

3469 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3470 
s
, 
j
, 
cou¡
 = 0;

3472 i‡(!
	`pxt4_has_„©uª_bigÆloc
(
sb
))

3473  (
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
Ë+ 
	`pxt4_bg_num_gdb
(sb, grp) +

3474 
sbi
->
s_ôb_≥r_group
 + 2);

3476 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) +

3477 (
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

3478 
œ°_block
 = 
fú°_block
 + 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3479 
i
 = 0; i < 
ngroups
; i++) {

3480 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

3481 
b
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

3482 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3483 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3484 
cou¡
++;

3486 
b
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

3487 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3488 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3489 
cou¡
++;

3491 
b
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

3492 i‡(
b
 >
fú°_block
 && b + 
sbi
->
s_ôb_≥r_group
 <
œ°_block
)

3493 
j
 = 0; j < 
sbi
->
s_ôb_≥r_group
; j++, 
b
++) {

3494 
c
 = 
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
);

3495 
	`pxt4_£t_bô
(
c
, 
buf
);

3496 
cou¡
++;

3498 i‡(
i
 !
gΩ
)

3500 
s
 = 0;

3501 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
)) {

3502 
	`pxt4_£t_bô
(
s
++, 
buf
);

3503 
cou¡
++;

3505 
j
 = 
	`pxt4_bg_num_gdb
(
sb
, 
gΩ
);

3506 i‡(
s
 + 
j
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

3507 
	`pxt4_îr‹
(
sb
, "InvalidÇumber of block group "

3508 "des¸ùt‹ blocks: %d", 
j
);

3509 
j
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
s
;

3511 
cou¡
 +
j
;

3512 ; 
j
 > 0; j--)

3513 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
s
++), 
buf
);

3515 i‡(!
cou¡
)

3517  
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) -

3518 
	`pxt4_cou¡_‰ì
(
buf
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3519 
	}
}

3524 
	$pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
)

3526 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3527 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3528 
öode
 *
j_öode
;

3529 
j_blocks
, 
j_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

3530 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3531 
pxt4_fsblk_t
 
ovîhód
 = 0;

3532 *
buf
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_NOFS
);

3534 i‡(!
buf
)

3535  -
ENOMEM
;

3546 
ovîhód
 = 
	`PXT4_B2C
(
sbi
, 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
));

3551 
i
 = 0; i < 
ngroups
; i++) {

3552 
blks
;

3554 
blks
 = 
	`cou¡_ovîhód
(
sb
, 
i
, 
buf
);

3555 
ovîhód
 +
blks
;

3556 i‡(
blks
)

3557 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3558 
	`c⁄d_ªsched
();

3565 i‡(
sbi
->
s_jou∫Æ
 && !sbi->
jou∫Æ_bdev
)

3566 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, sbi->
s_jou∫Æ
->
j_maxÀn
);

3567 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& !
sbi
->
s_jou∫Æ
) {

3568 
j_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
j_öum
);

3569 i‡(
j_öode
) {

3570 
j_blocks
 = 
j_öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

3571 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3572 
	`ùut
(
j_öode
);

3574 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3577 
sbi
->
s_ovîhód
 = 
ovîhód
;

3578 
	`smp_wmb
();

3579 
	`‰ì_∑ge
((Ë
buf
);

3581 
	}
}

3583 
	$pxt4_£t_ªsv_˛u°îs
(
su≥r_block
 *
sb
)

3585 
pxt4_fsblk_t
 
ªsv_˛u°îs
;

3586 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3594 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3604 
ªsv_˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

3605 
sbi
->
s_˛u°î_bôs
);

3607 
	`do_div
(
ªsv_˛u°îs
, 50);

3608 
ªsv_˛u°îs
 = 
	`mö_t
(
pxt4_fsblk_t
,Ñesv_clusters, 4096);

3610 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
ªsv_˛u°îs
);

3611 
	}
}

3613 
	$pxt4_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

3615 
dax_devi˚
 *
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
);

3616 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

3617 
buf„r_hód
 *
bh
, **
group_desc
;

3618 
pxt4_su≥r_block
 *
es
 = 
NULL
;

3619 
pxt4_sb_öfo
 *
sbi
 = 
	`kzÆloc
((*sbi), 
GFP_KERNEL
);

3620 
Êex_groups
 **flex_groups;

3621 
pxt4_fsblk_t
 
block
;

3622 
pxt4_fsblk_t
 
sb_block
 = 
	`gë_sb_block
(&
d©a
);

3623 
pxt4_fsblk_t
 
logiˇl_sb_block
;

3624 
off£t
 = 0;

3625 
jou∫Æ_devnum
 = 0;

3626 
def_mou¡_›ts
;

3627 
öode
 *
roŸ
;

3628 c⁄° *
des¸
;

3629 
ªt
 = -
ENOMEM
;

3630 
blocksize
, 
˛u°îsize
;

3631 
db_cou¡
;

3632 
i
;

3633 
√eds_ªcovîy
, 
has_huge_fûes
, 
has_bigÆloc
;

3634 
__u64
 
blocks_cou¡
;

3635 
îr
 = 0;

3636 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3637 
pxt4_group_t
 
fú°_nŸ_zî€d
;

3639 i‡((
d©a
 && !
‹ig_d©a
Ë|| !
sbi
)

3640 
out_‰ì_ba£
;

3642 
sbi
->
s_daxdev
 = 
dax_dev
;

3643 
sbi
->
s_blockgroup_lock
 =

3644 
	`kzÆloc
((
blockgroup_lock
), 
GFP_KERNEL
);

3645 i‡(!
sbi
->
s_blockgroup_lock
)

3646 
out_‰ì_ba£
;

3648 
sb
->
s_fs_öfo
 = 
sbi
;

3649 
sbi
->
s_sb
 = 
sb
;

3650 
sbi
->
s_öode_ªadahód_blks
 = 
PXT4_DEF_INODE_READAHEAD_BLKS
;

3651 
sbi
->
s_sb_block
 = 
sb_block
;

3652 i‡(
sb
->
s_bdev
->
bd_∑π
)

3653 
sbi
->
s_£˘‹s_wrôãn_°¨t
 =

3654 
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
, 
£˘‹s
[
STAT_WRITE
]);

3657 
	`°ºïœ˚
(
sb
->
s_id
, '/', '!');

3660 
ªt
 = -
EINVAL
;

3661 
blocksize
 = 
	`sb_mö_blocksize
(
sb
, 
PXT4_MIN_BLOCK_SIZE
);

3662 i‡(!
blocksize
) {

3663 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize");

3664 
out_Áû
;

3671 i‡(
blocksize
 !
PXT4_MIN_BLOCK_SIZE
) {

3672 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3673 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3675 
logiˇl_sb_block
 = 
sb_block
;

3678 i‡(!(
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
))) {

3679 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead superblock");

3680 
out_Áû
;

3686 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

3687 
sbi
->
s_es
 = 
es
;

3688 
sb
->
s_magic
 = 
	`À16_to_˝u
(
es
->s_magic);

3689 i‡(
sb
->
s_magic
 !
PXT4_SUPER_MAGIC
)

3690 
ˇ¡föd_pxt4
;

3691 
sbi
->
s_kbyãs_wrôãn
 = 
	`À64_to_˝u
(
es
->s_kbytes_written);

3694 i‡(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

3695 
	`pxt4_has_„©uª_gdt_csum
(
sb
))

3696 
	`pxt4_w¨nög
(
sb
, "metadata_csumánd uninit_bgáre "

3700 i‡(!
	`pxt4_vîify_csum_ty≥
(
sb
, 
es
)) {

3701 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3703 
sûít
 = 1;

3704 
ˇ¡föd_pxt4
;

3708 
sbi
->
s_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

3709 i‡(
	`IS_ERR
(
sbi
->
s_chksum_drivî
)) {

3710 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CannotÜoad crc32c driver.");

3711 
ªt
 = 
	`PTR_ERR
(
sbi
->
s_chksum_drivî
);

3712 
sbi
->
s_chksum_drivî
 = 
NULL
;

3713 
Áûed_mou¡
;

3717 i‡(!
	`pxt4_su≥rblock_csum_vîify
(
sb
, 
es
)) {

3718 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3720 
sûít
 = 1;

3721 
ªt
 = -
EFSBADCRC
;

3722 
ˇ¡föd_pxt4
;

3726 i‡(
	`pxt4_has_„©uª_csum_£ed
(
sb
))

3727 
sbi
->
s_csum_£ed
 = 
	`À32_to_˝u
(
es
->
s_checksum_£ed
);

3728 i‡(
	`pxt4_has_mëad©a_csum
(
sb
Ë|| 
	`pxt4_has_„©uª_ó_öode
(sb))

3729 
sbi
->
s_csum_£ed
 = 
	`pxt4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3730 (
es
->
s_uuid
));

3733 
def_mou¡_›ts
 = 
	`À32_to_˝u
(
es
->
s_deÁu…_mou¡_›ts
);

3734 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

3735 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DEBUG
)

3736 
	`£t_›t
(
sb
, 
DEBUG
);

3737 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_BSDGROUPS
)

3738 
	`£t_›t
(
sb
, 
GRPID
);

3739 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_UID16
)

3740 
	`£t_›t
(
sb
, 
NO_UID32
);

3742 
	`£t_›t
(
sb
, 
XATTR_USER
);

3743 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


3744 
	`£t_›t
(
sb
, 
POSIX_ACL
);

3747 i‡(
	`pxt4_has_mëad©a_csum
(
sb
))

3748 
	`£t_›t
(
sb
, 
JOURNAL_CHECKSUM
);

3750 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_DATA
)

3751 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

3752 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_ORDERED
)

3753 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

3754 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_WBACK
)

3755 
	`£t_›t
(
sb
, 
WRITEBACK_DATA
);

3757 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_PANIC
)

3758 
	`£t_›t
(
sb
, 
ERRORS_PANIC
);

3759 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_CONTINUE
)

3760 
	`£t_›t
(
sb
, 
ERRORS_CONT
);

3762 
	`£t_›t
(
sb
, 
ERRORS_RO
);

3764 
	`£t_›t
(
sb
, 
BLOCK_VALIDITY
);

3765 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DISCARD
)

3766 
	`£t_›t
(
sb
, 
DISCARD
);

3768 
sbi
->
s_ªsuid
 = 
	`make_kuid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsuid
));

3769 
sbi
->
s_ªsgid
 = 
	`make_kgid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsgid
));

3770 
sbi
->
s_commô_öãrvÆ
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3771 
sbi
->
s_mö_b©ch_time
 = 
PXT4_DEF_MIN_BATCH_TIME
;

3772 
sbi
->
s_max_b©ch_time
 = 
PXT4_DEF_MAX_BATCH_TIME
;

3774 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_NOBARRIER
) == 0)

3775 
	`£t_›t
(
sb
, 
BARRIER
);

3781 i‡(!
	`IS_EXT3_SB
(
sb
Ë&& !
	`IS_PXT2_SB
(sb) &&

3782 ((
def_mou¡_›ts
 & 
PXT4_DEFM_NODELALLOC
) == 0))

3783 
	`£t_›t
(
sb
, 
DELALLOC
);

3789 
sbi
->
s_li_waô_mu…
 = 
PXT4_DEF_LI_WAIT_MULT
;

3791 
blocksize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_block_size
);

3792 i‡(
blocksize
 < 
PXT4_MIN_BLOCK_SIZE
 ||

3793 
blocksize
 > 
PXT4_MAX_BLOCK_SIZE
) {

3794 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3796 
blocksize
, 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3797 
Áûed_mou¡
;

3800 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
) {

3801 
sbi
->
s_öode_size
 = 
PXT4_GOOD_OLD_INODE_SIZE
;

3802 
sbi
->
s_fú°_öo
 = 
PXT4_GOOD_OLD_FIRST_INO
;

3804 
sbi
->
s_öode_size
 = 
	`À16_to_˝u
(
es
->s_inode_size);

3805 
sbi
->
s_fú°_öo
 = 
	`À32_to_˝u
(
es
->s_first_ino);

3806 i‡(
sbi
->
s_fú°_öo
 < 
PXT4_GOOD_OLD_FIRST_INO
) {

3807 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

3808 
sbi
->
s_fú°_öo
);

3809 
Áûed_mou¡
;

3811 i‡((
sbi
->
s_öode_size
 < 
PXT4_GOOD_OLD_INODE_SIZE
) ||

3812 (!
	`is_powî_of_2
(
sbi
->
s_öode_size
)) ||

3813 (
sbi
->
s_öode_size
 > 
blocksize
)) {

3814 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3816 
sbi
->
s_öode_size
);

3817 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksize: %d", 
blocksize
);

3818 
Áûed_mou¡
;

3826 i‡(
sbi
->
s_öode_size
 >
	`off£tof
(
pxt4_öode
, 
i_©ime_exåa
) +

3827 (((
pxt4_öode
 *)0)->
i_©ime_exåa
)) {

3828 
sb
->
s_time_gøn
 = 1;

3829 
sb
->
s_time_max
 = 
PXT4_EXTRA_TIMESTAMP_MAX
;

3831 
sb
->
s_time_gøn
 = 
NSEC_PER_SEC
;

3832 
sb
->
s_time_max
 = 
PXT4_NON_EXTRA_TIMESTAMP_MAX
;

3834 
sb
->
s_time_mö
 = 
PXT4_TIMESTAMP_MIN
;

3836 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
) {

3837 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3838 
PXT4_GOOD_OLD_INODE_SIZE
;

3839 i‡(
	`pxt4_has_„©uª_exåa_isize
(
sb
)) {

3840 
v
, 
max
 = (
sbi
->
s_öode_size
 -

3841 
PXT4_GOOD_OLD_INODE_SIZE
);

3843 
v
 = 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
);

3844 i‡(
v
 > 
max
) {

3845 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3846 "bad s_w™t_exåa_isize: %d", 
v
);

3847 
Áûed_mou¡
;

3849 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3850 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3852 
v
 = 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
);

3853 i‡(
v
 > 
max
) {

3854 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3855 "bad s_mö_exåa_isize: %d", 
v
);

3856 
Áûed_mou¡
;

3858 i‡(
sbi
->
s_w™t_exåa_isize
 < 
v
)

3859 
sbi
->
s_w™t_exåa_isize
 = 
v
;

3863 i‡(
sbi
->
s_es
->
s_mou¡_›ts
[0]) {

3864 *
s_mou¡_›ts
 = 
	`k°∫dup
(
sbi
->
s_es
->s_mount_opts,

3865 (
sbi
->
s_es
->
s_mou¡_›ts
),

3866 
GFP_KERNEL
);

3867 i‡(!
s_mou¡_›ts
)

3868 
Áûed_mou¡
;

3869 i‡(!
	`∑r£_›ti⁄s
(
s_mou¡_›ts
, 
sb
, &
jou∫Æ_devnum
,

3870 &
jou∫Æ_i›rio
, 0)) {

3871 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3873 
s_mou¡_›ts
);

3875 
	`k‰ì
(
s_mou¡_›ts
);

3877 
sbi
->
s_def_mou¡_›t
 = sbi->
s_mou¡_›t
;

3878 i‡(!
	`∑r£_›ti⁄s
((*Ë
d©a
, 
sb
, &
jou∫Æ_devnum
,

3879 &
jou∫Æ_i›rio
, 0))

3880 
Áûed_mou¡
;

3882 #ifde‡
CONFIG_UNICODE


3883 i‡(
	`pxt4_has_„©uª_ˇ£fﬁd
(
sb
Ë&& !
sbi
->
s_ícodög
) {

3884 c⁄° 
pxt4_sb_ícodögs
 *
ícodög_öfo
;

3885 
unicode_m≠
 *
ícodög
;

3886 
__u16
 
ícodög_Êags
;

3888 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3889 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3891 
Áûed_mou¡
;

3894 i‡(
	`pxt4_sb_ªad_ícodög
(
es
, &
ícodög_öfo
,

3895 &
ícodög_Êags
)) {

3896 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3898 
Áûed_mou¡
;

3901 
ícodög
 = 
	`utf8_lﬂd
(
ícodög_öfo
->
vîsi⁄
);

3902 i‡(
	`IS_ERR
(
ícodög
)) {

3903 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3906 
ícodög_öfo
->
«me
,Éncodög_öfo->
vîsi⁄
,

3907 
ícodög_Êags
);

3908 
Áûed_mou¡
;

3910 
	`pxt4_msg
(
sb
, 
KERN_INFO
,"UsingÉncoding defined by superblock: "

3911 "%s-%†wôh fœg†0x%hx", 
ícodög_öfo
->
«me
,

3912 
ícodög_öfo
->
vîsi⁄
?:"\b", 
ícodög_Êags
);

3914 
sbi
->
s_ícodög
 = 
ícodög
;

3915 
sbi
->
s_ícodög_Êags
 = 
ícodög_Êags
;

3919 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

3920 
	`¥ötk_⁄˚
(
KERN_WARNING
 "PXT4-fs: Warning: mounting "

3923 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3924 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3926 
Áûed_mou¡
;

3928 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

3929 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3931 
Áûed_mou¡
;

3933 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

3934 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3936 
Áûed_mou¡
;

3938 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3939 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3943 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

3944 
	`˛ór_›t
(
sb
, 
DELALLOC
);

3946 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

3949 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

3950 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

3952 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
 &&

3953 (
	`pxt4_has_com∑t_„©uªs
(
sb
) ||

3954 
	`pxt4_has_ro_com∑t_„©uªs
(
sb
) ||

3955 
	`pxt4_has_öcom∑t_„©uªs
(
sb
)))

3956 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3960 i‡(
es
->
s_¸ót‹_os
 =
	`˝u_to_À32
(
PXT4_OS_HURD
)) {

3961 
	`£t_›t2
(
sb
, 
HURD_COMPAT
);

3962 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3963 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3965 
Áûed_mou¡
;

3972 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

3973 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3975 
Áûed_mou¡
;

3979 i‡(
	`IS_PXT2_SB
(
sb
)) {

3980 i‡(
	`pxt2_„©uª_£t_ok
(
sb
))

3981 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÖxt2 file system "

3988 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3989 
Áûed_mou¡
;

3990 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÖxt2 due "

3992 
Áûed_mou¡
;

3996 i‡(
	`IS_EXT3_SB
(
sb
)) {

3997 i‡(
	`ext3_„©uª_£t_ok
(
sb
))

3998 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÉxt3 file system "

4005 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

4006 
Áûed_mou¡
;

4007 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÉxt3 due "

4009 
Áûed_mou¡
;

4018 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, (
	`sb_rd⁄ly
(sb))))

4019 
Áûed_mou¡
;

4021 i‡(
	`À32_to_˝u
(
es
->
s_log_block_size
) >

4022 (
PXT4_MAX_BLOCK_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4023 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4025 
	`À32_to_˝u
(
es
->
s_log_block_size
));

4026 
Áûed_mou¡
;

4028 i‡(
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) >

4029 (
PXT4_MAX_CLUSTER_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

4030 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4032 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
));

4033 
Áûed_mou¡
;

4036 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
Ë> (
blocksize
 / 4)) {

4037 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4039 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
));

4040 
Áûed_mou¡
;

4043 i‡(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
) {

4044 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
)) {

4045 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX oná filesystem"

4047 
Áûed_mou¡
;

4049 i‡(!
	`bdev_dax_suµ‹ãd
(
sb
->
s_bdev
, 
blocksize
)) {

4050 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4052 
Áûed_mou¡
;

4056 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
Ë&& 
es
->
s_í¸y±i⁄_Àvñ
) {

4057 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "UnsupportedÉncryptionÜevel %d",

4058 
es
->
s_í¸y±i⁄_Àvñ
);

4059 
Áûed_mou¡
;

4062 i‡(
sb
->
s_blocksize
 !
blocksize
) {

4064 i‡(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

4065 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

4066 
blocksize
);

4067 
Áûed_mou¡
;

4070 
	`bªl£
(
bh
);

4071 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

4072 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

4073 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
);

4074 i‡(!
bh
) {

4075 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4077 
Áûed_mou¡
;

4079 
es
 = (
pxt4_su≥r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

4080 
sbi
->
s_es
 = 
es
;

4081 i‡(
es
->
s_magic
 !
	`˝u_to_À16
(
PXT4_SUPER_MAGIC
)) {

4082 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4084 
Áûed_mou¡
;

4088 
has_huge_fûes
 = 
	`pxt4_has_„©uª_huge_fûe
(
sb
);

4089 
sbi
->
s_bôm≠_maxbyãs
 = 
	`pxt4_max_bôm≠_size
(
sb
->
s_blocksize_bôs
,

4090 
has_huge_fûes
);

4091 
sb
->
s_maxbyãs
 = 
	`pxt4_max_size
(sb->
s_blocksize_bôs
, 
has_huge_fûes
);

4093 
sbi
->
s_desc_size
 = 
	`À16_to_˝u
(
es
->s_desc_size);

4094 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

4095 i‡(
sbi
->
s_desc_size
 < 
PXT4_MIN_DESC_SIZE_64BIT
 ||

4096 
sbi
->
s_desc_size
 > 
PXT4_MAX_DESC_SIZE
 ||

4097 !
	`is_powî_of_2
(
sbi
->
s_desc_size
)) {

4098 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4100 
sbi
->
s_desc_size
);

4101 
Áûed_mou¡
;

4104 
sbi
->
s_desc_size
 = 
PXT4_MIN_DESC_SIZE
;

4106 
sbi
->
s_blocks_≥r_group
 = 
	`À32_to_˝u
(
es
->s_blocks_per_group);

4107 
sbi
->
s_öodes_≥r_group
 = 
	`À32_to_˝u
(
es
->s_inodes_per_group);

4109 
sbi
->
s_öodes_≥r_block
 = 
blocksize
 / 
	`PXT4_INODE_SIZE
(
sb
);

4110 i‡(
sbi
->
s_öodes_≥r_block
 == 0)

4111 
ˇ¡föd_pxt4
;

4112 i‡(
sbi
->
s_öodes_≥r_group
 < sbi->
s_öodes_≥r_block
 ||

4113 
sbi
->
s_öodes_≥r_group
 > 
blocksize
 * 8) {

4114 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid inodesÖer group: %lu\n",

4115 
sbi
->
s_blocks_≥r_group
);

4116 
Áûed_mou¡
;

4118 
sbi
->
s_ôb_≥r_group
 = sbi->
s_öodes_≥r_group
 /

4119 
sbi
->
s_öodes_≥r_block
;

4120 
sbi
->
s_desc_≥r_block
 = 
blocksize
 / 
	`PXT4_DESC_SIZE
(
sb
);

4121 
sbi
->
s_sbh
 = 
bh
;

4122 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

4123 
sbi
->
s_addr_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_ADDR_PER_BLOCK
(
sb
));

4124 
sbi
->
s_desc_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_DESC_PER_BLOCK
(
sb
));

4126 
i
 = 0; i < 4; i++)

4127 
sbi
->
s_hash_£ed
[
i
] = 
	`À32_to_˝u
(
es
->s_hash_seed[i]);

4128 
sbi
->
s_def_hash_vîsi⁄
 = 
es
->s_def_hash_version;

4129 i‡(
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

4130 
i
 = 
	`À32_to_˝u
(
es
->
s_Êags
);

4131 i‡(
i
 & 
PXT2_FLAGS_UNSIGNED_HASH
)

4132 
sbi
->
s_hash_unsig√d
 = 3;

4133 i‡((
i
 & 
PXT2_FLAGS_SIGNED_HASH
) == 0) {

4134 #ifde‡
__CHAR_UNSIGNED__


4135 i‡(!
	`sb_rd⁄ly
(
sb
))

4136 
es
->
s_Êags
 |=

4137 
	`˝u_to_À32
(
PXT2_FLAGS_UNSIGNED_HASH
);

4138 
sbi
->
s_hash_unsig√d
 = 3;

4140 i‡(!
	`sb_rd⁄ly
(
sb
))

4141 
es
->
s_Êags
 |=

4142 
	`˝u_to_À32
(
PXT2_FLAGS_SIGNED_HASH
);

4148 
˛u°îsize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
);

4149 
has_bigÆloc
 = 
	`pxt4_has_„©uª_bigÆloc
(
sb
);

4150 i‡(
has_bigÆloc
) {

4151 i‡(
˛u°îsize
 < 
blocksize
) {

4152 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4154 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4155 
Áûed_mou¡
;

4157 
sbi
->
s_˛u°î_bôs
 = 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) -

4158 
	`À32_to_˝u
(
es
->
s_log_block_size
);

4159 
sbi
->
s_˛u°îs_≥r_group
 =

4160 
	`À32_to_˝u
(
es
->
s_˛u°îs_≥r_group
);

4161 i‡(
sbi
->
s_˛u°îs_≥r_group
 > 
blocksize
 * 8) {

4162 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4164 
sbi
->
s_˛u°îs_≥r_group
);

4165 
Áûed_mou¡
;

4167 i‡(
sbi
->
s_blocks_≥r_group
 !=

4168 (
sbi
->
s_˛u°îs_≥r_group
 * (
˛u°îsize
 / 
blocksize
))) {

4169 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksÖer group (%lu)ánd "

4171 
sbi
->
s_blocks_≥r_group
,

4172 
sbi
->
s_˛u°îs_≥r_group
);

4173 
Áûed_mou¡
;

4176 i‡(
˛u°îsize
 !
blocksize
) {

4177 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4179 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4180 
Áûed_mou¡
;

4182 i‡(
sbi
->
s_blocks_≥r_group
 > 
blocksize
 * 8) {

4183 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4185 
sbi
->
s_blocks_≥r_group
);

4186 
Áûed_mou¡
;

4188 
sbi
->
s_˛u°îs_≥r_group
 = sbi->
s_blocks_≥r_group
;

4189 
sbi
->
s_˛u°î_bôs
 = 0;

4191 
sbi
->
s_˛u°î_øtio
 = 
˛u°îsize
 / 
blocksize
;

4194 i‡(
sbi
->
s_blocks_≥r_group
 =
˛u°îsize
 << 3)

4195 
	`£t_›t2
(
sb
, 
STD_GROUP_SIZE
);

4201 
îr
 = 
	`gíîic_check_addªsßbÀ
(
sb
->
s_blocksize_bôs
,

4202 
	`pxt4_blocks_cou¡
(
es
));

4203 i‡(
îr
) {

4204 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4206 
Áûed_mou¡
;

4209 i‡(
	`PXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4210 
ˇ¡föd_pxt4
;

4213 
blocks_cou¡
 = 
sb
->
s_bdev
->
bd_öode
->
i_size
 >> sb->
s_blocksize_bôs
;

4214 i‡(
blocks_cou¡
 && 
	`pxt4_blocks_cou¡
(
es
) > blocks_count) {

4215 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4217 
	`pxt4_blocks_cou¡
(
es
), 
blocks_cou¡
);

4218 
Áûed_mou¡
;

4225 i‡(
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
Ë>
	`pxt4_blocks_cou¡
(es)) {

4226 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4228 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4229 
	`pxt4_blocks_cou¡
(
es
));

4230 
Áûed_mou¡
;

4232 i‡((
es
->
s_fú°_d©a_block
 =0Ë&& (es->
s_log_block_size
 == 0) &&

4233 (
sbi
->
s_˛u°î_øtio
 == 1)) {

4234 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4236 
Áûed_mou¡
;

4239 
blocks_cou¡
 = (
	`pxt4_blocks_cou¡
(
es
) -

4240 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) +

4241 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4242 
	`do_div
(
blocks_cou¡
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4243 i‡(
blocks_cou¡
 > ((
uöt64_t
)1<<32Ë- 
	`PXT4_DESC_PER_BLOCK
(
sb
)) {

4244 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "groups countÅooÜarge: %u "

4246 "block†≥∏grou∞%lu)", 
sbi
->
s_groups_cou¡
,

4247 
	`pxt4_blocks_cou¡
(
es
),

4248 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4249 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4250 
Áûed_mou¡
;

4252 
sbi
->
s_groups_cou¡
 = 
blocks_cou¡
;

4253 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

4254 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

4255 i‡(((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
) !=

4256 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

4257 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "inodes countÇot valid: %u vs %llu",

4258 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
),

4259 ((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
));

4260 
ªt
 = -
EINVAL
;

4261 
Áûed_mou¡
;

4263 
db_cou¡
 = (
sbi
->
s_groups_cou¡
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4264 
	`PXT4_DESC_PER_BLOCK
(
sb
);

4265 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
)) {

4266 i‡(
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
Ë> 
db_cou¡
) {

4267 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4270 
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
), 
db_cou¡
);

4271 
Áûed_mou¡
;

4274 
	`rcu_assign_poöãr
(
sbi
->
s_group_desc
,

4275 
	`kvmÆloc_¨øy
(
db_cou¡
,

4276 (
buf„r_hód
 *),

4277 
GFP_KERNEL
));

4278 i‡(
sbi
->
s_group_desc
 =
NULL
) {

4279 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory");

4280 
ªt
 = -
ENOMEM
;

4281 
Áûed_mou¡
;

4284 
	`bgl_lock_öô
(
sbi
->
s_blockgroup_lock
);

4287 
i
 = 0; i < 
db_cou¡
; i++) {

4288 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4289 
	`sb_bªadahód
(
sb
, 
block
);

4292 
i
 = 0; i < 
db_cou¡
; i++) {

4293 
buf„r_hód
 *
bh
;

4295 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4296 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
block
);

4297 i‡(!
bh
) {

4298 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4299 "ˇn'àªad grou∞des¸ùt‹ %d", 
i
);

4300 
db_cou¡
 = 
i
;

4301 
Áûed_mou¡2
;

4303 
	`rcu_ªad_lock
();

4304 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
)[
i
] = 
bh
;

4305 
	`rcu_ªad_u∆ock
();

4307 
sbi
->
s_gdb_cou¡
 = 
db_cou¡
;

4308 i‡(!
	`pxt4_check_des¸ùt‹s
(
sb
, 
logiˇl_sb_block
, &
fú°_nŸ_zî€d
)) {

4309 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4310 
ªt
 = -
EFSCORRUPTED
;

4311 
Áûed_mou¡2
;

4314 
	`timî_£tup
(&
sbi
->
s_îr_ªp‹t
, 
¥öt_daûy_îr‹_öfo
, 0);

4317 i‡(
	`pxt4_es_ªgi°î_shrökî
(
sbi
))

4318 
Áûed_mou¡3
;

4320 
sbi
->
s_°rùe
 = 
	`pxt4_gë_°rùe_size
(sbi);

4321 
sbi
->
s_exã¡_max_zîoout_kb
 = 32;

4326 
sb
->
s_›
 = &
pxt4_s›s
;

4327 
sb
->
s_exp‹t_›
 = &
pxt4_exp‹t_›s
;

4328 
sb
->
s_x©å
 = 
pxt4_x©å_h™dÀrs
;

4329 #ifde‡
CONFIG_FS_ENCRYPTION


4330 
sb
->
s_c›
 = &
pxt4_¸y±›s
;

4332 #ifde‡
CONFIG_FS_VERITY


4333 
sb
->
s_v›
 = &
pxt4_vîôy›s
;

4335 #ifde‡
CONFIG_QUOTA


4336 
sb
->
dq_›
 = &
pxt4_quŸa_›î©i⁄s
;

4337 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
))

4338 
sb
->
s_qc›
 = &
dquŸ_quŸa˘l_sysfûe_›s
;

4340 
sb
->
s_qc›
 = &
pxt4_q˘l_›î©i⁄s
;

4341 
sb
->
s_quŸa_ty≥s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4343 
	`mem˝y
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4345 
	`INIT_LIST_HEAD
(&
sbi
->
s_‹ph™
);

4346 
	`muãx_öô
(&
sbi
->
s_‹ph™_lock
);

4348 
sb
->
s_roŸ
 = 
NULL
;

4350 
√eds_ªcovîy
 = (
es
->
s_œ°_‹ph™
 != 0 ||

4351 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
));

4353 i‡(
	`pxt4_has_„©uª_mmp
(
sb
Ë&& !
	`sb_rd⁄ly
(sb))

4354 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
, 
	`À64_to_˝u
(
es
->
s_mmp_block
)))

4355 
Áûed_mou¡3a
;

4361 i‡(!
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb)) {

4362 
îr
 = 
	`pxt4_lﬂd_jou∫Æ
(
sb
, 
es
, 
jou∫Æ_devnum
);

4363 i‡(
îr
)

4364 
Áûed_mou¡3a
;

4365 } i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& !
	`sb_rd⁄ly
(sb) &&

4366 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4367 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "required journalÑecovery "

4369 
Áûed_mou¡_wq
;

4372 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4373 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4375 
Áûed_mou¡_wq
;

4377 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4378 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4380 
Áûed_mou¡_wq
;

4382 i‡(
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4383 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4385 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

4386 
Áûed_mou¡_wq
;

4388 i‡(
PXT4_MOUNT_DATA_FLAGS
 &

4389 (
sbi
->
s_mou¡_›t
 ^ sbi->
s_def_mou¡_›t
)) {

4390 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4392 
Áûed_mou¡_wq
;

4394 
sbi
->
s_def_mou¡_›t
 &~
PXT4_MOUNT_JOURNAL_CHECKSUM
;

4395 
	`˛ór_›t
(
sb
, 
JOURNAL_CHECKSUM
);

4396 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

4397 
sbi
->
s_jou∫Æ
 = 
NULL
;

4398 
√eds_ªcovîy
 = 0;

4399 
no_jou∫Æ
;

4402 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

4403 !
	`jbd3_jou∫Æ_£t_„©uªs
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, 0, 0,

4404 
JBD3_FEATURE_INCOMPAT_64BIT
)) {

4405 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set 64-bit journal feature");

4406 
Áûed_mou¡_wq
;

4409 i‡(!
	`£t_jou∫Æ_csum_„©uª_£t
(
sb
)) {

4410 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set journal checksum "

4412 
Áûed_mou¡_wq
;

4417 
	`ã°_›t
(
sb
, 
DATA_FLAGS
)) {

4423 i‡(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4424 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4425 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

4426 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_ORDERED_DATA
;

4428 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

4429 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_JOURNAL_DATA
;

4433 
PXT4_MOUNT_ORDERED_DATA
:

4434 
PXT4_MOUNT_WRITEBACK_DATA
:

4435 i‡(!
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4436 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4437 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Journal doesÇot support "

4439 
Áûed_mou¡_wq
;

4445 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
 &&

4446 
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4447 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4449 
Áûed_mou¡_wq
;

4452 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

4454 
sbi
->
s_jou∫Æ
->
j_commô_ˇŒback
 = 
pxt4_jou∫Æ_commô_ˇŒback
;

4456 
no_jou∫Æ
:

4457 i‡(!
	`ã°_›t
(
sb
, 
NO_MBCACHE
)) {

4458 
sbi
->
s_ó_block_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4459 i‡(!
sbi
->
s_ó_block_ˇche
) {

4460 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4462 
Áûed_mou¡_wq
;

4465 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

4466 
sbi
->
s_ó_öode_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4467 i‡(!
sbi
->
s_ó_öode_ˇche
) {

4468 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4470 
Áûed_mou¡_wq
;

4475 i‡(
	`pxt4_has_„©uª_vîôy
(
sb
Ë&& 
blocksize
 !
PAGE_SIZE
) {

4476 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unsupported blocksize for fs-verity");

4477 
Áûed_mou¡_wq
;

4480 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë&& !
	`sb_rd⁄ly
(
sb
) &&

4481 !
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

4482 
	`pxt4_£t_„©uª_í¸y±
(
sb
);

4483 
	`pxt4_commô_su≥r
(
sb
, 1);

4490 i‡(
es
->
s_ovîhód_˛u°îs
)

4491 
sbi
->
s_ovîhód
 = 
	`À32_to_˝u
(
es
->
s_ovîhód_˛u°îs
);

4493 
îr
 = 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

4494 i‡(
îr
)

4495 
Áûed_mou¡_wq
;

4502 
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
 =

4503 
	`Æloc_w‹kqueue
("pxt4-rsv-c⁄vîsi⁄", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4504 i‡(!
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
) {

4505 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: failedÅo create workqueue\n");

4506 
ªt
 = -
ENOMEM
;

4507 
Áûed_mou¡4
;

4515 
roŸ
 = 
	`pxt4_igë
(
sb
, 
PXT4_ROOT_INO
, 
PXT4_IGET_SPECIAL
);

4516 i‡(
	`IS_ERR
(
roŸ
)) {

4517 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

4518 
ªt
 = 
	`PTR_ERR
(
roŸ
);

4519 
roŸ
 = 
NULL
;

4520 
Áûed_mou¡4
;

4522 i‡(!
	`S_ISDIR
(
roŸ
->
i_mode
Ë|| !roŸ->
i_blocks
 || !roŸ->
i_size
) {

4523 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "corruptÑoot inode,ÑunÉ2fsck");

4524 
	`ùut
(
roŸ
);

4525 
Áûed_mou¡4
;

4528 #ifde‡
CONFIG_UNICODE


4529 i‡(
sbi
->
s_ícodög
)

4530 
sb
->
s_d_›
 = &
pxt4_díåy_›s
;

4533 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ
);

4534 i‡(!
sb
->
s_roŸ
) {

4535 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot dentry failed");

4536 
ªt
 = -
ENOMEM
;

4537 
Áûed_mou¡4
;

4540 
ªt
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 
	`sb_rd⁄ly
(sb));

4541 i‡(
ªt
 =-
EROFS
) {

4542 
sb
->
s_Êags
 |
SB_RDONLY
;

4543 
ªt
 = 0;

4544 } i‡(
ªt
)

4545 
Áûed_mou¡4a
;

4547 
	`pxt4_£t_ªsv_˛u°îs
(
sb
);

4549 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

4550 i‡(
îr
) {

4551 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize system "

4552 "z⁄ê(%d)", 
îr
);

4553 
Áûed_mou¡4a
;

4556 
	`pxt4_ext_öô
(
sb
);

4557 
îr
 = 
	`pxt4_mb_öô
(
sb
);

4558 i‡(
îr
) {

4559 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize mballoc (%d)",

4560 
îr
);

4561 
Áûed_mou¡5
;

4564 
block
 = 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
);

4565 
	`pxt4_‰ì_blocks_cou¡_£t
(
sbi
->
s_es
,

4566 
	`PXT4_C2B
(
sbi
, 
block
));

4567 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4568 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
block
,

4569 
GFP_KERNEL
);

4570 i‡(!
îr
) {

4571 
‰ìi
 = 
	`pxt4_cou¡_‰ì_öodes
(
sb
);

4572 
sbi
->
s_es
->
s_‰ì_öodes_cou¡
 = 
	`˝u_to_À32
(
‰ìi
);

4573 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4574 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ìöodes_cou¡î
, 
‰ìi
,

4575 
GFP_KERNEL
);

4577 i‡(!
îr
)

4578 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dús_cou¡î
,

4579 
	`pxt4_cou¡_dús
(
sb
), 
GFP_KERNEL
);

4580 i‡(!
îr
)

4581 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 0,

4582 
GFP_KERNEL
);

4583 i‡(!
îr
)

4584 
îr
 = 
	`≥r˝u_öô_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4586 i‡(
îr
) {

4587 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4588 
Áûed_mou¡6
;

4591 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

4592 i‡(!
	`pxt4_fûl_Êex_öfo
(
sb
)) {

4593 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4596 
Áûed_mou¡6
;

4599 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

4600 i‡(
îr
)

4601 
Áûed_mou¡6
;

4603 
îr
 = 
	`pxt4_ªgi°î_sysfs
(
sb
);

4604 i‡(
îr
)

4605 
Áûed_mou¡7
;

4607 #ifde‡
CONFIG_QUOTA


4609 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
	`sb_rd⁄ly
(sb)) {

4610 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

4611 i‡(
îr
)

4612 
Áûed_mou¡8
;

4616 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ORPHAN_FS
;

4617 
	`pxt4_‹ph™_˛ónup
(
sb
, 
es
);

4618 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 &~
PXT4_ORPHAN_FS
;

4619 i‡(
√eds_ªcovîy
) {

4620 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4621 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

4623 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

4624 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

4625 
des¸
 = " journalled data mode";

4626 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

4627 
des¸
 = " ordered data mode";

4629 
des¸
 = " writeback data mode";

4631 
des¸
 = "out journal";

4633 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4634 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

4635 i‡(!
	`blk_queue_disˇrd
(
q
))

4636 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4641 i‡(
	`___øãlimô
(&
pxt4_mou¡_msg_øãlimô
, "PXT4-fs mount"))

4642 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4643 "O±s: %.*s%s%s", 
des¸
,

4644 (Ë(
sbi
->
s_es
->
s_mou¡_›ts
),

4645 
sbi
->
s_es
->
s_mou¡_›ts
,

4646 *
sbi
->
s_es
->
s_mou¡_›ts
 ? "; " : "", 
‹ig_d©a
);

4648 i‡(
es
->
s_îr‹_cou¡
)

4649 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 300*
HZ
);

4652 
	`øãlimô_°©e_öô
(&
sbi
->
s_îr_øãlimô_°©e
, 5 * 
HZ
, 10);

4653 
	`øãlimô_°©e_öô
(&
sbi
->
s_w¨nög_øãlimô_°©e
, 5 * 
HZ
, 10);

4654 
	`øãlimô_°©e_öô
(&
sbi
->
s_msg_øãlimô_°©e
, 5 * 
HZ
, 10);

4656 
	`k‰ì
(
‹ig_d©a
);

4659 
ˇ¡föd_pxt4
:

4660 i‡(!
sûít
)

4661 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findÖxt4 filesystem");

4662 
Áûed_mou¡
;

4664 #ifde‡
CONFIG_QUOTA


4665 
Áûed_mou¡8
:

4666 
	`pxt4_uƒegi°î_sysfs
(
sb
);

4668 
Áûed_mou¡7
:

4669 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

4670 
Áûed_mou¡6
:

4671 
	`pxt4_mb_ªÀa£
(
sb
);

4672 
	`rcu_ªad_lock
();

4673 
Êex_groups
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_Êex_groups
);

4674 i‡(
Êex_groups
) {

4675 
i
 = 0; i < 
sbi
->
s_Êex_groups_Æloˇãd
; i++)

4676 
	`kv‰ì
(
Êex_groups
[
i
]);

4677 
	`kv‰ì
(
Êex_groups
);

4679 
	`rcu_ªad_u∆ock
();

4680 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

4681 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

4682 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

4683 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

4684 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_wrôïages_rw£m
);

4685 
Áûed_mou¡5
:

4686 
	`pxt4_ext_ªÀa£
(
sb
);

4687 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

4688 
Áûed_mou¡4a
:

4689 
	`dput
(
sb
->
s_roŸ
);

4690 
sb
->
s_roŸ
 = 
NULL
;

4691 
Áûed_mou¡4
:

4692 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4693 i‡(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
)

4694 
	`de°roy_w‹kqueue
(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
);

4695 
Áûed_mou¡_wq
:

4696 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

4697 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

4699 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

4700 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

4702 i‡(
sbi
->
s_jou∫Æ
) {

4703 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

4704 
sbi
->
s_jou∫Æ
 = 
NULL
;

4706 
Áûed_mou¡3a
:

4707 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

4708 
Áûed_mou¡3
:

4709 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

4710 i‡(
sbi
->
s_mmp_tsk
)

4711 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

4712 
Áûed_mou¡2
:

4713 
	`rcu_ªad_lock
();

4714 
group_desc
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_group_desc
);

4715 
i
 = 0; i < 
db_cou¡
; i++)

4716 
	`bªl£
(
group_desc
[
i
]);

4717 
	`kv‰ì
(
group_desc
);

4718 
	`rcu_ªad_u∆ock
();

4719 
Áûed_mou¡
:

4720 i‡(
sbi
->
s_chksum_drivî
)

4721 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

4723 #ifde‡
CONFIG_UNICODE


4724 
	`utf8_u∆ﬂd
(
sbi
->
s_ícodög
);

4727 #ifde‡
CONFIG_QUOTA


4728 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

4729 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

4731 
	`pxt4_blkdev_ªmove
(
sbi
);

4732 
	`bªl£
(
bh
);

4733 
out_Áû
:

4734 
sb
->
s_fs_öfo
 = 
NULL
;

4735 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

4736 
out_‰ì_ba£
:

4737 
	`k‰ì
(
sbi
);

4738 
	`k‰ì
(
‹ig_d©a
);

4739 
	`fs_put_dax
(
dax_dev
);

4740  
îr
 ?Éº : 
ªt
;

4741 
	}
}

4748 
	$pxt4_öô_jou∫Æ_∑øms
(
su≥r_block
 *
sb
, 
jou∫Æ_t
 *
jou∫Æ
)

4750 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4752 
jou∫Æ
->
j_commô_öãrvÆ
 = 
sbi
->
s_commô_öãrvÆ
;

4753 
jou∫Æ
->
j_mö_b©ch_time
 = 
sbi
->
s_mö_b©ch_time
;

4754 
jou∫Æ
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4756 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

4757 i‡(
	`ã°_›t
(
sb
, 
BARRIER
))

4758 
jou∫Æ
->
j_Êags
 |
JBD3_BARRIER
;

4760 
jou∫Æ
->
j_Êags
 &~
JBD3_BARRIER
;

4761 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

4762 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT_ON_SYNCDATA_ERR
;

4764 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT_ON_SYNCDATA_ERR
;

4765 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4766 
	}
}

4768 
öode
 *
	$pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

4769 
jou∫Æ_öum
)

4771 
öode
 *
jou∫Æ_öode
;

4778 
jou∫Æ_öode
 = 
	`pxt4_igë
(
sb
, 
jou∫Æ_öum
, 
PXT4_IGET_SPECIAL
);

4779 i‡(
	`IS_ERR
(
jou∫Æ_öode
)) {

4780 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4781  
NULL
;

4783 i‡(!
jou∫Æ_öode
->
i_∆ök
) {

4784 
	`make_bad_öode
(
jou∫Æ_öode
);

4785 
	`ùut
(
jou∫Æ_öode
);

4786 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4787  
NULL
;

4790 
	`jbd_debug
(2, "Journal inode foundát %p: %lld bytes\n",

4791 
jou∫Æ_öode
, jou∫Æ_öode->
i_size
);

4792 i‡(!
	`S_ISREG
(
jou∫Æ_öode
->
i_mode
)) {

4793 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4794 
	`ùut
(
jou∫Æ_öode
);

4795  
NULL
;

4797  
jou∫Æ_öode
;

4798 
	}
}

4800 
jou∫Æ_t
 *
	$pxt4_gë_jou∫Æ
(
su≥r_block
 *
sb
,

4801 
jou∫Æ_öum
)

4803 
öode
 *
jou∫Æ_öode
;

4804 
jou∫Æ_t
 *
jou∫Æ
;

4806 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4808 
jou∫Æ_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
jou∫Æ_öum
);

4809 i‡(!
jou∫Æ_öode
)

4810  
NULL
;

4812 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_öode
(
jou∫Æ_öode
);

4813 i‡(!
jou∫Æ
) {

4814 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CouldÇotÜoad journal inode");

4815 
	`ùut
(
jou∫Æ_öode
);

4816  
NULL
;

4818 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4819 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4820  
jou∫Æ
;

4821 
	}
}

4823 
jou∫Æ_t
 *
	$pxt4_gë_dev_jou∫Æ
(
su≥r_block
 *
sb
,

4824 
dev_t
 
j_dev
)

4826 
buf„r_hód
 *
bh
;

4827 
jou∫Æ_t
 *
jou∫Æ
;

4828 
pxt4_fsblk_t
 
°¨t
;

4829 
pxt4_fsblk_t
 
Àn
;

4830 
hblock
, 
blocksize
;

4831 
pxt4_fsblk_t
 
sb_block
;

4832 
off£t
;

4833 
pxt4_su≥r_block
 *
es
;

4834 
block_devi˚
 *
bdev
;

4836 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4838 
bdev
 = 
	`pxt4_blkdev_gë
(
j_dev
, 
sb
);

4839 i‡(
bdev
 =
NULL
)

4840  
NULL
;

4842 
blocksize
 = 
sb
->
s_blocksize
;

4843 
hblock
 = 
	`bdev_logiˇl_block_size
(
bdev
);

4844 i‡(
blocksize
 < 
hblock
) {

4845 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4847 
out_bdev
;

4850 
sb_block
 = 
PXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4851 
off£t
 = 
PXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4852 
	`£t_blocksize
(
bdev
, 
blocksize
);

4853 i‡(!(
bh
 = 
	`__bªad
(
bdev
, 
sb_block
, 
blocksize
))) {

4854 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn'tÑead superblock of "

4856 
out_bdev
;

4859 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

4860 i‡((
	`À16_to_˝u
(
es
->
s_magic
Ë!
PXT4_SUPER_MAGIC
) ||

4861 !(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

4862 
PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4863 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4865 
	`bªl£
(
bh
);

4866 
out_bdev
;

4869 i‡((
	`À32_to_˝u
(
es
->
s_„©uª_ro_com∑t
) &

4870 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4871 
es
->
s_checksum
 !
	`pxt4_su≥rblock_csum
(
sb
,És)) {

4872 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4874 
	`bªl£
(
bh
);

4875 
out_bdev
;

4878 i‡(
	`memcmp
(
	`PXT4_SB
(
sb
)->
s_es
->
s_jou∫Æ_uuid
, 
es
->
s_uuid
, 16)) {

4879 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal UUID doesÇot match");

4880 
	`bªl£
(
bh
);

4881 
out_bdev
;

4884 
Àn
 = 
	`pxt4_blocks_cou¡
(
es
);

4885 
°¨t
 = 
sb_block
 + 1;

4886 
	`bªl£
(
bh
);

4888 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_dev
(
bdev
, 
sb
->
s_bdev
,

4889 
°¨t
, 
Àn
, 
blocksize
);

4890 i‡(!
jou∫Æ
) {

4891 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo create device journal");

4892 
out_bdev
;

4894 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4895 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jou∫Æ
->
j_sb_buf„r
);

4896 
	`waô_⁄_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

4897 i‡(!
	`buf„r_u±od©e
(
jou∫Æ
->
j_sb_buf„r
)) {

4898 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror on journal device");

4899 
out_jou∫Æ
;

4901 i‡(
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
) != 1) {

4902 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "External journal has moreÅhan one "

4904 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
));

4905 
out_jou∫Æ
;

4907 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 = 
bdev
;

4908 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4909  
jou∫Æ
;

4911 
out_jou∫Æ
:

4912 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4913 
out_bdev
:

4914 
	`pxt4_blkdev_put
(
bdev
);

4915  
NULL
;

4916 
	}
}

4918 
	$pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *
sb
,

4919 
pxt4_su≥r_block
 *
es
,

4920 
jou∫Æ_devnum
)

4922 
jou∫Æ_t
 *
jou∫Æ
;

4923 
jou∫Æ_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

4924 
dev_t
 
jou∫Æ_dev
;

4925 
îr
 = 0;

4926 
ªÆly_ªad_⁄ly
;

4928 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4930 i‡(
jou∫Æ_devnum
 &&

4931 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4932 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4934 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
jou∫Æ_devnum
);

4936 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
));

4938 
ªÆly_ªad_⁄ly
 = 
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
);

4945 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4946 i‡(
	`sb_rd⁄ly
(
sb
)) {

4947 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "INFO:Ñecovery "

4949 i‡(
ªÆly_ªad_⁄ly
) {

4950 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

4953  -
EROFS
;

4955 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "writeáccess will "

4960 i‡(
jou∫Æ_öum
 && 
jou∫Æ_dev
) {

4961 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem has both journal "

4963  -
EINVAL
;

4966 i‡(
jou∫Æ_öum
) {

4967 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_jou∫Æ
(
sb
, 
jou∫Æ_öum
)))

4968  -
EINVAL
;

4970 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_dev_jou∫Æ
(
sb
, 
jou∫Æ_dev
)))

4971  -
EINVAL
;

4974 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

4975 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

4977 i‡(!
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
))

4978 
îr
 = 
	`jbd3_jou∫Æ_wùe
(
jou∫Æ
, !
ªÆly_ªad_⁄ly
);

4979 i‡(!
îr
) {

4980 *
ßve
 = 
	`kmÆloc
(
PXT4_S_ERR_LEN
, 
GFP_KERNEL
);

4981 i‡(
ßve
)

4982 
	`mem˝y
(
ßve
, ((*Ë
es
) +

4983 
PXT4_S_ERR_START
, 
PXT4_S_ERR_LEN
);

4984 
îr
 = 
	`jbd3_jou∫Æ_lﬂd
(
jou∫Æ
);

4985 i‡(
ßve
)

4986 
	`mem˝y
(((*Ë
es
Ë+ 
PXT4_S_ERR_START
,

4987 
ßve
, 
PXT4_S_ERR_LEN
);

4988 
	`k‰ì
(
ßve
);

4991 i‡(
îr
) {

4992 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "errorÜoading journal");

4993 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4994  
îr
;

4997 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
jou∫Æ
;

4998 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5000 i‡(!
ªÆly_ªad_⁄ly
 && 
jou∫Æ_devnum
 &&

5001 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

5002 
es
->
s_jou∫Æ_dev
 = 
	`˝u_to_À32
(
jou∫Æ_devnum
);

5005 
	`pxt4_commô_su≥r
(
sb
, 1);

5009 
	}
}

5011 
	$pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
)

5013 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

5014 
buf„r_hód
 *
sbh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

5015 
îr‹
 = 0;

5017 i‡(!
sbh
 || 
	`block_devi˚_eje˘ed
(
sb
))

5018  
îr‹
;

5024 i‡(!
	`buf„r_m≠≥d
(
sbh
))

5025  
îr‹
;

5037 i‡(!(
sb
->
s_Êags
 & 
SB_RDONLY
))

5038 
	`pxt4_upd©e_t°amp
(
es
, 
s_wtime
);

5039 i‡(
sb
->
s_bdev
->
bd_∑π
)

5040 
es
->
s_kbyãs_wrôãn
 =

5041 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
 +

5042 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

5043 
£˘‹s
[
STAT_WRITE
]) -

5044 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1));

5046 
es
->
s_kbyãs_wrôãn
 =

5047 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
);

5048 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
))

5049 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
,

5050 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
	`≥r˝u_cou¡î_sum_posôive
(

5051 &
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
)));

5052 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
))

5053 
es
->
s_‰ì_öodes_cou¡
 =

5054 
	`˝u_to_À32
(
	`≥r˝u_cou¡î_sum_posôive
(

5055 &
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
));

5056 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

5057 
	`pxt4_su≥rblock_csum_£t
(
sb
);

5058 i‡(
sync
)

5059 
	`lock_buf„r
(
sbh
);

5060 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
Ë|| !
	`buf„r_u±od©e
(sbh)) {

5069 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "previous I/OÉrrorÅo "

5071 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5072 
	`£t_buf„r_u±od©e
(
sbh
);

5074 
	`m¨k_buf„r_dúty
(
sbh
);

5075 i‡(
sync
) {

5076 
	`u∆ock_buf„r
(
sbh
);

5077 
îr‹
 = 
	`__sync_dúty_buf„r
(
sbh
,

5078 
REQ_SYNC
 | (
	`ã°_›t
(
sb
, 
BARRIER
Ë? 
REQ_FUA
 : 0));

5079 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
)) {

5080 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror while writing "

5082 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

5083 
	`£t_buf„r_u±od©e
(
sbh
);

5086  
îr‹
;

5087 
	}
}

5094 
	$pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

5095 
pxt4_su≥r_block
 *
es
)

5097 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5099 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

5100 
	`BUG_ON
(
jou∫Æ
 !
NULL
);

5103 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5104 i‡(
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
) < 0)

5105 
out
;

5107 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
Ë&& 
	`sb_rd⁄ly
(sb)) {

5108 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5109 
	`pxt4_commô_su≥r
(
sb
, 1);

5112 
out
:

5113 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5114 
	}
}

5121 
	$pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

5122 
pxt4_su≥r_block
 *
es
)

5124 
jou∫Æ_t
 *
jou∫Æ
;

5125 
j_î∫o
;

5126 c⁄° *
îr°r
;

5128 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

5130 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5137 
j_î∫o
 = 
	`jbd3_jou∫Æ_î∫o
(
jou∫Æ
);

5138 i‡(
j_î∫o
) {

5139 
nbuf
[16];

5141 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
j_î∫o
, 
nbuf
);

5142 
	`pxt4_w¨nög
(
sb
, "FilesystemÉrrorÑecorded "

5143 "‰omÖªviou†mou¡: %s", 
îr°r
);

5144 
	`pxt4_w¨nög
(
sb
, "Marking fs inÇeed of filesystem check.");

5146 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

5147 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

5148 
	`pxt4_commô_su≥r
(
sb
, 1);

5150 
	`jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ
);

5151 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

5153 
	}
}

5159 
	$pxt4_f‹˚_commô
(
su≥r_block
 *
sb
)

5161 
jou∫Æ_t
 *
jou∫Æ
;

5163 i‡(
	`sb_rd⁄ly
(
sb
))

5166 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5167  
	`pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

5168 
	}
}

5170 
	$pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

5172 
ªt
 = 0;

5173 
tid_t
 
èrgë
;

5174 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

5175 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5177 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

5180 
	`åa˚_pxt4_sync_fs
(
sb
, 
waô
);

5181 
	`Êush_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

5186 
	`dquŸ_wrôeback_dquŸs
(
sb
, -1);

5192 i‡(
sbi
->
s_jou∫Æ
) {

5193 
èrgë
 = 
	`jbd3_gë_œã°_å™ß˘i⁄
(
sbi
->
s_jou∫Æ
);

5194 i‡(
waô
 && 
sbi
->
s_jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

5195 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
sbi
->
s_jou∫Æ
, 
èrgë
))

5196 
√eds_b¨rõr
 = 
åue
;

5198 i‡(
	`jbd3_jou∫Æ_°¨t_commô
(
sbi
->
s_jou∫Æ
, &
èrgë
)) {

5199 i‡(
waô
)

5200 
ªt
 = 
	`jbd3_log_waô_commô
(
sbi
->
s_jou∫Æ
,

5201 
èrgë
);

5203 } i‡(
waô
 && 
	`ã°_›t
(
sb
, 
BARRIER
))

5204 
√eds_b¨rõr
 = 
åue
;

5205 i‡(
√eds_b¨rõr
) {

5206 
îr
;

5207 
îr
 = 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5208 i‡(!
ªt
)

5209 
ªt
 = 
îr
;

5212  
ªt
;

5213 
	}
}

5223 
	$pxt4_‰ìze
(
su≥r_block
 *
sb
)

5225 
îr‹
 = 0;

5226 
jou∫Æ_t
 *
jou∫Æ
;

5228 i‡(
	`sb_rd⁄ly
(
sb
))

5231 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5233 i‡(
jou∫Æ
) {

5235 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5241 
îr‹
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5242 i‡(
îr‹
 < 0)

5243 
out
;

5246 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5249 
îr‹
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5250 
out
:

5251 i‡(
jou∫Æ
)

5253 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5254  
îr‹
;

5255 
	}
}

5261 
	$pxt4_un‰ìze
(
su≥r_block
 *
sb
)

5263 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(sb)))

5266 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

5268 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5271 
	`pxt4_commô_su≥r
(
sb
, 1);

5273 
	}
}

5278 
	spxt4_mou¡_›ti⁄s
 {

5279 
	ms_mou¡_›t
;

5280 
	ms_mou¡_›t2
;

5281 
kuid_t
 
	ms_ªsuid
;

5282 
kgid_t
 
	ms_ªsgid
;

5283 
	ms_commô_öãrvÆ
;

5284 
u32
 
	ms_mö_b©ch_time
, 
	ms_max_b©ch_time
;

5285 #ifde‡
CONFIG_QUOTA


5286 
	ms_jquŸa_fmt
;

5287 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

5291 
	$pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

5293 
pxt4_su≥r_block
 *
es
;

5294 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5295 
ﬁd_sb_Êags
;

5296 
pxt4_mou¡_›ti⁄s
 
ﬁd_›ts
;

5297 
íabÀ_quŸa
 = 0;

5298 
pxt4_group_t
 
g
;

5299 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5300 
îr
 = 0;

5301 #ifde‡
CONFIG_QUOTA


5302 
i
, 
j
;

5303 *
to_‰ì
[
PXT4_MAXQUOTAS
];

5305 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

5307 i‡(
d©a
 && !
‹ig_d©a
)

5308  -
ENOMEM
;

5311 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

5312 
ﬁd_›ts
.
s_mou¡_›t
 = 
sbi
->s_mount_opt;

5313 
ﬁd_›ts
.
s_mou¡_›t2
 = 
sbi
->s_mount_opt2;

5314 
ﬁd_›ts
.
s_ªsuid
 = 
sbi
->s_resuid;

5315 
ﬁd_›ts
.
s_ªsgid
 = 
sbi
->s_resgid;

5316 
ﬁd_›ts
.
s_commô_öãrvÆ
 = 
sbi
->s_commit_interval;

5317 
ﬁd_›ts
.
s_mö_b©ch_time
 = 
sbi
->s_min_batch_time;

5318 
ﬁd_›ts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5319 #ifde‡
CONFIG_QUOTA


5320 
ﬁd_›ts
.
s_jquŸa_fmt
 = 
sbi
->s_jquota_fmt;

5321 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5322 i‡(
sbi
->
s_qf_«mes
[
i
]) {

5323 *
qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
i
);

5325 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
	`k°rdup
(
qf_«me
, 
GFP_KERNEL
);

5326 i‡(!
ﬁd_›ts
.
s_qf_«mes
[
i
]) {

5327 
j
 = 0; j < 
i
; j++)

5328 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
j
]);

5329 
	`k‰ì
(
‹ig_d©a
);

5330  -
ENOMEM
;

5333 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
NULL
;

5335 i‡(
sbi
->
s_jou∫Æ
 && sbi->s_jou∫Æ->
j_èsk
->
io_c⁄ãxt
)

5336 
jou∫Æ_i›rio
 = 
sbi
->
s_jou∫Æ
->
j_èsk
->
io_c⁄ãxt
->
i›rio
;

5338 i‡(!
	`∑r£_›ti⁄s
(
d©a
, 
sb
, 
NULL
, &
jou∫Æ_i›rio
, 1)) {

5339 
îr
 = -
EINVAL
;

5340 
ª°‹e_›ts
;

5343 i‡((
ﬁd_›ts
.
s_mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5344 
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

5345 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5347 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_JOURNAL_CHECKSUM
;

5350 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

5351 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5352 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5354 
îr
 = -
EINVAL
;

5355 
ª°‹e_›ts
;

5357 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

5358 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5360 
îr
 = -
EINVAL
;

5361 
ª°‹e_›ts
;

5363 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

5364 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5366 
îr
 = -
EINVAL
;

5367 
ª°‹e_›ts
;

5369 } i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
) {

5370 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5371 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5373 
îr
 = -
EINVAL
;

5374 
ª°‹e_›ts
;

5378 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_NO_MBCACHE
) {

5379 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tÉnableÇombcache duringÑemount");

5380 
îr
 = -
EINVAL
;

5381 
ª°‹e_›ts
;

5384 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_DAX
) {

5385 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning:Ñefusing change of "

5387 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_DAX
;

5390 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

5391 
	`pxt4_ab‹t
(
sb
, "Abort forced by user");

5393 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

5394 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

5396 
es
 = 
sbi
->
s_es
;

5398 i‡(
sbi
->
s_jou∫Æ
) {

5399 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
sbi
->
s_jou∫Æ
);

5400 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

5403 i‡(*
Êags
 & 
SB_LAZYTIME
)

5404 
sb
->
s_Êags
 |
SB_LAZYTIME
;

5406 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë!
	`sb_rd⁄ly
(
sb
)) {

5407 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
) {

5408 
îr
 = -
EROFS
;

5409 
ª°‹e_›ts
;

5412 i‡(*
Êags
 & 
SB_RDONLY
) {

5413 
îr
 = 
	`sync_fûesy°em
(
sb
);

5414 i‡(
îr
 < 0)

5415 
ª°‹e_›ts
;

5416 
îr
 = 
	`dquŸ_su•íd
(
sb
, -1);

5417 i‡(
îr
 < 0)

5418 
ª°‹e_›ts
;

5424 
sb
->
s_Êags
 |
SB_RDONLY
;

5431 i‡(!(
es
->
s_°©e
 & 
	`˝u_to_À16
(
PXT4_VALID_FS
)) &&

5432 (
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

5433 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

5435 i‡(
sbi
->
s_jou∫Æ
)

5436 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

5437 i‡(
sbi
->
s_mmp_tsk
)

5438 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

5441 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
) ||

5442 !
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

5443 
îr
 = -
EROFS
;

5444 
ª°‹e_›ts
;

5450 
g
 = 0; g < 
sbi
->
s_groups_cou¡
; g++) {

5451 
pxt4_group_desc
 *
gdp
 =

5452 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

5454 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
g
, 
gdp
)) {

5455 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

5457 
g
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, g, 
gdp
)),

5458 
	`À16_to_˝u
(
gdp
->
bg_checksum
));

5459 
îr
 = -
EFSBADCRC
;

5460 
ª°‹e_›ts
;

5469 i‡(
es
->
s_œ°_‹ph™
) {

5470 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5474 
îr
 = -
EINVAL
;

5475 
ª°‹e_›ts
;

5484 i‡(
sbi
->
s_jou∫Æ
)

5485 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5486 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

5488 
îr
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 0);

5489 i‡(
îr
)

5490 
ª°‹e_›ts
;

5492 
sb
->
s_Êags
 &~
SB_RDONLY
;

5493 i‡(
	`pxt4_has_„©uª_mmp
(
sb
))

5494 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
,

5495 
	`À64_to_˝u
(
es
->
s_mmp_block
))) {

5496 
îr
 = -
EROFS
;

5497 
ª°‹e_›ts
;

5499 
íabÀ_quŸa
 = 1;

5507 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`ã°_›t
(sb, 
INIT_INODE_TABLE
))

5508 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

5510 
pxt4_group_t
 
fú°_nŸ_zî€d
;

5511 
fú°_nŸ_zî€d
 = 
	`pxt4_has_unöô_ôabÀ
(
sb
);

5512 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

5515 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

5516 i‡(
sbi
->
s_jou∫Æ
 =
NULL
 && !(
ﬁd_sb_Êags
 & 
SB_RDONLY
)) {

5517 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5518 i‡(
îr
)

5519 
ª°‹e_›ts
;

5522 #ifde‡
CONFIG_QUOTA


5524 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5525 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
i
]);

5526 i‡(
íabÀ_quŸa
) {

5527 i‡(
	`sb_™y_quŸa_su•íded
(
sb
))

5528 
	`dquŸ_ªsume
(
sb
, -1);

5529 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

5530 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

5531 i‡(
îr
)

5532 
ª°‹e_›ts
;

5537 *
Êags
 = (*Êag†& ~
SB_LAZYTIME
Ë| (
sb
->
s_Êags
 & SB_LAZYTIME);

5538 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "ª-mou¡ed. O±s: %s", 
‹ig_d©a
);

5539 
	`k‰ì
(
‹ig_d©a
);

5542 
ª°‹e_›ts
:

5543 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

5544 
sbi
->
s_mou¡_›t
 = 
ﬁd_›ts
.s_mount_opt;

5545 
sbi
->
s_mou¡_›t2
 = 
ﬁd_›ts
.s_mount_opt2;

5546 
sbi
->
s_ªsuid
 = 
ﬁd_›ts
.s_resuid;

5547 
sbi
->
s_ªsgid
 = 
ﬁd_›ts
.s_resgid;

5548 
sbi
->
s_commô_öãrvÆ
 = 
ﬁd_›ts
.s_commit_interval;

5549 
sbi
->
s_mö_b©ch_time
 = 
ﬁd_›ts
.s_min_batch_time;

5550 
sbi
->
s_max_b©ch_time
 = 
ﬁd_›ts
.s_max_batch_time;

5551 #ifde‡
CONFIG_QUOTA


5552 
sbi
->
s_jquŸa_fmt
 = 
ﬁd_›ts
.s_jquota_fmt;

5553 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

5554 
to_‰ì
[
i
] = 
	`gë_qf_«me
(
sb
, 
sbi
, i);

5555 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
i
], 
ﬁd_›ts
.s_qf_names[i]);

5557 
	`synchr⁄ize_rcu
();

5558 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5559 
	`k‰ì
(
to_‰ì
[
i
]);

5561 
	`k‰ì
(
‹ig_d©a
);

5562  
îr
;

5563 
	}
}

5565 #ifde‡
CONFIG_QUOTA


5566 
	$pxt4_°©fs_¥oje˘
(
su≥r_block
 *
sb
,

5567 
k¥ojid_t
 
¥ojid
, 
k°©fs
 *
buf
)

5569 
kqid
 
qid
;

5570 
dquŸ
 *dquot;

5571 
u64
 
limô
;

5572 
u64
 
curblock
;

5574 
qid
 = 
	`make_kqid_¥ojid
(
¥ojid
);

5575 
dquŸ
 = 
	`dqgë
(
sb
, 
qid
);

5576 i‡(
	`IS_ERR
(
dquŸ
))

5577  
	`PTR_ERR
(
dquŸ
);

5578 
	`•ö_lock
(&
dquŸ
->
dq_dqb_lock
);

5580 
limô
 = 0;

5581 i‡(
dquŸ
->
dq_dqb
.
dqb_bso·limô
 &&

5582 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bso·limô
 <Üimit))

5583 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bso·limô
;

5584 i‡(
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 &&

5585 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
 <Üimit))

5586 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
;

5587 
limô
 >>
sb
->
s_blocksize_bôs
;

5589 i‡(
limô
 && 
buf
->
f_blocks
 >Üimit) {

5590 
curblock
 = (
dquŸ
->
dq_dqb
.
dqb_cur•a˚
 +

5591 
dquŸ
->
dq_dqb
.
dqb_rsv•a˚
Ë>> 
sb
->
s_blocksize_bôs
;

5592 
buf
->
f_blocks
 = 
limô
;

5593 
buf
->
f_b‰ì
 = buf->
f_bavaû
 =

5594 (
buf
->
f_blocks
 > 
curblock
) ?

5595 (
buf
->
f_blocks
 - 
curblock
) : 0;

5598 
limô
 = 0;

5599 i‡(
dquŸ
->
dq_dqb
.
dqb_iso·limô
 &&

5600 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 <Üimit))

5601 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_iso·limô
;

5602 i‡(
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 &&

5603 (!
limô
 || 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
 <Üimit))

5604 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
;

5606 i‡(
limô
 && 
buf
->
f_fûes
 >Üimit) {

5607 
buf
->
f_fûes
 = 
limô
;

5608 
buf
->
f_f‰ì
 =

5609 (
buf
->
f_fûes
 > 
dquŸ
->
dq_dqb
.
dqb_curöodes
) ?

5610 (
buf
->
f_fûes
 - 
dquŸ
->
dq_dqb
.
dqb_curöodes
) : 0;

5613 
	`•ö_u∆ock
(&
dquŸ
->
dq_dqb_lock
);

5614 
	`dqput
(
dquŸ
);

5616 
	}
}

5619 
	$pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

5621 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

5622 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5623 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

5624 
pxt4_fsblk_t
 
ovîhód
 = 0, 
ªsv_blocks
;

5625 
u64
 
fsid
;

5626 
s64
 
b‰ì
;

5627 
ªsv_blocks
 = 
	`PXT4_C2B
(
sbi
, 
	`©omic64_ªad
(&sbi->
s_ªsv_˛u°îs
));

5629 i‡(!
	`ã°_›t
(
sb
, 
MINIX_DF
))

5630 
ovîhód
 = 
sbi
->
s_ovîhód
;

5632 
buf
->
f_ty≥
 = 
PXT4_SUPER_MAGIC
;

5633 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5634 
buf
->
f_blocks
 = 
	`pxt4_blocks_cou¡
(
es
Ë- 
	`PXT4_C2B
(
sbi
, 
ovîhód
);

5635 
b‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
) -

5636 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

5638 
buf
->
f_b‰ì
 = 
	`PXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
b‰ì
, 0));

5639 
buf
->
f_bavaû
 = buf->
f_b‰ì
 -

5640 (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
);

5641 i‡(
buf
->
f_b‰ì
 < (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
))

5642 
buf
->
f_bavaû
 = 0;

5643 
buf
->
f_fûes
 = 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
);

5644 
buf
->
f_f‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

5645 
buf
->
f_«mñí
 = 
PXT4_NAME_LEN
;

5646 
fsid
 = 
	`À64_to_˝up
((*)
es
->
s_uuid
) ^

5647 
	`À64_to_˝up
((*)
es
->
s_uuid
 + (
u64
));

5648 
buf
->
f_fsid
.
vÆ
[0] = 
fsid
 & 0xFFFFFFFFUL;

5649 
buf
->
f_fsid
.
vÆ
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5651 #ifde‡
CONFIG_QUOTA


5652 i‡(
	`pxt4_ã°_öode_Êag
(
díåy
->
d_öode
, 
PXT4_INODE_PROJINHERIT
) &&

5653 
	`sb_has_quŸa_limôs_íabÀd
(
sb
, 
PRJQUOTA
))

5654 
	`pxt4_°©fs_¥oje˘
(
sb
, 
	`PXT4_I
(
díåy
->
d_öode
)->
i_¥ojid
, 
buf
);

5657 
	}
}

5660 #ifde‡
CONFIG_QUOTA


5666 
ölöe
 
öode
 *
	$dquŸ_to_öode
(
dquŸ
 *dquot)

5668  
	`sb_dq›t
(
dquŸ
->
dq_sb
)->
fûes
[dquŸ->
dq_id
.
ty≥
];

5669 
	}
}

5671 
	$pxt4_wrôe_dquŸ
(
dquŸ
 *dquot)

5673 
ªt
, 
îr
;

5674 
h™dÀ_t
 *
h™dÀ
;

5675 
öode
 *inode;

5677 
öode
 = 
	`dquŸ_to_öode
(
dquŸ
);

5678 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5679 
	`PXT4_QUOTA_TRANS_BLOCKS
(
dquŸ
->
dq_sb
));

5680 i‡(
	`IS_ERR
(
h™dÀ
))

5681  
	`PTR_ERR
(
h™dÀ
);

5682 
ªt
 = 
	`dquŸ_commô
(
dquŸ
);

5683 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5684 i‡(!
ªt
)

5685 
ªt
 = 
îr
;

5686  
ªt
;

5687 
	}
}

5689 
	$pxt4_acquúe_dquŸ
(
dquŸ
 *dquot)

5691 
ªt
, 
îr
;

5692 
h™dÀ_t
 *
h™dÀ
;

5694 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5695 
	`PXT4_QUOTA_INIT_BLOCKS
(
dquŸ
->
dq_sb
));

5696 i‡(
	`IS_ERR
(
h™dÀ
))

5697  
	`PTR_ERR
(
h™dÀ
);

5698 
ªt
 = 
	`dquŸ_acquúe
(
dquŸ
);

5699 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5700 i‡(!
ªt
)

5701 
ªt
 = 
îr
;

5702  
ªt
;

5703 
	}
}

5705 
	$pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot)

5707 
ªt
, 
îr
;

5708 
h™dÀ_t
 *
h™dÀ
;

5710 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5711 
	`PXT4_QUOTA_DEL_BLOCKS
(
dquŸ
->
dq_sb
));

5712 i‡(
	`IS_ERR
(
h™dÀ
)) {

5714 
	`dquŸ_ªÀa£
(
dquŸ
);

5715  
	`PTR_ERR
(
h™dÀ
);

5717 
ªt
 = 
	`dquŸ_ªÀa£
(
dquŸ
);

5718 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5719 i‡(!
ªt
)

5720 
ªt
 = 
îr
;

5721  
ªt
;

5722 
	}
}

5724 
	$pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot)

5726 
su≥r_block
 *
sb
 = 
dquŸ
->
dq_sb
;

5727 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5730 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
) ||

5731 
sbi
->
s_qf_«mes
[
USRQUOTA
] || sbi->s_qf_«mes[
GRPQUOTA
]) {

5732 
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5733  
	`pxt4_wrôe_dquŸ
(
dquŸ
);

5735  
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5737 
	}
}

5739 
	$pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
)

5741 
ªt
, 
îr
;

5742 
h™dÀ_t
 *
h™dÀ
;

5745 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`d_öode
(
sb
->
s_roŸ
), 
PXT4_HT_QUOTA
, 2);

5746 i‡(
	`IS_ERR
(
h™dÀ
))

5747  
	`PTR_ERR
(
h™dÀ
);

5748 
ªt
 = 
	`dquŸ_commô_öfo
(
sb
, 
ty≥
);

5749 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5750 i‡(!
ªt
)

5751 
ªt
 = 
îr
;

5752  
ªt
;

5753 
	}
}

5759 
	$pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
)

5761  
	`dquŸ_quŸa_⁄_mou¡
(
sb
, 
	`gë_qf_«me
(sb, 
	`PXT4_SB
(sb), 
ty≥
),

5762 
	`PXT4_SB
(
sb
)->
s_jquŸa_fmt
, 
ty≥
);

5763 
	}
}

5765 
	$lockdï_£t_quŸa_öode
(
öode
 *öode, 
sub˛ass
)

5767 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5775 (Ë
ei
;

5776 
	`lockdï_£t_sub˛ass
(&
ei
->
i_d©a_£m
, 
sub˛ass
);

5777 
	}
}

5782 
	$pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5783 c⁄° 
∑th
 *path)

5785 
îr
;

5787 i‡(!
	`ã°_›t
(
sb
, 
QUOTA
))

5788  -
EINVAL
;

5791 i‡(
∑th
->
díåy
->
d_sb
 !
sb
)

5792  -
EXDEV
;

5794 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
ty≥
]) {

5796 i‡(
∑th
->
díåy
->
d_∑ª¡
 !
sb
->
s_roŸ
)

5797 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

5800 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_NOLIST_DIRTY
;

5806 
	`sb_dq›t
(
sb
)->
Êags
 &~
DQUOT_NOLIST_DIRTY
;

5813 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

5814 
	`pxt4_should_jou∫Æ_d©a
(
	`d_öode
(
∑th
->
díåy
))) {

5819 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5820 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5821 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5822 i‡(
îr
)

5823  
îr
;

5826 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
, 
I_DATA_SEM_QUOTA
);

5827 
îr
 = 
	`dquŸ_quŸa_⁄
(
sb
, 
ty≥
, 
f‹m©_id
, 
∑th
);

5828 i‡(
îr
) {

5829 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
,

5830 
I_DATA_SEM_NORMAL
);

5832 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5833 
h™dÀ_t
 *
h™dÀ
;

5840 
	`öode_lock
(
öode
);

5841 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5842 i‡(
	`IS_ERR
(
h™dÀ
))

5843 
u∆ock_öode
;

5844 
	`PXT4_I
(
öode
)->
i_Êags
 |
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
;

5845 
	`öode_£t_Êags
(
öode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5846 
S_NOATIME
 | 
S_IMMUTABLE
);

5847 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5848 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5849 
u∆ock_öode
:

5850 
	`öode_u∆ock
(
öode
);

5852  
îr
;

5853 
	}
}

5855 
	$pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5856 
Êags
)

5858 
îr
;

5859 
öode
 *
qf_öode
;

5860 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5861 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5862 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5863 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5866 
	`BUG_ON
(!
	`pxt4_has_„©uª_quŸa
(
sb
));

5868 i‡(!
qf_öums
[
ty≥
])

5869  -
EPERM
;

5871 
qf_öode
 = 
	`pxt4_igë
(
sb
, 
qf_öums
[
ty≥
], 
PXT4_IGET_SPECIAL
);

5872 i‡(
	`IS_ERR
(
qf_öode
)) {

5873 
	`pxt4_îr‹
(
sb
, "Bad quŸ®öodê# %lu", 
qf_öums
[
ty≥
]);

5874  
	`PTR_ERR
(
qf_öode
);

5878 
qf_öode
->
i_Êags
 |
S_NOQUOTA
;

5879 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_QUOTA
);

5880 
îr
 = 
	`dquŸ_lﬂd_quŸa_öode
(
qf_öode
, 
ty≥
, 
f‹m©_id
, 
Êags
);

5881 i‡(
îr
)

5882 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_NORMAL
);

5883 
	`ùut
(
qf_öode
);

5885  
îr
;

5886 
	}
}

5889 
	$pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
)

5891 
ty≥
, 
îr
 = 0;

5892 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5893 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5894 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5895 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5897 
boﬁ
 
quŸa_m›t
[
PXT4_MAXQUOTAS
] = {

5898 
	`ã°_›t
(
sb
, 
USRQUOTA
),

5899 
	`ã°_›t
(
sb
, 
GRPQUOTA
),

5900 
	`ã°_›t
(
sb
, 
PRJQUOTA
),

5903 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5904 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++) {

5905 i‡(
qf_öums
[
ty≥
]) {

5906 
îr
 = 
	`pxt4_quŸa_íabÀ
(
sb
, 
ty≥
, 
QFMT_VFS_V1
,

5907 
DQUOT_USAGE_ENABLED
 |

5908 (
quŸa_m›t
[
ty≥
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5909 i‡(
îr
) {

5910 
	`pxt4_w¨nög
(
sb
,

5913 "e2fsckÅÿfix.", 
ty≥
, 
îr
);

5914 
ty≥
--;Åype >= 0;Åype--)

5915 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5917  
îr
;

5922 
	}
}

5924 
	$pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
)

5926 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5927 
h™dÀ_t
 *
h™dÀ
;

5928 
îr
;

5932 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

5933 
	`sync_fûesy°em
(
sb
);

5935 i‡(!
öode
 || !
	`igøb
(inode))

5936 
out
;

5938 
îr
 = 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5939 i‡(
îr
 || 
	`pxt4_has_„©uª_quŸa
(
sb
))

5940 
out_put
;

5942 
	`öode_lock
(
öode
);

5948 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5949 i‡(
	`IS_ERR
(
h™dÀ
))

5950 
out_u∆ock
;

5951 
	`PXT4_I
(
öode
)->
i_Êags
 &~(
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
);

5952 
	`öode_£t_Êags
(
öode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

5953 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5954 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5955 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5956 
out_u∆ock
:

5957 
	`öode_u∆ock
(
öode
);

5958 
out_put
:

5959 
	`lockdï_£t_quŸa_öode
(
öode
, 
I_DATA_SEM_NORMAL
);

5960 
	`ùut
(
öode
);

5961  
îr
;

5962 
out
:

5963  
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5964 
	}
}

5970 
ssize_t
 
	$pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

5971 
size_t
 
Àn
, 
loff_t
 
off
)

5973 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5974 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5975 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5976 
toc›y
;

5977 
size_t
 
t‹ód
;

5978 
buf„r_hód
 *
bh
;

5979 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

5981 i‡(
off
 > 
i_size
)

5983 i‡(
off
+
Àn
 > 
i_size
)

5984 
Àn
 = 
i_size
-
off
;

5985 
t‹ód
 = 
Àn
;

5986 
t‹ód
 > 0) {

5987 
toc›y
 = 
sb
->
s_blocksize
 - 
off£t
 < 
t‹ód
 ?

5988 
sb
->
s_blocksize
 - 
off£t
 : 
t‹ód
;

5989 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
blk
, 0);

5990 i‡(
	`IS_ERR
(
bh
))

5991  
	`PTR_ERR
(
bh
);

5992 i‡(!
bh
)

5993 
	`mem£t
(
d©a
, 0, 
toc›y
);

5995 
	`mem˝y
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
toc›y
);

5996 
	`bªl£
(
bh
);

5997 
off£t
 = 0;

5998 
t‹ód
 -
toc›y
;

5999 
d©a
 +
toc›y
;

6000 
blk
++;

6002  
Àn
;

6003 
	}
}

6007 
ssize_t
 
	$pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

6008 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
)

6010 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

6011 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

6012 
îr
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

6013 
ªåõs
 = 0;

6014 
buf„r_hód
 *
bh
;

6015 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

6017 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 && !
h™dÀ
) {

6018 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6020 ()
off
, ()
Àn
);

6021  -
EIO
;

6027 i‡(
sb
->
s_blocksize
 - 
off£t
 < 
Àn
) {

6028 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

6030 ()
off
, ()
Àn
);

6031  -
EIO
;

6035 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, 
blk
,

6036 
PXT4_GET_BLOCKS_CREATE
 |

6037 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

6038 } 
	`IS_ERR
(
bh
Ë&& (
	`PTR_ERR
(bhË=-
ENOSPC
) &&

6039 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6040 i‡(
	`IS_ERR
(
bh
))

6041  
	`PTR_ERR
(
bh
);

6042 i‡(!
bh
)

6043 
out
;

6044 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

6045 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

6046 i‡(
îr
) {

6047 
	`bªl£
(
bh
);

6048  
îr
;

6050 
	`lock_buf„r
(
bh
);

6051 
	`mem˝y
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Àn
);

6052 
	`Êush_dˇche_∑ge
(
bh
->
b_∑ge
);

6053 
	`u∆ock_buf„r
(
bh
);

6054 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

6055 
	`bªl£
(
bh
);

6056 
out
:

6057 i‡(
öode
->
i_size
 < 
off
 + 
Àn
) {

6058 
	`i_size_wrôe
(
öode
, 
off
 + 
Àn
);

6059 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

6060 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6062  
Àn
;

6063 
	}
}

6066 
díåy
 *
	$pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

6067 c⁄° *
dev_«me
, *
d©a
)

6069  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
pxt4_fûl_su≥r
);

6070 
	}
}

6072 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

6073 
ölöe
 
	$ªgi°î_as_pxt2
()

6075 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6076 i‡(
îr
)

6077 
	`¥ötk
(
KERN_WARNING


6078 "PXT4-fs: U«bÀÅÿªgi°îá†pxt2 (%d)\n", 
îr
);

6079 
	}
}

6081 
ölöe
 
	$uƒegi°î_as_pxt2
()

6083 
	`uƒegi°î_fûesy°em
(&
pxt2_fs_ty≥
);

6084 
	}
}

6086 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6088 i‡(
	`pxt4_has_unknown_pxt2_öcom∑t_„©uªs
(
sb
))

6090 i‡(
	`sb_rd⁄ly
(
sb
))

6092 i‡(
	`pxt4_has_unknown_pxt2_ro_com∑t_„©uªs
(
sb
))

6095 
	}
}

6097 
ölöe
 
	$ªgi°î_as_pxt2
(Ë{ 
	}
}

6098 
ölöe
 
	$uƒegi°î_as_pxt2
(Ë{ 
	}
}

6099 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
Ë{  0; 
	}
}

6102 
ölöe
 
	$ªgi°î_as_ext3
()

6104 
îr
 = 
	`ªgi°î_fûesy°em
(&
ext3_fs_ty≥
);

6105 i‡(
îr
)

6106 
	`¥ötk
(
KERN_WARNING


6107 "PXT4-fs: U«bÀÅÿªgi°îá†ext3 (%d)\n", 
îr
);

6108 
	}
}

6110 
ölöe
 
	$uƒegi°î_as_ext3
()

6112 
	`uƒegi°î_fûesy°em
(&
ext3_fs_ty≥
);

6113 
	}
}

6115 
ölöe
 
	$ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
)

6117 i‡(
	`pxt4_has_unknown_ext3_öcom∑t_„©uªs
(
sb
))

6119 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
))

6121 i‡(
	`sb_rd⁄ly
(
sb
))

6123 i‡(
	`pxt4_has_unknown_ext3_ro_com∑t_„©uªs
(
sb
))

6126 
	}
}

6128 
fûe_sy°em_ty≥
 
	gpxt4_fs_ty≥
 = {

6129 .
ow√r
 = 
THIS_MODULE
,

6130 .
	g«me
 = "pxt4",

6131 .
	gmou¡
 = 
pxt4_mou¡
,

6132 .
	gkûl_sb
 = 
kûl_block_su≥r
,

6133 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

6135 
MODULE_ALIAS_FS
("pxt4");

6138 
waô_queue_hód_t
 
	gpxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

6140 
__öô
 
	$pxt4_öô_fs
()

6142 
i
, 
îr
;

6144 
	`øãlimô_°©e_öô
(&
pxt4_mou¡_msg_øãlimô
, 30 * 
HZ
, 64);

6145 
pxt4_li_öfo
 = 
NULL
;

6146 
	`muãx_öô
(&
pxt4_li_mtx
);

6149 
	`pxt4_check_Êag_vÆues
();

6151 
i
 = 0; i < 
PXT4_WQ_HASH_SZ
; i++)

6152 
	`öô_waôqueue_hód
(&
pxt4__i€nd_wq
[
i
]);

6154 
îr
 = 
	`pxt4_öô_es
();

6155 i‡(
îr
)

6156  
îr
;

6158 
îr
 = 
	`pxt4_öô_≥ndög
();

6159 i‡(
îr
)

6160 
out7
;

6162 
îr
 = 
	`pxt4_öô_po°_ªad_¥o˚ssög
();

6163 i‡(
îr
)

6164 
out6
;

6166 
îr
 = 
	`pxt4_öô_∑geio
();

6167 i‡(
îr
)

6168 
out5
;

6170 
îr
 = 
	`pxt4_öô_sy°em_z⁄e
();

6171 i‡(
îr
)

6172 
out4
;

6174 
îr
 = 
	`pxt4_öô_sysfs
();

6175 i‡(
îr
)

6176 
out3
;

6178 
îr
 = 
	`pxt4_öô_mbÆloc
();

6179 i‡(
îr
)

6180 
out2
;

6181 
îr
 = 
	`öô_öodeˇche
();

6182 i‡(
îr
)

6183 
out1
;

6184 
	`ªgi°î_as_ext3
();

6185 
	`ªgi°î_as_pxt2
();

6186 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6187 i‡(
îr
)

6188 
out
;

6191 
out
:

6192 
	`uƒegi°î_as_pxt2
();

6193 
	`uƒegi°î_as_ext3
();

6194 
	`de°roy_öodeˇche
();

6195 
out1
:

6196 
	`pxt4_exô_mbÆloc
();

6197 
out2
:

6198 
	`pxt4_exô_sysfs
();

6199 
out3
:

6200 
	`pxt4_exô_sy°em_z⁄e
();

6201 
out4
:

6202 
	`pxt4_exô_∑geio
();

6203 
out5
:

6204 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6205 
out6
:

6206 
	`pxt4_exô_≥ndög
();

6207 
out7
:

6208 
	`pxt4_exô_es
();

6210  
îr
;

6211 
	}
}

6213 
__exô
 
	$pxt4_exô_fs
()

6215 
	`pxt4_de°roy_œzyöô_thªad
();

6216 
	`uƒegi°î_as_pxt2
();

6217 
	`uƒegi°î_as_ext3
();

6218 
	`uƒegi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6219 
	`de°roy_öodeˇche
();

6220 
	`pxt4_exô_mbÆloc
();

6221 
	`pxt4_exô_sysfs
();

6222 
	`pxt4_exô_sy°em_z⁄e
();

6223 
	`pxt4_exô_∑geio
();

6224 
	`pxt4_exô_po°_ªad_¥o˚ssög
();

6225 
	`pxt4_exô_es
();

6226 
	`pxt4_exô_≥ndög
();

6227 
	}
}

6229 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'oánd others");

6230 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6231 
MODULE_LICENSE
("GPL");

6232 
MODULE_SOFTDEP
("pre: crc32c");

6233 
	$moduÀ_öô
(
pxt4_öô_fs
)

6234 
	`moduÀ_exô
(
pxt4_exô_fs
)

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~"pxt4.h
"

24 
	~"x©å.h
"

26 c⁄° *
	$pxt4_í¸y±ed_gë_lök
(
díåy
 *dentry,

27 
öode
 *inode,

28 
dñayed_ˇŒ
 *
d⁄e
)

30 
∑ge
 *
˝age
 = 
NULL
;

31 c⁄° *
ˇddr
;

32 
max_size
;

33 c⁄° *
∑ddr
;

35 i‡(!
díåy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

39 
ˇddr
 = 
	`PXT4_I
(
öode
)->
i_d©a
;

40 
max_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

42 
˝age
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 0, 
NULL
);

43 i‡(
	`IS_ERR
(
˝age
))

44  
	`ERR_CAST
(
˝age
);

45 
ˇddr
 = 
	`∑ge_addªss
(
˝age
);

46 
max_size
 = 
öode
->
i_sb
->
s_blocksize
;

49 
∑ddr
 = 
	`fs¸y±_gë_symlök
(
öode
, 
ˇddr
, 
max_size
, 
d⁄e
);

50 i‡(
˝age
)

51 
	`put_∑ge
(
˝age
);

52  
∑ddr
;

53 
	}
}

55 c⁄° 
öode_›î©i⁄s
 
	gpxt4_í¸y±ed_symlök_öode_›î©i⁄s
 = {

56 .
gë_lök
 = 
pxt4_í¸y±ed_gë_lök
,

57 .
	g£èâr
 = 
pxt4_£èâr
,

58 .
	ggë©å
 = 
pxt4_gë©å
,

59 .
	gli°x©å
 = 
pxt4_li°x©å
,

62 c⁄° 
öode_›î©i⁄s
 
	gpxt4_symlök_öode_›î©i⁄s
 = {

63 .
gë_lök
 = 
∑ge_gë_lök
,

64 .
	g£èâr
 = 
pxt4_£èâr
,

65 .
	ggë©å
 = 
pxt4_gë©å
,

66 .
	gli°x©å
 = 
pxt4_li°x©å
,

69 c⁄° 
öode_›î©i⁄s
 
	gpxt4_Á°_symlök_öode_›î©i⁄s
 = {

70 .
gë_lök
 = 
sim∂e_gë_lök
,

71 .
	g£èâr
 = 
pxt4_£èâr
,

72 .
	ggë©å
 = 
pxt4_gë©å
,

73 .
	gli°x©å
 = 
pxt4_li°x©å
,

	@sysfs.c

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/¥oc_fs.h
>

17 
	~"pxt4.h
"

18 
	~"pxt4_jbd3.h
"

21 
	m©å_no›
,

22 
	m©å_dñayed_Æloˇti⁄_blocks
,

23 
	m©å_£ssi⁄_wrôe_kbyãs
,

24 
	m©å_li„time_wrôe_kbyãs
,

25 
	m©å_ª£rved_˛u°îs
,

26 
	m©å_öode_ªadahód
,

27 
	m©å_åiggî_ã°_îr‹
,

28 
	m©å_fú°_îr‹_time
,

29 
	m©å_œ°_îr‹_time
,

30 
	m©å_„©uª
,

31 
	m©å_poöãr_ui
,

32 
	m©å_poöãr_©omic
,

33 
	m©å_jou∫Æ_èsk
,

34 } 
	t©å_id_t
;

37 
	m±r_ex∂icô
,

38 
	m±r_pxt4_sb_öfo_off£t
,

39 
	m±r_pxt4_su≥r_block_off£t
,

40 } 
	t©å_±r_t
;

42 c⁄° 
	g¥oc_dú«me
[] = "fs/pxt4";

43 
¥oc_dú_íåy
 *
	gpxt4_¥oc_roŸ
;

45 
	spxt4_©å
 {

46 
©åibuã
 
	m©å
;

47 
	m©å_id
;

48 
	m©å_±r
;

50 
	moff£t
;

51 *
	mex∂icô_±r
;

52 } 
	mu
;

55 
ssize_t
 
	$£ssi⁄_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

57 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

59 i‡(!
sb
->
s_bdev
->
bd_∑π
)

60  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

61  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lu\n",

62 (
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

63 
£˘‹s
[
STAT_WRITE
]) -

64 
sbi
->
s_£˘‹s_wrôãn_°¨t
) >> 1);

65 
	}
}

67 
ssize_t
 
	$li„time_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

69 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

71 i‡(!
sb
->
s_bdev
->
bd_∑π
)

72  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

73  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

74 ()(
sbi
->
s_kbyãs_wrôãn
 +

75 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

76 
£˘‹s
[
STAT_WRITE
]) -

77 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1)));

78 
	}
}

80 
ssize_t
 
	$öode_ªadahód_blks_°‹e
(
pxt4_sb_öfo
 *
sbi
,

81 c⁄° *
buf
, 
size_t
 
cou¡
)

83 
t
;

84 
ªt
;

86 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

87 i‡(
ªt
)

88  
ªt
;

90 i‡(
t
 && (!
	`is_powî_of_2
(t) ||Å > 0x40000000))

91  -
EINVAL
;

93 
sbi
->
s_öode_ªadahód_blks
 = 
t
;

94  
cou¡
;

95 
	}
}

97 
ssize_t
 
	$ª£rved_˛u°îs_°‹e
(
pxt4_sb_öfo
 *
sbi
,

98 c⁄° *
buf
, 
size_t
 
cou¡
)

100 
vÆ
;

101 
pxt4_fsblk_t
 
˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

102 
sbi
->
s_˛u°î_bôs
);

103 
ªt
;

105 
ªt
 = 
	`k°πouŒ
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

106 i‡(
ªt
 || 
vÆ
 >
˛u°îs
)

107  -
EINVAL
;

109 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
vÆ
);

110  
cou¡
;

111 
	}
}

113 
ssize_t
 
	$åiggî_ã°_îr‹
(
pxt4_sb_öfo
 *
sbi
,

114 c⁄° *
buf
, 
size_t
 
cou¡
)

116 
Àn
 = 
cou¡
;

118 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

119  -
EPERM
;

121 i‡(
Àn
 && 
buf
[len-1] == '\n')

122 
Àn
--;

124 i‡(
Àn
)

125 
	`pxt4_îr‹
(
sbi
->
s_sb
, "%.*s", 
Àn
, 
buf
);

126  
cou¡
;

127 
	}
}

129 
ssize_t
 
	$jou∫Æ_èsk_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

131 i‡(!
sbi
->
s_jou∫Æ
)

132  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "<none>\n");

133  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

134 
	`èsk_pid_vƒ
(
sbi
->
s_jou∫Æ
->
j_èsk
));

135 
	}
}

137 
	#PXT4_ATTR
(
_«me
,
_mode
,
_id
) \

138 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

139 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

140 .
©å_id
 = 
©å_
##
_id
, \

141 }

	)

143 
	#PXT4_ATTR_FUNC
(
_«me
,
_mode
Ë
	`PXT4_ATTR
(_«me,_mode,_«me)

	)

145 
	#PXT4_ATTR_FEATURE
(
_«me
Ë
	`PXT4_ATTR
(_«me, 0444, 
„©uª
)

	)

147 
	#PXT4_ATTR_OFFSET
(
_«me
,
_mode
,
_id
,
_°ru˘
,
_ñ«me
) \

148 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

149 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

150 .
©å_id
 = 
©å_
##
_id
, \

151 .
©å_±r
 = 
±r_
##
_°ru˘
##
_off£t
, \

152 .
u
 = { \

153 .
off£t
 = 
	`off£tof
(
_°ru˘
, 
_ñ«me
),\

155 }

	)

157 
	#PXT4_RO_ATTR_ES_UI
(
_«me
,
_ñ«me
) \

158 
	`PXT4_ATTR_OFFSET
(
_«me
, 0444, 
poöãr_ui
, 
pxt4_su≥r_block
, 
_ñ«me
)

	)

160 
	#PXT4_RW_ATTR_SBI_UI
(
_«me
,
_ñ«me
) \

161 
	`PXT4_ATTR_OFFSET
(
_«me
, 0644, 
poöãr_ui
, 
pxt4_sb_öfo
, 
_ñ«me
)

	)

163 
	#PXT4_ATTR_PTR
(
_«me
,
_mode
,
_id
,
_±r
) \

164 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

165 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

166 .
©å_id
 = 
©å_
##
_id
, \

167 .
©å_±r
 = 
±r_ex∂icô
, \

168 .
u
 = { \

169 .
ex∂icô_±r
 = 
_±r
, \

171 }

	)

173 
	#ATTR_LIST
(
«me
Ë&
pxt4_©å_
##«me.
©å


	)

175 
PXT4_ATTR_FUNC
(
dñayed_Æloˇti⁄_blocks
, 0444);

176 
PXT4_ATTR_FUNC
(
£ssi⁄_wrôe_kbyãs
, 0444);

177 
PXT4_ATTR_FUNC
(
li„time_wrôe_kbyãs
, 0444);

178 
PXT4_ATTR_FUNC
(
ª£rved_˛u°îs
, 0644);

180 
PXT4_ATTR_OFFSET
(
öode_ªadahód_blks
, 0644, 
öode_ªadahód
,

181 
pxt4_sb_öfo
, 
s_öode_ªadahód_blks
);

182 
PXT4_RW_ATTR_SBI_UI
(
öode_gﬂl
, 
s_öode_gﬂl
);

183 
PXT4_RW_ATTR_SBI_UI
(
mb_°©s
, 
s_mb_°©s
);

184 
PXT4_RW_ATTR_SBI_UI
(
mb_max_to_sˇn
, 
s_mb_max_to_sˇn
);

185 
PXT4_RW_ATTR_SBI_UI
(
mb_mö_to_sˇn
, 
s_mb_mö_to_sˇn
);

186 
PXT4_RW_ATTR_SBI_UI
(
mb_‹dî2_ªq
, 
s_mb_‹dî2_ªqs
);

187 
PXT4_RW_ATTR_SBI_UI
(
mb_°ªam_ªq
, 
s_mb_°ªam_ªque°
);

188 
PXT4_RW_ATTR_SBI_UI
(
mb_group_¥óŒoc
, 
s_mb_group_¥óŒoc
);

189 
PXT4_RW_ATTR_SBI_UI
(
exã¡_max_zîoout_kb
, 
s_exã¡_max_zîoout_kb
);

190 
PXT4_ATTR
(
åiggî_fs_îr‹
, 0200, 
åiggî_ã°_îr‹
);

191 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_öãrvÆ_ms
, 
s_îr_øãlimô_°©e
.
öãrvÆ
);

192 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_bur°
, 
s_îr_øãlimô_°©e
.
bur°
);

193 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_öãrvÆ_ms
, 
s_w¨nög_øãlimô_°©e
.
öãrvÆ
);

194 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_bur°
, 
s_w¨nög_øãlimô_°©e
.
bur°
);

195 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_öãrvÆ_ms
, 
s_msg_øãlimô_°©e
.
öãrvÆ
);

196 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_bur°
, 
s_msg_øãlimô_°©e
.
bur°
);

197 
PXT4_RO_ATTR_ES_UI
(
îr‹s_cou¡
, 
s_îr‹_cou¡
);

198 
PXT4_ATTR
(
fú°_îr‹_time
, 0444, first_error_time);

199 
PXT4_ATTR
(
œ°_îr‹_time
, 0444,Üast_error_time);

200 
PXT4_ATTR
(
jou∫Æ_èsk
, 0444, journal_task);

202 
	gﬁd_bump_vÆ
 = 128;

203 
PXT4_ATTR_PTR
(
max_wrôeback_mb_bump
, 0444, 
poöãr_ui
, &
ﬁd_bump_vÆ
);

205 
©åibuã
 *
	gpxt4_©ås
[] = {

206 
ATTR_LIST
(
dñayed_Æloˇti⁄_blocks
),

207 
ATTR_LIST
(
£ssi⁄_wrôe_kbyãs
),

208 
ATTR_LIST
(
li„time_wrôe_kbyãs
),

209 
ATTR_LIST
(
ª£rved_˛u°îs
),

210 
ATTR_LIST
(
öode_ªadahód_blks
),

211 
ATTR_LIST
(
öode_gﬂl
),

212 
ATTR_LIST
(
mb_°©s
),

213 
ATTR_LIST
(
mb_max_to_sˇn
),

214 
ATTR_LIST
(
mb_mö_to_sˇn
),

215 
ATTR_LIST
(
mb_‹dî2_ªq
),

216 
ATTR_LIST
(
mb_°ªam_ªq
),

217 
ATTR_LIST
(
mb_group_¥óŒoc
),

218 
ATTR_LIST
(
max_wrôeback_mb_bump
),

219 
ATTR_LIST
(
exã¡_max_zîoout_kb
),

220 
ATTR_LIST
(
åiggî_fs_îr‹
),

221 
ATTR_LIST
(
îr_øãlimô_öãrvÆ_ms
),

222 
ATTR_LIST
(
îr_øãlimô_bur°
),

223 
ATTR_LIST
(
w¨nög_øãlimô_öãrvÆ_ms
),

224 
ATTR_LIST
(
w¨nög_øãlimô_bur°
),

225 
ATTR_LIST
(
msg_øãlimô_öãrvÆ_ms
),

226 
ATTR_LIST
(
msg_øãlimô_bur°
),

227 
ATTR_LIST
(
îr‹s_cou¡
),

228 
ATTR_LIST
(
fú°_îr‹_time
),

229 
ATTR_LIST
(
œ°_îr‹_time
),

230 
ATTR_LIST
(
jou∫Æ_èsk
),

231 
NULL
,

233 
ATTRIBUTE_GROUPS
(
pxt4
);

236 
PXT4_ATTR_FEATURE
(
œzy_ôabÀ_öô
);

237 
PXT4_ATTR_FEATURE
(
b©ched_disˇrd
);

238 
PXT4_ATTR_FEATURE
(
mëa_bg_ªsize
);

239 #ifde‡
CONFIG_FS_ENCRYPTION


240 
PXT4_ATTR_FEATURE
(
í¸y±i⁄
);

242 #ifde‡
CONFIG_UNICODE


243 
PXT4_ATTR_FEATURE
(
ˇ£fﬁd
);

245 #ifde‡
CONFIG_FS_VERITY


246 
PXT4_ATTR_FEATURE
(
vîôy
);

248 
PXT4_ATTR_FEATURE
(
mëad©a_csum_£ed
);

250 
©åibuã
 *
	gpxt4_„©_©ås
[] = {

251 
ATTR_LIST
(
œzy_ôabÀ_öô
),

252 
ATTR_LIST
(
b©ched_disˇrd
),

253 
ATTR_LIST
(
mëa_bg_ªsize
),

254 #ifde‡
CONFIG_FS_ENCRYPTION


255 
ATTR_LIST
(
í¸y±i⁄
),

257 #ifde‡
CONFIG_UNICODE


258 
ATTR_LIST
(
ˇ£fﬁd
),

260 #ifde‡
CONFIG_FS_VERITY


261 
ATTR_LIST
(
vîôy
),

263 
ATTR_LIST
(
mëad©a_csum_£ed
),

264 
NULL
,

266 
ATTRIBUTE_GROUPS
(
pxt4_„©
);

268 *
	$ˇlc_±r
(
pxt4_©å
 *
a
, 
pxt4_sb_öfo
 *
sbi
)

270 
a
->
©å_±r
) {

271 
±r_ex∂icô
:

272  
a
->
u
.
ex∂icô_±r
;

273 
±r_pxt4_sb_öfo_off£t
:

274  (*Ë(((*Ë
sbi
Ë+ 
a
->
u
.
off£t
);

275 
±r_pxt4_su≥r_block_off£t
:

276  (*Ë(((*Ë
sbi
->
s_es
Ë+ 
a
->
u
.
off£t
);

278  
NULL
;

279 
	}
}

281 
ssize_t
 
	$__¥öt_t°amp
(*
buf
, 
__À32
 
lo
, 
__u8
 
hi
)

283  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lld",

284 ((
time64_t
)
hi
 << 32Ë+ 
	`À32_to_˝u
(
lo
));

285 
	}
}

287 
	#¥öt_t°amp
(
buf
, 
es
, 
t°amp
) \

288 
	`__¥öt_t°amp
(
buf
, (
es
)->
t°amp
, (es)->t°am∞## 
_hi
)

	)

290 
ssize_t
 
	$pxt4_©å_show
(
kobje˘
 *
kobj
,

291 
©åibuã
 *
©å
, *
buf
)

293 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

294 
s_kobj
);

295 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

296 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

298 
a
->
©å_id
) {

299 
©å_dñayed_Æloˇti⁄_blocks
:

300  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

301 (
s64
Ë
	`PXT4_C2B
(
sbi
,

302 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

303 
©å_£ssi⁄_wrôe_kbyãs
:

304  
	`£ssi⁄_wrôe_kbyãs_show
(
sbi
, 
buf
);

305 
©å_li„time_wrôe_kbyãs
:

306  
	`li„time_wrôe_kbyãs_show
(
sbi
, 
buf
);

307 
©å_ª£rved_˛u°îs
:

308  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

310 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
));

311 
©å_öode_ªadahód
:

312 
©å_poöãr_ui
:

313 i‡(!
±r
)

315 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

316  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

317 
	`À32_to_˝up
(
±r
));

319  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

320 *((*Ë
±r
));

321 
©å_poöãr_©omic
:

322 i‡(!
±r
)

324  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

325 
	`©omic_ªad
((
©omic_t
 *Ë
±r
));

326 
©å_„©uª
:

327  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "supported\n");

328 
©å_fú°_îr‹_time
:

329  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_fú°_îr‹_time
);

330 
©å_œ°_îr‹_time
:

331  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_œ°_îr‹_time
);

332 
©å_jou∫Æ_èsk
:

333  
	`jou∫Æ_èsk_show
(
sbi
, 
buf
);

337 
	}
}

339 
ssize_t
 
	$pxt4_©å_°‹e
(
kobje˘
 *
kobj
,

340 
©åibuã
 *
©å
,

341 c⁄° *
buf
, 
size_t
 
Àn
)

343 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

344 
s_kobj
);

345 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

346 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

347 
t
;

348 
ªt
;

350 
a
->
©å_id
) {

351 
©å_ª£rved_˛u°îs
:

352  
	`ª£rved_˛u°îs_°‹e
(
sbi
, 
buf
, 
Àn
);

353 
©å_poöãr_ui
:

354 i‡(!
±r
)

356 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

357 i‡(
ªt
)

358  
ªt
;

359 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

360 *((
__À32
 *Ë
±r
Ë
	`˝u_to_À32
(
t
);

362 *((*Ë
±r
Ë
t
;

363  
Àn
;

364 
©å_öode_ªadahód
:

365  
	`öode_ªadahód_blks_°‹e
(
sbi
, 
buf
, 
Àn
);

366 
©å_åiggî_ã°_îr‹
:

367  
	`åiggî_ã°_îr‹
(
sbi
, 
buf
, 
Àn
);

370 
	}
}

372 
	$pxt4_sb_ªÀa£
(
kobje˘
 *
kobj
)

374 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

375 
s_kobj
);

376 
	`com∂ëe
(&
sbi
->
s_kobj_uƒegi°î
);

377 
	}
}

379 c⁄° 
sysfs_›s
 
	gpxt4_©å_›s
 = {

380 .
show
 = 
pxt4_©å_show
,

381 .
	g°‹e
 = 
pxt4_©å_°‹e
,

384 
kobj_ty≥
 
	gpxt4_sb_kty≥
 = {

385 .
deÁu…_groups
 = 
pxt4_groups
,

386 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

387 .
	gªÀa£
 = 
pxt4_sb_ªÀa£
,

390 
kobj_ty≥
 
	gpxt4_„©_kty≥
 = {

391 .
deÁu…_groups
 = 
pxt4_„©_groups
,

392 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

393 .
	gªÀa£
 = ((*)(
kobje˘
 *))
k‰ì
,

396 
kobje˘
 *
	gpxt4_roŸ
;

398 
kobje˘
 *
	gpxt4_„©
;

400 
	$pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
)

402 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

403 
îr
;

405 
	`öô_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

406 
îr
 = 
	`kobje˘_öô_™d_add
(&
sbi
->
s_kobj
, &
pxt4_sb_kty≥
, 
pxt4_roŸ
,

407 "%s", 
sb
->
s_id
);

408 i‡(
îr
) {

409 
	`kobje˘_put
(&
sbi
->
s_kobj
);

410 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

411  
îr
;

414 i‡(
pxt4_¥oc_roŸ
)

415 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

416 i‡(
sbi
->
s_¥oc
) {

417 
	`¥oc_¸óã_sögÀ_d©a
("›ti⁄s", 
S_IRUGO
, 
sbi
->
s_¥oc
,

418 
pxt4_£q_›ti⁄s_show
, 
sb
);

419 
	`¥oc_¸óã_sögÀ_d©a
("es_shrökî_öfo", 
S_IRUGO
,

420 
sbi
->
s_¥oc
, 
pxt4_£q_es_shrökî_öfo_show
,

421 
sb
);

422 
	`¥oc_¸óã_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_¥oc
,

423 &
pxt4_mb_£q_groups_›s
, 
sb
);

426 
	}
}

428 
	$pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
)

430 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

432 i‡(
sbi
->
s_¥oc
)

433 
	`ªmove_¥oc_subåì
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

434 
	`kobje˘_dñ
(&
sbi
->
s_kobj
);

435 
	}
}

437 
__öô
 
	$pxt4_öô_sysfs
()

439 
ªt
;

441 
pxt4_roŸ
 = 
	`kobje˘_¸óã_™d_add
("pxt4", 
fs_kobj
);

442 i‡(!
pxt4_roŸ
)

443  -
ENOMEM
;

445 
pxt4_„©
 = 
	`kzÆloc
((*pxt4_„©), 
GFP_KERNEL
);

446 i‡(!
pxt4_„©
) {

447 
ªt
 = -
ENOMEM
;

448 
roŸ_îr
;

451 
ªt
 = 
	`kobje˘_öô_™d_add
(
pxt4_„©
, &
pxt4_„©_kty≥
,

452 
pxt4_roŸ
, "features");

453 i‡(
ªt
)

454 
„©_îr
;

456 
pxt4_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

457  
ªt
;

459 
„©_îr
:

460 
	`kobje˘_put
(
pxt4_„©
);

461 
pxt4_„©
 = 
NULL
;

462 
roŸ_îr
:

463 
	`kobje˘_put
(
pxt4_roŸ
);

464 
pxt4_roŸ
 = 
NULL
;

465  
ªt
;

466 
	}
}

468 
	$pxt4_exô_sysfs
()

470 
	`kobje˘_put
(
pxt4_„©
);

471 
pxt4_„©
 = 
NULL
;

472 
	`kobje˘_put
(
pxt4_roŸ
);

473 
pxt4_roŸ
 = 
NULL
;

474 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

475 
pxt4_¥oc_roŸ
 = 
NULL
;

476 
	}
}

	@truncate.h

12 
ölöe
 
	$pxt4_åunˇã_Áûed_wrôe
(
öode
 *inode)

18 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

19 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

20 
	`pxt4_åunˇã
(
öode
);

21 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

22 
	}
}

28 
ölöe
 
	$pxt4_blocks_f‹_åunˇã
(
öode
 *inode)

30 
pxt4_lblk_t
 
√eded
;

32 
√eded
 = 
öode
->
i_blocks
 >> (öode->
i_sb
->
s_blocksize_bôs
 - 9);

40 i‡(
√eded
 < 2)

41 
√eded
 = 2;

45 i‡(
√eded
 > 
PXT4_MAX_TRANS_DATA
)

46 
√eded
 = 
PXT4_MAX_TRANS_DATA
;

48  
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
Ë+ 
√eded
;

49 
	}
}

	@verity.c

26 
	~<löux/quŸa›s.h
>

28 
	~"pxt4.h
"

29 
	~"pxt4_exã¡s.h
"

30 
	~"pxt4_jbd3.h
"

32 
ölöe
 
loff_t
 
	$pxt4_vîôy_mëad©a_pos
(c⁄° 
öode
 *inode)

34  
	`round_up
(
öode
->
i_size
, 65536);

35 
	}
}

41 
	$∑geˇche_ªad
(
öode
 *öode, *
buf
, 
size_t
 
cou¡
,

42 
loff_t
 
pos
)

44 
cou¡
) {

45 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

46 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

47 
∑ge
 *page;

48 *
addr
;

50 
∑ge
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
pos
 >> 
PAGE_SHIFT
,

51 
NULL
);

52 i‡(
	`IS_ERR
(
∑ge
))

53  
	`PTR_ERR
(
∑ge
);

55 
addr
 = 
	`km≠_©omic
(
∑ge
);

56 
	`mem˝y
(
buf
, 
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
n
);

57 
	`kunm≠_©omic
(
addr
);

59 
	`put_∑ge
(
∑ge
);

61 
buf
 +
n
;

62 
pos
 +
n
;

63 
cou¡
 -
n
;

66 
	}
}

72 
	$∑geˇche_wrôe
(
öode
 *öode, c⁄° *
buf
, 
size_t
 
cou¡
,

73 
loff_t
 
pos
)

75 i‡(
pos
 + 
cou¡
 > 
öode
->
i_sb
->
s_maxbyãs
)

76  -
EFBIG
;

78 
cou¡
) {

79 
size_t
 
n
 = 
	`mö_t
(size_t, 
cou¡
,

80 
PAGE_SIZE
 - 
	`off£t_ö_∑ge
(
pos
));

81 
∑ge
 *page;

82 *
fsd©a
;

83 *
addr
;

84 
ªs
;

86 
ªs
 = 
	`∑geˇche_wrôe_begö
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
, 0,

87 &
∑ge
, &
fsd©a
);

88 i‡(
ªs
)

89  
ªs
;

91 
addr
 = 
	`km≠_©omic
(
∑ge
);

92 
	`mem˝y
(
addr
 + 
	`off£t_ö_∑ge
(
pos
), 
buf
, 
n
);

93 
	`kunm≠_©omic
(
addr
);

95 
ªs
 = 
	`∑geˇche_wrôe_íd
(
NULL
, 
öode
->
i_m≠pög
, 
pos
, 
n
,Ç,

96 
∑ge
, 
fsd©a
);

97 i‡(
ªs
 < 0)

98  
ªs
;

99 i‡(
ªs
 !
n
)

100  -
EIO
;

102 
buf
 +
n
;

103 
pos
 +
n
;

104 
cou¡
 -
n
;

107 
	}
}

109 
	$pxt4_begö_íabÀ_vîôy
(
fûe
 *
fûp
)

111 
öode
 *öodê
	`fûe_öode
(
fûp
);

112 c⁄° 
¸edôs
 = 2;

113 
h™dÀ_t
 *
h™dÀ
;

114 
îr
;

116 i‡(
	`pxt4_vîôy_ö_¥ogªss
(
öode
))

117  -
EBUSY
;

125 
îr
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

126 i‡(
îr
)

127  
îr
;

129 
îr
 = 
	`dquŸ_öôülize
(
öode
);

130 i‡(
îr
)

131  
îr
;

133 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

134 i‡(
îr
)

135  
îr
;

137 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

138 
	`pxt4_w¨nög_öode
(
öode
,

140  -
EOPNOTSUPP
;

147 
îr
 = 
	`pxt4_åunˇã
(
öode
);

148 i‡(
îr
)

149  
îr
;

151 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

152 i‡(
	`IS_ERR
(
h™dÀ
))

153  
	`PTR_ERR
(
h™dÀ
);

155 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

156 i‡(
îr
 == 0)

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

159 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

160  
îr
;

161 
	}
}

175 
	$pxt4_wrôe_vîôy_des¸ùt‹
(
öode
 *öode, c⁄° *
desc
,

176 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

178 c⁄° 
u64
 
desc_pos
 = 
	`round_up
(
	`pxt4_vîôy_mëad©a_pos
(
öode
) +

179 
mîkÀ_åì_size
, 
	`i_blocksize
(
öode
));

180 c⁄° 
u64
 
desc_íd
 = 
desc_pos
 + 
desc_size
;

181 c⁄° 
__À32
 
desc_size_disk
 = 
	`˝u_to_À32
(
desc_size
);

182 c⁄° 
u64
 
desc_size_pos
 = 
	`round_up
(
desc_íd
 + (
desc_size_disk
),

183 
	`i_blocksize
(
öode
)) -

184 (
desc_size_disk
);

185 
îr
;

187 
îr
 = 
	`∑geˇche_wrôe
(
öode
, 
desc
, 
desc_size
, 
desc_pos
);

188 i‡(
îr
)

189  
îr
;

191  
	`∑geˇche_wrôe
(
öode
, &
desc_size_disk
, (desc_size_disk),

192 
desc_size_pos
);

193 
	}
}

195 
	$pxt4_íd_íabÀ_vîôy
(
fûe
 *
fûp
, c⁄° *
desc
,

196 
size_t
 
desc_size
, 
u64
 
mîkÀ_åì_size
)

198 
öode
 *öodê
	`fûe_öode
(
fûp
);

199 c⁄° 
¸edôs
 = 2;

200 
h™dÀ_t
 *
h™dÀ
;

201 
îr
 = 0;

202 
îr2
;

204 i‡(
desc
 !
NULL
) {

206 
îr
 = 
	`pxt4_wrôe_vîôy_des¸ùt‹
(
öode
, 
desc
, 
desc_size
,

207 
mîkÀ_åì_size
);

210 i‡(!
îr
)

211 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

215 i‡(
desc
 =
NULL
 || 
îr
)

216 
	`pxt4_åunˇã
(
öode
);

225 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_VERITY_IN_PROGRESS
);

227 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
¸edôs
);

228 i‡(
	`IS_ERR
(
h™dÀ
)) {

229 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

230  
	`PTR_ERR
(
h™dÀ
);

233 
îr2
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

234 i‡(
îr2
)

235 
out_°›
;

237 i‡(
desc
 !
NULL
 && !
îr
) {

238 
pxt4_ûoc
 
ûoc
;

240 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

241 i‡(
îr
)

242 
out_°›
;

243 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_VERITY
);

244 
	`pxt4_£t_öode_Êags
(
öode
);

245 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

247 
out_°›
:

248 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

249  
îr
 ?: 
îr2
;

250 
	}
}

252 
	$pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
 *inode,

253 
size_t
 *
desc_size_ªt
,

254 
u64
 *
desc_pos_ªt
)

256 
pxt4_ext_∑th
 *
∑th
;

257 
pxt4_exã¡
 *
œ°_exã¡
;

258 
u32
 
íd_lblk
;

259 
u64
 
desc_size_pos
;

260 
__À32
 
desc_size_disk
;

261 
u32
 
desc_size
;

262 
u64
 
desc_pos
;

263 
îr
;

270 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

271 
	`PXT4_ERROR_INODE
(
öode
, "verity file doesn't useÉxtents");

272  -
EFSCORRUPTED
;

275 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
, 0);

276 i‡(
	`IS_ERR
(
∑th
))

277  
	`PTR_ERR
(
∑th
);

279 
œ°_exã¡
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

280 i‡(!
œ°_exã¡
) {

281 
	`PXT4_ERROR_INODE
(
öode
, "verity file hasÇoÉxtents");

282 
	`pxt4_ext_dr›_ªfs
(
∑th
);

283 
	`k‰ì
(
∑th
);

284  -
EFSCORRUPTED
;

287 
íd_lblk
 = 
	`À32_to_˝u
(
œ°_exã¡
->
ì_block
) +

288 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_exã¡
);

289 
desc_size_pos
 = (
u64
)
íd_lblk
 << 
öode
->
i_blkbôs
;

290 
	`pxt4_ext_dr›_ªfs
(
∑th
);

291 
	`k‰ì
(
∑th
);

293 i‡(
desc_size_pos
 < (
desc_size_disk
))

294 
bad
;

295 
desc_size_pos
 -(
desc_size_disk
);

297 
îr
 = 
	`∑geˇche_ªad
(
öode
, &
desc_size_disk
, (desc_size_disk),

298 
desc_size_pos
);

299 i‡(
îr
)

300  
îr
;

301 
desc_size
 = 
	`À32_to_˝u
(
desc_size_disk
);

308 i‡(
desc_size
 > 
INT_MAX
 || desc_sizê> 
desc_size_pos
)

309 
bad
;

311 
desc_pos
 = 
	`round_down
(
desc_size_pos
 - 
desc_size
, 
	`i_blocksize
(
öode
));

312 i‡(
desc_pos
 < 
	`pxt4_vîôy_mëad©a_pos
(
öode
))

313 
bad
;

315 *
desc_size_ªt
 = 
desc_size
;

316 *
desc_pos_ªt
 = 
desc_pos
;

319 
bad
:

320 
	`PXT4_ERROR_INODE
(
öode
, "verity file corrupted; can't find descriptor");

321  -
EFSCORRUPTED
;

322 
	}
}

324 
	$pxt4_gë_vîôy_des¸ùt‹
(
öode
 *öode, *
buf
,

325 
size_t
 
buf_size
)

327 
size_t
 
desc_size
 = 0;

328 
u64
 
desc_pos
 = 0;

329 
îr
;

331 
îr
 = 
	`pxt4_gë_vîôy_des¸ùt‹_loˇti⁄
(
öode
, &
desc_size
, &
desc_pos
);

332 i‡(
îr
)

333  
îr
;

335 i‡(
buf_size
) {

336 i‡(
desc_size
 > 
buf_size
)

337  -
ERANGE
;

338 
îr
 = 
	`∑geˇche_ªad
(
öode
, 
buf
, 
desc_size
, 
desc_pos
);

339 i‡(
îr
)

340  
îr
;

342  
desc_size
;

343 
	}
}

345 
∑ge
 *
	$pxt4_ªad_mîkÀ_åì_∑ge
(
öode
 *inode,

346 
pgoff_t
 
ödex
)

348 
ödex
 +
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë>> 
PAGE_SHIFT
;

350  
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 
ödex
, 
NULL
);

351 
	}
}

353 
	$pxt4_wrôe_mîkÀ_åì_block
(
öode
 *öode, c⁄° *
buf
,

354 
u64
 
ödex
, 
log_blocksize
)

356 
loff_t
 
pos
 = 
	`pxt4_vîôy_mëad©a_pos
(
öode
Ë+ (
ödex
 << 
log_blocksize
);

358  
	`∑geˇche_wrôe
(
öode
, 
buf
, 1 << 
log_blocksize
, 
pos
);

359 
	}
}

361 c⁄° 
fsvîôy_›î©i⁄s
 
	gpxt4_vîôy›s
 = {

362 .
begö_íabÀ_vîôy
 = 
pxt4_begö_íabÀ_vîôy
,

363 .
	gíd_íabÀ_vîôy
 = 
pxt4_íd_íabÀ_vîôy
,

364 .
	ggë_vîôy_des¸ùt‹
 = 
pxt4_gë_vîôy_des¸ùt‹
,

365 .
	gªad_mîkÀ_åì_∑ge
 = 
pxt4_ªad_mîkÀ_åì_∑ge
,

366 .
	gwrôe_mîkÀ_åì_block
 = 
pxt4_wrôe_mîkÀ_åì_block
,

	@xattr.c

54 
	~<löux/öô.h
>

55 
	~<löux/fs.h
>

56 
	~<löux/¶ab.h
>

57 
	~<löux/mbˇche.h
>

58 
	~<löux/quŸa›s.h
>

59 
	~<löux/ivîsi⁄.h
>

60 
	~"pxt4_jbd3.h
"

61 
	~"pxt4.h
"

62 
	~"x©å.h
"

63 
	~"a˛.h
"

65 #ifde‡
PXT4_XATTR_DEBUG


66 
	#ó_idebug
(
öode
, 
fmt
, ...) \

67 
	`¥ötk
(
KERN_DEBUG
 "öodê%s:%lu: " 
fmt
 "\n", \

68 
öode
->
i_sb
->
s_id
, inode->
i_öo
, ##
__VA_ARGS__
)

	)

69 
	#ó_bdebug
(
bh
, 
fmt
, ...) \

70 
	`¥ötk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockƒ
, ##
__VA_ARGS__
)

	)

73 
	#ó_idebug
(
öode
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#ó_bdebug
(
bh
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

77 
pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *,

78 
buf„r_hód
 *);

79 
buf„r_hód
 *

80 
pxt4_x©å_block_ˇche_föd
(
öode
 *, 
pxt4_x©å_hódî
 *,

81 
mb_ˇche_íåy
 **);

82 
__À32
 
pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, __À32 *
vÆue
,

83 
size_t
 
vÆue_cou¡
);

84 
pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *);

86 c⁄° 
x©å_h™dÀr
 * c⁄° 
	gpxt4_x©å_h™dÀr_m≠
[] = {

87 [
PXT4_XATTR_INDEX_USER
] = &
pxt4_x©å_u£r_h™dÀr
,

88 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


89 [
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_a˛_ac˚ss_x©å_h™dÀr
,

90 [
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_a˛_deÁu…_x©å_h™dÀr
,

92 [
PXT4_XATTR_INDEX_TRUSTED
] = &
pxt4_x©å_åu°ed_h™dÀr
,

93 #ifde‡
CONFIG_PXT4_FS_SECURITY


94 [
PXT4_XATTR_INDEX_SECURITY
] = &
pxt4_x©å_£curôy_h™dÀr
,

98 c⁄° 
x©å_h™dÀr
 *
	gpxt4_x©å_h™dÀrs
[] = {

99 &
pxt4_x©å_u£r_h™dÀr
,

100 &
pxt4_x©å_åu°ed_h™dÀr
,

101 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


102 &
posix_a˛_ac˚ss_x©å_h™dÀr
,

103 &
posix_a˛_deÁu…_x©å_h™dÀr
,

105 #ifde‡
CONFIG_PXT4_FS_SECURITY


106 &
pxt4_x©å_£curôy_h™dÀr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

112 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_block_ˇche
)

	)

114 
	#EA_INODE_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

115 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_öode_ˇche
)

	)

118 
pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

119 
öode
 *inode);

121 #ifde‡
CONFIG_LOCKDEP


122 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
)

124 
	`lockdï_£t_sub˛ass
(&
ó_öode
->
i_rw£m
, 1);

125 
	}
}

128 
__À32
 
	$pxt4_x©å_block_csum
(
öode
 *inode,

129 
£˘‹_t
 
block_ƒ
,

130 
pxt4_x©å_hódî
 *
hdr
)

132 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

133 
__u32
 
csum
;

134 
__À64
 
dsk_block_ƒ
 = 
	`˝u_to_À64
(
block_ƒ
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
pxt4_x©å_hódî
, 
h_checksum
);

138 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_ƒ
,

139 (
dsk_block_ƒ
));

140 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +(
dummy_csum
);

143 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

146  
	`˝u_to_À32
(
csum
);

147 
	}
}

149 
	$pxt4_x©å_block_csum_vîify
(
öode
 *inode,

150 
buf„r_hód
 *
bh
)

152 
pxt4_x©å_hódî
 *
hdr
 = 
	`BHDR
(
bh
);

153 
ªt
 = 1;

155 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

156 
	`lock_buf„r
(
bh
);

157 
ªt
 = (
hdr
->
h_checksum
 =
	`pxt4_x©å_block_csum
(
öode
,

158 
bh
->
b_blockƒ
, 
hdr
));

159 
	`u∆ock_buf„r
(
bh
);

161  
ªt
;

162 
	}
}

164 
	$pxt4_x©å_block_csum_£t
(
öode
 *inode,

165 
buf„r_hód
 *
bh
)

167 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`pxt4_x©å_block_csum
(
öode
,

169 
bh
->
b_blockƒ
, 
	`BHDR
(bh));

170 
	}
}

172 
ölöe
 c⁄° 
x©å_h™dÀr
 *

173 
	$pxt4_x©å_h™dÀr
(
«me_ödex
)

175 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 = 
NULL
;

177 i‡(
«me_ödex
 > 0 &&Çame_ödex < 
	`ARRAY_SIZE
(
pxt4_x©å_h™dÀr_m≠
))

178 
h™dÀr
 = 
pxt4_x©å_h™dÀr_m≠
[
«me_ödex
];

179  
h™dÀr
;

180 
	}
}

183 
	$pxt4_x©å_check_íåõs
(
pxt4_x©å_íåy
 *
íåy
, *
íd
,

184 *
vÆue_°¨t
)

186 
pxt4_x©å_íåy
 *
e
 = 
íåy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
pxt4_x©å_íåy
 *
√xt
 = 
	`PXT4_XATTR_NEXT
(
e
);

191 i‡((*)
√xt
 >
íd
)

192  -
EFSCORRUPTED
;

193 i‡(
	`°∫Àn
(
e
->
e_«me
,É->
e_«me_Àn
) !=É->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
√xt
;

199 !
	`IS_LAST_ENTRY
(
íåy
)) {

200 
u32
 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

202 i‡(
size
 > 
PXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 i‡(
size
 !0 && 
íåy
->
e_vÆue_öum
 == 0) {

206 
u16
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

207 *
vÆue
;

215 i‡(
offs
 > 
íd
 - 
vÆue_°¨t
)

216  -
EFSCORRUPTED
;

217 
vÆue
 = 
vÆue_°¨t
 + 
offs
;

218 i‡(
vÆue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
íd
 - 
vÆue
 ||

220 
	`PXT4_XATTR_SIZE
(
size
Ë> 
íd
 - 
vÆue
)

221  -
EFSCORRUPTED
;

223 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
ölöe
 

230 
	$__pxt4_x©å_check_block
(
öode
 *öode, 
buf„r_hód
 *
bh
,

231 c⁄° *
fun˘i⁄
, 
löe
)

233 
îr‹
 = -
EFSCORRUPTED
;

235 i‡(
	`BHDR
(
bh
)->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !
	`˝u_to_À32
(1))

237 
îrout
;

238 i‡(
	`buf„r_vîifõd
(
bh
))

241 
îr‹
 = -
EFSBADCRC
;

242 i‡(!
	`pxt4_x©å_block_csum_vîify
(
öode
, 
bh
))

243 
îrout
;

244 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
îrout
:

247 i‡(
îr‹
)

248 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

250 (Ë
bh
->
b_blockƒ
);

252 
	`£t_buf„r_vîifõd
(
bh
);

253  
îr‹
;

254 
	}
}

256 
	#pxt4_x©å_check_block
(
öode
, 
bh
) \

257 
	`__pxt4_x©å_check_block
((
öode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©å_check_öode
(
öode
 *öode, 
pxt4_x©å_ibody_hódî
 *
hódî
,

262 *
íd
, c⁄° *
fun˘i⁄
, 
löe
)

264 
îr‹
 = -
EFSCORRUPTED
;

266 i‡(
íd
 - (*)
hódî
 < (*hódîË+ (
u32
) ||

267 (
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)))

268 
îrout
;

269 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`IFIRST
(
hódî
), 
íd
, IFIRST(header));

270 
îrout
:

271 i‡(
îr‹
)

272 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

274  
îr‹
;

275 
	}
}

277 
	#x©å_check_öode
(
öode
, 
hódî
, 
íd
) \

278 
	`__x©å_check_öode
((
öode
), (
hódî
), (
íd
), 
__func__
, 
__LINE__
)

	)

281 
	$x©å_föd_íåy
(
öode
 *öode, 
pxt4_x©å_íåy
 **
≥¡ry
,

282 *
íd
, 
«me_ödex
, c⁄° *
«me
, 
s‹ãd
)

284 
pxt4_x©å_íåy
 *
íåy
, *
√xt
;

285 
size_t
 
«me_Àn
;

286 
cmp
 = 1;

288 i‡(
«me
 =
NULL
)

289  -
EINVAL
;

290 
«me_Àn
 = 
	`°æí
(
«me
);

291 
íåy
 = *
≥¡ry
; !
	`IS_LAST_ENTRY
”¡ry);É¡ry = 
√xt
) {

292 
√xt
 = 
	`PXT4_XATTR_NEXT
(
íåy
);

293 i‡((*Ë
√xt
 >
íd
) {

294 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
«me_ödex
 - 
íåy
->
e_«me_ödex
;

298 i‡(!
cmp
)

299 
cmp
 = 
«me_Àn
 - 
íåy
->
e_«me_Àn
;

300 i‡(!
cmp
)

301 
cmp
 = 
	`memcmp
(
«me
, 
íåy
->
e_«me
, 
«me_Àn
);

302 i‡(
cmp
 <0 && (
s‹ãd
 || cmp == 0))

305 *
≥¡ry
 = 
íåy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$pxt4_x©å_öode_hash
(
pxt4_sb_öfo
 *
sbi
, c⁄° *
buf„r
, 
size_t
 
size
)

312  
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
buf„r
, 
size
);

313 
	}
}

315 
u64
 
	$pxt4_x©å_öode_gë_ªf
(
öode
 *
ó_öode
)

317  ((
u64
)
ó_öode
->
i_˘ime
.
tv_£c
 << 32) |

318 (
u32
Ë
	`öode_≥ek_ivîsi⁄_øw
(
ó_öode
);

319 
	}
}

321 
	$pxt4_x©å_öode_£t_ªf
(
öode
 *
ó_öode
, 
u64
 
ªf_cou¡
)

323 
ó_öode
->
i_˘ime
.
tv_£c
 = (
u32
)(
ªf_cou¡
 >> 32);

324 
	`öode_£t_ivîsi⁄_øw
(
ó_öode
, 
ªf_cou¡
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$pxt4_x©å_öode_gë_hash
(
öode
 *
ó_öode
)

329  (
u32
)
ó_öode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$pxt4_x©å_öode_£t_hash
(
öode
 *
ó_öode
, 
u32
 
hash
)

334 
ó_öode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$pxt4_x©å_öode_ªad
(
öode
 *
ó_öode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
ó_öode
->
i_blkbôs
;

343 
bh_cou¡
 = (
size
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

344 
èû_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
buf„r_hód
 *
bhs_ölöe
[8];

346 
buf„r_hód
 **
bhs
 = 
bhs_ölöe
;

347 
i
, 
ªt
;

349 i‡(
bh_cou¡
 > 
	`ARRAY_SIZE
(
bhs_ölöe
)) {

350 
bhs
 = 
	`kmÆloc_¨øy
(
bh_cou¡
, (*bhs), 
GFP_NOFS
);

351 i‡(!
bhs
)

352  -
ENOMEM
;

355 
ªt
 = 
	`pxt4_bªad_b©ch
(
ó_öode
, 0 , 
bh_cou¡
,

356 
åue
 , 
bhs
);

357 i‡(
ªt
)

358 
‰ì_bhs
;

360 
i
 = 0; i < 
bh_cou¡
; i++) {

362 i‡(!
bhs
[
i
]) {

363 
ªt
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`mem˝y
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_cou¡
 - 1 ? 
blocksize
 : 
èû_size
);

369 
ªt
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_cou¡
; i++)

372 
	`bªl£
(
bhs
[
i
]);

373 
‰ì_bhs
:

374 i‡(
bhs
 !
bhs_ölöe
)

375 
	`k‰ì
(
bhs
);

376  
ªt
;

377 
	}
}

379 
	#PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë((
__u32
)(öode)->
i_mtime
.
tv_£c
)

	)

381 
	$pxt4_x©å_öode_igë
(
öode
 *
∑ª¡
, 
ó_öo
,

382 
u32
 
ó_öode_hash
, 
öode
 **
ó_öode
)

384 
öode
 *inode;

385 
îr
;

387 
öode
 = 
	`pxt4_igë
(
∑ª¡
->
i_sb
, 
ó_öo
, 
PXT4_IGET_NORMAL
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

390 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

391 "îr‹ whûêªadög EA inodê%luÉº=%d", 
ó_öo
,

392 
îr
);

393  
îr
;

396 i‡(
	`is_bad_öode
(
öode
)) {

397 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

399 
ó_öo
);

400 
îr
 = -
EIO
;

401 
îr‹
;

404 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

405 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

407 
ó_öo
);

408 
îr
 = -
EINVAL
;

409 
îr‹
;

412 
	`pxt4_x©å_öode_£t_˛ass
(
öode
);

419 i‡(
ó_öode_hash
 !
	`pxt4_x©å_öode_gë_hash
(
öode
) &&

420 
	`PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë=
∑ª¡
->
i_öo
 &&

421 
öode
->
i_gíî©i⁄
 =
∑ª¡
->i_generation) {

422 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_LUSTRE_EA_INODE
);

423 
	`pxt4_x©å_öode_£t_ªf
(
öode
, 1);

425 
	`öode_lock
(
öode
);

426 
öode
->
i_Êags
 |
S_NOQUOTA
;

427 
	`öode_u∆ock
(
öode
);

430 *
ó_öode
 = 
öode
;

432 
îr‹
:

433 
	`ùut
(
öode
);

434  
îr
;

435 
	}
}

438 
	$pxt4_x©å_öode_vîify_hashes
(
öode
 *
ó_öode
,

439 
pxt4_x©å_íåy
 *
íåy
, *
buf„r
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
ó_öode
->
i_sb
), 
buf„r
, 
size
);

446 i‡(
hash
 !
	`pxt4_x©å_öode_gë_hash
(
ó_öode
))

447  -
EFSCORRUPTED
;

449 i‡(
íåy
) {

450 
__À32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`˝u_to_À32
(
hash
);

454 
e_hash
 = 
	`pxt4_x©å_hash_íåy
(
íåy
->
e_«me
,É¡ry->
e_«me_Àn
,

455 &
tmp_d©a
, 1);

456 i‡(
e_hash
 !
íåy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$pxt4_x©å_öode_gë
(
öode
 *öode, 
pxt4_x©å_íåy
 *
íåy
,

467 *
buf„r
, 
size_t
 
size
)

469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

470 
öode
 *
ó_öode
;

471 
îr
;

473 
îr
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

474 
	`À32_to_˝u
(
íåy
->
e_hash
), &
ó_öode
);

475 i‡(
îr
) {

476 
ó_öode
 = 
NULL
;

477 
out
;

480 i‡(
	`i_size_ªad
(
ó_öode
Ë!
size
) {

481 
	`pxt4_w¨nög_öode
(
ó_öode
,

483 
	`i_size_ªad
(
ó_öode
), 
size
);

484 
îr
 = -
EFSCORRUPTED
;

485 
out
;

488 
îr
 = 
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
buf„r
, 
size
);

489 i‡(
îr
)

490 
out
;

492 i‡(!
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
)) {

493 
îr
 = 
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
íåy
, 
buf„r
,

494 
size
);

495 i‡(
îr
) {

496 
	`pxt4_w¨nög_öode
(
ó_öode
,

498 
out
;

501 i‡(
ó_öode_ˇche
)

502 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
, 
GFP_NOFS
,

503 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
),

504 
ó_öode
->
i_öo
, 
åue
 );

506 
out
:

507 
	`ùut
(
ó_öode
);

508  
îr
;

509 
	}
}

512 
	$pxt4_x©å_block_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

513 *
buf„r
, 
size_t
 
buf„r_size
)

515 
buf„r_hód
 *
bh
 = 
NULL
;

516 
pxt4_x©å_íåy
 *
íåy
;

517 
size_t
 
size
;

518 *
íd
;

519 
îr‹
;

520 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

522 
	`ó_idebug
(
öode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
«me_ödex
, 
«me
, 
buf„r
, ()
buf„r_size
);

525 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

526  -
ENODATA
;

527 
	`ó_idebug
(
öode
, "reading block %llu",

528 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

529 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

530 i‡(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

533 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

534 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

535 i‡(
îr‹
)

536 
˛ónup
;

537 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bh
);

538 
íåy
 = 
	`BFIRST
(
bh
);

539 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 1);

541 i‡(
îr‹
)

542 
˛ónup
;

543 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

544 
îr‹
 = -
ERANGE
;

545 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

546 
˛ónup
;

547 i‡(
buf„r
) {

548 i‡(
size
 > 
buf„r_size
)

549 
˛ónup
;

550 i‡(
íåy
->
e_vÆue_öum
) {

551 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

552 
size
);

553 i‡(
îr‹
)

554 
˛ónup
;

556 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

560 
˛ónup
;

561 
	`mem˝y
(
buf„r
, 
p
, 
size
);

564 
îr‹
 = 
size
;

566 
˛ónup
:

567 
	`bªl£
(
bh
);

568  
îr‹
;

569 
	}
}

572 
	$pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

573 *
buf„r
, 
size_t
 
buf„r_size
)

575 
pxt4_x©å_ibody_hódî
 *
hódî
;

576 
pxt4_x©å_íåy
 *
íåy
;

577 
pxt4_öode
 *
øw_öode
;

578 
pxt4_ûoc
 
ûoc
;

579 
size_t
 
size
;

580 *
íd
;

581 
îr‹
;

583 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

586 i‡(
îr‹
)

587  
îr‹
;

588 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

589 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

590 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

591 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

592 i‡(
îr‹
)

593 
˛ónup
;

594 
íåy
 = 
	`IFIRST
(
hódî
);

595 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 0);

596 i‡(
îr‹
)

597 
˛ónup
;

598 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

599 
îr‹
 = -
ERANGE
;

600 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

601 
˛ónup
;

602 i‡(
buf„r
) {

603 i‡(
size
 > 
buf„r_size
)

604 
˛ónup
;

605 i‡(
íåy
->
e_vÆue_öum
) {

606 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

607 
size
);

608 i‡(
îr‹
)

609 
˛ónup
;

611 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

612 *
p
 = (*)
	`IFIRST
(
hódî
Ë+ 
off£t
;

614 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

615 
˛ónup
;

616 
	`mem˝y
(
buf„r
, 
p
, 
size
);

619 
îr‹
 = 
size
;

621 
˛ónup
:

622 
	`bªl£
(
ûoc
.
bh
);

623  
îr‹
;

624 
	}
}

637 
	$pxt4_x©å_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

638 *
buf„r
, 
size_t
 
buf„r_size
)

640 
îr‹
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

643  -
EIO
;

645 i‡(
	`°æí
(
«me
) > 255)

646  -
ERANGE
;

648 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

649 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

650 
buf„r_size
);

651 i‡(
îr‹
 =-
ENODATA
)

652 
îr‹
 = 
	`pxt4_x©å_block_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

653 
buf„r_size
);

654 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

655  
îr‹
;

656 
	}
}

659 
	$pxt4_x©å_li°_íåõs
(
díåy
 *díåy, 
pxt4_x©å_íåy
 *
íåy
,

660 *
buf„r
, 
size_t
 
buf„r_size
)

662 
size_t
 
ª°
 = 
buf„r_size
;

664 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

665 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 =

666 
	`pxt4_x©å_h™dÀr
(
íåy
->
e_«me_ödex
);

668 i‡(
h™dÀr
 && (!h™dÀr->
li°
 || h™dÀr->
	`li°
(
díåy
))) {

669 c⁄° *
¥efix
 = 
h™dÀr
->¥efix ?: h™dÀr->
«me
;

670 
size_t
 
¥efix_Àn
 = 
	`°æí
(
¥efix
);

671 
size_t
 
size
 = 
¥efix_Àn
 + 
íåy
->
e_«me_Àn
 + 1;

673 i‡(
buf„r
) {

674 i‡(
size
 > 
ª°
)

675  -
ERANGE
;

676 
	`mem˝y
(
buf„r
, 
¥efix
, 
¥efix_Àn
);

677 
buf„r
 +
¥efix_Àn
;

678 
	`mem˝y
(
buf„r
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

679 
buf„r
 +
íåy
->
e_«me_Àn
;

680 *
buf„r
++ = 0;

682 
ª°
 -
size
;

685  
buf„r_size
 - 
ª°
;

686 
	}
}

689 
	$pxt4_x©å_block_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

691 
öode
 *öodê
	`d_öode
(
díåy
);

692 
buf„r_hód
 *
bh
 = 
NULL
;

693 
îr‹
;

695 
	`ó_idebug
(
öode
, "buffer=%p, buffer_size=%ld",

696 
buf„r
, ()
buf„r_size
);

698 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

700 
	`ó_idebug
(
öode
, "reading block %llu",

701 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

702 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

703 i‡(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

706 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

707 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

708 i‡(
îr‹
)

709 
˛ónup
;

710 
	`pxt4_x©å_block_ˇche_ö£π
(
	`EA_BLOCK_CACHE
(
öode
), 
bh
);

711 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`BFIRST
(
bh
), 
buf„r
,

712 
buf„r_size
);

713 
˛ónup
:

714 
	`bªl£
(
bh
);

715  
îr‹
;

716 
	}
}

719 
	$pxt4_x©å_ibody_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

721 
öode
 *öodê
	`d_öode
(
díåy
);

722 
pxt4_x©å_ibody_hódî
 *
hódî
;

723 
pxt4_öode
 *
øw_öode
;

724 
pxt4_ûoc
 
ûoc
;

725 *
íd
;

726 
îr‹
;

728 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

730 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

731 i‡(
îr‹
)

732  
îr‹
;

733 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

734 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

735 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

736 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

737 i‡(
îr‹
)

738 
˛ónup
;

739 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`IFIRST
(
hódî
),

740 
buf„r
, 
buf„r_size
);

742 
˛ónup
:

743 
	`bªl£
(
ûoc
.
bh
);

744  
îr‹
;

745 
	}
}

759 
ssize_t


760 
	$pxt4_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

762 
ªt
, 
ªt2
;

764 
	`down_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

765 
ªt
 = 
ªt2
 = 
	`pxt4_x©å_ibody_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

766 i‡(
ªt
 < 0)

767 
îrout
;

768 i‡(
buf„r
) {

769 
buf„r
 +
ªt
;

770 
buf„r_size
 -
ªt
;

772 
ªt
 = 
	`pxt4_x©å_block_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

773 i‡(
ªt
 < 0)

774 
îrout
;

775 
ªt
 +
ªt2
;

776 
îrout
:

777 
	`up_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

778  
ªt
;

779 
	}
}

785 
	$pxt4_x©å_upd©e_su≥r_block
(
h™dÀ_t
 *
h™dÀ
,

786 
su≥r_block
 *
sb
)

788 i‡(
	`pxt4_has_„©uª_x©å
(
sb
))

791 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 i‡(
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`pxt4_£t_„©uª_x©å
(
sb
);

794 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

796 
	}
}

798 
	$pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
)

800 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

801 
buf„r_hód
 *
bh
 = 
NULL
;

802 
pxt4_öode
 *
øw_öode
;

803 
pxt4_x©å_ibody_hódî
 *
hódî
;

804 
pxt4_x©å_íåy
 *
íåy
;

805 
qsize_t
 
ó_öode_ªfs
 = 0;

806 *
íd
;

807 
ªt
;

809 
	`lockdï_as£π_hñd_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

811 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

812 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

813 i‡(
ªt
)

814 
out
;

815 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

816 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

817 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

818 
ªt
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

819 i‡(
ªt
)

820 
out
;

822 
íåy
 = 
	`IFIRST
(
hódî
); !
	`IS_LAST_ENTRY
(entry);

823 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

824 i‡(
íåy
->
e_vÆue_öum
)

825 
ó_öode_ªfs
++;

828 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

829 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

830 i‡(
	`IS_ERR
(
bh
)) {

831 
ªt
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
ªt
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

837 i‡(
ªt
)

838 
out
;

840 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

842 i‡(
íåy
->
e_vÆue_öum
)

843 
ó_öode_ªfs
++;

845 *
ußge
 = 
ó_öode_ªfs
 + 1;

846 
ªt
 = 0;

847 
out
:

848 
	`bªl£
(
ûoc
.
bh
);

849 
	`bªl£
(
bh
);

850  
ªt
;

851 
	}
}

853 
ölöe
 
size_t
 
	$round_up_˛u°î
(
öode
 *öode, 
size_t
 
Àngth
)

855 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

856 
size_t
 
˛u°î_size
 = 1 << (
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
 +

857 
öode
->
i_blkbôs
);

858 
size_t
 
mask
 = ~(
˛u°î_size
 - 1);

860  (
Àngth
 + 
˛u°î_size
 - 1Ë& 
mask
;

861 
	}
}

863 
	$pxt4_x©å_öode_Æloc_quŸa
(
öode
 *öode, 
size_t
 
Àn
)

865 
îr
;

867 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

868 i‡(
îr
)

869  
îr
;

870 
îr
 = 
	`dquŸ_Æloc_•a˚_nodúty
(
öode
, 
	`round_up_˛u°î
(öode, 
Àn
));

871 i‡(
îr
)

872 
	`dquŸ_‰ì_öode
(
öode
);

873  
îr
;

874 
	}
}

876 
	$pxt4_x©å_öode_‰ì_quŸa
(
öode
 *
∑ª¡
,

877 
öode
 *
ó_öode
,

878 
size_t
 
Àn
)

880 i‡(
ó_öode
 &&

881 
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquŸ_‰ì_•a˚_nodúty
(
∑ª¡
, 
	`round_up_˛u°î
’¨ít, 
Àn
));

884 
	`dquŸ_‰ì_öode
(
∑ª¡
);

885 
	}
}

887 
	$__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

888 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

889 
boﬁ
 
is_¸óã
)

891 
¸edôs
;

892 
blocks
;

907 
¸edôs
 = 7;

910 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 i‡(
öode
 && 
	`pxt4_has_ölöe_d©a
(inode))

917 
¸edôs
 +
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

920 i‡(!
	`pxt4_has_„©uª_ó_öode
(
sb
))

921  
¸edôs
;

924 
¸edôs
 += 4;

927 
blocks
 = (
vÆue_Àn
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

930 
blocks
 += 1;

933 
¸edôs
 +
blocks
 * 2;

936 
¸edôs
 +
blocks
;

938 i‡(!
is_¸óã
) {

942 
¸edôs
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_bôs
;

950 
blocks
 += 1;

953 
¸edôs
 +
blocks
 * 2;

959 i‡(
block_bh
) {

960 
pxt4_x©å_íåy
 *
íåy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry))

963 i‡(
íåy
->
e_vÆue_öum
)

965 
¸edôs
 += 1;

967  
¸edôs
;

968 
	}
}

970 
	$pxt4_x©å_öode_upd©e_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

971 
ªf_ch™ge
)

973 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
ó_öode
);

974 
pxt4_ûoc
 
ûoc
;

975 
s64
 
ªf_cou¡
;

976 
u32
 
hash
;

977 
ªt
;

979 
	`öode_lock
(
ó_öode
);

981 
ªt
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
ó_öode
, &
ûoc
);

982 i‡(
ªt
)

983 
out
;

985 
ªf_cou¡
 = 
	`pxt4_x©å_öode_gë_ªf
(
ó_öode
);

986 
ªf_cou¡
 +
ªf_ch™ge
;

987 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 
ªf_cou¡
);

989 i‡(
ªf_ch™ge
 > 0) {

990 
	`WARN_ONCE
(
ªf_cou¡
 <= 0, "EA inode %luÑef_count=%lld",

991 
ó_öode
->
i_öo
, 
ªf_cou¡
);

993 i‡(
ªf_cou¡
 == 1) {

994 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
, "EA inode %lu i_nlink=%u",

995 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

997 
	`£t_∆ök
(
ó_öode
, 1);

998 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
ó_öode
);

1000 i‡(
ó_öode_ˇche
) {

1001 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1002 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
,

1003 
GFP_NOFS
, 
hash
,

1004 
ó_öode
->
i_öo
,

1005 
åue
 );

1009 
	`WARN_ONCE
(
ªf_cou¡
 < 0, "EA inode %luÑef_count=%lld",

1010 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1012 i‡(
ªf_cou¡
 == 0) {

1013 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
 != 1,

1015 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1017 
	`˛ór_∆ök
(
ó_öode
);

1018 
	`pxt4_‹ph™_add
(
h™dÀ
, 
ó_öode
);

1020 i‡(
ó_öode_ˇche
) {

1021 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1022 
	`mb_ˇche_íåy_dñëe
(
ó_öode_ˇche
, 
hash
,

1023 
ó_öode
->
i_öo
);

1028 
ªt
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1029 i‡(
ªt
)

1030 
	`pxt4_w¨nög_öode
(
ó_öode
,

1031 "pxt4_m¨k_ûoc_dúty(ËÁûedÑë=%d", 
ªt
);

1032 
out
:

1033 
	`öode_u∆ock
(
ó_öode
);

1034  
ªt
;

1035 
	}
}

1037 
	$pxt4_x©å_öode_öc_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1039  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, 1);

1040 
	}
}

1042 
	$pxt4_x©å_öode_dec_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1044  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, -1);

1045 
	}
}

1047 
	$pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1048 
pxt4_x©å_íåy
 *
fú°
)

1050 
öode
 *
ó_öode
;

1051 
pxt4_x©å_íåy
 *
íåy
;

1052 
pxt4_x©å_íåy
 *
Áûed_íåy
;

1053 
ó_öo
;

1054 
îr
, 
ßved_îr
;

1056 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1057 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1058 i‡(!
íåy
->
e_vÆue_öum
)

1060 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1061 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1062 
	`À32_to_˝u
(
íåy
->
e_hash
),

1063 &
ó_öode
);

1064 i‡(
îr
)

1065 
˛ónup
;

1066 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1067 i‡(
îr
) {

1068 
	`pxt4_w¨nög_öode
(
ó_öode
, "ö¯ª‡îr‹ %d", 
îr
);

1069 
	`ùut
(
ó_öode
);

1070 
˛ónup
;

1072 
	`ùut
(
ó_öode
);

1076 
˛ónup
:

1077 
ßved_îr
 = 
îr
;

1078 
Áûed_íåy
 = 
íåy
;

1080 
íåy
 = 
fú°
;É¡ry !
Áûed_íåy
;

1081 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1082 i‡(!
íåy
->
e_vÆue_öum
)

1084 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1085 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1086 
	`À32_to_˝u
(
íåy
->
e_hash
),

1087 &
ó_öode
);

1088 i‡(
îr
) {

1089 
	`pxt4_w¨nög
(
∑ª¡
->
i_sb
,

1090 "˛ónu∞ó_öÿ%u igëÉº‹ %d", 
ó_öo
,

1091 
îr
);

1094 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1095 i‡(
îr
)

1096 
	`pxt4_w¨nög_öode
(
ó_öode
, "cleanup decÑefÉrror %d",

1097 
îr
);

1098 
	`ùut
(
ó_öode
);

1100  
ßved_îr
;

1101 
	}
}

1103 
	$pxt4_x©å_ª°¨t_‚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1104 
buf„r_hód
 *
bh
, 
boﬁ
 
block_csum
, boﬁ 
dúty
)

1106 
îr‹
;

1108 i‡(
bh
 && 
dúty
) {

1109 i‡(
block_csum
)

1110 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1111 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1112 i‡(
îr‹
) {

1113 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Handle metadata (error %d)",

1114 
îr‹
);

1115  
îr‹
;

1119 
	}
}

1122 
	$pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1123 
buf„r_hód
 *
bh
,

1124 
pxt4_x©å_íåy
 *
fú°
, 
boﬁ
 
block_csum
,

1125 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1126 
exåa_¸edôs
, 
boﬁ
 
skù_quŸa
)

1128 
öode
 *
ó_öode
;

1129 
pxt4_x©å_íåy
 *
íåy
;

1130 
boﬁ
 
dúty
 = 
Ál£
;

1131 
ó_öo
;

1132 
îr
;

1133 
¸edôs
;

1136 
¸edôs
 = 2 + 
exåa_¸edôs
;

1138 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1139 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1140 i‡(!
íåy
->
e_vÆue_öum
)

1142 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1143 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1144 
	`À32_to_˝u
(
íåy
->
e_hash
),

1145 &
ó_öode
);

1146 i‡(
îr
)

1149 
îr
 = 
	`pxt4_ex∑nd_öode_¨øy
(
ó_öode_¨øy
, 
ó_öode
);

1150 i‡(
îr
) {

1151 
	`pxt4_w¨nög_öode
(
ó_öode
,

1152 "Ex∑nd inodê¨øyÉº=%d", 
îr
);

1153 
	`ùut
(
ó_öode
);

1157 
îr
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs_‚
(
h™dÀ
, 
¸edôs
, credits,

1158 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
∑ª¡
->
i_sb
, 1),

1159 
	`pxt4_x©å_ª°¨t_‚
(
h™dÀ
, 
∑ª¡
, 
bh
, 
block_csum
,

1160 
dúty
));

1161 i‡(
îr
 < 0) {

1162 
	`pxt4_w¨nög_öode
(
ó_öode
, "Ensure creditsÉrr=%d",

1163 
îr
);

1166 i‡(
îr
 > 0) {

1167 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1168 i‡(
îr
) {

1169 
	`pxt4_w¨nög_öode
(
ó_öode
,

1171 
îr
);

1176 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1177 i‡(
îr
) {

1178 
	`pxt4_w¨nög_öode
(
ó_öode
, "ea_inode decÑefÉrr=%d",

1179 
îr
);

1183 i‡(!
skù_quŸa
)

1184 
	`pxt4_x©å_öode_‰ì_quŸa
(
∑ª¡
, 
ó_öode
,

1185 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

1193 
íåy
->
e_vÆue_öum
 = 0;

1194 
íåy
->
e_vÆue_size
 = 0;

1196 
dúty
 = 
åue
;

1199 i‡(
dúty
) {

1206 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1207 i‡(
îr
)

1208 
	`pxt4_w¨nög_öode
(
∑ª¡
,

1209 "h™dÀ dúty mëad©®îr=%d", 
îr
);

1211 
	}
}

1218 
	$pxt4_x©å_ªÀa£_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1219 
buf„r_hód
 *
bh
,

1220 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1221 
exåa_¸edôs
)

1223 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1224 
u32
 
hash
, 
ªf
;

1225 
îr‹
 = 0;

1227 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1228 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1229 i‡(
îr‹
)

1230 
out
;

1232 
	`lock_buf„r
(
bh
);

1233 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_hash
);

1234 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
);

1235 i‡(
ªf
 == 1) {

1236 
	`ó_bdebug
(
bh
, "refcountÇow=0; freeing");

1241 i‡(
ó_block_ˇche
)

1242 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1243 
bh
->
b_blockƒ
);

1244 
	`gë_bh
(
bh
);

1245 
	`u∆ock_buf„r
(
bh
);

1247 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
))

1248 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
bh
,

1249 
	`BFIRST
(
bh
),

1250 
åue
 ,

1251 
ó_öode_¨øy
,

1252 
exåa_¸edôs
,

1253 
åue
 );

1254 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
bh
, 0, 1,

1255 
PXT4_FREE_BLOCKS_METADATA
 |

1256 
PXT4_FREE_BLOCKS_FORGET
);

1258 
ªf
--;

1259 
	`BHDR
(
bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

1260 i‡(
ªf
 =
PXT4_XATTR_REFCOUNT_MAX
 - 1) {

1261 
mb_ˇche_íåy
 *
˚
;

1263 i‡(
ó_block_ˇche
) {

1264 
˚
 = 
	`mb_ˇche_íåy_gë
(
ó_block_ˇche
, 
hash
,

1265 
bh
->
b_blockƒ
);

1266 i‡(
˚
) {

1267 
˚
->
e_ªußbÀ
 = 1;

1268 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

1273 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1284 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1285 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1286 
	`u∆ock_buf„r
(
bh
);

1287 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1288 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1289 i‡(
	`IS_SYNC
(
öode
))

1290 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1291 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(öode->
i_sb
), 1));

1292 
	`ó_bdebug
(
bh
, "refcountÇow=%d;Ñeleasing",

1293 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
));

1295 
out
:

1296 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

1298 
	}
}

1304 
size_t
 
	$pxt4_x©å_‰ì_•a˚
(
pxt4_x©å_íåy
 *
œ°
,

1305 
size_t
 *
mö_offs
, *
ba£
, *
tŸÆ
)

1307 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

1308 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1309 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1310 i‡(
offs
 < *
mö_offs
)

1311 *
mö_offs
 = 
offs
;

1313 i‡(
tŸÆ
)

1314 *
tŸÆ
 +
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

1316  (*
mö_offs
 - ((*)
œ°
 - 
ba£
Ë- (
__u32
));

1317 
	}
}

1322 
	$pxt4_x©å_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1323 c⁄° *
buf
, 
bufsize
)

1325 
buf„r_hód
 *
bh
 = 
NULL
;

1326 
block
 = 0;

1327 
blocksize
 = 
ó_öode
->
i_sb
->
s_blocksize
;

1328 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

1329 
csize
, 
wsize
 = 0;

1330 
ªt
 = 0;

1331 
ªåõs
 = 0;

1333 
ªåy
:

1334 
ªt
 >0 &&Ñë < 
max_blocks
) {

1335 
pxt4_m≠_blocks
 
m≠
;

1336 
m≠
.
m_lblk
 = 
block
 +
ªt
;

1337 
m≠
.
m_Àn
 = 
max_blocks
 -
ªt
;

1339 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
ó_öode
, &
m≠
,

1340 
PXT4_GET_BLOCKS_CREATE
);

1341 i‡(
ªt
 <= 0) {

1342 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1343 i‡(
ªt
 =-
ENOSPC
 &&

1344 
	`pxt4_should_ªåy_Æloc
(
ó_öode
->
i_sb
, &
ªåõs
)) {

1345 
ªt
 = 0;

1346 
ªåy
;

1352 i‡(
ªt
 < 0)

1353  
ªt
;

1355 
block
 = 0;

1356 
wsize
 < 
bufsize
) {

1357 i‡(
bh
 !
NULL
)

1358 
	`bªl£
(
bh
);

1359 
csize
 = (
bufsize
 - 
wsize
Ë> 
blocksize
 ? blocksize :

1360 
bufsize
 - 
wsize
;

1361 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
ó_öode
, 
block
, 0);

1362 i‡(
	`IS_ERR
(
bh
))

1363  
	`PTR_ERR
(
bh
);

1364 i‡(!
bh
) {

1365 
	`WARN_ON_ONCE
(1);

1366 
	`PXT4_ERROR_INODE
(
ó_öode
,

1368  -
EFSCORRUPTED
;

1370 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1371 i‡(
ªt
)

1372 
out
;

1374 
	`mem˝y
(
bh
->
b_d©a
, 
buf
, 
csize
);

1375 
	`£t_buf„r_u±od©e
(
bh
);

1376 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
ó_öode
, 
bh
);

1378 
buf
 +
csize
;

1379 
wsize
 +
csize
;

1380 
block
 += 1;

1383 
	`öode_lock
(
ó_öode
);

1384 
	`i_size_wrôe
(
ó_öode
, 
wsize
);

1385 
	`pxt4_upd©e_i_disksize
(
ó_öode
, 
wsize
);

1386 
	`öode_u∆ock
(
ó_öode
);

1388 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1390 
out
:

1391 
	`bªl£
(
bh
);

1393  
ªt
;

1394 
	}
}

1399 
öode
 *
	$pxt4_x©å_öode_¸óã
(
h™dÀ_t
 *
h™dÀ
,

1400 
öode
 *öode, 
u32
 
hash
)

1402 
öode
 *
ó_öode
 = 
NULL
;

1403 
uid_t
 
ow√r
[2] = { 
	`i_uid_ªad
(
öode
), 
	`i_gid_ªad
(inode) };

1404 
îr
;

1410 
ó_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
öode
->
i_sb
->
s_roŸ
->
d_öode
,

1411 
S_IFREG
 | 0600, 
NULL
, 
öode
->
i_öo
 + 1, 
ow√r
,

1412 
PXT4_EA_INODE_FL
);

1413 i‡(!
	`IS_ERR
(
ó_öode
)) {

1414 
ó_öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

1415 
ó_öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

1416 
	`pxt4_£t_a›s
(
ó_öode
);

1417 
	`pxt4_x©å_öode_£t_˛ass
(
ó_öode
);

1418 
	`u∆ock_√w_öode
(
ó_öode
);

1419 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 1);

1420 
	`pxt4_x©å_öode_£t_hash
(
ó_öode
, 
hash
);

1421 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1422 i‡(!
îr
)

1423 
îr
 = 
	`pxt4_öode_©èch_jöode
(
ó_öode
);

1424 i‡(
îr
) {

1425 
	`ùut
(
ó_öode
);

1426  
	`ERR_PTR
(
îr
);

1433 
	`dquŸ_‰ì_öode
(
ó_öode
);

1434 
	`dquŸ_dr›
(
ó_öode
);

1435 
	`öode_lock
(
ó_öode
);

1436 
ó_öode
->
i_Êags
 |
S_NOQUOTA
;

1437 
	`öode_u∆ock
(
ó_öode
);

1440  
ó_öode
;

1441 
	}
}

1443 
öode
 *

1444 
	$pxt4_x©å_öode_ˇche_föd
(
öode
 *öode, c⁄° *
vÆue
,

1445 
size_t
 
vÆue_Àn
, 
u32
 
hash
)

1447 
öode
 *
ó_öode
;

1448 
mb_ˇche_íåy
 *
˚
;

1449 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

1450 *
ó_d©a
;

1452 i‡(!
ó_öode_ˇche
)

1453  
NULL
;

1455 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_öode_ˇche
, 
hash
);

1456 i‡(!
˚
)

1457  
NULL
;

1459 
ó_d©a
 = 
	`pxt4_kvmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1460 i‡(!
ó_d©a
) {

1461 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1462  
NULL
;

1465 
˚
) {

1466 
ó_öode
 = 
	`pxt4_igë
(
öode
->
i_sb
, 
˚
->
e_vÆue
,

1467 
PXT4_IGET_NORMAL
);

1468 i‡(!
	`IS_ERR
(
ó_öode
) &&

1469 !
	`is_bad_öode
(
ó_öode
) &&

1470 (
	`PXT4_I
(
ó_öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
) &&

1471 
	`i_size_ªad
(
ó_öode
Ë=
vÆue_Àn
 &&

1472 !
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
ó_d©a
, 
vÆue_Àn
) &&

1473 !
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
NULL
, 
ó_d©a
,

1474 
vÆue_Àn
) &&

1475 !
	`memcmp
(
vÆue
, 
ó_d©a
, 
vÆue_Àn
)) {

1476 
	`mb_ˇche_íåy_touch
(
ó_öode_ˇche
, 
˚
);

1477 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1478 
	`kv‰ì
(
ó_d©a
);

1479  
ó_öode
;

1482 i‡(!
	`IS_ERR
(
ó_öode
))

1483 
	`ùut
(
ó_öode
);

1484 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_öode_ˇche
, ce);

1486 
	`kv‰ì
(
ó_d©a
);

1487  
NULL
;

1488 
	}
}

1493 
	$pxt4_x©å_öode_lookup_¸óã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1494 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

1495 
öode
 **
ªt_öode
)

1497 
öode
 *
ó_öode
;

1498 
u32
 
hash
;

1499 
îr
;

1501 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
öode
->
i_sb
), 
vÆue
, 
vÆue_Àn
);

1502 
ó_öode
 = 
	`pxt4_x©å_öode_ˇche_föd
(
öode
, 
vÆue
, 
vÆue_Àn
, 
hash
);

1503 i‡(
ó_öode
) {

1504 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1505 i‡(
îr
) {

1506 
	`ùut
(
ó_öode
);

1507  
îr
;

1510 *
ªt_öode
 = 
ó_öode
;

1515 
ó_öode
 = 
	`pxt4_x©å_öode_¸óã
(
h™dÀ
, 
öode
, 
hash
);

1516 i‡(
	`IS_ERR
(
ó_öode
))

1517  
	`PTR_ERR
(
ó_öode
);

1519 
îr
 = 
	`pxt4_x©å_öode_wrôe
(
h™dÀ
, 
ó_öode
, 
vÆue
, 
vÆue_Àn
);

1520 i‡(
îr
) {

1521 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1522 
	`ùut
(
ó_öode
);

1523  
îr
;

1526 i‡(
	`EA_INODE_CACHE
(
öode
))

1527 
	`mb_ˇche_íåy_¸óã
(
	`EA_INODE_CACHE
(
öode
), 
GFP_NOFS
, 
hash
,

1528 
ó_öode
->
i_öo
, 
åue
 );

1530 *
ªt_öode
 = 
ó_öode
;

1532 
	}
}

1538 
	#PXT4_XATTR_BLOCK_RESERVE
(
öode
Ë
	`mö
(
	`i_blocksize
(öode)/8, 1024U)

	)

1540 
	$pxt4_x©å_£t_íåy
(
pxt4_x©å_öfo
 *
i
,

1541 
pxt4_x©å_£¨ch
 *
s
,

1542 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1543 
boﬁ
 
is_block
)

1545 
pxt4_x©å_íåy
 *
œ°
, *
√xt
;

1546 
pxt4_x©å_íåy
 *
hîe
 = 
s
->here;

1547 
size_t
 
mö_offs
 = 
s
->
íd
 - s->
ba£
, 
«me_Àn
 = 
	`°æí
(
i
->
«me
);

1548 
ö_öode
 = 
i
->in_inode;

1549 
öode
 *
ﬁd_ó_öode
 = 
NULL
;

1550 
öode
 *
√w_ó_öode
 = 
NULL
;

1551 
size_t
 
ﬁd_size
, 
√w_size
;

1552 
ªt
;

1555 
ﬁd_size
 = (!
s
->
nŸ_found
 && !
hîe
->
e_vÆue_öum
) ?

1556 
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
hîe
->
e_vÆue_size
)) : 0;

1557 
√w_size
 = (
i
->
vÆue
 && !
ö_öode
Ë? 
	`PXT4_XATTR_SIZE
(i->
vÆue_Àn
) : 0;

1563 i‡(
√w_size
 &&Çew_sizê=
ﬁd_size
) {

1564 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1565 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1567 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1568 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1569 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1571 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1573 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0, 
√w_size
 - i->value_len);

1575 
upd©e_hash
;

1579 
œ°
 = 
s
->
fú°
;

1580 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
√xt
) {

1581 
√xt
 = 
	`PXT4_XATTR_NEXT
(
œ°
);

1582 i‡((*)
√xt
 >
s
->
íd
) {

1583 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

1584 
ªt
 = -
EFSCORRUPTED
;

1585 
out
;

1587 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1588 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1589 i‡(
offs
 < 
mö_offs
)

1590 
mö_offs
 = 
offs
;

1595 i‡(
i
->
vÆue
) {

1596 
size_t
 
‰ì
;

1598 
‰ì
 = 
mö_offs
 - ((*)
œ°
 - 
s
->
ba£
Ë- (
__u32
);

1599 i‡(!
s
->
nŸ_found
)

1600 
‰ì
 +
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
ﬁd_size
;

1602 i‡(
‰ì
 < 
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
√w_size
) {

1603 
ªt
 = -
ENOSPC
;

1604 
out
;

1613 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

1614 
√w_size
 && 
is_block
 &&

1615 (
mö_offs
 + 
ﬁd_size
 - 
√w_size
) <

1616 
	`PXT4_XATTR_BLOCK_RESERVE
(
öode
)) {

1617 
ªt
 = -
ENOSPC
;

1618 
out
;

1626 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_öum
) {

1627 
ªt
 = 
	`pxt4_x©å_öode_igë
(
öode
,

1628 
	`À32_to_˝u
(
hîe
->
e_vÆue_öum
),

1629 
	`À32_to_˝u
(
hîe
->
e_hash
),

1630 &
ﬁd_ó_öode
);

1631 i‡(
ªt
) {

1632 
ﬁd_ó_öode
 = 
NULL
;

1633 
out
;

1636 i‡(
i
->
vÆue
 && 
ö_öode
) {

1637 
	`WARN_ON_ONCE
(!
i
->
vÆue_Àn
);

1639 
ªt
 = 
	`pxt4_x©å_öode_Æloc_quŸa
(
öode
, 
i
->
vÆue_Àn
);

1640 i‡(
ªt
)

1641 
out
;

1643 
ªt
 = 
	`pxt4_x©å_öode_lookup_¸óã
(
h™dÀ
, 
öode
, 
i
->
vÆue
,

1644 
i
->
vÆue_Àn
,

1645 &
√w_ó_öode
);

1646 i‡(
ªt
) {

1647 
√w_ó_öode
 = 
NULL
;

1648 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
i
->
vÆue_Àn
);

1649 
out
;

1653 i‡(
ﬁd_ó_öode
) {

1655 
ªt
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ﬁd_ó_öode
);

1656 i‡(
ªt
) {

1658 i‡(
√w_ó_öode
) {

1659 
îr
;

1661 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

1662 
√w_ó_öode
);

1663 i‡(
îr
)

1664 
	`pxt4_w¨nög_öode
(
√w_ó_öode
,

1666 
îr
);

1667 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
√w_ó_öode
,

1668 
i
->
vÆue_Àn
);

1670 
out
;

1673 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ﬁd_ó_öode
,

1674 
	`À32_to_˝u
(
hîe
->
e_vÆue_size
));

1679 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_size
 && !hîe->
e_vÆue_öum
) {

1681 *
fú°_vÆ
 = 
s
->
ba£
 + 
mö_offs
;

1682 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1683 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1685 
	`memmove
(
fú°_vÆ
 + 
ﬁd_size
, fú°_vÆ, 
vÆ
 - first_val);

1686 
	`mem£t
(
fú°_vÆ
, 0, 
ﬁd_size
);

1687 
mö_offs
 +
ﬁd_size
;

1690 
œ°
 = 
s
->
fú°
;

1691 !
	`IS_LAST_ENTRY
(
œ°
)) {

1692 
size_t
 
o
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1694 i‡(!
œ°
->
e_vÆue_öum
 &&

1695 
œ°
->
e_vÆue_size
 && 
o
 < 
offs
)

1696 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
o
 + 
ﬁd_size
);

1697 
œ°
 = 
	`PXT4_XATTR_NEXT
(last);

1701 i‡(!
i
->
vÆue
) {

1703 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1705 
œ°
 = 
	`ENTRY
((*Óa° - 
size
);

1706 
	`memmove
(
hîe
, (*)hîê+ 
size
,

1707 (*)
œ°
 - (*)
hîe
 + (
__u32
));

1708 
	`mem£t
(
œ°
, 0, 
size
);

1709 } i‡(
s
->
nŸ_found
) {

1711 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1712 
size_t
 
ª°
 = (*)
œ°
 - (*)
hîe
 + (
__u32
);

1714 
	`memmove
((*)
hîe
 + 
size
, hîe, 
ª°
);

1715 
	`mem£t
(
hîe
, 0, 
size
);

1716 
hîe
->
e_«me_ödex
 = 
i
->
«me_ödex
;

1717 
hîe
->
e_«me_Àn
 = 
«me_Àn
;

1718 
	`mem˝y
(
hîe
->
e_«me
, 
i
->
«me
, 
«me_Àn
);

1721 
hîe
->
e_vÆue_öum
 = 0;

1722 
hîe
->
e_vÆue_offs
 = 0;

1723 
hîe
->
e_vÆue_size
 = 0;

1726 i‡(
i
->
vÆue
) {

1728 i‡(
ö_öode
) {

1729 
hîe
->
e_vÆue_öum
 = 
	`˝u_to_À32
(
√w_ó_öode
->
i_öo
);

1730 } i‡(
i
->
vÆue_Àn
) {

1731 *
vÆ
 = 
s
->
ba£
 + 
mö_offs
 - 
√w_size
;

1733 
hîe
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
mö_offs
 - 
√w_size
);

1734 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1735 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1737 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1739 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0,

1740 
√w_size
 - 
i
->
vÆue_Àn
);

1743 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1746 
upd©e_hash
:

1747 i‡(
i
->
vÆue
) {

1748 
__À32
 
hash
 = 0;

1751 i‡(
ö_öode
) {

1752 
__À32
 
¸c32c_hash
;

1759 
¸c32c_hash
 = 
	`˝u_to_À32
(

1760 
	`pxt4_x©å_öode_gë_hash
(
√w_ó_öode
));

1761 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1762 
hîe
->
e_«me_Àn
,

1763 &
¸c32c_hash
, 1);

1764 } i‡(
is_block
) {

1765 
__À32
 *
vÆue
 = 
s
->
ba£
 + 
	`À16_to_˝u
(

1766 
hîe
->
e_vÆue_offs
);

1768 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1769 
hîe
->
e_«me_Àn
, 
vÆue
,

1770 
√w_size
 >> 2);

1772 
hîe
->
e_hash
 = 
hash
;

1775 i‡(
is_block
)

1776 
	`pxt4_x©å_ªhash
((
pxt4_x©å_hódî
 *)
s
->
ba£
);

1778 
ªt
 = 0;

1779 
out
:

1780 
	`ùut
(
ﬁd_ó_öode
);

1781 
	`ùut
(
√w_ó_öode
);

1782  
ªt
;

1783 
	}
}

1785 
	spxt4_x©å_block_föd
 {

1786 
pxt4_x©å_£¨ch
 
	ms
;

1787 
buf„r_hód
 *
	mbh
;

1791 
	$pxt4_x©å_block_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

1792 
pxt4_x©å_block_föd
 *
bs
)

1794 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1795 
îr‹
;

1797 
	`ó_idebug
(
öode
, "name=%d.%s, value=%p, value_len=%ld",

1798 
i
->
«me_ödex
, i->
«me
, i->
vÆue
, ()i->
vÆue_Àn
);

1800 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

1802 
bs
->
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`PXT4_I
(
öode
)->
i_fûe_a˛
, 
REQ_PRIO
);

1803 i‡(
	`IS_ERR
(
bs
->
bh
))

1804  
	`PTR_ERR
(
bs
->
bh
);

1805 
	`ó_bdebug
(
bs
->
bh
, "b_count=%d,Ñefcount=%d",

1806 
	`©omic_ªad
(&(
bs
->
bh
->
b_cou¡
)),

1807 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_ªfcou¡
));

1808 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bs
->
bh
);

1809 i‡(
îr‹
)

1810  
îr‹
;

1812 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1813 
bs
->
s
.
fú°
 = 
	`BFIRST
(bs->
bh
);

1814 
bs
->
s
.
íd
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1815 
bs
->
s
.
hîe
 = bs->s.
fú°
;

1816 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
bs
->
s
.
hîe
, bs->s.
íd
,

1817 
i
->
«me_ödex
, i->
«me
, 1);

1818 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

1819  
îr‹
;

1820 
bs
->
s
.
nŸ_found
 = 
îr‹
;

1823 
	}
}

1826 
	$pxt4_x©å_block_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1827 
pxt4_x©å_öfo
 *
i
,

1828 
pxt4_x©å_block_föd
 *
bs
)

1830 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1831 
buf„r_hód
 *
√w_bh
 = 
NULL
;

1832 
pxt4_x©å_£¨ch
 
s_c›y
 = 
bs
->
s
;

1833 
pxt4_x©å_£¨ch
 *
s
 = &
s_c›y
;

1834 
mb_ˇche_íåy
 *
˚
 = 
NULL
;

1835 
îr‹
 = 0;

1836 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1837 
öode
 *
ó_öode
 = 
NULL
, *
tmp_öode
;

1838 
size_t
 
ﬁd_ó_öode_quŸa
 = 0;

1839 
ó_öo
;

1842 
	#hódî
(
x
Ë((
pxt4_x©å_hódî
 *)(x))

	)

1844 i‡(
s
->
ba£
) {

1845 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1846 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bs
->
bh
);

1847 i‡(
îr‹
)

1848 
˛ónup
;

1849 
	`lock_buf„r
(
bs
->
bh
);

1851 i‡(
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 =
	`˝u_to_À32
(1)) {

1852 
__u32
 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1859 i‡(
ó_block_ˇche
)

1860 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1861 
bs
->
bh
->
b_blockƒ
);

1862 
	`ó_bdebug
(
bs
->
bh
, "modifying in-place");

1863 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
,

1864 
åue
 );

1865 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bs
->
bh
);

1866 
	`u∆ock_buf„r
(
bs
->
bh
);

1867 i‡(
îr‹
 =-
EFSCORRUPTED
)

1868 
bad_block
;

1869 i‡(!
îr‹
)

1870 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1871 
öode
,

1872 
bs
->
bh
);

1873 i‡(
îr‹
)

1874 
˛ónup
;

1875 
ö£πed
;

1877 
off£t
 = (*)
s
->
hîe
 - 
bs
->
bh
->
b_d©a
;

1879 
	`u∆ock_buf„r
(
bs
->
bh
);

1880 
	`ó_bdebug
(
bs
->
bh
, "cloning");

1881 
s
->
ba£
 = 
	`kmÆloc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1882 
îr‹
 = -
ENOMEM
;

1883 i‡(
s
->
ba£
 =
NULL
)

1884 
˛ónup
;

1885 
	`mem˝y
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1886 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1887 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1888 
s
->
hîe
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1889 
s
->
íd
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1898 i‡(!
s
->
nŸ_found
 && s->
hîe
->
e_vÆue_öum
) {

1899 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1900 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1901 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1902 &
tmp_öode
);

1903 i‡(
îr‹
)

1904 
˛ónup
;

1906 i‡(!
	`pxt4_ã°_öode_°©e
(
tmp_öode
,

1907 
PXT4_STATE_LUSTRE_EA_INODE
)) {

1912 
ﬁd_ó_öode_quŸa
 = 
	`À32_to_˝u
(

1913 
s
->
hîe
->
e_vÆue_size
);

1915 
	`ùut
(
tmp_öode
);

1917 
s
->
hîe
->
e_vÆue_öum
 = 0;

1918 
s
->
hîe
->
e_vÆue_size
 = 0;

1923 
s
->
ba£
 = 
	`kzÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1925 
îr‹
 = -
ENOMEM
;

1926 i‡(
s
->
ba£
 =
NULL
)

1927 
˛ónup
;

1928 
	`hódî
(
s
->
ba£
)->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

1929 
	`hódî
(
s
->
ba£
)->
h_blocks
 = 
	`˝u_to_À32
(1);

1930 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1931 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1932 
s
->
hîe
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1933 
s
->
íd
 = s->
ba£
 + 
sb
->
s_blocksize
;

1936 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
åue
 );

1937 i‡(
îr‹
 =-
EFSCORRUPTED
)

1938 
bad_block
;

1939 i‡(
îr‹
)

1940 
˛ónup
;

1942 i‡(
i
->
vÆue
 && 
s
->
hîe
->
e_vÆue_öum
) {

1949 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1950 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1951 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1952 &
ó_öode
);

1953 i‡(
îr‹
) {

1954 
ó_öode
 = 
NULL
;

1955 
˛ónup
;

1959 
ö£πed
:

1960 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

1961 
√w_bh
 = 
	`pxt4_x©å_block_ˇche_föd
(
öode
, 
	`hódî
(
s
->
ba£
),

1962 &
˚
);

1963 i‡(
√w_bh
) {

1965 i‡(
√w_bh
 =
bs
->
bh
)

1966 
	`ó_bdebug
(
√w_bh
, "keeping");

1968 
u32
 
ªf
;

1970 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

1974 
îr‹
 = 
	`dquŸ_Æloc_block
(
öode
,

1975 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

1976 i‡(
îr‹
)

1977 
˛ónup
;

1978 
	`BUFFER_TRACE
(
√w_bh
, "get_write_access");

1979 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1980 
√w_bh
);

1981 i‡(
îr‹
)

1982 
˛ónup_dquŸ
;

1983 
	`lock_buf„r
(
√w_bh
);

1996 i‡(
	`hli°_bl_unhashed
(&
˚
->
e_hash_li°
) ||

1997 !
˚
->
e_ªußbÀ
) {

2002 
	`u∆ock_buf„r
(
√w_bh
);

2003 
	`dquŸ_‰ì_block
(
öode
,

2004 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

2006 
	`bªl£
(
√w_bh
);

2007 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2008 
˚
 = 
NULL
;

2009 
√w_bh
 = 
NULL
;

2010 
ö£πed
;

2012 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
√w_bh
)->
h_ªfcou¡
) + 1;

2013 
	`BHDR
(
√w_bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

2014 i‡(
ªf
 >
PXT4_XATTR_REFCOUNT_MAX
)

2015 
˚
->
e_ªußbÀ
 = 0;

2016 
	`ó_bdebug
(
√w_bh
, "reusing;ÑefcountÇow=%d",

2017 
ªf
);

2018 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2019 
	`u∆ock_buf„r
(
√w_bh
);

2020 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

2021 
öode
,

2022 
√w_bh
);

2023 i‡(
îr‹
)

2024 
˛ónup_dquŸ
;

2026 
	`mb_ˇche_íåy_touch
(
ó_block_ˇche
, 
˚
);

2027 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2028 
˚
 = 
NULL
;

2029 } i‡(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
) {

2031 
	`ó_bdebug
(
bs
->
bh
, "keepingÅhis block");

2032 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bs
->
bh
);

2033 
√w_bh
 = 
bs
->
bh
;

2034 
	`gë_bh
(
√w_bh
);

2037 
pxt4_fsblk_t
 
gﬂl
, 
block
;

2039 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2041 
gﬂl
 = 
	`pxt4_group_fú°_block_no
(
sb
,

2042 
	`PXT4_I
(
öode
)->
i_block_group
);

2045 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2046 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

2048 
block
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 0,

2049 
NULL
, &
îr‹
);

2050 i‡(
îr‹
)

2051 
˛ónup
;

2053 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2054 
	`BUG_ON
(
block
 > 
PXT4_MAX_BLOCK_FILE_PHYS
);

2056 
	`ó_idebug
(
öode
, "creating block %llu",

2057 ()
block
);

2059 
√w_bh
 = 
	`sb_gëblk
(
sb
, 
block
);

2060 i‡(
	`u∆ikñy
(!
√w_bh
)) {

2061 
îr‹
 = -
ENOMEM
;

2062 
gëblk_Áûed
:

2063 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

2064 
PXT4_FREE_BLOCKS_METADATA
);

2065 
˛ónup
;

2067 
îr‹
 = 
	`pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ
, 
öode
,

2068 
	`ENTRY
(
	`hódî
(
s
->
ba£
)+1));

2069 i‡(
îr‹
)

2070 
gëblk_Áûed
;

2071 i‡(
ó_öode
) {

2073 
îr‹
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

2074 
ó_öode
);

2075 i‡(
îr‹
)

2076 
	`pxt4_w¨nög_öode
(
ó_öode
,

2078 
îr‹
);

2079 
	`ùut
(
ó_öode
);

2080 
ó_öode
 = 
NULL
;

2083 
	`lock_buf„r
(
√w_bh
);

2084 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
√w_bh
);

2085 i‡(
îr‹
) {

2086 
	`u∆ock_buf„r
(
√w_bh
);

2087 
îr‹
 = -
EIO
;

2088 
gëblk_Áûed
;

2090 
	`mem˝y
(
√w_bh
->
b_d©a
, 
s
->
ba£
,Çew_bh->
b_size
);

2091 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2092 
	`£t_buf„r_u±od©e
(
√w_bh
);

2093 
	`u∆ock_buf„r
(
√w_bh
);

2094 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
√w_bh
);

2095 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
,

2096 
√w_bh
);

2097 i‡(
îr‹
)

2098 
˛ónup
;

2102 i‡(
ﬁd_ó_öode_quŸa
)

2103 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
ﬁd_ó_öode_quŸa
);

2106 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 
√w_bh
 ?Çew_bh->
b_blockƒ
 : 0;

2109 i‡(
bs
->
bh
 && bs->bh !
√w_bh
) {

2110 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

2112 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bs
->
bh
,

2113 &
ó_öode_¨øy
,

2115 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

2117 
îr‹
 = 0;

2119 
˛ónup
:

2120 i‡(
ó_öode
) {

2121 
îr‹2
;

2123 
îr‹2
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

2124 i‡(
îr‹2
)

2125 
	`pxt4_w¨nög_öode
(
ó_öode
, "decÑefÉrror=%d",

2126 
îr‹2
);

2129 i‡(
îr‹
)

2130 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2131 
	`i_size_ªad
(
ó_öode
));

2132 
	`ùut
(
ó_öode
);

2134 i‡(
˚
)

2135 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2136 
	`bªl£
(
√w_bh
);

2137 i‡(!(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
))

2138 
	`k‰ì
(
s
->
ba£
);

2140  
îr‹
;

2142 
˛ónup_dquŸ
:

2143 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2144 
˛ónup
;

2146 
bad_block
:

2147 
	`PXT4_ERROR_INODE
(
öode
, "bad block %llu",

2148 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2149 
˛ónup
;

2151 #unde‡
hódî


2152 
	}
}

2154 
	$pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

2155 
pxt4_x©å_ibody_föd
 *
is
)

2157 
pxt4_x©å_ibody_hódî
 *
hódî
;

2158 
pxt4_öode
 *
øw_öode
;

2159 
îr‹
;

2161 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2163 
øw_öode
 = 
	`pxt4_øw_öode
(&
is
->
ûoc
);

2164 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2165 
is
->
s
.
ba£
 = is->s.
fú°
 = 
	`IFIRST
(
hódî
);

2166 
is
->
s
.
hîe
 = is->s.
fú°
;

2167 
is
->
s
.
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2168 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2169 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
is
->
s
.
íd
);

2170 i‡(
îr‹
)

2171  
îr‹
;

2173 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
is
->
s
.
hîe
, is->s.
íd
,

2174 
i
->
«me_ödex
, i->
«me
, 0);

2175 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

2176  
îr‹
;

2177 
is
->
s
.
nŸ_found
 = 
îr‹
;

2180 
	}
}

2182 
	$pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2183 
pxt4_x©å_öfo
 *
i
,

2184 
pxt4_x©å_ibody_föd
 *
is
)

2186 
pxt4_x©å_ibody_hódî
 *
hódî
;

2187 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2188 
îr‹
;

2190 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2191  -
ENOSPC
;

2192 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2193 i‡(
îr‹
)

2194  
îr‹
;

2195 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2196 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2197 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2198 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2200 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2201 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2204 
	}
}

2206 
	$pxt4_x©å_ibody_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2207 
pxt4_x©å_öfo
 *
i
,

2208 
pxt4_x©å_ibody_föd
 *
is
)

2210 
pxt4_x©å_ibody_hódî
 *
hódî
;

2211 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2212 
îr‹
;

2214 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2215  -
ENOSPC
;

2216 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2217 i‡(
îr‹
)

2218  
îr‹
;

2219 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2220 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2221 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2222 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2224 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2225 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2228 
	}
}

2230 
	$pxt4_x©å_vÆue_ßme
(
pxt4_x©å_£¨ch
 *
s
,

2231 
pxt4_x©å_öfo
 *
i
)

2233 *
vÆue
;

2236 i‡(
s
->
hîe
->
e_vÆue_öum
)

2238 i‡(
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_size
Ë!
i
->
vÆue_Àn
)

2240 
vÆue
 = ((*)
s
->
ba£
Ë+ 
	`À16_to_˝u
(s->
hîe
->
e_vÆue_offs
);

2241  !
	`memcmp
(
vÆue
, 
i
->vÆue, i->
vÆue_Àn
);

2242 
	}
}

2244 
buf„r_hód
 *
	$pxt4_x©å_gë_block
(
öode
 *inode)

2246 
buf„r_hód
 *
bh
;

2247 
îr‹
;

2249 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

2250  
NULL
;

2251 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2252 i‡(
	`IS_ERR
(
bh
))

2253  
bh
;

2254 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2255 i‡(
îr‹
) {

2256 
	`bªl£
(
bh
);

2257  
	`ERR_PTR
(
îr‹
);

2259  
bh
;

2260 
	}
}

2275 
	$pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
«me_ödex
,

2276 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

2277 
Êags
)

2279 
pxt4_x©å_öfo
 
i
 = {

2280 .
«me_ödex
 =Çame_index,

2281 .
«me
 =Çame,

2282 .
vÆue
 = value,

2283 .
vÆue_Àn
 = value_len,

2284 .
ö_öode
 = 0,

2286 
pxt4_x©å_ibody_föd
 
is
 = {

2287 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2289 
pxt4_x©å_block_föd
 
bs
 = {

2290 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2292 
no_ex∑nd
;

2293 
îr‹
;

2295 i‡(!
«me
)

2296  -
EINVAL
;

2297 i‡(
	`°æí
(
«me
) > 255)

2298  -
ERANGE
;

2300 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2303 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2304 
buf„r_hód
 *
bh
;

2305 
¸edôs
;

2307 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2308 i‡(
	`IS_ERR
(
bh
)) {

2309 
îr‹
 = 
	`PTR_ERR
(
bh
);

2310 
˛ónup
;

2313 
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2314 
vÆue_Àn
,

2315 
Êags
 & 
XATTR_CREATE
);

2316 
	`bªl£
(
bh
);

2318 i‡(
	`jbd3_h™dÀ_buf„r_¸edôs
(
h™dÀ
Ë< 
¸edôs
) {

2319 
îr‹
 = -
ENOSPC
;

2320 
˛ónup
;

2324 
îr‹
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2325 i‡(
îr‹
)

2326 
˛ónup
;

2328 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
)) {

2329 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(&
is
.
ûoc
);

2330 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

2331 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

2334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

2335 i‡(
îr‹
)

2336 
˛ónup
;

2337 i‡(
is
.
s
.
nŸ_found
)

2338 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2339 i‡(
îr‹
)

2340 
˛ónup
;

2341 i‡(
is
.
s
.
nŸ_found
 && 
bs
.s.not_found) {

2342 
îr‹
 = -
ENODATA
;

2343 i‡(
Êags
 & 
XATTR_REPLACE
)

2344 
˛ónup
;

2345 
îr‹
 = 0;

2346 i‡(!
vÆue
)

2347 
˛ónup
;

2349 
îr‹
 = -
EEXIST
;

2350 i‡(
Êags
 & 
XATTR_CREATE
)

2351 
˛ónup
;

2354 i‡(!
vÆue
) {

2355 i‡(!
is
.
s
.
nŸ_found
)

2356 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2357 i‡(!
bs
.
s
.
nŸ_found
)

2358 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2360 
îr‹
 = 0;

2362 i‡(!
is
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&is.s, &
i
))

2363 
˛ónup
;

2364 i‡(!
bs
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&bs.s, &
i
))

2365 
˛ónup
;

2367 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2368 (
	`PXT4_XATTR_SIZE
(
i
.
vÆue_Àn
) >

2369 
	`PXT4_XATTR_MIN_LARGE_EA_SIZE
(
öode
->
i_sb
->
s_blocksize
)))

2370 
i
.
ö_öode
 = 1;

2371 
ªåy_öode
:

2372 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2373 i‡(!
îr‹
 && !
bs
.
s
.
nŸ_found
) {

2374 
i
.
vÆue
 = 
NULL
;

2375 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2376 } i‡(
îr‹
 =-
ENOSPC
) {

2377 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
 && !
bs
.
s
.
ba£
) {

2378 
	`bªl£
(
bs
.
bh
);

2379 
bs
.
bh
 = 
NULL
;

2380 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2381 i‡(
îr‹
)

2382 
˛ónup
;

2384 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2385 i‡(!
îr‹
 && !
is
.
s
.
nŸ_found
) {

2386 
i
.
vÆue
 = 
NULL
;

2387 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
,

2388 &
is
);

2389 } i‡(
îr‹
 =-
ENOSPC
) {

2394 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2395 !
i
.
ö_öode
) {

2396 
i
.
ö_öode
 = 1;

2397 
ªåy_öode
;

2402 i‡(!
îr‹
) {

2403 
	`pxt4_x©å_upd©e_su≥r_block
(
h™dÀ
, 
öode
->
i_sb
);

2404 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

2405 i‡(!
vÆue
)

2406 
no_ex∑nd
 = 0;

2407 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2412 
is
.
ûoc
.
bh
 = 
NULL
;

2413 i‡(
	`IS_SYNC
(
öode
))

2414 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2417 
˛ónup
:

2418 
	`bªl£
(
is
.
ûoc
.
bh
);

2419 
	`bªl£
(
bs
.
bh
);

2420 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2421  
îr‹
;

2422 
	}
}

2424 
	$pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

2425 
boﬁ
 
is_¸óã
, *
¸edôs
)

2427 
buf„r_hód
 *
bh
;

2428 
îr
;

2430 *
¸edôs
 = 0;

2432 i‡(!
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

2435 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2437 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2438 i‡(
	`IS_ERR
(
bh
)) {

2439 
îr
 = 
	`PTR_ERR
(
bh
);

2441 *
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2442 
vÆue_Àn
, 
is_¸óã
);

2443 
	`bªl£
(
bh
);

2444 
îr
 = 0;

2447 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2448  
îr
;

2449 
	}
}

2460 
	$pxt4_x©å_£t
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

2461 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
, 
Êags
)

2463 
h™dÀ_t
 *
h™dÀ
;

2464 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2465 
îr‹
, 
ªåõs
 = 0;

2466 
¸edôs
;

2468 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

2469 i‡(
îr‹
)

2470  
îr‹
;

2472 
ªåy
:

2473 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
vÆue_Àn
, 
Êags
 & 
XATTR_CREATE
,

2474 &
¸edôs
);

2475 i‡(
îr‹
)

2476  
îr‹
;

2478 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

2479 i‡(
	`IS_ERR
(
h™dÀ
)) {

2480 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2482 
îr‹2
;

2484 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, 
«me
,

2485 
vÆue
, 
vÆue_Àn
, 
Êags
);

2486 
îr‹2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2487 i‡(
îr‹
 =-
ENOSPC
 &&

2488 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

2489 
ªåy
;

2490 i‡(
îr‹
 == 0)

2491 
îr‹
 = 
îr‹2
;

2494  
îr‹
;

2495 
	}
}

2501 
	$pxt4_x©å_shi·_íåõs
(
pxt4_x©å_íåy
 *
íåy
,

2502 
vÆue_offs_shi·
, *
to
,

2503 *
‰om
, 
size_t
 
n
)

2505 
pxt4_x©å_íåy
 *
œ°
 = 
íåy
;

2506 
√w_offs
;

2509 
	`BUG_ON
(
vÆue_offs_shi·
 > 0);

2512 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2513 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

2514 
√w_offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
) +

2515 
vÆue_offs_shi·
;

2516 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
√w_offs
);

2520 
	`memmove
(
to
, 
‰om
, 
n
);

2521 
	}
}

2526 
	$pxt4_x©å_move_to_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2527 
pxt4_öode
 *
øw_öode
,

2528 
pxt4_x©å_íåy
 *
íåy
)

2530 
pxt4_x©å_ibody_föd
 *
is
 = 
NULL
;

2531 
pxt4_x©å_block_föd
 *
bs
 = 
NULL
;

2532 *
buf„r
 = 
NULL
, *
b_íåy_«me
 = NULL;

2533 
size_t
 
vÆue_size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

2534 
pxt4_x©å_öfo
 
i
 = {

2535 .
vÆue
 = 
NULL
,

2536 .
vÆue_Àn
 = 0,

2537 .
«me_ödex
 = 
íåy
->
e_«me_ödex
,

2538 .
ö_öode
 = !!
íåy
->
e_vÆue_öum
,

2540 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2541 
îr‹
;

2543 
is
 = 
	`kzÆloc
((
pxt4_x©å_ibody_föd
), 
GFP_NOFS
);

2544 
bs
 = 
	`kzÆloc
((
pxt4_x©å_block_föd
), 
GFP_NOFS
);

2545 
buf„r
 = 
	`kmÆloc
(
vÆue_size
, 
GFP_NOFS
);

2546 
b_íåy_«me
 = 
	`kmÆloc
(
íåy
->
e_«me_Àn
 + 1, 
GFP_NOFS
);

2547 i‡(!
is
 || !
bs
 || !
buf„r
 || !
b_íåy_«me
) {

2548 
îr‹
 = -
ENOMEM
;

2549 
out
;

2552 
is
->
s
.
nŸ_found
 = -
ENODATA
;

2553 
bs
->
s
.
nŸ_found
 = -
ENODATA
;

2554 
is
->
ûoc
.
bh
 = 
NULL
;

2555 
bs
->
bh
 = 
NULL
;

2558 i‡(
íåy
->
e_vÆue_öum
) {

2559 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
, 
vÆue_size
);

2560 i‡(
îr‹
)

2561 
out
;

2563 
size_t
 
vÆue_offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

2564 
	`mem˝y
(
buf„r
, (*)
	`IFIRST
(
hódî
Ë+ 
vÆue_offs
, 
vÆue_size
);

2567 
	`mem˝y
(
b_íåy_«me
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

2568 
b_íåy_«me
[
íåy
->
e_«me_Àn
] = '\0';

2569 
i
.
«me
 = 
b_íåy_«me
;

2571 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
->
ûoc
);

2572 i‡(
îr‹
)

2573 
out
;

2575 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, 
is
);

2576 i‡(
îr‹
)

2577 
out
;

2580 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, 
is
);

2581 i‡(
îr‹
)

2582 
out
;

2584 
i
.
vÆue
 = 
buf„r
;

2585 
i
.
vÆue_Àn
 = 
vÆue_size
;

2586 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, 
bs
);

2587 i‡(
îr‹
)

2588 
out
;

2591 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, 
bs
);

2592 i‡(
îr‹
)

2593 
out
;

2594 
îr‹
 = 0;

2595 
out
:

2596 
	`k‰ì
(
b_íåy_«me
);

2597 
	`k‰ì
(
buf„r
);

2598 i‡(
is
)

2599 
	`bªl£
(
is
->
ûoc
.
bh
);

2600 i‡(
bs
)

2601 
	`bªl£
(
bs
->
bh
);

2602 
	`k‰ì
(
is
);

2603 
	`k‰ì
(
bs
);

2605  
îr‹
;

2606 
	}
}

2608 
	$pxt4_x©å_make_öode_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2609 
pxt4_öode
 *
øw_öode
,

2610 
isize_diff
, 
size_t
 
i‰ì
,

2611 
size_t
 
b‰ì
, *
tŸÆ_öo
)

2613 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2614 
pxt4_x©å_íåy
 *
smÆl_íåy
;

2615 
pxt4_x©å_íåy
 *
íåy
;

2616 
pxt4_x©å_íåy
 *
œ°
;

2617 
íåy_size
;

2618 
tŸÆ_size
;

2619 
mö_tŸÆ_size
;

2620 
îr‹
;

2622 
isize_diff
 > 
i‰ì
) {

2623 
íåy
 = 
NULL
;

2624 
smÆl_íåy
 = 
NULL
;

2625 
mö_tŸÆ_size
 = ~0U;

2626 
œ°
 = 
	`IFIRST
(
hódî
);

2628 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2630 i‡((
œ°
->
e_«me_Àn
 == 4) &&

2631 (
œ°
->
e_«me_ödex
 =
PXT4_XATTR_INDEX_SYSTEM
) &&

2632 !
	`memcmp
(
œ°
->
e_«me
, "data", 4))

2634 
tŸÆ_size
 = 
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

2635 i‡(!
œ°
->
e_vÆue_öum
)

2636 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2637 
	`À32_to_˝u
(
œ°
->
e_vÆue_size
));

2638 i‡(
tŸÆ_size
 <
b‰ì
 &&

2639 
tŸÆ_size
 < 
mö_tŸÆ_size
) {

2640 i‡(
tŸÆ_size
 + 
i‰ì
 < 
isize_diff
) {

2641 
smÆl_íåy
 = 
œ°
;

2643 
íåy
 = 
œ°
;

2644 
mö_tŸÆ_size
 = 
tŸÆ_size
;

2649 i‡(
íåy
 =
NULL
) {

2650 i‡(
smÆl_íåy
 =
NULL
)

2651  -
ENOSPC
;

2652 
íåy
 = 
smÆl_íåy
;

2655 
íåy_size
 = 
	`PXT4_XATTR_LEN
(
íåy
->
e_«me_Àn
);

2656 
tŸÆ_size
 = 
íåy_size
;

2657 i‡(!
íåy
->
e_vÆue_öum
)

2658 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2659 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2660 
îr‹
 = 
	`pxt4_x©å_move_to_block
(
h™dÀ
, 
öode
, 
øw_öode
,

2661 
íåy
);

2662 i‡(
îr‹
)

2663  
îr‹
;

2665 *
tŸÆ_öo
 -
íåy_size
;

2666 
i‰ì
 +
tŸÆ_size
;

2667 
b‰ì
 -
tŸÆ_size
;

2671 
	}
}

2677 
	$pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

2678 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
)

2680 
pxt4_x©å_ibody_hódî
 *
hódî
;

2681 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2682 
m¡_cou¡
;

2683 
size_t
 
mö_offs
;

2684 
size_t
 
i‰ì
, 
b‰ì
;

2685 
tŸÆ_öo
;

2686 *
ba£
, *
íd
;

2687 
îr‹
 = 0, 
åõd_mö_exåa_isize
 = 0;

2688 
s_mö_exåa_isize
 = 
	`À16_to_˝u
(
sbi
->
s_es
->s_min_extra_isize);

2689 
isize_diff
;

2691 
ªåy
:

2692 
isize_diff
 = 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

2693 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 >
√w_exåa_isize
)

2696 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2703 
ba£
 = 
	`IFIRST
(
hódî
);

2704 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2705 
mö_offs
 = 
íd
 - 
ba£
;

2706 
tŸÆ_öo
 = (
pxt4_x©å_ibody_hódî
Ë+ (
u32
);

2708 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

2709 i‡(
îr‹
)

2710 
˛ónup
;

2712 
i‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
ba£
, &
mö_offs
, ba£, &
tŸÆ_öo
);

2713 i‡(
i‰ì
 >
isize_diff
)

2714 
shi·
;

2720 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2721 
buf„r_hód
 *
bh
;

2723 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2724 i‡(
	`IS_ERR
(
bh
)) {

2725 
îr‹
 = 
	`PTR_ERR
(
bh
);

2726 
˛ónup
;

2728 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2729 i‡(
îr‹
) {

2730 
	`bªl£
(
bh
);

2731 
˛ónup
;

2733 
ba£
 = 
	`BHDR
(
bh
);

2734 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

2735 
mö_offs
 = 
íd
 - 
ba£
;

2736 
b‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
	`BFIRST
(
bh
), &
mö_offs
, 
ba£
,

2737 
NULL
);

2738 
	`bªl£
(
bh
);

2739 i‡(
b‰ì
 + 
i‰ì
 < 
isize_diff
) {

2740 i‡(!
åõd_mö_exåa_isize
 && 
s_mö_exåa_isize
) {

2741 
åõd_mö_exåa_isize
++;

2742 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2743 
ªåy
;

2745 
îr‹
 = -
ENOSPC
;

2746 
˛ónup
;

2749 
b‰ì
 = 
öode
->
i_sb
->
s_blocksize
;

2752 
îr‹
 = 
	`pxt4_x©å_make_öode_•a˚
(
h™dÀ
, 
öode
, 
øw_öode
,

2753 
isize_diff
, 
i‰ì
, 
b‰ì
,

2754 &
tŸÆ_öo
);

2755 i‡(
îr‹
) {

2756 i‡(
îr‹
 =-
ENOSPC
 && !
åõd_mö_exåa_isize
 &&

2757 
s_mö_exåa_isize
) {

2758 
åõd_mö_exåa_isize
++;

2759 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2760 
ªåy
;

2762 
˛ónup
;

2764 
shi·
:

2766 
	`pxt4_x©å_shi·_íåõs
(
	`IFIRST
(
hódî
), 
	`PXT4_I
(
öode
)->
i_exåa_isize


2767 - 
√w_exåa_isize
, (*)
øw_öode
 +

2768 
PXT4_GOOD_OLD_INODE_SIZE
 + 
√w_exåa_isize
,

2769 (*)
hódî
, 
tŸÆ_öo
);

2770 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

2772 
˛ónup
:

2773 i‡(
îr‹
 && (
m¡_cou¡
 !
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
))) {

2774 
	`pxt4_w¨nög
(
öode
->
i_sb
, "UnableÅoÉxpand inode %lu. Delete some EAs orÑunÉ2fsck.",

2775 
öode
->
i_öo
);

2776 
m¡_cou¡
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
);

2778  
îr‹
;

2779 
	}
}

2781 
	#EIA_INCR
 16

	)

2782 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2789 
	$pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2790 
öode
 *inode)

2792 i‡(*
ó_öode_¨øy
 =
NULL
) {

2797 (*
ó_öode_¨øy
) =

2798 
	`kmÆloc
(
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2799 
öodes
[
EIA_MASK
]),

2800 
GFP_NOFS
);

2801 i‡(*
ó_öode_¨øy
 =
NULL
)

2802  -
ENOMEM
;

2803 (*
ó_öode_¨øy
)->
cou¡
 = 0;

2804 } i‡(((*
ó_öode_¨øy
)->
cou¡
 & 
EIA_MASK
) == EIA_MASK) {

2806 
pxt4_x©å_öode_¨øy
 *
√w_¨øy
 = 
NULL
;

2807 
cou¡
 = (*
ó_öode_¨øy
)->count;

2810 
√w_¨øy
 = 
	`kmÆloc
(

2811 
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2812 
öodes
[
cou¡
 + 
EIA_INCR
]),

2813 
GFP_NOFS
);

2814 i‡(
√w_¨øy
 =
NULL
)

2815  -
ENOMEM
;

2816 
	`mem˝y
(
√w_¨øy
, *
ó_öode_¨øy
,

2817 
	`off£tof
(
pxt4_x©å_öode_¨øy
, 
öodes
[
cou¡
]));

2818 
	`k‰ì
(*
ó_öode_¨øy
);

2819 *
ó_öode_¨øy
 = 
√w_¨øy
;

2821 (*
ó_öode_¨øy
)->
öodes
[(*ó_öode_¨øy)->
cou¡
++] = 
öode
;

2823 
	}
}

2834 
	$pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2835 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2836 
exåa_¸edôs
)

2838 
buf„r_hód
 *
bh
 = 
NULL
;

2839 
pxt4_x©å_ibody_hódî
 *
hódî
;

2840 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

2841 
pxt4_x©å_íåy
 *
íåy
;

2842 
öode
 *
ó_öode
;

2843 
îr‹
;

2845 
îr‹
 = 
	`pxt4_jou∫Æ_ísuª_¸edôs
(
h™dÀ
, 
exåa_¸edôs
,

2846 
	`pxt4_‰ì_mëad©a_ªvoke_¸edôs
(
öode
->
i_sb
, 1));

2847 i‡(
îr‹
 < 0) {

2848 
	`PXT4_ERROR_INODE
(
öode
, "ísuª cªdô†”º‹ %d)", 
îr‹
);

2849 
˛ónup
;

2852 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2853 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2855 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2856 i‡(
îr‹
) {

2857 
	`PXT4_ERROR_INODE
(
öode
, "öodêlo¯”º‹ %d)", 
îr‹
);

2858 
˛ónup
;

2861 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

2862 i‡(
îr‹
) {

2863 
	`PXT4_ERROR_INODE
(
öode
, "writeáccess (error %d)",

2864 
îr‹
);

2865 
˛ónup
;

2868 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
ûoc
));

2869 i‡(
hódî
->
h_magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
))

2870 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
ûoc
.
bh
,

2871 
	`IFIRST
(
hódî
),

2872 
Ál£
 ,

2873 
ó_öode_¨øy
,

2874 
exåa_¸edôs
,

2875 
Ál£
 );

2878 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2879 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2880 i‡(
	`IS_ERR
(
bh
)) {

2881 
îr‹
 = 
	`PTR_ERR
(
bh
);

2882 i‡(
îr‹
 =-
EIO
)

2883 
	`PXT4_ERROR_INODE
(
öode
, "block %lluÑeadÉrror",

2884 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2885 
bh
 = 
NULL
;

2886 
˛ónup
;

2888 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2889 i‡(
îr‹
)

2890 
˛ónup
;

2892 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
)) {

2893 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2894 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

2895 i‡(!
íåy
->
e_vÆue_öum
)

2897 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
,

2898 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

2899 
	`À32_to_˝u
(
íåy
->
e_hash
),

2900 &
ó_öode
);

2901 i‡(
îr‹
)

2903 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2904 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2905 
	`ùut
(
ó_öode
);

2910 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bh
, 
ó_öode_¨øy
,

2911 
exåa_¸edôs
);

2916 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 0;

2917 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2918 i‡(
îr‹
) {

2919 
	`PXT4_ERROR_INODE
(
öode
, "mark inode dirty (error %d)",

2920 
îr‹
);

2921 
˛ónup
;

2924 
îr‹
 = 0;

2925 
˛ónup
:

2926 
	`bªl£
(
ûoc
.
bh
);

2927 
	`bªl£
(
bh
);

2928  
îr‹
;

2929 
	}
}

2931 
	$pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
)

2933 
idx
;

2935 i‡(
ó_öode_¨øy
 =
NULL
)

2938 
idx
 = 0; idx < 
ó_öode_¨øy
->
cou¡
; ++idx)

2939 
	`ùut
(
ó_öode_¨øy
->
öodes
[
idx
]);

2940 
	`k‰ì
(
ó_öode_¨øy
);

2941 
	}
}

2952 
	$pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *
ó_block_ˇche
,

2953 
buf„r_hód
 *
bh
)

2955 
pxt4_x©å_hódî
 *
hódî
 = 
	`BHDR
(
bh
);

2956 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

2957 
ªußbÀ
 = 
	`À32_to_˝u
(
hódî
->
h_ªfcou¡
) <

2958 
PXT4_XATTR_REFCOUNT_MAX
;

2959 
îr‹
;

2961 i‡(!
ó_block_ˇche
)

2963 
îr‹
 = 
	`mb_ˇche_íåy_¸óã
(
ó_block_ˇche
, 
GFP_NOFS
, 
hash
,

2964 
bh
->
b_blockƒ
, 
ªußbÀ
);

2965 i‡(
îr‹
) {

2966 i‡(
îr‹
 =-
EBUSY
)

2967 
	`ó_bdebug
(
bh
, "already in cache");

2969 
	`ó_bdebug
(
bh
, "ö£πög [%x]", ()
hash
);

2970 
	}
}

2981 
	$pxt4_x©å_cmp
(
pxt4_x©å_hódî
 *
hódî1
,

2982 
pxt4_x©å_hódî
 *
hódî2
)

2984 
pxt4_x©å_íåy
 *
íåy1
, *
íåy2
;

2986 
íåy1
 = 
	`ENTRY
(
hódî1
+1);

2987 
íåy2
 = 
	`ENTRY
(
hódî2
+1);

2988 !
	`IS_LAST_ENTRY
(
íåy1
)) {

2989 i‡(
	`IS_LAST_ENTRY
(
íåy2
))

2991 i‡(
íåy1
->
e_hash
 !
íåy2
->e_hash ||

2992 
íåy1
->
e_«me_ödex
 !
íåy2
->e_name_index ||

2993 
íåy1
->
e_«me_Àn
 !
íåy2
->e_name_len ||

2994 
íåy1
->
e_vÆue_size
 !
íåy2
->e_value_size ||

2995 
íåy1
->
e_vÆue_öum
 !
íåy2
->e_value_inum ||

2996 
	`memcmp
(
íåy1
->
e_«me
, 
íåy2
->e_«me,É¡ry1->
e_«me_Àn
))

2998 i‡(!
íåy1
->
e_vÆue_öum
 &&

2999 
	`memcmp
((*)
hódî1
 + 
	`À16_to_˝u
(
íåy1
->
e_vÆue_offs
),

3000 (*)
hódî2
 + 
	`À16_to_˝u
(
íåy2
->
e_vÆue_offs
),

3001 
	`À32_to_˝u
(
íåy1
->
e_vÆue_size
)))

3004 
íåy1
 = 
	`PXT4_XATTR_NEXT
(entry1);

3005 
íåy2
 = 
	`PXT4_XATTR_NEXT
(entry2);

3007 i‡(!
	`IS_LAST_ENTRY
(
íåy2
))

3010 
	}
}

3020 
buf„r_hód
 *

3021 
	$pxt4_x©å_block_ˇche_föd
(
öode
 *inode,

3022 
pxt4_x©å_hódî
 *
hódî
,

3023 
mb_ˇche_íåy
 **
p˚
)

3025 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

3026 
mb_ˇche_íåy
 *
˚
;

3027 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

3029 i‡(!
ó_block_ˇche
)

3030  
NULL
;

3031 i‡(!
hódî
->
h_hash
)

3032  
NULL
;

3033 
	`ó_idebug
(
öode
, "lookög f‹ cached block†[%x]", ()
hash
);

3034 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_block_ˇche
, 
hash
);

3035 
˚
) {

3036 
buf„r_hód
 *
bh
;

3038 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
˚
->
e_vÆue
, 
REQ_PRIO
);

3039 i‡(
	`IS_ERR
(
bh
)) {

3040 i‡(
	`PTR_ERR
(
bh
Ë=-
ENOMEM
)

3041  
NULL
;

3042 
bh
 = 
NULL
;

3043 
	`PXT4_ERROR_INODE
(
öode
, "block %luÑeadÉrror",

3044 ()
˚
->
e_vÆue
);

3045 } i‡(
	`pxt4_x©å_cmp
(
hódî
, 
	`BHDR
(
bh
)) == 0) {

3046 *
p˚
 = 
˚
;

3047  
bh
;

3049 
	`bªl£
(
bh
);

3050 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_block_ˇche
, ce);

3052  
NULL
;

3053 
	}
}

3055 
	#NAME_HASH_SHIFT
 5

	)

3056 
	#VALUE_HASH_SHIFT
 16

	)

3063 
__À32
 
	$pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, 
__À32
 *
vÆue
,

3064 
size_t
 
vÆue_cou¡
)

3066 
__u32
 
hash
 = 0;

3068 
«me_Àn
--) {

3069 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3070 (
hash
 >> (8*(hashË- 
NAME_HASH_SHIFT
)) ^

3071 *
«me
++;

3073 
vÆue_cou¡
--) {

3074 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3075 (
hash
 >> (8*(hashË- 
VALUE_HASH_SHIFT
)) ^

3076 
	`À32_to_˝u
(*
vÆue
++);

3078  
	`˝u_to_À32
(
hash
);

3079 
	}
}

3081 #unde‡
NAME_HASH_SHIFT


3082 #unde‡
VALUE_HASH_SHIFT


3084 
	#BLOCK_HASH_SHIFT
 16

	)

3091 
	$pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *
hódî
)

3093 
pxt4_x©å_íåy
 *
hîe
;

3094 
__u32
 
hash
 = 0;

3096 
hîe
 = 
	`ENTRY
(
hódî
+1);

3097 !
	`IS_LAST_ENTRY
(
hîe
)) {

3098 i‡(!
hîe
->
e_hash
) {

3100 
hash
 = 0;

3103 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3104 (
hash
 >> (8*(hashË- 
BLOCK_HASH_SHIFT
)) ^

3105 
	`À32_to_˝u
(
hîe
->
e_hash
);

3106 
hîe
 = 
	`PXT4_XATTR_NEXT
(here);

3108 
hódî
->
h_hash
 = 
	`˝u_to_À32
(
hash
);

3109 
	}
}

3111 #unde‡
BLOCK_HASH_SHIFT


3113 
	#HASH_BUCKET_BITS
 10

	)

3115 
mb_ˇche
 *

3116 
	$pxt4_x©å_¸óã_ˇche
()

3118  
	`mb_ˇche_¸óã
(
HASH_BUCKET_BITS
);

3119 
	}
}

3121 
	$pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *
ˇche
)

3123 i‡(
ˇche
)

3124 
	`mb_ˇche_de°roy
(
ˇche
);

3125 
	}
}

	@xattr.h

10 
	~<löux/x©å.h
>

13 
	#PXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#PXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#PXT4_XATTR_INDEX_USER
 1

	)

20 
	#PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#PXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#PXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#PXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#PXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#PXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#PXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#PXT4_XATTR_INDEX_HURD
 10

	)

30 
	spxt4_x©å_hódî
 {

31 
__À32
 
	mh_magic
;

32 
__À32
 
	mh_ªfcou¡
;

33 
__À32
 
	mh_blocks
;

34 
__À32
 
	mh_hash
;

35 
__À32
 
	mh_checksum
;

37 
__u32
 
	mh_ª£rved
[3];

40 
	spxt4_x©å_ibody_hódî
 {

41 
__À32
 
	mh_magic
;

44 
	spxt4_x©å_íåy
 {

45 
__u8
 
	me_«me_Àn
;

46 
__u8
 
	me_«me_ödex
;

47 
__À16
 
	me_vÆue_offs
;

48 
__À32
 
	me_vÆue_öum
;

49 
__À32
 
	me_vÆue_size
;

50 
__À32
 
	me_hash
;

51 
	me_«me
[0];

54 
	#PXT4_XATTR_PAD_BITS
 2

	)

55 
	#PXT4_XATTR_PAD
 (1<<
PXT4_XATTR_PAD_BITS
)

	)

56 
	#PXT4_XATTR_ROUND
 (
PXT4_XATTR_PAD
-1)

	)

57 
	#PXT4_XATTR_LEN
(
«me_Àn
) \

58 (((
«me_Àn
Ë+ 
PXT4_XATTR_ROUND
 + \

59 (
pxt4_x©å_íåy
)Ë& ~
PXT4_XATTR_ROUND
)

	)

60 
	#PXT4_XATTR_NEXT
(
íåy
) \

61 ((
pxt4_x©å_íåy
 *)( \

62 (*)(
íåy
Ë+ 
	`PXT4_XATTR_LEN
(”¡ry)->
e_«me_Àn
)))

	)

63 
	#PXT4_XATTR_SIZE
(
size
) \

64 (((
size
Ë+ 
PXT4_XATTR_ROUND
Ë& ~PXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
öode
, 
øw_öode
) \

67 ((
pxt4_x©å_ibody_hódî
 *) \

68 ((*)
øw_öode
 + \

69 
PXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`PXT4_I
(
öode
)->
i_exåa_isize
))

	)

71 
	#IFIRST
(
hdr
Ë((
pxt4_x©å_íåy
 *)((hdr)+1))

	)

82 
	#PXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#PXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
Ë- 
	`PXT4_XATTR_LEN
(3Ë- (
pxt4_x©å_hódî
Ë- 4)

	)

91 
	#BHDR
(
bh
Ë((
pxt4_x©å_hódî
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
Ë((
pxt4_x©å_íåy
 *)’å))

	)

93 
	#BFIRST
(
bh
Ë
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
íåy
Ë(*(
__u32
 *)”¡ryË=0)

	)

96 
	#PXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	spxt4_x©å_öfo
 {

99 c⁄° *
	m«me
;

100 c⁄° *
	mvÆue
;

101 
size_t
 
	mvÆue_Àn
;

102 
	m«me_ödex
;

103 
	mö_öode
;

106 
	spxt4_x©å_£¨ch
 {

107 
pxt4_x©å_íåy
 *
	mfú°
;

108 *
	mba£
;

109 *
	míd
;

110 
pxt4_x©å_íåy
 *
	mhîe
;

111 
	mnŸ_found
;

114 
	spxt4_x©å_ibody_föd
 {

115 
pxt4_x©å_£¨ch
 
	ms
;

116 
pxt4_ûoc
 
	mûoc
;

119 
	spxt4_x©å_öode_¨øy
 {

120 
	mcou¡
;

121 
öode
 *
	möodes
[0];

124 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_u£r_h™dÀr
;

125 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_åu°ed_h™dÀr
;

126 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_£curôy_h™dÀr
;

128 
	#PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
ölöe
 
	$pxt4_wrôe_lock_x©å
(
öode
 *öode, *
ßve
)

141 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

142 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

143 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
ölöe
 
	$pxt4_wrôe_åylock_x©å
(
öode
 *öode, *
ßve
)

148 i‡(
	`down_wrôe_åylock
(&
	`PXT4_I
(
öode
)->
x©å_£m
) == 0)

150 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

151 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
ölöe
 
	$pxt4_wrôe_u∆ock_x©å
(
öode
 *öode, *
ßve
)

157 i‡(*
ßve
 == 0)

158 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

159 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

160 
	}
}

162 
ssize_t
 
pxt4_li°x©å
(
díåy
 *, *, 
size_t
);

164 
pxt4_x©å_gë
(
öode
 *, , c⁄° *, *, 
size_t
);

165 
pxt4_x©å_£t
(
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

166 
pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *, 
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

167 
pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

168 
boﬁ
 
is_¸óã
, *
¸edôs
);

169 
__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

170 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

171 
boﬁ
 
is_¸óã
);

173 
pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

174 
pxt4_x©å_öode_¨øy
 **
¨øy
,

175 
exåa_¸edôs
);

176 
pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
¨øy
);

178 
pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

179 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
);

181 c⁄° 
x©å_h™dÀr
 *
pxt4_x©å_h™dÀrs
[];

183 
pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

184 
pxt4_x©å_ibody_föd
 *
is
);

185 
pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
,

186 c⁄° *
«me
,

187 *
buf„r
, 
size_t
 
buf„r_size
);

188 
pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

189 
pxt4_x©å_öfo
 *
i
,

190 
pxt4_x©å_ibody_föd
 *
is
);

192 
mb_ˇche
 *
pxt4_x©å_¸óã_ˇche
();

193 
pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *);

195 #ifde‡
CONFIG_EXT4_FS_SECURITY


196 
pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

197 
öode
 *
dú
, c⁄° 
q°r
 *qstr);

199 
ölöe
 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

200 
öode
 *
dú
, c⁄° 
q°r
 *qstr)

203 
	}
}

206 #ifde‡
CONFIG_LOCKDEP


207 
pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
);

209 
ölöe
 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
Ë{ 
	}
}

212 
pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
);

	@xattr_security.c

7 
	~<löux/°rög.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/£curôy.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

16 
	$pxt4_x©å_£curôy_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

17 
díåy
 *
unu£d
, 
öode
 *inode,

18 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

20  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

21 
«me
, 
buf„r
, 
size
);

22 
	}
}

25 
	$pxt4_x©å_£curôy_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

26 
díåy
 *
unu£d
, 
öode
 *inode,

27 c⁄° *
«me
, c⁄° *
vÆue
,

28 
size_t
 
size
, 
Êags
)

30  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

31 
«me
, 
vÆue
, 
size
, 
Êags
);

32 
	}
}

35 
	$pxt4_öôx©ås
(
öode
 *öode, c⁄° 
x©å
 *
x©å_¨øy
,

36 *
fs_öfo
)

38 c⁄° 
x©å
 *xattr;

39 
h™dÀ_t
 *
h™dÀ
 = 
fs_öfo
;

40 
îr
 = 0;

42 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

43 
îr
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

44 
PXT4_XATTR_INDEX_SECURITY
,

45 
x©å
->
«me
, x©å->
vÆue
,

46 
x©å
->
vÆue_Àn
, 
XATTR_CREATE
);

47 i‡(
îr
 < 0)

50  
îr
;

51 
	}
}

54 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
,

55 c⁄° 
q°r
 *qstr)

57  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

58 &
pxt4_öôx©ås
, 
h™dÀ
);

59 
	}
}

61 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_£curôy_h™dÀr
 = {

62 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	ggë
 = 
pxt4_x©å_£curôy_gë
,

64 .
	g£t
 = 
pxt4_x©å_£curôy_£t
,

	@xattr_trusted.c

9 
	~<löux/°rög.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/fs.h
>

12 
	~"pxt4_jbd3.h
"

13 
	~"pxt4.h
"

14 
	~"x©å.h
"

16 
boﬁ


17 
	$pxt4_x©å_åu°ed_li°
(
díåy
 *dentry)

19  
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$pxt4_x©å_åu°ed_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

24 
díåy
 *
unu£d
, 
öode
 *inode,

25 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

27  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

28 
«me
, 
buf„r
, 
size
);

29 
	}
}

32 
	$pxt4_x©å_åu°ed_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

33 
díåy
 *
unu£d
, 
öode
 *inode,

34 c⁄° *
«me
, c⁄° *
vÆue
,

35 
size_t
 
size
, 
Êags
)

37  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

38 
«me
, 
vÆue
, 
size
, 
Êags
);

39 
	}
}

41 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_åu°ed_h™dÀr
 = {

42 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli°
 = 
pxt4_x©å_åu°ed_li°
,

44 .
	ggë
 = 
pxt4_x©å_åu°ed_gë
,

45 .
	g£t
 = 
pxt4_x©å_åu°ed_£t
,

	@xattr_user.c

9 
	~<löux/°rög.h
>

10 
	~<löux/fs.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

15 
boﬁ


16 
	$pxt4_x©å_u£r_li°
(
díåy
 *dentry)

18  
	`ã°_›t
(
díåy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$pxt4_x©å_u£r_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

23 
díåy
 *
unu£d
, 
öode
 *inode,

24 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

26 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_USER
,

29 
«me
, 
buf„r
, 
size
);

30 
	}
}

33 
	$pxt4_x©å_u£r_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

34 
díåy
 *
unu£d
, 
öode
 *inode,

35 c⁄° *
«me
, c⁄° *
vÆue
,

36 
size_t
 
size
, 
Êags
)

38 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_USER
,

41 
«me
, 
vÆue
, 
size
, 
Êags
);

42 
	}
}

44 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_u£r_h™dÀr
 = {

45 .
¥efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli°
 = 
pxt4_x©å_u£r_li°
,

47 .
	ggë
 = 
pxt4_x©å_u£r_gë
,

48 .
	g£t
 = 
pxt4_x©å_u£r_£t
,

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

377 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #i‚de‡
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/f˙é.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

51 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

52 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

53 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

54 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

60 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

61 
	#RWH_WRITE_LIFE_NONE
 1

	)

62 
	#RWH_WRITE_LIFE_SHORT
 2

	)

63 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

64 
	#RWH_WRITE_LIFE_LONG
 4

	)

65 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

70 
	#DN_ACCESS
 0x00000001

	)

71 
	#DN_MODIFY
 0x00000002

	)

72 
	#DN_CREATE
 0x00000004

	)

73 
	#DN_DELETE
 0x00000008

	)

74 
	#DN_RENAME
 0x00000010

	)

75 
	#DN_ATTRIB
 0x00000020

	)

76 
	#DN_MULTISHOT
 0x80000000

	)

78 
	#AT_FDCWD
 -100

	)

81 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

82 
	#AT_REMOVEDIR
 0x200

	)

84 
	#AT_SYMLINK_FOLLOW
 0x400

	)

85 
	#AT_NO_AUTOMOUNT
 0x800

	)

86 
	#AT_EMPTY_PATH
 0x1000

	)

88 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

89 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

90 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

91 
	#AT_STATX_DONT_SYNC
 0x4000

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

28 #unde‡
NR_OPEN


29 
	#INR_OPEN_CUR
 1024

	)

30 
	#INR_OPEN_MAX
 4096

	)

32 
	#BLOCK_SIZE_BITS
 10

	)

33 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

35 
	#SEEK_SET
 0

	)

36 
	#SEEK_CUR
 1

	)

37 
	#SEEK_END
 2

	)

38 
	#SEEK_DATA
 3

	)

39 
	#SEEK_HOLE
 4

	)

40 
	#SEEK_MAX
 
SEEK_HOLE


	)

42 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

43 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

44 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

46 
	sfûe_˛⁄e_ønge
 {

47 
__s64
 
	m§c_fd
;

48 
__u64
 
	m§c_off£t
;

49 
__u64
 
	m§c_Àngth
;

50 
__u64
 
	mde°_off£t
;

53 
	sf°rim_ønge
 {

54 
__u64
 
	m°¨t
;

55 
__u64
 
	mÀn
;

56 
__u64
 
	mmöÀn
;

60 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

61 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

64 
	sfûe_dedu≥_ønge_öfo
 {

65 
__s64
 
	mde°_fd
;

66 
__u64
 
	mde°_off£t
;

67 
__u64
 
	mbyãs_dedu≥d
;

74 
__s32
 
	m°©us
;

75 
__u32
 
	mª£rved
;

79 
	sfûe_dedu≥_ønge
 {

80 
__u64
 
	m§c_off£t
;

81 
__u64
 
	m§c_Àngth
;

82 
__u16
 
	mde°_cou¡
;

83 
__u16
 
	mª£rved1
;

84 
__u32
 
	mª£rved2
;

85 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

89 
	sfûes_°©_°ru˘
 {

90 
	mƒ_fûes
;

91 
	mƒ_‰ì_fûes
;

92 
	mmax_fûes
;

95 
	söodes_°©_t
 {

96 
	mƒ_öodes
;

97 
	mƒ_unu£d
;

98 
	mdummy
[5];

102 
	#NR_FILE
 8192

	)

108 
	#MS_RDONLY
 1

	)

109 
	#MS_NOSUID
 2

	)

110 
	#MS_NODEV
 4

	)

111 
	#MS_NOEXEC
 8

	)

112 
	#MS_SYNCHRONOUS
 16

	)

113 
	#MS_REMOUNT
 32

	)

114 
	#MS_MANDLOCK
 64

	)

115 
	#MS_DIRSYNC
 128

	)

116 
	#MS_NOATIME
 1024

	)

117 
	#MS_NODIRATIME
 2048

	)

118 
	#MS_BIND
 4096

	)

119 
	#MS_MOVE
 8192

	)

120 
	#MS_REC
 16384

	)

121 
	#MS_VERBOSE
 32768

	)

123 
	#MS_SILENT
 32768

	)

124 
	#MS_POSIXACL
 (1<<16Ë

	)

125 
	#MS_UNBINDABLE
 (1<<17Ë

	)

126 
	#MS_PRIVATE
 (1<<18Ë

	)

127 
	#MS_SLAVE
 (1<<19Ë

	)

128 
	#MS_SHARED
 (1<<20Ë

	)

129 
	#MS_RELATIME
 (1<<21Ë

	)

130 
	#MS_KERNMOUNT
 (1<<22Ë

	)

131 
	#MS_I_VERSION
 (1<<23Ë

	)

132 
	#MS_STRICTATIME
 (1<<24Ë

	)

133 
	#MS_LAZYTIME
 (1<<25Ë

	)

136 
	#MS_SUBMOUNT
 (1<<26)

	)

137 
	#MS_NOREMOTELOCK
 (1<<27)

	)

138 
	#MS_NOSEC
 (1<<28)

	)

139 
	#MS_BORN
 (1<<29)

	)

140 
	#MS_ACTIVE
 (1<<30)

	)

141 
	#MS_NOUSER
 (1<<31)

	)

146 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

147 
MS_LAZYTIME
)

	)

152 
	#MS_MGC_VAL
 0xC0ED0000

	)

153 
	#MS_MGC_MSK
 0xffff0000

	)

158 
	sfsx©å
 {

159 
__u32
 
	mfsx_xÊags
;

160 
__u32
 
	mfsx_extsize
;

161 
__u32
 
	mfsx_√xã¡s
;

162 
__u32
 
	mfsx_¥ojid
;

163 
__u32
 
	mfsx_cowextsize
;

164 
	mfsx_∑d
[8];

170 
	#FS_XFLAG_REALTIME
 0x00000001

	)

171 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

172 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

173 
	#FS_XFLAG_APPEND
 0x00000010

	)

174 
	#FS_XFLAG_SYNC
 0x00000020

	)

175 
	#FS_XFLAG_NOATIME
 0x00000040

	)

176 
	#FS_XFLAG_NODUMP
 0x00000080

	)

177 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

178 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

179 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

180 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

181 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

182 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

183 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

184 
	#FS_XFLAG_DAX
 0x00008000

	)

185 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

186 
	#FS_XFLAG_HASATTR
 0x80000000

	)

191 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

192 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

193 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

194 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

195 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

196 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

197 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

198 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

199 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

200 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

201 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

202 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

204 
	#BLKPG
 
	`_IO
(0x12,105)

	)

208 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

209 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

214 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

215 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

216 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

217 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

218 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

219 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

220 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

221 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

222 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

223 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

224 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

225 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

226 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

227 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

228 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

229 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

235 
	#BMAP_IOCTL
 1

	)

236 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

237 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

238 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

239 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

240 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

241 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

242 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

243 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

245 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

246 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

247 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

248 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

249 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

250 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

251 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

252 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

253 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

254 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©å
)

	)

255 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©å
)

	)

261 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

263 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

264 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

265 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

266 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

267 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

268 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

271 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

275 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

277 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

279 
	sfs¸y±_pﬁicy
 {

280 
__u8
 
	mvîsi⁄
;

281 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

282 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

283 
__u8
 
	mÊags
;

284 
__u8
 
	mma°î_key_des¸ùt‹
[
FS_KEY_DESCRIPTOR_SIZE
];

287 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

288 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

289 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

292 
	#FS_KEY_DESC_PREFIX
 "fs¸y±:"

	)

293 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

296 
	#FS_MAX_KEY_SIZE
 64

	)

298 
	sfs¸y±_key
 {

299 
__u32
 
	mmode
;

300 
__u8
 
	møw
[
FS_MAX_KEY_SIZE
];

301 
__u32
 
	msize
;

324 
	#FS_SECRM_FL
 0x00000001

	)

325 
	#FS_UNRM_FL
 0x00000002

	)

326 
	#FS_COMPR_FL
 0x00000004

	)

327 
	#FS_SYNC_FL
 0x00000008

	)

328 
	#FS_IMMUTABLE_FL
 0x00000010

	)

329 
	#FS_APPEND_FL
 0x00000020

	)

330 
	#FS_NODUMP_FL
 0x00000040

	)

331 
	#FS_NOATIME_FL
 0x00000080

	)

333 
	#FS_DIRTY_FL
 0x00000100

	)

334 
	#FS_COMPRBLK_FL
 0x00000200

	)

335 
	#FS_NOCOMP_FL
 0x00000400

	)

337 
	#FS_ENCRYPT_FL
 0x00000800

	)

338 
	#FS_BTREE_FL
 0x00001000

	)

339 
	#FS_INDEX_FL
 0x00001000

	)

340 
	#FS_IMAGIC_FL
 0x00002000

	)

341 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

342 
	#FS_NOTAIL_FL
 0x00008000

	)

343 
	#FS_DIRSYNC_FL
 0x00010000

	)

344 
	#FS_TOPDIR_FL
 0x00020000

	)

345 
	#FS_HUGE_FILE_FL
 0x00040000

	)

346 
	#FS_EXTENT_FL
 0x00080000

	)

347 
	#FS_EA_INODE_FL
 0x00200000

	)

348 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

349 
	#FS_NOCOW_FL
 0x00800000

	)

350 
	#FS_INLINE_DATA_FL
 0x10000000

	)

351 
	#FS_PROJINHERIT_FL
 0x20000000

	)

352 
	#FS_RESERVED_FL
 0x80000000

	)

354 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

355 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

358 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

359 
	#SYNC_FILE_RANGE_WRITE
 2

	)

360 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

366 
	t__bôwi£
 
	t__kî√l_rwf_t
;

369 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

372 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

375 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

378 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

381 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
)

	)

	@/usr/include/linux/fsmap.h

9 #i‚de‡
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<löux/ty≥s.h
>

50 
	sfsm≠
 {

51 
__u32
 
	mfmr_devi˚
;

52 
__u32
 
	mfmr_Êags
;

53 
__u64
 
	mfmr_physiˇl
;

54 
__u64
 
	mfmr_ow√r
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Àngth
;

57 
__u64
 
	mfmr_ª£rved
[3];

60 
	sfsm≠_hód
 {

61 
__u32
 
	mfmh_iÊags
;

62 
__u32
 
	mfmh_oÊags
;

63 
__u32
 
	mfmh_cou¡
;

64 
__u32
 
	mfmh_íåõs
;

65 
__u64
 
	mfmh_ª£rved
[6];

67 
fsm≠
 
	mfmh_keys
[2];

68 
fsm≠
 
	mfmh_ªcs
[];

72 
__ölöe__
 
size_t


73 
	$fsm≠_sizeof
(

74 
ƒ
)

76  (
fsm≠_hód
Ë+ 
ƒ
 * (
fsm≠
);

77 
	}
}

80 
__ölöe__
 

81 
	$fsm≠_adv™˚
(

82 
fsm≠_hód
 *
hód
)

84 
hód
->
fmh_keys
[0] = hód->
fmh_ªcs
[hód->
fmh_íåõs
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty≥
, 
code
Ë(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
ow√r
Ë((
__u32
)((
__u64
)ow√∏>> 32))

	)

106 
	#FMR_OWNER_CODE
(
ow√r
Ë((
__u32
)(((
__u64
)ow√∏& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1Ë

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2Ë

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3Ë

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm≠_hód
)

	)

	@/usr/include/linux/kdev_t.h

2 #i‚de‡
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

10 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

23 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

24 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

25 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

26 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

27 
	#NILFS_SUPER_MAGIC
 0x3434

	)

28 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

29 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

30 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

31 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

32 
	#PSTOREFS_MAGIC
 0x6165676C

	)

33 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

34 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

35 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

37 
	#MINIX_SUPER_MAGIC
 0x137F

	)

38 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

39 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

40 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

41 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

43 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

44 
	#NCP_SUPER_MAGIC
 0x564¯

	)

45 
	#NFS_SUPER_MAGIC
 0x6969

	)

46 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

47 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

48 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

49 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

50 
	#AFS_FS_MAGIC
 0x6B414653

	)

52 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

55 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

56 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

57 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

59 
	#SMB_SUPER_MAGIC
 0x517B

	)

60 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

61 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

63 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

65 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

67 
	#TRACEFS_MAGIC
 0x74726163

	)

69 
	#V9FS_MAGIC
 0x01021997

	)

71 
	#BDEVFS_MAGIC
 0x62646576

	)

72 
	#DAXFS_MAGIC
 0x64646178

	)

73 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

74 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

75 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

76 
	#PIPEFS_MAGIC
 0x50495045

	)

77 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

78 
	#SOCKFS_MAGIC
 0x534F434B

	)

79 
	#SYSFS_MAGIC
 0x62656572

	)

80 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

81 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

82 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

83 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

84 
	#NSFS_MAGIC
 0x6e736673

	)

85 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

86 
	#AAFS_MAGIC
 0x5a3c69f0

	)

89 
	#UDF_SUPER_MAGIC
 0x15013346

	)

90 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

91 
	#ZSMALLOC_MAGIC
 0x58295829

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

22 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

23 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

25 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

26 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

27 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

28 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

29 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

30 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

31 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

32 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

33 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

34 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/quota.h

33 #i‚de‡
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<löux/ty≥s.h
>

38 
	#__DQUOT_VERSION__
 "dquŸ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty≥
Ë(((cmdË<< 
SUBCMDSHIFT
Ë| (—y≥Ë& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¨dlimô
;

112 
__u64
 
	mdqb_bso·limô
;

113 
__u64
 
	mdqb_cur•a˚
;

114 
__u64
 
	mdqb_ih¨dlimô
;

115 
__u64
 
	mdqb_iso·limô
;

116 
__u64
 
	mdqb_curöodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_ôime
;

119 
__u32
 
	mdqb_vÆid
;

122 
	sif_√xtdqblk
 {

123 
__u64
 
	mdqb_bh¨dlimô
;

124 
__u64
 
	mdqb_bso·limô
;

125 
__u64
 
	mdqb_cur•a˚
;

126 
__u64
 
	mdqb_ih¨dlimô
;

127 
__u64
 
	mdqb_iso·limô
;

128 
__u64
 
	mdqb_curöodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_ôime
;

131 
__u32
 
	mdqb_vÆid
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqöfo
 {

157 
__u64
 
	mdqi_bgø˚
;

158 
__u64
 
	mdqi_igø˚
;

159 
__u32
 
	mdqi_Êags
;

160 
__u32
 
	mdqi_vÆid
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

8 
	#CSIGNAL
 0x000000f‡

	)

9 
	#CLONE_VM
 0x00000100

	)

10 
	#CLONE_FS
 0x00000200

	)

11 
	#CLONE_FILES
 0x00000400

	)

12 
	#CLONE_SIGHAND
 0x00000800

	)

13 
	#CLONE_PTRACE
 0x00002000

	)

14 
	#CLONE_VFORK
 0x00004000

	)

15 
	#CLONE_PARENT
 0x00008000

	)

16 
	#CLONE_THREAD
 0x00010000

	)

17 
	#CLONE_NEWNS
 0x00020000

	)

18 
	#CLONE_SYSVSEM
 0x00040000

	)

19 
	#CLONE_SETTLS
 0x00080000

	)

20 
	#CLONE_PARENT_SETTID
 0x00100000

	)

21 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

22 
	#CLONE_DETACHED
 0x00400000

	)

23 
	#CLONE_UNTRACED
 0x00800000

	)

24 
	#CLONE_CHILD_SETTID
 0x01000000

	)

25 
	#CLONE_NEWCGROUP
 0x02000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

42 
	#SCHED_DEADLINE
 6

	)

45 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

50 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

51 
	#SCHED_FLAG_RECLAIM
 0x02

	)

	@/usr/include/linux/stat.h

2 #i‚de‡
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<löux/ty≥s.h
>

7 #i‡
deföed
(
__KERNEL__
Ë|| !deföed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s°©x_time°amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__ª£rved
;

99 
	s°©x
 {

101 
__u32
 
	m°x_mask
;

102 
__u32
 
	m°x_blksize
;

103 
__u64
 
	m°x_©åibuãs
;

105 
__u32
 
	m°x_∆ök
;

106 
__u32
 
	m°x_uid
;

107 
__u32
 
	m°x_gid
;

108 
__u16
 
	m°x_mode
;

109 
__u16
 
	m__•¨e0
[1];

111 
__u64
 
	m°x_öo
;

112 
__u64
 
	m°x_size
;

113 
__u64
 
	m°x_blocks
;

114 
__u64
 
	m°x_©åibuãs_mask
;

116 
°©x_time°amp
 
	m°x_©ime
;

117 
°©x_time°amp
 
	m°x_btime
;

118 
°©x_time°amp
 
	m°x_˘ime
;

119 
°©x_time°amp
 
	m°x_mtime
;

121 
__u32
 
	m°x_rdev_maj‹
;

122 
__u32
 
	m°x_rdev_mö‹
;

123 
__u32
 
	m°x_dev_maj‹
;

124 
__u32
 
	m°x_dev_mö‹
;

126 
__u64
 
	m__•¨e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	stimez⁄e
 {

22 
	mtz_möuãswe°
;

23 
	mtz_d°time
;

31 
	#ITIMER_REAL
 0

	)

32 
	#ITIMER_VIRTUAL
 1

	)

33 
	#ITIMER_PROF
 2

	)

35 
	sôimî•ec
 {

36 
time•ec
 
	mô_öãrvÆ
;

37 
time•ec
 
	mô_vÆue
;

40 
	sôimîvÆ
 {

41 
timevÆ
 
	mô_öãrvÆ
;

42 
timevÆ
 
	mô_vÆue
;

48 
	#CLOCK_REALTIME
 0

	)

49 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

51 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

52 
	#CLOCK_MONOTONIC_RAW
 4

	)

53 
	#CLOCK_REALTIME_COARSE
 5

	)

54 
	#CLOCK_MONOTONIC_COARSE
 6

	)

55 
	#CLOCK_BOOTTIME
 7

	)

56 
	#CLOCK_REALTIME_ALARM
 8

	)

57 
	#CLOCK_BOOTTIME_ALARM
 9

	)

62 
	#CLOCK_SGI_CYCLE
 10

	)

63 
	#CLOCK_TAI
 11

	)

65 
	#MAX_CLOCKS
 16

	)

66 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

67 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

72 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #i‚de‡
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sﬁdﬁd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnodíame
[9];

10 
	mªÀa£
[9];

11 
	mvîsi⁄
[9];

12 
	mmachöe
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sﬁd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnodíame
[65];

20 
	mªÀa£
[65];

21 
	mvîsi⁄
[65];

22 
	mmachöe
[65];

25 
	s√w_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnodíame
[
__NEW_UTS_LEN
 + 1];

28 
	mªÀa£
[
__NEW_UTS_LEN
 + 1];

29 
	mvîsi⁄
[
__NEW_UTS_LEN
 + 1];

30 
	mmachöe
[
__NEW_UTS_LEN
 + 1];

31 
	mdomaö«me
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

22 
	~<löux/°rög.h
>

25 
__u8
 
	mb
[16];

26 } 
	tguid_t
;

28 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

29 ((
guid_t
) \

30 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

31 (
b
) & 0xff, ((b) >> 8) & 0xff, \

32 (
c
) & 0xff, ((c) >> 8) & 0xff, \

33 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

36 
guid_t
 
	tuuid_À
;

37 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

38 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

39 
	#NULL_UUID_LE
 \

40 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

41 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 266002

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

	@/usr/include/linux/xattr.h

12 
	~<löux/libc-com∑t.h
>

14 #i‚de‡
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #i‡
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

52 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


53 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

63 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

67 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

72 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

75 #ifde‡
__OPTIMIZE__


76 
__exã∫_Æways_ölöe
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


79  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

82 
__exã∫_Æways_ölöe
 const *

83 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


85  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

94 #ifde‡
__USE_GNU


97 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

100 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

108 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

121 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

122 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

124 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

125 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

129 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

132 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

133 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

137 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

139 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

146 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

147 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

148 
__THROW
 
	`__n⁄nuŒ
 ((2));

150 #ifde‡
__USE_XOPEN2K8


152 
	~<bôs/ty≥s/loˇÀ_t.h
>

155 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

156 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

159 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

160 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

163 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$°rdup
 (c⁄° *
__s
)

167 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

173 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

175 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


180 
	#°rdu∑
(
s
) \

181 (
__exãnsi⁄__
 \

183 c⁄° *
__ﬁd
 = (
s
); \

184 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

185 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

186 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

187 
	}
}))

	)

190 
	#°∫du∑
(
s
, 
n
) \

191 (
__exãnsi⁄__
 \

193 c⁄° *
__ﬁd
 = (
s
); \

194 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

195 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

196 
__√w
[
__Àn
] = '\0'; \

197 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

198 }))

	)

202 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
°rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

207 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

210 #ifde‡
__OPTIMIZE__


211 
__exã∫_Æways_ölöe
 *

212 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


214  
__buûtö_°rchr
 (
__s
, 
__c
);

217 
__exã∫_Æways_ölöe
 const *

218 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

225 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

226 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

229 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`°ºchr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

234 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

237 #ifde‡
__OPTIMIZE__


238 
__exã∫_Æways_ölöe
 *

239 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


241  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

244 
__exã∫_Æways_ölöe
 const *

245 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

253 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

256 #ifde‡
__USE_GNU


259 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

262 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

265 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

266 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

276 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

277 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

279 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

283 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__OPTIMIZE__


288 
__exã∫_Æways_ölöe
 *

289 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


291  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

294 
__exã∫_Æways_ölöe
 const *

295 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


297  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

300 
	}
}

302 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

303 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

306 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

310 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

311 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

312 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__OPTIMIZE__


315 
__exã∫_Æways_ölöe
 *

316 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


318  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

321 
__exã∫_Æways_ölöe
 const *

322 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


324  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

327 
	}
}

329 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

330 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

335 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

336 
__THROW
 
	`__n⁄nuŒ
 ((2));

340 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

341 c⁄° *
__ª°ri˘
 
__dñim
,

342 **
__ª°ri˘
 
__ßve_±r
)

343 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

344 #ifde‡
__USE_POSIX


345 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

346 **
__ª°ri˘
 
__ßve_±r
)

347 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

350 #ifde‡
__USE_GNU


352 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

354 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

355 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

356 c⁄° *
__√edÀ
)

357 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

359 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

360 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 #ifde‡
__USE_GNU


368 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

369 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

370 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

374 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

375 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

376 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

377 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

378 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

379 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

384 
size_t
 
	$°æí
 (c⁄° *
__s
)

385 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

391 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

397 #ifde‡
__USE_XOPEN2K


405 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


408 #ifde‡
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

410 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

411 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

413 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

414 
__THROW
 
	`__n⁄nuŒ
 ((2));

415 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

420 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

421 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

425 #ifde‡
__USE_XOPEN2K8


427 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

430 #ifde‡
__USE_MISC


431 
	~<°rögs.h
>

435 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

439 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

440 c⁄° *
__ª°ri˘
 
__dñim
)

441 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

449 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

450 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

451 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

452 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

456 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

457 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

458 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

459 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

460 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

461 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

467 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

470 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

473 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

475 #i‚de‡
ba£«me


480 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£«me
 (*
__fûíame
)

482 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

483 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

484 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

486 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

491 #i‡
	`__GNUC_PREREQ
 (3,4)

492 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


494 
	~<bôs/°rög_f‹tifõd.h
>

498 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

119 #unde‡
__USE_ISOC11


120 #unde‡
__USE_ISOC99


121 #unde‡
__USE_ISOC95


122 #unde‡
__USE_ISOCXX11


123 #unde‡
__USE_POSIX


124 #unde‡
__USE_POSIX2


125 #unde‡
__USE_POSIX199309


126 #unde‡
__USE_POSIX199506


127 #unde‡
__USE_XOPEN


128 #unde‡
__USE_XOPEN_EXTENDED


129 #unde‡
__USE_UNIX98


130 #unde‡
__USE_XOPEN2K


131 #unde‡
__USE_XOPEN2KXSI


132 #unde‡
__USE_XOPEN2K8


133 #unde‡
__USE_XOPEN2K8XSI


134 #unde‡
__USE_LARGEFILE


135 #unde‡
__USE_LARGEFILE64


136 #unde‡
__USE_FILE_OFFSET64


137 #unde‡
__USE_MISC


138 #unde‡
__USE_ATFILE


139 #unde‡
__USE_GNU


140 #unde‡
__USE_FORTIFY_LEVEL


141 #unde‡
__KERNEL_STRICT_NAMES


142 #unde‡
__GLIBC_USE_DEPRECATED_GETS


146 #i‚de‡
_LOOSE_KERNEL_NAMES


147 
	#__KERNEL_STRICT_NAMES


	)

157 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


158 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

159 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

161 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

168 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


169 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

170 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

172 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

176 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

182 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

183 && !
deföed
 
	g_DEFAULT_SOURCE


185 #unde‡
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

190 #ifde‡
_GNU_SOURCE


191 #unde‡
_ISOC95_SOURCE


192 
	#_ISOC95_SOURCE
 1

	)

193 #unde‡
_ISOC99_SOURCE


194 
	#_ISOC99_SOURCE
 1

	)

195 #unde‡
_ISOC11_SOURCE


196 
	#_ISOC11_SOURCE
 1

	)

197 #unde‡
_POSIX_SOURCE


198 
	#_POSIX_SOURCE
 1

	)

199 #unde‡
_POSIX_C_SOURCE


200 
	#_POSIX_C_SOURCE
 200809L

	)

201 #unde‡
_XOPEN_SOURCE


202 
	#_XOPEN_SOURCE
 700

	)

203 #unde‡
_XOPEN_SOURCE_EXTENDED


204 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

205 #unde‡
_LARGEFILE64_SOURCE


206 
	#_LARGEFILE64_SOURCE
 1

	)

207 #unde‡
_DEFAULT_SOURCE


208 
	#_DEFAULT_SOURCE
 1

	)

209 #unde‡
_ATFILE_SOURCE


210 
	#_ATFILE_SOURCE
 1

	)

215 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

216 || (!
deföed
 
	g__STRICT_ANSI__
 \

217 && !
deföed
 
	g_ISOC99_SOURCE
 \

218 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

219 && !
deföed
 
	g_XOPEN_SOURCE
))

220 #unde‡
_DEFAULT_SOURCE


221 
	#_DEFAULT_SOURCE
 1

	)

225 #i‡(
deföed
 
_ISOC11_SOURCE
 \

226 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

227 
	#__USE_ISOC11
 1

	)

231 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

232 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

233 
	#__USE_ISOC99
 1

	)

237 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

238 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

239 
	#__USE_ISOC95
 1

	)

242 #ifde‡
__˝lu•lus


244 #i‡
__˝lu•lus
 >= 201703L

245 
	#__USE_ISOC11
 1

	)

249 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


250 
	#__USE_ISOCXX11
 1

	)

251 
	#__USE_ISOC99
 1

	)

258 #ifde‡
_DEFAULT_SOURCE


259 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


260 
	#__USE_POSIX_IMPLICITLY
 1

	)

262 #unde‡
_POSIX_SOURCE


263 
	#_POSIX_SOURCE
 1

	)

264 #unde‡
_POSIX_C_SOURCE


265 
	#_POSIX_C_SOURCE
 200809L

	)

268 #i‡((!
deföed
 
__STRICT_ANSI__
 \

269 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

270 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

271 
	#_POSIX_SOURCE
 1

	)

272 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

273 
	#_POSIX_C_SOURCE
 2

	)

274 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

275 
	#_POSIX_C_SOURCE
 199506L

	)

276 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

277 
	#_POSIX_C_SOURCE
 200112L

	)

279 
	#_POSIX_C_SOURCE
 200809L

	)

281 
	#__USE_POSIX_IMPLICITLY
 1

	)

290 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

291 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

292 
	#_POSIX_SOURCE
 1

	)

293 #unde‡
_POSIX_C_SOURCE


294 
	#_POSIX_C_SOURCE
 199506L

	)

297 #i‡(
deföed
 
_POSIX_SOURCE
 \

298 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

299 || 
deföed
 
_XOPEN_SOURCE
)

300 
	#__USE_POSIX
 1

	)

303 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


304 
	#__USE_POSIX2
 1

	)

307 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

308 
	#__USE_POSIX199309
 1

	)

311 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

312 
	#__USE_POSIX199506
 1

	)

315 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

316 
	#__USE_XOPEN2K
 1

	)

317 #unde‡
__USE_ISOC95


318 
	#__USE_ISOC95
 1

	)

319 #unde‡
__USE_ISOC99


320 
	#__USE_ISOC99
 1

	)

323 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

324 
	#__USE_XOPEN2K8
 1

	)

325 #unde‡
_ATFILE_SOURCE


326 
	#_ATFILE_SOURCE
 1

	)

329 #ifdef 
_XOPEN_SOURCE


330 
	#__USE_XOPEN
 1

	)

331 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

332 
	#__USE_XOPEN_EXTENDED
 1

	)

333 
	#__USE_UNIX98
 1

	)

334 #unde‡
_LARGEFILE_SOURCE


335 
	#_LARGEFILE_SOURCE
 1

	)

336 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

337 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

338 
	#__USE_XOPEN2K8
 1

	)

339 
	#__USE_XOPEN2K8XSI
 1

	)

341 
	#__USE_XOPEN2K
 1

	)

342 
	#__USE_XOPEN2KXSI
 1

	)

343 #unde‡
__USE_ISOC95


344 
	#__USE_ISOC95
 1

	)

345 #unde‡
__USE_ISOC99


346 
	#__USE_ISOC99
 1

	)

349 #ifde‡
_XOPEN_SOURCE_EXTENDED


350 
	#__USE_XOPEN_EXTENDED
 1

	)

355 #ifde‡
_LARGEFILE_SOURCE


356 
	#__USE_LARGEFILE
 1

	)

359 #ifde‡
_LARGEFILE64_SOURCE


360 
	#__USE_LARGEFILE64
 1

	)

363 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

364 
	#__USE_FILE_OFFSET64
 1

	)

367 #i‡
deföed
 
_DEFAULT_SOURCE


368 
	#__USE_MISC
 1

	)

371 #ifdef 
_ATFILE_SOURCE


372 
	#__USE_ATFILE
 1

	)

375 #ifdef 
_GNU_SOURCE


376 
	#__USE_GNU
 1

	)

379 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

380 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

381 #i‡
_FORTIFY_SOURCE
 > 1

382 
	#__USE_FORTIFY_LEVEL
 2

	)

384 
	#__USE_FORTIFY_LEVEL
 1

	)

387 
	#__USE_FORTIFY_LEVEL
 0

	)

394 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


395 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

397 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

402 
	~<°dc-¥edef.h
>

410 #unde‡
__GNU_LIBRARY__


411 
	#__GNU_LIBRARY__
 6

	)

415 
	#__GLIBC__
 2

	)

416 
	#__GLIBC_MINOR__
 27

	)

418 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

419 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

422 #i‚de‡
__ASSEMBLER__


423 #i‚de‡
_SYS_CDEFS_H


424 
	~<sys/cdefs.h
>

429 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


430 
	#__USE_LARGEFILE
 1

	)

431 
	#__USE_LARGEFILE64
 1

	)

437 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

438 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

439 && 
deföed
 
	g__exã∫_ölöe


440 
	#__USE_EXTERN_INLINES
 1

	)

448 
	~<gnu/°ubs.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

61 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
88
1603
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
extents.c
extents_status.c
extents_status.h
file.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode-test.c
inode.c
ioctl.c
jbd3/checkpoint.c
jbd3/commit.c
jbd3/journal.c
jbd3/recovery.c
jbd3/revoke.c
jbd3/transaction.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
pxt4.h
pxt4.mod.c
pxt4_extents.h
pxt4_jbd3.c
pxt4_jbd3.h
readpage.c
resize.c
super.c
symlink.c
sysfs.c
truncate.h
verity.c
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fsmap.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
