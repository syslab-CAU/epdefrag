cscope 15 $HOME/Kernels/pxt4/jbd3               0000180747
	@checkpoint.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<Œaû/ev’ts/jbd3.h
>

30 
šlše
 
	$__bufãr_uÆšk_fœ¡
(
jouº®_h—d
 *
jh
)

32 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

34 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh->b_cpprev;

35 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh->b_cpnext;

36 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
) {

37 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
->
b_ıÃxt
;

38 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
)

39 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
NULL
;

41 
	}
}

48 
šlše
 
	$__bufãr_uÆšk
(
jouº®_h—d
 *
jh
)

50 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

52 
	`__bufãr_uÆšk_fœ¡
(
jh
);

53 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
) {

54 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
->
b_ıÃxt
;

55 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
)

56 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
NULL
;

58 
	}
}

65 
šlše
 
	$__bufãr_»lšk_io
(
jouº®_h—d
 *
jh
)

67 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

69 
	`__bufãr_uÆšk_fœ¡
(
jh
);

71 ià(!
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

72 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

74 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

75 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
->b_cpprev;

76 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

77 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

79 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
;

80 
	}
}

89 
	$__Œy_to_ä“_ı_buf
(
jouº®_h—d
 *
jh
)

91 
»t
 = 0;

92 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

94 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 && !
	`bufãr_locked
(
bh
) &&

95 !
	`bufãr_dœty
(
bh
è&& !
	`bufãr_wr™e_io_”rÜ
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

97 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

99  
»t
;

100 
	}
}

108 
	$__jbd3_log_wa™_fÜ_¥aû
(
jouº®_t
 *
jouº®
)

110 
nblocks
, 
¥aû_Ëá
;

113 
nblocks
 = 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
;

114 
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
nblocks
) {

115 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

116 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

129 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

130 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

131 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

134 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

135 
¥aû_Ëá
 = 
	`jbd3_log_¥aû_Ëá
(
jouº®
);

136 ià(
¥aû_Ëá
 < 
nblocks
) {

137 
chk±
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
;

138 
tid_t
 
tid
 = 0;

140 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

141 
tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

142 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

143 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

144 ià(
chk±
) {

145 
	`jbd3_log_do_checkpošt
(
jouº®
);

146 } ià(
	`jbd3_ş—nup_jouº®_
(
jouº®
) == 0) {

149 } ià(
tid
) {

155 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

156 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

157 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

160 
	`´štk
(
KERN_ERR
 "%s:‚eeded %d blocks‡nd "

162 
__func__
, 
nblocks
, 
¥aû_Ëá
);

163 
	`´štk
(
KERN_ERR
 "%s:‚o wayo get more "

164 "jouº® s·û iÀ%s\n", 
__func__
,

165 
jouº®
->
j_devÇme
);

166 
	`WARN_ON
(1);

167 
	`jbd3_jouº®_abÜt
(
jouº®
, -
EIO
);

169 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

171 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

173 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

175 
	}
}

178 
	$__æush_b©ch
(
jouº®_t
 *
jouº®
, *
b©ch_couÁ
)

180 
i
;

181 
blk_¶ug
 
¶ug
;

183 
	`blk_¡¬t_¶ug
(&
¶ug
);

184 
i
 = 0; i < *
b©ch_couÁ
; i++)

185 
	`wr™e_dœty_bufãr
(
jouº®
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

186 
	`blk_fšish_¶ug
(&
¶ug
);

188 
i
 = 0; i < *
b©ch_couÁ
; i++) {

189 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_chk±_bhs
[
i
];

190 
	`BUFFER_TRACE
(
bh
, "brelse");

191 
	`__b»l£
(
bh
);

193 *
b©ch_couÁ
 = 0;

194 
	}
}

204 
	$jbd3_log_do_checkpošt
(
jouº®_t
 *
jouº®
)

206 
jouº®_h—d
 *
jh
;

207 
bufãr_h—d
 *
bh
;

208 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

209 
tid_t
 
this_tid
;

210 
»suÉ
, 
b©ch_couÁ
 = 0;

212 
	`jbd_debug
(1, "Start checkpoint\n");

219 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

220 
	`Œaû_jbd3_checkpošt
(
jouº®
, 
»suÉ
);

221 
	`jbd_debug
(1, "ş—nup_jouº®_„‘uºed %d\n", 
»suÉ
);

222 ià(
»suÉ
 <= 0)

223  
»suÉ
;

229 
»suÉ
 = 0;

230 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

231 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
)

232 
out
;

233 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

234 ià(
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 == 0)

235 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 = 
jiff›s
;

236 
this_tid
 = 
Œª§ùiÚ
->
t_tid
;

237 
»¡¬t
:

243 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

244 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

245 
out
;

248 
Œª§ùiÚ
->
t_checkpošt_li¡
) {

249 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

250 
bh
 = 
	`jh2bh
(
jh
);

252 ià(
	`bufãr_locked
(
bh
)) {

253 
	`g‘_bh
(
bh
);

254 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

255 
	`wa™_Ú_bufãr
(
bh
);

257 
	`BUFFER_TRACE
(
bh
, "brelse");

258 
	`__b»l£
(
bh
);

259 
»Œy
;

261 ià(
jh
->
b_Œª§ùiÚ
 !ğ
NULL
) {

262 
Œª§ùiÚ_t
 *
t
 = 
jh
->
b_Œª§ùiÚ
;

263 
tid_t
 
tid
 = 
t
->
t_tid
;

265 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_fÜûd_to_şo£
++;

266 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

267 ià(
	`uÆik–y
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
))

274 
	`´štk
(
KERN_ERR


276 
jouº®
->
j_devÇme
, (è
bh
->
b_blockÄ
);

278 ià(
b©ch_couÁ
)

279 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

280 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

289 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

290 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

291 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

292 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

293 
»¡¬t
;

295 ià(!
	`bufãr_dœty
(
bh
)) {

296 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

297 
»suÉ
 = -
EIO
;

298 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

299 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

301 
out
;

312 
	`BUFFER_TRACE
(
bh
, "queue");

313 
	`g‘_bh
(
bh
);

314 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jwr™e
(bh));

315 
jouº®
->
j_chk±_bhs
[
b©ch_couÁ
++] = 
bh
;

316 
	`__bufãr_»lšk_io
(
jh
);

317 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_wr™‹n
++;

318 ià((
b©ch_couÁ
 =ğ
JBD3_NR_BATCH
) ||

319 
	`Ãed_»sched
() ||

320 
	`¥š_Ãedb»ak
(&
jouº®
->
j_li¡_lock
))

321 
uÆock_ªd_æush
;

324 ià(
b©ch_couÁ
) {

325 
uÆock_ªd_æush
:

326 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

327 
»Œy
:

328 ià(
b©ch_couÁ
)

329 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

330 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

331 
»¡¬t
;

338 
»¡¬t2
:

340 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

341 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

342 
out
;

344 
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

345 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

346 
bh
 = 
	`jh2bh
(
jh
);

347 ià(
	`bufãr_locked
(
bh
)) {

348 
	`g‘_bh
(
bh
);

349 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

350 
	`wa™_Ú_bufãr
(
bh
);

352 
	`BUFFER_TRACE
(
bh
, "brelse");

353 
	`__b»l£
(
bh
);

354 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

355 
»¡¬t2
;

357 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

358 
»suÉ
 = -
EIO
;

365 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

368 
out
:

369 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

370 ià(
»suÉ
 < 0)

371 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»suÉ
);

373 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

375  (
»suÉ
 < 0) ?„esult : 0;

376 
	}
}

396 
	$jbd3_ş—nup_jouº®_
(
jouº®_t
 *
jouº®
)

398 
tid_t
 
fœ¡_tid
;

399 
blockÄ
;

401 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

402  -
EIO
;

404 ià(!
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
blockÄ
))

406 
	`J_ASSERT
(
blockÄ
 != 0);

416 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
)

417 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

419  
	`__jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
blockÄ
);

420 
	}
}

434 
	$jouº®_ş—n_Úe_ı_li¡
(
jouº®_h—d
 *
jh
, 
boŞ
 
de¡roy
)

436 
jouº®_h—d
 *
Ï¡_jh
;

437 
jouº®_h—d
 *
Ãxt_jh
 = 
jh
;

438 
»t
;

440 ià(!
jh
)

443 
Ï¡_jh
 = 
jh
->
b_ı´ev
;

445 
jh
 = 
Ãxt_jh
;

446 
Ãxt_jh
 = 
jh
->
b_ıÃxt
;

447 ià(!
de¡roy
)

448 
»t
 = 
	`__Œy_to_ä“_ı_buf
(
jh
);

450 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

451 ià(!
»t
)

453 ià(
»t
 == 2)

461 ià(
	`Ãed_»sched
())

463 } 
jh
 !ğ
Ï¡_jh
);

466 
	}
}

476 
	$__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®_t
 *
jouº®
, 
boŞ
 
de¡roy
)

478 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ï¡_Œª§ùiÚ
, *
Ãxt_Œª§ùiÚ
;

479 
»t
;

481 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

482 ià(!
Œª§ùiÚ
)

485 
Ï¡_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ı´ev
;

486 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

488 
Œª§ùiÚ
 = 
Ãxt_Œª§ùiÚ
;

489 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ıÃxt
;

490 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->
t_checkpošt_li¡
,

491 
de¡roy
);

497 ià(
	`Ãed_»sched
())

499 ià(
»t
)

506 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->

507 
t_checkpošt_io_li¡
, 
de¡roy
);

508 ià(
	`Ãed_»sched
())

515 ià(!
»t
)

517 } 
Œª§ùiÚ
 !ğ
Ï¡_Œª§ùiÚ
);

518 
	}
}

524 
	$jbd3_jouº®_de¡roy_checkpošt
(
jouº®_t
 *
jouº®
)

531 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

532 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
) {

533 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

536 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
Œue
);

537 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

538 
	`cÚd_»sched
();

540 
	}
}

560 
	$__jbd3_jouº®_»move_checkpošt
(
jouº®_h—d
 *
jh
)

562 
Œª§ùiÚ_chp_¡©s_s
 *
¡©s
;

563 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

564 
jouº®_t
 *
jouº®
;

565 
»t
 = 0;

567 
	`JBUFFER_TRACE
(
jh
, "entry");

569 ià((
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
è=ğ
NULL
) {

570 
	`JBUFFER_TRACE
(
jh
, "not onransaction");

571 
out
;

573 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

575 
	`JBUFFER_TRACE
(
jh
, "removing fromransaction");

576 
	`__bufãr_uÆšk
(
jh
);

577 
jh
->
b_ı_Œª§ùiÚ
 = 
NULL
;

578 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

580 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 !ğ
NULL
 ||

581 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 !ğ
NULL
)

582 
out
;

593 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_FINISHED
)

594 
out
;

598 
¡©s
 = &
Œª§ùiÚ
->
t_chp_¡©s
;

599 ià(
¡©s
->
cs_chp_time
)

600 
¡©s
->
cs_chp_time
 = 
	`jbd3_time_diff
(stats->cs_chp_time,

601 
jiff›s
);

602 
	`Œaû_jbd3_checkpošt_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

603 
Œª§ùiÚ
->
t_tid
, 
¡©s
);

605 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

606 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ
);

607 
»t
 = 1;

608 
out
:

609  
»t
;

610 
	}
}

620 
	$__jbd3_jouº®_š£¹_checkpošt
(
jouº®_h—d
 *
jh
,

621 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

623 
	`JBUFFER_TRACE
(
jh
, "entry");

624 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_dœty
(
	`jh2bh
(jh)è|| 
	`bufãr_jbddœty
(jh2bh(jh)));

625 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

628 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
	`jh2bh
(
jh
));

629 
jh
->
b_ı_Œª§ùiÚ
 = 
Œª§ùiÚ
;

631 ià(!
Œª§ùiÚ
->
t_checkpošt_li¡
) {

632 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

634 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

635 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
->b_cpprev;

636 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

637 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

639 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
;

640 
	}
}

652 
	$__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

654 
	`as£¹_¥š_locked
(&
jouº®
->
j_li¡_lock
);

655 ià(
Œª§ùiÚ
->
t_ıÃxt
) {

656 
Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =ransaction->t_cpprev;

657 
Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =ransaction->t_cpnext;

658 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

659 
jouº®
->
j_checkpošt_Œª§ùiÚs
 =

660 
Œª§ùiÚ
->
t_ıÃxt
;

661 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

662 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
NULL
;

665 
	`J_ASSERT
(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_FINISHED
);

666 
	`J_ASSERT
(
Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

667 
	`J_ASSERT
(
Œª§ùiÚ
->
t_fÜg‘
 =ğ
NULL
);

668 
	`J_ASSERT
(
Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

669 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

670 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
);

671 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) == 0);

672 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

673 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

675 
	`Œaû_jbd3_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

677 
	`jbd_debug
(1, "Drİpšg¿n§ùiÚ %d,‡Î dÚe\n", 
Œª§ùiÚ
->
t_tid
);

678 
	}
}

	@commit.c

13 
	~<lšux/time.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/jbd3.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/jiff›s.h
>

21 
	~<lšux/üc32.h
>

22 
	~<lšux/wr™eback.h
>

23 
	~<lšux/backšg-dev.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/b™İs.h
>

27 
	~<Œaû/ev’ts/jbd3.h
>

32 
	$jouº®_’d_bufãr_io_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

34 
bufãr_h—d
 *
Üig_bh
 = 
bh
->
b_´iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 ià(
u±od©e
)

38 
	`£t_bufãr_u±od©e
(
bh
);

40 
	`ş—r_bufãr_u±od©e
(
bh
);

41 ià(
Üig_bh
) {

42 
	`ş—r_b™_uÆock
(
BH_Shadow
, &
Üig_bh
->
b_¡©e
);

43 
	`smp_mb__aá”_©omic
();

44 
	`wake_up_b™
(&
Üig_bh
->
b_¡©e
, 
BH_Shadow
);

46 
	`uÆock_bufãr
(
bh
);

47 
	}
}

63 
	$»Ëa£_bufãr_·ge
(
bufãr_h—d
 *
bh
)

65 
·ge
 *page;

67 ià(
	`bufãr_dœty
(
bh
))

68 
nİe
;

69 ià(
	`©omic_»ad
(&
bh
->
b_couÁ
) != 1)

70 
nİe
;

71 
·ge
 = 
bh
->
b_·ge
;

72 ià(!
·ge
)

73 
nİe
;

74 ià(
·ge
->
m­pšg
)

75 
nİe
;

78 ià(!
	`Œylock_·ge
(
·ge
))

79 
nİe
;

81 
	`g‘_·ge
(
·ge
);

82 
	`__b»l£
(
bh
);

83 
	`Œy_to_ä“_bufãrs
(
·ge
);

84 
	`uÆock_·ge
(
·ge
);

85 
	`put_·ge
(
·ge
);

88 
nİe
:

89 
	`__b»l£
(
bh
);

90 
	}
}

92 
	$jbd3_comm™_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

94 
comm™_h—d”
 *
h
;

95 
__u32
 
csum
;

97 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

100 
h
 = (
comm™_h—d”
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty³
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`ıu_to_be32
(
csum
);

106 
	}
}

116 
	$jouº®_subm™_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

117 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
,

118 
bufãr_h—d
 **
cbh
,

119 
__u32
 
üc32_sum
)

121 
comm™_h—d”
 *
tmp
;

122 
bufãr_h—d
 *
bh
;

123 
»t
;

124 
time¥ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

131 
bh
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
comm™_Œª§ùiÚ
,

132 
JBD3_COMMIT_BLOCK
);

133 ià(!
bh
)

136 
tmp
 = (
comm™_h—d”
 *)
bh
->
b_d©a
;

137 
	`ktime_g‘_cßr£_»®_ts64
(&
now
);

138 
tmp
->
h_comm™_£c
 = 
	`ıu_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_comm™_n£c
 = 
	`ıu_to_be32
(
now
.
tv_n£c
);

141 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

142 
tmp
->
h_chksum_ty³
 = 
JBD3_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD3_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`ıu_to_be32
(
üc32_sum
);

146 
	`jbd3_comm™_block_csum_£t
(
jouº®
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_bufãr
(
bh
);

150 
	`ş—r_bufãr_dœty
(
bh
);

151 
	`£t_bufãr_u±od©e
(
bh
);

152 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

154 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
 &&

155 !
	`jbd3_has_ã©u»_async_comm™
(
jouº®
))

156 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
»t
;

163 
	}
}

169 
	$jouº®_wa™_Ú_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

170 
bufãr_h—d
 *
bh
)

172 
»t
 = 0;

174 
	`ş—r_bufãr_dœty
(
bh
);

175 
	`wa™_Ú_bufãr
(
bh
);

177 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

178 
»t
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
»t
;

182 
	}
}

190 
	$jouº®_subm™_šode_d©a_bufãrs
(
add»ss_¥aû
 *
m­pšg
,

191 
loff_t
 
dœty_¡¬t
,†off_ˆ
dœty_’d
)

193 
»t
;

194 
wr™eback_cÚŒŞ
 
wbc
 = {

195 .
sync_mode
 = 
WB_SYNC_ALL
,

196 .
Ä_to_wr™e
 = 
m­pšg
->
Ä·ges
 * 2,

197 .
¿nge_¡¬t
 = 
dœty_¡¬t
,

198 .
¿nge_’d
 = 
dœty_’d
,

201 
»t
 = 
	`g’”ic_wr™•ages
(
m­pšg
, &
wbc
);

202  
»t
;

203 
	}
}

213 
	$jouº®_subm™_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

214 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

216 
jbd3_šode
 *
jšode
;

217 
”r
, 
»t
 = 0;

218 
add»ss_¥aû
 *
m­pšg
;

220 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

221 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

222 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

223 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

225 ià(!(
jšode
->
i_æags
 & 
JI_WRITE_DATA
))

227 
m­pšg
 = 
jšode
->
i_vfs_šode
->
i_m­pšg
;

228 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

229 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

236 
	`Œaû_jbd3_subm™_šode_d©a
(
jšode
->
i_vfs_šode
);

237 
”r
 = 
	`jouº®_subm™_šode_d©a_bufãrs
(
m­pšg
, 
dœty_¡¬t
,

238 
dœty_’d
);

239 ià(!
»t
)

240 
»t
 = 
”r
;

241 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

242 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

243 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

244 
	`smp_mb
();

245 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

247 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

248  
»t
;

249 
	}
}

256 
	$jouº®_fšish_šode_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

257 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

259 
jbd3_šode
 *
jšode
, *
Ãxt_i
;

260 
”r
, 
»t
 = 0;

263 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

264 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

265 
loff_t
 
dœty_¡¬t
 = 
jšode
->
i_dœty_¡¬t
;

266 
loff_t
 
dœty_’d
 = 
jšode
->
i_dœty_’d
;

268 ià(!(
jšode
->
i_æags
 & 
JI_WAIT_DATA
))

270 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

271 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

272 
”r
 = 
	`fem­_fd©awa™_¿nge_k“p_”rÜs
(

273 
jšode
->
i_vfs_šode
->
i_m­pšg
, 
dœty_¡¬t
,

274 
dœty_’d
);

275 ià(!
»t
)

276 
»t
 = 
”r
;

277 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

278 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

279 
	`smp_mb
();

280 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

284 
	`li¡_fÜ_—ch_’Œy_§ã
(
jšode
, 
Ãxt_i
,

285 &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

286 
	`li¡_d–
(&
jšode
->
i_li¡
);

287 ià(
jšode
->
i_Ãxt_Œª§ùiÚ
) {

288 
jšode
->
i_Œª§ùiÚ
 = jšode->
i_Ãxt_Œª§ùiÚ
;

289 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

290 
	`li¡_add
(&
jšode
->
i_li¡
,

291 &
jšode
->
i_Œª§ùiÚ
->
t_šode_li¡
);

293 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

294 
jšode
->
i_dœty_¡¬t
 = 0;

295 
jšode
->
i_dœty_’d
 = 0;

298 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

300  
»t
;

301 
	}
}

303 
__u32
 
	$jbd3_checksum_d©a
(
__u32
 
üc32_sum
, 
bufãr_h—d
 *
bh
)

305 
·ge
 *·gğ
bh
->
b_·ge
;

306 *
addr
;

307 
__u32
 
checksum
;

309 
addr
 = 
	`km­_©omic
(
·ge
);

310 
checksum
 = 
	`üc32_be
(
üc32_sum
,

311 (*)(
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
)), bh->
b_size
);

312 
	`kunm­_©omic
(
addr
);

314  
checksum
;

315 
	}
}

317 
	$wr™e_g_block
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

318 
block
)

320 
g
->
t_blockÄ
 = 
	`ıu_to_be32
(
block
 & (
u32
)~0);

321 ià(
	`jbd3_has_ã©u»_64b™
(
j
))

322 
g
->
t_blockÄ_high
 = 
	`ıu_to_be32
((
block
 >> 31) >> 1);

323 
	}
}

325 
	$jbd3_block_g_csum_£t
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

326 
bufãr_h—d
 *
bh
, 
__u32
 
£qu’û
)

328 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

329 
·ge
 *·gğ
bh
->
b_·ge
;

330 
__u8
 *
addr
;

331 
__u32
 
csum32
;

332 
__be32
 
£q
;

334 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

337 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

338 
addr
 = 
	`km­_©omic
(
·ge
);

339 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

340 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
),

341 
bh
->
b_size
);

342 
	`kunm­_©omic
(
addr
);

344 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

345 
g3
->
t_checksum
 = 
	`ıu_to_be32
(
csum32
);

347 
g
->
t_checksum
 = 
	`ıu_to_be16
(
csum32
);

348 
	}
}

355 
	$jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®_t
 *
jouº®
)

357 
Œª§ùiÚ_¡©s_s
 
¡©s
;

358 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
;

359 
jouº®_h—d
 *
jh
;

360 
bufãr_h—d
 *
desütÜ
;

361 
bufãr_h—d
 **
wbuf
 = 
jouº®
->
j_wbuf
;

362 
bufs
;

363 
æags
;

364 
”r
;

365 
blockÄ
;

366 
ktime_t
 
¡¬t_time
;

367 
u64
 
comm™_time
;

368 *
gp
 = 
NULL
;

369 
jouº®_block_g_t
 *
g
 = 
NULL
;

370 
¥aû_Ëá
 = 0;

371 
fœ¡_g
 = 0;

372 
g_æag
;

373 
i
;

374 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

375 
bufãr_h—d
 *
cbh
 = 
NULL
;

376 
__u32
 
üc32_sum
 = ~0;

377 
blk_¶ug
 
¶ug
;

379 
fœ¡_block
;

380 
tid_t
 
fœ¡_tid
;

381 
upd©e_
;

382 
csum_size
 = 0;

383 
	`LIST_HEAD
(
io_bufs
);

384 
	`LIST_HEAD
(
log_bufs
);

386 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

387 
csum_size
 = (
jbd3_jouº®_block_
);

395 ià(
jouº®
->
j_æags
 & 
JBD3_FLUSHED
) {

396 
	`jbd_debug
(3, "super block updated\n");

397 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

404 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

405 
jouº®
->
j__£qu’û
,

406 
jouº®
->
j_
,

407 
REQ_SYNC
);

408 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

410 
	`jbd_debug
(3, "superblock‚ot updated\n");

413 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
NULL
);

414 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

416 
comm™_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

418 
	`Œaû_jbd3_¡¬t_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

419 
	`jbd_debug
(1, "JBD3: starting commit ofransaction %d\n",

420 
comm™_Œª§ùiÚ
->
t_tid
);

422 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

423 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

424 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_LOCKED
;

426 
	`Œaû_jbd3_comm™_lockšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

427 
¡©s
.
run
.
rs_wa™
 = 
comm™_Œª§ùiÚ
->
t_max_wa™
;

428 
¡©s
.
run
.
rs_»que¡_d–ay
 = 0;

429 
¡©s
.
run
.
rs_locked
 = 
jiff›s
;

430 ià(
comm™_Œª§ùiÚ
->
t_»que¡ed
)

431 
¡©s
.
run
.
rs_»que¡_d–ay
 =

432 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_»que¡ed
,

433 
¡©s
.
run
.
rs_locked
);

434 
¡©s
.
run
.
rs_ruÂšg
 = 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_¡¬t
,

435 
¡©s
.
run
.
rs_locked
);

437 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

438 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

439 
	`DEFINE_WAIT
(
wa™
);

441 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

442 
TASK_UNINTERRUPTIBLE
);

443 ià(
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

444 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

445 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

446 
	`scheduË
();

447 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

448 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

450 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

452 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

453 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_SWITCH
;

454 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

456 
	`J_ASSERT
 (
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) <=

457 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

475 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
) {

476 
jh
 = 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
;

477 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:„efile");

482 ià(
jh
->
b_comm™‹d_d©a
) {

483 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

485 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

486 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

487 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

488 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

490 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

498 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

499 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
çl£
);

500 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

502 
	`jbd_debug
(3, "JBD3: commit…hase 1\n");

508 
	`jbd3_ş—r_bufãr_»voked_æags
(
jouº®
);

513 
	`jbd3_jouº®_sw™ch_»voke_bË
(
jouº®
);

518 
	`©omic_sub
(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
),

519 &
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

521 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

522 
	`Œaû_jbd3_comm™_æushšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

523 
¡©s
.
run
.
rs_æushšg
 = 
jiff›s
;

524 
¡©s
.
run
.
rs_locked
 = 
	`jbd3_time_diff
(stats.run.rs_locked,

525 
¡©s
.
run
.
rs_æushšg
);

527 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FLUSH
;

528 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
comm™_Œª§ùiÚ
;

529 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
NULL
;

530 
¡¬t_time
 = 
	`ktime_g‘
();

531 
comm™_Œª§ùiÚ
->
t_log_¡¬t
 = 
jouº®
->
j_h—d
;

532 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

533 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

535 
	`jbd_debug
(3, "JBD3: commit…hase 2a\n");

541 
”r
 = 
	`jouº®_subm™_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

542 ià(
”r
)

543 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

545 
	`blk_¡¬t_¶ug
(&
¶ug
);

546 
	`jbd3_jouº®_wr™e_»voke_»cÜds
(
comm™_Œª§ùiÚ
, &
log_bufs
);

548 
	`jbd_debug
(3, "JBD3: commit…hase 2b\n");

555 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

556 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT
;

557 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

559 
	`Œaû_jbd3_comm™_loggšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

560 
¡©s
.
run
.
rs_loggšg
 = 
jiff›s
;

561 
¡©s
.
run
.
rs_æushšg
 = 
	`jbd3_time_diff
(stats.run.rs_flushing,

562 
¡©s
.
run
.
rs_loggšg
);

563 
¡©s
.
run
.
rs_blocks
 = 
comm™_Œª§ùiÚ
->
t_Ä_bufãrs
;

564 
¡©s
.
run
.
rs_blocks_logged
 = 0;

566 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_Ä_bufãrs
 <=

567 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
));

569 
”r
 = 0;

570 
bufs
 = 0;

571 
desütÜ
 = 
NULL
;

572 
comm™_Œª§ùiÚ
->
t_bufãrs
) {

576 
jh
 = 
comm™_Œª§ùiÚ
->
t_bufãrs
;

581 ià(
	`is_jouº®_abÜ‹d
(
jouº®
)) {

582 
	`ş—r_bufãr_jbddœty
(
	`jh2bh
(
jh
));

583 
	`JBUFFER_TRACE
(
jh
, "journal is‡borting:„efile");

584 
	`jbd3_bufãr_abÜt_Œigg”
(
jh
,

585 
jh
->
b_äoz’_d©a
 ?

586 
jh
->
b_äoz’_Œigg”s
 :

587 
jh
->
b_Œigg”s
);

588 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

593 ià(!
comm™_Œª§ùiÚ
->
t_bufãrs
)

594 
¡¬t_jouº®_io
;

601 ià(!
desütÜ
) {

602 
	`J_ASSERT
 (
bufs
 == 0);

604 
	`jbd_debug
(4, "JBD3: get descriptor\n");

606 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(

607 
comm™_Œª§ùiÚ
,

608 
JBD3_DESCRIPTOR_BLOCK
);

609 ià(!
desütÜ
) {

610 
	`jbd3_jouº®_abÜt
(
jouº®
, -
EIO
);

614 
	`jbd_debug
(4, "JBD3: got buffer %llu (%p)\n",

615 ()
desütÜ
->
b_blockÄ
,

616 
desütÜ
->
b_d©a
);

617 
gp
 = &
desütÜ
->
b_d©a
[(
jouº®_h—d”_t
)];

618 
¥aû_Ëá
 = 
desütÜ
->
b_size
 -

619 (
jouº®_h—d”_t
);

620 
fœ¡_g
 = 1;

621 
	`£t_bufãr_jwr™e
(
desütÜ
);

622 
	`£t_bufãr_dœty
(
desütÜ
);

623 
wbuf
[
bufs
++] = 
desütÜ
;

627 
	`BUFFER_TRACE
(
desütÜ
, "ph3: file‡s descriptor");

628 
	`jbd3_fe_log_bh
(&
log_bufs
, 
desütÜ
);

633 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

637 ià(
”r
) {

638 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

646 
	`©omic_dec
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

651 
	`©omic_šc
(&
	`jh2bh
(
jh
)->
b_couÁ
);

657 
	`£t_b™
(
BH_JWr™e
, &
	`jh2bh
(
jh
)->
b_¡©e
);

658 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

659 
æags
 = 
	`jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
comm™_Œª§ùiÚ
,

660 
jh
, &
wbuf
[
bufs
], 
blockÄ
);

661 ià(
æags
 < 0) {

662 
	`jbd3_jouº®_abÜt
(
jouº®
, 
æags
);

665 
	`jbd3_fe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

670 
g_æag
 = 0;

671 ià(
æags
 & 1)

672 
g_æag
 |ğ
JBD3_FLAG_ESCAPE
;

673 ià(!
fœ¡_g
)

674 
g_æag
 |ğ
JBD3_FLAG_SAME_UUID
;

676 
g
 = (
jouº®_block_g_t
 *è
gp
;

677 
	`wr™e_g_block
(
jouº®
, 
g
, 
	`jh2bh
(
jh
)->
b_blockÄ
);

678 
g
->
t_æags
 = 
	`ıu_to_be16
(
g_æag
);

679 
	`jbd3_block_g_csum_£t
(
jouº®
, 
g
, 
wbuf
[
bufs
],

680 
comm™_Œª§ùiÚ
->
t_tid
);

681 
gp
 +ğ
g_by‹s
;

682 
¥aû_Ëá
 -ğ
g_by‹s
;

683 
bufs
++;

685 ià(
fœ¡_g
) {

686 
	`memıy
 (
gp
, 
jouº®
->
j_uuid
, 16);

687 
gp
 += 16;

688 
¥aû_Ëá
 -= 16;

689 
fœ¡_g
 = 0;

695 ià(
bufs
 =ğ
jouº®
->
j_wbufsize
 ||

696 
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
 ||

697 
¥aû_Ëá
 < 
g_by‹s
 + 16 + 
csum_size
) {

699 
	`jbd_debug
(4, "JBD3: Subm™ %d IOs\n", 
bufs
);

705 
g
->
t_æags
 |ğ
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
);

706 
¡¬t_jouº®_io
:

707 ià(
desütÜ
)

708 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
,

709 
desütÜ
);

711 
i
 = 0; i < 
bufs
; i++) {

712 
bufãr_h—d
 *
bh
 = 
wbuf
[
i
];

716 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

717 
üc32_sum
 =

718 
	`jbd3_checksum_d©a
(
üc32_sum
, 
bh
);

721 
	`lock_bufãr
(
bh
);

722 
	`ş—r_bufãr_dœty
(
bh
);

723 
	`£t_bufãr_u±od©e
(
bh
);

724 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

725 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

727 
	`cÚd_»sched
();

731 
desütÜ
 = 
NULL
;

732 
bufs
 = 0;

736 
”r
 = 
	`jouº®_fšish_šode_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

737 ià(
”r
) {

738 
	`´štk
(
KERN_WARNING


740 "Ú %s\n", 
jouº®
->
j_devÇme
);

741 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT_ON_SYNCDATA_ERR
)

742 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

743 
”r
 = 0;

753 
upd©e_
 =

754 
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
fœ¡_block
);

756 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

757 ià(
upd©e_
) {

758 
ä“d
 = 
fœ¡_block
 - 
jouº®
->
j_
;

760 ià(
fœ¡_block
 < 
jouº®
->
j_
)

761 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

763 ià(
ä“d
 < 
jouº®
->
j_maxËn
 / 4)

764 
upd©e_
 = 0;

766 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT
);

767 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_DFLUSH
;

768 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

775 ià(
comm™_Œª§ùiÚ
->
t_Ãed_d©a_æush
 &&

776 (
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) &&

777 (
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

778 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

781 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

782 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

783 &
cbh
, 
üc32_sum
);

784 ià(
”r
)

785 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

788 
	`blk_fšish_¶ug
(&
¶ug
);

801 
	`jbd_debug
(3, "JBD3: commit…hase 3\n");

803 !
	`li¡_em±y
(&
io_bufs
)) {

804 
bufãr_h—d
 *
bh
 = 
	`li¡_’Œy
(
io_bufs
.
´ev
,

805 
bufãr_h—d
,

806 
b_assoc_bufãrs
);

808 
	`wa™_Ú_bufãr
(
bh
);

809 
	`cÚd_»sched
();

811 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

812 
”r
 = -
EIO
;

813 
	`jbd3_unfe_log_bh
(
bh
);

814 
¡©s
.
run
.
rs_blocks_logged
++;

820 
	`BUFFER_TRACE
(
bh
, "dumpingemporary bh");

821 
	`__b»l£
(
bh
);

822 
	`J_ASSERT_BH
(
bh
, 
	`©omic_»ad
(&bh->
b_couÁ
) == 0);

823 
	`ä“_bufãr_h—d
(
bh
);

826 
jh
 = 
comm™_Œª§ùiÚ
->
t_shadow_li¡
->
b_»v
;

827 
bh
 = 
	`jh2bh
(
jh
);

828 
	`ş—r_bufãr_jwr™e
(
bh
);

829 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbddœty
(bh));

830 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_shadow
(bh));

836 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Forget");

837 
	`jbd3_jouº®_fe_bufãr
(
jh
, 
comm™_Œª§ùiÚ
, 
BJ_FÜg‘
);

838 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

839 
	`__b»l£
(
bh
);

842 
	`J_ASSERT
 (
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

844 
	`jbd_debug
(3, "JBD3: commit…hase 4\n");

847 !
	`li¡_em±y
(&
log_bufs
)) {

848 
bufãr_h—d
 *
bh
;

850 
bh
 = 
	`li¡_’Œy
(
log_bufs
.
´ev
, 
bufãr_h—d
, 
b_assoc_bufãrs
);

851 
	`wa™_Ú_bufãr
(
bh
);

852 
	`cÚd_»sched
();

854 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

855 
”r
 = -
EIO
;

857 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

858 
	`ş—r_bufãr_jwr™e
(
bh
);

859 
	`jbd3_unfe_log_bh
(
bh
);

860 
¡©s
.
run
.
rs_blocks_logged
++;

861 
	`__b»l£
(
bh
);

865 ià(
”r
)

866 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

868 
	`jbd_debug
(3, "JBD3: commit…hase 5\n");

869 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

870 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_DFLUSH
);

871 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_JFLUSH
;

872 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

874 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

875 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

876 &
cbh
, 
üc32_sum
);

877 ià(
”r
)

878 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

880 ià(
cbh
)

881 
”r
 = 
	`jouº®_wa™_Ú_comm™_»cÜd
(
jouº®
, 
cbh
);

882 
¡©s
.
run
.
rs_blocks_logged
++;

883 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
) &&

884 
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

885 
	`blkdev_issue_æush
(
jouº®
->
j_dev
, 
GFP_NOFS
, 
NULL
);

888 ià(
”r
)

889 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

891 
	`WARN_ON_ONCE
(

892 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) < 0);

899 ià(
upd©e_
)

900 
	`jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
fœ¡_block
);

907 
	`jbd_debug
(3, "JBD3: commit…hase 6\n");

909 
	`J_ASSERT
(
	`li¡_em±y
(&
comm™_Œª§ùiÚ
->
t_šode_li¡
));

910 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

911 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

912 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

914 
»¡¬t_loİ
:

919 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

920 
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

921 
Œª§ùiÚ_t
 *
ı_Œª§ùiÚ
;

922 
bufãr_h—d
 *
bh
;

923 
Œy_to_ä“
 = 0;

924 
boŞ
 
drİ_»f
;

926 
jh
 = 
comm™_Œª§ùiÚ
->
t_fÜg‘
;

927 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

928 
bh
 = 
	`jh2bh
(
jh
);

933 
	`g‘_bh
(
bh
);

934 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

935 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

950 ià(
jh
->
b_comm™‹d_d©a
) {

951 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

952 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

953 ià(
jh
->
b_äoz’_d©a
) {

954 
jh
->
b_comm™‹d_d©a
 = jh->
b_äoz’_d©a
;

955 
jh
->
b_äoz’_d©a
 = 
NULL
;

956 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

958 } ià(
jh
->
b_äoz’_d©a
) {

959 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

960 
jh
->
b_äoz’_d©a
 = 
NULL
;

961 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

964 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

965 
ı_Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

966 ià(
ı_Œª§ùiÚ
) {

967 
	`JBUFFER_TRACE
(
jh
, "remove from old cpransaction");

968 
ı_Œª§ùiÚ
->
t_chp_¡©s
.
cs_drİ³d
++;

969 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

987 ià(
	`bufãr_ä“d
(
bh
è&& !
jh
->
b_Ãxt_Œª§ùiÚ
) {

988 
add»ss_¥aû
 *
m­pšg
;

990 
	`ş—r_bufãr_ä“d
(
bh
);

991 
	`ş—r_bufãr_jbddœty
(
bh
);

1004 
m­pšg
 = 
	`READ_ONCE
(
bh
->
b_·ge
->mapping);

1005 ià(
m­pšg
 && !
	`sb_is_blkdev_sb
(m­pšg->
ho¡
->
i_sb
)) {

1006 
	`ş—r_bufãr_m­³d
(
bh
);

1007 
	`ş—r_bufãr_Ãw
(
bh
);

1008 
	`ş—r_bufãr_»q
(
bh
);

1009 
bh
->
b_bdev
 = 
NULL
;

1013 ià(
	`bufãr_jbddœty
(
bh
)) {

1014 
	`JBUFFER_TRACE
(
jh
, "addo‚ew checkpointingrans");

1015 
	`__jbd3_jouº®_š£¹_checkpošt
(
jh
, 
comm™_Œª§ùiÚ
);

1016 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1017 
	`ş—r_bufãr_jbddœty
(
bh
);

1019 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_dœty
(bh));

1029 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
)

1030 
Œy_to_ä“
 = 1;

1032 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1033 
drİ_»f
 = 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

1034 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1035 ià(
drİ_»f
)

1036 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1037 ià(
Œy_to_ä“
)

1038 
	`»Ëa£_bufãr_·ge
(
bh
);

1040 
	`__b»l£
(
bh
);

1041 
	`cÚd_»sched_lock
(&
jouº®
->
j_li¡_lock
);

1043 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1050 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1051 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1056 ià(
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

1057 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1058 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1059 
»¡¬t_loİ
;

1065 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
) {

1066 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
comm™_Œª§ùiÚ
;

1067 
comm™_Œª§ùiÚ
->
t_ıÃxt
 = commit_transaction;

1068 
comm™_Œª§ùiÚ
->
t_ı´ev
 = commit_transaction;

1070 
comm™_Œª§ùiÚ
->
t_ıÃxt
 =

1071 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

1072 
comm™_Œª§ùiÚ
->
t_ı´ev
 =

1073 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
;

1074 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =

1075 
comm™_Œª§ùiÚ
;

1076 
comm™_Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =

1077 
comm™_Œª§ùiÚ
;

1079 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1083 
	`jbd_debug
(3, "JBD3: commit…hase 7\n");

1085 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_JFLUSH
);

1087 
comm™_Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

1088 
¡©s
.
run
.
rs_loggšg
 = 
	`jbd3_time_diff
(stats.run.rs_logging,

1089 
comm™_Œª§ùiÚ
->
t_¡¬t
);

1094 
¡©s
.
ts_tid
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1095 
¡©s
.
run
.
rs_hªdË_couÁ
 =

1096 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_hªdË_couÁ
);

1097 
	`Œaû_jbd3_run_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1098 
comm™_Œª§ùiÚ
->
t_tid
, &
¡©s
.
run
);

1099 
¡©s
.
ts_»que¡ed
 = (
comm™_Œª§ùiÚ
->
t_»que¡ed
) ? 1 : 0;

1101 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_CALLBACK
;

1102 
	`J_ASSERT
(
comm™_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

1103 
jouº®
->
j_comm™_£qu’û
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1104 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
NULL
;

1105 
comm™_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1111 ià(
	`lik–y
(
jouº®
->
j_av”age_comm™_time
))

1112 
jouº®
->
j_av”age_comm™_time
 = (
comm™_time
 +

1113 
jouº®
->
j_av”age_comm™_time
*3) / 4;

1115 
jouº®
->
j_av”age_comm™_time
 = 
comm™_time
;

1117 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1119 ià(
jouº®
->
j_comm™_ÿÎback
)

1120 
jouº®
->
	`j_comm™_ÿÎback
(jouº®, 
comm™_Œª§ùiÚ
);

1122 
	`Œaû_jbd3_’d_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

1123 
	`jbd_debug
(1, "JBD3: commit %d complete, head %d\n",

1124 
jouº®
->
j_comm™_£qu’û
, jouº®->
j__£qu’û
);

1126 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1127 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1128 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FINISHED
;

1130 ià(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
 &&

1131 
comm™_Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
) {

1132 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
comm™_Œª§ùiÚ
);

1133 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
comm™_Œª§ùiÚ
);

1135 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1136 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1137 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

1142 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1143 
jouº®
->
j_¡©s
.
ts_tid
++;

1144 
jouº®
->
j_¡©s
.
ts_»que¡ed
 +ğ
¡©s
.ts_requested;

1145 
jouº®
->
j_¡©s
.
run
.
rs_wa™
 +ğ
¡©s
.run.rs_wait;

1146 
jouº®
->
j_¡©s
.
run
.
rs_»que¡_d–ay
 +ğ
¡©s
.run.rs_request_delay;

1147 
jouº®
->
j_¡©s
.
run
.
rs_ruÂšg
 +ğ
¡©s
.run.rs_running;

1148 
jouº®
->
j_¡©s
.
run
.
rs_locked
 +ğ
¡©s
.run.rs_locked;

1149 
jouº®
->
j_¡©s
.
run
.
rs_æushšg
 +ğ
¡©s
.run.rs_flushing;

1150 
jouº®
->
j_¡©s
.
run
.
rs_loggšg
 +ğ
¡©s
.run.rs_logging;

1151 
jouº®
->
j_¡©s
.
run
.
rs_hªdË_couÁ
 +ğ
¡©s
.run.rs_handle_count;

1152 
jouº®
->
j_¡©s
.
run
.
rs_blocks
 +ğ
¡©s
.run.rs_blocks;

1153 
jouº®
->
j_¡©s
.
run
.
rs_blocks_logged
 +ğ
¡©s
.run.rs_blocks_logged;

1154 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1155 
	}
}

	@journal.c

22 
	~<lšux/moduË.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/jbd3.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/ä“z”.h
>

31 
	~<lšux/·gem­.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/poisÚ.h
>

34 
	~<lšux/´oc_fs.h
>

35 
	~<lšux/£q_fe.h
>

36 
	~<lšux/m©h64.h
>

37 
	~<lšux/hash.h
>

38 
	~<lšux/log2.h
>

39 
	~<lšux/vm®loc.h
>

40 
	~<lšux/backšg-dev.h
>

41 
	~<lšux/b™İs.h
>

42 
	~<lšux/¿‹lim™.h
>

43 
	~<lšux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<Œaû/ev’ts/jbd3.h
>

48 
	~<lšux/uacûss.h
>

49 
	~<asm/·ge.h
>

51 #ifdeà
CONFIG_JBD3_DEBUG


52 
ushÜt
 
jbd3_jouº®_’abË_debug
 
	g__»ad_mo¡ly
;

53 
EXPORT_SYMBOL
(
jbd3_jouº®_’abË_debug
);

55 
moduË_·¿m_Çmed
(
jbd3_debug
, 
jbd3_jouº®_’abË_debug
, 
ushÜt
, 0644);

56 
MODULE_PARM_DESC
(
jbd3_debug
, "Debugging†evel for jbd3");

59 
EXPORT_SYMBOL
(
jbd3_jouº®_ex‹nd
);

60 
EXPORT_SYMBOL
(
jbd3_jouº®_¡İ
);

61 
EXPORT_SYMBOL
(
jbd3_jouº®_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd3_jouº®_uÆock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_wr™e_acûss
);

64 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_ü—‹_acûss
);

65 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_undo_acûss
);

66 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_Œigg”s
);

67 
EXPORT_SYMBOL
(
jbd3_jouº®_dœty_m‘ad©a
);

68 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜg‘
);

69 
EXPORT_SYMBOL
(
jbd3_jouº®_æush
);

70 
EXPORT_SYMBOL
(
jbd3_jouº®_»voke
);

72 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_dev
);

73 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_šode
);

74 
EXPORT_SYMBOL
(
jbd3_jouº®_check_u£d_ã©u»s
);

75 
EXPORT_SYMBOL
(
jbd3_jouº®_check_avaabË_ã©u»s
);

76 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_ã©u»s
);

77 
EXPORT_SYMBOL
(
jbd3_jouº®_lßd
);

78 
EXPORT_SYMBOL
(
jbd3_jouº®_de¡roy
);

79 
EXPORT_SYMBOL
(
jbd3_jouº®_abÜt
);

80 
EXPORT_SYMBOL
(
jbd3_jouº®_”ºo
);

81 
EXPORT_SYMBOL
(
jbd3_jouº®_ack_”r
);

82 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_”r
);

83 
EXPORT_SYMBOL
(
jbd3_log_wa™_comm™
);

84 
EXPORT_SYMBOL
(
jbd3_log_¡¬t_comm™
);

85 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_comm™
);

86 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™_Ã¡ed
);

87 
EXPORT_SYMBOL
(
jbd3_jouº®_we
);

88 
EXPORT_SYMBOL
(
jbd3_jouº®_blocks_³r_·ge
);

89 
EXPORT_SYMBOL
(
jbd3_jouº®_šv®id©•age
);

90 
EXPORT_SYMBOL
(
jbd3_jouº®_Œy_to_ä“_bufãrs
);

91 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™
);

92 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_¿nged_wr™e
);

93 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_¿nged_wa™
);

94 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_jbd_šode
);

95 
EXPORT_SYMBOL
(
jbd3_jouº®_»Ëa£_jbd_šode
);

96 
EXPORT_SYMBOL
(
jbd3_jouº®_begš_Üd”ed_Œunÿ‹
);

97 
EXPORT_SYMBOL
(
jbd3_šode_ÿche
);

99 
__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
);

100 
jbd3_jouº®_ü—‹_¦ab
(
size_t
 
¦ab_size
);

102 #ifdeà
CONFIG_JBD3_DEBUG


103 
	$__jbd3_debug
(
Ëv–
, cÚ¡ *
fe
, cÚ¡ *
func
,

104 
lše
, cÚ¡ *
fmt
, ...)

106 
va_fÜm©
 
vaf
;

107 
va_li¡
 
¬gs
;

109 ià(
Ëv–
 > 
jbd3_jouº®_’abË_debug
)

111 
	`va_¡¬t
(
¬gs
, 
fmt
);

112 
vaf
.
fmt
 = fmt;

113 
vaf
.
va
 = &
¬gs
;

114 
	`´štk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fe
, 
func
, 
lše
, &
vaf
);

115 
	`va_’d
(
¬gs
);

116 
	}
}

117 
EXPORT_SYMBOL
(
__jbd3_debug
);

121 
	$jbd3_v”ify_csum_ty³
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

123 ià(!
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
j
))

126  
sb
->
s_checksum_ty³
 =ğ
JBD3_CRC32C_CHKSUM
;

127 
	}
}

129 
__be32
 
	$jbd3_su³rblock_csum
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

131 
__u32
 
csum
;

132 
__be32
 
Şd_csum
;

134 
Şd_csum
 = 
sb
->
s_checksum
;

135 
sb
->
s_checksum
 = 0;

136 
csum
 = 
	`jbd3_chksum
(
j
, ~0, (*)
sb
, (
jouº®_su³rblock_t
));

137 
sb
->
s_checksum
 = 
Şd_csum
;

139  
	`ıu_to_be32
(
csum
);

140 
	}
}

146 
	$comm™_timeout
(
tim”_li¡
 *
t
)

148 
jouº®_t
 *
jouº®
 = 
	`äom_tim”
(jouº®, 
t
, 
j_comm™_tim”
);

150 
	`wake_up_´oûss
(
jouº®
->
j_sk
);

151 
	}
}

169 
	$kjouº®d2
(*
¬g
)

171 
jouº®_t
 *
jouº®
 = 
¬g
;

172 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

178 
	`tim”_£tup
(&
jouº®
->
j_comm™_tim”
, 
comm™_timeout
, 0);

180 
	`£t_ä“zabË
();

183 
jouº®
->
j_sk
 = 
cu¼’t
;

184 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

192 
	`mem®loc_nofs_§ve
();

197 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

199 
loİ
:

200 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

201 
’d_loİ
;

203 
	`jbd_debug
(1, "commit_sequence=%u, commit_request=%u\n",

204 
jouº®
->
j_comm™_£qu’û
, jouº®->
j_comm™_»que¡
);

206 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
) {

207 
	`jbd_debug
(1, "OK,„equests differ\n");

208 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

209 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

210 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

211 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

212 
loİ
;

215 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

216 ià(
	`ä“zšg
(
cu¼’t
)) {

222 
	`jbd_debug
(1, "Now suspending kjournald2\n");

223 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

224 
	`Œy_to_ä“ze
();

225 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

231 
	`DEFINE_WAIT
(
wa™
);

232 
should_¦“p
 = 1;

234 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
,

235 
TASK_INTERRUPTIBLE
);

236 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
)

237 
should_¦“p
 = 0;

238 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

239 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,

240 
Œª§ùiÚ
->
t_expœes
))

241 
should_¦“p
 = 0;

242 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

243 
should_¦“p
 = 0;

244 ià(
should_¦“p
) {

245 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

246 
	`scheduË
();

247 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

249 
	`fšish_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
);

252 
	`jbd_debug
(1, "kjournald2 wakes\n");

257 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

258 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,¿n§ùiÚ->
t_expœes
)) {

259 
jouº®
->
j_comm™_»que¡
 = 
Œª§ùiÚ
->
t_tid
;

260 
	`jbd_debug
(1, "woke because ofimeout\n");

262 
loİ
;

264 
’d_loİ
:

265 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

266 
jouº®
->
j_sk
 = 
NULL
;

267 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

268 
	`jbd_debug
(1, "Journalhreadƒxiting.\n");

269 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

271 
	}
}

273 
	$jbd3_jouº®_¡¬t_th»ad
(
jouº®_t
 *
jouº®
)

275 
sk_¡ruù
 *
t
;

277 
t
 = 
	`kth»ad_run
(
kjouº®d2
, 
jouº®
, "jbd3/%s",

278 
jouº®
->
j_devÇme
);

279 ià(
	`IS_ERR
(
t
))

280  
	`PTR_ERR
(
t
);

282 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 !ğ
NULL
);

284 
	}
}

286 
	$jouº®_kl_th»ad
(
jouº®_t
 *
jouº®
)

288 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

289 
jouº®
->
j_æags
 |ğ
JBD3_UNMOUNT
;

291 
jouº®
->
j_sk
) {

292 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

293 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

294 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 =ğ
NULL
);

295 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

297 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

298 
	}
}

335 
	$jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

336 
jouº®_h—d
 *
jh_š
,

337 
bufãr_h—d
 **
bh_out
,

338 
£ùÜ_t
 
blockÄ
)

340 
Ãed_cİy_out
 = 0;

341 
dÚe_cİy_out
 = 0;

342 
do_esÿ³
 = 0;

343 *
m­³d_d©a
;

344 
bufãr_h—d
 *
Ãw_bh
;

345 
·ge
 *
Ãw_·ge
;

346 
Ãw_off£t
;

347 
bufãr_h—d
 *
bh_š
 = 
	`jh2bh
(
jh_š
);

348 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

359 
	`J_ASSERT_BH
(
bh_š
, 
	`bufãr_jbddœty
(bh_in));

361 
Ãw_bh
 = 
	`®loc_bufãr_h—d
(
GFP_NOFS
|
__GFP_NOFAIL
);

364 
	`©omic_£t
(&
Ãw_bh
->
b_couÁ
, 1);

366 
	`¥š_lock
(&
jh_š
->
b_¡©e_lock
);

367 
»³©
:

372 ià(
jh_š
->
b_äoz’_d©a
) {

373 
dÚe_cİy_out
 = 1;

374 
Ãw_·ge
 = 
	`vœt_to_·ge
(
jh_š
->
b_äoz’_d©a
);

375 
Ãw_off£t
 = 
	`off£t_š_·ge
(
jh_š
->
b_äoz’_d©a
);

377 
Ãw_·ge
 = 
	`jh2bh
(
jh_š
)->
b_·ge
;

378 
Ãw_off£t
 = 
	`off£t_š_·ge
(
	`jh2bh
(
jh_š
)->
b_d©a
);

381 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

388 ià(!
dÚe_cİy_out
)

389 
	`jbd3_bufãr_äoz’_Œigg”
(
jh_š
, 
m­³d_d©a
 + 
Ãw_off£t
,

390 
jh_š
->
b_Œigg”s
);

395 ià(*((
__be32
 *)(
m­³d_d©a
 + 
Ãw_off£t
)) ==

396 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

397 
Ãed_cİy_out
 = 1;

398 
do_esÿ³
 = 1;

400 
	`kunm­_©omic
(
m­³d_d©a
);

405 ià(
Ãed_cİy_out
 && !
dÚe_cİy_out
) {

406 *
tmp
;

408 
	`¥š_uÆock
(&
jh_š
->
b_¡©e_lock
);

409 
tmp
 = 
	`jbd3_®loc
(
bh_š
->
b_size
, 
GFP_NOFS
);

410 ià(!
tmp
) {

411 
	`b»l£
(
Ãw_bh
);

412  -
ENOMEM
;

414 
	`¥š_lock
(&
jh_š
->
b_¡©e_lock
);

415 ià(
jh_š
->
b_äoz’_d©a
) {

416 
	`jbd3_ä“
(
tmp
, 
bh_š
->
b_size
);

417 
»³©
;

420 
jh_š
->
b_äoz’_d©a
 = 
tmp
;

421 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

422 
	`memıy
(
tmp
, 
m­³d_d©a
 + 
Ãw_off£t
, 
bh_š
->
b_size
);

423 
	`kunm­_©omic
(
m­³d_d©a
);

425 
Ãw_·ge
 = 
	`vœt_to_·ge
(
tmp
);

426 
Ãw_off£t
 = 
	`off£t_š_·ge
(
tmp
);

427 
dÚe_cİy_out
 = 1;

434 
jh_š
->
b_äoz’_Œigg”s
 = jh_š->
b_Œigg”s
;

441 ià(
do_esÿ³
) {

442 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

443 *((*)(
m­³d_d©a
 + 
Ãw_off£t
)) = 0;

444 
	`kunm­_©omic
(
m­³d_d©a
);

447 
	`£t_bh_·ge
(
Ãw_bh
, 
Ãw_·ge
, 
Ãw_off£t
);

448 
Ãw_bh
->
b_size
 = 
bh_š
->b_size;

449 
Ãw_bh
->
b_bdev
 = 
jouº®
->
j_dev
;

450 
Ãw_bh
->
b_blockÄ
 = 
blockÄ
;

451 
Ãw_bh
->
b_´iv©e
 = 
bh_š
;

452 
	`£t_bufãr_m­³d
(
Ãw_bh
);

453 
	`£t_bufãr_dœty
(
Ãw_bh
);

455 *
bh_out
 = 
Ãw_bh
;

462 
	`JBUFFER_TRACE
(
jh_š
, "file‡s BJ_Shadow");

463 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

464 
	`__jbd3_jouº®_fe_bufãr
(
jh_š
, 
Œª§ùiÚ
, 
BJ_Shadow
);

465 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

466 
	`£t_bufãr_shadow
(
bh_š
);

467 
	`¥š_uÆock
(&
jh_š
->
b_¡©e_lock
);

469  
do_esÿ³
 | (
dÚe_cİy_out
 << 1);

470 
	}
}

481 
	$__jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
rg‘
)

484 ià(
jouº®
->
j_comm™_»que¡
 =ğ
rg‘
)

492 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

493 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
rg‘
) {

499 
jouº®
->
j_comm™_»que¡
 = 
rg‘
;

500 
	`jbd_debug
(1, "JBD3:„equesting commit %u/%u\n",

501 
jouº®
->
j_comm™_»que¡
,

502 
jouº®
->
j_comm™_£qu’û
);

503 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_»que¡ed
 = 
jiff›s
;

504 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

506 } ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
rg‘
))

510 
	`WARN_ONCE
(1, "JBD3: bad†og_start_commit: %u %u %u %u\n",

511 
jouº®
->
j_comm™_»que¡
,

512 
jouº®
->
j_comm™_£qu’û
,

513 
rg‘
, 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

514 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

516 
	}
}

518 
	$jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

520 
»t
;

522 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

523 
»t
 = 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

524 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

525  
»t
;

526 
	}
}

535 
	$__jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

537 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

538 
tid_t
 
tid
;

539 
Ãed_to_¡¬t
 = 0, 
»t
 = 0;

541 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

542 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && !
cu¼’t
->
jouº®_šfo
) {

543 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

544 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
Œª§ùiÚ
->
t_tid
))

545 
Ãed_to_¡¬t
 = 1;

546 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

547 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

549 ià(!
Œª§ùiÚ
) {

551 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

554 
tid
 = 
Œª§ùiÚ
->
t_tid
;

555 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

556 ià(
Ãed_to_¡¬t
)

557 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

558 
»t
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

559 ià(!
»t
)

560 
»t
 = 1;

562  
»t
;

563 
	}
}

573 
	$jbd3_jouº®_fÜû_comm™_Ã¡ed
(
jouº®_t
 *
jouº®
)

575 
»t
;

577 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

578  
»t
 > 0;

579 
	}
}

588 
	$jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

590 
»t
;

592 
	`J_ASSERT
(!
cu¼’t
->
jouº®_šfo
);

593 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

594 ià(
»t
 > 0)

595 
»t
 = 0;

596  
»t
;

597 
	}
}

604 
	$jbd3_jouº®_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 *
±id
)

606 
»t
 = 0;

608 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

609 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

610 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

612 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

615 ià(
±id
)

616 *
±id
 = 
tid
;

617 
»t
 = 1;

618 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

623 ià(
±id
)

624 *
±id
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

625 
»t
 = 1;

627 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

628  
»t
;

629 
	}
}

637 
	$jbd3_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

639 
»t
 = 0;

640 
Œª§ùiÚ_t
 *
comm™_Œªs
;

642 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

644 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

646 ià(
	`tid_geq
(
jouº®
->
j_comm™_£qu’û
, 
tid
))

647 
out
;

648 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

649 ià(!
comm™_Œªs
 || comm™_Œªs->
t_tid
 !ğ
tid
) {

650 
»t
 = 1;

651 
out
;

657 ià(
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) {

658 ià(!
comm™_Œªs
->
t_Ãed_d©a_æush
 ||

659 
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_DFLUSH
)

660 
out
;

662 ià(
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_JFLUSH
)

663 
out
;

665 
»t
 = 1;

666 
out
:

667 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

668  
»t
;

669 
	}
}

670 
EXPORT_SYMBOL
(
jbd3_Œªs_wl_£nd_d©a_b¬r›r
);

676 
	$jbd3_log_wa™_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

678 
”r
 = 0;

680 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

681 #ifdeà
CONFIG_PROVE_LOCKING


687 ià(
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
) &&

688 (!
jouº®
->
j_comm™tšg_Œª§ùiÚ
 ||

689 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 !ğ
tid
)) {

690 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

691 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

692 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

695 #ifdeà
CONFIG_JBD3_DEBUG


696 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
)) {

697 
	`´štk
(
KERN_ERR


699 
__func__
, 
jouº®
->
j_comm™_»que¡
, 
tid
);

702 
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
)) {

703 
	`jbd_debug
(1, "JBD3: want %u, j_commit_sequence=%u\n",

704 
tid
, 
jouº®
->
j_comm™_£qu’û
);

705 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

706 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

707 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
,

708 !
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
));

709 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

711 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

713 ià(
	`uÆik–y
(
	`is_jouº®_abÜ‹d
(
jouº®
)))

714 
”r
 = -
EIO
;

715  
”r
;

716 
	}
}

719 
	$jbd3_Œª§ùiÚ_comm™‹d
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

721 
»t
 = 1;

723 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

724 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

725 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

726 
»t
 = 0;

727 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

728 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

729 
»t
 = 0;

730 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

731  
»t
;

732 
	}
}

733 
EXPORT_SYMBOL
(
jbd3_Œª§ùiÚ_comm™‹d
);

742 
	$jbd3_com¶‘e_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

744 
Ãed_to_wa™
 = 1;

746 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

747 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

748 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
) {

749 ià(
jouº®
->
j_comm™_»que¡
 !ğ
tid
) {

751 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

752 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

753 
wa™_comm™
;

755 } ià(!(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

756 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
))

757 
Ãed_to_wa™
 = 0;

758 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

759 ià(!
Ãed_to_wa™
)

761 
wa™_comm™
:

762  
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

763 
	}
}

764 
EXPORT_SYMBOL
(
jbd3_com¶‘e_Œª§ùiÚ
);

770 
	$jbd3_jouº®_Ãxt_log_block
(
jouº®_t
 *
jouº®
, *
»
)

772 
blockÄ
;

774 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

775 
	`J_ASSERT
(
jouº®
->
j_ä“
 > 1);

777 
blockÄ
 = 
jouº®
->
j_h—d
;

778 
jouº®
->
j_h—d
++;

779 
jouº®
->
j_ä“
--;

780 ià(
jouº®
->
j_h—d
 =ğjouº®->
j_Ï¡
)

781 
jouº®
->
j_h—d
 = jouº®->
j_fœ¡
;

782 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

783  
	`jbd3_jouº®_bm­
(
jouº®
, 
blockÄ
, 
»
);

784 
	}
}

793 
	$jbd3_jouº®_bm­
(
jouº®_t
 *
jouº®
, 
blockÄ
,

794 *
»
)

796 
”r
 = 0;

797 
»t
;

799 ià(
jouº®
->
j_šode
) {

800 
»t
 = 
	`bm­
(
jouº®
->
j_šode
, 
blockÄ
);

801 ià(
»t
)

802 *
»
 = 
»t
;

804 
	`´štk
(
KERN_ALERT
 "%s: journal block‚ot found "

806 
__func__
, 
blockÄ
, 
jouº®
->
j_devÇme
);

807 
”r
 = -
EIO
;

808 
	`__jouº®_abÜt_soá
(
jouº®
, 
”r
);

811 *
»
 = 
blockÄ
;

813  
”r
;

814 
	}
}

826 
bufãr_h—d
 *

827 
	$jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
ty³
)

829 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

830 
bufãr_h—d
 *
bh
;

831 
blockÄ
;

832 
jouº®_h—d”_t
 *
h—d”
;

833 
”r
;

835 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

837 ià(
”r
)

838  
NULL
;

840 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

841 ià(!
bh
)

842  
NULL
;

843 
	`©omic_dec
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

844 
	`lock_bufãr
(
bh
);

845 
	`mem£t
(
bh
->
b_d©a
, 0, 
jouº®
->
j_blocksize
);

846 
h—d”
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

847 
h—d”
->
h_magic
 = 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

848 
h—d”
->
h_blockty³
 = 
	`ıu_to_be32
(
ty³
);

849 
h—d”
->
h_£qu’û
 = 
	`ıu_to_be32
(
Œª§ùiÚ
->
t_tid
);

850 
	`£t_bufãr_u±od©e
(
bh
);

851 
	`uÆock_bufãr
(
bh
);

852 
	`BUFFER_TRACE
(
bh
, "returnhis buffer");

853  
bh
;

854 
	}
}

856 
	$jbd3_desütÜ_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

858 
jbd3_jouº®_block_
 *

;

859 
__u32
 
csum
;

861 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

864 

 = (
jbd3_jouº®_block_
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

865 (
jbd3_jouº®_block_
));

866 

->
t_checksum
 = 0;

867 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

868 

->
t_checksum
 = 
	`ıu_to_be32
(
csum
);

869 
	}
}

881 
	$jbd3_jouº®_g‘_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 *
tid
,

882 *
block
)

884 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

885 
»t
;

887 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

888 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

889 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

890 ià(
Œª§ùiÚ
) {

891 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

892 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

893 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
è!ğ
NULL
) {

894 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

895 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

896 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
è!ğ
NULL
) {

897 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

898 *
block
 = 
jouº®
->
j_h—d
;

900 *
tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
;

901 *
block
 = 
jouº®
->
j_h—d
;

903 
»t
 = 
	`tid_gt
(*
tid
, 
jouº®
->
j__£qu’û
);

904 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

905 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

907  
»t
;

908 
	}
}

920 
	$__jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

922 
ä“d
;

923 
»t
;

925 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

933 
»t
 = 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
, 
tid
, 
block
,

934 
REQ_SYNC
 | 
REQ_FUA
);

935 ià(
»t
)

936 
out
;

938 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

939 
ä“d
 = 
block
 - 
jouº®
->
j_
;

940 ià(
block
 < 
jouº®
->
j_
)

941 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

943 
	`Œaû_jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
, 
ä“d
);

944 
	`jbd_debug
(1,

947 
jouº®
->
j__£qu’û
, 
tid
, 
block
, 
ä“d
);

949 
jouº®
->
j_ä“
 +ğ
ä“d
;

950 
jouº®
->
j__£qu’û
 = 
tid
;

951 
jouº®
->
j_
 = 
block
;

952 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

954 
out
:

955  
»t
;

956 
	}
}

963 
	$jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

965 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

966 ià(
	`tid_gt
(
tid
, 
jouº®
->
j__£qu’û
))

967 
	`__jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
);

968 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

969 
	}
}

971 
	sjbd3_¡©s_´oc_£ssiÚ
 {

972 
jouº®_t
 *
	mjouº®
;

973 
Œª§ùiÚ_¡©s_s
 *
	m¡©s
;

974 
	m¡¬t
;

975 
	mmax
;

978 *
	$jbd3_£q_šfo_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

980  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

981 
	}
}

983 *
	$jbd3_£q_šfo_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

985 (*
pos
)++;

986  
NULL
;

987 
	}
}

989 
	$jbd3_£q_šfo_show
(
£q_fe
 *
£q
, *
v
)

991 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

993 ià(
v
 !ğ
SEQ_START_TOKEN
)

995 
	`£q_´štf
(
£q
, "%luransactions (%lu„equested), "

997 
s
->
¡©s
->
ts_tid
, s->¡©s->
ts_»que¡ed
,

998 
s
->
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

999 ià(
s
->
¡©s
->
ts_tid
 == 0)

1001 
	`£q_´štf
(
£q
, "average: \n %ums waiting forransaction\n",

1002 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_wa™
 / s->¡©s->
ts_tid
));

1003 
	`£q_´štf
(
£q
, " %ums„equest delay\n",

1004 (
s
->
¡©s
->
ts_»que¡ed
 == 0) ? 0 :

1005 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_»que¡_d–ay
 /

1006 
s
->
¡©s
->
ts_»que¡ed
));

1007 
	`£q_´štf
(
£q
, " %ums„unningransaction\n",

1008 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_ruÂšg
 / s->¡©s->
ts_tid
));

1009 
	`£q_´štf
(
£q
, " %umsransaction was being†ocked\n",

1010 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_locked
 / s->¡©s->
ts_tid
));

1011 
	`£q_´štf
(
£q
, " %ums flushing data (in ordered mode)\n",

1012 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_æushšg
 / s->¡©s->
ts_tid
));

1013 
	`£q_´štf
(
£q
, " %ums†oggingransaction\n",

1014 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_loggšg
 / s->¡©s->
ts_tid
));

1015 
	`£q_´štf
(
£q
, " %lluus‡verageransaction commitime\n",

1016 
	`div_u64
(
s
->
jouº®
->
j_av”age_comm™_time
, 1000));

1017 
	`£q_´štf
(
£q
, " %lu handles…erransaction\n",

1018 
s
->
¡©s
->
run
.
rs_hªdË_couÁ
 / s->¡©s->
ts_tid
);

1019 
	`£q_´štf
(
£q
, " %lu blocks…erransaction\n",

1020 
s
->
¡©s
->
run
.
rs_blocks
 / s->¡©s->
ts_tid
);

1021 
	`£q_´štf
(
£q
, " %lu†ogged blocks…erransaction\n",

1022 
s
->
¡©s
->
run
.
rs_blocks_logged
 / s->¡©s->
ts_tid
);

1024 
	}
}

1026 
	$jbd3_£q_šfo_¡İ
(
£q_fe
 *
£q
, *
v
)

1028 
	}
}

1030 cÚ¡ 
£q_İ”©iÚs
 
	gjbd3_£q_šfo_İs
 = {

1031 .
¡¬t
 = 
jbd3_£q_šfo_¡¬t
,

1032 .
	gÃxt
 = 
jbd3_£q_šfo_Ãxt
,

1033 .
	g¡İ
 = 
jbd3_£q_šfo_¡İ
,

1034 .
	gshow
 = 
jbd3_£q_šfo_show
,

1037 
	$jbd3_£q_šfo_İ’
(
šode
 *šode, 
fe
 *file)

1039 
jouº®_t
 *
jouº®
 = 
	`PDE_DATA
(
šode
);

1040 
jbd3_¡©s_´oc_£ssiÚ
 *
s
;

1041 
rc
, 
size
;

1043 
s
 = 
	`km®loc
((*s), 
GFP_KERNEL
);

1044 ià(
s
 =ğ
NULL
)

1045  -
ENOMEM
;

1046 
size
 = (
Œª§ùiÚ_¡©s_s
);

1047 
s
->
¡©s
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

1048 ià(
s
->
¡©s
 =ğ
NULL
) {

1049 
	`kä“
(
s
);

1050  -
ENOMEM
;

1052 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1053 
	`memıy
(
s
->
¡©s
, &
jouº®
->
j_¡©s
, 
size
);

1054 
s
->
jouº®
 = journal;

1055 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1057 
rc
 = 
	`£q_İ’
(
fe
, &
jbd3_£q_šfo_İs
);

1058 ià(
rc
 == 0) {

1059 
£q_fe
 *
m
 = 
fe
->
´iv©e_d©a
;

1060 
m
->
´iv©e
 = 
s
;

1062 
	`kä“
(
s
->
¡©s
);

1063 
	`kä“
(
s
);

1065  
rc
;

1067 
	}
}

1069 
	$jbd3_£q_šfo_»Ëa£
(
šode
 *šode, 
fe
 *file)

1071 
£q_fe
 *
£q
 = 
fe
->
´iv©e_d©a
;

1072 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

1073 
	`kä“
(
s
->
¡©s
);

1074 
	`kä“
(
s
);

1075  
	`£q_»Ëa£
(
šode
, 
fe
);

1076 
	}
}

1078 cÚ¡ 
fe_İ”©iÚs
 
	gjbd3_£q_šfo_fİs
 = {

1079 .
owÃr
 = 
THIS_MODULE
,

1080 .
	gİ’
 = 
jbd3_£q_šfo_İ’
,

1081 .
	g»ad
 = 
£q_»ad
,

1082 .
	gÎ£ek
 = 
£q_l£ek
,

1083 .
	g»Ëa£
 = 
jbd3_£q_šfo_»Ëa£
,

1086 
´oc_dœ_’Œy
 *
	g´oc_jbd3_¡©s
;

1088 
	$jbd3_¡©s_´oc_š™
(
jouº®_t
 *
jouº®
)

1090 
jouº®
->
j_´oc_’Œy
 = 
	`´oc_mkdœ
(jouº®->
j_devÇme
, 
´oc_jbd3_¡©s
);

1091 ià(
jouº®
->
j_´oc_’Œy
) {

1092 
	`´oc_ü—‹_d©a
("šfo", 
S_IRUGO
, 
jouº®
->
j_´oc_’Œy
,

1093 &
jbd3_£q_šfo_fİs
, 
jouº®
);

1095 
	}
}

1097 
	$jbd3_¡©s_´oc_ex™
(
jouº®_t
 *
jouº®
)

1099 
	`»move_´oc_’Œy
("šfo", 
jouº®
->
j_´oc_’Œy
);

1100 
	`»move_´oc_’Œy
(
jouº®
->
j_devÇme
, 
´oc_jbd3_¡©s
);

1101 
	}
}

1104 
	$jbd3_mš_g_size
()

1110  (
jouº®_block_g_t
) - 4;

1111 
	}
}

1122 
jouº®_t
 *
	$jouº®_š™_commÚ
(
block_deviû
 *
bdev
,

1123 
block_deviû
 *
fs_dev
,

1124 
¡¬t
, 
Ën
, 
blocksize
)

1126 
lock_şass_key
 
jbd3_Œªs_comm™_key
;

1127 
jouº®_t
 *
jouº®
;

1128 
”r
;

1129 
bufãr_h—d
 *
bh
;

1130 
n
;

1132 
jouº®
 = 
	`kz®loc
((*jouº®), 
GFP_KERNEL
);

1133 ià(!
jouº®
)

1134  
NULL
;

1136 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1137 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_dÚe_comm™
);

1138 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_comm™
);

1139 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_upd©es
);

1140 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_»£rved
);

1141 
	`mu‹x_š™
(&
jouº®
->
j_b¬r›r
);

1142 
	`mu‹x_š™
(&
jouº®
->
j_checkpošt_mu‹x
);

1143 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

1144 
	`¥š_lock_š™
(&
jouº®
->
j_li¡_lock
);

1145 
	`rwlock_š™
(&
jouº®
->
j_¡©e_lock
);

1147 
jouº®
->
j_comm™_š‹rv®
 = (
HZ
 * 
JBD3_DEFAULT_MAX_COMMIT_AGE
);

1148 
jouº®
->
j_mš_b©ch_time
 = 0;

1149 
jouº®
->
j_max_b©ch_time
 = 15000;

1150 
	`©omic_£t
(&
jouº®
->
j_»£rved_üed™s
, 0);

1153 
jouº®
->
j_æags
 = 
JBD3_ABORT
;

1156 
”r
 = 
	`jbd3_jouº®_š™_»voke
(
jouº®
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1157 ià(
”r
)

1158 
”r_ş—nup
;

1160 
	`¥š_lock_š™
(&
jouº®
->
j_hi¡Üy_lock
);

1162 
	`lockd•_š™_m­
(&
jouº®
->
j_Œªs_comm™_m­
, "jbd3_handle",

1163 &
jbd3_Œªs_comm™_key
, 0);

1166 
jouº®
->
j_blocksize
 = 
blocksize
;

1167 
jouº®
->
j_dev
 = 
bdev
;

1168 
jouº®
->
j_fs_dev
 = 
fs_dev
;

1169 
jouº®
->
j_blk_off£t
 = 
¡¬t
;

1170 
jouº®
->
j_maxËn
 = 
Ën
;

1172 
n
 = 
jouº®
->
j_blocksize
 / 
	`jbd3_mš_g_size
();

1173 
jouº®
->
j_wbufsize
 = 
n
;

1174 
jouº®
->
j_wbuf
 = 
	`km®loc_¬¿y
(
n
, (
bufãr_h—d
 *),

1175 
GFP_KERNEL
);

1176 ià(!
jouº®
->
j_wbuf
)

1177 
”r_ş—nup
;

1179 
bh
 = 
	`g‘blk_unmovabË
(
jouº®
->
j_dev
, 
¡¬t
, jouº®->
j_blocksize
);

1180 ià(!
bh
) {

1181 
	`´_”r
("%s: Cannot get buffer for journal superblock\n",

1182 
__func__
);

1183 
”r_ş—nup
;

1185 
jouº®
->
j_sb_bufãr
 = 
bh
;

1186 
jouº®
->
j_su³rblock
 = (
jouº®_su³rblock_t
 *)
bh
->
b_d©a
;

1188  
jouº®
;

1190 
”r_ş—nup
:

1191 
	`kä“
(
jouº®
->
j_wbuf
);

1192 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1193 
	`kä“
(
jouº®
);

1194  
NULL
;

1195 
	}
}

1220 
jouº®_t
 *
	$jbd3_jouº®_š™_dev
(
block_deviû
 *
bdev
,

1221 
block_deviû
 *
fs_dev
,

1222 
¡¬t
, 
Ën
, 
blocksize
)

1224 
jouº®_t
 *
jouº®
;

1226 
jouº®
 = 
	`jouº®_š™_commÚ
(
bdev
, 
fs_dev
, 
¡¬t
, 
Ën
, 
blocksize
);

1227 ià(!
jouº®
)

1228  
NULL
;

1230 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1231 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1232 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1234  
jouº®
;

1235 
	}
}

1245 
jouº®_t
 *
	$jbd3_jouº®_š™_šode
(
šode
 *inode)

1247 
jouº®_t
 *
jouº®
;

1248 *
p
;

1249 
blockÄ
;

1251 
blockÄ
 = 
	`bm­
(
šode
, 0);

1252 ià(!
blockÄ
) {

1253 
	`´_”r
("%s: Cannot†ocate journal superblock\n",

1254 
__func__
);

1255  
NULL
;

1258 
	`jbd_debug
(1, "JBD3: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1259 
šode
->
i_sb
->
s_id
, inode->
i_šo
, (èšode->
i_size
,

1260 
šode
->
i_sb
->
s_blocksize_b™s
, inode->i_sb->
s_blocksize
);

1262 
jouº®
 = 
	`jouº®_š™_commÚ
(
šode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1263 
blockÄ
, 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
,

1264 
šode
->
i_sb
->
s_blocksize
);

1265 ià(!
jouº®
)

1266  
NULL
;

1268 
jouº®
->
j_šode
 = 
šode
;

1269 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1270 
p
 = 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1271 
	`¥rštf
(
p
, "-%lu", 
jouº®
->
j_šode
->
i_šo
);

1272 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1274  
jouº®
;

1275 
	}
}

1282 
	$jouº®_ç_su³rblock
 (
jouº®_t
 *
jouº®
)

1284 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1285 
	`b»l£
(
bh
);

1286 
jouº®
->
j_sb_bufãr
 = 
NULL
;

1287 
	}
}

1296 
	$jouº®_»£t
(
jouº®_t
 *
jouº®
)

1298 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1299 
fœ¡
, 
Ï¡
;

1301 
fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1302 
Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1303 ià(
fœ¡
 + 
JBD3_MIN_JOURNAL_BLOCKS
 > 
Ï¡
 + 1) {

1304 
	`´štk
(
KERN_ERR
 "JBD3: Journaloo short (blocks %llu-%llu).\n",

1305 
fœ¡
, 
Ï¡
);

1306 
	`jouº®_ç_su³rblock
(
jouº®
);

1307  -
EINVAL
;

1310 
jouº®
->
j_fœ¡
 = 
fœ¡
;

1311 
jouº®
->
j_Ï¡
 = 
Ï¡
;

1313 
jouº®
->
j_h—d
 = 
fœ¡
;

1314 
jouº®
->
j_
 = 
fœ¡
;

1315 
jouº®
->
j_ä“
 = 
Ï¡
 - 
fœ¡
;

1317 
jouº®
->
j__£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
;

1318 
jouº®
->
j_comm™_£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
 - 1;

1319 
jouº®
->
j_comm™_»que¡
 = jouº®->
j_comm™_£qu’û
;

1321 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 = jouº®->
j_maxËn
 / 4;

1329 ià(
sb
->
s_¡¬t
 == 0) {

1330 
	`jbd_debug
(1, "JBD3: Skipping superblock update on„ecovered sb "

1332 
jouº®
->
j_
, jouº®->
j__£qu’û
,

1333 
jouº®
->
j_”ºo
);

1334 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1337 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1344 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

1345 
jouº®
->
j__£qu’û
,

1346 
jouº®
->
j_
,

1347 
REQ_SYNC
 | 
REQ_FUA
);

1348 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1350  
	`jbd3_jouº®_¡¬t_th»ad
(
jouº®
);

1351 
	}
}

1357 
	$jbd3_wr™e_su³rblock
(
jouº®_t
 *
jouº®
, 
wr™e_æags
)

1359 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1360 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1361 
»t
;

1364 ià(!
	`bufãr_m­³d
(
bh
))

1365  -
EIO
;

1367 
	`Œaû_jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_æags
);

1368 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

1369 
wr™e_æags
 &ğ~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1370 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1379 
	`´štk
(
KERN_ERR
 "JBD3:…revious I/Oƒrror detected "

1381 
jouº®
->
j_devÇme
);

1382 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1383 
	`£t_bufãr_u±od©e
(
bh
);

1385 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

1386 
sb
->
s_checksum
 = 
	`jbd3_su³rblock_csum
(
jouº®
, sb);

1387 
	`g‘_bh
(
bh
);

1388 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

1389 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
wr™e_æags
, 
bh
);

1390 
	`wa™_Ú_bufãr
(
bh
);

1391 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1392 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1393 
	`£t_bufãr_u±od©e
(
bh
);

1394 
»t
 = -
EIO
;

1396 ià(
»t
) {

1397 
	`´štk
(
KERN_ERR
 "JBD3: Error %d detected when updating "

1398 "jouº® su³rblock fÜ %s.\n", 
»t
,

1399 
jouº®
->
j_devÇme
);

1400 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

1403  
»t
;

1404 
	}
}

1416 
	$jbd3_jouº®_upd©e_sb_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
_tid
,

1417 
_block
, 
wr™e_İ
)

1419 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1420 
»t
;

1422 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1423  -
EIO
;

1425 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1426 
	`jbd_debug
(1, "JBD3: updating superblock (start %lu, seq %u)\n",

1427 
_block
, 
_tid
);

1429 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1430 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
_tid
);

1431 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(
_block
);

1433 
»t
 = 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1434 ià(
»t
)

1435 
out
;

1438 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1439 
	`WARN_ON
(!
sb
->
s_£qu’û
);

1440 
jouº®
->
j_æags
 &ğ~
JBD3_FLUSHED
;

1441 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1443 
out
:

1444  
»t
;

1445 
	}
}

1455 
	$jbd3_m¬k_jouº®_em±y
(
jouº®_t
 *
jouº®
, 
wr™e_İ
)

1457 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1459 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1460 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1461 ià(
sb
->
s_¡¬t
 == 0) {

1462 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1466 
	`jbd_debug
(1, "JBD3: Marking journal‡sƒmpty (seq %u)\n",

1467 
jouº®
->
j__£qu’û
);

1469 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
jouº®
->
j__£qu’û
);

1470 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(0);

1472 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1475 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1476 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1477 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1478 
	}
}

1488 
	$jbd3_jouº®_upd©e_sb_”ºo
(
jouº®_t
 *
jouº®
)

1490 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1491 
”rcode
;

1493 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1494 
”rcode
 = 
jouº®
->
j_”ºo
;

1495 ià(
”rcode
 =ğ-
ESHUTDOWN
)

1496 
”rcode
 = 0;

1497 
	`jbd_debug
(1, "JBD3: upd©šg su³rblockƒ¼Ü (”ºØ%d)\n", 
”rcode
);

1498 
sb
->
s_”ºo
 = 
	`ıu_to_be32
(
”rcode
);

1500 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

1501 
	}
}

1502 
EXPORT_SYMBOL
(
jbd3_jouº®_upd©e_sb_”ºo
);

1504 
	$jouº®_»voke_»cÜds_³r_block
(
jouº®_t
 *
jouº®
)

1506 
»cÜd_size
;

1507 
¥aû
 = 
jouº®
->
j_blocksize
 - (
jbd3_jouº®_»voke_h—d”_t
);

1509 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

1510 
»cÜd_size
 = 8;

1512 
»cÜd_size
 = 4;

1514 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

1515 
¥aû
 -ğ(
jbd3_jouº®_block_
);

1516  
¥aû
 / 
»cÜd_size
;

1517 
	}
}

1523 
	$jouº®_g‘_su³rblock
(
jouº®_t
 *
jouº®
)

1525 
bufãr_h—d
 *
bh
;

1526 
jouº®_su³rblock_t
 *
sb
;

1527 
”r
 = -
EIO
;

1529 
bh
 = 
jouº®
->
j_sb_bufãr
;

1531 
	`J_ASSERT
(
bh
 !ğ
NULL
);

1532 ià(!
	`bufãr_u±od©e
(
bh
)) {

1533 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1534 
	`wa™_Ú_bufãr
(
bh
);

1535 ià(!
	`bufãr_u±od©e
(
bh
)) {

1536 
	`´štk
(
KERN_ERR


1538 
out
;

1542 ià(
	`bufãr_v”if›d
(
bh
))

1545 
sb
 = 
jouº®
->
j_su³rblock
;

1547 
”r
 = -
EINVAL
;

1549 ià(
sb
->
s_h—d”
.
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
) ||

1550 
sb
->
s_blocksize
 !ğ
	`ıu_to_be32
(
jouº®
->
j_blocksize
)) {

1551 
	`´štk
(
KERN_WARNING
 "JBD3:‚o valid journal superblock found\n");

1552 
out
;

1555 
	`be32_to_ıu
(
sb
->
s_h—d”
.
h_blockty³
)) {

1556 
JBD3_SUPERBLOCK_V1
:

1557 
jouº®
->
j_fÜm©_v”siÚ
 = 1;

1559 
JBD3_SUPERBLOCK_V2
:

1560 
jouº®
->
j_fÜm©_v”siÚ
 = 2;

1563 
	`´štk
(
KERN_WARNING
 "JBD3: unrecognised superblock format ID\n");

1564 
out
;

1567 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è< 
jouº®
->
j_maxËn
)

1568 
jouº®
->
j_maxËn
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1569 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è> 
jouº®
->
j_maxËn
) {

1570 
	`´štk
(
KERN_WARNING
 "JBD3: journal fileoo short\n");

1571 
out
;

1574 ià(
	`be32_to_ıu
(
sb
->
s_fœ¡
) == 0 ||

1575 
	`be32_to_ıu
(
sb
->
s_fœ¡
è>ğ
jouº®
->
j_maxËn
) {

1576 
	`´štk
(
KERN_WARNING


1578 
	`be32_to_ıu
(
sb
->
s_fœ¡
));

1579 
out
;

1582 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
) &&

1583 
	`jbd3_has_ã©u»_csum3
(
jouº®
)) {

1585 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v2‡nd v3 "

1587 
out
;

1590 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
) &&

1591 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

1593 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v1‡nd v2/3 "

1595 
out
;

1598 ià(!
	`jbd3_v”ify_csum_ty³
(
jouº®
, 
sb
)) {

1599 
	`´štk
(
KERN_ERR
 "JBD3: Unknown checksumype\n");

1600 
out
;

1604 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
)) {

1605 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1606 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1607 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1608 
”r
 = 
	`PTR_ERR
(
jouº®
->
j_chksum_driv”
);

1609 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1610 
out
;

1614 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
)) {

1616 ià(
sb
->
s_checksum
 !ğ
	`jbd3_su³rblock_csum
(
jouº®
, sb)) {

1617 
	`´štk
(
KERN_ERR
 "JBD3: journal checksumƒrror\n");

1618 
”r
 = -
EFSBADCRC
;

1619 
out
;

1623 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1624 (
sb
->
s_uuid
));

1627 
jouº®
->
j_»voke_»cÜds_³r_block
 =

1628 
	`jouº®_»voke_»cÜds_³r_block
(
jouº®
);

1629 
	`£t_bufãr_v”if›d
(
bh
);

1633 
out
:

1634 
	`jouº®_ç_su³rblock
(
jouº®
);

1635  
”r
;

1636 
	}
}

1643 
	$lßd_su³rblock
(
jouº®_t
 *
jouº®
)

1645 
”r
;

1646 
jouº®_su³rblock_t
 *
sb
;

1648 
”r
 = 
	`jouº®_g‘_su³rblock
(
jouº®
);

1649 ià(
”r
)

1650  
”r
;

1652 
sb
 = 
jouº®
->
j_su³rblock
;

1654 
jouº®
->
j__£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

1655 
jouº®
->
j_
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

1656 
jouº®
->
j_fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1657 
jouº®
->
j_Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1658 
jouº®
->
j_”ºo
 = 
	`be32_to_ıu
(
sb
->
s_”ºo
);

1661 
	}
}

1672 
	$jbd3_jouº®_lßd
(
jouº®_t
 *
jouº®
)

1674 
”r
;

1675 
jouº®_su³rblock_t
 *
sb
;

1677 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

1678 ià(
”r
)

1679  
”r
;

1681 
sb
 = 
jouº®
->
j_su³rblock
;

1685 ià(
jouº®
->
j_fÜm©_v”siÚ
 >= 2) {

1686 ià((
sb
->
s_ã©u»_ro_com·t
 &

1687 ~
	`ıu_to_be32
(
JBD3_KNOWN_ROCOMPAT_FEATURES
)) ||

1688 (
sb
->
s_ã©u»_šcom·t
 &

1689 ~
	`ıu_to_be32
(
JBD3_KNOWN_INCOMPAT_FEATURES
))) {

1690 
	`´štk
(
KERN_WARNING


1692  -
EINVAL
;

1699 
”r
 = 
	`jbd3_jouº®_ü—‹_¦ab
(
	`be32_to_ıu
(
sb
->
s_blocksize
));

1700 ià(
”r
)

1701  
”r
;

1705 ià(
	`jbd3_jouº®_»cov”
(
jouº®
))

1706 
»cov”y_”rÜ
;

1708 ià(
jouº®
->
j_çed_comm™
) {

1709 
	`´štk
(
KERN_ERR
 "JBD3: journalransaction %u on %s "

1710 "i cÜru±.\n", 
jouº®
->
j_çed_comm™
,

1711 
jouº®
->
j_devÇme
);

1712  -
EFSCORRUPTED
;

1718 
jouº®
->
j_æags
 &ğ~
JBD3_ABORT
;

1723 ià(
	`jouº®_»£t
(
jouº®
))

1724 
»cov”y_”rÜ
;

1726 
jouº®
->
j_æags
 |ğ
JBD3_LOADED
;

1729 
»cov”y_”rÜ
:

1730 
	`´štk
(
KERN_WARNING
 "JBD3:„ecovery failed\n");

1731  -
EIO
;

1732 
	}
}

1742 
	$jbd3_jouº®_de¡roy
(
jouº®_t
 *
jouº®
)

1744 
”r
 = 0;

1747 
	`jouº®_kl_th»ad
(
jouº®
);

1750 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

1751 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

1756 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1757 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1758 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1759 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1760 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

1761 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1766 ià(
”r
) {

1767 
	`jbd3_jouº®_de¡roy_checkpošt
(
jouº®
);

1768 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1771 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1774 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

1775 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

1776 
	`J_ASSERT
(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
);

1777 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1779 ià(
jouº®
->
j_sb_bufãr
) {

1780 ià(!
	`is_jouº®_abÜ‹d
(
jouº®
)) {

1781 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1783 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1784 
jouº®
->
j__£qu’û
 =

1785 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

1786 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1788 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
,

1789 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1790 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1792 
”r
 = -
EIO
;

1793 
	`b»l£
(
jouº®
->
j_sb_bufãr
);

1796 ià(
jouº®
->
j_´oc_’Œy
)

1797 
	`jbd3_¡©s_´oc_ex™
(
jouº®
);

1798 
	`ut
(
jouº®
->
j_šode
);

1799 ià(
jouº®
->
j_»voke
)

1800 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1801 ià(
jouº®
->
j_chksum_driv”
)

1802 
	`üy±o_ä“_shash
(
jouº®
->
j_chksum_driv”
);

1803 
	`kä“
(
jouº®
->
j_wbuf
);

1804 
	`kä“
(
jouº®
);

1806  
”r
;

1807 
	}
}

1821 
	$jbd3_jouº®_check_u£d_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1822 
ro
, 
šcom·t
)

1824 
jouº®_su³rblock_t
 *
sb
;

1826 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1829 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 0 &&

1830 
	`jouº®_g‘_su³rblock
(
jouº®
) != 0)

1832 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 1)

1835 
sb
 = 
jouº®
->
j_su³rblock
;

1837 ià(((
	`be32_to_ıu
(
sb
->
s_ã©u»_com·t
è& 
com·t
) == compat) &&

1838 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_ro_com·t
è& 
ro
) ==„o) &&

1839 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_šcom·t
è& 
šcom·t
) == incompat))

1843 
	}
}

1856 
	$jbd3_jouº®_check_avaabË_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1857 
ro
, 
šcom·t
)

1859 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1866 ià(
jouº®
->
j_fÜm©_v”siÚ
 != 2)

1869 ià((
com·t
 & 
JBD3_KNOWN_COMPAT_FEATURES
) == compat &&

1870 (
ro
 & 
JBD3_KNOWN_ROCOMPAT_FEATURES
) ==„o &&

1871 (
šcom·t
 & 
JBD3_KNOWN_INCOMPAT_FEATURES
) == incompat)

1875 
	}
}

1889 
	$jbd3_jouº®_£t_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1890 
ro
, 
šcom·t
)

1892 
	#INCOMPAT_FEATURE_ON
(
f
) \

1893 ((
šcom·t
 & (
f
)è&& !(
sb
->
s_ã©u»_šcom·t
 & 
	`ıu_to_be32
(f)))

	)

1894 
	#COMPAT_FEATURE_ON
(
f
) \

1895 ((
com·t
 & (
f
)è&& !(
sb
->
s_ã©u»_com·t
 & 
	`ıu_to_be32
(f)))

	)

1896 
jouº®_su³rblock_t
 *
sb
;

1898 ià(
	`jbd3_jouº®_check_u£d_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1901 ià(!
	`jbd3_jouº®_check_avaabË_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1905 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V2
) {

1906 
šcom·t
 &ğ~
JBD3_FEATURE_INCOMPAT_CSUM_V2
;

1907 
šcom·t
 |ğ
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

1911 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 &&

1912 
com·t
 & 
JBD3_FEATURE_COMPAT_CHECKSUM
)

1913 
com·t
 &ğ~
JBD3_FEATURE_COMPAT_CHECKSUM
;

1915 
	`jbd_debug
(1, "Setting‚ew features 0x%lx/0x%lx/0x%lx\n",

1916 
com·t
, 
ro
, 
šcom·t
);

1918 
sb
 = 
jouº®
->
j_su³rblock
;

1921 ià((
jouº®
->
j_chksum_driv”
 =ğ
NULL
) &&

1922 
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1923 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1924 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1925 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1926 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1930 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1931 (
sb
->
s_uuid
));

1934 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1937 ià(
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1938 
sb
->
s_checksum_ty³
 = 
JBD3_CRC32C_CHKSUM
;

1939 
sb
->
s_ã©u»_com·t
 &=

1940 ~
	`ıu_to_be32
(
JBD3_FEATURE_COMPAT_CHECKSUM
);

1944 ià(
	`COMPAT_FEATURE_ON
(
JBD3_FEATURE_COMPAT_CHECKSUM
))

1945 
sb
->
s_ã©u»_šcom·t
 &=

1946 ~
	`ıu_to_be32
(
JBD3_FEATURE_INCOMPAT_CSUM_V2
 |

1947 
JBD3_FEATURE_INCOMPAT_CSUM_V3
);

1949 
sb
->
s_ã©u»_com·t
 |ğ
	`ıu_to_be32
(
com·t
);

1950 
sb
->
s_ã©u»_ro_com·t
 |ğ
	`ıu_to_be32
(
ro
);

1951 
sb
->
s_ã©u»_šcom·t
 |ğ
	`ıu_to_be32
(
šcom·t
);

1952 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1953 
jouº®
->
j_»voke_»cÜds_³r_block
 =

1954 
	`jouº®_»voke_»cÜds_³r_block
(
jouº®
);

1957 #undeà
COMPAT_FEATURE_ON


1958 #undeà
INCOMPAT_FEATURE_ON


1959 
	}
}

1972 
	$jbd3_jouº®_ş—r_ã©u»s
(
jouº®_t
 *
jouº®
, 
com·t
,

1973 
ro
, 
šcom·t
)

1975 
jouº®_su³rblock_t
 *
sb
;

1977 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1978 
com·t
, 
ro
, 
šcom·t
);

1980 
sb
 = 
jouº®
->
j_su³rblock
;

1982 
sb
->
s_ã©u»_com·t
 &ğ~
	`ıu_to_be32
(
com·t
);

1983 
sb
->
s_ã©u»_ro_com·t
 &ğ~
	`ıu_to_be32
(
ro
);

1984 
sb
->
s_ã©u»_šcom·t
 &ğ~
	`ıu_to_be32
(
šcom·t
);

1985 
jouº®
->
j_»voke_»cÜds_³r_block
 =

1986 
	`jouº®_»voke_»cÜds_³r_block
(
jouº®
);

1987 
	}
}

1988 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_ã©u»s
);

1999 
	$jbd3_jouº®_æush
(
jouº®_t
 *
jouº®
)

2001 
”r
 = 0;

2002 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

2004 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2007 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

2008 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2009 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

2010 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

2011 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

2014 ià(
Œª§ùiÚ
) {

2015 
tid_t
 
tid
 = 
Œª§ùiÚ
->
t_tid
;

2017 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2018 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

2020 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2024 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2025 !
”r
 && 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

2026 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2027 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2028 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

2029 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2030 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2032 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2034 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

2035  -
EIO
;

2037 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2038 ià(!
”r
) {

2039 
”r
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

2040 ià(
”r
 < 0) {

2041 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2042 
out
;

2044 
”r
 = 0;

2052 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2053 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2054 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2055 
	`J_ASSERT
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2056 
	`J_ASSERT
(!
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2057 
	`J_ASSERT
(!
jouº®
->
j_checkpošt_Œª§ùiÚs
);

2058 
	`J_ASSERT
(
jouº®
->
j_h—d
 =ğjouº®->
j_
);

2059 
	`J_ASSERT
(
jouº®
->
j__£qu’û
 =ğjouº®->
j_Œª§ùiÚ_£qu’û
);

2060 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2061 
out
:

2062  
”r
;

2063 
	}
}

2078 
	$jbd3_jouº®_we
(
jouº®_t
 *
jouº®
, 
wr™e
)

2080 
”r
 = 0;

2082 
	`J_ASSERT
 (!(
jouº®
->
j_æags
 & 
JBD3_LOADED
));

2084 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

2085 ià(
”r
)

2086  
”r
;

2088 ià(!
jouº®
->
j_
)

2089 
no_»cov”y
;

2091 
	`´štk
(
KERN_WARNING
 "JBD3: %s„ecovery information on journal\n",

2092 
wr™e
 ? "Clearing" : "Ignoring");

2094 
”r
 = 
	`jbd3_jouº®_sk_»cov”y
(
jouº®
);

2095 ià(
wr™e
) {

2097 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2098 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2099 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2102 
no_»cov”y
:

2103  
”r
;

2104 
	}
}

2119 
	$__jbd3_jouº®_abÜt_h¬d
(
jouº®_t
 *
jouº®
)

2121 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2123 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2126 
	`´štk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2127 
jouº®
->
j_devÇme
);

2129 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2130 
jouº®
->
j_æags
 |ğ
JBD3_ABORT
;

2131 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2132 ià(
Œª§ùiÚ
)

2133 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

2134 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2135 
	}
}

2139 
	$__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
)

2141 
Şd_”ºo
;

2143 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2144 
Şd_”ºo
 = 
jouº®
->
j_”ºo
;

2145 ià(!
jouº®
->
j_”ºo
 || 
”ºo
 =ğ-
ESHUTDOWN
)

2146 
jouº®
->
j_”ºo
 = 
”ºo
;

2148 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

2149 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2150 ià(
Şd_”ºo
 !ğ-
ESHUTDOWN
 && 
”ºo
 == -ESHUTDOWN)

2151 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2154 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2156 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

2158 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2159 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2160 
jouº®
->
j_æags
 |ğ
JBD3_REC_ERR
;

2161 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2162 
	}
}

2205 
	$jbd3_jouº®_abÜt
(
jouº®_t
 *
jouº®
, 
”ºo
)

2207 
	`__jouº®_abÜt_soá
(
jouº®
, 
”ºo
);

2208 
	}
}

2221 
	$jbd3_jouº®_”ºo
(
jouº®_t
 *
jouº®
)

2223 
”r
;

2225 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2226 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2227 
”r
 = -
EROFS
;

2229 
”r
 = 
jouº®
->
j_”ºo
;

2230 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2231  
”r
;

2232 
	}
}

2241 
	$jbd3_jouº®_ş—r_”r
(
jouº®_t
 *
jouº®
)

2243 
”r
 = 0;

2245 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2246 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2247 
”r
 = -
EROFS
;

2249 
jouº®
->
j_”ºo
 = 0;

2250 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2251  
”r
;

2252 
	}
}

2261 
	$jbd3_jouº®_ack_”r
(
jouº®_t
 *
jouº®
)

2263 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2264 ià(
jouº®
->
j_”ºo
)

2265 
jouº®
->
j_æags
 |ğ
JBD3_ACK_ERR
;

2266 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2267 
	}
}

2269 
	$jbd3_jouº®_blocks_³r_·ge
(
šode
 *inode)

2271  1 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

2272 
	}
}

2277 
size_t
 
	$jouº®_g_by‹s
(
jouº®_t
 *
jouº®
)

2279 
size_t
 
sz
;

2281 ià(
	`jbd3_has_ã©u»_csum3
(
jouº®
))

2282  (
jouº®_block_g3_t
);

2284 
sz
 = (
jouº®_block_g_t
);

2286 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
))

2287 
sz
 +ğ(
__u16
);

2289 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

2290  
sz
;

2292  
sz
 - (
__u32
);

2293 
	}
}

2310 
	#JBD3_MAX_SLABS
 8

	)

2311 
kmem_ÿche
 *
	gjbd3_¦ab
[
JBD3_MAX_SLABS
];

2313 cÚ¡ *
	gjbd3_¦ab_Çmes
[
JBD3_MAX_SLABS
] = {

2319 
	$jbd3_jouº®_de¡roy_¦abs
()

2321 
i
;

2323 
i
 = 0; i < 
JBD3_MAX_SLABS
; i++) {

2324 
	`kmem_ÿche_de¡roy
(
jbd3_¦ab
[
i
]);

2325 
jbd3_¦ab
[
i
] = 
NULL
;

2327 
	}
}

2329 
	$jbd3_jouº®_ü—‹_¦ab
(
size_t
 
size
)

2331 
	`DEFINE_MUTEX
(
jbd3_¦ab_ü—‹_mu‹x
);

2332 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2333 
size_t
 
¦ab_size
;

2335 ià(
size
 =ğ
PAGE_SIZE
)

2338 ià(
i
 >ğ
JBD3_MAX_SLABS
)

2339  -
EINVAL
;

2341 ià(
	`uÆik–y
(
i
 < 0))

2342 
i
 = 0;

2343 
	`mu‹x_lock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2344 ià(
jbd3_¦ab
[
i
]) {

2345 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2349 
¦ab_size
 = 1 << (
i
+10);

2350 
jbd3_¦ab
[
i
] = 
	`kmem_ÿche_ü—‹
(
jbd3_¦ab_Çmes
[i], 
¦ab_size
,

2351 
¦ab_size
, 0, 
NULL
);

2352 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2353 ià(!
jbd3_¦ab
[
i
]) {

2354 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for jbd3_slab cache\n");

2355  -
ENOMEM
;

2358 
	}
}

2360 
kmem_ÿche
 *
	$g‘_¦ab
(
size_t
 
size
)

2362 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2364 
	`BUG_ON
(
i
 >ğ
JBD3_MAX_SLABS
);

2365 ià(
	`uÆik–y
(
i
 < 0))

2366 
i
 = 0;

2367 
	`BUG_ON
(
jbd3_¦ab
[
i
] =ğ
NULL
);

2368  
jbd3_¦ab
[
i
];

2369 
	}
}

2371 *
	$jbd3_®loc
(
size_t
 
size
, 
gå_t
 
æags
)

2373 *
±r
;

2375 
	`BUG_ON
(
size
 & (size-1));

2377 ià(
size
 < 
PAGE_SIZE
)

2378 
±r
 = 
	`kmem_ÿche_®loc
(
	`g‘_¦ab
(
size
), 
æags
);

2380 
±r
 = (*)
	`__g‘_ä“_·ges
(
æags
, 
	`g‘_Üd”
(
size
));

2384 
	`BUG_ON
(((è
±r
è& (
size
-1));

2386  
±r
;

2387 
	}
}

2389 
	$jbd3_ä“
(*
±r
, 
size_t
 
size
)

2391 ià(
size
 < 
PAGE_SIZE
)

2392 
	`kmem_ÿche_ä“
(
	`g‘_¦ab
(
size
), 
±r
);

2394 
	`ä“_·ges
(()
±r
, 
	`g‘_Üd”
(
size
));

2395 
	}
};

2400 
kmem_ÿche
 *
	gjbd3_jouº®_h—d_ÿche
;

2401 #ifdeà
CONFIG_JBD3_DEBUG


2402 
©omic_t
 
	gÄ_jouº®_h—ds
 = 
ATOMIC_INIT
(0);

2405 
__š™
 
	$jbd3_jouº®_š™_jouº®_h—d_ÿche
()

2407 
	`J_ASSERT
(!
jbd3_jouº®_h—d_ÿche
);

2408 
jbd3_jouº®_h—d_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_journal_head",

2409 (
jouº®_h—d
),

2411 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2412 
NULL
);

2413 ià(!
jbd3_jouº®_h—d_ÿche
) {

2414 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for journal_head cache\n");

2415  -
ENOMEM
;

2418 
	}
}

2420 
	$jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
()

2422 
	`kmem_ÿche_de¡roy
(
jbd3_jouº®_h—d_ÿche
);

2423 
jbd3_jouº®_h—d_ÿche
 = 
NULL
;

2424 
	}
}

2429 
jouº®_h—d
 *
	$jouº®_®loc_jouº®_h—d
()

2431 
jouº®_h—d
 *
»t
;

2433 #ifdeà
CONFIG_JBD3_DEBUG


2434 
	`©omic_šc
(&
Ä_jouº®_h—ds
);

2436 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
, 
GFP_NOFS
);

2437 ià(!
»t
) {

2438 
	`jbd_debug
(1, "out of memory for journal_head\n");

2439 
	`´_nÙiû_¿‹lim™ed
("ENOMEM iÀ%s,„‘ryšg.\n", 
__func__
);

2440 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
,

2441 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2443 ià(
»t
)

2444 
	`¥š_lock_š™
(&
»t
->
b_¡©e_lock
);

2445  
»t
;

2446 
	}
}

2448 
	$jouº®_ä“_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2450 #ifdeà
CONFIG_JBD3_DEBUG


2451 
	`©omic_dec
(&
Ä_jouº®_h—ds
);

2452 
	`mem£t
(
jh
, 
JBD3_POISON_FREE
, (*jh));

2454 
	`kmem_ÿche_ä“
(
jbd3_jouº®_h—d_ÿche
, 
jh
);

2455 
	}
}

2498 
jouº®_h—d
 *
	$jbd3_jouº®_add_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2500 
jouº®_h—d
 *
jh
;

2501 
jouº®_h—d
 *
Ãw_jh
 = 
NULL
;

2503 
»³©
:

2504 ià(!
	`bufãr_jbd
(
bh
))

2505 
Ãw_jh
 = 
	`jouº®_®loc_jouº®_h—d
();

2507 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2508 ià(
	`bufãr_jbd
(
bh
)) {

2509 
jh
 = 
	`bh2jh
(
bh
);

2511 
	`J_ASSERT_BH
(
bh
,

2512 (
	`©omic_»ad
(&
bh
->
b_couÁ
) > 0) ||

2513 (
bh
->
b_·ge
 && bh->b_·ge->
m­pšg
));

2515 ià(!
Ãw_jh
) {

2516 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2517 
»³©
;

2520 
jh
 = 
Ãw_jh
;

2521 
Ãw_jh
 = 
NULL
;

2522 
	`£t_bufãr_jbd
(
bh
);

2523 
bh
->
b_´iv©e
 = 
jh
;

2524 
jh
->
b_bh
 = 
bh
;

2525 
	`g‘_bh
(
bh
);

2526 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2528 
jh
->
b_jcouÁ
++;

2529 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2530 ià(
Ãw_jh
)

2531 
	`jouº®_ä“_jouº®_h—d
(
Ãw_jh
);

2532  
bh
->
b_´iv©e
;

2533 
	}
}

2539 
jouº®_h—d
 *
	$jbd3_jouº®_g¿b_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2541 
jouº®_h—d
 *
jh
 = 
NULL
;

2543 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2544 ià(
	`bufãr_jbd
(
bh
)) {

2545 
jh
 = 
	`bh2jh
(
bh
);

2546 
jh
->
b_jcouÁ
++;

2548 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2549  
jh
;

2550 
	}
}

2552 
	$__jouº®_»move_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2554 
jouº®_h—d
 *
jh
 = 
	`bh2jh
(
bh
);

2556 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 >= 0);

2557 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
NULL
);

2558 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2559 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

2560 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 =ğ
BJ_NÚe
);

2561 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbd
(bh));

2562 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2563 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2566 
bh
->
b_´iv©e
 = 
NULL
;

2567 
jh
->
b_bh
 = 
NULL
;

2568 
	`ş—r_bufãr_jbd
(
bh
);

2569 
	}
}

2571 
	$jouº®_»Ëa£_jouº®_h—d
(
jouº®_h—d
 *
jh
, 
size_t
 
b_size
)

2573 ià(
jh
->
b_äoz’_d©a
) {

2574 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_äoz’_d©a\n", 
__func__
);

2575 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
b_size
);

2577 ià(
jh
->
b_comm™‹d_d©a
) {

2578 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_comm™‹d_d©a\n", 
__func__
);

2579 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
b_size
);

2581 
	`jouº®_ä“_jouº®_h—d
(
jh
);

2582 
	}
}

2588 
	$jbd3_jouº®_put_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2590 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2592 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2593 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 > 0);

2594 --
jh
->
b_jcouÁ
;

2595 ià(!
jh
->
b_jcouÁ
) {

2596 
	`__jouº®_»move_jouº®_h—d
(
bh
);

2597 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2598 
	`jouº®_»Ëa£_jouº®_h—d
(
jh
, 
bh
->
b_size
);

2599 
	`__b»l£
(
bh
);

2601 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2603 
	}
}

2608 
	$jbd3_jouº®_š™_jbd_šode
(
jbd3_šode
 *
jšode
, 
šode
 *inode)

2610 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2611 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

2612 
jšode
->
i_vfs_šode
 = 
šode
;

2613 
jšode
->
i_æags
 = 0;

2614 
jšode
->
i_dœty_¡¬t
 = 0;

2615 
jšode
->
i_dœty_’d
 = 0;

2616 
	`INIT_LIST_HEAD
(&
jšode
->
i_li¡
);

2617 
	}
}

2624 
	$jbd3_jouº®_»Ëa£_jbd_šode
(
jouº®_t
 *
jouº®
,

2625 
jbd3_šode
 *
jšode
)

2627 ià(!
jouº®
)

2629 
»¡¬t
:

2630 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2632 ià(
jšode
->
i_æags
 & 
JI_COMMIT_RUNNING
) {

2633 
wa™_queue_h—d_t
 *
wq
;

2634 
	`DEFINE_WAIT_BIT
(
wa™
, &
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2635 
wq
 = 
	`b™_wa™queue
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2636 
	`´•¬e_to_wa™
(
wq
, &
wa™
.
wq_’Œy
, 
TASK_UNINTERRUPTIBLE
);

2637 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2638 
	`scheduË
();

2639 
	`fšish_wa™
(
wq
, &
wa™
.
wq_’Œy
);

2640 
»¡¬t
;

2643 ià(
jšode
->
i_Œª§ùiÚ
) {

2644 
	`li¡_d–
(&
jšode
->
i_li¡
);

2645 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2647 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2648 
	}
}

2651 #ifdeà
CONFIG_PROC_FS


2653 
	#JBD3_STATS_PROC_NAME
 "fs/jbd3"

	)

2655 
__š™
 
	$jbd3_ü—‹_jbd_¡©s_´oc_’Œy
()

2657 
´oc_jbd3_¡©s
 = 
	`´oc_mkdœ
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2658 
	}
}

2660 
__ex™
 
	$jbd3_»move_jbd_¡©s_´oc_’Œy
()

2662 ià(
´oc_jbd3_¡©s
)

2663 
	`»move_´oc_’Œy
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2664 
	}
}

2668 
	#jbd3_ü—‹_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2669 
	#jbd3_»move_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2673 
kmem_ÿche
 *
	gjbd3_hªdË_ÿche
, *
	gjbd3_šode_ÿche
;

2675 
__š™
 
	$jbd3_jouº®_š™_šode_ÿche
()

2677 
	`J_ASSERT
(!
jbd3_šode_ÿche
);

2678 
jbd3_šode_ÿche
 = 
	`KMEM_CACHE
(
jbd3_šode
, 0);

2679 ià(!
jbd3_šode_ÿche
) {

2680 
	`´_em”g
("JBD3: failedo create inode cache\n");

2681  -
ENOMEM
;

2684 
	}
}

2686 
__š™
 
	$jbd3_jouº®_š™_hªdË_ÿche
()

2688 
	`J_ASSERT
(!
jbd3_hªdË_ÿche
);

2689 
jbd3_hªdË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_jouº®_hªdË
, 
SLAB_TEMPORARY
);

2690 ià(!
jbd3_hªdË_ÿche
) {

2691 
	`´štk
(
KERN_EMERG
 "JBD3: failedo create handle cache\n");

2692  -
ENOMEM
;

2695 
	}
}

2697 
	$jbd3_jouº®_de¡roy_šode_ÿche
()

2699 
	`kmem_ÿche_de¡roy
(
jbd3_šode_ÿche
);

2700 
jbd3_šode_ÿche
 = 
NULL
;

2701 
	}
}

2703 
	$jbd3_jouº®_de¡roy_hªdË_ÿche
()

2705 
	`kmem_ÿche_de¡roy
(
jbd3_hªdË_ÿche
);

2706 
jbd3_hªdË_ÿche
 = 
NULL
;

2707 
	}
}

2713 
__š™
 
	$jouº®_š™_ÿches
()

2715 
»t
;

2717 
»t
 = 
	`jbd3_jouº®_š™_»voke_»cÜd_ÿche
();

2718 ià(
»t
 == 0)

2719 
»t
 = 
	`jbd3_jouº®_š™_»voke_bË_ÿche
();

2720 ià(
»t
 == 0)

2721 
»t
 = 
	`jbd3_jouº®_š™_jouº®_h—d_ÿche
();

2722 ià(
»t
 == 0)

2723 
»t
 = 
	`jbd3_jouº®_š™_hªdË_ÿche
();

2724 ià(
»t
 == 0)

2725 
»t
 = 
	`jbd3_jouº®_š™_šode_ÿche
();

2726 ià(
»t
 == 0)

2727 
»t
 = 
	`jbd3_jouº®_š™_Œª§ùiÚ_ÿche
();

2728  
»t
;

2729 
	}
}

2731 
	$jbd3_jouº®_de¡roy_ÿches
()

2733 
	`jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
();

2734 
	`jbd3_jouº®_de¡roy_»voke_bË_ÿche
();

2735 
	`jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
();

2736 
	`jbd3_jouº®_de¡roy_hªdË_ÿche
();

2737 
	`jbd3_jouº®_de¡roy_šode_ÿche
();

2738 
	`jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
();

2739 
	`jbd3_jouº®_de¡roy_¦abs
();

2740 
	}
}

2742 
__š™
 
	$jouº®_š™
()

2744 
»t
;

2746 
	`BUILD_BUG_ON
((
jouº®_su³rblock_s
) != 1024);

2748 
»t
 = 
	`jouº®_š™_ÿches
();

2749 ià(
»t
 == 0) {

2750 
	`jbd3_ü—‹_jbd_¡©s_´oc_’Œy
();

2752 
	`jbd3_jouº®_de¡roy_ÿches
();

2754  
»t
;

2755 
	}
}

2757 
__ex™
 
	$jouº®_ex™
()

2759 #ifdeà
CONFIG_JBD3_DEBUG


2760 
n
 = 
	`©omic_»ad
(&
Ä_jouº®_h—ds
);

2761 ià(
n
)

2762 
	`´štk
(
KERN_ERR
 "JBD3:†—ked %d jouº®_h—ds!\n", 
n
);

2764 
	`jbd3_»move_jbd_¡©s_´oc_’Œy
();

2765 
	`jbd3_jouº®_de¡roy_ÿches
();

2766 
	}
}

2768 
MODULE_LICENSE
("GPL");

2769 
moduË_š™
(
jouº®_š™
);

2770 
moduË_ex™
(
jouº®_ex™
);

	@recovery.c

13 #iâdeà
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<lšux/time.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/jbd3.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/blkdev.h
>

28 
	s»cov”y_šfo


30 
tid_t
 
	m¡¬t_Œª§ùiÚ
;

31 
tid_t
 
	m’d_Œª§ùiÚ
;

33 
	mÄ_»¶ays
;

34 
	mÄ_»vokes
;

35 
	mÄ_»voke_h™s
;

38 
	e·s¡y³
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_Úe_·ss
(
jouº®_t
 *
jouº®
,

40 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
);

41 
sÿn_»voke_»cÜds
(
jouº®_t
 *, 
bufãr_h—d
 *,

42 
tid_t
, 
»cov”y_šfo
 *);

44 #ifdeà
__KERNEL__


47 
	$jouº®_b»l£_¬¿y
(
bufãr_h—d
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`b»l£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_»adah—d
(
jouº®_t
 *
jouº®
, 
¡¬t
)

69 
”r
;

70 
max
, 
nbufs
, 
Ãxt
;

71 
blockÄ
;

72 
bufãr_h—d
 *
bh
;

74 
bufãr_h—d
 * 
bufs
[
MAXBUF
];

77 
max
 = 
¡¬t
 + (128 * 1024 / 
jouº®
->
j_blocksize
);

78 ià(
max
 > 
jouº®
->
j_maxËn
)

79 
max
 = 
jouº®
->
j_maxËn
;

84 
nbufs
 = 0;

86 
Ãxt
 = 
¡¬t
;‚exˆ< 
max
;‚ext++) {

87 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
Ãxt
, &
blockÄ
);

89 ià(
”r
) {

90 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

91 
Ãxt
);

92 
çed
;

95 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

96 ià(!
bh
) {

97 
”r
 = -
ENOMEM
;

98 
çed
;

101 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 ià(
nbufs
 =ğ
MAXBUF
) {

104 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`b»l£
(
bh
);

112 ià(
nbufs
)

113 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
”r
 = 0;

116 
çed
:

117 ià(
nbufs
)

118 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

119  
”r
;

120 
	}
}

129 
	$j»ad
(
bufãr_h—d
 **
bhp
, 
jouº®_t
 *
jouº®
,

130 
off£t
)

132 
”r
;

133 
blockÄ
;

134 
bufãr_h—d
 *
bh
;

136 *
bhp
 = 
NULL
;

138 ià(
off£t
 >ğ
jouº®
->
j_maxËn
) {

139 
	`´štk
(
KERN_ERR
 "JBD3: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
off£t
, &
blockÄ
);

145 ià(
”r
) {

146 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

147 
off£t
);

148  
”r
;

151 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

152 ià(!
bh
)

153  -
ENOMEM
;

155 ià(!
	`bufãr_u±od©e
(
bh
)) {

158 ià(!
	`bufãr_»q
(
bh
))

159 
	`do_»adah—d
(
jouº®
, 
off£t
);

160 
	`wa™_Ú_bufãr
(
bh
);

163 ià(!
	`bufãr_u±od©e
(
bh
)) {

164 
	`´štk
(
KERN_ERR
 "JBD3: Failedo„ead block‡t offset %u\n",

165 
off£t
);

166 
	`b»l£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd3_desütÜ_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

176 
jbd3_jouº®_block_
 *

;

177 
__be32
 
´ovided
;

178 
__u32
 
ÿlcuÏ‹d
;

180 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

183 

 = (
jbd3_jouº®_block_
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd3_jouº®_block_
));

185 
´ovided
 = 

->
t_checksum
;

186 

->
t_checksum
 = 0;

187 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 

->
t_checksum
 = 
´ovided
;

190  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

191 
	}
}

197 
	$couÁ_gs
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

199 * 
gp
;

200 
jouº®_block_g_t
 * 
g
;

201 
Ä
 = 0, 
size
 = 
jouº®
->
j_blocksize
;

202 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

204 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

205 
size
 -ğ(
jbd3_jouº®_block_
);

207 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

209 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
è<ğ
size
) {

210 
g
 = (
jouº®_block_g_t
 *è
gp
;

212 
Ä
++;

213 
gp
 +ğ
g_by‹s
;

214 ià(!(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_SAME_UUID
)))

215 
gp
 += 16;

217 ià(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
))

221  
Ä
;

222 
	}
}

226 
	#w¿p
(
jouº®
, 
v¬
) \

228 ià(
v¬
 >ğ(
jouº®
)->
j_Ï¡
) \

229 
v¬
 -ğ((
jouº®
)->
j_Ï¡
 - (jouº®)->
j_fœ¡
); \

230 } 0)

	)

244 
	$jbd3_jouº®_»cov”
(
jouº®_t
 *
jouº®
)

246 
”r
, 
”r2
;

247 
jouº®_su³rblock_t
 * 
sb
;

249 
»cov”y_šfo
 
šfo
;

251 
	`mem£t
(&
šfo
, 0, (info));

252 
sb
 = 
jouº®
->
j_su³rblock
;

260 ià(!
sb
->
s_¡¬t
) {

261 
	`jbd_debug
(1, "No„ecovery„equired,†astransaction %d\n",

262 
	`be32_to_ıu
(
sb
->
s_£qu’û
));

263 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
) + 1;

267 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

268 ià(!
”r
)

269 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REVOKE
);

270 ià(!
”r
)

271 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD3:„ecovery,ƒxit status %d, "

275 
”r
, 
šfo
.
¡¬t_Œª§ùiÚ
, info.
’d_Œª§ùiÚ
);

276 
	`jbd_debug
(1, "JBD3: Replayed %d‡nd„evoked %d/%d blocks\n",

277 
šfo
.
Ä_»¶ays
, info.
Ä_»voke_h™s
, info.
Ä_»vokes
);

281 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

283 
	`jbd3_jouº®_ş—r_»voke
(
jouº®
);

284 
”r2
 = 
	`sync_blockdev
(
jouº®
->
j_fs_dev
);

285 ià(!
”r
)

286 
”r
 = 
”r2
;

288 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

289 
”r2
 = 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 ià(!
”r
)

291 
”r
 = 
”r2
;

293  
”r
;

294 
	}
}

309 
	$jbd3_jouº®_sk_»cov”y
(
jouº®_t
 *
jouº®
)

311 
”r
;

313 
»cov”y_šfo
 
šfo
;

315 
	`mem£t
 (&
šfo
, 0, (info));

317 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

319 ià(
”r
) {

320 
	`´štk
(
KERN_ERR
 "JBD3:ƒ¼Ü %d sÿÂšg jouº®\n", 
”r
);

321 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

323 #ifdeà
CONFIG_JBD3_DEBUG


324 
drİ³d
 = 
šfo
.
’d_Œª§ùiÚ
 -

325 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_£qu’û
);

326 
	`jbd_debug
(1,

328 
drİ³d
, (dropped == 1) ? "" : "s");

330 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

333 
jouº®
->
j_
 = 0;

334  
”r
;

335 
	}
}

337 
šlše
 
	$»ad_g_block
(
jouº®_t
 *
jouº®
,

338 
jouº®_block_g_t
 *
g
)

340 
block
 = 
	`be32_to_ıu
(
g
->
t_blockÄ
);

341 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

342 
block
 |ğ(
u64
)
	`be32_to_ıu
(
g
->
t_blockÄ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ÿlc_chksums
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

351 *
Ãxt_log_block
, 
__u32
 *
üc32_sum
)

353 
i
, 
num_blks
, 
”r
;

354 
io_block
;

355 
bufãr_h—d
 *
obh
;

357 
num_blks
 = 
	`couÁ_gs
(
jouº®
, 
bh
);

359 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
Ãxt_log_block
)++;

363 
	`w¿p
(
jouº®
, *
Ãxt_log_block
);

364 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

365 ià(
”r
) {

366 
	`´štk
(
KERN_ERR
 "JBD3: IOƒrror %d„ecovering block "

367 "%lu iÀlog\n", 
”r
, 
io_block
);

370 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd3_comm™_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

380 
comm™_h—d”
 *
h
;

381 
__be32
 
´ovided
;

382 
__u32
 
ÿlcuÏ‹d
;

384 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

387 
h
 = 
buf
;

388 
´ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
´ovided
;

393  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

394 
	}
}

396 
	$jbd3_block_g_csum_v”ify
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

397 *
buf
, 
__u32
 
£qu’û
)

399 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

406 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

407 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

411  
g3
->
t_checksum
 =ğ
	`ıu_to_be32
(
csum32
);

413  
g
->
t_checksum
 =ğ
	`ıu_to_be16
(
csum32
);

414 
	}
}

416 
	$do_Úe_·ss
(
jouº®_t
 *
jouº®
,

417 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
)

419 
fœ¡_comm™_ID
, 
Ãxt_comm™_ID
;

420 
Ãxt_log_block
;

421 
”r
, 
sucûss
 = 0;

422 
jouº®_su³rblock_t
 * 
sb
;

423 
jouº®_h—d”_t
 * 
tmp
;

424 
bufãr_h—d
 * 
bh
;

425 
£qu’û
;

426 
blockty³
;

427 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

428 
__u32
 
üc32_sum
 = ~0;

429 
desü_csum_size
 = 0;

430 
block_”rÜ
 = 0;

438 
sb
 = 
jouº®
->
j_su³rblock
;

439 
Ãxt_comm™_ID
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

440 
Ãxt_log_block
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

442 
fœ¡_comm™_ID
 = 
Ãxt_comm™_ID
;

443 ià(
·ss
 =ğ
PASS_SCAN
)

444 
šfo
->
¡¬t_Œª§ùiÚ
 = 
fœ¡_comm™_ID
;

446 
	`jbd_debug
(1, "S¹šg„ecov”y…as %d\n", 
·ss
);

456 
æags
;

457 * 
gp
;

458 
jouº®_block_g_t
 * 
g
;

459 
bufãr_h—d
 * 
obh
;

460 
bufãr_h—d
 * 
nbh
;

462 
	`cÚd_»sched
();

468 ià(
·ss
 !ğ
PASS_SCAN
)

469 ià(
	`tid_geq
(
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %u‡t %lu/%lu\n",

473 
Ãxt_comm™_ID
, 
Ãxt_log_block
, 
jouº®
->
j_Ï¡
);

479 
	`jbd_debug
(3, "JBD3: checkšg block %ld\n", 
Ãxt_log_block
);

480 
”r
 = 
	`j»ad
(&
bh
, 
jouº®
, 
Ãxt_log_block
);

481 ià(
”r
)

482 
çed
;

484 
Ãxt_log_block
++;

485 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

493 
tmp
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

495 ià(
tmp
->
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

496 
	`b»l£
(
bh
);

500 
blockty³
 = 
	`be32_to_ıu
(
tmp
->
h_blockty³
);

501 
£qu’û
 = 
	`be32_to_ıu
(
tmp
->
h_£qu’û
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty³
, 
£qu’û
);

505 ià(
£qu’û
 !ğ
Ãxt_comm™_ID
) {

506 
	`b»l£
(
bh
);

514 
blockty³
) {

515 
JBD3_DESCRIPTOR_BLOCK
:

517 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

518 
desü_csum_size
 =

519 (
jbd3_jouº®_block_
);

520 ià(
desü_csum_size
 > 0 &&

521 !
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
,

522 
bh
->
b_d©a
)) {

523 
	`´štk
(
KERN_ERR
 "JBD3: Invalid checksum "

525 
Ãxt_log_block
);

526 
”r
 = -
EFSBADCRC
;

527 
	`b»l£
(
bh
);

528 
çed
;

535 ià(
·ss
 !ğ
PASS_REPLAY
) {

536 ià(
·ss
 =ğ
PASS_SCAN
 &&

537 
	`jbd3_has_ã©u»_checksum
(
jouº®
) &&

538 !
šfo
->
’d_Œª§ùiÚ
) {

539 ià(
	`ÿlc_chksums
(
jouº®
, 
bh
,

540 &
Ãxt_log_block
,

541 &
üc32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
Ãxt_log_block
 +ğ
	`couÁ_gs
(
jouº®
, 
bh
);

549 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

550 
	`put_bh
(
bh
);

558 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

559 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
)

560 <ğ
jouº®
->
j_blocksize
 - 
desü_csum_size
) {

561 
io_block
;

563 
g
 = (
jouº®_block_g_t
 *è
gp
;

564 
æags
 = 
	`be16_to_ıu
(
g
->
t_æags
);

566 
io_block
 = 
Ãxt_log_block
++;

567 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

568 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

569 ià(
”r
) {

572 
sucûss
 = 
”r
;

573 
	`´štk
(
KERN_ERR


576 
”r
, 
io_block
);

578 
blockÄ
;

580 
	`J_ASSERT
(
obh
 !ğ
NULL
);

581 
blockÄ
 = 
	`»ad_g_block
(
jouº®
,

582 
g
);

587 ià(
jbd3_jouº®_‹¡_»voke


588 (
jouº®
, 
blockÄ
,

589 
Ãxt_comm™_ID
)) {

590 
	`b»l£
(
obh
);

591 ++
šfo
->
Ä_»voke_h™s
;

592 
sk_wr™e
;

596 ià(!
	`jbd3_block_g_csum_v”ify
(

597 
jouº®
, 
g
, 
obh
->
b_d©a
,

598 
	`be32_to_ıu
(
tmp
->
h_£qu’û
))) {

599 
	`b»l£
(
obh
);

600 
sucûss
 = -
EFSBADCRC
;

601 
	`´štk
(
KERN_ERR
 "JBD3: Invalid "

604 "log\n", 
blockÄ
);

605 
block_”rÜ
 = 1;

606 
sk_wr™e
;

611 
nbh
 = 
	`__g‘blk
(
jouº®
->
j_fs_dev
,

612 
blockÄ
,

613 
jouº®
->
j_blocksize
);

614 ià(
nbh
 =ğ
NULL
) {

615 
	`´štk
(
KERN_ERR


618 
”r
 = -
ENOMEM
;

619 
	`b»l£
(
bh
);

620 
	`b»l£
(
obh
);

621 
çed
;

624 
	`lock_bufãr
(
nbh
);

625 
	`memıy
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jouº®
->
j_blocksize
);

627 ià(
æags
 & 
JBD3_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_bufãr_u±od©e
(
nbh
);

634 
	`m¬k_bufãr_dœty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
šfo
->
Ä_»¶ays
;

638 
	`uÆock_bufãr
(
nbh
);

639 
	`b»l£
(
obh
);

640 
	`b»l£
(
nbh
);

643 
sk_wr™e
:

644 
gp
 +ğ
g_by‹s
;

645 ià(!(
æags
 & 
JBD3_FLAG_SAME_UUID
))

646 
gp
 += 16;

648 ià(
æags
 & 
JBD3_FLAG_LAST_TAG
)

652 
	`b»l£
(
bh
);

655 
JBD3_COMMIT_BLOCK
:

691 ià(
·ss
 =ğ
PASS_SCAN
 &&

692 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

693 
chksum_”r
, 
chksum_£’
;

694 
comm™_h—d”
 *
cbh
 =

695 (
comm™_h—d”
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_ıu
(
cbh
->
h_chksum
[0]);

699 
chksum_”r
 = 
chksum_£’
 = 0;

701 ià(
šfo
->
’d_Œª§ùiÚ
) {

702 
jouº®
->
j_çed_comm™
 =

703 
šfo
->
’d_Œª§ùiÚ
;

704 
	`b»l£
(
bh
);

708 ià(
üc32_sum
 =ğ
found_chksum
 &&

709 
cbh
->
h_chksum_ty³
 =ğ
JBD3_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD3_CRC32_CHKSUM_SIZE
)

712 
chksum_£’
 = 1;

713 ià(!(
cbh
->
h_chksum_ty³
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£’
))

727 
chksum_”r
 = 1;

729 ià(
chksum_”r
) {

730 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

732 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

733 
jouº®
->
j_çed_comm™
 =

734 
Ãxt_comm™_ID
;

735 
	`b»l£
(
bh
);

739 
üc32_sum
 = ~0;

741 ià(
·ss
 =ğ
PASS_SCAN
 &&

742 !
	`jbd3_comm™_block_csum_v”ify
(
jouº®
,

743 
bh
->
b_d©a
)) {

744 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

746 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

747 
jouº®
->
j_çed_comm™
 =

748 
Ãxt_comm™_ID
;

749 
	`b»l£
(
bh
);

753 
	`b»l£
(
bh
);

754 
Ãxt_comm™_ID
++;

757 
JBD3_REVOKE_BLOCK
:

760 ià(
·ss
 !ğ
PASS_REVOKE
) {

761 
	`b»l£
(
bh
);

765 
”r
 = 
	`sÿn_»voke_»cÜds
(
jouº®
, 
bh
,

766 
Ãxt_comm™_ID
, 
šfo
);

767 
	`b»l£
(
bh
);

768 ià(
”r
)

769 
çed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,ƒnd of scan.\n",

774 
blockty³
);

775 
	`b»l£
(
bh
);

776 
dÚe
;

780 
dÚe
:

788 ià(
·ss
 =ğ
PASS_SCAN
) {

789 ià(!
šfo
->
’d_Œª§ùiÚ
)

790 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

794 ià(
šfo
->
’d_Œª§ùiÚ
 !ğ
Ãxt_comm™_ID
) {

795 
	`´štk
(
KERN_ERR
 "JBD3:„ecovery…ass %dƒnded‡t "

797 
·ss
, 
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
);

798 ià(!
sucûss
)

799 
sucûss
 = -
EIO
;

802 ià(
block_”rÜ
 && 
sucûss
 == 0)

803 
sucûss
 = -
EIO
;

804  
sucûss
;

806 
çed
:

807  
”r
;

808 
	}
}

812 
	$sÿn_»voke_»cÜds
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

813 
tid_t
 
£qu’û
, 
»cov”y_šfo
 *
šfo
)

815 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcouÁ
;

819 
»cÜd_Ën
 = 4;

821 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *è
bh
->
b_d©a
;

822 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

823 
rcouÁ
 = 
	`be32_to_ıu
(
h—d”
->
r_couÁ
);

825 ià(!
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
, 
h—d”
))

826  -
EFSBADCRC
;

828 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

829 
csum_size
 = (
jbd3_jouº®_block_
);

830 ià(
rcouÁ
 > 
jouº®
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcouÁ
;

834 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

835 
»cÜd_Ën
 = 8;

837 
off£t
 + 
»cÜd_Ën
 <ğ
max
) {

838 
blockÄ
;

839 
”r
;

841 ià(
»cÜd_Ën
 == 4)

842 
blockÄ
 = 
	`be32_to_ıu
(* ((
__be32
 *è(
bh
->
b_d©a
+
off£t
)));

844 
blockÄ
 = 
	`be64_to_ıu
(* ((
__be64
 *è(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +ğ
»cÜd_Ën
;

846 
”r
 = 
	`jbd3_jouº®_£t_»voke
(
jouº®
, 
blockÄ
, 
£qu’û
);

847 ià(
”r
)

848  
”r
;

849 ++
šfo
->
Ä_»vokes
;

852 
	}
}

	@revoke.c

80 #iâdeà
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<lšux/time.h
>

84 
	~<lšux/fs.h
>

85 
	~<lšux/jbd3.h
>

86 
	~<lšux/”ºo.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/li¡.h
>

89 
	~<lšux/š™.h
>

90 
	~<lšux/bio.h
>

91 
	~<lšux/log2.h
>

92 
	~<lšux/hash.h
>

95 
kmem_ÿche
 *
	gjbd3_»voke_»cÜd_ÿche
;

96 
kmem_ÿche
 *
	gjbd3_»voke_bË_ÿche
;

102 
	sjbd3_»voke_»cÜd_s


104 
li¡_h—d
 
	mhash
;

105 
tid_t
 
	m£qu’û
;

106 
	mblockÄ
;

111 
	sjbd3_»voke_bË_s


115 
	mhash_size
;

116 
	mhash_shiá
;

117 
li¡_h—d
 *
	mhash_bË
;

121 #ifdeà
__KERNEL__


122 
wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *,

123 
li¡_h—d
 *,

124 
bufãr_h—d
 **, *,

125 
jbd3_»voke_»cÜd_s
 *);

126 
æush_desütÜ
(
jouº®_t
 *, 
bufãr_h—d
 *, );

131 
šlše
 
	$hash
(
jouº®_t
 *
jouº®
, 
block
)

133  
	`hash_64
(
block
, 
jouº®
->
j_»voke
->
hash_shiá
);

134 
	}
}

136 
	$š£¹_»voke_hash
(
jouº®_t
 *
jouº®
, 
blockÄ
,

137 
tid_t
 
£q
)

139 
li¡_h—d
 *
hash_li¡
;

140 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

141 
gå_t
 
gå_mask
 = 
GFP_NOFS
;

143 ià(
jouº®_oom_»Œy
)

144 
gå_mask
 |ğ
__GFP_NOFAIL
;

145 
»cÜd
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_»cÜd_ÿche
, 
gå_mask
);

146 ià(!
»cÜd
)

147  -
ENOMEM
;

149 
»cÜd
->
£qu’û
 = 
£q
;

150 
»cÜd
->
blockÄ
 = blocknr;

151 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

152 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

153 
	`li¡_add
(&
»cÜd
->
hash
, 
hash_li¡
);

154 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

156 
	}
}

160 
jbd3_»voke_»cÜd_s
 *
	$fšd_»voke_»cÜd
(
jouº®_t
 *
jouº®
,

161 
blockÄ
)

163 
li¡_h—d
 *
hash_li¡
;

164 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

166 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

168 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

169 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è
hash_li¡
->
Ãxt
;

170 &(
»cÜd
->
hash
è!ğ
hash_li¡
) {

171 ià(
»cÜd
->
blockÄ
 == blocknr) {

172 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

173  
»cÜd
;

175 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è»cÜd->
hash
.
Ãxt
;

177 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
()

183 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_»cÜd_ÿche
);

184 
jbd3_»voke_»cÜd_ÿche
 = 
NULL
;

185 
	}
}

187 
	$jbd3_jouº®_de¡roy_»voke_bË_ÿche
()

189 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_bË_ÿche
);

190 
jbd3_»voke_bË_ÿche
 = 
NULL
;

191 
	}
}

193 
__š™
 
	$jbd3_jouº®_š™_»voke_»cÜd_ÿche
()

195 
	`J_ASSERT
(!
jbd3_»voke_»cÜd_ÿche
);

196 
jbd3_»voke_»cÜd_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_»cÜd_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 ià(!
jbd3_»voke_»cÜd_ÿche
) {

200 
	`´_em”g
("JBD3: failedo create„evoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__š™
 
	$jbd3_jouº®_š™_»voke_bË_ÿche
()

208 
	`J_ASSERT
(!
jbd3_»voke_bË_ÿche
);

209 
jbd3_»voke_bË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_bË_s
,

210 
SLAB_TEMPORARY
);

211 ià(!
jbd3_»voke_bË_ÿche
) {

212 
	`´_em”g
("JBD3: failedo create„evoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd3_»voke_bË_s
 *
	$jbd3_jouº®_š™_»voke_bË
(
hash_size
)

220 
shiá
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd3_»voke_bË_s
 *
bË
;

224 
bË
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_bË_ÿche
, 
GFP_KERNEL
);

225 ià(!
bË
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shiá
++;

231 
bË
->
hash_size
 = hash_size;

232 
bË
->
hash_shiá
 = 
shiá
;

233 
bË
->
hash_bË
 =

234 
	`km®loc_¬¿y
(
hash_size
, (
li¡_h—d
), 
GFP_KERNEL
);

235 ià(!
bË
->
hash_bË
) {

236 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

237 
bË
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;m°< 
hash_size
;mp++)

242 
	`INIT_LIST_HEAD
(&
bË
->
hash_bË
[
tmp
]);

244 
out
:

245  
bË
;

246 
	}
}

248 
	$jbd3_jouº®_de¡roy_»voke_bË
(
jbd3_»voke_bË_s
 *
bË
)

250 
i
;

251 
li¡_h—d
 *
hash_li¡
;

253 
i
 = 0; i < 
bË
->
hash_size
; i++) {

254 
hash_li¡
 = &
bË
->
hash_bË
[
i
];

255 
	`J_ASSERT
(
	`li¡_em±y
(
hash_li¡
));

258 
	`kä“
(
bË
->
hash_bË
);

259 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

260 
	}
}

263 
	$jbd3_jouº®_š™_»voke
(
jouº®_t
 *
jouº®
, 
hash_size
)

265 
	`J_ASSERT
(
jouº®
->
j_»voke_bË
[0] =ğ
NULL
);

266 
	`J_ASSERT
(
	`is_pow”_of_2
(
hash_size
));

268 
jouº®
->
j_»voke_bË
[0] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

269 ià(!
jouº®
->
j_»voke_bË
[0])

270 
ç0
;

272 
jouº®
->
j_»voke_bË
[1] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

273 ià(!
jouº®
->
j_»voke_bË
[1])

274 
ç1
;

276 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

278 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

282 
ç1
:

283 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

284 
jouº®
->
j_»voke_bË
[0] = 
NULL
;

285 
ç0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd3_jouº®_de¡roy_»voke
(
jouº®_t
 *
jouº®
)

292 
jouº®
->
j_»voke
 = 
NULL
;

293 ià(
jouº®
->
j_»voke_bË
[0])

294 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

295 ià(
jouº®
->
j_»voke_bË
[1])

296 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[1]);

297 
	}
}

300 #ifdeà
__KERNEL__


326 
	$jbd3_jouº®_»voke
(
hªdË_t
 *
hªdË
, 
blockÄ
,

327 
bufãr_h—d
 *
bh_š
)

329 
bufãr_h—d
 *
bh
 = 
NULL
;

330 
jouº®_t
 *
jouº®
;

331 
block_deviû
 *
bdev
;

332 
”r
;

334 
	`might_¦“p
();

335 ià(
bh_š
)

336 
	`BUFFER_TRACE
(
bh_š
, "enter");

338 
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

339 ià(!
	`jbd3_jouº®_£t_ã©u»s
(
jouº®
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot set„evoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jouº®
->
j_fs_dev
;

345 
bh
 = 
bh_š
;

347 ià(!
bh
) {

348 
bh
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

349 ià(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifdeà
JBD3_EXPENSIVE_CHECKING


354 
bufãr_h—d
 *
bh2
;

358 
bh2
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

359 ià(
bh2
) {

361 ià(
bh2
 !ğ
bh
 && 
	`bufãr_»vokev®id
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`bufãr_»voked
(bh2));

369 
	`put_bh
(
bh2
);

374 ià(
	`WARN_ON_ONCE
(
hªdË
->
h_»voke_üed™s
 <= 0)) {

375 ià(!
bh_š
)

376 
	`b»l£
(
bh
);

377  -
EIO
;

382 ià(
bh
) {

383 ià(!
	`J_EXPECT_BH
(
bh
, !
	`bufãr_»voked
(bh),

385 ià(!
bh_š
)

386 
	`b»l£
(
bh
);

387  -
EIO
;

389 
	`£t_bufãr_»voked
(
bh
);

390 
	`£t_bufãr_»vokev®id
(
bh
);

391 ià(
bh_š
) {

392 
	`BUFFER_TRACE
(
bh_š
, "call jbd3_journal_forget");

393 
	`jbd3_jouº®_fÜg‘
(
hªdË
, 
bh_š
);

395 
	`BUFFER_TRACE
(
bh
, "call brelse");

396 
	`__b»l£
(
bh
);

399 
hªdË
->
h_»voke_üed™s
--;

401 
	`jbd_debug
(2, "š£¹„evokfÜ block %Îu, bh_š=%p\n",
blockÄ
, 
bh_š
);

402 
”r
 = 
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
,

403 
hªdË
->
h_Œª§ùiÚ
->
t_tid
);

404 
	`BUFFER_TRACE
(
bh_š
, "exit");

405  
”r
;

406 
	}
}

423 
	$jbd3_jouº®_ÿnûl_»voke
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
)

425 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

426 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

427 
Ãed_ÿnûl
;

428 
did_»voke
 = 0;

429 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

431 
	`jbd_debug
(4, "jouº®_h—d %p, cªûÎšg„evoke\n", 
jh
);

437 ià(
	`‹¡_£t_bufãr_»vokev®id
(
bh
)) {

438 
Ãed_ÿnûl
 = 
	`‹¡_ş—r_bufãr_»voked
(
bh
);

440 
Ãed_ÿnûl
 = 1;

441 
	`ş—r_bufãr_»voked
(
bh
);

444 ià(
Ãed_ÿnûl
) {

445 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

446 ià(
»cÜd
) {

447 
	`jbd_debug
(4, "cancelledƒxisting„evoke on "

448 "blockÄ %Îu\n", ()
bh
->
b_blockÄ
);

449 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

450 
	`li¡_d–
(&
»cÜd
->
hash
);

451 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

452 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

453 
did_»voke
 = 1;

457 #ifdeà
JBD3_EXPENSIVE_CHECKING


459 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

460 
	`J_ASSERT_JH
(
jh
, 
»cÜd
 =ğ
NULL
);

467 ià(
Ãed_ÿnûl
) {

468 
bufãr_h—d
 *
bh2
;

469 
bh2
 = 
	`__fšd_g‘_block
(
bh
->
b_bdev
, bh->
b_blockÄ
, bh->
b_size
);

470 ià(
bh2
) {

471 ià(
bh2
 !ğ
bh
)

472 
	`ş—r_bufãr_»voked
(
bh2
);

473 
	`__b»l£
(
bh2
);

476  
did_»voke
;

477 
	}
}

484 
	$jbd3_ş—r_bufãr_»voked_æags
(
jouº®_t
 *
jouº®
)

486 
jbd3_»voke_bË_s
 *
»voke
 = 
jouº®
->
j_»voke
;

487 
i
 = 0;

489 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

490 
li¡_h—d
 *
hash_li¡
;

491 
li¡_h—d
 *
li¡_’Œy
;

492 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

494 
	`li¡_fÜ_—ch
(
li¡_’Œy
, 
hash_li¡
) {

495 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

496 
bufãr_h—d
 *
bh
;

497 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)
li¡_’Œy
;

498 
bh
 = 
	`__fšd_g‘_block
(
jouº®
->
j_fs_dev
,

499 
»cÜd
->
blockÄ
,

500 
jouº®
->
j_blocksize
);

501 ià(
bh
) {

502 
	`ş—r_bufãr_»voked
(
bh
);

503 
	`__b»l£
(
bh
);

507 
	}
}

513 
	$jbd3_jouº®_sw™ch_»voke_bË
(
jouº®_t
 *
jouº®
)

515 
i
;

517 ià(
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0])

518 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

520 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[0];

522 
i
 = 0; i < 
jouº®
->
j_»voke
->
hash_size
; i++)

523 
	`INIT_LIST_HEAD
(&
jouº®
->
j_»voke
->
hash_bË
[
i
]);

524 
	}
}

530 
	$jbd3_jouº®_wr™e_»voke_»cÜds
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

531 
li¡_h—d
 *
log_bufs
)

533 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

534 
bufãr_h—d
 *
desütÜ
;

535 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

536 
jbd3_»voke_bË_s
 *
»voke
;

537 
li¡_h—d
 *
hash_li¡
;

538 
i
, 
off£t
, 
couÁ
;

540 
desütÜ
 = 
NULL
;

541 
off£t
 = 0;

542 
couÁ
 = 0;

545 
»voke
 = 
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0] ?

546 
jouº®
->
j_»voke_bË
[1] : journal->j_revoke_table[0];

548 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

549 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

551 !
	`li¡_em±y
(
hash_li¡
)) {

552 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)

553 
hash_li¡
->
Ãxt
;

554 
	`wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ
, 
log_bufs
,

555 &
desütÜ
, &
off£t
, 
»cÜd
);

556 
couÁ
++;

557 
	`li¡_d–
(&
»cÜd
->
hash
);

558 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

561 ià(
desütÜ
)

562 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

563 
	`jbd_debug
(1, "WrÙ%d„evok»cÜds\n", 
couÁ
);

564 
	}
}

571 
	$wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

572 
li¡_h—d
 *
log_bufs
,

573 
bufãr_h—d
 **
desütÜp
,

574 *
off£
,

575 
jbd3_»voke_»cÜd_s
 *
»cÜd
)

577 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

578 
csum_size
 = 0;

579 
bufãr_h—d
 *
desütÜ
;

580 
sz
, 
off£t
;

586 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

589 
desütÜ
 = *
desütÜp
;

590 
off£t
 = *
off£
;

593 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

594 
csum_size
 = (
jbd3_jouº®_block_
);

596 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

597 
sz
 = 8;

599 
sz
 = 4;

602 ià(
desütÜ
) {

603 ià(
off£t
 + 
sz
 > 
jouº®
->
j_blocksize
 - 
csum_size
) {

604 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

605 
desütÜ
 = 
NULL
;

609 ià(!
desütÜ
) {

610 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ
,

611 
JBD3_REVOKE_BLOCK
);

612 ià(!
desütÜ
)

616 
	`BUFFER_TRACE
(
desütÜ
, "file in†og_bufs");

617 
	`jbd3_fe_log_bh
(
log_bufs
, 
desütÜ
);

619 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

620 *
desütÜp
 = 
desütÜ
;

623 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

624 * ((
__be64
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

625 
	`ıu_to_be64
(
»cÜd
->
blockÄ
);

627 * ((
__be32
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

628 
	`ıu_to_be32
(
»cÜd
->
blockÄ
);

629 
off£t
 +ğ
sz
;

631 *
off£
 = 
off£t
;

632 
	}
}

641 
	$æush_desütÜ
(
jouº®_t
 *
jouº®
,

642 
bufãr_h—d
 *
desütÜ
,

643 
off£t
)

645 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

647 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

650 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *)
desütÜ
->
b_d©a
;

651 
h—d”
->
r_couÁ
 = 
	`ıu_to_be32
(
off£t
);

652 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
, 
desütÜ
);

654 
	`£t_bufãr_jwr™e
(
desütÜ
);

655 
	`BUFFER_TRACE
(
desütÜ
, "write");

656 
	`£t_bufãr_dœty
(
desütÜ
);

657 
	`wr™e_dœty_bufãr
(
desütÜ
, 
REQ_SYNC
);

658 
	}
}

683 
	$jbd3_jouº®_£t_»voke
(
jouº®_t
 *
jouº®
,

684 
blockÄ
,

685 
tid_t
 
£qu’û
)

687 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

689 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

690 ià(
»cÜd
) {

693 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

694 
»cÜd
->
£qu’û
 = sequence;

697  
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
, 
£qu’û
);

698 
	}
}

707 
	$jbd3_jouº®_‹¡_»voke
(
jouº®_t
 *
jouº®
,

708 
blockÄ
,

709 
tid_t
 
£qu’û
)

711 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

713 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

714 ià(!
»cÜd
)

716 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

719 
	}
}

726 
	$jbd3_jouº®_ş—r_»voke
(
jouº®_t
 *
jouº®
)

728 
i
;

729 
li¡_h—d
 *
hash_li¡
;

730 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

731 
jbd3_»voke_bË_s
 *
»voke
;

733 
»voke
 = 
jouº®
->
j_»voke
;

735 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

736 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

737 !
	`li¡_em±y
(
hash_li¡
)) {

738 
»cÜd
 = (
jbd3_»voke_»cÜd_s
*è
hash_li¡
->
Ãxt
;

739 
	`li¡_d–
(&
»cÜd
->
hash
);

740 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

743 
	}
}

	@transaction.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/tim”.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/h¹im”.h
>

26 
	~<lšux/backšg-dev.h
>

27 
	~<lšux/bug.h
>

28 
	~<lšux/moduË.h
>

29 
	~<lšux/sched/mm.h
>

31 
	~<Œaû/ev’ts/jbd3.h
>

33 
__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
);

34 
__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
);

36 
kmem_ÿche
 *
	gŒª§ùiÚ_ÿche
;

37 
__š™
 
	$jbd3_jouº®_š™_Œª§ùiÚ_ÿche
()

39 
	`J_ASSERT
(!
Œª§ùiÚ_ÿche
);

40 
Œª§ùiÚ_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_transaction_s",

41 (
Œª§ùiÚ_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 ià(!
Œª§ùiÚ_ÿche
) {

46 
	`´_em”g
("JBD3: failedo createransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
()

54 
	`kmem_ÿche_de¡roy
(
Œª§ùiÚ_ÿche
);

55 
Œª§ùiÚ_ÿche
 = 
NULL
;

56 
	}
}

58 
	$jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

60 ià(
	`uÆik–y
(
	`ZERO_OR_NULL_PTR
(
Œª§ùiÚ
)))

62 
	`kmem_ÿche_ä“
(
Œª§ùiÚ_ÿche
, 
Œª§ùiÚ
);

63 
	}
}

68 
	$jbd3_desütÜ_blocks_³r_Œªs
(
jouº®_t
 *
jouº®
)

70 
g_¥aû
 = 
jouº®
->
j_blocksize
 - (
jouº®_h—d”_t
);

71 
gs_³r_block
;

74 
g_¥aû
 -= 16;

75 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

76 
g_¥aû
 -ğ(
jbd3_jouº®_block_
);

78 
gs_³r_block
 = (
g_¥aû
 - 16è/ 
	`jouº®_g_by‹s
(
jouº®
);

83  1 + 
	`DIV_ROUND_UP
(
jouº®
->
j_max_Œª§ùiÚ_bufãrs
,

84 
gs_³r_block
);

85 
	}
}

102 
	$jbd3_g‘_Œª§ùiÚ
(
jouº®_t
 *
jouº®
,

103 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

105 
Œª§ùiÚ
->
t_jouº®
 = 
jouº®
;

106 
Œª§ùiÚ
->
t_¡©e
 = 
T_RUNNING
;

107 
Œª§ùiÚ
->
t_¡¬t_time
 = 
	`ktime_g‘
();

108 
Œª§ùiÚ
->
t_tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
++;

109 
Œª§ùiÚ
->
t_expœes
 = 
jiff›s
 + 
jouº®
->
j_comm™_š‹rv®
;

110 
	`¥š_lock_š™
(&
Œª§ùiÚ
->
t_hªdË_lock
);

111 
	`©omic_£t
(&
Œª§ùiÚ
->
t_upd©es
, 0);

112 
	`©omic_£t
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
,

113 
	`jbd3_desütÜ_blocks_³r_Œªs
(
jouº®
) +

114 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
));

115 
	`©omic_£t
(&
Œª§ùiÚ
->
t_out¡ªdšg_»vokes
, 0);

116 
	`©omic_£t
(&
Œª§ùiÚ
->
t_hªdË_couÁ
, 0);

117 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_šode_li¡
);

118 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_´iv©e_li¡
);

121 
jouº®
->
j_comm™_tim”
.
expœes
 = 
	`round_jiff›s_up
(
Œª§ùiÚ
->
t_expœes
);

122 
	`add_tim”
(&
jouº®
->
j_comm™_tim”
);

124 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

125 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
Œª§ùiÚ
;

126 
Œª§ùiÚ
->
t_max_wa™
 = 0;

127 
Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

128 
Œª§ùiÚ
->
t_»que¡ed
 = 0;

129 
	}
}

149 
šlše
 
	$upd©e_t_max_wa™
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

150 
ts
)

152 #ifdeà
CONFIG_JBD3_DEBUG


153 ià(
jbd3_jouº®_’abË_debug
 &&

154 
	`time_aá”
(
Œª§ùiÚ
->
t_¡¬t
, 
ts
)) {

155 
ts
 = 
	`jbd3_time_diff
Ñs, 
Œª§ùiÚ
->
t_¡¬t
);

156 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

157 ià(
ts
 > 
Œª§ùiÚ
->
t_max_wa™
)

158 
Œª§ùiÚ
->
t_max_wa™
 = 
ts
;

159 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

162 
	}
}

169 
	$wa™_Œª§ùiÚ_locked
(
jouº®_t
 *
jouº®
)

170 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

172 
	`DEFINE_WAIT
(
wa™
);

173 
Ãed_to_¡¬t
;

174 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

176 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

177 
TASK_UNINTERRUPTIBLE
);

178 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

179 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

180 ià(
Ãed_to_¡¬t
)

181 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

182 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

183 
	`scheduË
();

184 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

185 
	}
}

192 
	$wa™_Œª§ùiÚ_sw™chšg
(
jouº®_t
 *
jouº®
)

193 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

195 
	`DEFINE_WAIT
(
wa™
);

197 ià(
	`WARN_ON
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ||

198 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_¡©e
 !ğ
T_SWITCH
))

200 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

201 
TASK_UNINTERRUPTIBLE
);

202 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

209 
	`scheduË
();

210 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

211 
	}
}

213 
	$sub_»£rved_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
)

215 
	`©omic_sub
(
blocks
, &
jouº®
->
j_»£rved_üed™s
);

216 
	`wake_up
(&
jouº®
->
j_wa™_»£rved
);

217 
	}
}

225 
	$add_Œª§ùiÚ_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
,

226 
rsv_blocks
)

228 
Œª§ùiÚ_t
 *
t
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

229 
Ãeded
;

230 
tÙ®
 = 
blocks
 + 
rsv_blocks
;

236 ià(
t
->
t_¡©e
 !ğ
T_RUNNING
) {

237 
	`WARN_ON_ONCE
(
t
->
t_¡©e
 >ğ
T_FLUSH
);

238 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

247 
Ãeded
 = 
	`©omic_add_»tuº
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

248 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

254 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

260 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 >

261 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

262 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

263 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

264 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

265 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 <=

266 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

270 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

285 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
è< jouº®->
j_max_Œª§ùiÚ_bufãrs
) {

286 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

287 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

288 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

289 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

290 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
) <

291 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
)

292 
	`__jbd3_log_wa™_fÜ_¥aû
(
jouº®
);

293 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

298 ià(!
rsv_blocks
)

301 
Ãeded
 = 
	`©omic_add_»tuº
(
rsv_blocks
, &
jouº®
->
j_»£rved_üed™s
);

303 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) {

304 
	`sub_»£rved_üed™s
(
jouº®
, 
rsv_blocks
);

305 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

306 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

307 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

308 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

309 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
rsv_blocks


310 <ğ
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2);

314 
	}
}

323 
	$¡¬t_this_hªdË
(
jouº®_t
 *
jouº®
, 
hªdË_t
 *
hªdË
,

324 
gå_t
 
gå_mask
)

326 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ãw_Œª§ùiÚ
 = 
NULL
;

327 
blocks
 = 
hªdË
->
h_tÙ®_üed™s
;

328 
rsv_blocks
 = 0;

329 
ts
 = 
jiff›s
;

331 ià(
hªdË
->
h_rsv_hªdË
)

332 
rsv_blocks
 = 
hªdË
->
h_rsv_hªdË
->
h_tÙ®_üed™s
;

339 ià((
rsv_blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) ||

340 (
rsv_blocks
 + 
blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
)) {

341 
	`´štk
(
KERN_ERR
 "JBD3: %s wantsoo many credits "

343 
cu¼’t
->
comm
, 
blocks
, 
rsv_blocks
,

344 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

345 
	`WARN_ON
(1);

346  -
ENOSPC
;

349 
®loc_Œª§ùiÚ
:

350 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

355 ià((
gå_mask
 & 
__GFP_FS
) == 0)

356 
gå_mask
 |ğ
__GFP_NOFAIL
;

357 
Ãw_Œª§ùiÚ
 = 
	`kmem_ÿche_z®loc
(
Œª§ùiÚ_ÿche
,

358 
gå_mask
);

359 ià(!
Ãw_Œª§ùiÚ
)

360  -
ENOMEM
;

363 
	`jbd_debug
(3, "New hªdË %°gošg†ive.\n", 
hªdË
);

369 
»³©
:

370 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

371 
	`BUG_ON
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
);

372 ià(
	`is_jouº®_abÜ‹d
(
jouº®
) ||

373 (
jouº®
->
j_”ºo
 !ğ0 && !(jouº®->
j_æags
 & 
JBD3_ACK_ERR
))) {

374 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

375 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

376  -
EROFS
;

384 ià(!
hªdË
->
h_»£rved
 && 
jouº®
->
j_b¬r›r_couÁ
) {

385 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

386 
	`wa™_ev’t
(
jouº®
->
j_wa™_Œª§ùiÚ_locked
,

387 
jouº®
->
j_b¬r›r_couÁ
 == 0);

388 
»³©
;

391 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

392 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

393 ià(!
Ãw_Œª§ùiÚ
)

394 
®loc_Œª§ùiÚ
;

395 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

396 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

397 (
hªdË
->
h_»£rved
 || !
jouº®
->
j_b¬r›r_couÁ
)) {

398 
	`jbd3_g‘_Œª§ùiÚ
(
jouº®
, 
Ãw_Œª§ùiÚ
);

399 
Ãw_Œª§ùiÚ
 = 
NULL
;

401 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

402 
»³©
;

405 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

407 ià(!
hªdË
->
h_»£rved
) {

409 ià(
	`add_Œª§ùiÚ_üed™s
(
jouº®
, 
blocks
, 
rsv_blocks
))

410 
»³©
;

419 ià(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_SWITCH
) {

420 
	`wa™_Œª§ùiÚ_sw™chšg
(
jouº®
);

421 
»³©
;

423 
	`sub_»£rved_üed™s
(
jouº®
, 
blocks
);

424 
hªdË
->
h_»£rved
 = 0;

430 
	`upd©e_t_max_wa™
(
Œª§ùiÚ
, 
ts
);

431 
hªdË
->
h_Œª§ùiÚ
 = 
Œª§ùiÚ
;

432 
hªdË
->
h_»que¡ed_üed™s
 = 
blocks
;

433 
hªdË
->
h_»voke_üed™s_»que¡ed
 = hªdË->
h_»voke_üed™s
;

434 
hªdË
->
h_¡¬t_jiff›s
 = 
jiff›s
;

435 
	`©omic_šc
(&
Œª§ùiÚ
->
t_upd©es
);

436 
	`©omic_šc
(&
Œª§ùiÚ
->
t_hªdË_couÁ
);

437 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

438 
hªdË
, 
blocks
,

439 
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
),

440 
	`jbd3_log_¥aû_Ëá
(
jouº®
));

441 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

442 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

444 
	`rw£m_acquœe_»ad
(&
jouº®
->
j_Œªs_comm™_m­
, 0, 0, 
_THIS_IP_
);

445 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

450 
hªdË
->
§ved_®loc_cÚ‹xt
 = 
	`mem®loc_nofs_§ve
();

452 
	}
}

455 
hªdË_t
 *
	$Ãw_hªdË
(
nblocks
)

457 
hªdË_t
 *
hªdË
 = 
	`jbd3_®loc_hªdË
(
GFP_NOFS
);

458 ià(!
hªdË
)

459  
NULL
;

460 
hªdË
->
h_tÙ®_üed™s
 = 
nblocks
;

461 
hªdË
->
h_»f
 = 1;

463  
hªdË
;

464 
	}
}

466 
hªdË_t
 *
	$jbd3__jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
, 
rsv_blocks
,

467 
»voke_»cÜds
, 
gå_t
 
gå_mask
,

468 
ty³
, 
lše_no
)

470 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

471 
”r
;

473 ià(!
jouº®
)

474  
	`ERR_PTR
(-
EROFS
);

476 ià(
hªdË
) {

477 
	`J_ASSERT
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
 =ğ
jouº®
);

478 
hªdË
->
h_»f
++;

479  
hªdË
;

482 
nblocks
 +ğ
	`DIV_ROUND_UP
(
»voke_»cÜds
,

483 
jouº®
->
j_»voke_»cÜds_³r_block
);

484 
hªdË
 = 
	`Ãw_hªdË
(
nblocks
);

485 ià(!
hªdË
)

486  
	`ERR_PTR
(-
ENOMEM
);

487 ià(
rsv_blocks
) {

488 
hªdË_t
 *
rsv_hªdË
;

490 
rsv_hªdË
 = 
	`Ãw_hªdË
(
rsv_blocks
);

491 ià(!
rsv_hªdË
) {

492 
	`jbd3_ä“_hªdË
(
hªdË
);

493  
	`ERR_PTR
(-
ENOMEM
);

495 
rsv_hªdË
->
h_»£rved
 = 1;

496 
rsv_hªdË
->
h_jouº®
 = 
jouº®
;

497 
hªdË
->
h_rsv_hªdË
 = 
rsv_hªdË
;

499 
hªdË
->
h_»voke_üed™s
 = 
»voke_»cÜds
;

501 
”r
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

502 ià(
”r
 < 0) {

503 ià(
hªdË
->
h_rsv_hªdË
)

504 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

505 
	`jbd3_ä“_hªdË
(
hªdË
);

506  
	`ERR_PTR
(
”r
);

508 
hªdË
->
h_ty³
 = 
ty³
;

509 
hªdË
->
h_lše_no
 = 
lše_no
;

510 
	`Œaû_jbd3_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

511 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

512 
lše_no
, 
nblocks
);

514  
hªdË
;

515 
	}
}

516 
EXPORT_SYMBOL
(
jbd3__jouº®_¡¬t
);

538 
hªdË_t
 *
	$jbd3_jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
)

540  
	`jbd3__jouº®_¡¬t
(
jouº®
, 
nblocks
, 0, 0, 
GFP_NOFS
, 0, 0);

541 
	}
}

542 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t
);

544 
	$__jbd3_jouº®_uÄe£rve_hªdË
(
hªdË_t
 *
hªdË
)

546 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

548 
	`WARN_ON
(!
hªdË
->
h_»£rved
);

549 
	`sub_»£rved_üed™s
(
jouº®
, 
hªdË
->
h_tÙ®_üed™s
);

550 
	}
}

552 
	$jbd3_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

554 
	`__jbd3_jouº®_uÄe£rve_hªdË
(
hªdË
);

555 
	`jbd3_ä“_hªdË
(
hªdË
);

556 
	}
}

557 
EXPORT_SYMBOL
(
jbd3_jouº®_ä“_»£rved
);

573 
	$jbd3_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
ty³
,

574 
lše_no
)

576 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

577 
»t
 = -
EIO
;

579 ià(
	`WARN_ON
(!
hªdË
->
h_»£rved
)) {

581 
	`jbd3_jouº®_¡İ
(
hªdË
);

582  
»t
;

588 ià(
	`WARN_ON
(
cu¼’t
->
jouº®_šfo
)) {

589 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

590  
»t
;

593 
hªdË
->
h_jouº®
 = 
NULL
;

598 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
GFP_NOFS
);

599 ià(
»t
 < 0) {

600 
hªdË
->
h_jouº®
 = 
jouº®
;

601 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

602  
»t
;

604 
hªdË
->
h_ty³
 = 
ty³
;

605 
hªdË
->
h_lše_no
 = 
lše_no
;

606 
	`Œaû_jbd3_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

607 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

608 
lše_no
, 
hªdË
->
h_tÙ®_üed™s
);

610 
	}
}

611 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_»£rved
);

634 
	$jbd3_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
, 
»voke_»cÜds
)

636 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

637 
jouº®_t
 *
jouº®
;

638 
»suÉ
;

639 
wª‹d
;

641 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

642  -
EROFS
;

643 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

645 
»suÉ
 = 1;

647 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

650 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_RUNNING
) {

651 
	`jbd_debug
(3, "denied handle %p %d blocks: "

652 "Œª§ùiÚ‚Ù„uÂšg\n", 
hªdË
, 
nblocks
);

653 
”rÜ_out
;

656 
nblocks
 +ğ
	`DIV_ROUND_UP
(

657 
hªdË
->
h_»voke_üed™s_»que¡ed
 + 
»voke_»cÜds
,

658 
jouº®
->
j_»voke_»cÜds_³r_block
) -

659 
	`DIV_ROUND_UP
(

660 
hªdË
->
h_»voke_üed™s_»que¡ed
,

661 
jouº®
->
j_»voke_»cÜds_³r_block
);

662 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

663 
wª‹d
 = 
	`©omic_add_»tuº
(
nblocks
,

664 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

666 ià(
wª‹d
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

667 
	`jbd_debug
(3, "denied handle %p %d blocks: "

668 "Œª§ùiÚoØÏrge\n", 
hªdË
, 
nblocks
);

669 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

670 
uÆock
;

673 
	`Œaû_jbd3_hªdË_ex‹nd
(
jouº®
->
j_fs_dev
->
bd_dev
,

674 
Œª§ùiÚ
->
t_tid
,

675 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

676 
hªdË
->
h_tÙ®_üed™s
,

677 
nblocks
);

679 
hªdË
->
h_tÙ®_üed™s
 +ğ
nblocks
;

680 
hªdË
->
h_»que¡ed_üed™s
 +ğ
nblocks
;

681 
hªdË
->
h_»voke_üed™s
 +ğ
»voke_»cÜds
;

682 
hªdË
->
h_»voke_üed™s_»que¡ed
 +ğ
»voke_»cÜds
;

683 
»suÉ
 = 0;

685 
	`jbd_debug
(3, "ex‹nded hªdË %°by %d\n", 
hªdË
, 
nblocks
);

686 
uÆock
:

687 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

688 
”rÜ_out
:

689 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

690  
»suÉ
;

691 
	}
}

693 
	$¡İ_this_hªdË
(
hªdË_t
 *
hªdË
)

695 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

696 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

697 
»vokes
;

699 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

700 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

701 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

708 
»vokes
 = 
hªdË
->
h_»voke_üed™s_»que¡ed
 - hªdË->
h_»voke_üed™s
;

709 ià(
»vokes
) {

710 
t_»vokes
, 
»voke_desütÜs
;

711 
¼_³r_blk
 = 
jouº®
->
j_»voke_»cÜds_³r_block
;

713 
	`WARN_ON_ONCE
(
	`DIV_ROUND_UP
(
»vokes
, 
¼_³r_blk
)

714 > 
hªdË
->
h_tÙ®_üed™s
);

715 
t_»vokes
 = 
	`©omic_add_»tuº
(
»vokes
,

716 &
Œª§ùiÚ
->
t_out¡ªdšg_»vokes
);

717 
»voke_desütÜs
 =

718 
	`DIV_ROUND_UP
(
t_»vokes
, 
¼_³r_blk
) -

719 
	`DIV_ROUND_UP
(
t_»vokes
 - 
»vokes
, 
¼_³r_blk
);

720 
hªdË
->
h_tÙ®_üed™s
 -ğ
»voke_desütÜs
;

722 
	`©omic_sub
(
hªdË
->
h_tÙ®_üed™s
,

723 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

724 ià(
hªdË
->
h_rsv_hªdË
)

725 
	`__jbd3_jouº®_uÄe£rve_hªdË
(
hªdË
->
h_rsv_hªdË
);

726 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
))

727 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

729 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 
_THIS_IP_
);

734 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

735 
	}
}

754 
	$jbd3__jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
, 
»voke_»cÜds
,

755 
gå_t
 
gå_mask
)

757 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

758 
jouº®_t
 *
jouº®
;

759 
tid_t
 
tid
;

760 
Ãed_to_¡¬t
;

761 
»t
;

765 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

767 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

768 
tid
 = 
Œª§ùiÚ
->
t_tid
;

774 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

775 
	`¡İ_this_hªdË
(
hªdË
);

776 
hªdË
->
h_Œª§ùiÚ
 = 
NULL
;

782 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

783 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

784 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

785 ià(
Ãed_to_¡¬t
)

786 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

787 
hªdË
->
h_tÙ®_üed™s
 = 
nblocks
 +

788 
	`DIV_ROUND_UP
(
»voke_»cÜds
,

789 
jouº®
->
j_»voke_»cÜds_³r_block
);

790 
hªdË
->
h_»voke_üed™s
 = 
»voke_»cÜds
;

791 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

792 
	`Œaû_jbd3_hªdË_»¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

793 
»t
 ? 0 : 
hªdË
->
h_Œª§ùiÚ
->
t_tid
,

794 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

795 
hªdË
->
h_tÙ®_üed™s
);

796  
»t
;

797 
	}
}

798 
EXPORT_SYMBOL
(
jbd3__jouº®_»¡¬t
);

801 
	$jbd3_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

803  
	`jbd3__jouº®_»¡¬t
(
hªdË
, 
nblocks
, 0, 
GFP_NOFS
);

804 
	}
}

805 
EXPORT_SYMBOL
(
jbd3_jouº®_»¡¬t
);

817 
	$jbd3_jouº®_lock_upd©es
(
jouº®_t
 *
jouº®
)

819 
	`DEFINE_WAIT
(
wa™
);

821 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

823 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

824 ++
jouº®
->
j_b¬r›r_couÁ
;

827 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
)) {

828 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

829 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

830 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
) == 0);

831 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

836 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

838 ià(!
Œª§ùiÚ
)

841 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

842 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

843 
TASK_UNINTERRUPTIBLE
);

844 ià(!
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
)) {

845 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

846 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

849 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

850 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

851 
	`scheduË
();

852 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

853 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

855 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

863 
	`mu‹x_lock
(&
jouº®
->
j_b¬r›r
);

864 
	}
}

874 
	$jbd3_jouº®_uÆock_upd©es
 (
jouº®_t
 *
jouº®
)

876 
	`J_ASSERT
(
jouº®
->
j_b¬r›r_couÁ
 != 0);

878 
	`mu‹x_uÆock
(&
jouº®
->
j_b¬r›r
);

879 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

880 --
jouº®
->
j_b¬r›r_couÁ
;

881 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

882 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

883 
	}
}

885 
	$w¬n_dœty_bufãr
(
bufãr_h—d
 *
bh
)

887 
	`´štk
(
KERN_WARNING


891 
bh
->
b_bdev
, ()bh->
b_blockÄ
);

892 
	}
}

895 
	$jbd3_ä“ze_jh_d©a
(
jouº®_h—d
 *
jh
)

897 
·ge
 *page;

898 
off£t
;

899 *
sourû
;

900 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

902 
	`J_EXPECT_JH
(
jh
, 
	`bufãr_u±od©e
(
bh
), "Possible IO failure.\n");

903 
·ge
 = 
bh
->
b_·ge
;

904 
off£t
 = 
	`off£t_š_·ge
(
bh
->
b_d©a
);

905 
sourû
 = 
	`km­_©omic
(
·ge
);

907 
	`jbd3_bufãr_äoz’_Œigg”
(
jh
, 
sourû
 + 
off£t
, jh->
b_Œigg”s
);

908 
	`memıy
(
jh
->
b_äoz’_d©a
, 
sourû
 + 
off£t
, 
bh
->
b_size
);

909 
	`kunm­_©omic
(
sourû
);

915 
jh
->
b_äoz’_Œigg”s
 = jh->
b_Œigg”s
;

916 
	}
}

929 
	$do_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
,

930 
fÜû_cİy
)

932 
bufãr_h—d
 *
bh
;

933 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

934 
jouº®_t
 *
jouº®
;

935 
”rÜ
;

936 *
äoz’_bufãr
 = 
NULL
;

937 
¡¬t_lock
, 
time_lock
;

939 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

941 
	`jbd_debug
(5, "jouº®_h—d %p, fÜû_cİy %d\n", 
jh
, 
fÜû_cİy
);

943 
	`JBUFFER_TRACE
(
jh
, "entry");

944 
»³©
:

945 
bh
 = 
	`jh2bh
(
jh
);

949 
¡¬t_lock
 = 
jiff›s
;

950 
	`lock_bufãr
(
bh
);

951 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

954 
time_lock
 = 
	`jbd3_time_diff
(
¡¬t_lock
, 
jiff›s
);

955 ià(
time_lock
 > 
HZ
/10)

956 
	`Œaû_jbd3_lock_bufãr_¡®l
(
bh
->
b_bdev
->
bd_dev
,

957 
	`jiff›s_to_m£cs
(
time_lock
));

972 ià(
	`bufãr_dœty
(
bh
)) {

977 ià(
jh
->
b_Œª§ùiÚ
) {

978 
	`J_ASSERT_JH
(
jh
,

979 
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

980 
jh
->
b_Œª§ùiÚ
 ==

981 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

982 ià(
jh
->
b_Ãxt_Œª§ùiÚ
)

983 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 ==

984 
Œª§ùiÚ
);

985 
	`w¬n_dœty_bufãr
(
bh
);

992 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

993 
	`ş—r_bufãr_dœty
(
bh
);

994 
	`£t_bufãr_jbddœty
(
bh
);

997 
	`uÆock_bufãr
(
bh
);

999 
”rÜ
 = -
EROFS
;

1000 ià(
	`is_hªdË_abÜ‹d
(
hªdË
)) {

1001 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1002 
out
;

1004 
”rÜ
 = 0;

1010 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1011 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

1012 
dÚe
;

1018 
jh
->
b_modif›d
 = 0;

1025 ià(!
jh
->
b_Œª§ùiÚ
) {

1026 
	`JBUFFER_TRACE
(
jh
, "noransaction");

1027 
	`J_ASSERT_JH
(
jh
, !jh->
b_Ãxt_Œª§ùiÚ
);

1028 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

1034 
	`smp_wmb
();

1035 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1036 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

1037 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1038 
dÚe
;

1044 ià(
jh
->
b_äoz’_d©a
) {

1045 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

1046 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1047 
©ch_Ãxt
;

1050 
	`JBUFFER_TRACE
(
jh
, "owned by olderransaction");

1051 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1052 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

1063 ià(
	`bufãr_shadow
(
bh
)) {

1064 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

1065 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1066 
	`wa™_Ú_b™_io
(&
bh
->
b_¡©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

1067 
»³©
;

1082 ià(
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
 || 
fÜû_cİy
) {

1083 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1084 ià(!
äoz’_bufãr
) {

1085 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1086 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1087 
äoz’_bufãr
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1088 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1089 
»³©
;

1091 
jh
->
b_äoz’_d©a
 = 
äoz’_bufãr
;

1092 
äoz’_bufãr
 = 
NULL
;

1093 
	`jbd3_ä“ze_jh_d©a
(
jh
);

1095 
©ch_Ãxt
:

1101 
	`smp_wmb
();

1102 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1104 
dÚe
:

1105 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1111 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1113 
out
:

1114 ià(
	`uÆik–y
(
äoz’_bufãr
))

1115 
	`jbd3_ä“
(
äoz’_bufãr
, 
bh
->
b_size
);

1117 
	`JBUFFER_TRACE
(
jh
, "exit");

1118  
”rÜ
;

1119 
	}
}

1122 
boŞ
 
	$jbd3_wr™e_acûss_g¿Áed
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
,

1123 
boŞ
 
undo
)

1125 
jouº®_h—d
 *
jh
;

1126 
boŞ
 
»t
 = 
çl£
;

1129 ià(
	`bufãr_dœty
(
bh
))

1130  
çl£
;

1143 
	`rcu_»ad_lock
();

1144 ià(!
	`bufãr_jbd
(
bh
))

1145 
out
;

1147 
jh
 = 
	`READ_ONCE
(
bh
->
b_´iv©e
);

1148 ià(!
jh
)

1149 
out
;

1151 ià(
undo
 && !
jh
->
b_comm™‹d_d©a
)

1152 
out
;

1153 ià(
jh
->
b_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
 &&

1154 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
)

1155 
out
;

1165 
	`smp_mb
();

1166 ià(
	`uÆik–y
(
jh
->
b_bh
 !ğ
bh
))

1167 
out
;

1168 
»t
 = 
Œue
;

1169 
out
:

1170 
	`rcu_»ad_uÆock
();

1171  
»t
;

1172 
	}
}

1185 
	$jbd3_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1187 
jouº®_h—d
 *
jh
;

1188 
rc
;

1190 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1191  -
EROFS
;

1193 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
çl£
))

1196 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1200 
rc
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 0);

1201 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1202  
rc
;

1203 
	}
}

1225 
	$jbd3_jouº®_g‘_ü—‹_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1227 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1228 
jouº®_t
 *
jouº®
;

1229 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1230 
”r
;

1232 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1233 
”r
 = -
EROFS
;

1234 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1235 
out
;

1236 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1237 
”r
 = 0;

1239 
	`JBUFFER_TRACE
(
jh
, "entry");

1247 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1248 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1249 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 ||

1250 (
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

1251 
jh
->
b_jli¡
 =ğ
BJ_FÜg‘
)));

1253 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1254 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_locked
(
	`jh2bh
(jh)));

1256 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
) {

1265 
	`ş—r_bufãr_dœty
(
	`jh2bh
(
jh
));

1267 
jh
->
b_modif›d
 = 0;

1269 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

1270 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1271 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

1272 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1273 } ià(
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

1275 
jh
->
b_modif›d
 = 0;

1277 
	`JBUFFER_TRACE
(
jh
, "set‚extransaction");

1278 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1279 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1280 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1282 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1291 
	`JBUFFER_TRACE
(
jh
, "cancelling„evoke");

1292 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1293 
out
:

1294 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1295  
”r
;

1296 
	}
}

1324 
	$jbd3_jouº®_g‘_undo_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1326 
”r
;

1327 
jouº®_h—d
 *
jh
;

1328 *
comm™‹d_d©a
 = 
NULL
;

1330 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1331  -
EROFS
;

1333 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
Œue
))

1336 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1337 
	`JBUFFER_TRACE
(
jh
, "entry");

1344 
”r
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 1);

1345 ià(
”r
)

1346 
out
;

1348 
»³©
:

1349 ià(!
jh
->
b_comm™‹d_d©a
)

1350 
comm™‹d_d©a
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1351 
GFP_NOFS
|
__GFP_NOFAIL
);

1353 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1354 ià(!
jh
->
b_comm™‹d_d©a
) {

1357 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1358 ià(!
comm™‹d_d©a
) {

1359 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1360 
»³©
;

1363 
jh
->
b_comm™‹d_d©a
 = 
comm™‹d_d©a
;

1364 
comm™‹d_d©a
 = 
NULL
;

1365 
	`memıy
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1367 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1368 
out
:

1369 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1370 ià(
	`uÆik–y
(
comm™‹d_d©a
))

1371 
	`jbd3_ä“
(
comm™‹d_d©a
, 
bh
->
b_size
);

1372  
”r
;

1373 
	}
}

1386 
	$jbd3_jouº®_£t_Œigg”s
(
bufãr_h—d
 *
bh
,

1387 
jbd3_bufãr_Œigg”_ty³
 *
ty³
)

1389 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

1391 ià(
	`WARN_ON
(!
jh
))

1393 
jh
->
b_Œigg”s
 = 
ty³
;

1394 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1395 
	}
}

1397 
	$jbd3_bufãr_äoz’_Œigg”
(
jouº®_h—d
 *
jh
, *
m­³d_d©a
,

1398 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1400 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1402 ià(!
Œigg”s
 || !Œigg”s->
t_äoz’
)

1405 
Œigg”s
->
	`t_äoz’
Ñrigg”s, 
bh
, 
m­³d_d©a
, bh->
b_size
);

1406 
	}
}

1408 
	$jbd3_bufãr_abÜt_Œigg”
(
jouº®_h—d
 *
jh
,

1409 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1411 ià(!
Œigg”s
 || !Œigg”s->
t_abÜt
)

1414 
Œigg”s
->
	`t_abÜt
Ñrigg”s, 
	`jh2bh
(
jh
));

1415 
	}
}

1440 
	$jbd3_jouº®_dœty_m‘ad©a
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1442 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1443 
jouº®_t
 *
jouº®
;

1444 
jouº®_h—d
 *
jh
;

1445 
»t
 = 0;

1447 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1448  -
EROFS
;

1449 ià(!
	`bufãr_jbd
(
bh
))

1450  -
EUCLEAN
;

1456 
jh
 = 
	`bh2jh
(
bh
);

1457 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1458 
	`JBUFFER_TRACE
(
jh
, "entry");

1466 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 &&

1467 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1468 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1469 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1470 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1471 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1473 ià(
jh
->
b_modif›d
 == 1) {

1475 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1476 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
) {

1477 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1478 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1479 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
)

1480 
	`´_”r
("JBD3:‡ssertion failure: h_type=%u "

1482 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1483 (è
bh
->
b_blockÄ
,

1484 
jh
->
b_jli¡
);

1485 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 ||

1486 
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
);

1487 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1489 
out
;

1492 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1493 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1495 ià(
jh
->
b_modif›d
 == 0) {

1501 ià(
	`WARN_ON_ONCE
(
	`jbd3_hªdË_bufãr_üed™s
(
hªdË
) <= 0)) {

1502 
»t
 = -
ENOSPC
;

1503 
out_uÆock_bh
;

1505 
jh
->
b_modif›d
 = 1;

1506 
hªdË
->
h_tÙ®_üed™s
--;

1516 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
BJ_M‘ad©a
) {

1517 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1518 ià(
	`uÆik–y
(
jh
->
b_Œª§ùiÚ
 !=

1519 
jouº®
->
j_ruÂšg_Œª§ùiÚ
)) {

1520 
	`´štk
(
KERN_ERR
 "JBD3: %s: "

1523 
jouº®
->
j_devÇme
,

1524 (è
bh
->
b_blockÄ
,

1525 
jh
->
b_Œª§ùiÚ
,

1526 
jh
->
b_Œª§ùiÚ
 ? jh->b_Œª§ùiÚ->
t_tid
 : 0,

1527 
jouº®
->
j_ruÂšg_Œª§ùiÚ
,

1528 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

1529 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

1530 
»t
 = -
EINVAL
;

1532 
out_uÆock_bh
;

1535 
	`£t_bufãr_jbddœty
(
bh
);

1543 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1544 
	`JBUFFER_TRACE
(
jh
, "already on otherransaction");

1545 ià(
	`uÆik–y
(((
jh
->
b_Œª§ùiÚ
 !=

1546 
jouº®
->
j_comm™tšg_Œª§ùiÚ
)) ||

1547 (
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
))) {

1548 
	`´štk
(
KERN_ERR
 "jbd3_journal_dirty_metadata: %s: "

1553 
jouº®
->
j_devÇme
,

1554 (è
bh
->
b_blockÄ
,

1555 
Œª§ùiÚ
,¿n§ùiÚ->
t_tid
,

1556 
jh
->
b_Œª§ùiÚ
,

1557 
jh
->
b_Œª§ùiÚ
 ?

1558 
jh
->
b_Œª§ùiÚ
->
t_tid
 : 0,

1559 
jh
->
b_Ãxt_Œª§ùiÚ
,

1560 
jh
->
b_Ãxt_Œª§ùiÚ
 ?

1561 
jh
->
b_Ãxt_Œª§ùiÚ
->
t_tid
 : 0,

1562 
jh
->
b_jli¡
);

1563 
	`WARN_ON
(1);

1564 
»t
 = -
EINVAL
;

1568 
out_uÆock_bh
;

1572 
	`J_ASSERT_JH
(
jh
, jh->
b_äoz’_d©a
 =ğ
NULL
);

1574 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Metadata");

1575 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1576 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_M‘ad©a
);

1577 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1578 
out_uÆock_bh
:

1579 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1580 
out
:

1581 
	`JBUFFER_TRACE
(
jh
, "exit");

1582  
»t
;

1583 
	}
}

1602 
	$jbd3_jouº®_fÜg‘
 (
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1604 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1605 
jouº®_t
 *
jouº®
;

1606 
jouº®_h—d
 *
jh
;

1607 
drİ_»£rve
 = 0;

1608 
”r
 = 0;

1609 
was_modif›d
 = 0;

1611 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1612  -
EROFS
;

1613 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1615 
	`BUFFER_TRACE
(
bh
, "entry");

1617 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

1618 ià(!
jh
) {

1619 
	`__bfÜg‘
(
bh
);

1623 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

1627 ià(!
	`J_EXPECT_JH
(
jh
, !jh->
b_comm™‹d_d©a
,

1629 
”r
 = -
EIO
;

1630 
drİ
;

1634 
was_modif›d
 = 
jh
->
b_modif›d
;

1640 
jh
->
b_modif›d
 = 0;

1642 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
) {

1643 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

1648 
	`ş—r_bufãr_dœty
(
bh
);

1649 
	`ş—r_bufãr_jbddœty
(
bh
);

1651 
	`JBUFFER_TRACE
(
jh
, "belongso currentransaction: unfile");

1657 ià(
was_modif›d
)

1658 
drİ_»£rve
 = 1;

1672 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1673 ià(
jh
->
b_ı_Œª§ùiÚ
) {

1674 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1675 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1677 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

1678 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1680 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1681 } ià(
jh
->
b_Œª§ùiÚ
) {

1682 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 ==

1683 
jouº®
->
j_comm™tšg_Œª§ùiÚ
));

1686 
	`JBUFFER_TRACE
(
jh
, "belongso olderransaction");

1694 
	`£t_bufãr_ä“d
(
bh
);

1696 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

1697 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1698 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1699 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1701 
	`J_ASSERT
(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1707 ià(
was_modif›d
)

1708 
drİ_»£rve
 = 1;

1716 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1717 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

1718 
	`JBUFFER_TRACE
(
jh
, "belongso‚oneransaction");

1719 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1720 
drİ
;

1727 ià(!
	`bufãr_dœty
(
bh
)) {

1728 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

1729 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1730 
drİ
;

1739 
	`ş—r_bufãr_dœty
(
bh
);

1740 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1741 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1743 
drİ
:

1744 
	`__b»l£
(
bh
);

1745 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

1746 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1747 ià(
drİ_»£rve
) {

1749 
hªdË
->
h_tÙ®_üed™s
++;

1751  
”r
;

1752 
	}
}

1770 
	$jbd3_jouº®_¡İ
(
hªdË_t
 *
hªdË
)

1772 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1773 
jouº®_t
 *
jouº®
;

1774 
”r
 = 0, 
wa™_fÜ_comm™
 = 0;

1775 
tid_t
 
tid
;

1776 
pid_t
 
pid
;

1778 ià(--
hªdË
->
h_»f
 > 0) {

1779 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1780 
hªdË
->
h_»f
);

1781 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1782  -
EIO
;

1785 ià(!
Œª§ùiÚ
) {

1790 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

1791 
ä“_ªd_ex™
;

1793 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1794 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1796 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1797 
”r
 = -
EIO
;

1799 
	`jbd_debug
(4, "HªdË %°gošg down\n", 
hªdË
);

1800 
	`Œaû_jbd3_hªdË_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1801 
tid
, 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1802 
jiff›s
 - 
hªdË
->
h_¡¬t_jiff›s
,

1803 
hªdË
->
h_sync
, hªdË->
h_»que¡ed_üed™s
,

1804 (
hªdË
->
h_»que¡ed_üed™s
 -

1805 
hªdË
->
h_tÙ®_üed™s
));

1836 
pid
 = 
cu¼’t
->pid;

1837 ià(
hªdË
->
h_sync
 && 
jouº®
->
j_Ï¡_sync_wr™”
 !ğ
pid
 &&

1838 
jouº®
->
j_max_b©ch_time
) {

1839 
u64
 
comm™_time
, 
Œªs_time
;

1841 
jouº®
->
j_Ï¡_sync_wr™”
 = 
pid
;

1843 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

1844 
comm™_time
 = 
jouº®
->
j_av”age_comm™_time
;

1845 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

1847 
Œªs_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(),

1848 
Œª§ùiÚ
->
t_¡¬t_time
));

1850 
comm™_time
 = 
	`max_t
(
u64
, commit_time,

1851 1000*
jouº®
->
j_mš_b©ch_time
);

1852 
comm™_time
 = 
	`mš_t
(
u64
, commit_time,

1853 1000*
jouº®
->
j_max_b©ch_time
);

1855 ià(
Œªs_time
 < 
comm™_time
) {

1856 
ktime_t
 
expœes
 = 
	`ktime_add_ns
(
	`ktime_g‘
(),

1857 
comm™_time
);

1858 
	`£t_cu¼’t_¡©e
(
TASK_UNINTERRUPTIBLE
);

1859 
	`scheduË_h¹imeout
(&
expœes
, 
HRTIMER_MODE_ABS
);

1863 ià(
hªdË
->
h_sync
)

1864 
Œª§ùiÚ
->
t_synchrÚous_comm™
 = 1;

1871 ià(
hªdË
->
h_sync
 ||

1872 
	`time_aá”_eq
(
jiff›s
, 
Œª§ùiÚ
->
t_expœes
)) {

1877 
	`jbd_debug
(2, "transactionoo old,„equesting commit for "

1878 "hªdË %p\n", 
hªdË
);

1880 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

1886 ià(
hªdË
->
h_sync
 && !(
cu¼’t
->
æags
 & 
PF_MEMALLOC
))

1887 
wa™_fÜ_comm™
 = 1;

1896 
	`¡İ_this_hªdË
(
hªdË
);

1898 ià(
wa™_fÜ_comm™
)

1899 
”r
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

1901 
ä“_ªd_ex™
:

1902 ià(
hªdË
->
h_rsv_hªdË
)

1903 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

1904 
	`jbd3_ä“_hªdË
(
hªdË
);

1905  
”r
;

1906 
	}
}

1924 
šlše
 

1925 
	$__bli¡_add_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1927 ià(!*
li¡
) {

1928 
jh
->
b_Šext
 = jh->
b_»v
 = jh;

1929 *
li¡
 = 
jh
;

1932 
jouº®_h—d
 *
fœ¡
 = *
li¡
, *
Ï¡
 = fœ¡->
b_»v
;

1933 
jh
->
b_»v
 = 
Ï¡
;

1934 
jh
->
b_Šext
 = 
fœ¡
;

1935 
Ï¡
->
b_Šext
 = 
fœ¡
->
b_»v
 = 
jh
;

1937 
	}
}

1948 
šlše
 

1949 
	$__bli¡_d–_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1951 ià(*
li¡
 =ğ
jh
) {

1952 *
li¡
 = 
jh
->
b_Šext
;

1953 ià(*
li¡
 =ğ
jh
)

1954 *
li¡
 = 
NULL
;

1956 
jh
->
b_»v
->
b_Šext
 = jh->b_tnext;

1957 
jh
->
b_Šext
->
b_»v
 = jh->b_tprev;

1958 
	}
}

1971 
	$__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
)

1973 
jouº®_h—d
 **
li¡
 = 
NULL
;

1974 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

1975 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1977 
	`lockd•_as£¹_h–d
(&
jh
->
b_¡©e_lock
);

1978 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

1979 ià(
Œª§ùiÚ
)

1980 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

1982 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

1983 ià(
jh
->
b_jli¡
 !ğ
BJ_NÚe
)

1984 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 !ğ
NULL
);

1986 
jh
->
b_jli¡
) {

1987 
BJ_NÚe
:

1989 
BJ_M‘ad©a
:

1990 
Œª§ùiÚ
->
t_Ä_bufãrs
--;

1991 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
->
t_Ä_bufãrs
 >= 0);

1992 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

1994 
BJ_FÜg‘
:

1995 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

1997 
BJ_Shadow
:

1998 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

2000 
BJ_Re£rved
:

2001 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

2005 
	`__bli¡_d–_bufãr
(
li¡
, 
jh
);

2006 
jh
->
b_jli¡
 = 
BJ_NÚe
;

2007 ià(
Œª§ùiÚ
 && 
	`is_jouº®_abÜ‹d
Ñ¿n§ùiÚ->
t_jouº®
))

2008 
	`ş—r_bufãr_jbddœty
(
bh
);

2009 ià(
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

2010 
	`m¬k_bufãr_dœty
(
bh
);

2011 
	}
}

2019 
	$__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
)

2021 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2022 
jh
->
b_Œª§ùiÚ
 = 
NULL
;

2023 
	}
}

2025 
	$jbd3_jouº®_unfe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

2027 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2030 
	`g‘_bh
(
bh
);

2031 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

2032 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2033 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2034 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2035 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2036 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2037 
	`__b»l£
(
bh
);

2038 
	}
}

2046 
	$__jouº®_Œy_to_ä“_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

2048 
jouº®_h—d
 *
jh
;

2050 
jh
 = 
	`bh2jh
(
bh
);

2052 ià(
	`bufãr_locked
(
bh
è|| 
	`bufãr_dœty
(bh))

2053 
out
;

2055 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
NULL
 || jh->
b_Œª§ùiÚ
 != NULL)

2056 
out
;

2058 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2059 ià(
jh
->
b_ı_Œª§ùiÚ
 !ğ
NULL
) {

2061 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

2062 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2064 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2065 
out
:

2067 
	}
}

2107 
	$jbd3_jouº®_Œy_to_ä“_bufãrs
(
jouº®_t
 *
jouº®
,

2108 
·ge
 *·ge, 
gå_t
 
gå_mask
)

2110 
bufãr_h—d
 *
h—d
;

2111 
bufãr_h—d
 *
bh
;

2112 
»t
 = 0;

2114 
	`J_ASSERT
(
	`PageLocked
(
·ge
));

2116 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2117 
bh
 = 
h—d
;

2119 
jouº®_h—d
 *
jh
;

2126 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2127 ià(!
jh
)

2130 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

2131 
	`__jouº®_Œy_to_ä“_bufãr
(
jouº®
, 
bh
);

2132 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2133 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2134 ià(
	`bufãr_jbd
(
bh
))

2135 
busy
;

2136 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2138 
»t
 = 
	`Œy_to_ä“_bufãrs
(
·ge
);

2140 
busy
:

2141  
»t
;

2142 
	}
}

2156 
	$__di¥o£_bufãr
(
jouº®_h—d
 *
jh
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

2158 
may_ä“
 = 1;

2159 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2161 ià(
jh
->
b_ı_Œª§ùiÚ
) {

2162 
	`JBUFFER_TRACE
(
jh
, "on„unning+cpransaction");

2163 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2169 
	`ş—r_bufãr_dœty
(
bh
);

2170 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

2171 
may_ä“
 = 0;

2173 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2174 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2175 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2177  
may_ä“
;

2178 
	}
}

2227 
	$jouº®_unm­_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

2228 
·¹Ÿl_·ge
)

2230 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2231 
jouº®_h—d
 *
jh
;

2232 
may_ä“
 = 1;

2234 
	`BUFFER_TRACE
(
bh
, "entry");

2242 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2243 ià(!
jh
)

2244 
z­_bufãr_uÆocked
;

2247 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2248 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

2249 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2274 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

2275 ià(
Œª§ùiÚ
 =ğ
NULL
) {

2280 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

2281 
	`JBUFFER_TRACE
(
jh
, "not on‡nyransaction: zap");

2282 
z­_bufãr
;

2285 ià(!
	`bufãr_dœty
(
bh
)) {

2287 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2288 
z­_bufãr
;

2295 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

2299 
	`JBUFFER_TRACE
(
jh
, "checkpointed:‡ddo BJ_Forget");

2300 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2301 
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2302 
z­_bufãr
;

2308 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2309 
	`JBUFFER_TRACE
(
jh
, "giveo committingrans");

2310 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2311 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2312 
z­_bufãr
;

2316 
	`ş—r_bufãr_jbddœty
(
bh
);

2317 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2318 
z­_bufãr
;

2321 } ià(
Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2322 
	`JBUFFER_TRACE
(
jh
, "on committingransaction");

2328 ià(
·¹Ÿl_·ge
) {

2329 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2330 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2331 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2332 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2333  -
EBUSY
;

2342 
	`£t_bufãr_ä“d
(
bh
);

2343 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && 
	`bufãr_jbddœty
(
bh
))

2344 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2345 
jh
->
b_modif›d
 = 0;

2346 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2347 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2348 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2349 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2358 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 =ğ
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2359 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2360 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
, 
Œª§ùiÚ
);

2363 
z­_bufãr
:

2372 
jh
->
b_modif›d
 = 0;

2373 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2374 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2375 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2376 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2377 
z­_bufãr_uÆocked
:

2378 
	`ş—r_bufãr_dœty
(
bh
);

2379 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jbddœty
(bh));

2380 
	`ş—r_bufãr_m­³d
(
bh
);

2381 
	`ş—r_bufãr_»q
(
bh
);

2382 
	`ş—r_bufãr_Ãw
(
bh
);

2383 
	`ş—r_bufãr_d–ay
(
bh
);

2384 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2385 
bh
->
b_bdev
 = 
NULL
;

2386  
may_ä“
;

2387 
	}
}

2401 
	$jbd3_jouº®_šv®id©•age
(
jouº®_t
 *
jouº®
,

2402 
·ge
 *page,

2403 
off£t
,

2404 
Ëngth
)

2406 
bufãr_h—d
 *
h—d
, *
bh
, *
Ãxt
;

2407 
¡İ
 = 
off£t
 + 
Ëngth
;

2408 
cu¼_off
 = 0;

2409 
·¹Ÿl_·ge
 = (
off£t
 || 
Ëngth
 < 
PAGE_SIZE
);

2410 
may_ä“
 = 1;

2411 
»t
 = 0;

2413 ià(!
	`PageLocked
(
·ge
))

2414 
	`BUG
();

2415 ià(!
	`·ge_has_bufãrs
(
·ge
))

2418 
	`BUG_ON
(
¡İ
 > 
PAGE_SIZE
 || stİ < 
Ëngth
);

2424 
h—d
 = 
bh
 = 
	`·ge_bufãrs
(
·ge
);

2426 
Ãxt_off
 = 
cu¼_off
 + 
bh
->
b_size
;

2427 
Ãxt
 = 
bh
->
b_this_·ge
;

2429 ià(
Ãxt_off
 > 
¡İ
)

2432 ià(
off£t
 <ğ
cu¼_off
) {

2434 
	`lock_bufãr
(
bh
);

2435 
»t
 = 
	`jouº®_unm­_bufãr
(
jouº®
, 
bh
, 
·¹Ÿl_·ge
);

2436 
	`uÆock_bufãr
(
bh
);

2437 ià(
»t
 < 0)

2438  
»t
;

2439 
may_ä“
 &ğ
»t
;

2441 
cu¼_off
 = 
Ãxt_off
;

2442 
bh
 = 
Ãxt
;

2444 } 
bh
 !ğ
h—d
);

2446 ià(!
·¹Ÿl_·ge
) {

2447 ià(
may_ä“
 && 
	`Œy_to_ä“_bufãrs
(
·ge
))

2448 
	`J_ASSERT
(!
	`·ge_has_bufãrs
(
·ge
));

2451 
	}
}

2456 
	$__jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2457 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2459 
jouº®_h—d
 **
li¡
 = 
NULL
;

2460 
was_dœty
 = 0;

2461 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2463 
	`lockd•_as£¹_h–d
(&
jh
->
b_¡©e_lock
);

2464 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2466 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

2467 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2468 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
);

2470 ià(
jh
->
b_Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
jli¡
)

2473 ià(
jli¡
 =ğ
BJ_M‘ad©a
 || jli¡ =ğ
BJ_Re£rved
 ||

2474 
jli¡
 =ğ
BJ_Shadow
 || jli¡ =ğ
BJ_FÜg‘
) {

2482 ià(
	`bufãr_dœty
(
bh
))

2483 
	`w¬n_dœty_bufãr
(
bh
);

2484 ià(
	`‹¡_ş—r_bufãr_dœty
(
bh
) ||

2485 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

2486 
was_dœty
 = 1;

2489 ià(
jh
->
b_Œª§ùiÚ
)

2490 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2492 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2493 
jh
->
b_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2495 
jli¡
) {

2496 
BJ_NÚe
:

2497 
	`J_ASSERT_JH
(
jh
, !jh->
b_comm™‹d_d©a
);

2498 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

2500 
BJ_M‘ad©a
:

2501 
Œª§ùiÚ
->
t_Ä_bufãrs
++;

2502 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

2504 
BJ_FÜg‘
:

2505 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

2507 
BJ_Shadow
:

2508 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

2510 
BJ_Re£rved
:

2511 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

2515 
	`__bli¡_add_bufãr
(
li¡
, 
jh
);

2516 
jh
->
b_jli¡
 = 
jli¡
;

2518 ià(
was_dœty
)

2519 
	`£t_bufãr_jbddœty
(
bh
);

2520 
	}
}

2522 
	$jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2523 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2525 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

2526 
	`¥š_lock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2527 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
jli¡
);

2528 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2529 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2530 
	}
}

2545 
boŞ
 
	$__jbd3_jouº®_»fe_bufãr
(
jouº®_h—d
 *
jh
)

2547 
was_dœty
, 
jli¡
;

2548 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2550 
	`lockd•_as£¹_h–d
(&
jh
->
b_¡©e_lock
);

2551 ià(
jh
->
b_Œª§ùiÚ
)

2552 
	`as£¹_¥š_locked
(&
jh
->
b_Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2555 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
) {

2556 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2557  
Œue
;

2565 
was_dœty
 = 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
);

2566 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2572 
jh
->
b_Œª§ùiÚ
 = jh->
b_Ãxt_Œª§ùiÚ
;

2573 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
NULL
;

2574 ià(
	`bufãr_ä“d
(
bh
))

2575 
jli¡
 = 
BJ_FÜg‘
;

2576 ià(
jh
->
b_modif›d
)

2577 
jli¡
 = 
BJ_M‘ad©a
;

2579 
jli¡
 = 
BJ_Re£rved
;

2580 
	`__jbd3_jouº®_fe_bufãr
(
jh
, jh->
b_Œª§ùiÚ
, 
jli¡
);

2581 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

2583 ià(
was_dœty
)

2584 
	`£t_bufãr_jbddœty
(
bh
);

2585  
çl£
;

2586 
	}
}

2594 
	$jbd3_jouº®_»fe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

2596 
boŞ
 
drİ
;

2598 
	`¥š_lock
(&
jh
->
b_¡©e_lock
);

2599 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2600 
drİ
 = 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

2601 
	`¥š_uÆock
(&
jh
->
b_¡©e_lock
);

2602 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2603 ià(
drİ
)

2604 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2605 
	}
}

2610 
	$jbd3_jouº®_fe_šode
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
,

2611 
æags
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
’d_by‹
)

2613 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

2614 
jouº®_t
 *
jouº®
;

2616 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

2617  -
EROFS
;

2618 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

2620 
	`jbd_debug
(4, "Addšg inod%lu,id:%d\n", 
jšode
->
i_vfs_šode
->
i_šo
,

2621 
Œª§ùiÚ
->
t_tid
);

2623 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2624 
jšode
->
i_æags
 |ğ
æags
;

2626 ià(
jšode
->
i_dœty_’d
) {

2627 
jšode
->
i_dœty_¡¬t
 = 
	`mš
(jšode->i_dœty_¡¬t, 
¡¬t_by‹
);

2628 
jšode
->
i_dœty_’d
 = 
	`max
(jšode->i_dœty_’d, 
’d_by‹
);

2630 
jšode
->
i_dœty_¡¬t
 = 
¡¬t_by‹
;

2631 
jšode
->
i_dœty_’d
 = 
’d_by‹
;

2635 ià(
jšode
->
i_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2636 
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

2637 
dÚe
;

2644 ià(!
Œª§ùiÚ
->
t_Ãed_d©a_æush
)

2645 
Œª§ùiÚ
->
t_Ãed_d©a_æush
 = 1;

2648 ià(
jšode
->
i_Œª§ùiÚ
) {

2649 
	`J_ASSERT
(
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2650 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 ==

2651 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2652 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2653 
dÚe
;

2656 
	`J_ASSERT
(!
jšode
->
i_Ãxt_Œª§ùiÚ
);

2657 
jšode
->
i_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2658 
	`li¡_add
(&
jšode
->
i_li¡
, &
Œª§ùiÚ
->
t_šode_li¡
);

2659 
dÚe
:

2660 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2663 
	}
}

2665 
	$jbd3_jouº®_šode_¿nged_wr™e
(
hªdË_t
 *
hªdË
,

2666 
jbd3_šode
 *
jšode
, 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2668  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
,

2669 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
, 
¡¬t_by‹
,

2670 
¡¬t_by‹
 + 
Ëngth
 - 1);

2671 
	}
}

2673 
	$jbd3_jouº®_šode_¿nged_wa™
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
,

2674 
loff_t
 
¡¬t_by‹
,†off_ˆ
Ëngth
)

2676  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
, 
JI_WAIT_DATA
,

2677 
¡¬t_by‹
, s¹_by‹ + 
Ëngth
 - 1);

2678 
	}
}

2700 
	$jbd3_jouº®_begš_Üd”ed_Œunÿ‹
(
jouº®_t
 *
jouº®
,

2701 
jbd3_šode
 *
jšode
,

2702 
loff_t
 
Ãw_size
)

2704 
Œª§ùiÚ_t
 *
šode_Œªs
, *
comm™_Œªs
;

2705 
»t
 = 0;

2708 ià(!
jšode
->
i_Œª§ùiÚ
)

2709 
out
;

2713 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2714 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

2715 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2716 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2717 
šode_Œªs
 = 
jšode
->
i_Œª§ùiÚ
;

2718 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2719 ià(
šode_Œªs
 =ğ
comm™_Œªs
) {

2720 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
jšode
->
i_vfs_šode
->
i_m­pšg
,

2721 
Ãw_size
, 
LLONG_MAX
);

2722 ià(
»t
)

2723 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

2725 
out
:

2726  
»t
;

2727 
	}
}

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

28 #undeà
NR_OPEN


29 
	#INR_OPEN_CUR
 1024

	)

30 
	#INR_OPEN_MAX
 4096

	)

32 
	#BLOCK_SIZE_BITS
 10

	)

33 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

35 
	#SEEK_SET
 0

	)

36 
	#SEEK_CUR
 1

	)

37 
	#SEEK_END
 2

	)

38 
	#SEEK_DATA
 3

	)

39 
	#SEEK_HOLE
 4

	)

40 
	#SEEK_MAX
 
SEEK_HOLE


	)

42 
	#RENAME_NOREPLACE
 (1 << 0è

	)

43 
	#RENAME_EXCHANGE
 (1 << 1è

	)

44 
	#RENAME_WHITEOUT
 (1 << 2è

	)

46 
	sfe_şÚe_¿nge
 {

47 
__s64
 
	m¤c_fd
;

48 
__u64
 
	m¤c_off£t
;

49 
__u64
 
	m¤c_Ëngth
;

50 
__u64
 
	mde¡_off£t
;

53 
	sf¡rim_¿nge
 {

54 
__u64
 
	m¡¬t
;

55 
__u64
 
	mËn
;

56 
__u64
 
	mmšËn
;

60 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

61 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

64 
	sfe_dedu³_¿nge_šfo
 {

65 
__s64
 
	mde¡_fd
;

66 
__u64
 
	mde¡_off£t
;

67 
__u64
 
	mby‹s_dedu³d
;

74 
__s32
 
	m¡©us
;

75 
__u32
 
	m»£rved
;

79 
	sfe_dedu³_¿nge
 {

80 
__u64
 
	m¤c_off£t
;

81 
__u64
 
	m¤c_Ëngth
;

82 
__u16
 
	mde¡_couÁ
;

83 
__u16
 
	m»£rved1
;

84 
__u32
 
	m»£rved2
;

85 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

89 
	sfes_¡©_¡ruù
 {

90 
	mÄ_fes
;

91 
	mÄ_ä“_fes
;

92 
	mmax_fes
;

95 
	sšodes_¡©_t
 {

96 
	mÄ_šodes
;

97 
	mÄ_unu£d
;

98 
	mdummy
[5];

102 
	#NR_FILE
 8192

	)

108 
	#MS_RDONLY
 1

	)

109 
	#MS_NOSUID
 2

	)

110 
	#MS_NODEV
 4

	)

111 
	#MS_NOEXEC
 8

	)

112 
	#MS_SYNCHRONOUS
 16

	)

113 
	#MS_REMOUNT
 32

	)

114 
	#MS_MANDLOCK
 64

	)

115 
	#MS_DIRSYNC
 128

	)

116 
	#MS_NOATIME
 1024

	)

117 
	#MS_NODIRATIME
 2048

	)

118 
	#MS_BIND
 4096

	)

119 
	#MS_MOVE
 8192

	)

120 
	#MS_REC
 16384

	)

121 
	#MS_VERBOSE
 32768

	)

123 
	#MS_SILENT
 32768

	)

124 
	#MS_POSIXACL
 (1<<16è

	)

125 
	#MS_UNBINDABLE
 (1<<17è

	)

126 
	#MS_PRIVATE
 (1<<18è

	)

127 
	#MS_SLAVE
 (1<<19è

	)

128 
	#MS_SHARED
 (1<<20è

	)

129 
	#MS_RELATIME
 (1<<21è

	)

130 
	#MS_KERNMOUNT
 (1<<22è

	)

131 
	#MS_I_VERSION
 (1<<23è

	)

132 
	#MS_STRICTATIME
 (1<<24è

	)

133 
	#MS_LAZYTIME
 (1<<25è

	)

136 
	#MS_SUBMOUNT
 (1<<26)

	)

137 
	#MS_NOREMOTELOCK
 (1<<27)

	)

138 
	#MS_NOSEC
 (1<<28)

	)

139 
	#MS_BORN
 (1<<29)

	)

140 
	#MS_ACTIVE
 (1<<30)

	)

141 
	#MS_NOUSER
 (1<<31)

	)

146 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

147 
MS_LAZYTIME
)

	)

152 
	#MS_MGC_VAL
 0xC0ED0000

	)

153 
	#MS_MGC_MSK
 0xffff0000

	)

158 
	sfsx©Œ
 {

159 
__u32
 
	mfsx_xæags
;

160 
__u32
 
	mfsx_extsize
;

161 
__u32
 
	mfsx_Ãx‹Ás
;

162 
__u32
 
	mfsx_´ojid
;

163 
__u32
 
	mfsx_cowextsize
;

164 
	mfsx_·d
[8];

170 
	#FS_XFLAG_REALTIME
 0x00000001

	)

171 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

172 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

173 
	#FS_XFLAG_APPEND
 0x00000010

	)

174 
	#FS_XFLAG_SYNC
 0x00000020

	)

175 
	#FS_XFLAG_NOATIME
 0x00000040

	)

176 
	#FS_XFLAG_NODUMP
 0x00000080

	)

177 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

178 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

179 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

180 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

181 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

182 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

183 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

184 
	#FS_XFLAG_DAX
 0x00008000

	)

185 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

186 
	#FS_XFLAG_HASATTR
 0x80000000

	)

191 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

192 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

193 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

194 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

195 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

196 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

197 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

198 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

199 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

200 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

201 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

202 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

204 
	#BLKPG
 
	`_IO
(0x12,105)

	)

208 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

209 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

214 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

215 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

216 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

217 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

218 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

219 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

220 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

221 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

222 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

223 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

224 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

225 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

226 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

227 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

228 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

229 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

235 
	#BMAP_IOCTL
 1

	)

236 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

237 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

238 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

239 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

240 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

241 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

242 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

243 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

245 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

246 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

247 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

248 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

249 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

250 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

251 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

252 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

253 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

254 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©Œ
)

	)

255 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©Œ
)

	)

261 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

263 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

264 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

265 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

266 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

267 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

268 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

271 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

275 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

277 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

279 
	sfsüy±_pŞicy
 {

280 
__u8
 
	mv”siÚ
;

281 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

282 
__u8
 
	mf’ames_’üy±iÚ_mode
;

283 
__u8
 
	mæags
;

284 
__u8
 
	mma¡”_key_desütÜ
[
FS_KEY_DESCRIPTOR_SIZE
];

287 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

288 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

289 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

292 
	#FS_KEY_DESC_PREFIX
 "fsüy±:"

	)

293 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

296 
	#FS_MAX_KEY_SIZE
 64

	)

298 
	sfsüy±_key
 {

299 
__u32
 
	mmode
;

300 
__u8
 
	m¿w
[
FS_MAX_KEY_SIZE
];

301 
__u32
 
	msize
;

324 
	#FS_SECRM_FL
 0x00000001

	)

325 
	#FS_UNRM_FL
 0x00000002

	)

326 
	#FS_COMPR_FL
 0x00000004

	)

327 
	#FS_SYNC_FL
 0x00000008

	)

328 
	#FS_IMMUTABLE_FL
 0x00000010

	)

329 
	#FS_APPEND_FL
 0x00000020

	)

330 
	#FS_NODUMP_FL
 0x00000040

	)

331 
	#FS_NOATIME_FL
 0x00000080

	)

333 
	#FS_DIRTY_FL
 0x00000100

	)

334 
	#FS_COMPRBLK_FL
 0x00000200

	)

335 
	#FS_NOCOMP_FL
 0x00000400

	)

337 
	#FS_ENCRYPT_FL
 0x00000800

	)

338 
	#FS_BTREE_FL
 0x00001000

	)

339 
	#FS_INDEX_FL
 0x00001000

	)

340 
	#FS_IMAGIC_FL
 0x00002000

	)

341 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

342 
	#FS_NOTAIL_FL
 0x00008000

	)

343 
	#FS_DIRSYNC_FL
 0x00010000

	)

344 
	#FS_TOPDIR_FL
 0x00020000

	)

345 
	#FS_HUGE_FILE_FL
 0x00040000

	)

346 
	#FS_EXTENT_FL
 0x00080000

	)

347 
	#FS_EA_INODE_FL
 0x00200000

	)

348 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

349 
	#FS_NOCOW_FL
 0x00800000

	)

350 
	#FS_INLINE_DATA_FL
 0x10000000

	)

351 
	#FS_PROJINHERIT_FL
 0x20000000

	)

352 
	#FS_RESERVED_FL
 0x80000000

	)

354 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

355 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

358 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

359 
	#SYNC_FILE_RANGE_WRITE
 2

	)

360 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

366 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

369 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

372 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

375 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

378 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

381 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
)

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	stimezÚe
 {

22 
	mtz_mšu‹swe¡
;

23 
	mtz_d¡time
;

31 
	#ITIMER_REAL
 0

	)

32 
	#ITIMER_VIRTUAL
 1

	)

33 
	#ITIMER_PROF
 2

	)

35 
	s™im”¥ec
 {

36 
time¥ec
 
	m™_š‹rv®
;

37 
time¥ec
 
	m™_v®ue
;

40 
	s™im”v®
 {

41 
timev®
 
	m™_š‹rv®
;

42 
timev®
 
	m™_v®ue
;

48 
	#CLOCK_REALTIME
 0

	)

49 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

51 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

52 
	#CLOCK_MONOTONIC_RAW
 4

	)

53 
	#CLOCK_REALTIME_COARSE
 5

	)

54 
	#CLOCK_MONOTONIC_COARSE
 6

	)

55 
	#CLOCK_BOOTTIME
 7

	)

56 
	#CLOCK_REALTIME_ALARM
 8

	)

57 
	#CLOCK_BOOTTIME_ALARM
 9

	)

62 
	#CLOCK_SGI_CYCLE
 10

	)

63 
	#CLOCK_TAI
 11

	)

65 
	#MAX_CLOCKS
 16

	)

66 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

67 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

72 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@
1
.
1
/usr/include
15
314
checkpoint.c
commit.c
journal.c
recovery.c
revoke.c
transaction.c
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/module.h
/usr/include/linux/time.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/types.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
